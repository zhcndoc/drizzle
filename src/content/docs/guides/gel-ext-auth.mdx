---
title: Gel è®¤è¯æ‰©å±•
slug: gel-ext-auth
---
import Prerequisites from "@mdx/Prerequisites.astro";
import Callout from "@mdx/Callout.astro";
import Npx from "@mdx/Npx.astro";

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [Gel](/docs/get-started-gel)
- ä½¿ç”¨ [drizzle-kit pull](/docs/drizzle-kit-pull)
</Prerequisites>

#### ç¬¬ä¸€æ­¥ - å®šä¹‰ Gel è®¤è¯ schema

åœ¨ `dbschema/default.esdl` æ–‡ä»¶ä¸­æ·»åŠ å¸¦æœ‰è®¤è¯æ‰©å±•çš„ Gel schema

```esdl
using extension auth;

module default {
  global current_user := (
    assert_single((
      select User { id, username, email }
      filter .identity = global ext::auth::ClientTokenIdentity
    ))
  );

  type User {
    required identity: ext::auth::Identity;
    required username: str;
    required email: str;
  }
}
```

#### ç¬¬äºŒæ­¥ - å°† Gel schema æ¨é€åˆ°æ•°æ®åº“

ç”Ÿæˆ Gel è¿ç§»æ–‡ä»¶ï¼š
```bash
gel migration create
```

å°† Gel è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“
```bash
gel migration apply
```

#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - æ˜¯ä¸€ä¸ªè¢« [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å…³äºæ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œ schema æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
  // ä¸º drizzle-kit å¯ç”¨ auth schema
  schemaFilter: ['ext::auth', 'public']
});
```

#### ç¬¬å››æ­¥ - å°† Gel ç±»å‹æ‹‰å–åˆ° Drizzle schema

æ‹‰å–ä½ çš„æ•°æ®åº“ schemaï¼š
<Npx>
drizzle-kit pull
</Npx>

ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„ schema.ts æ–‡ä»¶ç¤ºä¾‹ï¼š

<Callout type="warning">
ä½ ä¸ä»…ä¼šè·å¾—æ¥è‡ª `ext::auth` çš„ `Identity` è¡¨ï¼ŒDrizzle ä¼šæ‹‰å–æ‰€æœ‰ä½ å¯ä»¥ä½¿ç”¨çš„ `auth` è¡¨ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»…å±•ç¤ºå…¶ä¸­ä¸€ä¸ªã€‚
</Callout>

```ts
import { gelTable, uniqueIndex, uuid, text, gelSchema, timestamptz, foreignKey } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const extauth = gelSchema('ext::auth');

export const identityInExtauth = extauth.table('Identity', {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	createdAt: timestamptz('created_at').default(sql`(clock_timestamp())`).notNull(),
	issuer: text().notNull(),
	modifiedAt: timestamptz('modified_at').notNull(),
	subject: text().notNull(),
}, (table) => [
	uniqueIndex('6bc2dd19-bce4-5810-bb1b-7007afe97a11;schemaconstr').using(
		'btree',
		table.id.asc().nullsLast().op('uuid_ops'),
	),
]);

export const user = gelTable('User', {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	email: text().notNull(),
	identityId: uuid('identity_id').notNull(),
	username: text().notNull(),
}, (table) => [
	uniqueIndex('d504514c-26a7-11f0-b836-81aa188c0abe;schemaconstr').using(
		'btree',
		table.id.asc().nullsLast().op('uuid_ops'),
	),
	foreignKey({
		columns: [table.identityId],
		foreignColumns: [identityInExtauth.id],
		name: 'User_fk_identity',
	}),
]);
```

ğŸ‰ ç°åœ¨ä½ å¯ä»¥åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ `auth` è¡¨äº†ï¼