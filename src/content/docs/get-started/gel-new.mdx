import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPostgreSQL from '@mdx/get-started/postgresql/ConnectPostgreSQL.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Gel å¿«é€Ÿå…¥é—¨

<Prerequisites>
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://tsx.is/)
  - **gel-js** - ç”¨äºæŸ¥è¯¢ Gel æ•°æ®åº“çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://github.com/geldata/gel-js)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `gel` å®¢æˆ·ç«¯è¿æ¥ Gelã€‚

è¿™æ˜¯é¡¹ç›®çš„åŸºç¡€æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ `index.ts` æ–‡ä»¶ï¼Œç”¨äºè¡¨çš„å®šä¹‰ã€‚åœ¨ `drizzle` æ–‡ä»¶å¤¹ä¸­åˆ™å­˜æ”¾äº†ä» Gel ç”Ÿæˆçš„ Drizzle schemaã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### ç¬¬1æ­¥ - å®‰è£…å¹¶åˆå§‹åŒ– **Gel** é¡¹ç›®

<Npx>
gel project init
</Npx>

#### ç¬¬2æ­¥ - å®šä¹‰åŸºç¡€ Gel schema

åœ¨ `dbschema/default.esdl` æ–‡ä»¶ä¸­æ·»åŠ åŸºç¡€çš„ Gel schema

```esdl
module default {
    type user {
        name: str;
        required email: str;
        age: int16;
    }
}
```

#### ç¬¬3æ­¥ - æ¨é€ Gel schema åˆ°æ•°æ®åº“

ç”Ÿæˆ Gel è¿ç§»æ–‡ä»¶ï¼š
```bash
gel migration create
```

åº”ç”¨ Gel è¿ç§»åˆ°æ•°æ®åº“ï¼š
```bash
gel migration apply
```

<Callout>
ç°åœ¨ä½ çš„æ–‡ä»¶ç»“æ„åº”è¯¥æ˜¯è¿™æ ·

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ dbschema
 â”‚ â”œ ğŸ“‚ migrations
 â”‚ â”œ ğŸ“œ default.esdl
 â”‚ â”” ğŸ“œ scoping.esdl
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ edgedb.toml
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```
</Callout>

#### ç¬¬4æ­¥ - å®‰è£…æ‰€éœ€åŒ…
<Npm>
  drizzle-orm gel
  -D drizzle-kit tsx
</Npm>

#### ç¬¬5æ­¥ - é…ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®æ–‡ä»¶** æ˜¯ [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹åŠ schema æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
});
```

#### ç¬¬6æ­¥ - ä» Gel åŒæ­¥ç±»å‹åˆ° Drizzle schema

åŒæ­¥ä½ çš„æ•°æ®åº“ schemaï¼š
<Npx>
drizzle-kit pull
</Npx>

è¿™æ˜¯ç¤ºä¾‹ç”Ÿæˆçš„ schema.ts æ–‡ä»¶ï¼š

```typescript filename="drizzle/schema.ts"
import { gelTable, uniqueIndex, uuid, smallint, text } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const users = gelTable("users", {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	age: smallint(),
	email: text().notNull(),
	name: text(),
}, (table) => [
	uniqueIndex("a8c6061c-f37f-11ef-9249-0d78f6c1807b;schemaconstr").using("btree", table.id.asc().nullsLast().op("uuid_ops")),
]);
```

#### ç¬¬7æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

åœ¨ `src` ç›®å½•ä¸‹åˆ›å»º `index.ts` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```typescript copy filename="src/index.ts"
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";

const gelClient = createClient();
const db = drizzle({ client: gelClient });
```

#### ç¬¬8æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";
import { users } from "../drizzle/schema";

const gelClient = createClient();
const db = drizzle({ client: gelClient });

async function main() {
  const user: typeof users.$inferInsert = {
    name: "John",
    age: 30,
    email: "john@example.com",
  };

  await db.insert(users).values(user);
  console.log("æ–°ç”¨æˆ·å·²åˆ›å»ºï¼");

  const usersResponse = await db.select().from(users);
  console.log("ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·ï¼š", usersResponse);
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(users)
    .set({
      age: 31,
    })
    .where(eq(users.email, user.email));
  console.log("ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼");

  await db.delete(users).where(eq(users.email, user.email));
  console.log("ç”¨æˆ·å·²åˆ é™¤ï¼");
}

main();
```

#### ç¬¬9æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>