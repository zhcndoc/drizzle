---
title: DrizzleORM v0.29.5 å‘å¸ƒ
pubDate: 2024-03-06
description: å¢åŠ äº†ä¸æ›´æ–°ã€ä¸åˆ é™¤ã€ä¸æ’å…¥ï¼Œèƒ½å¤ŸæŒ‡å®šè‡ªå®šä¹‰æ¨¡å¼å’Œè¿ç§»è¡¨çš„è‡ªå®šä¹‰åç§°ï¼Œsqlite ä»£ç†æ‰¹é‡å’Œå…³ç³»æŸ¥è¯¢æ”¯æŒã€‚
---

import Section from "@mdx/Section.astro";

## æ–°ç‰¹æ€§

### ğŸ‰ WITH æ›´æ–°ã€WITH åˆ é™¤ã€WITH æ’å…¥

ç°åœ¨æ‚¨å¯ä»¥åœ¨ [INSERT](/docs/insert#with-insert-clause)ã€[UPDATE](/docs/update#with-update-clause) å’Œ [DELETE](/docs/delete#with-delete-clause) è¯­å¥ä¸­ä½¿ç”¨ `WITH` è¯­å¥ã€‚

ä½¿ç”¨ç¤ºä¾‹

<Section>
```ts copy {6,7}
const averageAmount = db.$with('average_amount').as(
	db.select({ value: sql`avg(${orders.amount})`.as('value') }).from(orders),
);

const result = await db
	.with(averageAmount)
	.delete(orders)
	.where(gt(orders.amount, sql`(select * from ${averageAmount})`))
	.returning({
		id: orders.id,
	});
```

```sql
with "average_amount" as (select avg("amount") as "value" from "orders") 
delete from "orders" 
where "orders"."amount" > (select * from "average_amount") 
returning "id";
```
</Section>

æœ‰å…³æ‰€æœ‰è¯­å¥çš„æ›´å¤šç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£ï¼š

- [with insert æ–‡æ¡£](/docs/insert#with-insert-clause)
- [with update æ–‡æ¡£](/docs/update#with-update-clause)
- [with delete æ–‡æ¡£](/docs/delete#with-delete-clause)

### ğŸ‰ èƒ½å¤ŸæŒ‡å®šè‡ªå®šä¹‰æ¨¡å¼å’Œè¿ç§»è¡¨çš„è‡ªå®šä¹‰åç§°

- **è‡ªå®šä¹‰è¿ç§»è¡¨**

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æœ‰å…³å·²æ‰§è¡Œè¿ç§»çš„ä¿¡æ¯å°†å­˜å‚¨åœ¨æ•°æ®åº“çš„ `__drizzle_migrations` è¡¨ä¸­ï¼Œ
PostgreSQL ä¸­åˆ™åœ¨ `drizzle` æ¨¡å¼ä¸‹ã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥é…ç½®å­˜å‚¨è¿™äº›è®°å½•çš„ä½ç½®ã€‚

è¦ä¸ºå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„è¿ç§»æ·»åŠ è‡ªå®šä¹‰è¡¨åï¼Œæ‚¨åº”ä½¿ç”¨ `migrationsTable` é€‰é¡¹ã€‚

ä½¿ç”¨ç¤ºä¾‹

```ts copy {3}
await migrate(db, {
	migrationsFolder: './drizzle',
	migrationsTable: 'my_migrations',
});
```

- **è‡ªå®šä¹‰è¿ç§»æ¨¡å¼**

> ä»…é€‚ç”¨äº PostgreSQL æ•°æ®åº“

è¦ä¸ºå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„è¿ç§»æ·»åŠ è‡ªå®šä¹‰æ¨¡å¼åç§°ï¼Œæ‚¨åº”ä½¿ç”¨ `migrationsSchema` é€‰é¡¹ã€‚

ä½¿ç”¨ç¤ºä¾‹

```ts copy {3}
await migrate(db, {
	migrationsFolder: './drizzle',
	migrationsSchema: 'custom',
});
```

### ğŸ‰ SQLite ä»£ç†æ‰¹é‡å’Œå…³ç³»æŸ¥è¯¢æ”¯æŒ

æ‚¨å¯ä»¥åœ¨ [æ–‡æ¡£](/docs/get-started-sqlite#http-proxy) ä¸­æ‰¾åˆ°æœ‰å…³ SQLite ä»£ç†çš„æ›´å¤šä¿¡æ¯ã€‚

- æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ `.query.findFirst` å’Œ `.query.findMany` è¯­æ³•ä¸ sqlite ä»£ç†é©±åŠ¨ç¨‹åºã€‚

- SQLite ä»£ç†æ”¯æŒæ‰¹é‡è¯·æ±‚ï¼Œå°±åƒå…¶ä»–æ‰€æœ‰é©±åŠ¨ç¨‹åºä¸€æ ·ã€‚è¯·æŸ¥çœ‹å®Œæ•´çš„ [æ–‡æ¡£](/docs/batch-api)ã€‚

æ‚¨éœ€è¦ä¸ºæ‰¹é‡æŸ¥è¯¢æŒ‡å®šç‰¹å®šå›è°ƒå¹¶å¤„ç†å¯¹ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚ï¼š

```ts
import { drizzle } from 'drizzle-orm/sqlite-proxy';

type ResponseType = { rows: any[][] | any[] }[];

const db = drizzle(
	async (sql, params, method) => {
		// å•ä¸ªæŸ¥è¯¢é€»è¾‘
	},
	// æ–°çš„æ‰¹é‡å›è°ƒ
	async (
		queries: {
			sql: string;
			params: any[];
			method: 'all' | 'run' | 'get' | 'values';
		}[],
	) => {
		try {
			const result: ResponseType = await axios.post(
				'http://localhost:3000/batch',
				{ queries },
			);

			return result;
		} catch (e: any) {
			console.error('æ¥è‡ª sqlite ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯:', e);
			throw e;
		}
	},
);
```

ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨ `db.batch([])` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ä»£ç†æ‰€æœ‰æŸ¥è¯¢ã€‚

> æ‰¹é‡å“åº”åº”ä¸ºåŸå§‹å€¼çš„æ•°ç»„ï¼ˆæ•°ç»„ä¸­çš„æ•°ç»„ï¼‰ï¼Œé¡ºåºä¸å‘é€åˆ°ä»£ç†æœåŠ¡å™¨æ—¶ç›¸åŒã€‚
