import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';

# ç¼“å­˜

<Callout type='warning'>
ä»…åœ¨ `drizzle-orm@cache` æ ‡ç­¾ä¸­å¯ç”¨

<Npm>
drizzle-orm@cache
</Npm>
</Callout>

Drizzle é»˜è®¤å°†æ¯ä¸ªæŸ¥è¯¢ç›´æ¥å‘é€åˆ°ä½ çš„æ•°æ®åº“ã€‚æ²¡æœ‰éšè—çš„æ“ä½œï¼Œæ²¡æœ‰è‡ªåŠ¨ç¼“å­˜æˆ–å¤±æ•ˆ - ä½ å°†å§‹ç»ˆçœ‹åˆ°ç¡®åˆ‡çš„æ‰§è¡Œå†…å®¹ã€‚å¦‚æœä½ éœ€è¦ç¼“å­˜ï¼Œå¿…é¡»æ‰‹åŠ¨é€‰æ‹©ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrizzle ä½¿ç”¨ `explicit` ç¼“å­˜ç­–ç•¥ï¼ˆå³ `global: false`ï¼‰ï¼Œå› æ­¤é™¤éä½ è¯·æ±‚ï¼Œå¦åˆ™ä¸ä¼šç¼“å­˜ä»»ä½•å†…å®¹ã€‚è¿™é˜²æ­¢äº†åœ¨ä½ çš„åº”ç”¨ä¸­å‡ºç°æƒŠè®¶æˆ–éšè—çš„æ€§èƒ½é™·é˜±ã€‚æˆ–è€…ï¼Œä½ å¯ä»¥å¯ç”¨ `all` ç¼“å­˜ï¼ˆ`global: true`ï¼‰ï¼Œè¿™æ ·æ¯ä¸ªé€‰æ‹©éƒ½å°†é¦–å…ˆæŸ¥çœ‹ç¼“å­˜ã€‚

## å¿«é€Ÿå¼€å§‹

### Upstash é›†æˆ

Drizzle æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ `upstashCache()` è¾…åŠ©å‡½æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼Œå®ƒä½¿ç”¨ Upstash Redis è¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  cache: upstashCache(),
});
```

ä½ è¿˜å¯ä»¥æ˜¾å¼å®šä¹‰ä½ çš„ Upstash å‡­è¯ï¼Œé»˜è®¤å¯ç”¨æ‰€æœ‰æŸ¥è¯¢çš„å…¨å±€ç¼“å­˜æˆ–ä¼ é€’è‡ªå®šä¹‰ç¼“å­˜é€‰é¡¹ï¼š

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  cache: upstashCache({
    // ğŸ‘‡ Redis å‡­è¯ï¼ˆå¯é€‰ â€” ä¹Ÿå¯ä»¥ä»ç¯å¢ƒå˜é‡ä¸­æå–ï¼‰
    url: '<UPSTASH_URL>',
    token: '<UPSTASH_TOKEN>',

    // ğŸ‘‡ é»˜è®¤å¯ç”¨æ‰€æœ‰æŸ¥è¯¢çš„ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    global: true,

    // ğŸ‘‡ é»˜è®¤ç¼“å­˜è¡Œä¸ºï¼ˆå¯é€‰ï¼‰
    config: { ex: 60 }
  })
});
```

## ç¼“å­˜é…ç½®å‚è€ƒ

Drizzle æ”¯æŒä»¥ä¸‹ Upstash ç¼“å­˜é…ç½®é€‰é¡¹ï¼š

```ts
export type CacheConfig = {
  /**
   * è¿‡æœŸæ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½çš„æ­£æ•´æ•°ï¼‰
   */
  ex?: number;
  /**
   * åœ¨ç»™å®šå“ˆå¸Œé”®çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µä¸Šè®¾ç½®è¿‡æœŸï¼ˆTTL æˆ–ç”Ÿå­˜æ—¶é—´ï¼‰ã€‚
   * ç”¨äº HEXPIRE å‘½ä»¤
   */
  hexOptions?: "NX" | "nx" | "XX" | "xx" | "GT" | "gt" | "LT" | "lt";
};
```

## ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹

ä¸€æ—¦ä½ é…ç½®äº†ç¼“å­˜ï¼Œä¸‹é¢æ˜¯ç¼“å­˜çš„è¡Œä¸ºï¼š

**æ¡ˆä¾‹1ï¼šDrizzle ä½¿ç”¨ `global: false`ï¼ˆé»˜è®¤ï¼Œé€‰æ‹©æ€§ç¼“å­˜ï¼‰**

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  // ğŸ‘‡ æ²¡æœ‰ä¼ å…¥ `global: true`ï¼Œé»˜è®¤æ˜¯ false
  cache: upstashCache({ url: "", token: "" }),
});
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æŸ¥è¯¢ä¸ä¼šä»ç¼“å­˜è¯»å–

```ts
const res = await db.select().from(users);

// ä»»ä½•å˜æ›´æ“ä½œä»å°†è§¦å‘ç¼“å­˜çš„ onMutate å¤„ç†å™¨
// å°è¯•ä½¿ä»»ä½•æ¶‰åŠå—å½±å“è¡¨çš„ç¼“å­˜æŸ¥è¯¢å¤±æ•ˆ
await db.insert(users).value({ email: "cacheman@upstash.com" });
```

è¦ä½¿æ­¤æŸ¥è¯¢ä»ç¼“å­˜è¯»å–ï¼Œè°ƒç”¨ `.$withCache()`

```ts
const res = await db.select().from(users).$withCache();
```

`.$withCache` æœ‰ä¸€ç»„å¯ä¾›ä½ ä½¿ç”¨çš„é€‰é¡¹ï¼Œä»¥ç®¡ç†å’Œé…ç½®æ­¤ç‰¹å®šæŸ¥è¯¢ç­–ç•¥

```ts
// ä¸ºæ­¤ç‰¹å®šæŸ¥è¯¢é‡å†™é…ç½®
.$withCache({ config: {} })

// ç»™æ­¤æŸ¥è¯¢ä¸€ä¸ªè‡ªå®šä¹‰ç¼“å­˜é”®ï¼ˆè€Œä¸æ˜¯åœ¨åå°å“ˆå¸ŒæŸ¥è¯¢+å‚æ•°ï¼‰
.$withCache({ tag: 'custom_key' })

// å…³é—­æ­¤æŸ¥è¯¢çš„è‡ªåŠ¨å¤±æ•ˆ
// æ³¨æ„ï¼šè¿™ä¼šå¯¼è‡´æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¦‚ä¸‹æ‰€è¿°ï¼‰
.$withCache({ autoInvalidate: false })
```

<Callout>
**æœ€ç»ˆä¸€è‡´æ€§ç¤ºä¾‹**

æ­¤ç¤ºä¾‹ä»…åœ¨ä½ æ‰‹åŠ¨è®¾ç½® `autoInvalidate: false` æ—¶ç›¸å…³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨ `autoInvalidate`ã€‚

å¦‚æœä½ æƒ³å…³é—­ `autoInvalidate`ï¼Œä½ å¯èƒ½ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼š
- ä½ çš„æ•°æ®ä¸ç»å¸¸æ›´æ”¹ï¼Œå¹¶ä¸”å¯ä»¥æ¥å—è½»å¾®çš„è¿‡æ—¶ï¼ˆä¾‹å¦‚äº§å“åˆ—è¡¨ã€åšå®¢æ–‡ç« ï¼‰
- ä½ æ‰‹åŠ¨å¤„ç†ç¼“å­˜å¤±æ•ˆ

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå…³é—­å®ƒå¯ä»¥å‡å°‘ä¸å¿…è¦çš„ç¼“å­˜å¤±æ•ˆã€‚ç„¶è€Œï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®ä¿ç•™é»˜è®¤å¯ç”¨ã€‚

ç¤ºä¾‹ï¼šå‡è®¾ä½ åœ¨ `usersTable` ä¸Šç¼“å­˜ä»¥ä¸‹æŸ¥è¯¢ï¼Œè¿‡æœŸæ—¶é—´ä¸º 3 ç§’ï¼š

``` ts
const recent = await db
  .select().from(usersTable)
  .$withCache({ config: { ex: 3 }, autoInvalidate: false });
```

å¦‚æœæœ‰äººè¿è¡Œ `db.insert(usersTable)...`ï¼Œç¼“å­˜ä¸ä¼šç«‹å³å¤±æ•ˆã€‚åœ¨æœ€å¤š 3 ç§’å†…ï¼Œä½ å°†ç»§ç»­çœ‹åˆ°æ—§æ•°æ®ï¼Œç›´åˆ°å®ƒæœ€ç»ˆå˜å¾—ä¸€è‡´ã€‚
</Callout>

**æ¡ˆä¾‹2ï¼šDrizzle ä½¿ç”¨ `global: true` é€‰é¡¹**

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  cache: upstashCache({ url: "", token: "", global: true }),
});
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æŸ¥è¯¢å°†ä»ç¼“å­˜è¯»å–

```ts
const res = await db.select().from(users);
```

å¦‚æœä½ æƒ³ç¦ç”¨æ­¤ç‰¹å®šæŸ¥è¯¢çš„ç¼“å­˜ï¼Œè°ƒç”¨ `.$withCache(false)`

```ts
// ç¦ç”¨æ­¤æŸ¥è¯¢çš„ç¼“å­˜
const res = await db.select().from(users).$withCache(false);
```

ä½ è¿˜å¯ä»¥ä½¿ç”¨æ¥è‡ª `db` çš„ç¼“å­˜å®ä¾‹æ¥ä½¿ç‰¹å®šè¡¨æˆ–æ ‡ç­¾å¤±æ•ˆã€‚

```ts
// ä½¿æ‰€æœ‰ä½¿ç”¨ `users` è¡¨çš„æŸ¥è¯¢å¤±æ•ˆã€‚ä½ å¯ä»¥ç”¨ Drizzle å®ä¾‹åšåˆ°è¿™ä¸€ç‚¹ã€‚
await db.$cache.invalidate({ tables: users });
// æˆ–
await db.$cache.invalidate({ tables: [users, posts] });

// ä½¿æ‰€æœ‰ä½¿ç”¨ `usersTable` çš„æŸ¥è¯¢å¤±æ•ˆã€‚ä½ å¯ä»¥ä½¿ç”¨è¡¨åç§°æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚
await db.$cache.invalidate({ tables: "usersTable" });
// æˆ–
await db.$cache.invalidate({ tables: ["usersTable", "postsTable"] });

// ä½ è¿˜å¯ä»¥ä½¿åœ¨ä»»ä½•ä¹‹å‰æ‰§è¡Œçš„é€‰æ‹©æŸ¥è¯¢ä¸­å®šä¹‰çš„è‡ªå®šä¹‰æ ‡ç­¾å¤±æ•ˆã€‚
await db.$cache.invalidate({ tags: "custom_key" });
// æˆ–
await db.$cache.invalidate({ tags: ["custom_key", "custom_key1"] });
```

## è‡ªå®šä¹‰ç¼“å­˜

æ­¤ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åœ¨ Drizzle ä¸­æ’å…¥è‡ªå®šä¹‰ `cache`ï¼šä½ æä¾›å‡½æ•°ä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€å°†ç»“æœå­˜å‚¨å›ç¼“å­˜ï¼Œå¹¶åœ¨æ¯æ¬¡æ‰§è¡Œå˜æ›´æ—¶ä½¿æ¡ç›®å¤±æ•ˆã€‚

ç¼“å­˜æ‰©å±•æä¾›æ­¤é…ç½®é€‰é¡¹é›†
```ts
export type CacheConfig = {
  /** è¿‡æœŸæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ */
  ex?: number;
  /** è¿‡æœŸæ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ */
  px?: number;
  /** é”®å°†åœ¨ Unix æ—¶é—´ï¼ˆç§’ï¼‰åˆ°æœŸ */
  exat?: number;
  /** é”®å°†åœ¨ Unix æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰åˆ°æœŸ */
  pxat?: number;
  /** æ›´æ–°é”®æ—¶ä¿ç•™ç°æœ‰çš„ TTL */
  keepTtl?: boolean;
  /** HEXPIREï¼ˆå“ˆå¸Œå­—æ®µ TTLï¼‰çš„é€‰é¡¹ */
  hexOptions?: 'NX' | 'XX' | 'GT' | 'LT' | 'nx' | 'xx' | 'gt' | 'lt';
};
```

```ts
const db = drizzle(process.env.DB_URL!, { cache: new TestGlobalCache() });
```

```ts
import Keyv from "keyv";

export class TestGlobalCache extends Cache {
  private globalTtl: number = 1000;
  // æ­¤å¯¹è±¡å°†ç”¨äºå­˜å‚¨ç‰¹å®šè¡¨ä½¿ç”¨çš„æŸ¥è¯¢é”®ï¼Œ
  // ä»¥ä¾¿æˆ‘ä»¬ä»¥åå¯ä»¥ç”¨äºå¤±æ•ˆå¤„ç†ã€‚
  private usedTablesPerKey: Record<string, string[]> = {};

  constructor(private kv: Keyv = new Keyv()) {
    super();
  }

  // å¯¹äºç­–ç•¥ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š
  // - 'explicit': ä»…å½“å¯¹æŸ¥è¯¢æ·»åŠ äº† .$withCache() æ—¶ä½¿ç”¨ç¼“å­˜ã€‚
  // - 'all': æ‰€æœ‰æŸ¥è¯¢è¢«å…¨å±€ç¼“å­˜ã€‚
  // é»˜è®¤è¡Œä¸ºæ˜¯ 'explicit'ã€‚
  override strategy(): "explicit" | "all" {
    return "all";
  }

  // æ­¤å‡½æ•°æ¥å—æŸ¥è¯¢å’Œå‚æ•°ï¼Œç¼“å­˜åˆ°é”®å‚æ•°ä¸­ï¼Œ
  // å…è®¸ä½ ä»ç¼“å­˜ä¸­æ£€ç´¢æ­¤æŸ¥è¯¢çš„å“åº”å€¼ã€‚
  override async get(key: string): Promise<any[] | undefined> {
    const res = (await this.kv.get(key)) ?? undefined;
    return res;
  }

  // æ­¤å‡½æ•°æ¥å—å¤šä¸ªé€‰é¡¹ä»¥å®šä¹‰ç¼“å­˜æ•°æ®å°†å¦‚ä½•å­˜å‚¨ï¼š
  // - 'key': å“ˆå¸ŒæŸ¥è¯¢å’Œå‚æ•°ã€‚
  // - 'response': Drizzle ä»æ•°æ®åº“è¿”å›çš„å€¼æ•°ç»„ã€‚
  // - 'tables': å‚ä¸é€‰æ‹©æŸ¥è¯¢çš„è¡¨æ•°ç»„ã€‚è¿™äº›ä¿¡æ¯å¯¹äºç¼“å­˜å¤±æ•ˆæ˜¯å¿…éœ€çš„ã€‚
  //
  // ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªæŸ¥è¯¢ä½¿ç”¨äº† "users" å’Œ "posts" è¡¨ï¼Œä½ å¯ä»¥å­˜å‚¨è¿™äº›ä¿¡æ¯ã€‚ç¨åï¼Œå½“åº”ç”¨ç¨‹åºæ‰§è¡Œ
  // åœ¨è¿™äº›è¡¨ä¸Šçš„ä»»ä½•å˜æ›´è¯­å¥æ—¶ï¼Œå¯ä»¥ä»ç¼“å­˜ä¸­åˆ é™¤ç›¸åº”çš„é”®ã€‚
  // å¦‚æœä½ å¯¹æŸ¥è¯¢çš„æœ€ç»ˆä¸€è‡´æ€§æ„Ÿåˆ°æ»¡æ„ï¼Œå¯ä»¥è·³è¿‡æ­¤é€‰é¡¹ã€‚
  override async put(
    key: string,
    response: any,
    tables: string[],
    config?: CacheConfig,
  ): Promise<void> {
    await this.kv.set(key, response, config ? config.ex : this.globalTtl);
    for (const table of tables) {
      const keys = this.usedTablesPerKey[table];
      if (keys === undefined) {
        this.usedTablesPerKey[table] = [key];
      } else {
        keys.push(key);
      }
    }
  }

  // å½“æ‰§è¡Œæ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤è¯­å¥æ—¶è°ƒç”¨æ­¤å‡½æ•°ã€‚
  // ä½ å¯ä»¥é€‰æ‹©è·³è¿‡æ­¤æ­¥éª¤æˆ–ä½¿ä½¿ç”¨å—å½±å“è¡¨çš„æŸ¥è¯¢å¤±æ•ˆã€‚
  //
  // è¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé”®çš„å¯¹è±¡ï¼š
  // - 'tags': ç”¨äºæ ‡è®°ä¸ºç‰¹å®šæ ‡ç­¾çš„æŸ¥è¯¢ï¼Œå…è®¸æŒ‰è¯¥æ ‡ç­¾å¤±æ•ˆã€‚
  // - 'tables': ç”±æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤è¯­å¥å½±å“çš„å®é™…è¡¨ï¼Œ
  //   å¸®åŠ©ä½ è·Ÿè¸ªè‡ªä¸Šæ¬¡ç¼“å­˜æ›´æ–°ä»¥æ¥å“ªäº›è¡¨å·²æ›´æ”¹ã€‚
  override async onMutate(params: {
    tags: string | string[];
    tables: string | string[] | Table<any> | Table<any>[];
  }): Promise<void> {
    const tagsArray = params.tags
      ? Array.isArray(params.tags)
        ? params.tags
        : [params.tags]
      : [];
    const tablesArray = params.tables
      ? Array.isArray(params.tables)
        ? params.tables
        : [params.tables]
      : [];

    const keysToDelete = new Set<string>();

    for (const table of tablesArray) {
      const tableName = is(table, Table)
        ? getTableName(table)
        : (table as string);
      const keys = this.usedTablesPerKey[tableName] ?? [];
      for (const key of keys) keysToDelete.add(key);
    }

    if (keysToDelete.size > 0 || tagsArray.length > 0) {
      for (const tag of tagsArray) {
        await this.kv.delete(tag);
      }

      for (const key of keysToDelete) {
        await this.kv.delete(key);
        for (const table of tablesArray) {
          const tableName = is(table, Table)
            ? getTableName(table)
            : (table as string);
          this.usedTablesPerKey[tableName] = [];
        }
      }
    }
  }
}
```

## é™åˆ¶

#### ä¸ä¼šè¢« `cache` æ‰©å±•å¤„ç†çš„æŸ¥è¯¢ï¼š

- ä½¿ç”¨åŸå§‹æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ï¼Œä¾‹å¦‚ï¼š

```ts
db.execute(sql`select 1`);
```

- åœ¨ `d1` å’Œ `libsql` ä¸­ä½¿ç”¨ `batch` åŠŸèƒ½æ—¶ä½¿ç”¨ç¼“å­˜

```ts
db.batch([
    db.insert(users).values(...),
    db.update(users).set(...).where()
])
```

- åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨ç¼“å­˜
```ts
await db.transaction(async (tx) => {
  await tx.update(accounts).set(...).where(...);
  await tx.update...
});
```

#### ç›®å‰æ˜¯ä¸´æ—¶é™åˆ¶ï¼Œç¨åå°†å¤„ç†ï¼š

- ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ—¶ä½¿ç”¨ç¼“å­˜
```ts
await db.query.users.findMany();
```

- ä¸ `better-sqlite3`ã€`Durable Objects`ã€`expo sqlite` ä¸€èµ·ä½¿ç”¨ç¼“å­˜
- ä¸ AWS æ•°æ® API é©±åŠ¨ç¨‹åºä¸€èµ·ä½¿ç”¨ç¼“å­˜
- ä¸è§†å›¾ä¸€èµ·ä½¿ç”¨ç¼“å­˜