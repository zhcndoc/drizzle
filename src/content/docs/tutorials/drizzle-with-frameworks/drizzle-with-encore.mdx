---
title: "使用 Encore 的 Drizzle"
date: "2026-02-02"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="90.6 91 90.9 102.1" fill="currentColor"><path d="M181.4,170.2v22.9H90.6v-69.3c14.4-3.1,28.7-7.1,42.6-12c16.6-5.8,32.7-12.7,48.3-20.8v25.6 c-13.2,6.4-26.9,12-40.8,16.9c-15.7,5.5-31.8,9.9-48.1,13.3v0.2c30.1-2.8,59.7-7.7,88.9-14.5v23.5c-29.2,6.6-58.9,11.3-88.9,14v0.2 H181.4z"/></svg>']
---

import Steps from "@mdx/Steps.astro";
import Npm from "@mdx/Npm.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import CodeTab from "@mdx/CodeTab.astro";
import Section from "@mdx/Section.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

本教程演示如何将 **Drizzle ORM** 与 **Encore** 一起使用，Encore 是一个开源的后端框架，内建基础设施自动化和可观测性功能。

<Prerequisites>
  - 你需要安装 Encore CLI。你可以使用以下命令安装：
  ```bash
  # macOS
  brew install encoredev/tap/encore

  # Linux
  curl -L https://encore.dev/install.sh | bash

  # Windows
  iwr https://encore.dev/install.ps1 | iex
  ```

  - 你需要安装 Drizzle ORM 以及 [Drizzle kit](/docs/kit-overview)。你可以运行以下命令进行安装：
  <Npm>
    drizzle-orm
    -D drizzle-kit
  </Npm>
</Prerequisites>

## 配置 Encore 和 Drizzle ORM

<Steps>
#### 创建一个新的 Encore 项目

你可以创建一个 Drizzle 已预配置的新 Encore 项目：

```bash
encore app create my-app --example=ts/drizzle
cd my-app
```

或者如果你已有现成的 Encore 项目，安装 Drizzle：

<Npm>
  drizzle-orm
  -D drizzle-kit
</Npm>

#### 创建数据库

在 `database.ts` 文件中定义你的数据库。Encore 会自动在本地使用 Docker 预置 PostgreSQL 数据库，部署到云端时亦然：

```typescript copy filename="database.ts"
import { SQLDatabase } from "encore.dev/storage/sqldb";
import { drizzle } from "drizzle-orm/node-postgres";
import * as schema from "./schema";

const db = new SQLDatabase("mydb", {
  migrations: {
    path: "migrations",
    source: "drizzle",
  },
});

export const orm = drizzle(db.connectionString, { schema });
```

将 `source: "drizzle"` 设定为告诉 Encore 使用 Drizzle 的迁移格式。

#### 定义你的 Schema

创建 `schema.ts` 文件来定义表：

```typescript copy filename="schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text().notNull(),
  email: p.text().unique().notNull(),
  createdAt: p.timestamp().defaultNow().notNull(),
});
```

#### 配置 Drizzle 配置文件

创建 `drizzle.config.ts` 文件：

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  out: "migrations",
  schema: "schema.ts",
  dialect: "postgresql",
});
```

#### 生成迁移文件

运行 Drizzle Kit 从你的 Schema 生成迁移：

```bash
drizzle-kit generate
```

这会在 `migrations` 文件夹中生成迁移文件。

#### 创建 API 端点

在你的 Encore 端点中使用 Drizzle：

```typescript copy filename="users.ts"
import { api } from "encore.dev/api";
import { orm } from "./database";
import { users } from "./schema";
import { eq } from "drizzle-orm";

interface User {
  id: number;
  name: string;
  email: string;
}

export const list = api(
  { expose: true, method: "GET", path: "/users" },
  async (): Promise<{ users: User[] }> => {
    const result = await orm.select().from(users);
    return { users: result };
  }
);

export const create = api(
  { expose: true, method: "POST", path: "/users" },
  async (req: { name: string; email: string }): Promise<User> => {
    const [user] = await orm
      .insert(users)
      .values({ name: req.name, email: req.email })
      .returning();
    return user;
  }
);
```

#### 运行你的应用

启动你的 Encore 应用：

```bash
encore run
```

Encore 在启动时自动应用迁移。打开 [localhost:9400](http://localhost:9400) 可查看本地仪表盘，包含 API 文档、数据库浏览器及追踪功能。
</Steps>

<Callout type="info">
当你运行 Encore 应用时，迁移会自动应用。你不需要手动执行 `drizzle-kit migrate`。
</Callout>

## 了解更多

- [Encore 文档](https://encore.dev/docs)
- [Encore Drizzle 指南](https://encore.dev/docs/ts/develop/orms/drizzle)
- [Drizzle ORM 文档](/docs/overview)