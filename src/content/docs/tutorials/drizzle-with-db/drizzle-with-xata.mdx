---
title: "ä½¿ç”¨ Drizzle è¿æ¥ Xata"
date: "2024-12-13"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>']
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•å°† Drizzle ORM ä¸ [Xata](https://xata.io) ä¸€èµ·ä½¿ç”¨ã€‚Xata æ˜¯ä¸€ä¸ª PostgreSQL æ•°æ®åº“å¹³å°ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ›´é«˜æ•ˆåœ°è¿ç»´å’Œæ‰©å±•æ•°æ®åº“ï¼Œå…·å¤‡å³æ—¶å†™æ—¶å¤åˆ¶æ•°æ®åº“åˆ†æ”¯ã€é›¶åœæœºæ¨¡å¼çš„æ¶æ„å˜æ›´ã€æ•°æ®åŒ¿ååŒ–ä»¥åŠ AI é©±åŠ¨çš„æ€§èƒ½ç›‘æ§ç­‰åŠŸèƒ½ã€‚

<Prerequisites>
- ä½ éœ€è¦å…ˆå®‰è£… Drizzle ORM å’Œ [Drizzle Kit](/docs/kit-overview)ã€‚å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- ä½ éœ€è¦å®‰è£… `dotenv` åŒ…æ¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚å¯åœ¨è¿™é‡Œäº†è§£æ›´å¤šè¯¥åŒ…ä¿¡æ¯ï¼š[dotenv](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>

- ä½ éœ€è¦å®‰è£… `postgres` åŒ…ä»¥è¿æ¥ Postgres æ•°æ®åº“ã€‚è¯¦ç»†ä»‹ç»è§ï¼š[postgres](https://www.npmjs.com/package/postgres)
<Npm>
  postgres
</Npm>

- ä½ éœ€è¦æ‹¥æœ‰ä¸€ä¸ª Xata è´¦å·åŠå·²åˆ›å»ºæ•°æ®åº“ã€‚å‚è€ƒ [Xata æ–‡æ¡£](https://xata.io/documentation/getting-started) åˆ›å»ºè´¦æˆ·åŠæ•°æ®åº“ã€‚
</Prerequisites>

æŸ¥çœ‹[Xata æ–‡æ¡£](https://xata.io/documentation/quickstarts/drizzle)ä»¥äº†è§£æ›´å¤š Drizzle ORM ä¸ Xata çš„ä½¿ç”¨èµ„è®¯ã€‚

## è®¾ç½® Xata å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Xata æ•°æ®åº“

æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä¸€ä¸ªæ–°çš„ Xata æ•°æ®åº“ï¼š

1. æ³¨å†Œæˆ–ç™»å½•ä½ çš„ [Xata è´¦å·](https://xata.io/)
2. ä»ä»ªè¡¨ç›˜åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“
3. é€‰æ‹©ä½ æ‰€åœ¨åŒºåŸŸåŠæ•°æ®åº“åç§°
4. ç³»ç»Ÿå°†åˆ›å»ºå¸¦æœ‰ PostgreSQL ç«¯ç‚¹çš„æ•°æ®åº“

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

è¿›å…¥ Xata ä»ªè¡¨ç›˜ï¼Œå¤åˆ¶ PostgreSQL è¿æ¥å­—ç¬¦ä¸²ï¼Œè¯¥ä¿¡æ¯å¯åœ¨åˆ†æ”¯æ€»è§ˆé¡µæ‰¾åˆ°ã€‚

å°† `DATABASE_URL` å˜é‡æ·»åŠ è‡³ä½ çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ï¼š

```plaintext copy
DATABASE_URL=<YOUR_XATA_DATABASE_URL>
```

è¿æ¥å­—ç¬¦ä¸²æ ¼å¼ç¤ºä¾‹å¦‚ä¸‹ï¼š
```plaintext
postgresql://postgres:<password>@<branch-id>.<region>.xata.tech/<database>?sslmode=require
```

ç¤ºä¾‹ï¼š
```plaintext
postgresql://postgres:password@t56hgfp7hd2sjfeiqcn66qpo8s.us-east-1.xata.tech/app?sslmode=require
```

<Callout type="info">
Xata æä¾›äº†åŸºäºåˆ†æ”¯çš„å¼€å‘ï¼Œå…è®¸ä½ ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒåˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“åˆ†æ”¯ã€‚
</Callout>

#### è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸‹åˆ›å»º `index.ts` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ï¼š

```typescript copy filename="src/db/index.ts"
import { config } from 'dotenv';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

config({ path: '.env' }); // æˆ–è€… .env.local

const client = postgres(process.env.DATABASE_URL!);
export const db = drizzle({ client });
```

#### åˆ›å»ºè¡¨ç»“æ„

åœ¨ `src/db` ç›®å½•ä¸‹æ–°å»º `schema.ts` æ–‡ä»¶ï¼Œå£°æ˜æ•°æ®è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### é…ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®æ–‡ä»¶**ç”¨äº [Drizzle Kit](/docs/kit-overview)ï¼ŒåŒ…å«æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€è¿ç§»æ–‡ä»¶å¤¹è·¯å¾„å’Œ schema æ–‡ä»¶è·¯å¾„ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### åº”ç”¨æ•°æ®åº“å˜æ›´

ä½ å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼Œå†ç”¨ `drizzle-kit migrate` å‘½ä»¤æ¥æ‰§è¡Œè¿ç§»ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿ç§»æ–‡ä»¶å­˜å‚¨äº `migrations` ç›®å½•ï¼ˆç”±ä½ çš„ `drizzle.config.ts` æŒ‡å®šï¼‰ï¼Œè¯¥ç›®å½•åŒ…å«æ›´æ–°æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µçš„ schema å¿«ç…§ã€‚

ç¤ºä¾‹ç”Ÿæˆçš„è¿ç§»å†…å®¹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

æ‰§è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

è¯¦ç»†äº†è§£[è¿ç§»æµç¨‹](/docs/migrations)ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ [Drizzle kit çš„ push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥æ¨é€å˜æ›´åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºéœ€è¦åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒå¿«é€Ÿæµ‹è¯•æ–° schema è®¾è®¡æˆ–å˜æ›´ï¼Œå…è®¸å¿«é€Ÿè¿­ä»£è€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„åœºæ™¯ã€‚</Callout>

<Callout type="info">
**Xata åˆ†æ”¯å¼€å‘**ï¼šXata å…è®¸ä½ ä¸ºä¸åŒç¯å¢ƒåˆ›å»ºæ•°æ®åº“åˆ†æ”¯ï¼Œä½ å¯ä»¥ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§åˆ†æ”¯ä½¿ç”¨ä¸åŒçš„è¿æ¥å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§å‰æµ‹è¯•æ¶æ„æ›´æ”¹ã€‚
</Callout>
</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„å¦‚ä¸‹ã€‚åœ¨ `src/db` ç›®å½•ä¸‹å­˜æ”¾æ•°æ®åº“ç›¸å…³æ–‡ä»¶ï¼ŒåŒ…æ‹¬è¿æ¥é…ç½®çš„ `index.ts` å’Œ schema å®šä¹‰çš„ `schema.ts`ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `src/db/queries` åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œåˆ†åˆ«åˆ›å»ºæ–‡ä»¶ï¼šæ’å…¥ã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ã€‚

#### æ’å…¥æ•°æ®

å…³äºæ’å…¥æŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### æŸ¥è¯¢æ•°æ®

å…³äºæŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/select)ã€‚

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getTableColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getTableColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨[å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

å…³äºæ›´æ–°æŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

å…³äºåˆ é™¤æŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```

## åç»­æ­¥éª¤

å®Œæˆ Drizzle ORM ä¸ Xata çš„æ­å»ºåï¼Œä½ å¯ä»¥ç»§ç»­æ·±å…¥å­¦ä¹ ï¼š

- äº†è§£ [Drizzle å…³ç³»æŸ¥è¯¢](/docs/rqb) ä»¥å®ç°å¤æ‚æŸ¥è¯¢
- æ¢ç´¢ [Xata å®˜æ–¹æ–‡æ¡£](https://xata.io/documentation/)
- å®æ–½ [æ•°æ®åº“è¿ç§»](/docs/migrations) ä»¥ä¾¿ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²