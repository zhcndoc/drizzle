---
title: "ä½¿ç”¨ Vercel Postgres çš„ Drizzle"
date: "2024-06-09"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5L4 19H20L12 5Z" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>]
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ORM ç»“åˆ [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres)ã€‚Vercel Postgres æ˜¯ä¸€ä¸ªæ— æœåŠ¡å™¨ SQL æ•°æ®åº“ï¼Œæ—¨åœ¨ä¸ Vercel Functions å’Œæ‚¨çš„å‰ç«¯æ¡†æ¶é›†æˆã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `@vercel/postgres` åŒ…ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/@vercel/postgres)
<Npm>
  @vercel/postgres
</Npm>  
</Prerequisites>

æŸ¥çœ‹ [Vercel æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/using-an-orm#drizzle)ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“ã€‚

## è®¾ç½® Vercel Postgres å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºæ–°çš„ Vercel Postgres æ•°æ®åº“

æ‚¨å¯ä»¥åœ¨ [æ§åˆ¶é¢æ¿](https://vercel.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Vercel Postgres æ•°æ®åº“ã€‚

è¯·æŸ¥é˜… Vercel Postgres [æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/quickstart) ä»¥äº†è§£å¦‚ä½•åˆ›å»ºæ–°çš„æ•°æ®åº“ã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªè‡³æ‚¨çš„ Vercel Postgres æ•°æ®åº“å¹¶ä» `.env.local` éƒ¨åˆ†å¤åˆ¶ `POSTGRES_URL`ã€‚

å°† `POSTGRES_URL` æ·»åŠ åˆ°æ‚¨çš„ `.env.local` æˆ– `.env` æ–‡ä»¶ä¸­ã€‚

```plaintext copy
POSTGRES_URL=<YOUR_DATABASE_URL>
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { config } from 'dotenv';

config({ path: '.env.local' }); // æˆ– .env

export const db = drizzle();

```

#### åˆ›å»ºè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - è¿™æ˜¯ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env.local' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle/migrations` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨åœ¨ `drizzle.config.ts` ä¸­æŒ‡å®šçš„é‚£æ ·ã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ‚¨çš„æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶ä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µçš„æ¶æ„å¿«ç…§ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œæ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬åœ¨ `index.ts` ä¸­çš„è¿æ¥å’Œåœ¨ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ã€‚

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env.local
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»º `src/db/queries` æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œåˆ†å¼€æ–‡ä»¶ï¼šæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°ã€åˆ é™¤ã€‚

#### æ’å…¥æ•°æ®

æœ‰å…³æ’å…¥æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

æœ‰å…³é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/select)ã€‚

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

æœ‰å…³æ›´æ–°æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

æœ‰å…³åˆ é™¤æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```
