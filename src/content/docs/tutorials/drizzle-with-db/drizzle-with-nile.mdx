---
title: "ä½¿ç”¨ Nile æ•°æ®åº“çš„ Drizzle"
date: "2025-01-15"
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ORM ä¸ [Nile æ•°æ®åº“](https://thenile.dev)ã€‚Nile æ˜¯ä¸ºå¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºé‡æ–°è®¾è®¡çš„ Postgresã€‚

æœ¬æ•™ç¨‹å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ä¸ Nile çš„è™šæ‹Ÿç§Ÿæˆ·æ•°æ®åº“æ¥å¼€å‘ä¸€ä¸ªå®‰å…¨ã€å¯æ‰©å±•çš„å¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºã€‚

æˆ‘ä»¬å°†é€æ­¥æ„å»ºè¿™ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚å¦‚æœæ‚¨æƒ³æŸ¥çœ‹å®Œæ•´çš„ç¤ºä¾‹ï¼Œå¯ä»¥æŸ¥çœ‹å®ƒçš„ [Github ä»“åº“](https://github.com/niledatabase/niledatabase/tree/main/examples/quickstart/drizzle)ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆå®‰è£…ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `node-postgres` åŒ…ä»¥è¿æ¥åˆ° Postgres æ•°æ®åº“ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/node-postgres)
<Npm>
  node-postgres
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `express` åŒ…ä»¥ä½œä¸º Web æ¡†æ¶ã€‚æœ‰å…³ express çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://expressjs.com/)
<Npm>
  express
</Npm>

- æœ¬æŒ‡å—ä½¿ç”¨ [AsyncLocalStorage](https://nodejs.org/api/async_context.html) æ¥ç®¡ç†ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœæ‚¨çš„æ¡†æ¶æˆ–è¿è¡Œæ—¶ä¸æ”¯æŒ `AsyncLocalStorage`ï¼Œæ‚¨å¯ä»¥å‚è€ƒ [Drizzle\<\>Nile](../connect-nile) æ–‡æ¡£ä»¥è·å–æ›¿ä»£é€‰é¡¹ã€‚
</Prerequisites>

## è®¾ç½® Nile å’Œ Drizzle ORM

<Steps>
#### æ³¨å†Œ Nile å¹¶åˆ›å»ºæ•°æ®åº“

å¦‚æœæ‚¨è¿˜æ²¡æœ‰ï¼Œè¯·æ³¨å†Œ [Nile](https://console.thenile.dev)ï¼Œå¹¶æŒ‰ç…§åº”ç”¨è¯´æ˜åˆ›å»ºä¸€ä¸ªæ–°æ•°æ®åº“ã€‚

#### è·å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

åœ¨å·¦ä¾§è¾¹æ ä¸­ï¼Œé€‰æ‹©â€œè®¾ç½®â€é€‰é¡¹ï¼Œç‚¹å‡» Postgres å¾½æ ‡ï¼Œç„¶åç‚¹å‡»â€œç”Ÿæˆå‡­è¯â€ã€‚å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²å¹¶å°†å…¶æ·»åŠ åˆ°é¡¹ç›®ä¸­çš„ `.env` æ–‡ä»¶ï¼š

```plaintext copy
NILEDB_URL=postgres://youruser:yourpassword@us-west-2.db.thenile.dev:5432:5432/your_db_name
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import dotenv from "dotenv/config";
import { sql } from "drizzle-orm";
import { AsyncLocalStorage } from "async_hooks";

export const db = drizzle(process.env.NILEDB_URL);
export const tenantContext = new AsyncLocalStorage<string | undefined>();

export function tenantDB<T>(cb: (tx: any) => T | Promise<T>): Promise<T> {
  return db.transaction(async (tx) => {
    const tenantId = tenantContext.getStore();
    console.log("æ‰§è¡Œå¸¦ç§Ÿæˆ·çš„æŸ¥è¯¢: " + tenantId);
    // å¦‚æœæœ‰ç§Ÿæˆ· IDï¼Œåœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å®ƒ
    if (tenantId) {
      await tx.execute(sql`set local nile.tenant_id = '${sql.raw(tenantId)}'`);
    }

    return cb(tx);
  }) as Promise<T>;
}
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - æ­¤é…ç½®æ–‡ä»¶ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨ï¼ŒåŒ…å«æœ‰å…³æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';
export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.NILEDB_URL!,
  },
});
```

#### è§£æ Nile æ•°æ®åº“

Nile æ•°æ®åº“å…·æœ‰å†…ç½®è¡¨ã€‚å…¶ä¸­æœ€é‡è¦çš„æ˜¯ `tenants` è¡¨ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†ç§Ÿæˆ·ã€‚
ä¸ºäº†èƒ½åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ­¤è¡¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Drizzle Kit CLI ç”ŸæˆåŒ…å«æ­¤æ¶æ„çš„æ¨¡å¼æ–‡ä»¶ã€‚

```bash copy
npx drizzle-kit pull
```

è§£æçš„ç»“æœå°†æ˜¯ä¸€ä¸ª `schema.ts` æ–‡ä»¶ã€ä¸€ä¸ªåŒ…å«æ•°æ®åº“æ¨¡å¼å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€ä¸€ä¸ªå¸¦æœ‰è¿ç§»çš„ sql æ–‡ä»¶å’Œä¸€ä¸ªç”¨äº [å…³ç³»æŸ¥è¯¢](/docs/rqb) çš„ `relations.ts` æ–‡ä»¶ã€‚

<TransferCode/>

è¿™æ˜¯ç”Ÿæˆçš„ `schema.ts` æ–‡ä»¶ç¤ºä¾‹ï¼š

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡è§£æç”Ÿæˆçš„è¡¨æ¨¡å¼
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});
```

#### åˆ›å»ºé™„åŠ è¡¨

é™¤äº†å†…ç½®è¡¨ä¹‹å¤–ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿˜éœ€è¦ä¸€äº›è¡¨æ¥å­˜å‚¨æ•°æ®ã€‚æˆ‘ä»¬å°†å®ƒä»¬æ·»åŠ åˆ°ä¹‹å‰ç”Ÿæˆçš„ `src/db/schema.ts` ä¸­ï¼Œå› æ­¤è¯¥æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡è§£æç”Ÿæˆçš„è¡¨æ¨¡å¼
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});

export const todos = pgTable("todos", {
	id: uuid().defaultRandom(),
	tenantId: uuid("tenant_id"),
	title: varchar({ length: 256 }),
	estimate: varchar({ length: 256 }),
	embedding: vector({ dimensions: 3 }),
	complete: boolean(),
});
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### åˆå§‹åŒ– web åº”ç”¨

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½® Drizzle è¿æ¥åˆ° Nileï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æ¨¡å¼å·²å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤šç§Ÿæˆ· Web åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒä»¬ã€‚
åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Express ä½œä¸º Web æ¡†æ¶ï¼Œå°½ç®¡ Nile å’Œ Drizzle å¯ä»¥ä¸ä»»ä½• Web æ¡†æ¶ä¸€èµ·ä½¿ç”¨ã€‚

ä¸ºäº†ä¿æŒç¤ºä¾‹ç®€å•ï¼Œæˆ‘ä»¬å°†åœ¨å•ä¸ªæ–‡ä»¶ `src/app.ts` ä¸­å®ç° Web åº”ç”¨ã€‚æˆ‘ä»¬å°†é€šè¿‡åˆå§‹åŒ– Web åº”ç”¨å¼€å§‹ï¼š

```typescript copy filename="src/app.ts"
import express from "express";
import { tenantDB, tenantContext, db } from "./db/db";
import {
  tenants as tenantSchema,
  todos as todoSchema,
} from "./db/schema";
import { eq } from "drizzle-orm";

const PORT = process.env.PORT || 3001;

const app = express();
app.listen(PORT, () => console.log(`æœåŠ¡å™¨æ­£åœ¨ç«¯å£ ${PORT} ä¸Šè¿è¡Œ`));
app.use(express.json());
```

#### åˆå§‹åŒ–ç§Ÿæˆ·æ„ŸçŸ¥ä¸­é—´ä»¶

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ç¤ºä¾‹ä¸­æ·»åŠ ä¸­é—´ä»¶ã€‚æ­¤ä¸­é—´ä»¶ä»è·¯å¾„å‚æ•°ä¸­è·å–ç§Ÿæˆ· IDï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ `AsyncLocalStorage` ä¸­ã€‚
æˆ‘ä»¬åœ¨ `src/db/index.ts` ä¸­åˆ›å»ºçš„ `tenantDB` åŒ…è£…å™¨ä½¿ç”¨è¯¥ç§Ÿæˆ· ID åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶è®¾ç½® `nile.tenant_id`ï¼Œè¿™ç¡®ä¿äº†ä¸€æ—¦æŸ¥è¯¢å°†é’ˆå¯¹è¯¥ç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“æ‰§è¡Œã€‚

```typescript copy filename="src/app.ts"
// æ ¹æ® URL å‚æ•°åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç§Ÿæˆ· ID
app.use('/api/tenants/:tenantId/*', (req, res, next) => {
  const tenantId = req.params.tenantId;
  console.log("è®¾ç½®ä¸Šä¸‹æ–‡ä¸ºç§Ÿæˆ·: " + tenantId);
  tenantContext.run(tenantId, next);
});
```

<Callout>
è¯¥ç¤ºä¾‹ä»è·¯å¾„å‚æ•°è·å–ç§Ÿæˆ· IDï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡ `x-tenant-id` çš„æ ‡å¤´æˆ– cookie æ¥è®¾ç½®ç§Ÿæˆ· IDã€‚
</Callout>

#### æ·»åŠ è·¯ç”±

æœ€åï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›è·¯ç”±ï¼Œç”¨äºåˆ›å»ºå’Œåˆ—å‡ºç§Ÿæˆ·åŠå¾…åŠäº‹é¡¹ã€‚æ³¨æ„æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ `tenantDB` åŒ…è£…å™¨æ¥è¿æ¥ç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“ã€‚
åŒæ ·æ³¨æ„ï¼Œåœ¨ `app.get("/api/tenants/:tenantId/todos"` ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨æŸ¥è¯¢ä¸­æŒ‡å®š `where tenant_id=...`ã€‚
è¿™æ°æ°æ˜¯å› ä¸ºæˆ‘ä»¬è·¯ç”±åˆ°è¯¥ç§Ÿæˆ·çš„æ•°æ®åº“ï¼Œä¸”æŸ¥è¯¢ä¸èƒ½è¿”å›å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®ã€‚

```typescript copy filename="src/app.ts" {6,20,39,58,62,75,83}
// åˆ›å»ºæ–°ç§Ÿæˆ·
app.post("/api/tenants", async (req, res) => {
  try {
    const name = req.body.name;
    var tenants: any = null;
    tenants = await tenantDB(async (tx) => {
        return await tx.insert(tenantSchema).values({ name }).returning();
    });
    res.json(tenants);
  } catch (error: any) {
    console.log("åˆ›å»ºç§Ÿæˆ·æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// è¿”å›ç§Ÿæˆ·åˆ—è¡¨
app.get("/api/tenants", async (req, res) => {
  let tenants: any = [];
  try {
      tenants = await tenantDB(async (tx) => {
        return await tx.select().from(tenantSchema);
      });
    res.json(tenants);
  } catch (error: any) {
    console.log("åˆ—å‡ºç§Ÿæˆ·æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// ä¸ºç§Ÿæˆ·æ·»åŠ æ–°ä»»åŠ¡
app.post("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    const { title, complete } = req.body;
    if (!title) {
      res.status(400).json({message: "æœªæä¾›ä»»åŠ¡æ ‡é¢˜",});
    }
    const tenantId = req.params.tenantId;

    const newTodo = await tenantDB(async (tx) => {
      return await tx
        .insert(todoSchema)
        .values({ tenantId, title, complete })
        .returning();
    });
    // è¿”å›æ—¶ä¸åŒ…æ‹¬ embedding å‘é‡ï¼Œå› ä¸ºå®ƒå¾ˆå¤§ä¸”æ— ç”¨
    res.json(newTodo);
  } catch (error: any) {
    console.log("æ·»åŠ ä»»åŠ¡æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// æ›´æ–°ç§Ÿæˆ·çš„ä»»åŠ¡
// å› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­æœ‰ç§Ÿæˆ·ï¼Œæ‰€ä»¥ä¸éœ€è¦ where å­å¥
app.put("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    const { id, complete } = req.body;
    await tenantDB(async (tx) => {
      return await tx
        .update(todoSchema)
        .set({ complete })
        .where(eq(todoSchema.id, id));
    });
    res.sendStatus(200);
  } catch (error: any) {
    console.log("æ›´æ–°ä»»åŠ¡æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// è·å–ç§Ÿæˆ·çš„æ‰€æœ‰ä»»åŠ¡
app.get("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    // è¿™é‡Œä¸éœ€è¦â€œwhereâ€å­å¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®äº†ç§Ÿæˆ· ID
    const todos = await tenantDB(async (tx) => {
      return await tx
        .select({
          id: todoSchema.id,
          tenant_id: todoSchema.tenantId,
          title: todoSchema.title,
          estimate: todoSchema.estimate,
        })
        .from(todoSchema);
    });
    res.json(todos);
  } catch (error: any) {
    console.log("åˆ—å‡ºä»»åŠ¡æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: error.message,});
  }
});
```

#### å°è¯•ä¸€ä¸‹ï¼

æ‚¨ç°åœ¨å¯ä»¥è¿è¡Œæ‚¨çš„æ–° Web åº”ç”¨ï¼š

```bash copy
npx tsx src/app.ts
```

å¹¶ä½¿ç”¨ `curl` å°è¯•æ‚¨åˆšåˆšåˆ›å»ºçš„è·¯ç”±ï¼š

```bash
# åˆ›å»ºä¸€ä¸ªç§Ÿæˆ·
curl --location --request POST 'localhost:3001/api/tenants' \
--header 'Content-Type: application/json' \
--data-raw '{"name":"æˆ‘çš„ç¬¬ä¸€ä¸ªå®¢æˆ·"}'

# è·å–ç§Ÿæˆ·åˆ—è¡¨
curl  -X GET 'http://localhost:3001/api/tenants'

# åˆ›å»ºå¾…åŠäº‹é¡¹ï¼ˆè¯·åŠ¡å¿…åœ¨ URL ä¸­ä½¿ç”¨çœŸå®çš„ç§Ÿæˆ· IDï¼‰
curl  -X POST \
  'http://localhost:3001/api/tenants/108124a5-2e34-418a-9735-b93082e9fbf2/todos' \
  --header 'Content-Type: application/json' \
  --data-raw '{"title": "å–‚çŒ«", "complete": false}'

# åˆ—å‡ºç§Ÿæˆ·çš„å¾…åŠäº‹é¡¹ï¼ˆè¯·åŠ¡å¿…åœ¨ URL ä¸­ä½¿ç”¨çœŸå®çš„ç§Ÿæˆ· IDï¼‰
curl  -X GET \
  'http://localhost:3001/api/tenants/108124a5-2e34-418a-9735-b93082e9fbf2/todos'
```
</Steps>

## é¡¹ç›®æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬ `db.ts` ä¸­çš„è¿æ¥å’Œ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ã€‚
ç”±è¿ç§»å’Œè§£æç”Ÿæˆçš„æ–‡ä»¶ä½äº `./drizzle` ä¸­ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ db.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”‚   â”” ğŸ“œ app.ts
 â”œ ğŸ“‚ drizzle
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”œ ğŸ“œ relations.ts
 â”‚   â”œ ğŸ“œ schema.ts
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```