import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import Section from '@mdx/Section.astro';
import Npx from "@mdx/Npx.astro";
import Npm from "@mdx/Npm.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';

# è¿ç§»åˆ°å…³ç³»æŸ¥è¯¢ç‰ˆæœ¬ 2

<Callout type='error'>
æœ¬æ–‡æ¡£ä»‹ç»çš„æ˜¯ drizzle ç‰ˆæœ¬ `1.0.0-beta.1` åŠä»¥ä¸Šæ”¯æŒçš„æ¦‚å¿µã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

<Prerequisites>
- **Drizzle Relations v1** - [ç‚¹å‡»æŸ¥çœ‹](/docs/relations)
- **å…³ç³»æŸ¥è¯¢ v1** - [ç‚¹å‡»æŸ¥çœ‹](/docs/rqb)
- **drizzle-kit pull** - [ç‚¹å‡»æŸ¥çœ‹](/docs/drizzle-kit-pull)
- **å…³ç³»åŸºç¡€çŸ¥è¯†** - [ç‚¹å‡»æŸ¥çœ‹](/docs/relations-schema-declaration)
</Prerequisites>

<Callout>
ä»¥ä¸‹æ˜¯ç›®å½•ã€‚ç‚¹å‡»æ¡ç›®å¯è·³è½¬åˆ°å¯¹åº”ç« èŠ‚ï¼š

- [ç›¸æ¯” v1 æœ‰å“ªäº›ä¸åŒ](#what-was-changed-and-is-working-differently-from-v1)  
- [v2 æ–°åŠŸèƒ½](2#what-is-new)  
- [å¦‚ä½•å°†å…³ç³»å®šä¹‰ä» v1 è¿ç§»åˆ° v2](#how-to-migrate-relations-schema-definition-from-v1-to-v2)  
- [å¦‚ä½•å°†æŸ¥è¯¢ä» v1 è¿ç§»åˆ° v2](#how-to-migrate-queries-from-v1-to-v2)  
- [éƒ¨åˆ†å‡çº§ï¼Œæˆ–å‡çº§åå¦‚ä½•ç»§ç»­ä½¿ç”¨ v1ï¼Ÿ](#partial-upgrade-or-how-to-stay-on-rqb-v1-even-after-an-upgrade)  
- [å†…éƒ¨å˜åŒ–ï¼ˆå¯¼å…¥ã€å†…éƒ¨ç±»å‹ç­‰ï¼‰](#internal-changes)
</Callout>

### API å˜åŒ–
#### ç›¸æ¯” v1 æœ‰å“ªäº›ä¸åŒ

{/* ##### Drizzle Relations schema definition */}

æœ€ä¸»è¦çš„æ›´æ–°ä¹‹ä¸€æ˜¯ **å…³ç³»æ¨¡å¼å®šä¹‰ï¼ˆRelations Schema å®šä¹‰ï¼‰**

ç¬¬ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œä½ ä¸å†éœ€è¦ä¸ºæ¯ä¸ªè¡¨åˆ†åˆ«åœ¨ä¸åŒå¯¹è±¡ä¸­æŒ‡å®š `relations`ï¼Œç„¶åå†è¿åŒ schema ä¸€èµ·ä¼ ç»™ `drizzle()`ã€‚åœ¨å…³ç³»æŸ¥è¯¢ v2 ä¸­ï¼Œä½ åªæœ‰ä¸€ä¸ªä¸“é—¨çš„ä½ç½®æ¥ä¸ºæ‰€æœ‰éœ€è¦çš„è¡¨æŒ‡å®šå…¨éƒ¨å…³ç³»ã€‚

å›è°ƒå‡½æ•°ä¸­çš„å‚æ•° `r` æä¾›äº†ç»¼åˆçš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ â€”â€” åŒ…å«ä½  schema ä¸­çš„æ‰€æœ‰è¡¨ï¼Œä»¥åŠ `one`ã€`many`ã€`through` è¿™ç±»å‡½æ•° â€”â€” æœ¬è´¨ä¸Šä¸ºä½ æŒ‡å®šå…³ç³»æä¾›äº†ä¸€åˆ‡æ‰€éœ€ã€‚

```ts
// relations.ts
import * as schema from "./schema"
import { defineRelations } from "drizzle-orm"

export const relations = defineRelations(schema, (r) => ({
    ...
}));
```
```ts
// index.ts
import { relations } from "./relations"
import { drizzle } from "drizzle-orm/..."

const db = drizzle(process.env.DATABASE_URL, { relations })
```

##### æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

<Callout collapsed="Schema Definition">
```ts copy {21-28}
import * as p from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text(),
	invitedBy: p.integer('invited_by'),
});

export const posts = p.pgTable('posts', {
	id: p.integer().primaryKey(),
	content: p.text(),
	authorId: p.integer('author_id'),
});
```
</Callout>

**æ‰€æœ‰å…³ç³»é›†ä¸­åˆ°ä¸€ä¸ªåœ°æ–¹**

<Callout title="âŒ v1">
```ts
import { relations } from "drizzle-orm/_relations";
import { users, posts } from './schema';

export const usersRelation = relations(users, ({ one, many }) => ({
  invitee: one(users, {
    fields: [users.invitedBy],
    references: [users.id],
  }),
  posts: many(posts),
}));

export const postsRelation = relations(posts, ({ one, many }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}));
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  },
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  },
}));
```
</Callout>

ä½ ä»ç„¶å¯ä»¥å°†å…¶æ‹†åˆ†æˆä¸åŒçš„ `parts`ï¼Œä¸” parts çš„å¤§å°ç”±ä½ å†³å®š

```ts
import { defineRelations, defineRelationsPart } from 'drizzle-orm';
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  }
}));

export const part = defineRelationsPart(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  }
}));
```

ç„¶åä½ å¯ä»¥è¿™æ ·ä¼ ç»™æ•°æ®åº“å®ä¾‹

```ts
const db = drizzle(process.env.DB_URL, { relations: { ...relations, ...part } })
```

**å®šä¹‰ `many` æ—¶å¯ä»¥ä¸ä¾èµ– `one`**

v1 ä¸­ï¼Œå¦‚æœä½ åªæƒ³å®šä¹‰å…³ç³»çš„ `many` ç«¯ï¼Œå¿…é¡»åœ¨å¦ä¸€ç«¯å®šä¹‰å¯¹åº”çš„ `one`ï¼Œè¿™ä½¿å¼€å‘ä½“éªŒè¾ƒå·®ã€‚

v2 ä¸­ï¼Œä½ å¯ä»¥ç®€å•åœ°åªç”¨ `many`ï¼Œæ— éœ€é¢å¤–æ“ä½œã€‚

<Callout title="âŒ v1">
```ts
import { relations } from "drizzle-orm/_relations";
import { users, posts } from './schema';

export const usersRelation = relations(users, ({ one, many }) => ({
  posts: many(posts),
}));

export const postsRelation = relations(posts, ({ one, many }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}));
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    posts: r.many.posts({
      from: r.users.id,
      to: r.posts.authorId,
    }),
  },
}));
```
</Callout>

**æ–°å¢ `optional` é€‰é¡¹**

ç±»å‹å±‚é¢ä¸Šçš„ `optional: false` ä¼šè®© `posts` å¯¹è±¡ä¸­çš„ `author` å±æ€§å˜æˆå¿…éœ€ã€‚åº”åœ¨ç¡®å®šå¯¹åº”å®ä½“ä¸€å®šå­˜åœ¨æ—¶ä½¿ç”¨ã€‚

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
```ts {9}
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    posts: r.many.posts({
      from: r.users.id,
      to: r.posts.authorId,
      optional: false,
    }),
  },
}));
```
</Callout>

**`drizzle()` ä¸å†éœ€è¦æŒ‡å®šæ¨¡å¼ï¼ˆmodeï¼‰**

æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ç§å¯¹æ‰€æœ‰ MySQL æ–¹è¨€é€šç”¨çš„ç­–ç•¥ï¼Œå› æ­¤æ— éœ€å†æŒ‡å®šæ¨¡å¼ã€‚

<Callout title="âŒ v1">
```ts
import * as schema from './schema'

const db = drizzle(process.env.DATABASE_URL, { mode: "planetscale", schema });
// æˆ–è€…
const db = drizzle(process.env.DATABASE_URL, { mode: "default", schema });
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { relations } from './relations'

const db = drizzle(process.env.DATABASE_URL, { relations });
```
</Callout>

**`from` å’Œ `to` çš„å‡çº§**

å°† `fields` é‡å‘½åä¸º `from`ï¼Œ`references` é‡å‘½åä¸º `to`ï¼Œä¸¤è€…éƒ½æ”¯æŒå•å€¼æˆ–æ•°ç»„ã€‚

<Callout title="âŒ v1">
```ts
...
author: one(users, {
  fields: [posts.authorId],
  references: [users.id],
}),
...
```
</Callout>

<Callout title='âœ… v2'>
```ts
... 
author: r.one.users({
  from: r.posts.authorId,
  to: r.users.id,
}),
...
```
```ts
... 
author: r.one.users({
  from: [r.posts.authorId],
  to: [r.users.id],
}),
...
```
</Callout>

**`relationName` æ”¹ä¸º `alias`**

<Callout title="âŒ v1">
```ts
import { relations } from "drizzle-orm/_relations";
import { users, posts } from './schema';

export const postsRelation = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
	  relationName: "author_post",
  }),
}));
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
      alias: "author_post",
    }),
  },
}));
```
</Callout>

**è‡ªå®šä¹‰ç±»å‹çš„æ–°å‡½æ•°**

æ–°å¢ä¸€äº›å‡½æ•°ç”¨äºæ§åˆ¶å…³ç³»æŸ¥è¯¢ v2 ä¸­çš„æ•°æ®æ˜ å°„ï¼š

<Callout collapsed='fromJson'>
å¯é€‰çš„æ˜ å°„å‡½æ•°ï¼Œç”¨äºå°†æ•°æ®åº“ä¸­è½¬ä¸º JSON è¿”å›çš„æ•°æ®è½¬æ¢ä¸ºæœŸæœ›æ ¼å¼ã€‚

ä¾‹å¦‚å½“é€šè¿‡ [RQB](https://orm.drizzle.team/docs/rqb-v2) æˆ– [JSON å‡½æ•°](https://orm.drizzle.team/docs/json-functions) æŸ¥è¯¢ bigint åˆ—æ—¶ï¼Œè¿”å›çš„å­—æ®µä¼šæ˜¯å­—ç¬¦ä¸²å½¢å¼ï¼Œè€Œéæ™®é€šæŸ¥è¯¢ä¸­çš„ bigint ç±»å‹ã€‚

æ­¤å‡½æ•°ç”¨æ¥å¤„ç†è¯¥å­—æ®µçš„æ˜ å°„ï¼š

```ts
fromJson(value: string): bigint {
	return BigInt(value);
},
```

ä¼šä½¿è¿”å›æ•°æ®ä»ï¼š

```ts
{
	customField: "5044565289845416380";
}
```

å˜ä¸ºï¼š

```ts
{
	customField: 5044565289845416380n;
}
```
</Callout> 
<Callout collapsed='forJsonSelect'>
å¯é€‰çš„é€‰æ‹©ä¿®æ”¹å‡½æ•°ï¼Œç”¨äºæ›´æ”¹ [JSON å‡½æ•°](https://orm.drizzle.team/docs/json-functions) å†…åˆ—çš„é€‰å–æ–¹å¼ã€‚

é’ˆå¯¹è¿™ç±»åœºæ™¯çš„é¢å¤–æ˜ å°„å¯ç”¨ fromJson å‡½æ•°å¤„ç†ã€‚

ç”± [å…³ç³»æŸ¥è¯¢](https://orm.drizzle.team/docs/rqb-v2) ä½¿ç”¨ã€‚

ä¸¾ä¾‹è€Œè¨€ï¼Œä½¿ç”¨ bigint ç±»å‹æ—¶éœ€è¦å¼ºåˆ¶å­—æ®µè½¬æ¢ä¸ºæ–‡æœ¬ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§ï¼š

```ts
forJsonSelect(identifier: SQL, sql: SQLGenerator, arrayDimensions?: number): SQL {
	return sql`${identifier}::text`
},
```

ä½¿æŸ¥è¯¢ä»ï¼š

```sql
SELECT
	row_to_json("t".*)
	FROM
	(
		SELECT
		"table"."custom_bigint" AS "bigint"
		FROM
		"table"
	) AS "t"
```

å˜ä¸ºï¼š

```sql
SELECT
	row_to_json("t".*)
	FROM
	(
		SELECT
		"table"."custom_bigint"::text AS "bigint"
		FROM
		"table"
	) AS "t"
```

æŸ¥è¯¢å¯¹è±¡è¿”å›å€¼ä»ï¼š

```ts
{
	bigint: 5044565289845416000; // ç”±äºç›´æ¥è½¬ JSONï¼Œæ•°æ®éƒ¨åˆ†ä¸¢å¤±
}
```

å˜ä¸ºï¼š

```ts
{
	bigint: "5044565289845416380"; // è½¬ä¸º text å†è½¬ JSONï¼Œæ•°æ®å¾—ä»¥ä¿ç•™
}
```
</Callout>

<Callout title='âœ… v2'>
```ts
const customBytes = customType<{
 	data: Buffer;
 	driverData: Buffer;
 	jsonData: string;
 }>({
 	dataType: () => 'bytea',
 	fromJson: (value) => {
 		return Buffer.from(value.slice(2, value.length), 'hex');
 	},
 	forJsonSelect: (identifier, sql, arrayDimensions) =>
 		sql`${identifier}::text${sql.raw('[]'.repeat(arrayDimensions ?? 0))}`,
 });
```

</Callout>

##### æœ‰å“ªäº›æ–°å¢ï¼Ÿ

**å¤šå¯¹å¤šå…³ç³»çš„ `through`**

ä¹‹å‰ï¼Œä½ éœ€è¦æ˜¾å¼é€šè¿‡è”ç»“è¡¨æŸ¥è¯¢ï¼Œç„¶ååœ¨æ¯æ¬¡å“åº”ä¸­æ˜ å°„å®ƒã€‚

ç°åœ¨ä¸éœ€è¦å†è¿™æ ·åšäº†ï¼

<Callout collapsed='Schema'>
```ts
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.integer().primaryKey(),
  name: p.text(),
  verified: p.boolean().notNull(),
});

export const groups = p.pgTable("groups", {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const usersToGroups = p.pgTable(
  "users_to_groups",
  {
    userId: p
      .integer("user_id")
      .notNull()
      .references(() => users.id),
    groupId: p
      .integer("group_id")
      .notNull()
      .references(() => groups.id),
  },
  (t) => [p.primaryKey({ columns: [t.userId, t.groupId] })]
);
```
</Callout>

<Callout title="âŒ v1">
```ts
export const usersRelations = relations(users, ({ many }) => ({
  usersToGroups: many(usersToGroups),
}));

export const groupsRelations = relations(groups, ({ many }) => ({
  usersToGroups: many(usersToGroups),
}));

export const usersToGroupsRelations = relations(usersToGroups, ({ one }) => ({
  group: one(groups, {
    fields: [usersToGroups.groupId],
    references: [groups.id],
  }),
  user: one(users, {
    fields: [usersToGroups.userId],
    references: [users.id],
  }),
}));
```
```ts
// æŸ¥è¯¢ç¤ºä¾‹
const response = await db.query.users.findMany({
  with: {
    usersToGroups: {
      columns: {},
      with: {
        group: true,
      },
    },
  },
});
```
</Callout>

<Callout title='âœ… v2'>
```ts
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';

export const relations = defineRelations(schema, (r) => ({
  users: {
    groups: r.many.groups({
      from: r.users.id.through(r.usersToGroups.userId),
      to: r.groups.id.through(r.usersToGroups.groupId),
    }),
  },
  groups: {
    participants: r.many.users(),
  },
}));
```
```ts
// æŸ¥è¯¢ç¤ºä¾‹
const response = await db.query.users.findMany({
  with: {
    groups: true,
  },
});
```
</Callout>

**é¢„å®šä¹‰è¿‡æ»¤å™¨**

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
```ts {10-12}
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';

export const relations = defineRelations(schema,
  (r) => ({
    groups: {
      verifiedUsers: r.many.users({
        from: r.groups.id.through(r.usersToGroups.groupId),
        to: r.users.id.through(r.usersToGroups.userId),
        where: {
          verified: true,
        },
      }),
    },
  })
);
```
```ts {4}
// æŸ¥è¯¢ç¤ºä¾‹ï¼šè·å–æ‰€æœ‰åŒ…å«å·²éªŒè¯ç”¨æˆ·çš„ç»„
const response = await db.query.groups.findMany({
  with: {
    verifiedUsers: true,
  },
});
```
</Callout>

##### `where` ç°åœ¨æ˜¯å¯¹è±¡

<Callout title="âŒ v1">
```ts
const response = db._query.users.findMany({
  where: (users, { eq }) => eq(users.id, 1),
});
```
</Callout>

<Callout title="âœ… v2">
```ts
const response = db.query.users.findMany({
  where: {
    id: 1,
  },
});
```

å®Œæ•´ API å‚è€ƒè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [é€‰æ‹©è¿‡æ»¤å™¨æ–‡æ¡£](/docs/rqb-v2#select-filters)
</Callout>

<Callout collapsed='ä½¿ç”¨ RAW çš„å¤æ‚è¿‡æ»¤ç¤ºä¾‹'>
```ts
// schema.ts
import { integer, jsonb, pgTable, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: integer("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  age: integer("age"),
  createdAt: timestamp("created_at").defaultNow(),
  lastLogin: timestamp("last_login"),
  subscriptionEnd: timestamp("subscription_end"),
  lastActivity: timestamp("last_activity"),
  preferences: jsonb("preferences"),      // å­˜å‚¨ç”¨æˆ·è®¾ç½®/åå¥½çš„ JSON åˆ—
  interests: text("interests").array(),  // å­˜å‚¨ç”¨æˆ·å…´è¶£çš„æ•°ç»„åˆ—
});
```
```ts
const response = db.query.users.findMany({
  where: {
    AND: [
      {
        OR: [
          { RAW: (table) => sql`LOWER(${table.name}) LIKE 'john%'` },
          { name: { ilike: "jane%" } },
        ],
      },
      {
        OR: [
          { RAW: (table) => sql`${table.preferences}->>'theme' = 'dark'` },
          { RAW: (table) => sql`${table.preferences}->>'theme' IS NULL` },
        ],
      },
      { RAW: (table) => sql`${table.age} BETWEEN 25 AND 35` },
    ],
  },
});
```
</Callout>

##### `orderBy` ç°åœ¨æ˜¯å¯¹è±¡

<Callout title="âŒ v1">
```ts
const response = db._query.users.findMany({
  orderBy: (users, { asc }) => [asc(users.id)],
});
```
</Callout>

<Callout title="âœ… v2">
```ts
const response = db.query.users.findMany({
  orderBy: { id: "asc" },
});
```
</Callout>

##### é€šè¿‡å…³ç³»è¿‡æ»¤

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
ç¤ºä¾‹ï¼šè·å– ID å¤§äº 10ï¼Œä¸”è‡³å°‘æ‹¥æœ‰ä¸€ä¸ªå†…å®¹ä»¥ â€œMâ€ å¼€å¤´å¸–å­ï¼ˆpostï¼‰çš„ç”¨æˆ·

```ts
const usersWithPosts = await db.query.usersTable.findMany({
  where: {
    id: {
      gt: 10
    },
    posts: {
      content: {
        like: 'M%'
      }
    }
  },
});
```
</Callout>

##### å…³è”å¯¹è±¡ä¸­ä½¿ç”¨ `offset`

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
```ts
await db.query.posts.findMany({
	limit: 5,
	offset: 2, // æ­£ç¡® âœ…
	with: {
		comments: {
			offset: 3, // æ­£ç¡® âœ…
			limit: 3,
		},
	},
});
```
</Callout>

#### å¦‚ä½•å°†å…³ç³»å®šä¹‰ä» v1 è¿ç§»åˆ° v2

##### **æ–¹æ¡ˆ 1**ï¼šä½¿ç”¨ `drizzle-kit pull`

æ–°ç‰ˆæœ¬çš„ `drizzle-kit pull` æ”¯æŒä»¥æ–°è¯­æ³•æ‹‰å– `relations.ts` æ–‡ä»¶ï¼š

##### ç¬¬ 1 æ­¥

<Npx>
drizzle-kit pull
</Npx>

#### ç¬¬ 2 æ­¥ 

å°† `drizzle/relations.ts` ä¸­ç”Ÿæˆçš„ relations ä»£ç è¿ç§»åˆ°ä½ ç”¨äºå®šä¹‰å…³ç³»çš„æ–‡ä»¶ä¸­ 
```plaintext {4-5}
 â”œ ğŸ“‚ drizzle
 â”‚ â”œ ğŸ“‚ meta
 â”‚ â”œ ğŸ“œ migration.sql
 â”‚ â”œ ğŸ“œ relations.ts â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ â”” ğŸ“œ schema.ts            |
 â”œ ğŸ“‚ src                    â”‚ 
 â”‚ â”œ ğŸ“‚ db                   â”‚
 â”‚ â”‚ â”œ ğŸ“œ relations.ts <â”€â”€â”€â”€â”€â”˜
 â”‚ â”‚ â”” ğŸ“œ schema.ts 
 â”‚ â”” ğŸ“œ index.ts         
 â”” â€¦
```

<Callout>
`drizzle/relations.ts` ä¼šå¯¼å…¥æ‰€æœ‰è¡¨çš„ schemaï¼Œå½¢å¼å¦‚ä¸‹ï¼š
```ts
import * as schema from './schema'
```

ä½ å¯èƒ½éœ€è¦å°†æ­¤å¯¼å…¥æ”¹ä¸ºä½ æ‰€æœ‰ schema è¡¨æ‰€åœ¨çš„æ–‡ä»¶ã€‚

å¦‚æœ schema æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
```ts
import * as schema1 from './schema1'
import * as schema2 from './schema2'
...
```
</Callout>

#### ç¬¬ 3 æ­¥

ä¿®æ”¹ drizzle æ•°æ®åº“å®ä¾‹åˆ›å»ºï¼Œæä¾› `relations` å¯¹è±¡è€Œé `schema`

<Callout title='è¿ç§»å‰'>
```ts
import * as schema from './schema'
import { drizzle } from 'drizzle-orm/...'

const db = drizzle('<url>', { schema })
```
</Callout>

<Callout title='è¿ç§»å'>
```ts
// åº”è¯¥ä»ç¬¬ 2 æ­¥ä¿®æ”¹çš„æ–‡ä»¶å¯¼å…¥
import { relations } from './relations'
import { drizzle } from 'drizzle-orm/...'

const db = drizzle('<url>', { relations })
```
</Callout>

<Callout>
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ MySQL æ–¹è¨€ï¼Œå¯ä»¥åœ¨ v2 ä¸­å»æ‰ `drizzle()` ä¸­çš„ `mode`ï¼Œå› ä¸ºå·²ä¸å†éœ€è¦ã€‚
</Callout>


##### æ‰‹åŠ¨è¿ç§»

å¦‚æœä½ æƒ³æ‰‹åŠ¨è¿ç§»ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ [Drizzle Relations ç« èŠ‚](/docs/relations-v2) è·å–å®Œæ•´ API å‚è€ƒï¼Œä»¥åŠä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»çš„ç¤ºä¾‹ã€‚

#### å¦‚ä½•å°†æŸ¥è¯¢ä» v1 è¿ç§»åˆ° v2

##### è¿ç§» `where` è¯­å¥

ä½ å¯ä»¥æŸ¥çœ‹æˆ‘ä»¬çš„ [é€‰æ‹©è¿‡æ»¤å™¨æ–‡æ¡£](/docs/rqb-v2#select-filters) æŸ¥çœ‹ç¤ºä¾‹å’Œå®Œæ•´ API å‚è€ƒã€‚

æ–°è¯­æ³•æ”¯æŒ `AND`ã€`OR`ã€`NOT`ã€`RAW`ï¼Œä»¥åŠ Relations v1 ä¹‹å‰æ‰€æœ‰å¯ç”¨çš„è¿‡æ»¤æ“ä½œç¬¦ã€‚

**ç¤ºä¾‹**
<CodeTabs items={["ç®€å•ç­‰äº", "ä½¿ç”¨ AND", "ä½¿ç”¨ OR", "ä½¿ç”¨ NOT", "ä½¿ç”¨ RAW çš„å¤æ‚ç¤ºä¾‹"]}>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    age: 15,
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name"
from "users" 
where ("users"."age" = $1)
```
</CodeTab>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    age: 15,
    name: 'John'
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name"
from "users" 
where ("users"."age" = $1 and "users"."name" = $2)
```
</CodeTab>
<CodeTab>
```ts
const response = await db.query.users.findMany({
  where: {
    OR: [
      {
        id: {
          gt: 10,
        },
      },
	  {
		name: {
          like: "John%",
        },
	  }
    ],
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name" 
from "users" 
where ("users"."id" > $1 or "users"."name" like $2)
```
</CodeTab>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    NOT: {
      id: {
        gt: 10,
      },
    },
    name: {
      like: "John%",
    },
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name" 
from "users" 
where (not "users"."id" > $1 and "users"."name" like $2)
```
</CodeTab>
<CodeTab>
```ts
// schema.ts
import { integer, jsonb, pgTable, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: integer("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  age: integer("age"),
  createdAt: timestamp("created_at").defaultNow(),
  lastLogin: timestamp("last_login"),
  subscriptionEnd: timestamp("subscription_end"),
  lastActivity: timestamp("last_activity"),
  preferences: jsonb("preferences"),      // ç”¨æˆ·è®¾ç½®/åå¥½çš„ JSON åˆ—
  interests: text("interests").array(),  // ç”¨æˆ·å…´è¶£çš„æ•°ç»„åˆ—
});
```
```ts
const response = db.query.users.findMany({
  where: {
    AND: [
      {
        OR: [
          { RAW: (table) => sql`LOWER(${table.name}) LIKE 'john%'` },
          { name: { ilike: "jane%" } },
        ],
      },
      {
        OR: [
          { RAW: (table) => sql`${table.preferences}->>'theme' = 'dark'` },
          { RAW: (table) => sql`${table.preferences}->>'theme' IS NULL` },
        ],
      },
      { RAW: (table) => sql`${table.age} BETWEEN 25 AND 35` },
    ],
  },
});
```
```sql
```
</CodeTab>
</CodeTabs>

##### è¿ç§» `orderBy` è¯­å¥

`orderBy` ç°åœ¨ç®€åŒ–ä¸ºå•ä¸ªå¯¹è±¡ï¼ŒæŒ‡å®šåˆ—å’Œæ’åºæ–¹å‘ï¼ˆ`asc` æˆ– `desc`ï¼‰

<Callout title="âŒ v1">
```ts
const response = db._query.users.findMany({
  orderBy: (users, { asc }) => [asc(users.id)],
});
```
</Callout>

<Callout title="âœ… v2">
```ts
const response = db.query.users.findMany({
  orderBy: { id: "asc" },
});
```
</Callout>

##### è¿ç§»å¤šå¯¹å¤šæŸ¥è¯¢

å…³ç³»æŸ¥è¯¢ v1 å¤„ç†å¤šå¯¹å¤šæŸ¥è¯¢éå¸¸ç¹çã€‚ä½ éœ€è¦æ˜¾å¼ä½¿ç”¨è”ç»“è¡¨æŸ¥è¯¢ï¼Œå¹¶æ‰‹åŠ¨æ˜ å°„ï¼š

```ts
const response = await db.query.users.findMany({
  with: {
    usersToGroups: {
      columns: {},
      with: {
        group: true,
      },
    },
  },
});
```

å‡çº§åˆ°å…³ç³»æŸ¥è¯¢ v2 åï¼Œå¤šå¯¹å¤šå…³ç³»å˜æˆè¿™æ ·ï¼š

```ts
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';

export const relations = defineRelations(schema, (r) => ({
  users: {
    groups: r.many.groups({
      from: r.users.id.through(r.usersToGroups.userId),
      to: r.groups.id.through(r.usersToGroups.groupId),
    }),
  },
  groups: {
    participants: r.many.users(),
  },
}));
```

æŸ¥è¯¢è¯­å¥æ›´æ–°ä¸ºï¼š

```ts
// æŸ¥è¯¢ç¤ºä¾‹
const response = await db.query.users.findMany({
  with: {
    groups: true,
  },
});
```

#### éƒ¨åˆ†å‡çº§ï¼Œæˆ–è€…å‡çº§åå¦‚ä½•ç»§ç»­ä½¿ç”¨ RQB v1ï¼Ÿ

æˆ‘ä»¬çš„å‡çº§æ–¹æ¡ˆä¿è¯æ—§çš„æŸ¥è¯¢å’Œå…³ç³»å®šä¹‰ä¾ç„¶å¯ç”¨ã€‚è¿™æ ·ä½ å°±å¯ä»¥åœ¨é¡¹ç›®ä¸­é€æ¡è¿ç§»æŸ¥è¯¢ï¼Œæ— éœ€ä¸€æ¬¡æ€§å¤§é‡æ„ã€‚

##### ç¬¬ 1 æ­¥ï¼šä¿®æ”¹ relations å¯¼å…¥

v1 ä¸­ï¼Œä½ éœ€è¦ä» `drizzle-orm` å¯¼å…¥ `relations`

<Callout type='error' title='v1'>
```ts
import { relations } from 'drizzle-orm';
```
</Callout>

v2 ä¸­ï¼Œæˆ‘ä»¬å°†å…¶ç§»åˆ° `drizzle-orm/_relations`ï¼Œè®©ä½ æœ‰æ—¶é—´åšè¿ç§»

<Callout title='v2'>
```ts
import { relations } from "drizzle-orm/_relations";
```
</Callout>

##### ç¬¬ 2 æ­¥ï¼šå°†æŸ¥è¯¢æ”¹ä¸ºä½¿ç”¨ `._query`

v1 ä¸­ï¼Œä½ é€šè¿‡ `db.query.` è®¿é—®å…³ç³»æŸ¥è¯¢ API

<Callout type='error' title='v1'>
```ts
await db.query.users.findMany();
```
</Callout>

åœ¨ v2 ä¸­ï¼Œæˆ‘ä»¬ç”¨ `db._query` è¿è¡Œ v1 ä»£ç ï¼Œ`db.query` ç”¨äºæ–°è¯­æ³•ã€‚å³ï¼š

<Callout title='v2'>
```ts
// ä½¿ç”¨ RQB v1
await db._query.users.findMany();

// ä½¿ç”¨ RQB v2
await db.query.users.findMany();
```
</Callout>

##### ç¬¬ 3 æ­¥

å®šä¹‰æ–°çš„ relationsï¼Œæˆ–è€…æ ¹æ®[æœ¬æŒ‡å—](#how-to-migrate-relations-schema-definition-from-v1-to-v2)æ‹‰å–ï¼Œç„¶åæ–°æŸ¥è¯¢ä½¿ç”¨æ–°å…³ç³»å®šä¹‰ï¼Œæ—§æŸ¥è¯¢é€æ¡è¿ç§»ã€‚

### å†…éƒ¨å˜åŒ–

1. æ¯ä¸ª `drizzle` æ•°æ®åº“ã€ä¼šè¯ã€è¿ç§»å™¨å’Œäº‹åŠ¡å®ä¾‹éƒ½æ–°å¢äº† RQB v2 æŸ¥è¯¢çš„ä¸¤ä¸ªæ³›å‹å‚æ•°ã€‚

<Callout collapsed='ç¤ºä¾‹'>
**è¿ç§»å™¨**
<Callout type='error' title='ä¹‹å‰'>
```ts
export async function migrate<
  TSchema extends Record<string, unknown>
>(
  db: NodePgDatabase<TSchema>,
  config: MigrationConfig,
) {
  ...
}
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,5}
export async function migrate<
 TSchema extends Record<string, unknown>,
 TRelations extends AnyRelations
>(
  db: NodePgDatabase<TSchema, TRelations>,
  config: MigrationConfig,
) {
  ...
}
```
</Callout>
**ä¼šè¯**
<Callout type='error' title='ä¹‹å‰'>
```ts
export class NodePgSession<
  TFullSchema extends Record<string, unknown>,
  TSchema extends V1.TablesRelationalConfig,
> extends PgSession<NodePgQueryResultHKT, TFullSchema, TSchema>
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,4,6}
export class NodePgSession<
  TFullSchema extends Record<string, unknown>,
  TRelations extends AnyRelations,
  TTablesConfig extends TablesRelationalConfig,
  TSchema extends V1.TablesRelationalConfig,
> extends PgSession<NodePgQueryResultHKT, TFullSchema, TRelations, TTablesConfig, TSchema>
```
</Callout>
**äº‹åŠ¡**
<Callout type='error' title='ä¹‹å‰'>
```ts
export class NodePgTransaction<
  TFullSchema extends Record<string, unknown>,
  TSchema extends V1.TablesRelationalConfig,
> extends PgTransaction<NodePgQueryResultHKT, TFullSchema, TSchema>
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,4,6}
export class NodePgTransaction<
  TFullSchema extends Record<string, unknown>,
  TRelations extends AnyRelations,
  TTablesConfig extends TablesRelationalConfig,
  TSchema extends V1.TablesRelationalConfig,
> extends PgTransaction<NodePgQueryResultHKT, TFullSchema, TRelations, TTablesConfig, TSchema>
```
</Callout>
**é©±åŠ¨**
<Callout type='error' title='ä¹‹å‰'>
```ts
export class NodePgDatabase<
  TSchema extends Record<string, unknown> = Record<string, never>,
> extends PgDatabase<NodePgQueryResultHKT, TSchema>
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,4}
export class NodePgDatabase<
  TSchema extends Record<string, unknown> = Record<string, never>,
  TRelations extends AnyRelations = EmptyRelations,
> extends PgDatabase<NodePgQueryResultHKT, TSchema, TRelations>
```
</Callout>
</Callout>

2. æ›´æ–°äº† `DrizzleConfig` æ³›å‹ï¼Œæ–°å¢äº† `TRelations` å‚æ•°å’Œ `relations: TRelations` å­—æ®µ

<Callout collapsed='ç¤ºä¾‹'>
<Callout type='error' title='ä¹‹å‰'>
```ts
export interface DrizzleConfig<
  TSchema extends Record<string, unknown> = Record<string, never>
> {
  logger?: boolean | Logger;
  schema?: TSchema;
  casing?: Casing;
}
```
</Callout>

<Callout title='ç°åœ¨'>
```ts {8}
export interface DrizzleConfig<
  TSchema extends Record<string, unknown> = Record<string, never>,
  TRelations extends AnyRelations = EmptyRelations,
> {
  logger?: boolean | Logger;
  schema?: TSchema;
  casing?: Casing;
  relations?: TRelations;
}
```
</Callout>
</Callout>

3. ä»¥ä¸‹å®ä½“ä» `drizzle-orm` å’Œ `drizzle-orm/relations` ç§»åŠ¨åˆ° `drizzle-orm/_relations`ã€‚åŸæœ‰å¯¼å…¥ç°åœ¨åŒ…å«äº†å…³ç³»æŸ¥è¯¢ v2 ä½¿ç”¨çš„æ–°ç±»å‹ï¼Œå¦‚æœä½ è¿˜æƒ³ç”¨æ—§ç±»å‹ï¼Œè¯·æ›´æ–°å¯¼å…¥ï¼š

<Callout collapsed='å…¨éƒ¨è¿ç§»çš„å®ä½“åˆ—è¡¨'>
- `Relation`
- `Relations`
- `One`
- `Many`
- `TableRelationsKeysOnly`
- `ExtractTableRelationsFromSchema`
- `ExtractObjectValues`
- `ExtractRelationsFromTableExtraConfigSchema`
- `getOperators`
- `Operators`
- `getOrderByOperators`
- `OrderByOperators`
- `FindTableByDBName`
- `DBQueryConfig`
- `TableRelationalConfig`
- `TablesRelationalConfig`
- `RelationalSchemaConfig`
- `ExtractTablesWithRelations`
- `ReturnTypeOrValue`
- `BuildRelationResult`
- `NonUndefinedKeysOnly`
- `BuildQueryResult`
- `RelationConfig`
- `extractTablesRelationalConfig`
- `relations`
- `createOne`
- `createMany`
- `NormalizedRelation`
- `normalizeRelation`
- `createTableRelationsHelpers`
- `TableRelationsHelpers`
- `BuildRelationalQueryResult`
- `mapRelationalRow`
</Callout>

4. åŒæ ·è§„åˆ™ï¼Œ`${dialect}-core/query-builders/query` æ–‡ä»¶ç§»åŠ¨åˆ°äº† `${dialect}-core/query-builders/_query` ï¼ŒåŸä½ç½®æ›¿æ¢ä¸º RQB v2 å¯¹åº”çš„å®ç°ã€‚

<Callout collapsed='ç¤ºä¾‹'>
<Callout type='error' title='ä¹‹å‰'>
```ts
import { RelationalQueryBuilder, PgRelationalQuery } from './query-builders/query.ts';
```
</Callout>

<Callout title='ç°åœ¨'>
```ts
import { _RelationalQueryBuilder, _PgRelationalQuery } from './query-builders/_query.ts';
```
</Callout>
</Callout>