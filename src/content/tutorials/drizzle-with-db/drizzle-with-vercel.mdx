---
title: "Drizzle ä½¿ç”¨ Vercel Postgres"
date: "2024-06-09"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5L4 19H20L12 5Z" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>]
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM å’Œ [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres)ã€‚Vercel Postgres æ˜¯ä¸€ä¸ªä¸º Vercel Functions å’Œæ‚¨çš„å‰ç«¯æ¡†æ¶è®¾è®¡çš„æ— æœåŠ¡å™¨ SQL æ•°æ®åº“ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](https://orm.drizzle.team/kit-docs/overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† `dotenv` åŒ…æ¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æ›´å¤šå…³äºè¿™ä¸ªåŒ…çš„è¯¦æƒ…ï¼Œè¯·æŸ¥çœ‹ [è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>

- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† `@vercel/postgres` åŒ…ã€‚æ›´å¤šå…³äºè¿™ä¸ªåŒ…çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [è¿™é‡Œ](https://www.npmjs.com/package/@vercel/postgres)
<Npm>
  @vercel/postgres
</Npm>  
</Prerequisites>

è¯·æŸ¥çœ‹ [Vercelæ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/using-an-orm#drizzle) äº†è§£å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“ã€‚

## è®¾ç½® Vercel Postgres å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºæ–°çš„ Vercel Postgres æ•°æ®åº“

æ‚¨å¯ä»¥åœ¨ [ä»ªè¡¨ç›˜](https://vercel.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Vercel Postgres æ•°æ®åº“ã€‚

é˜…è¯» Vercel Postgres [æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/quickstart) äº†è§£å¦‚ä½•åˆ›å»ºæ–°æ•°æ®åº“ã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªåˆ°æ‚¨çš„ Vercel Postgres æ•°æ®åº“å¹¶å¤åˆ¶ `POSTGRES_URL` æ¥è‡ª `.env.local` éƒ¨åˆ†ã€‚

å°† `POSTGRES_URL` æ·»åŠ åˆ°æ‚¨çš„ `.env.local` æˆ– `.env` æ–‡ä»¶ã€‚

```plaintext copy
POSTGRES_URL=<YOUR_DATABASE_URL>
```

#### è¿æ¥ Drizzle ORM åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶è®¾ç½®æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { sql } from '@vercel/postgres';
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { config } from 'dotenv';

config({ path: '.env.local' }); // or .env

export const db = drizzle(sql);

```

#### åˆ›å»ºè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”± [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview) ä½¿ç”¨ï¼Œå¹¶ä¸”åŒ…å«äº†æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env.local' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

#### åº”ç”¨æ•°æ®åº“æ›´æ”¹

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle/migrations` ç›®å½•ä¸­ï¼Œæ­£å¦‚æ‚¨çš„ `drizzle.config.ts` ä¸­æŒ‡å®šçš„ã€‚è¿™ä¸ªç›®å½•å°†åŒ…å«æ›´æ–°æ‚¨çš„æ•°æ®åº“æ¨¡å¼æ‰€å¿…éœ€çš„ SQL æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨åœ¨ä¸åŒè¿ç§»é˜¶æ®µçš„æ•°æ®åº“æ¨¡å¼å¿«ç…§ã€‚

ç”Ÿæˆçš„è¿ç§»ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼Œä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/kit-docs/overview#prototyping-with-db-push)ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚åˆäºå¿«é€Ÿæµ‹è¯•æ–°çš„æ¨¡å¼è®¾è®¡æˆ–æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­çš„æ›´æ”¹æƒ…å†µï¼Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„é¢å¤–å¼€é”€ï¼Œå…è®¸å¿«é€Ÿè¿­ä»£ã€‚</Callout>

</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›å…³äºæ•°æ®åº“çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬ `index.ts` ä¸­çš„è¿æ¥è®¾ç½®å’Œ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ã€‚

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env.local
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `src/db/queries` ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œåˆ†éš”æ–‡ä»¶ï¼šæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°å’Œåˆ é™¤ã€‚

#### æ’å…¥æ•°æ®

åœ¨ [æ–‡æ¡£](/docs/insert) ä¸­é˜…è¯»æ›´å¤šå…³äºæ’å…¥æŸ¥è¯¢çš„ä¿¡æ¯ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

åœ¨ [æ–‡æ¡£](/docs/select) ä¸­é˜…è¯»æ›´å¤šå…³äºé€‰æ‹©æŸ¥è¯¢çš„ä¿¡æ¯ã€‚

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getTableColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getTableColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

åœ¨ [æ–‡æ¡£](/docs/update) ä¸­é˜…è¯»æ›´å¤šå…³äºæ›´æ–°æŸ¥è¯¢çš„ä¿¡æ¯ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

åœ¨ [æ–‡æ¡£](/docs/delete) ä¸­é˜…è¯»æ›´å¤šå…³äºåˆ é™¤æŸ¥è¯¢çš„ä¿¡æ¯ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```
