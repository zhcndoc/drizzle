---
title: "ä» TypeORM è¿ç§»åˆ° Drizzle"
---
import Npm from "@mdx/Npm.astro";
import Steps from "@mdx/Steps.astro";

## å¼€å§‹

æœ¬æŒ‡å—æä¾›äº†å°†åŸºæœ¬ **TypeORM** é¡¹ç›®è¿ç§»åˆ° **Drizzle ORM** çš„ç®€æ˜æ–¹æ³•ã€‚è™½ç„¶ç¤ºä¾‹ä¸“æ³¨äº `PostgreSQL`ï¼Œä½†å…¶ä»–æ”¯æŒçš„æ•°æ®åº“çš„è¿‡ç¨‹ç±»ä¼¼ã€‚

### è¿ç§»è¿‡ç¨‹æ¦‚è¿°

æ— è®ºä½ çš„åº”ç”¨ç¨‹åºç±»å‹æˆ– API å±‚æ˜¯ä»€ä¹ˆï¼Œä» **TypeORM** è¿‡æ¸¡åˆ° **Drizzle ORM** çš„æ­¥éª¤ä¿æŒä¸€è‡´ï¼š

1. å®‰è£… **Drizzle ORM** å’Œ **Drizzle Kit**
2. è®¾ç½® **Drizzle é…ç½®** æ–‡ä»¶
3. æ·±å…¥äº†è§£ä½ çš„æ•°æ®åº“
4. å°† **Drizzle ORM** è¿æ¥åˆ°ä½ çš„æ•°æ®åº“
5. å°†ä½ çš„ **TypeORM** æŸ¥è¯¢è¿ç§»åˆ° **Drizzle ORM** æŸ¥è¯¢

è¿™äº›æ­¥éª¤é€‚ç”¨äºä½ æ­£åœ¨å¼€å‘ REST APIï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ Expressã€Koa æˆ– NestJSï¼‰æˆ–ä»»ä½•å…¶ä»–ç±»å‹åˆ©ç”¨ **TypeORM** è¿›è¡Œæ•°æ®åº“äº¤äº’çš„åº”ç”¨ç¨‹åºã€‚

## TypeORM é¡¹ç›®æ¦‚è¿°

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `Express` æ„å»ºçš„ REST API ä½œä¸ºè¿ç§»åˆ° **Drizzle ORM** çš„ç¤ºä¾‹é¡¹ç›®ã€‚å®ƒæœ‰å››ä¸ªå®ä½“ï¼š

```typescript collapsable copy filename="src/entities/supplier.entity.ts"
import { Column, Entity, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { Product } from './product.entity';

@Entity({ name: 'suppliers' })
export class Supplier {
  @PrimaryGeneratedColumn('increment')
  public id: number;

  @Column({ type: 'text' })
  public companyName: string;

  @Column({ type: 'text', nullable: true })
  public city: string;

  @Column({ type: 'text' })
  public country: string;

  @OneToMany(() => Product, (product) => product.supplier)
  public products: Product[];
}
```

```typescript collapsable copy filename="src/entities/product.entity.ts"
import { Column, Entity, JoinColumn, ManyToOne, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { OrderDetail } from './order-detail.entity';
import { Supplier } from './supplier.entity';

@Entity({ name: 'products' })
export class Product {
  @PrimaryGeneratedColumn('increment')
  public id: number;

  @Column({ type: 'text' })
  public name: string;

  @Column({ type: 'integer' })
  public supplierId: number;

  @Column({ type: 'decimal', precision: 10, scale: 4 })
  public unitPrice: number;

  @Column({ type: 'integer' })
  public unitsInStock: number;

  @OneToMany(() => OrderDetail, (orderDetail) => orderDetail.product)
  public orderDetails: OrderDetail[];

  @ManyToOne(() => Supplier, (supplier) => supplier.products)
  @JoinColumn({ name: 'supplierId', referencedColumnName: 'id' })
  public supplier: Supplier;
}
```

```typescript collapsable copy filename="src/entities/order.entity.ts"
import { Column, Entity, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { OrderDetail } from './order-detail.entity';

@Entity({ name: 'orders' })
export class Order {
  @PrimaryGeneratedColumn('increment')
  public id: number;

  @Column({ type: 'date' })
  public orderDate: Date;

  @Column({ type: 'date', nullable: true })
  public shippedDate: Date;

  @Column({ type: 'text' })
  public shipAddress: string;

  @Column({ type: 'text', nullable: true })
  public shipPostalCode: string;

  @Column({ type: 'text' })
  public shipCountry: string;

  @OneToMany(() => OrderDetail, (orderDetail) => orderDetail.order)
  public orderDetails: OrderDetail[];
}
```

```typescript collapsable copy filename="src/entities/order-detail.entity.ts"
import { Column, Entity, JoinColumn, ManyToOne, PrimaryColumn } from 'typeorm';
import { Order } from './order.entity';
import { Product } from './product.entity';

@Entity({ name: 'order_details' })
export class OrderDetail {
  @PrimaryColumn({ type: 'integer' })
  public orderId: number;

  @PrimaryColumn({ type: 'integer' })
  public productId: number;

  @Column({ type: 'integer' })
  public quantity: number;

  @ManyToOne(() => Order, (order) => order.orderDetails)
  @JoinColumn({ name: 'orderId', referencedColumnName: 'id' })
  public order: Order;

  @ManyToOne(() => Product, (product) => product.orderDetails)
  @JoinColumn({ name: 'productId', referencedColumnName: 'id' })
  public product: Product;
}
```

è¿™äº›æ¨¡å‹å…·æœ‰ä»¥ä¸‹å…³ç³»ï¼š

1. `ä¸€å¯¹å¤š` å…³ç³»åœ¨ `Supplier` å’Œ `Product` ä¹‹é—´
2. `å¤šå¯¹å¤š` å…³ç³»åœ¨ `Order` å’Œ `Product` ä¹‹é—´

å¯¹äº `å¤šå¯¹å¤š` å…³ç³»ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¿æ¥è¡¨ `order_details`ï¼Œå› æ­¤ `Order` å’Œ `Product` å®ä½“å°†ä¸ `OrderDetail` å®ä½“å…·æœ‰ `ä¸€å¯¹å¤š` å…³ç³»ã€‚

ç›¸åº”çš„è¡¨å·²ä½¿ç”¨ç”Ÿæˆçš„ TypeORM è¿ç§»åˆ›å»ºã€‚

```typescript copy filename="src/db/migrations/1702216840703-init.ts"
import { MigrationInterface, QueryRunner } from "typeorm";

export class Init1702216840703 implements MigrationInterface {
    name = 'Init1702216840703'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`CREATE TABLE "orders" ("id" SERIAL NOT NULL, "orderDate" date NOT NULL, "shippedDate" date, "shipAddress" text NOT NULL, "shipPostalCode" text, "shipCountry" text NOT NULL, CONSTRAINT "PK_710e2d4957aa5878dfe94e4ac2f" PRIMARY KEY ("id"))`);
        await queryRunner.query(`CREATE TABLE "suppliers" ("id" SERIAL NOT NULL, "companyName" text NOT NULL, "city" text, "country" text NOT NULL, CONSTRAINT "PK_b70ac51766a9e3144f778cfe81e" PRIMARY KEY ("id"))`);
        await queryRunner.query(`CREATE TABLE "products" ("id" SERIAL NOT NULL, "name" text NOT NULL, "supplierId" integer NOT NULL, "unitPrice" numeric(10,4) NOT NULL, "unitsInStock" integer NOT NULL, CONSTRAINT "PK_0806c755e0aca124e67c0cf6d7d" PRIMARY KEY ("id"))`);
        await queryRunner.query(`CREATE TABLE "order_details" ("orderId" integer NOT NULL, "productId" integer NOT NULL, "quantity" integer NOT NULL, CONSTRAINT "PK_e08ee153eb9c98ee497c1d1287e" PRIMARY KEY ("orderId", "productId"))`);
        await queryRunner.query(`ALTER TABLE "products" ADD CONSTRAINT "FK_c143cbc0299e1f9220c4b5debd8" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        await queryRunner.query(`ALTER TABLE "order_details" ADD CONSTRAINT "FK_147bc15de4304f89a93c7eee969" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        await queryRunner.query(`ALTER TABLE "order_details" ADD CONSTRAINT "FK_c67ebaba3e5085b6401911acc70" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`ALTER TABLE "order_details" DROP CONSTRAINT "FK_c67ebaba3e5085b6401911acc70"`);
        await queryRunner.query(`ALTER TABLE "order_details" DROP CONSTRAINT "FK_147bc15de4304f89a93c7eee969"`);
        await queryRunner.query(`ALTER TABLE "products" DROP CONSTRAINT "FK_c143cbc0299e1f9220c4b5debd8"`);
        await queryRunner.query(`DROP TABLE "order_details"`);
        await queryRunner.query(`DROP TABLE "products"`);
        await queryRunner.query(`DROP TABLE "suppliers"`);
        await queryRunner.query(`DROP TABLE "orders"`);
    }

}
```

æœ¬æŒ‡å—ä½¿ç”¨ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```text
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ db
 â”‚  â”‚  â”œ ğŸ“‚ migrations
 â”‚  â”‚  â”‚  â”” ğŸ“œ 1702216840703-init.ts
 â”‚  â”‚  â”” ğŸ“œ typeorm.config.ts
 â”‚  â”œ ğŸ“‚ entities
 â”‚  â”‚  â”œ ğŸ“œ order-detail.entity.ts
 â”‚  â”‚  â”œ ğŸ“œ order.entity.ts
 â”‚  â”‚  â”œ ğŸ“œ product.entity.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.entity.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<Steps>

#### å®‰è£… Drizzle ORM å’Œ Drizzle Kit

ç¬¬ä¸€æ­¥æ˜¯å®‰è£… **Drizzle ORM** å’Œ `pg` åŒ…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›ä½œä¸ºé©±åŠ¨ç¨‹åºã€‚ç¬¬äºŒæ­¥æ˜¯å®‰è£… **Drizzle Kit** å’Œ `pg` çš„ç±»å‹ã€‚ [Drizzle Kit](/docs/kit-overview) - è‡ªåŠ¨ SQL è¿ç§»ç”Ÿæˆå’Œå¿«é€ŸåŸå‹çš„ CLI ä¼´ä¾£ã€‚

<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªç”± **Drizzle Kit** ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³ä½ çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // ç¡®ä¿å®‰è£…äº† dotenv åŒ…
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  out: './src/drizzle',
  schema: './src/drizzle/schema.ts',
  dbCredentials: {
    host: process.env.DB_HOST!,
    port: Number(process.env.DB_PORT!),
    user: process.env.DB_USERNAME!,
    password: process.env.DB_PASSWORD!,
    database: process.env.DB_NAME!,
  },
  // æ‰“å°æ‰€æœ‰è¯­å¥
  verbose: true,
  // å§‹ç»ˆè¯¢é—®ç¡®è®¤
  strict: true,
});
```

#### æ·±å…¥äº†è§£ä½ çš„æ•°æ®åº“

**Drizzle Kit** æä¾›äº†ä¸€ä¸ª CLI å‘½ä»¤æ¥æ·±å…¥äº†è§£ä½ çš„æ•°æ®åº“å¹¶ç”Ÿæˆä¸€ä¸ªæ¨¡å¼æ–‡ä»¶ã€‚æ¨¡å¼æ–‡ä»¶åŒ…å«æœ‰å…³ä½ çš„æ•°æ®åº“è¡¨ã€åˆ—ã€å…³ç³»å’Œç´¢å¼•çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```bash
npx drizzle-kit introspect
```

æ­¤å‘½ä»¤å°†åœ¨ src/drizzle æ–‡ä»¶å¤¹ç”Ÿæˆä¸€ä¸ª schema.ts æ–‡ä»¶ï¼Œä»¥åŠå¿«ç…§å’Œè¿ç§»ã€‚

```typescript collapsable copy filename="src/drizzle/schema.ts" 
import {
  pgTable,
  serial,
  bigint,
  varchar,
  text,
  foreignKey,
  integer,
  numeric,
  date,
  primaryKey,
} from 'drizzle-orm/pg-core';
import { sql } from 'drizzle-orm';

export const migrations = pgTable('migrations', {
  id: serial('id').primaryKey().notNull(),
  // å¦‚æœæ•°å­—è¶…è¿‡ js æ•°å­—é™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ { mode: "bigint" }
  timestamp: bigint('timestamp', { mode: 'number' }).notNull(),
  name: varchar('name').notNull(),
});

export const suppliers = pgTable('suppliers', {
  id: serial('id').primaryKey().notNull(),
  companyName: text('companyName').notNull(),
  city: text('city'),
  country: text('country').notNull(),
});

export const products = pgTable('products', {
  id: serial('id').primaryKey().notNull(),
  name: text('name').notNull(),
  supplierId: integer('supplierId')
    .notNull()
    .references(() => suppliers.id),
  unitPrice: numeric('unitPrice', { precision: 10, scale: 4 }).notNull(),
  unitsInStock: integer('unitsInStock').notNull(),
});

export const orders = pgTable('orders', {
  id: serial('id').primaryKey().notNull(),
  orderDate: date('orderDate').notNull(),
  shippedDate: date('shippedDate'),
  shipAddress: text('shipAddress').notNull(),
  shipPostalCode: text('shipPostalCode'),
  shipCountry: text('shipCountry').notNull(),
});

export const orderDetails = pgTable(
  'order_details',
  {
    orderId: integer('orderId')
      .notNull()
      .references(() => orders.id),
    productId: integer('productId')
      .notNull()
      .references(() => products.id),
    quantity: integer('quantity').notNull(),
  },
  (table) => {
    return {
      pkE08Ee153Eb9C98Ee497C1D1287E: primaryKey({
        columns: [table.orderId, table.productId],
        name: 'PK_e08ee153eb9c98ee497c1d1287e',
      }),
    };
  },
);
```

```sql collapsable copy filename="src/drizzle/0000_lush_lenny_balinger.sql"
-- å½“å‰ SQL æ–‡ä»¶æ˜¯é€šè¿‡æ·±å…¥äº†è§£æ•°æ®åº“ç”Ÿæˆçš„

CREATE TABLE IF NOT EXISTS "migrations" (
	"id" serial PRIMARY KEY NOT NULL,
	"timestamp" bigint NOT NULL,
	"name" varchar NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "suppliers" (
	"id" serial PRIMARY KEY NOT NULL,
	"companyName" text NOT NULL,
	"city" text,
	"country" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "products" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"supplierId" integer NOT NULL,
	"unitPrice" numeric(10, 4) NOT NULL,
	"unitsInStock" integer NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "orders" (
	"id" serial PRIMARY KEY NOT NULL,
	"orderDate" date NOT NULL,
	"shippedDate" date,
	"shipAddress" text NOT NULL,
	"shipPostalCode" text,
	"shipCountry" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "order_details" (
	"orderId" integer NOT NULL,
	"productId" integer NOT NULL,
	"quantity" integer NOT NULL,
	CONSTRAINT PK_e08ee153eb9c98ee497c1d1287e PRIMARY KEY("orderId","productId")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "products" ADD CONSTRAINT "FK_c143cbc0299e1f9220c4b5debd8" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "FK_147bc15de4304f89a93c7eee969" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "FK_c67ebaba3e5085b6401911acc70" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE no action ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨å…³ç³»æŸ¥è¯¢ï¼Œä½ å¿…é¡»æ›´æ–°ä½ çš„æ¨¡å¼æ–‡ä»¶ä»¥åŒ…å«å…³ç³»è¡¨ï¼š

```typescript copy filename="src/drizzle/schema.ts"
// ...å…¶ä»–å¯¼å…¥
import { relations } from 'drizzle-orm';

// ...å…¶ä»–è¡¨ 
export const suppliersRelations = relations(suppliers, ({ many }) => ({
  products: many(products),
}));

export const productsRelations = relations(products, ({ one, many }) => ({
  supplier: one(suppliers, { fields: [products.supplierId], references: [suppliers.id] }),
  orderDetails: many(orderDetails),
}));

export const ordersRelations = relations(orders, ({ many }) => ({
  orderDetails: many(orderDetails),
}));

export const orderDetailsRelations = relations(orderDetails, ({ one }) => ({
  order: one(orders, { fields: [orderDetails.orderId], references: [orders.id] }),
  product: one(products, { fields: [orderDetails.productId], references: [products.id] }),
}));
```

ç°åœ¨æˆ‘ä»¬æœ‰ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```text
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ drizzle
 â”‚  â”‚  â”œ ğŸ“‚ meta
 |  |  |  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”‚  â”œ ğŸ“œ 0000_lush_lenny_balinger.sql
 â”‚  â”‚  â”” ğŸ“œ schema.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ tsconfig.json
```

#### è¿æ¥ Drizzle ORM åˆ°ä½ çš„æ•°æ®åº“

åœ¨ `src/drizzle` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®ä½ çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/drizzle/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';
import * as schema from './schema';

export const client = new Client({
  host: process.env.DB_HOST!,
  port: Number(process.env.DB_PORT!),
  user: process.env.DB_USERNAME!,
  password: process.env.DB_PASSWORD!,
  database: process.env.DB_NAME!,
});

// { schema } ç”¨äºå…³ç³»æŸ¥è¯¢
export const db = drizzle({ client, schema });
```

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { client, db } from './drizzle/db';
import { resolve } from 'node:path';
import { migrate } from 'drizzle-orm/node-postgres/migrator';


(async () => {
  await client.connect();

  // æ­¤å‘½ä»¤å°†è¿è¡Œè¿ç§»æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰è¿ç§»ï¼Œå¹¶å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“
  await migrate(db, { migrationsFolder: resolve(__dirname, './drizzle') });

  // ... å¯åŠ¨ä½ çš„åº”ç”¨ç¨‹åº
})();
```

#### å°†ä½ çš„ TypeORM æŸ¥è¯¢è¿ç§»åˆ° Drizzle ORM æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å°†ä¸€äº› **TypeORM** æŸ¥è¯¢æ›¿æ¢ä¸º **Drizzle ORM** æŸ¥è¯¢ã€‚

##### æ›¿æ¢æ’å…¥æŸ¥è¯¢

æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•å°†æ–°è¡Œæ’å…¥åˆ° `suppliers` å’Œ `products` è¡¨ä¸­ã€‚

1. `POST /suppliers`
```typescript copy filename="src/controllers/supplier.controller.ts"
import dataSource from '../db/typeorm.config';
import { Supplier } from '../entities/supplier.entity';

const repository = dataSource.getRepository(Supplier);

const suppliers = repository.create([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);

await repository.save(suppliers);
```

ä½¿ç”¨ **Drizzle ORM**ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

await db.insert(suppliers).values([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

2. `POST /products`

```typescript copy filename="src/controllers/product.controller.ts"
import dataSource from '../db/typeorm.config';
import { Product } from '../entities/product.entity';

const repository = dataSource.getRepository(Product);

const products = repository.create([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: 10,
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: 25,
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: 50,
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: 100,
    unitsInStock: 2,
  },
]);

await repository.save(products);
```

ä½¿ç”¨ **Drizzle ORM**ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

è¦æ³¨æ„ `unitPrice` å­—æ®µã€‚åœ¨ **TypeORM** ä¸­å®ƒæ˜¯ `number` ç±»å‹ï¼Œä½†åœ¨ **Drizzle ORM** ä¸­å®ƒæ˜¯ `string` ç±»å‹ï¼Œå¯ä»¥å¤„ç†è¶…è¿‡ 16383 ä½å°æ•°ç‚¹åçš„æ•°å­—ï¼Œè€Œä¸åŒäº `number` ç±»å‹ã€‚

```typescript copy filename="src/controllers/product.controller.ts"
await db.insert(products).values([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: '10',
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: '25',
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: '50',
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: '100',
    unitsInStock: 2,
  },
]);
```

##### æ›¿æ¢é€‰æ‹©æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•é€‰æ‹©å•è¡Œã€å¤šè¡Œã€ç»Ÿè®¡è¡Œã€ç­›é€‰è¡Œã€è”æ¥è¡¨ä»¥åŠåˆ†é¡µç»“æœã€‚

1. `GET /products/:id`

åœ¨ **TypeORM** ä¸­ï¼Œå“åº”ç±»å‹ä¸æ˜¯ä¸¥æ ¼ç±»å‹ã€‚å½“ä½ é€‰æ‹©åŒ…å«å…³ç³»æˆ–åªé€‰æ‹©æŸäº›å­—æ®µè€Œä¸æ˜¯å…¨éƒ¨æ—¶ï¼Œè¿™äº›ä¿®æ”¹ä¸ä¼šåæ˜ åœ¨å“åº”ç±»å‹ä¸­ã€‚

```typescript copy filename="src/controllers/product.controller.ts"
import dataSource from '../db/typeorm.config';
import { Product } from '../entities/product.entity';

const { id } = req.params;

const repository = dataSource.getRepository(Product);

const response = await repostitory.findOne({
  where: { id },
  relations: ['supplier'],
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/product.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products, suppliers } from '../drizzle/schema';

const { id } = req.params;

const response = await db
  .select({
    product: products,
    supplier: suppliers,
  })
  .from(products)
  .where(eq(products.id, id))
  .leftJoin(suppliers, eq(suppliers.id, products.supplierId));

// æˆ–è€…å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const response = await db.query.products.findFirst({
  where: (products, { eq }) => eq(products.id, id),
  with: {
    supplier: true,
  },
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œå“åº”ç±»å‹å°†ä¸æ‰€é€‰å¯¹è±¡ä¸­çš„å†…å®¹å®Œå…¨åŒ¹é…ï¼Œå› æ­¤åŒ…å« `supplier` å…³ç³»æ˜¯å®Œå…¨ç±»å‹å®‰å…¨çš„ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  product: {
    name: string;
    id: number;
    supplierId: number;
    unitPrice: string;
    unitsInStock: number;
  };
  supplier: {
    id: number;
    companyName: string;
    city: string | null;
    country: string;
  } | null;
}[]
```

2. `GET /products`

åœ¨ **TypeORM** ä¸­ï¼Œç»“æœä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä¸æŒ‡å®šè¦é€‰æ‹©çš„å­—æ®µã€‚

```typescript copy filename="src/controllers/product.controller.ts"
import { ILike } from 'typeorm';
import dataSource from '../db/typeorm.config';
import { Product } from '../entities/product.entity';

const repository = dataSource.getRepository(Product);

const response = await repostitory.findAndCount({
  skip: 0,
  take: 10,
  where: {
    name: ILike(`%test%`),
  },
  select: ['id', 'name', 'unitPrice', 'unitsInStock'],
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript collapsable copy filename="src/controllers/product.controller.ts"
import { ilike, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products } from '../drizzle/schema';

const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db
    .select({
      id: products.id,
      name: products.name,
      unitPrice: products.unitPrice,
      unitsInStock: products.unitsInStock,
    })
    .from(products)
    .where(whereOptions)
    .offset(0)
    .limit(10),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);

// æˆ–è€…å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db.query.products.findMany({
    where: whereOptions,
    columns: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
    offset: 0,
    limit: 10,
  }),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœæ˜¯ä¸¥æ ¼ç±»å‹å®‰å…¨çš„ï¼Œè¿™æ„å‘³ç€ä½ é€‰æ‹©çš„å­—æ®µæ˜¯æ˜ç¡®å®šä¹‰çš„ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  name: string;
  unitPrice: string;
  unitsInStock: number;
}[]
```

3. `GET /orders/:id`

åœ¨ **TypeORM** ä¸­ï¼Œä½ ä¸èƒ½ä½¿ç”¨ `èšåˆå‡½æ•°` å¤„ç†å…³ç³»å¹¶ä½¿ç”¨ `findOne` æ–¹æ³•é€‰æ‹©ç‰¹å®šå­—æ®µã€‚å› æ­¤ï¼Œä½ å¿…é¡»ä½¿ç”¨ `querybuilder`ï¼Œè¿™ä¹Ÿæ˜¯ä¸ç±»å‹å®‰å…¨çš„ã€‚

æˆ‘ä»¬æƒ³é€‰æ‹© `id`ã€`orderDate` å’Œ `shipCountry` å­—æ®µä» `orders` è¡¨ï¼Œå¹¶ä½¿ç”¨ `èšåˆå‡½æ•°` ç»Ÿè®¡è®¢å•çš„ `totalPrice`ã€è®¢å•ä¸­çš„ `totalQuantity` äº§å“æ•°é‡å’Œè®¢å•ä¸­çš„ `totalProducts` æ•°é‡ã€‚

```typescript copy filename="src/controllers/order.controller.ts"
import dataSource from '../db/typeorm.config';
import { Order } from '../entities/order.entity';

const { id } = req.params;

const orderRepository = dataSource.getRepository(Order);

const orderQueryBuilder = orderRepository.createQueryBuilder('order');

const response = await orderQueryBuilder
  .select([
    'order.id as id',
    'order.orderDate as "orderDate"',
    'order.shipCountry as "shipCountry"',
    'SUM(product.unitPrice * detail.quantity)::float as "totalPrice"',
    'SUM(detail.quantity)::int as "totalQuantity"',
    'COUNT(detail.productId)::int as "totalProducts"',
  ])
  .leftJoin('order.orderDetails', 'detail')
  .leftJoin('detail.product', 'product')
  .groupBy('order.id')
  .where('order.id = :id', { id })
  .getRawOne();
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orders, orderDetails, products } from '../drizzle/schema';

const { id } = req.params;

const response = await db
      .select({
        id: orders.id,
        shipCountry: orders.shipCountry,
        orderDate: orders.orderDate,
        totalPrice: sql<number>`cast(sum(${orderDetails.quantity} * ${products.unitPrice}) as float)`,
        totalQuantity: sql<number>`cast(sum(${orderDetails.quantity}) as int)`,
        totalProducts: sql<number>`cast(count(${orderDetails.productId}) as int)`,
      })
      .from(orders)
      .where(eq(orders.id, id))
      .groupBy(orders.id)
      .leftJoin(orderDetails, eq(orderDetails.orderId, orders.id))
      .leftJoin(products, eq(products.id, orderDetails.productId));
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœå°†æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œèšåˆä¹Ÿä¼šå¦‚æ­¤ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  shipCountry: string;
  orderDate: string;
  totalPrice: number;
  totalQuantity: number;
  totalProducts: number;
}[]
```

**æ³¨æ„ï¼š** ç›®å‰èšåˆåœ¨å…³ç³»æŸ¥è¯¢ä¸­ä¸å—æ”¯æŒï¼Œå› æ­¤ä½ å¿…é¡»ä½¿ç”¨ `æ ¸å¿ƒæŸ¥è¯¢`ã€‚

##### æ›¿æ¢æ›´æ–°æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•æ›´æ–°å¤šè¡Œã€‚

1. `PATCH /suppliers/:id`

```typescript copy filename="src/controllers/supplier.controller.ts"
import dataSource from '../db/typeorm.config';
import { Supplier } from '../entities/supplier.entity';

const { id } = req.params;

const repository = dataSource.getRepository(Supplier);

const supplier = await repository.findOneBy({ id });
if (!supplier) {
  throw new Error('Supplier not found');
}

supplier.city = 'TestCity1Updated';
supplier.country = 'TestCountry1Updated';

await repository.save(supplier);
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

const { id } = req.params;

await db
    .update(suppliers)
    .set({
      city: 'TestCity1Updated',
      country: 'TestCountry1Updated',
    })
    .where(eq(suppliers.id, id));
```

##### æ›¿æ¢åˆ é™¤æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨äº‹åŠ¡åˆ é™¤å•è¡Œå’Œå¤šè¡Œã€‚

1. `DELETE /orders/:id`

```typescript copy filename="src/controllers/order.controller.ts"
import dataSource from '../db/typeorm.config';
import { OrderDetail } from '../entities/order-detail.entity';
import { Order } from '../entities/order.entity';

const { id } = req.params;

const queryRunner = dataSource.createQueryRunner();

await queryRunner.connect();

await queryRunner.startTransaction();

try {
  await queryRunner.manager.delete(OrderDetail, { orderId: id });

  await queryRunner.manager.delete(Order, { id });

  await queryRunner.commitTransaction();
} catch (e) {
  await queryRunner.rollbackTransaction();

  console.error(e);
} finally {
  await queryRunner.release();
}
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å®ç°å¦‚ä¸‹ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orderDetails, orders } from '../drizzle/schema';

const { id } = req.params;

try {
  await db.transaction(async (tx) => {
    await tx.delete(orderDetails).where(eq(orderDetails.orderId, id));

    await tx.delete(orders).where(eq(orders.id, id));
  });
} catch (e) {
  console.error(e);
}
```

</Steps>
