---
title: "ä» Sequelize è¿ç§»åˆ° Drizzle"
---
import Npm from "@mdx/Npm.astro";
import Steps from "@mdx/Steps.astro";

## å¼€å§‹

æœ¬æŒ‡å—æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œä»¥å°†åŸºæœ¬çš„ **Sequelize** é¡¹ç›®è¿ç§»åˆ° **Drizzle ORM**ã€‚è™½ç„¶ç¤ºä¾‹ä¾§é‡äº `PostgreSQL`ï¼Œä½†å¯¹äºå…¶ä»–æ”¯æŒçš„æ•°æ®åº“ï¼Œè¿‡ç¨‹æ˜¯ç›¸ä¼¼çš„ã€‚

### è¿ç§»è¿‡ç¨‹æ¦‚è¿°

æ— è®ºæ‚¨çš„åº”ç”¨ç¨‹åºç±»å‹æˆ– API å±‚æ˜¯ä»€ä¹ˆï¼Œä» **Sequelize** è¿‡æ¸¡åˆ° **Drizzle ORM** çš„æ­¥éª¤ä¿æŒä¸€è‡´ï¼š

1. å®‰è£… **Drizzle ORM** å’Œ **Drizzle Kit**
2. è®¾ç½® **Drizzle é…ç½®** æ–‡ä»¶
3. æ·±å…¥æ£€æŸ¥æ‚¨çš„æ•°æ®åº“
4. å°† **Drizzle ORM** è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“
5. å°† **Sequelize** æŸ¥è¯¢è¿ç§»åˆ° **Drizzle ORM** æŸ¥è¯¢

è¿™äº›æ­¥éª¤é€‚ç”¨äºå¼€å‘ REST APIï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ Expressã€Koa æˆ– NestJSï¼‰æˆ–ä»»ä½•å…¶ä»–åˆ©ç”¨ **Sequelize** è¿›è¡Œæ•°æ®åº“äº¤äº’çš„åº”ç”¨ç¨‹åºã€‚

## Sequelize é¡¹ç›®æ¦‚è¿°

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `Express` æ„å»ºçš„ REST API ä½œä¸ºè¿ç§»åˆ° **Drizzle ORM** çš„ç¤ºä¾‹é¡¹ç›®ã€‚å®ƒæœ‰å››ä¸ªå®ä½“ï¼š

```typescript collapsable copy filename="src/db/models/supplier.ts"
import { DataTypes, Model } from 'sequelize';
import { Product } from './product';
import { sequelize } from '../db';

export class Supplier extends Model {}

Supplier.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    companyName: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    city: {
      type: DataTypes.TEXT,
      allowNull: true,
    },
    country: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'suppliers',
    modelName: 'Supplier',
    timestamps: false,
  },
);

Supplier.hasMany(Product, {
  foreignKey: 'supplierId',
});

Product.belongsTo(Supplier, {
  foreignKey: 'supplierId',
  targetKey: 'id',
});
```

```typescript collapsable copy filename="src/db/models/product.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';

export class Product extends Model {}

Product.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    name: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    supplierId: {
      type: DataTypes.INTEGER,
      allowNull: false,
      references: {
        model: 'suppliers',
        key: 'id',
      },
      field: 'supplierId',
    },
    unitPrice: {
      type: DataTypes.DECIMAL,
      allowNull: false,
    },
    unitsInStock: {
      type: DataTypes.INTEGER,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'products',
    modelName: 'Product',
    timestamps: false,
  },
);
```

```typescript collapsable copy filename="src/db/models/order.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';

export class Order extends Model {}

Order.init(
  {
    id: {
      type: DataTypes.INTEGER,
      autoIncrement: true,
      primaryKey: true,
    },
    orderDate: {
      type: DataTypes.DATE,
      allowNull: false,
    },
    shippedDate: {
      type: DataTypes.DATE,
      allowNull: true,
    },
    shipAddress: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
    shipPostalCode: {
      type: DataTypes.TEXT,
      allowNull: true,
    },
    shipCountry: {
      type: DataTypes.TEXT,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'orders',
    modelName: 'Order',
    timestamps: false,
  },
);
```

```typescript collapsable copy filename="src/db/models/order-detail.ts"
import { DataTypes, Model } from 'sequelize';
import { sequelize } from '../db';
import { Order } from './order';
import { Product } from './product';

export class OrderDetail extends Model {}

OrderDetail.init(
  {
    orderId: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      references: {
        model: Order,
        key: 'id',
      },
      field: 'orderId',
    },
    productId: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      references: {
        model: Product,
        key: 'id',
      },
      field: 'productId',
    },
    quantity: {
      type: DataTypes.INTEGER,
      allowNull: false,
    },
  },
  {
    sequelize,
    tableName: 'order_details',
    modelName: 'OrderDetail',
    timestamps: false,
  },
);

Order.hasMany(OrderDetail, { foreignKey: 'orderId', as: 'details' });
OrderDetail.belongsTo(Order, { foreignKey: 'orderId' });

Product.hasMany(OrderDetail, { foreignKey: 'productId', as: 'details' });
OrderDetail.belongsTo(Product, { foreignKey: 'productId' });

Order.belongsToMany(Product, {
  through: OrderDetail,
  foreignKey: 'orderId',
  as: 'products',
  targetKey: 'id',
});
Product.belongsToMany(Order, {
  through: OrderDetail,
  foreignKey: 'productId',
  as: 'orders',
  targetKey: 'id',
});
```

è¿™äº›æ¨¡å‹å…·æœ‰ä»¥ä¸‹å…³ç³»ï¼š

1. `ä¸€å¯¹å¤š` çš„å…³ç³»åœ¨ `Supplier` å’Œ `Product` ä¹‹é—´
2. `å¤šå¯¹å¤š` çš„å…³ç³»åœ¨ `Order` å’Œ `Product` ä¹‹é—´

å¯¹äº `å¤šå¯¹å¤š` å…³ç³»ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè”æ¥è¡¨ `order_details`ï¼Œå› æ­¤ `Order` å’Œ `Product` å®ä½“å°†ä¸ `OrderDetail` å®ä½“å…·æœ‰ `ä¸€å¯¹å¤š` çš„å…³ç³»ã€‚

ç›¸åº”çš„è¡¨å·²ç»ä½¿ç”¨ Sequelize è¿ç§»åˆ›å»ºã€‚Sequelize ä¸æ”¯æŒè‡ªåŠ¨ç”Ÿæˆè¿ç§»ï¼Œå› æ­¤æ‚¨å¿…é¡»æ‰‹åŠ¨ç¼–å†™å®ƒä»¬ã€‚

```javascript collapsable copy filename="src/db/migrations/20231220152726-init.js"
'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable('suppliers', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      companyName: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      city: {
        type: Sequelize.TEXT,
        allowNull: true,
      },
      country: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
    });

    await queryInterface.createTable('products', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      name: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      supplierId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: {
          model: 'suppliers',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL',
      },
      unitPrice: {
        type: Sequelize.DECIMAL,
        allowNull: false,
      },
      unitsInStock: {
        type: Sequelize.INTEGER,
        allowNull: false,
      },
    });

    await queryInterface.createTable('orders', {
      id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
      },
      orderDate: {
        type: Sequelize.DATE,
        allowNull: false,
      },
      shippedDate: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      shipAddress: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
      shipPostalCode: {
        type: Sequelize.TEXT,
        allowNull: true,
      },
      shipCountry: {
        type: Sequelize.TEXT,
        allowNull: false,
      },
    });

    await queryInterface.createTable('order_details', {
      orderId: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        references: {
          model: 'orders',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
      },
      productId: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        references: {
          model: 'products',
          key: 'id',
        },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE',
      },
      quantity: {
        type: Sequelize.INTEGER,
        allowNull: false,
      },
    });
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.dropTable('order_details');
    await queryInterface.dropTable('orders');
    await queryInterface.dropTable('products');
    await queryInterface.dropTable('suppliers');
  },
};
```

æœ¬æŒ‡å—ä½¿ç”¨ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```text
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ db
 â”‚  â”‚  â”œ ğŸ“‚ migrations
 â”‚  â”‚  â”‚  â”” ğŸ“œ 20231220152726-init.js
 â”‚  â”‚  â”œ ğŸ“‚ models
 â”‚  â”‚  â”‚  â”œ ğŸ“œ order-detail.ts
 â”‚  â”‚  â”‚  â”œ ğŸ“œ order.ts
 â”‚  â”‚  â”‚  â”œ ğŸ“œ product.ts
 â”‚  â”‚  â”‚  â”” ğŸ“œ supplier.ts
 â”‚  â”‚  â”œ ğŸ“œ db.ts
 â”‚  â”‚  â”” ğŸ“œ config.js
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ .sequelizerc
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<Steps>

#### å®‰è£… Drizzle ORM å’Œ Drizzle Kit

ç¬¬ä¸€æ­¥æ˜¯å®‰è£… **Drizzle ORM** å’Œ `pg` åŒ…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä½œä¸ºé©±åŠ¨ç¨‹åºã€‚ç¬¬äºŒæ­¥æ˜¯å®‰è£… **Drizzle Kit** å’Œ `pg` çš„ç±»å‹ã€‚ [Drizzle Kit](/docs/kit-overview) - CLI ä¼´ä¾£ï¼Œç”¨äºè‡ªåŠ¨ç”Ÿæˆ SQL è¿ç§»å’Œå¿«é€ŸåŸå‹å¼€å‘ã€‚

<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - æ˜¯ä¸€ä¸ªç”¨äº **Drizzle Kit** çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨æ‚¨çš„é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // ç¡®ä¿å®‰è£…äº† dotenv åŒ…
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  out: './src/drizzle',
  schema: './src/drizzle/schema.ts',
  dbCredentials: {
    host: process.env.DB_HOST!,
    port: Number(process.env.DB_PORT!),
    user: process.env.DB_USERNAME!,
    password: process.env.DB_PASSWORD!,
    database: process.env.DB_NAME!,
  },
  // æ‰“å°æ‰€æœ‰è¯­å¥
  verbose: true,
  // æ€»æ˜¯è¯·æ±‚ç¡®è®¤
  strict: true,
});
```

#### æ·±å…¥æ£€æŸ¥æ‚¨çš„æ•°æ®åº“

**Drizzle Kit** æä¾›äº†ä¸€ä¸ª CLI å‘½ä»¤ï¼Œå¯ä»¥æ·±å…¥æ£€æŸ¥æ‚¨çš„æ•°æ®åº“å¹¶ç”Ÿæˆä¸€ä¸ªæ¨¡å¼æ–‡ä»¶ã€‚æ¨¡å¼æ–‡ä»¶åŒ…å«æœ‰å…³æ•°æ®åº“è¡¨ã€åˆ—ã€å…³ç³»å’Œç´¢å¼•çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```bash
npx drizzle-kit introspect
```

è¯¥å‘½ä»¤å°†åœ¨ src/drizzle æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆä¸€ä¸ª schema.ts æ–‡ä»¶ï¼Œä»¥åŠå¿«ç…§å’Œè¿ç§»ã€‚

```typescript collapsable copy filename="src/drizzle/schema.ts"
import {
  pgTable,
  varchar,
  serial,
  text,
  foreignKey,
  integer,
  numeric,
  timestamp,
  primaryKey,
} from 'drizzle-orm/pg-core';
import { relations, sql } from 'drizzle-orm';

export const sequelizeMeta = pgTable('SequelizeMeta', {
  name: varchar('name', { length: 255 }).primaryKey().notNull(),
});

export const suppliers = pgTable('suppliers', {
  id: serial('id').primaryKey().notNull(),
  companyName: text('companyName').notNull(),
  city: text('city'),
  country: text('country').notNull(),
});

export const products = pgTable('products', {
  id: serial('id').primaryKey().notNull(),
  name: text('name').notNull(),
  supplierId: integer('supplierId')
    .notNull()
    .references(() => suppliers.id, { onDelete: 'set null', onUpdate: 'cascade' }),
  unitPrice: numeric('unitPrice').notNull(),
  unitsInStock: integer('unitsInStock').notNull(),
});

export const orders = pgTable('orders', {
  id: serial('id').primaryKey().notNull(),
  orderDate: timestamp('orderDate', { withTimezone: true, mode: 'string' }).notNull(),
  shippedDate: timestamp('shippedDate', { withTimezone: true, mode: 'string' }),
  shipAddress: text('shipAddress').notNull(),
  shipPostalCode: text('shipPostalCode'),
  shipCountry: text('shipCountry').notNull(),
});

export const orderDetails = pgTable(
  'order_details',
  {
    orderId: integer('orderId')
      .notNull()
      .references(() => orders.id, { onDelete: 'cascade', onUpdate: 'cascade' }),
    productId: integer('productId')
      .notNull()
      .references(() => products.id, { onDelete: 'cascade', onUpdate: 'cascade' }),
    quantity: integer('quantity').notNull(),
  },
  (table) => {
    return {
      orderDetailsPkey: primaryKey({ columns: [table.orderId, table.productId], name: 'order_details_pkey' }),
    };
  },
);
```

```sql collapsable copy filename="src/drizzle/0000_high_rhodey.sql"
-- å½“å‰ SQL æ–‡ä»¶æ˜¯é€šè¿‡æ·±å…¥æ£€æŸ¥æ•°æ®åº“ç”Ÿæˆçš„

CREATE TABLE IF NOT EXISTS "SequelizeMeta" (
	"name" varchar(255) PRIMARY KEY NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "suppliers" (
	"id" serial PRIMARY KEY NOT NULL,
	"companyName" text NOT NULL,
	"city" text,
	"country" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "products" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"supplierId" integer NOT NULL,
	"unitPrice" numeric NOT NULL,
	"unitsInStock" integer NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "orders" (
	"id" serial PRIMARY KEY NOT NULL,
	"orderDate" timestamp with time zone NOT NULL,
	"shippedDate" timestamp with time zone,
	"shipAddress" text NOT NULL,
	"shipPostalCode" text,
	"shipCountry" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "order_details" (
	"orderId" integer NOT NULL,
	"productId" integer NOT NULL,
	"quantity" integer NOT NULL,
	CONSTRAINT order_details_pkey PRIMARY KEY("orderId","productId")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "products" ADD CONSTRAINT "products_supplierId_fkey" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE set null ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE cascade ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE cascade ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

æ­¤å¤–ï¼Œå¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨å…³ç³»æŸ¥è¯¢ï¼Œåˆ™éœ€è¦ä½¿ç”¨å…³ç³»è¡¨æ›´æ–°æ‚¨çš„æ¨¡å¼æ–‡ä»¶ï¼š

```typescript copy filename="src/drizzle/schema.ts"
// ...å…¶ä»–å¯¼å…¥
import { relations } from 'drizzle-orm';

// ...å…¶ä»–è¡¨ 
export const suppliersRelations = relations(suppliers, ({ many }) => ({
  products: many(products),
}));

export const productsRelations = relations(products, ({ one, many }) => ({
  supplier: one(suppliers, { fields: [products.supplierId], references: [suppliers.id] }),
  orderDetails: many(orderDetails),
}));

export const ordersRelations = relations(orders, ({ many }) => ({
  orderDetails: many(orderDetails),
}));

export const orderDetailsRelations = relations(orderDetails, ({ one }) => ({
  order: one(orders, { fields: [orderDetails.orderId], references: [orders.id] }),
  product: one(products, { fields: [orderDetails.productId], references: [products.id] }),
}));
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```text
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ drizzle
 â”‚  â”‚  â”œ ğŸ“‚ meta
 |  |  |  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”‚  â”œ ğŸ“œ 0000_lush_lenny_balinger.sql
 â”‚  â”‚  â”” ğŸ“œ schema.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ tsconfig.json
```

#### è¿æ¥ Drizzle ORM åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/drizzle` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶ï¼Œè®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/drizzle/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';
import * as schema from './schema';

export const client = new Client({
  host: process.env.DB_HOST!,
  port: Number(process.env.DB_PORT!),
  user: process.env.DB_USERNAME!,
  password: process.env.DB_PASSWORD!,
  database: process.env.DB_NAME!,
});

// { schema } ç”¨äºå…³ç³»æŸ¥è¯¢
export const db = drizzle(client, { schema });
```

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { client, db } from './drizzle/db';
import { resolve } from 'node:path';
import { migrate } from 'drizzle-orm/node-postgres/migrator';


(async () => {
  await client.connect();

  // æ­¤å‘½ä»¤è¿è¡Œ migrations æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰è¿ç§»å¹¶å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“
  await migrate(db, { migrationsFolder: resolve(__dirname, './drizzle') });

  // ... å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº
})();
```

#### å°† Sequelize æŸ¥è¯¢è¿ç§»åˆ° Drizzle ORM æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å°† **Sequelize** çš„å‡ ä¸ªæŸ¥è¯¢æ›¿æ¢ä¸º **Drizzle ORM** çš„æŸ¥è¯¢ã€‚

##### æ›¿æ¢æ’å…¥æŸ¥è¯¢

æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•å‘ `suppliers` å’Œ `products` è¡¨ä¸­æ’å…¥æ–°è¡Œã€‚

1. `POST /suppliers`
```typescript copy filename="src/controllers/supplier.controller.ts"
import { Supplier } from '../db/models/supplier';

const suppliers = await Supplier.bulkCreate([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

ä½¿ç”¨ **Drizzle ORM**ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

await db.insert(suppliers).values([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

2. `POST /products`

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';

const products = await Product.bulkCreate([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: 10,
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: 25,
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: 50,
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: 100,
    unitsInStock: 2,
  },
]);
```

ä½¿ç”¨ **Drizzle ORM**ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

æ³¨æ„ `unitPrice` å­—æ®µã€‚åœ¨ **Sequelize** ä¸­å®ƒæ˜¯ `number` ç±»å‹ï¼Œè€Œåœ¨ **Drizzle ORM** ä¸­å®ƒæ˜¯ `string` ç±»å‹ï¼Œå¯ä»¥å¤„ç†å°æ•°ç‚¹åè¶…è¿‡ 16383 ä½çš„æ•°å­—ï¼Œä¸åƒ `number` ç±»å‹ã€‚

```typescript copy filename="src/controllers/product.controller.ts"
await db.insert(products).values([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: '10',
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: '25',
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: '50',
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: '100',
    unitsInStock: 2,
  },
]);
```

##### æ›¿æ¢é€‰æ‹©æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•é€‰æ‹©ä¸€è¡Œã€å¤šè¡Œã€è®¡æ•°è¡Œã€è¿‡æ»¤è¡Œã€è¿æ¥è¡¨å’Œåˆ†é¡µç»“æœã€‚

1. `GET /products/:id`

åœ¨ **Sequelize** ä¸­ï¼Œå“åº”ç±»å‹å¹¶ä¸æ˜¯ä¸¥æ ¼ç±»å‹åŒ–çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨é€‰æ‹©åŒ…å«ä¸€ä¸ªå…³ç³»æˆ–ä»…é€‰æ‹©ä¸€äº›å­—æ®µè€Œä¸æ˜¯æ‰€æœ‰å­—æ®µï¼Œè¿™äº›ä¿®æ”¹ä¸ä¼šåæ˜ åœ¨å“åº”ç±»å‹ä¸­ã€‚

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';
import { Supplier } from '../db/models/supplier';

const { id } = req.params;

const response = await Product.findByPk(id, {
  include: Supplier,
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/product.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products, suppliers } from '../drizzle/schema';

const { id } = req.params;

const response = await db
  .select({
    product: products,
    supplier: suppliers,
  })
  .from(products)
  .where(eq(products.id, id))
  .leftJoin(suppliers, eq(suppliers.id, products.supplierId));

// æˆ–è€…å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const response = await db.query.products.findFirst({
  where: (products, { eq }) => eq(products.id, id),
  with: {
    supplier: true,
  },
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œå“åº”ç±»å‹å°†ç²¾ç¡®åŒ¹é…æ‰€æŒ‡å®šçš„é€‰æ‹©å¯¹è±¡ï¼Œå› æ­¤åŒ…æ‹¬ `supplier` å…³ç³»æ˜¯å®Œå…¨ç±»å‹å®‰å…¨çš„ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  product: {
    name: string;
    id: number;
    supplierId: number;
    unitPrice: string;
    unitsInStock: number;
  };
  supplier: {
    id: number;
    companyName: string;
    city: string | null;
    country: string;
  } | null;
}[]
```

2. `GET /products`

åœ¨ **Sequelize** ä¸­ï¼Œç»“æœä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä¸ä¼šæŒ‡å®šæ‚¨å¸Œæœ›é€‰æ‹©çš„å­—æ®µã€‚

```typescript copy filename="src/controllers/product.controller.ts"
import { Product } from '../db/models/product';
import { Op } from 'sequelize';

const { rows, count } = await Product.findAndCountAll({
  limit: 10,
  offset: 0,
  attributes: ['id', 'name', 'unitPrice', 'unitsInStock'],
  where: {
    name: {
      [Op.iLike]: `%test%`,
    },
  },
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript collapsable copy filename="src/controllers/product.controller.ts"
import { ilike, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products } from '../drizzle/schema';

const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db
    .select({
      id: products.id,
      name: products.name,
      unitPrice: products.unitPrice,
      unitsInStock: products.unitsInStock,
    })
    .from(products)
    .where(whereOptions)
    .offset(0)
    .limit(10),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);

// æˆ–è€…å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db.query.products.findMany({
    where: whereOptions,
    columns: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
    offset: 0,
    limit: 10,
  }),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœæ˜¯ä¸¥æ ¼ç±»å‹å®‰å…¨çš„ï¼Œè¿™æ„å‘³ç€æ‚¨é€‰æ‹©çš„å­—æ®µæ˜¯æ˜ç¡®çš„ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  name: string;
  unitPrice: string;
  unitsInStock: number;
}[]
```

3. `GET /orders/:id`

åœ¨ **Sequelize** ä¸­ï¼Œæ‚¨æ— æ³•ä½¿ç”¨ `findByPk` ç­‰æ–¹æ³•å®ç°å¤æ‚æŸ¥è¯¢ã€‚å› æ­¤ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨åŸå§‹æŸ¥è¯¢ï¼Œè¿™ä¹Ÿä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚

æˆ‘ä»¬æƒ³è¦ä» `orders` è¡¨ä¸­é€‰æ‹© `id`ã€`orderDate` å’Œ `shipCountry` å­—æ®µï¼Œå¹¶ä½¿ç”¨èšåˆå‡½æ•°è®¡ç®— `totalPrice`ã€è®¢å•ä¸­çš„ `totalQuantity` å’Œè®¢å•ä¸­çš„ `totalProducts`ã€‚

```typescript copy filename="src/controllers/order.controller.ts"
import { sequelize } from '../db/db';
import { QueryTypes } from 'sequelize';

const { id } = req.params;

const response = await sequelize.query(
      `
SELECT 
  orders.id,
  orders."orderDate",
  orders."shipCountry",
  SUM(products."unitPrice" * order_details.quantity)::float AS "totalPrice",
  SUM(order_details.quantity)::int AS "totalQuantity",
  COUNT(order_details."productId")::int AS "totalProducts"
FROM orders
LEFT JOIN order_details ON orders.id = order_details."orderId"
LEFT JOIN products ON order_details."productId" = products.id
WHERE orders.id = :orderId
GROUP BY orders.id
`,
      {
        replacements: { orderId: id },
        type: QueryTypes.SELECT,
      },
    );
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orders, orderDetails, products } from '../drizzle/schema';

const { id } = req.params;

const response = await db
      .select({
        id: orders.id,
        shipCountry: orders.shipCountry,
        orderDate: orders.orderDate,
        totalPrice: sql<number>`cast(sum(${orderDetails.quantity} * ${products.unitPrice}) as float)`,
        totalQuantity: sql<number>`cast(sum(${orderDetails.quantity}) as int)`,
        totalProducts: sql<number>`cast(count(${orderDetails.productId}) as int)`,
      })
      .from(orders)
      .where(eq(orders.id, id))
      .groupBy(orders.id)
      .leftJoin(orderDetails, eq(orderDetails.orderId, orders.id))
      .leftJoin(products, eq(products.id, orderDetails.productId));
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœå°†æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå³ä½¿æ˜¯èšåˆè®¡ç®—ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  shipCountry: string;
  orderDate: string;
  totalPrice: number;
  totalQuantity: number;
  totalProducts: number;
}[]
```

**æ³¨æ„ï¼š** å½“å‰èšåˆåœ¨å…³ç³»æŸ¥è¯¢ä¸­ä¸æ”¯æŒï¼Œå› æ­¤æ‚¨å¿…é¡»ä½¿ç”¨æ ¸å¿ƒæŸ¥è¯¢ã€‚

##### æ›¿æ¢æ›´æ–°æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•æ›´æ–°å¤šè¡Œã€‚

1. `PATCH /suppliers/:id`

```typescript copy filename="src/controllers/supplier.controller.ts"
import { Supplier } from '../db/models/supplier';

const { id } = req.params;

const supplier = await Supplier.findByPk(1);
if (!supplier) {
  throw new Error('Supplier not found');
}

supplier.set({
  city: 'TestCity1Updated',
  country: 'TestCountry1Updated',
});

await supplier.save();
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

const { id } = req.params;

await db
    .update(suppliers)
    .set({
      city: 'TestCity1Updated',
      country: 'TestCountry1Updated',
    })
    .where(eq(suppliers.id, id));
```

##### æ›¿æ¢åˆ é™¤æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨äº‹åŠ¡åˆ é™¤å•ä¸ªè¡Œå’Œå¤šè¡Œã€‚

1. `DELETE /orders/:id`

```typescript copy filename="src/controllers/order.controller.ts"
import { Order } from '../db/models/order';
import { OrderDetail } from '../db/models/order-detail';
import { sequelize } from '../db/db';

const { id } = req.params;

try {
  const order = await Order.findByPk(id);
  if (!order) {
    throw new Error('Order not found');
  }

  await sequelize.transaction(async (t) => {
    await OrderDetail.destroy({
      where: {
        orderId: id,
      },
      transaction: t,
    });

    await order.destroy({ transaction: t });
  });
} catch (e) {
  console.error(e);
}
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orderDetails, orders } from '../drizzle/schema';

const { id } = req.params;

try {
  await db.transaction(async (tx) => {
    await tx.delete(orderDetails).where(eq(orderDetails.orderId, id));

    await tx.delete(orders).where(eq(orders.id, id));
  });
} catch (e) {
  console.error(e);
}
```

</Steps>
