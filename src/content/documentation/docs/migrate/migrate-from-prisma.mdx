---
title: "ä» Prisma è¿ç§»åˆ° Drizzle"
---
import Steps from "@mdx/Steps.astro";
import Npm from "@mdx/Npm.astro";

## å…¥é—¨

æœ¬æŒ‡å—æä¾›äº†å°†åŸºæœ¬ **Prisma** é¡¹ç›®è¿ç§»åˆ° **Drizzle ORM** çš„ç®€æ˜æ–¹æ³•ã€‚å°½ç®¡ç¤ºä¾‹ä¾§é‡äº `PostgreSQL`ï¼Œä½†å…¶ä»–æ”¯æŒçš„æ•°æ®åº“çš„è¿‡ç¨‹ä¹Ÿç±»ä¼¼ã€‚

### è¿ç§»è¿‡ç¨‹æ¦‚è¿°

æ— è®ºæ‚¨çš„åº”ç”¨ç±»å‹æˆ– API å±‚å¦‚ä½•ï¼Œä» **Prisma** è¿ç§»åˆ° **Drizzle ORM** çš„æ­¥éª¤éƒ½æ˜¯ä¸€è‡´çš„ï¼š

1. å®‰è£… **Drizzle ORM** å’Œ **Drizzle Kit**
2. è®¾ç½® **Drizzle é…ç½®** æ–‡ä»¶
3. åå‘å·¥ç¨‹æ‚¨çš„æ•°æ®åº“
4. å°† **Drizzle ORM** è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“
5. å°† **Prisma** æŸ¥è¯¢è½¬æ¢ä¸º **Drizzle ORM** æŸ¥è¯¢

è¿™äº›æ­¥éª¤é€‚ç”¨äºæ— è®ºæ˜¯å¼€å‘ REST APIï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ Expressã€Koa æˆ– NestJSï¼‰è¿˜æ˜¯ä»»ä½•å…¶ä»–ç±»å‹ä½¿ç”¨ **Prisma** è¿›è¡Œæ•°æ®åº“äº¤äº’çš„åº”ç”¨ã€‚

## Prisma é¡¹ç›®æ¦‚è¿°

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŸºäº `Express` æ„å»ºçš„ REST API ä½œä¸ºç¤ºä¾‹é¡¹ç›®ï¼Œè¿ç§»åˆ° **Drizzle ORM**ã€‚å®ƒæœ‰å››ä¸ªå®ä½“ï¼š

```prisma  copy filename="prisma/schema.prisma" collapsable
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Product {
  id              Int           @id @default(autoincrement())
  name            String
  supplierId      Int
  unitPrice       Decimal       @db.Decimal(10, 4)
  unitsInStock    Int

  supplier        Supplier?     @relation(fields: [supplierId], references: [id])
  orderDetails    OrderDetail[]

  @@map("products")
}

model Supplier {
  id           Int       @id @default(autoincrement())
  companyName  String
  city         String
  country      String

  products     Product[]

  @@map("suppliers")
}

model OrderDetail {
  orderId   Int
  productId Int
  quantity  Int

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@id([orderId, productId])
  @@map("order_details")
}

model Order {
  id             Int       @id @default(autoincrement())
  orderDate      DateTime  @db.Date
  shippedDate    DateTime? @db.Date
  shipAddress    String
  shipPostalCode String?
  shipCountry    String

  orderDetails OrderDetail[]

  @@map("orders")
}
```

æ¨¡å‹ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š

1. `ä¸€å¯¹å¤š` å…³ç³»ï¼Œ`Supplier` å’Œ `Product`
2. `å¤šå¯¹å¤š` å…³ç³»ï¼Œ`Order` å’Œ `Product`

å¯¹äº `å¤šå¯¹å¤š` å…³ç³»ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¿æ¥è¡¨ `order_details`ï¼Œå› æ­¤ `Order` å’Œ `Product` å®ä½“å°†ä¸ `OrderDetail` å®ä½“æœ‰ `ä¸€å¯¹å¤š` å…³ç³»ã€‚

ç›¸åº”çš„è¡¨å·²ä½¿ç”¨ç”Ÿæˆçš„ Prisma è¿ç§»åˆ›å»ºã€‚


```sql copy filename="prisma/migrations/20240101200233_init/migration.sql" collapsable
-- CreateTable
CREATE TABLE "products" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "supplierId" INTEGER NOT NULL,
    "unitPrice" DECIMAL(10,4) NOT NULL,
    "unitsInStock" INTEGER NOT NULL,

    CONSTRAINT "products_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "suppliers" (
    "id" SERIAL NOT NULL,
    "companyName" TEXT NOT NULL,
    "city" TEXT NOT NULL,
    "country" TEXT NOT NULL,

    CONSTRAINT "suppliers_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "order_details" (
    "orderId" INTEGER NOT NULL,
    "productId" INTEGER NOT NULL,
    "quantity" INTEGER NOT NULL,

    CONSTRAINT "order_details_pkey" PRIMARY KEY ("orderId","productId")
);

-- CreateTable
CREATE TABLE "orders" (
    "id" SERIAL NOT NULL,
    "orderDate" DATE NOT NULL,
    "shippedDate" DATE,
    "shipAddress" TEXT NOT NULL,
    "shipPostalCode" TEXT,
    "shipCountry" TEXT NOT NULL,

    CONSTRAINT "orders_pkey" PRIMARY KEY ("id")
);

-- AddForeignKey
ALTER TABLE "products" ADD CONSTRAINT "products_supplierId_fkey" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "order_details" ADD CONSTRAINT "order_details_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "order_details" ADD CONSTRAINT "order_details_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

æœ¬æŒ‡å—ä½¿ç”¨ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ prisma
 â”‚  â”œ ğŸ“‚ migrations
 â”‚  â”‚  â”œ ğŸ“‚ 20240101200233_init
 â”‚  â”‚  â”‚  â”” ğŸ“œ migration.sql
 â”‚  â”‚  â”” ğŸ“œ migration_lock.toml
 â”‚  â”” ğŸ“œ schema.prisma
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ db
 â”‚  â”‚  â”” ğŸ“œ db.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<Steps>

#### å®‰è£… Drizzle ORM å’Œ Drizzle Kit

ç¬¬ä¸€æ­¥æ˜¯å®‰è£… **Drizzle ORM** å’Œ `pg` åŒ…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä½œä¸ºé©±åŠ¨ç¨‹åºã€‚ç¬¬äºŒæ­¥æ˜¯å®‰è£… **Drizzle Kit** å’Œ `pg` çš„ç±»å‹ã€‚[Drizzle Kit](/docs/kit-overview) - ç”¨äºè‡ªåŠ¨ç”Ÿæˆ SQL è¿ç§»å’Œå¿«é€ŸåŸå‹çš„ CLI ä¼™ä¼´ã€‚

<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± **Drizzle Kit** ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨æ‚¨çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // ç¡®ä¿å®‰è£… dotenv åŒ…
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  out: './src/drizzle',
  schema: './src/drizzle/schema.ts',
  dbCredentials: {
    host: process.env.DB_HOST!,
    port: Number(process.env.DB_PORT!),
    user: process.env.DB_USERNAME!,
    password: process.env.DB_PASSWORD!,
    database: process.env.DB_NAME!,
  },
  // æ‰“å°æ‰€æœ‰è¯­å¥
  verbose: true,
  // å§‹ç»ˆè¦æ±‚ç¡®è®¤
  strict: true,
});
```

#### åå‘å·¥ç¨‹æ‚¨çš„æ•°æ®åº“

**Drizzle Kit** æä¾› CLI å‘½ä»¤æ¥åå‘å·¥ç¨‹æ‚¨çš„æ•°æ®åº“å¹¶ç”Ÿæˆæ¨¡å¼æ–‡ä»¶ã€‚æ¨¡å¼æ–‡ä»¶åŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¡¨ã€åˆ—ã€å…³ç³»å’Œç´¢å¼•çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```bash
npx drizzle-kit introspect
```

æ­¤å‘½ä»¤å°†ç”Ÿæˆä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶åœ¨ `src/drizzle` æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆå¿«ç…§å’Œè¿ç§»ã€‚

```typescript collapsable copy filename="src/drizzle/schema.ts"
import {
  pgTable,
  varchar,
  timestamp,
  text,
  integer,
  serial,
  foreignKey,
  numeric,
  date,
  primaryKey,
} from 'drizzle-orm/pg-core';
import { sql } from 'drizzle-orm';

export const prismaMigrations = pgTable('_prisma_migrations', {
  id: varchar('id', { length: 36 }).primaryKey().notNull(),
  checksum: varchar('checksum', { length: 64 }).notNull(),
  finishedAt: timestamp('finished_at', { withTimezone: true, mode: 'string' }),
  migrationName: varchar('migration_name', { length: 255 }).notNull(),
  logs: text('logs'),
  rolledBackAt: timestamp('rolled_back_at', { withTimezone: true, mode: 'string' }),
  startedAt: timestamp('started_at', { withTimezone: true, mode: 'string' }).defaultNow().notNull(),
  appliedStepsCount: integer('applied_steps_count').default(0).notNull(),
});

export const suppliers = pgTable('suppliers', {
  id: serial('id').primaryKey().notNull(),
  companyName: text('companyName').notNull(),
  city: text('city').notNull(),
  country: text('country').notNull(),
});

export const products = pgTable('products', {
  id: serial('id').primaryKey().notNull(),
  name: text('name').notNull(),
  supplierId: integer('supplierId')
    .notNull()
    .references(() => suppliers.id, { onDelete: 'restrict', onUpdate: 'cascade' }),
  unitPrice: numeric('unitPrice', { precision: 10, scale: 4 }).notNull(),
  unitsInStock: integer('unitsInStock').notNull(),
});

export const orders = pgTable('orders', {
  id: serial('id').primaryKey().notNull(),
  orderDate: date('orderDate').notNull(),
  shippedDate: date('shippedDate'),
  shipAddress: text('shipAddress').notNull(),
  shipPostalCode: text('shipPostalCode'),
  shipCountry: text('shipCountry').notNull(),
});

export const orderDetails = pgTable(
  'order_details',
  {
    orderId: integer('orderId')
      .notNull()
      .references(() => orders.id, { onDelete: 'restrict', onUpdate: 'cascade' }),
    productId: integer('productId')
      .notNull()
      .references(() => products.id, { onDelete: 'restrict', onUpdate: 'cascade' }),
    quantity: integer('quantity').notNull(),
  },
  (table) => {
    return {
      orderDetailsPkey: primaryKey({ columns: [table.orderId, table.productId], name: 'order_details_pkey' }),
    };
  },
);
```

```sql collapsable copy filename="src/drizzle/0000_cool_puff_adder.sql"
CREATE TABLE IF NOT EXISTS "_prisma_migrations" (
	"id" varchar(36) PRIMARY KEY NOT NULL,
	"checksum" varchar(64) NOT NULL,
	"finished_at" timestamp with time zone,
	"migration_name" varchar(255) NOT NULL,
	"logs" text,
	"rolled_back_at" timestamp with time zone,
	"started_at" timestamp with time zone DEFAULT now() NOT NULL,
	"applied_steps_count" integer DEFAULT 0 NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "suppliers" (
	"id" serial PRIMARY KEY NOT NULL,
	"companyName" text NOT NULL,
	"city" text NOT NULL,
	"country" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "products" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"supplierId" integer NOT NULL,
	"unitPrice" numeric(10, 4) NOT NULL,
	"unitsInStock" integer NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "orders" (
	"id" serial PRIMARY KEY NOT NULL,
	"orderDate" date NOT NULL,
	"shippedDate" date,
	"shipAddress" text NOT NULL,
	"shipPostalCode" text,
	"shipCountry" text NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "order_details" (
	"orderId" integer NOT NULL,
	"productId" integer NOT NULL,
	"quantity" integer NOT NULL,
	CONSTRAINT order_details_pkey PRIMARY KEY("orderId","productId")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "products" ADD CONSTRAINT "products_supplierId_fkey" FOREIGN KEY ("supplierId") REFERENCES "suppliers"("id") ON DELETE restrict ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_orderId_fkey" FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE restrict ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "order_details" ADD CONSTRAINT "order_details_productId_fkey" FOREIGN KEY ("productId") REFERENCES "products"("id") ON DELETE restrict ON UPDATE cascade;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

å¦å¤–ï¼Œå¦‚æœæ‚¨æƒ³ä½¿ç”¨å…³ç³»æŸ¥è¯¢ï¼Œå¿…é¡»é€šè¿‡å…³ç³»è¡¨æ›´æ–°æ‚¨çš„æ¨¡å¼æ–‡ä»¶ï¼š

```typescript copy filename="src/drizzle/schema.ts"
// ...å…¶ä»–å¯¼å…¥
import { relations } from 'drizzle-orm';

// ...å…¶ä»–è¡¨
export const suppliersRelations = relations(suppliers, ({ many }) => ({
  products: many(products),
}));

export const productsRelations = relations(products, ({ one, many }) => ({
  supplier: one(suppliers, { fields: [products.supplierId], references: [suppliers.id] }),
  orderDetails: many(orderDetails),
}));

export const ordersRelations = relations(orders, ({ many }) => ({
  orderDetails: many(orderDetails),
}));

export const orderDetailsRelations = relations(orderDetails, ({ one }) => ({
  order: one(orders, { fields: [orderDetails.orderId], references: [orders.id] }),
  product: one(products, { fields: [orderDetails.productId], references: [products.id] }),
}));
```

ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ drizzle
 â”‚  â”‚  â”œ ğŸ“‚ meta
 |  |  |  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”‚  â”œ ğŸ“œ 0000_cool_puff_adder.sql
 â”‚  â”‚  â”” ğŸ“œ schema.ts
 â”‚  â”œ ğŸ“‚ routers
 â”‚  â”‚  â”œ ğŸ“œ order.router.ts
 â”‚  â”‚  â”œ ğŸ“œ product.router.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.router.ts
 â”‚  â”œ ğŸ“‚ controllers
 â”‚  â”‚  â”œ ğŸ“œ order.controller.ts
 â”‚  â”‚  â”œ ğŸ“œ product.controller.ts
 â”‚  â”‚  â”” ğŸ“œ supplier.controller.ts
 â”‚  â”œ ğŸ“œ index.ts
 â”‚  â”” ğŸ“œ server.ts
 â”œ ğŸ“œ package.json
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ tsconfig.json
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/drizzle` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/drizzle/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';
import * as schema from './schema';

export const client = new Client({
  host: process.env.DB_HOST!,
  port: Number(process.env.DB_PORT!),
  user: process.env.DB_USERNAME!,
  password: process.env.DB_PASSWORD!,
  database: process.env.DB_NAME!,
});

// { schema } ç”¨äºå…³ç³»æŸ¥è¯¢
export const db = drizzle(client, { schema });
```

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { client, db } from './drizzle/db';
import { resolve } from 'node:path';
import { migrate } from 'drizzle-orm/node-postgres/migrator';


(async () => {
  await client.connect();

  // æ­¤å‘½ä»¤è¿è¡Œè¿ç§»æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰è¿ç§»å¹¶å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“
  await migrate(db, { migrationsFolder: resolve(__dirname, './drizzle') });

  // ... å¯åŠ¨æ‚¨çš„åº”ç”¨
})();
```

#### å°†æ‚¨çš„ Prisma æŸ¥è¯¢è½¬æ¢ä¸º Drizzle ORM æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å°†å¤šä¸ª **Prisma** æŸ¥è¯¢æ›¿æ¢ä¸º **Drizzle ORM** æŸ¥è¯¢ã€‚

##### æ›¿æ¢æ’å…¥æŸ¥è¯¢

æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•å°†æ–°è¡Œæ’å…¥ `suppliers` å’Œ `products` è¡¨ä¸­ã€‚

1. `POST /suppliers`
```typescript copy filename="src/controllers/supplier.controller.ts"
import { prisma } from '../db/db';

await prisma.supplier.createMany({
  data: [
    { companyName: 'TestCompanyName1', city: 'TestCity1', country: 'TestCountry1' },
    { companyName: 'TestCompanyName2', city: 'TestCity2', country: 'TestCountry2' },
  ],
});
```

ä½¿ç”¨ **Drizzle ORM**ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

await db.insert(suppliers).values([
  {
    companyName: 'TestCompanyName1',
    city: 'TestCity1',
    country: 'TestCountry1',
  },
  {
    companyName: 'TestCompanyName2',
    city: 'TestCity2',
    country: 'TestCountry2',
  },
]);
```

2. `POST /products`

```typescript copy filename="src/controllers/product.controller.ts"
import { prisma } from '../db/db';

await prisma.product.createMany({
  data: [
    { 
      name: 'TestProductName1',
      supplierId: 1,
      unitPrice: 10,
      unitsInStock: 20,
    },
    {
      name: 'TestProductName2',
      supplierId: 1,
      unitPrice: 25,
      unitsInStock: 7,
    },
    {
      name: 'TestProductName3',
      supplierId: 2,
      unitPrice: 50,
      unitsInStock: 17,
    },
    {
      name: 'TestProductName4',
      supplierId: 2,
      unitPrice: 100,
      unitsInStock: 2,
    },
  ],
});
```

ä½¿ç”¨ **Drizzle ORM**ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

è¯·æ³¨æ„ `unitPrice` å­—æ®µã€‚åœ¨ **Prisma** ä¸­å®ƒæ˜¯ `number` ç±»å‹ï¼Œä½†åœ¨ **Drizzle ORM** ä¸­å®ƒæ˜¯ `string` ç±»å‹ï¼Œå¯ä»¥å¤„ç†è¶…è¿‡ 16383 ä½å°æ•°çš„æ•°å­—ï¼Œä¸ `number` ç±»å‹ä¸åŒã€‚

```typescript copy filename="src/controllers/product.controller.ts"
await db.insert(products).values([
  {
    name: 'TestProductName1',
    supplierId: 1,
    unitPrice: '10',
    unitsInStock: 20,
  },
  {
    name: 'TestProductName2',
    supplierId: 1,
    unitPrice: '25',
    unitsInStock: 7,
  },
  {
    name: 'TestProductName3',
    supplierId: 2,
    unitPrice: '50',
    unitsInStock: 17,
  },
  {
    name: 'TestProductName4',
    supplierId: 2,
    unitPrice: '100',
    unitsInStock: 2,
  },
]);
```

##### æ›¿æ¢é€‰æ‹©æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•é€‰æ‹©ä¸€è¡Œã€å¤šè¡Œã€è®¡æ•°è¡Œã€è¿‡æ»¤è¡Œã€è¿æ¥è¡¨å’Œåˆ†é¡µç»“æœã€‚

1. `GET /products/:id`

```typescript copy filename="src/controllers/product.controller.ts"
import { prisma } from '../db/db';

const { id } = req.params;

const response = await prisma.product.findUnique({
  where: { id },
  include: {
    supplier: true,
  },
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/product.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products, suppliers } from '../drizzle/schema';

const { id } = req.params;

const response = await db
  .select({
    product: products,
    supplier: suppliers,
  })
  .from(products)
  .where(eq(products.id, id))
  .leftJoin(suppliers, eq(suppliers.id, products.supplierId));

// æˆ–è€…å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const response = await db.query.products.findFirst({
  where: (products, { eq }) => eq(products.id, id),
  with: {
    supplier: true,
  },
});
```

å“åº”å°†æ˜¯å¯¹ä¸¤ä¸ª ORM çš„ç±»å‹å®‰å…¨ã€‚

```typescript
// Drizzle ORM çš„å“åº”ç±»å‹
const response: {
  product: {
    name: string;
    id: number;
    supplierId: number;
    unitPrice: string;
    unitsInStock: number;
  };
  supplier: {
    id: number;
    companyName: string;
    city: string | null;
    country: string;
  } | null;
}[]
```

2. `GET /products`

```typescript copy filename="src/controllers/product.controller.ts"
import { Prisma } from '@prisma/client';
import { prisma } from '../db/db';

const whereOptions: Prisma.ProductWhereInput = {
  name: { contains: 'test', mode: 'insensitive' },
};

const [response, count] = await Promise.all([
  prisma.product.findMany({
    where: whereOptions,
    take: 10,
    skip: 0,
    select: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
  }),
  prisma.product.count({ where: whereOptions }),
]);
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript collapsable copy filename="src/controllers/product.controller.ts"
import { ilike, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { products } from '../drizzle/schema';

const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db
    .select({
      id: products.id,
      name: products.name,
      unitPrice: products.unitPrice,
      unitsInStock: products.unitsInStock,
    })
    .from(products)
    .where(whereOptions)
    .offset(0)
    .limit(10),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);

// æˆ–è€…å¯ä»¥ä½¿ç”¨å…³ç³»æŸ¥è¯¢
const whereOptions = ilike(products.name, `%test%`);

const [response, count] = await Promise.all([
  db.query.products.findMany({
    where: whereOptions,
    columns: {
      id: true,
      name: true,
      unitPrice: true,
      unitsInStock: true,
    },
    offset: 0,
    limit: 10,
  }),
  db
    .select({ count: sql<number>`cast(count(${products.id}) as integer)` })
    .from(products)
    .where(whereOptions),
]);
```

å“åº”å°†æ˜¯å¯¹ä¸¤ä¸ª ORM çš„ç±»å‹å®‰å…¨ã€‚

```typescript
// Drizzle ORM çš„å“åº”ç±»å‹
const response: {
  id: number;
  name: string;
  unitPrice: string;
  unitsInStock: number;
}[]
```

3. `GET /orders/:id`

åœ¨ **Prisma** ä¸­ï¼Œèšåˆå‡½æ•°éœ€è¦ä½¿ç”¨ `aggregate` æ–¹æ³•ã€‚å¯¹äºå¤æ‚çš„æŸ¥è¯¢ï¼Œä½¿ç”¨ `$queryRaw` æ–¹æ³•ï¼Œå®ƒä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚

æˆ‘ä»¬å¸Œæœ›ä» `orders` è¡¨ä¸­é€‰æ‹© `id`ã€`orderDate` å’Œ `shipCountry` å­—æ®µï¼Œå¹¶ä½¿ç”¨ `èšåˆå‡½æ•°` æ±‚å’Œ `è®¢å•æ€»ä»·`ã€`è®¢å•ä¸­äº§å“æ€»é‡` å’Œ `è®¢å•ä¸­çš„äº§å“æ€»æ•°`ã€‚

```typescript copy filename="src/controllers/order.controller.ts"
import { prisma } from '../db/db';

const { id } = req.params;

const order = await prisma.order.findFirst({
  where: { id },
  select: {
    id: true,
    orderDate: true,
    shipCountry: true,
  },
});
if (!order) {
  throw new Error('Order not found');
}

const { _count, _sum } = await prisma.orderDetail.aggregate({
  where: { orderId: id },
  _sum: {
    quantity: true,
  },
  _count: {
    orderId: true,
  },
});

const totalPrice: Array<{ totalPrice: number }> = await prisma.$queryRaw<number>`
  SELECT SUM(unitPrice * quantity) as "totalPrice"
  FROM order_details
  WHERE "orderId" = ${id}
`;

const response = {
  ...order,
  totalPrice: totalPrice[0].totalPrice,
  totalQuantity: _sum.quantity,
  totalProducts: _count.orderId,
};
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq, sql } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orders, orderDetails, products } from '../drizzle/schema';

const { id } = req.params;

const response = await db
      .select({
        id: orders.id,
        shipCountry: orders.shipCountry,
        orderDate: orders.orderDate,
        totalPrice: sql<number>`cast(sum(${orderDetails.quantity} * ${products.unitPrice}) as float)`,
        totalQuantity: sql<number>`cast(sum(${orderDetails.quantity}) as int)`,
        totalProducts: sql<number>`cast(count(${orderDetails.productId}) as int)`,
      })
      .from(orders)
      .where(eq(orders.id, id))
      .groupBy(orders.id)
      .leftJoin(orderDetails, eq(orderDetails.orderId, orders.id))
      .leftJoin(products, eq(products.id, orderDetails.productId));
```

åœ¨ **Drizzle ORM** ä¸­ï¼Œç»“æœä¹Ÿä¼šæ˜¯ç±»å‹å®‰å…¨çš„åŒ…å«èšåˆçš„æŸ¥è¯¢ã€‚

```typescript
// å“åº”ç±»å‹
const response: {
  id: number;
  shipCountry: string;
  orderDate: string;
  totalPrice: number;
  totalQuantity: number;
  totalProducts: number;
}[]
```

**æ³¨æ„:** ç›®å‰èšåˆä¸æ”¯æŒåœ¨å…³ç³»æŸ¥è¯¢ä¸­ä½¿ç”¨ï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨ `æ ¸å¿ƒæŸ¥è¯¢`ã€‚

##### æ›¿æ¢æ›´æ–°æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•æ›´æ–°å¤šè¡Œã€‚

1. `PATCH /suppliers/:id`
  
```typescript copy filename="src/controllers/supplier.controller.ts"
import { prisma } from '../db/db';

const { id } = req.params;

const supplier = await prisma.supplier.update({
  where: { id },
  data: { city: 'TestCity1Updated', country: 'TestCountry1Updated' },
});
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/supplier.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { suppliers } from '../drizzle/schema';

const { id } = req.params;

await db
    .update(suppliers)
    .set({
      city: 'TestCity1Updated',
      country: 'TestCountry1Updated',
    })
    .where(eq(suppliers.id, id));
```

##### æ›¿æ¢åˆ é™¤æŸ¥è¯¢

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨äº‹åŠ¡åˆ é™¤å•ä¸ªè¡Œå’Œå¤šä¸ªè¡Œã€‚

1. `DELETE /orders/:id`

```typescript copy filename="src/controllers/order.controller.ts"
import { prisma } from '../db/db';

const { id } = req.params;

const orderDetailQuery = prisma.orderDetail.deleteMany({
  where: { orderId: id },
});

const orderQuery = prisma.order.deleteMany({
  where: { id },
});

await prisma.$transaction([orderDetailQuery, orderQuery]);
```

åœ¨ **Drizzle ORM** ä¸­ï¼ŒæŸ¥è¯¢å¦‚ä¸‹å®ç°ï¼š

```typescript copy filename="src/controllers/order.controller.ts"
import { eq } from 'drizzle-orm';
import { db } from '../drizzle/db';
import { orderDetails, orders } from '../drizzle/schema';

const { id } = req.params;

try {
  await db.transaction(async (tx) => {
    await tx.delete(orderDetails).where(eq(orderDetails.orderId, id));

    await tx.delete(orders).where(eq(orders.id, id));
  });
} catch (e) {
  console.error(e);
}
```
</Steps>
