import Tab from '@components/markdown/Tab.astro';
import Tabs from '@components/markdown/Tabs.astro';
import Callout from '@components/markdown/Callout.astro';
import CodeTab from '@components/markdown/CodeTab.astro';
import CodeTabs from '@components/markdown/CodeTabs.astro';
import Npm from '@components/markdown/Npm.astro';

# drizzle-graphql

é€šè¿‡ä¸€è¡Œä»£ç ä» Drizzle æ¨¡å¼åˆ›å»º GraphQL æœåŠ¡å™¨ï¼Œå¹¶è½»æ¾å¢å¼ºè‡ªå®šä¹‰æŸ¥è¯¢å’Œå˜æ›´ã€‚

## å¿«é€Ÿå¼€å§‹

ç¡®ä¿ä½ çš„ `drizzle-orm` ç‰ˆæœ¬è‡³å°‘ä¸º `0.30.9`ï¼Œå¦‚æœ‰éœ€è¦è¯·æ›´æ–°ï¼š
<Npm>drizzle-orm@latest</Npm>

### Apollo æœåŠ¡å™¨

<Npm>drizzle-graphql @apollo/server graphql</Npm>

<CodeTabs items={['server.ts', 'schema.ts']}>
<CodeTab>
```ts copy {1, 10}
import { buildSchema } from 'drizzle-graphql';
import { drizzle } from 'drizzle-orm/...';
import client from './db';
import { ApolloServer } from '@apollo/server';
import { startStandaloneServer } from '@apollo/server/standalone';

import * as dbSchema from './schema';

const db = drizzle(client, { schema: dbSchema });

const { schema } = buildSchema(db);

const server = new ApolloServer({ schema });
const { url } = await startStandaloneServer(server);

console.log(`ğŸš€ æœåŠ¡å™¨å·²å‡†å¤‡å¥½ï¼Œåœ°å€ä¸º ${url}`);
```
</CodeTab>
<CodeTab>
```typescript copy
import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, { fields: [posts.authorId], references: [users.id] }),
}));
```
</CodeTab>
</CodeTabs>

### GraphQL Yoga

<Npm>drizzle-graphql graphql-yoga graphql</Npm>

<CodeTabs items={['server.ts', 'schema.ts']}>
<CodeTab>
```ts copy {1, 10}
import { buildSchema } from 'drizzle-graphql';
import { drizzle } from 'drizzle-orm/...';
import { createYoga } from 'graphql-yoga';
import { createServer } from 'node:http';

import * as dbSchema from './schema';

const db = drizzle({ schema: dbSchema });

const { schema } = buildSchema(db);

const yoga = createYoga({ schema });
const server = createServer(yoga);

server.listen(4000, () => {
  console.info('æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ http://localhost:4000/graphql');
});
```
</CodeTab>
<CodeTab>
```typescript copy
import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, { fields: [posts.authorId], references: [users.id] }),
}));
```
</CodeTab>
</CodeTabs>

## è‡ªå®šä¹‰æ¨¡å¼

<Callout type='info' emoji='â„¹ï¸'>
`buildSchema()` ä½¿ç”¨æ ‡å‡†çš„ `graphql` SDK ç”Ÿæˆæ¨¡å¼å’Œç±»å‹ï¼Œå› æ­¤å…¶è¾“å‡ºä¸ä»»ä½•æ”¯æŒè¯¥è¾“å‡ºçš„åº“å…¼å®¹ã€‚
</Callout>

å¦‚æœä½ æƒ³è‡ªå®šä¹‰ä½ çš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ `entities` å¯¹è±¡æ¥æ„å»ºä½ è‡ªå·±çš„æ–°æ¨¡å¼ï¼š

<CodeTabs items={['server.ts', 'schema.ts']}>
<CodeTab>
```ts {1, 11}
import { buildSchema } from 'drizzle-graphql';
import { drizzle } from 'drizzle-orm/...';
import { GraphQLList, GraphQLNonNull, GraphQLObjectType, GraphQLSchema } from 'graphql';
import { createYoga } from 'graphql-yoga';
import { createServer } from 'node:http';

import * as dbSchema from './schema';

const db = drizzle({ schema: dbSchema });

const { entities } = buildSchema(db);

// ä½ å¯ä»¥è‡ªå®šä¹‰æŸ¥è¯¢æˆ–å˜æ›´çš„éƒ¨åˆ†
const schema = new GraphQLSchema({
  query: new GraphQLObjectType({
    name: 'Query',
    fields: {
      // ä»æ‰€æœ‰ç”Ÿæˆçš„æŸ¥è¯¢ä¸­é€‰æ‹©æ‰€éœ€çš„æŸ¥è¯¢
      users: entities.queries.users,
      customer: entities.queries.customersSingle,

      // åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æŸ¥è¯¢
      customUsers: {
        // ä½ å¯ä»¥é‡æ–°ä½¿ç”¨å¹¶è‡ªå®šä¹‰æ¥è‡ªåŸå§‹æ¨¡å¼çš„ç±»å‹
        type: new GraphQLList(new GraphQLNonNull(entities.types.UsersItem)),
        args: {
          // ä½ ä¹Ÿå¯ä»¥é‡æ–°ä½¿ç”¨è¾“å…¥
          where: {
            type: entities.inputs.UsersFilters
          },
        },
        resolve: async (source, args, context, info) => {
          // ä½ çš„è‡ªå®šä¹‰é€»è¾‘åœ¨è¿™é‡Œ...
          const result = await db.select(schema.users).where()...

          return result;
        },
      },
    },
  }),
  // ç›¸åŒçš„è§„åˆ™é€‚ç”¨äºå˜æ›´
  mutation: new GraphQLObjectType({
    name: 'Mutation',
    fields: entities.mutations,
  }),
  // å¦‚æœä½ éœ€è¦ç±»å‹åœ¨ä½ çš„æ¨¡å¼å†…
  types: [...Object.values(entities.types), ...Object.values(entities.inputs)],
});

const yoga = createYoga({
  schema,
});

const server = createServer(yoga);

server.listen(4000, () => {
  console.info('æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ http://localhost:4000/graphql');
})
```
</CodeTab>
<CodeTab>
```typescript copy
import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, { fields: [posts.authorId], references: [users.id] }),
}));
```
</CodeTab>
</CodeTabs>
