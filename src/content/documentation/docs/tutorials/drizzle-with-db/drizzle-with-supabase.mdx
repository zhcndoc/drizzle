---
title: "ä½¿ç”¨ Supabase æ•°æ®åº“çš„ Drizzle"
date: "2024-05-07"
svgs: ['<svg width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 43.4805 67.3037)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 76.9395 46.5342)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 128.424 46.5352)" fill="currentColor"></rect><rect width="9.63139" height="40.8516" rx="4.8157" transform="matrix(0.873028 0.48767 -0.497212 0.867629 94.957 67.3037)" fill="currentColor"></rect></svg>', <svg width="24" height="25" viewBox="0 0 24 25" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M13.3501 21.1611C12.9303 21.6898 12.079 21.4002 12.0689 20.7251L11.921 10.8511H18.5603C19.7628 10.8511 20.4335 12.24 19.6857 13.1818L13.3501 21.1611Z" /><path d="M10.6499 5.27307C11.0697 4.7443 11.921 5.03403 11.9311 5.70913L11.996 15.5831H5.43981C4.23723 15.5831 3.56652 14.1942 4.31432 13.2524L10.6499 5.27307Z"/></svg>]
---

import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥ [Supabase æ•°æ®åº“](https://supabase.com/docs/guides/database/overview)ã€‚æ¯ä¸ª Supabase é¡¹ç›®éƒ½é™„å¸¦ä¸€ä¸ªå®Œæ•´çš„ [Postgres](https://www.postgresql.org/) æ•°æ®åº“ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- æ‚¨åº”è¯¥å·²å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³è¯¥åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·[ç‚¹å‡»æ­¤å¤„](https://www.npmjs.com/package/dotenv)ã€‚
<Npm>
  dotenv
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `postgres` åŒ…ä»¥è¿æ¥åˆ° Postgres æ•°æ®åº“ã€‚æœ‰å…³è¯¥åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·[ç‚¹å‡»æ­¤å¤„](https://www.npmjs.com/package/postgres)ã€‚
<Npm>
  postgres
</Npm>

- æ‚¨è¿˜åº”å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ [Supabase CLI](https://supabase.com/docs/guides/cli/getting-started#installing-the-supabase-cli)ï¼ˆä»…åœ¨æ‚¨æƒ³ä½¿ç”¨ Supabase CLI è¿›è¡Œè¿ç§»æ—¶ï¼‰ã€‚
</Prerequisites>

è¯·æŸ¥çœ‹ [Supabase æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connecting-with-drizzle)ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“ã€‚

## è®¾ç½® Supabase å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Supabase é¡¹ç›®

æ‚¨å¯ä»¥åœ¨ [ä»ªè¡¨æ¿](https://supabase.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Supabase é¡¹ç›®ï¼Œæˆ–é€šè¿‡æ­¤ [é“¾æ¥](https://database.new/) åˆ›å»ºã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªåˆ° [æ•°æ®åº“è®¾ç½®](https://supabase.com/dashboard/project/_/settings/database)ï¼Œå¹¶ä» `è¿æ¥å­—ç¬¦ä¸²` éƒ¨åˆ†å¤åˆ¶ URIã€‚ç¡®ä¿ä½¿ç”¨ `è¿æ¥æ± `ã€‚è¯·è®°å¾—ç”¨æ‚¨çš„å®é™…æ•°æ®åº“å¯†ç æ›¿æ¢å¯†ç å ä½ç¬¦ã€‚

å°† `DATABASE_URL` å˜é‡æ·»åŠ åˆ°æ‚¨çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ä¸­ã€‚

```plaintext copy
DATABASE_URL=<YOUR_DATABASE_URL>
```

æœ‰å…³è¿æ¥æ± å’Œæ± æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)ã€‚

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { config } from 'dotenv';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

config({ path: '.env' }); // æˆ– .env.local

const client = postgres(process.env.DATABASE_URL!);
export const db = drizzle(client);
```

#### åˆ›å»ºè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './supabase/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `supabase/migrations` ç›®å½•ä¸­ï¼Œæ­£å¦‚æ‚¨åœ¨ `drizzle.config.ts` ä¸­æŒ‡å®šçš„é‚£æ ·ã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ‚¨çš„æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ªç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µæ¶æ„å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

äº†è§£æœ‰å…³ [è¿ç§»è¿‡ç¨‹](/docs/migrations) çš„æ›´å¤šä¿¡æ¯ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ [Supabase CLI](https://supabase.com/docs/guides/cli/getting-started) åº”ç”¨è¿ç§»ï¼š
- å¯¹äºå·²å­˜åœ¨çš„è¡¨ï¼Œæ‰‹åŠ¨å®¡æŸ¥ä» `npx drizzle-kit generate` ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ï¼Œå¹¶æ³¨é‡Šæˆ–è°ƒæ•´ä»»ä½•ä¸å®‰å…¨çš„çº¯åˆ›å»ºè¯­å¥ï¼ˆä¾‹å¦‚ï¼Œ`CREATE SCHEMA "auth";`ï¼‰ï¼Œç¡®ä¿å®‰å…¨çš„æ¡ä»¶åˆ›å»ºï¼ˆä¾‹å¦‚ï¼Œ`CREATE TABLE IF NOT EXISTS "auth"."users"`ï¼‰å¾—åˆ°å¦¥å–„å¤„ç†ã€‚

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œæ›´æ”¹çš„æƒ…å†µï¼Œä½¿æ‚¨èƒ½å¤Ÿå¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

è¦ä½¿ç”¨ Supabase CLI åº”ç”¨è¿ç§»ï¼Œæ‚¨åº”éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

ä½¿ç”¨ Drizzle Kit ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

åˆå§‹åŒ–æœ¬åœ° Supabase é¡¹ç›®ï¼š

```bash copy
supabase init
```

å°†å…¶é“¾æ¥åˆ°æ‚¨çš„è¿œç¨‹é¡¹ç›®ï¼š

```bash copy
supabase link
```

å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
supabase db push
```
</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬åœ¨ `index.ts` ä¸­çš„è¿æ¥å’Œåœ¨ `schema.ts` ä¸­çš„æ¶æ„å®šä¹‰ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ supabase
 â”‚   â”œ ğŸ“‚ migrations
 â”‚   â”‚  â”œ ğŸ“‚ meta
 â”‚   â”‚  â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”‚  â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”‚   â”” ğŸ“œ config.toml
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º `src/db/queries` æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œï¼ˆæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°ã€åˆ é™¤ï¼‰å•ç‹¬åˆ›å»ºæ–‡ä»¶ã€‚

#### æ’å…¥æ•°æ®

æœ‰å…³æ’å…¥æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

æœ‰å…³é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/select)ã€‚

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getTableColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getTableColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚
#### æ›´æ–°æ•°æ®

æœ‰å…³æ›´æ–°æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

æœ‰å…³åˆ é™¤æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```