import Npm from '@components/markdown/Npm.astro';
import Callout from '@components/markdown/Callout.astro';
import Tabs from '@components/markdown/Tabs.astro';
import Tab from '@components/markdown/Tab.astro';
import AnchorCards from '@components/markdown/AnchorCards.astro';

<AnchorCards cards={{
  "PlanetScale": "#planetscale",
  "mysql2": "#mysql-2",
  "TiDB Serverless": "#tidb-serverless",
  "HTTP proxy": "#http-proxy"
}} />

## PlanetScale

æ ¹æ®å…¶ [å®˜æ–¹ç½‘ç«™](https://planetscale.com/) æè¿°ï¼Œ
PlanetScale æ˜¯ä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„æ— æœåŠ¡å™¨ MySQL å¹³å°ã€‚

æœ‰äº† Drizzle ORMï¼Œæ‚¨å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ `drizzle-orm/planetscale-serverless` è½¯ä»¶åŒ…ï¼Œé€šè¿‡å…¶å®˜æ–¹ [`database-js`](https://github.com/planetscale/database-js) é©±åŠ¨ç¨‹åºï¼Œåœ¨æ— æœåŠ¡å™¨å’Œæœ‰æœåŠ¡å™¨ç¯å¢ƒä¸­é€šè¿‡ http è®¿é—® PlanetScaleã€‚

ä½ è¿˜å¯ä»¥é€šè¿‡ `mysql2` é©±åŠ¨é€šè¿‡ TCP è¿æ¥åˆ° PlanetScaleï¼Œè¯·å‚é˜… [MySQL 2 æ–‡æ¡£](/docs/get-started-mysql#mysql-2)ã€‚

<Npm>
drizzle-orm @planetscale/database
-D drizzle-kit
</Npm>

```typescript copy filename="index.ts"
import { drizzle } from "drizzle-orm/planetscale-serverless";
import { Client } from "@planetscale/database";

const client = new Client({
  host: process.env["DATABASE_HOST"],
  username: process.env["DATABASE_USERNAME"],
  password: process.env["DATABASE_PASSWORD"],
});

const db = drizzle(client);
```

<Callout type="warning" emoji="âš ï¸">
ä»¥å‰ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ `database-js` é©±åŠ¨çš„ `connect()` å‡½æ•°ã€‚ç„¶è€Œï¼Œåœ¨æ¥æ”¶åˆ° PlanetScale å›¢é˜Ÿå’Œ database-js çš„ä½œè€…çš„å»ºè®®åï¼Œæˆ‘ä»¬ç°åœ¨å¼ºåˆ¶ä½¿ç”¨ `Client` å®ä¾‹æ¥å¤„ç†ä¸ PlanetScale çš„è¿æ¥ã€‚

è¯·æ³¨æ„ï¼Œä½ å°†æ”¶åˆ°ä¸€ä¸ªè­¦å‘Šï¼Œè¦æ±‚ä» `connect()` åˆ‡æ¢åˆ° `new Client()`ã€‚ä»ç‰ˆæœ¬ `0.30.0` å¼€å§‹ï¼Œä½ å°†é‡åˆ°é”™è¯¯ï¼Œå¹¶éœ€è¦ä½¿ç”¨ `Client` è¿æ¥ã€‚ç¡®ä¿ä» `connect()` è¿ç§»åˆ° `Client`ã€‚
</Callout>

è¯·åŠ¡å¿…æŸ¥çœ‹ PlanetScale å®˜æ–¹çš„ [MySQL è¯¾ç¨‹](https://planetscale.com/courses/mysql-for-developers/introduction/course-introduction)
ï¼Œæˆ‘ä»¬è®¤ä¸ºå®ƒä»¬éå¸¸å‡ºè‰² ğŸ™Œ

## mysql2

æ ¹æ®å…¶ [å®˜æ–¹ç½‘ç«™](https://github.com/sidorares/node-mysql2) æè¿°ï¼Œ`mysql2` æ˜¯ä¸€ä¸ªä¸“æ³¨äºæ€§èƒ½çš„ Node.js MySQL å®¢æˆ·ç«¯ã€‚

Drizzle ORM ä½¿ç”¨ `drizzle-orm/mysql2` åŒ…åŸç”Ÿæ”¯æŒ `mysql2`ã€‚

<Npm>
drizzle-orm mysql2
-D drizzle-kit
</Npm>

ä½ å¯ä»¥ä½¿ç”¨ `mysql2` é©±åŠ¨è¿æ¥åˆ° MySQLï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œå•ä¸ª `client` è¿æ¥æˆ–è€…ä¸€ä¸ª `pool`ã€‚

<Tabs items={['Client connection', 'Pool connection']}>
  <Tab>
  ```typescript copy filename="index.ts"
  import { drizzle } from "drizzle-orm/mysql2";
  import mysql from "mysql2/promise";

  const connection = await mysql.createConnection({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle(connection);
  ```
  </Tab>

  <Tab>
  ```typescript copy filename="index.ts"
  import { drizzle } from "drizzle-orm/mysql2";
  import mysql from "mysql2/promise";

  const poolConnection = mysql.createPool({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle(poolConnection);
  ```
  </Tab>
</Tabs>

<Callout type="warning" emoji="âš™ï¸">
å¯¹äºå¸¦æœ‰ DDL è¿ç§»çš„å†…ç½® `migrate()` å‡½æ•°ï¼Œæˆ‘ä»¬å’Œé©±åŠ¨ç¨‹åºå¼ºçƒˆå»ºè®®ä½¿ç”¨å•ä¸ª `client` è¿æ¥è¿æ¥åˆ° MySQLã€‚

å¯¹äºæŸ¥è¯¢ç›®çš„ï¼Œè¯·æ ¹æ®ä¸šåŠ¡éœ€æ±‚éšæ„ä½¿ç”¨ `client` æˆ– `pool`ã€‚
</Callout>

## TiDB Serverless

According to the **[official website](https://www.pingcap.com/tidb-serverless/)**, 
TiDB Serverless is a fully-managed, autonomous DBaaS with split-second cluster provisioning and consumption-based pricing.

<Callout type="info" emoji="â„¹ï¸">
TiDB Serverless is compatible with MySQL, so you can use [`drizzle-orm/mysql2`](#mysql2) to connect to it.
</Callout>

TiDB Serverless provides an [HTTP driver](https://docs.pingcap.com/tidbcloud/serverless-driver) for edge environments. It is natively supported by Drizzle ORM via `drizzle-orm/tidb-serverless` package.

<Npm>
drizzle-orm @tidbcloud/serverless
-D drizzle-kit
</Npm>

```typescript copy filename="index.ts"
import { connect } from '@tidbcloud/serverless';
import { drizzle } from 'drizzle-orm/tidb-serverless';

const client = connect({ url: '...' });
const db = drizzle(client);
```

## HTTP ä»£ç†

é©±åŠ¨å®ç°ç¤ºä¾‹

```typescript copy
import { drizzle } from 'drizzle-orm/mysql-proxy';

const db = drizzle(async (sql, params, method) => {
  try {
    const rows = await axios.post('http://localhost:3000/query', { sql, params, method });

    return { rows: rows.data };
  } catch (e: any) {
    console.error('Error from mysql proxy server: ', e.response.data)
    return { rows: [] };
  }
});
```

æœåŠ¡å™¨å®ç°ç¤ºä¾‹

```ts
import * as mysql from 'mysql2/promise';
import express from 'express';

const app = express();

app.use(express.json());
const port = 3000;

const main = async () => {
    const connection = await mysql.createConnection('mysql://root:mysql@127.0.0.1:5432/drizzle');

    app.post('/query', async (req, res) => {
    	const { sql, params, method } = req.body;

      // prevent multiple queries
    	const sqlBody = sql.replace(/;/g, '');

      try {
            const result = await connection.query({
                sql: sqlBody,
                values: params,
                rowsAsArray: method === 'all',
                typeCast: function(field: any, next: any) {
                    if (field.type === 'TIMESTAMP' || field.type === 'DATETIME' || field.type === 'DATE') {
                        return field.string();
                    }
                    return next();
                },
            });
    	} catch (e: any) {
    		res.status(500).json({ error: e });
    	}

    	if (method === 'all') {
    		res.send(result[0]);
    	} else if (method === 'execute') {
    		res.send(result);
    	}
    	res.status(500).json({ error: 'Unknown method value' });
    });

    app.listen(port, () => {
    	console.log(`Example app listening on port ${port}`);
    });
}

main();
```
