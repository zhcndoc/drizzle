---
title: DrizzleORM v0.29.0 å‘å¸ƒ
pubDate: 2023-11-09
description: æ·»åŠ äº†æ–°åŠŸèƒ½ï¼Œå¦‚ MySQL ä¸­ bigint çš„æ— ç¬¦å·é€‰é¡¹ï¼Œæ”¹è¿›äº†æŸ¥è¯¢æ„å»ºå™¨ç±»å‹ï¼Œæ·»åŠ äº†æŒ‡å®šä¸»é”®å’Œå¤–é”®åç§°çš„å¯èƒ½æ€§ï¼Œæ”¯æŒè¯»å–å‰¯æœ¬ï¼Œæ”¯æŒé›†åˆè¿ç®—ç¬¦ï¼Œæ–°çš„ MySQL å’Œ PostgreSQL ä»£ç†é©±åŠ¨ï¼Œæ”¯æŒ D1 æ‰¹å¤„ç† APIã€‚
---
import Section from "@mdx/Section.astro";

> Drizzle ORM ç‰ˆæœ¬ `0.29.0` å°†éœ€è¦æœ€ä½ Drizzle Kit ç‰ˆæœ¬ä¸º `0.20.0`ï¼Œåä¹‹äº¦ç„¶ã€‚å› æ­¤ï¼Œå½“å‡çº§åˆ°è¾ƒæ–°çš„ Drizzle ORM ç‰ˆæœ¬æ—¶ï¼Œæ‚¨ä¹Ÿéœ€è¦å‡çº§ Drizzle Kitã€‚è¿™å¯èƒ½å¯¼è‡´ç‰ˆæœ¬ä¹‹é—´çš„ä¸€äº›ç ´åæ€§æ›´æ”¹ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ‚¨éœ€è¦å‡çº§ Drizzle Kit è€Œæ‚¨çš„ Drizzle ORM ç‰ˆæœ¬æ—©äº `<0.28.0`ã€‚

## æ–°åŠŸèƒ½

### ğŸ‰ MySQL `unsigned` é€‰é¡¹ç”¨äº bigint

ç°åœ¨æ‚¨å¯ä»¥æŒ‡å®š `bigint unsigned` ç±»å‹ã€‚

```ts copy {2}
const table = mysqlTable('table', {
  id: bigint('id', { mode: 'number', unsigned: true }),
});
```

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/column-types/mysql#bigint)ã€‚

### ğŸ‰ æ”¹è¿›çš„æŸ¥è¯¢æ„å»ºå™¨ç±»å‹

ä» `0.29.0` å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”±äº Drizzle ä¸­æ‰€æœ‰æŸ¥è¯¢æ„å»ºå™¨å°½é‡éµå¾ª SQLï¼Œæ‚¨åªèƒ½è°ƒç”¨å¤§å¤šæ•°æ–¹æ³•ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ SELECT è¯­å¥ä¸­å¯èƒ½åªæœ‰ä¸€ä¸ª WHERE å­å¥ï¼Œå› æ­¤æ‚¨åªèƒ½è°ƒç”¨ .where() ä¸€æ¬¡ï¼š

```ts copy {5}
const query = db
  .select()
  .from(users)
  .where(eq(users.id, 1))
  .where(eq(users.name, 'John')); // âŒ ç±»å‹é”™è¯¯ - where() åªèƒ½è°ƒç”¨ä¸€æ¬¡
```

è¿™ç§è¡Œä¸ºå¯¹äºå¸¸è§„çš„æŸ¥è¯¢æ„å»ºå¾ˆæœ‰ç”¨ï¼Œå³å½“æ‚¨ä¸€æ¬¡åˆ›å»ºæ•´ä¸ªæŸ¥è¯¢æ—¶ã€‚ç„¶è€Œï¼Œå½“æ‚¨æƒ³åŠ¨æ€æ„å»ºæŸ¥è¯¢æ—¶ï¼Œè¿™å°±æˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œå³å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå…±äº«å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªæŸ¥è¯¢æ„å»ºå™¨å¹¶å¢å¼ºå®ƒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDrizzle ä¸ºæŸ¥è¯¢æ„å»ºå™¨æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„â€œåŠ¨æ€â€æ¨¡å¼ï¼Œç§»é™¤äº†ä»…è°ƒç”¨æ–¹æ³•ä¸€æ¬¡çš„é™åˆ¶ã€‚è¦å¯ç”¨å®ƒï¼Œæ‚¨éœ€è¦åœ¨æŸ¥è¯¢æ„å»ºå™¨ä¸Šè°ƒç”¨ .$dynamic()ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„ withPagination å‡½æ•°æ¥å·¥ä½œï¼Œè¯¥å‡½æ•°æ ¹æ®æä¾›çš„é¡µç å’Œå¯é€‰çš„é¡µé¢å¤§å°å‘æŸ¥è¯¢æ·»åŠ  LIMIT å’Œ OFFSET å­å¥ï¼š

```ts copy {12,13}
function withPagination<T extends PgSelect>(
  qb: T,
  page: number,
  pageSize: number = 10,
) {
  return qb.limit(pageSize).offset(page * pageSize);
}

const query = db.select().from(users).where(eq(users.id, 1));
withPagination(query, 1); // âŒ ç±»å‹é”™è¯¯ - æŸ¥è¯¢æ„å»ºå™¨ä¸åœ¨åŠ¨æ€æ¨¡å¼

const dynamicQuery = query.$dynamic();
withPagination(dynamicQuery, 1); // âœ… OK
```

è¯·æ³¨æ„ withPagination å‡½æ•°æ˜¯æ³›å‹çš„ï¼Œè¿™å…è®¸æ‚¨åœ¨å…¶ä¸­ä¿®æ”¹æŸ¥è¯¢æ„å»ºå™¨çš„ç»“æœç±»å‹ï¼Œä¾‹å¦‚é€šè¿‡æ·»åŠ è”æ¥ï¼š

```ts copy {2}
function withFriends<T extends PgSelect>(qb: T) {
  return qb.leftJoin(friends, eq(friends.userId, users.id));
}

let query = db.select().from(users).where(eq(users.id, 1)).$dynamic();
query = withFriends(query);
```

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/dynamic-query-building)ã€‚

### ğŸ‰ æŒ‡å®šä¸»é”®å’Œå¤–é”®åç§°çš„å¯èƒ½æ€§

å½“çº¦æŸåç§°è¶…è¿‡æ•°æ®åº“çš„ 64 ä¸ªå­—ç¬¦é™åˆ¶æ—¶ï¼Œä¼šå‡ºç°é—®é¢˜ã€‚è¿™ä¼šå¯¼è‡´æ•°æ®åº“å¼•æ“æˆªæ–­åç§°ï¼Œä»è€Œå¯èƒ½å¯¼è‡´é—®é¢˜ã€‚ä» `0.29.0` å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä¸º `primaryKey()` å’Œ `foreignKey()` æŒ‡å®šè‡ªå®šä¹‰åç§°ã€‚æˆ‘ä»¬è¿˜å¼ƒç”¨äº†æ—§çš„ `primaryKey()` è¯­æ³•ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œä½†å°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚

```ts copy {5,7}
const table = pgTable('table', {
  id: integer('id'),
  name: text('name'),
}, (table) => ({
  cpk: primaryKey({ name: 'composite_key', columns: [table.id, table.name] }),
  cfk: foreignKey({
    name: 'fkName',
    columns: [table.id],
    foreignColumns: [table.name],
  }),
}));
```

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/indexes-constraints#composite-primary-key)ã€‚

### ğŸ‰ è¯»å–å‰¯æœ¬æ”¯æŒ

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ Drizzle çš„ `withReplica` å‡½æ•°ä¸ºè¯»å–å‰¯æœ¬å’Œè¿›è¡Œå†™æ“ä½œçš„ä¸»å®ä¾‹æŒ‡å®šä¸åŒçš„æ•°æ®åº“è¿æ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`withReplicas` å°†åœ¨è¯»å–æ“ä½œä¸­ä½¿ç”¨éšæœºçš„è¯»å–å‰¯æœ¬ï¼Œåœ¨æ‰€æœ‰å…¶ä»–æ•°æ®ä¿®æ”¹æ“ä½œä¸­ä½¿ç”¨ä¸»å®ä¾‹ã€‚æ‚¨è¿˜å¯ä»¥æŒ‡å®šè‡ªå®šä¹‰é€»è¾‘ä»¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªè¯»å–å‰¯æœ¬è¿æ¥ã€‚æ‚¨å¯ä»¥è‡ªç”±åšå‡ºä»»ä½•åŠ æƒçš„è‡ªå®šä¹‰å†³ç­–ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ç”¨æ³•ç¤ºä¾‹ï¼š

```ts copy {5}
const primaryDb = drizzle({ client });
const read1 = drizzle({ client });
const read2 = drizzle({ client });

const db = withReplicas(primaryDb, [read1, read2]);

// ä»ä¸»æ•°æ®åº“è¯»å–
db.$primary.select().from(usersTable);

// ä» read1 æˆ– read2 è¿æ¥è¯»å–
db.select().from(usersTable)

// ä½¿ç”¨ä¸»æ•°æ®åº“è¿›è¡Œåˆ é™¤æ“ä½œ
db.delete(usersTable).where(eq(usersTable.id, 1))
```

é€‰æ‹©è¯»å–å‰¯æœ¬çš„è‡ªå®šä¹‰é€»è¾‘çš„å®ç°ç¤ºä¾‹ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‰¯æœ¬æœ‰ 70% çš„æœºä¼šè¢«é€‰æ‹©ï¼Œç¬¬äºŒä¸ªå‰¯æœ¬æœ‰ 30% çš„æœºä¼šè¢«é€‰æ‹©ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥å®ç°ä»»ä½•ç±»å‹çš„éšæœºé€‰æ‹©ä»¥é€‰æ‹©è¯»å–å‰¯æœ¬ã€‚

```ts copy
const db = withReplicas(primaryDb, [read1, read2], (replicas) => {
    const weight = [0.7, 0.3];
    let cumulativeProbability = 0;
    const rand = Math.random();

    for (const [i, replica] of replicas.entries()) {
      cumulativeProbability += weight[i]!;
      if (rand < cumulativeProbability) return replica;
    }
    return replicas[0]!;
});
```

`withReplicas` å‡½æ•°åœ¨ Drizzle ORM çš„æ‰€æœ‰æ–¹è¨€ä¸­å¯ç”¨ã€‚

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/read-replicas)ã€‚

### ğŸ‰ æ”¯æŒé›†åˆè¿ç®—ç¬¦ (UNION, UNION ALL, INTERSECT, INTERSECT ALL, EXCEPT, EXCEPT ALL)

ç‰¹åˆ«æ„Ÿè°¢ @Angelelz è¿›è¡Œçš„é‡å¤§è´¡çŒ®ï¼Œä» API è®¨è®ºåˆ°æ­£ç¡®çš„ç±»å‹æ£€æŸ¥å’Œè¿è¡Œæ—¶é€»è¾‘ï¼Œä»¥åŠä¸€ç»„å…¨é¢çš„æµ‹è¯•ã€‚è¿™æå¤§åœ°å¸®åŠ©æˆ‘ä»¬åœ¨æ­¤ç‰ˆæœ¬ä¸­äº¤ä»˜æ­¤åŠŸèƒ½ã€‚

ç”¨æ³•ç¤ºä¾‹ï¼š
æ‰€æœ‰é›†åˆè¿ç®—ç¬¦å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ä½¿ç”¨ï¼š`å¯¼å…¥æ–¹å¼` æˆ– `æ„å»ºå™¨æ–¹å¼`ã€‚

<Section>
```ts copy {2,7}
// å¯¼å…¥æ–¹å¼
import { union } from 'drizzle-orm/pg-core'

const allUsersQuery = db.select().from(users);
const allCustomersQuery = db.select().from(customers);

const result = await union(allUsersQuery, allCustomersQuery);
```

```ts copy {2}
// æ„å»ºå™¨æ–¹å¼
const result = await db.select().from(users).union(db.select().from(customers));
```
</Section>

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/set-operations)ã€‚

### ğŸ‰ æ–°çš„ MySQL ä»£ç†é©±åŠ¨

å·²å‘å¸ƒæ–°çš„é©±åŠ¨ç¨‹åºï¼Œå…è®¸æ‚¨ä½¿ç”¨ MySQL æ•°æ®åº“åˆ›å»ºè‡ªå·±çš„ HTTP é©±åŠ¨ç¨‹åºå®ç°ã€‚æ‚¨å¯ä»¥åœ¨ `./examples/mysql-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç”¨æ³•ç¤ºä¾‹ã€‚

æ‚¨éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®ç°ä¸¤ä¸ªç«¯ç‚¹ï¼Œè¿™äº›ç«¯ç‚¹å°†ç”¨äºæŸ¥è¯¢å’Œè¿ç§»ï¼ˆè¿ç§»ç«¯ç‚¹æ˜¯å¯é€‰çš„ï¼Œä»…åœ¨æ‚¨å¸Œæœ›ä½¿ç”¨ Drizzle è¿ç§»æ—¶ï¼‰ã€‚æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºçš„å®ç°ç”±æ‚¨å†³å®šï¼Œå› æ­¤æ‚¨æ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚æ‚¨å¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ˜ å°„ã€æ—¥å¿—è®°å½•ç­‰ã€‚

æ‚¨å¯ä»¥åœ¨ `./examples/mysql-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºçš„å®ç°ç¤ºä¾‹ã€‚

```ts copy {4,9}
// é©±åŠ¨
import axios from 'axios';
import { eq } from 'drizzle-orm/expressions';
import { drizzle } from 'drizzle-orm/mysql-proxy';
import { migrate } from 'drizzle-orm/mysql-proxy/migrator';
import { cities, users } from './schema';

async function main() {
  const db = drizzle(async (sql, params, method) => {
    try {
      const rows = await axios.post(`${process.env.REMOTE_DRIVER}/query`, {
        sql,
        params,
        method,
      });

      return { rows: rows.data };
    } catch (e: any) {
      console.error('æ¥è‡ª pg ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯:', e.response.data);
      return { rows: [] };
    }
  });

  await migrate(db, async (queries) => {
    try {
      await axios.post(`${process.env.REMOTE_DRIVER}/migrate`, { queries });
    } catch (e) {
      console.log(e);
      throw new Error('ä»£ç†æœåŠ¡å™¨æ— æ³•è¿›è¡Œè¿ç§»');
    }
  }, { migrationsFolder: 'drizzle' });

  await db.insert(cities).values({ id: 1, name: 'name' });

  await db.insert(users).values({
    id: 1,
    name: 'name',
    email: 'email',
    cityId: 1,
  });

  const usersToCityResponse = await db.select().from(users).leftJoin(
    cities,
    eq(users.cityId, cities.id),
  );
}
```

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/get-started-mysql#http-proxy)ã€‚

### ğŸ‰ æ–°çš„ PostgreSQL ä»£ç†é©±åŠ¨

ä¸ MySQL ä¸€æ ·ï¼Œæ‚¨ç°åœ¨å¯ä»¥ä¸º PostgreSQL æ•°æ®åº“å®ç°è‡ªå·±çš„ http é©±åŠ¨ç¨‹åºã€‚æ‚¨å¯ä»¥åœ¨ `./examples/pg-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç”¨æ³•ç¤ºä¾‹ã€‚

æ‚¨éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®ç°ä¸¤ä¸ªç«¯ç‚¹ï¼Œè¿™äº›ç«¯ç‚¹å°†ç”¨äºæŸ¥è¯¢å’Œè¿ç§»ï¼ˆè¿ç§»ç«¯ç‚¹æ˜¯å¯é€‰çš„ï¼Œä»…åœ¨æ‚¨å¸Œæœ›ä½¿ç”¨ Drizzle è¿ç§»æ—¶ï¼‰ã€‚æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºçš„å®ç°ç”±æ‚¨å†³å®šï¼Œå› æ­¤æ‚¨æ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚æ‚¨å¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ˜ å°„ã€æ—¥å¿—è®°å½•ç­‰ã€‚

æ‚¨å¯ä»¥åœ¨ `./examples/pg-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºçš„å®ç°ç¤ºä¾‹ã€‚

```ts copy {3,8}
import axios from 'axios';
import { eq } from 'drizzle-orm/expressions';
import { drizzle } from 'drizzle-orm/pg-proxy';
import { migrate } from 'drizzle-orm/pg-proxy/migrator';
import { cities, users } from './schema';

async function main() {
  const db = drizzle(async (sql, params, method) => {
    try {
      const rows = await axios.post(`${process.env.REMOTE_DRIVER}/query`, { sql, params, method });

      return { rows: rows.data };
    } catch (e: any) {
      console.error('æ¥è‡ª pg ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯:', e.response.data);
      return { rows: [] };
    }
  });

  await migrate(db, async (queries) => {
    try {
      await axios.post(`${process.env.REMOTE_DRIVER}/query`, { queries });
    } catch (e) {
      console.log(e);
      throw new Error('ä»£ç†æœåŠ¡å™¨æ— æ³•è¿›è¡Œè¿ç§»');
    }
  }, { migrationsFolder: 'drizzle' });

  const insertedCity = await db.insert(cities).values({ id: 1, name: 'name' }).returning();
  const insertedUser = await db.insert(users).values({ id: 1, name: 'name', email: 'email', cityId: 1 });
  const usersToCityResponse = await db.select().from(users).leftJoin(cities, eq(users.cityId, cities.id));
}
```

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [docs](/docs/get-started-postgresql#http-proxy)ã€‚

### ğŸ‰ `D1` æ‰¹å¤„ç† API æ”¯æŒ

å‚è€ƒï¼š https://developers.cloudflare.com/d1/platform/client-api/#dbbatch

æ‰¹å¤„ç† API ç”¨æ³•ç¤ºä¾‹ï¼š

<Section>
```ts copy {1}
const batchResponse = await db.batch([
  db.insert(usersTable).values({ id: 1, name: 'John' }).returning({
    id: usersTable.id,
  }),
  db.update(usersTable).set({ name: 'Dan' }).where(eq(usersTable.id, 1)),
  db.query.usersTable.findMany({}),
  db.select().from(usersTable).where(eq(usersTable.id, 1)),
  db.select({ id: usersTable.id, invitedBy: usersTable.invitedBy }).from(
    usersTable,
  ),
]);
```

```ts
type BatchResponse = [
  {
    id: number;
  }[],
  D1Result,
  {
    id: number;
    name: string;
    verified: number;
    invitedBy: number | null;
  }[],
  {
    id: number;
    name: string;
    verified: number;
    invitedBy: number | null;
  }[],
  {
    id: number;
    invitedBy: number | null;
  }[],
];
```
</Section>

æ‰€æœ‰å¯ä»¥åœ¨ `db.batch` å†…éƒ¨ä½¿ç”¨çš„æ„å»ºå™¨ï¼š

```ts
`db.all()`,
`db.get()`,
`db.values()`,
`db.run()`,
`db.query.<table>.findMany()`,
`db.query.<table>.findFirst()`,
`db.select()...`,
`db.update()...`,
`db.delete()...`,
`db.insert()...`,
```

æ›´å¤šç”¨æ³•ç¤ºä¾‹è¯·è§ï¼š [integration-tests/tests/d1-batch.test.ts](https://github.com/drizzle-team/drizzle-orm/blob/beta/integration-tests/tests/d1-batch.test.ts) å’Œ [docs](/docs/batch-api)ã€‚

---
## Drizzle Kit 0.20.0

1. ä½¿ç”¨ `defineConfig` å‡½æ•°å®šä¹‰ drizzle.config çš„æ–°æ–¹å¼
2. ä½¿ç”¨ wrangler.toml æ–‡ä»¶é€šè¿‡ Drizzle Studio è®¿é—® Cloudflare D1 çš„å¯èƒ½æ€§
3. Drizzle Studio æ­£åœ¨è¿ç§»è‡³ https://local.drizzle.studio/
4. `bigint unsigned` æ”¯æŒ
5. `primaryKeys` å’Œ `foreignKeys` ç°åœ¨å¯ä»¥å…·æœ‰è‡ªå®šä¹‰åç§°
6. ç¯å¢ƒå˜é‡ç°åœ¨è‡ªåŠ¨è·å–
7. ä¸€äº› bug ä¿®å¤å’Œæ”¹è¿›

æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ](https://github.com/drizzle-team/drizzle-kit-mirror/releases/tag/v0.20.0) é˜…è¯»æœ‰å…³ drizzle-kit æ›´æ–°çš„æ›´å¤šä¿¡æ¯ã€‚
