---
title: DrizzleORM v0.29.0 å‘å¸ƒ
pubDate: 2023-11-09
description: æ–°å¢äº†ä¸€äº›åŠŸèƒ½ï¼Œå¦‚ MySQL ä¸­ bigint çš„ unsigned é€‰é¡¹ï¼Œæ”¹è¿›äº†æŸ¥è¯¢æ„å»ºå™¨ç±»å‹çš„æ”¯æŒï¼Œæ–°å¢äº†æŒ‡å®šä¸»é”®å’Œå¤–é”®çš„åç§°çš„å¯èƒ½æ€§ï¼Œæ”¯æŒè¯»å‰¯æœ¬ï¼Œæ”¯æŒé›†åˆæ“ä½œç¬¦ï¼Œæ–°çš„ MySQL å’Œ PostgreSQL ä»£ç†é©±åŠ¨ç¨‹åºï¼ŒD1 æ‰¹å¤„ç† API æ”¯æŒã€‚
---
import Section from "@mdx/Section.astro";

> Drizzle ORM ç‰ˆæœ¬ `0.29.0` å°†éœ€è¦æœ€ä½ Drizzle Kit ç‰ˆæœ¬ä¸º `0.20.0` ï¼Œåä¹‹äº¦ç„¶ã€‚å› æ­¤ï¼Œå½“å‡çº§åˆ°æ›´æ–°ç‰ˆæœ¬çš„ Drizzle ORM æ—¶ï¼Œæ‚¨ä¹Ÿéœ€è¦å‡çº§ Drizzle Kitã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´åœ¨ç‰ˆæœ¬ä¹‹é—´äº§ç”Ÿä¸€äº›ç ´åæ€§å˜åŒ–ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ‚¨éœ€è¦å‡çº§ Drizzle Kitï¼Œè€Œæ‚¨çš„ Drizzle ORM ç‰ˆæœ¬æ—§äº `<0.28.0`

## æ–°åŠŸèƒ½

### ğŸ‰ MySQL çš„ `unsigned` é€‰é¡¹æ”¯æŒ bigint

ç°åœ¨æ‚¨å¯ä»¥æŒ‡å®š `bigint unsigned` ç±»å‹

```ts copy {2}
const table = mysqlTable('table', {
  id: bigint('id', { mode: 'number', unsigned: true }),
});
```

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/column-types/mysql#bigint) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ æ”¹è¿›çš„æŸ¥è¯¢æ„å»ºå™¨ç±»å‹æ”¯æŒ

ä» `0.29.0` å¼€å§‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç”±äº Drizzle ä¸­çš„æ‰€æœ‰æŸ¥è¯¢æ„å»ºå™¨å°½å¯èƒ½ç¬¦åˆ SQLï¼Œæ‚¨åªèƒ½è°ƒç”¨å¤§å¤šæ•°æ–¹æ³•ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ SELECT è¯­å¥ä¸­å¯èƒ½åªæœ‰ä¸€ä¸ª WHERE å­å¥ï¼Œå› æ­¤åªèƒ½è°ƒç”¨ .where() ä¸€æ¬¡ï¼š

```ts copy {5}
const query = db
  .select()
  .from(users)
  .where(eq(users.id, 1))
  .where(eq(users.name, 'John')); // âŒ ç±»å‹é”™è¯¯ - åªèƒ½è°ƒç”¨ where() ä¸€æ¬¡
```

è¿™ä¸ªè¡Œä¸ºå¯¹äºä¼ ç»Ÿçš„æŸ¥è¯¢æ„å»ºå¾ˆæœ‰ç”¨ï¼Œå³ä¸€æ¬¡åˆ›å»ºæ•´ä¸ªæŸ¥è¯¢ã€‚ç„¶è€Œï¼Œåœ¨æ‚¨æƒ³åŠ¨æ€æ„å»ºæŸ¥è¯¢æ—¶ï¼Œå®ƒå°±æˆä¸ºä¸€ä¸ªé—®é¢˜ï¼Œå³å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå…±äº«å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªæŸ¥è¯¢æ„å»ºå™¨å¹¶å¢å¼ºå®ƒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDrizzle æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„ 'dynamic' æ¨¡å¼çš„æŸ¥è¯¢æ„å»ºå™¨ï¼Œå®ƒåˆ é™¤äº†ä»…èƒ½è°ƒç”¨æ–¹æ³•ä¸€æ¬¡çš„é™åˆ¶ã€‚è¦å¯ç”¨å®ƒï¼Œæ‚¨éœ€è¦åœ¨æŸ¥è¯¢æ„å»ºå™¨ä¸Šè°ƒç”¨ .$dynamic() æ–¹æ³•ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œé€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„ withPagination å‡½æ•°ï¼Œæ ¹æ®æä¾›çš„é¡µç å’Œå¯é€‰çš„é¡µé¢å¤§å°æ·»åŠ  LIMIT å’Œ OFFSET å­å¥åˆ°æŸ¥è¯¢ä¸­ï¼š

```ts copy {12,13}
function withPagination<T extends PgSelect>(
  qb: T,
  page: number,
  pageSize: number = 10,
) {
  return qb.limit(pageSize).offset(page * pageSize);
}

const query = db.select().from(users).where(eq(users.id, 1));
withPagination(query, 1); // âŒ ç±»å‹é”™è¯¯ - æŸ¥è¯¢æ„å»ºå™¨ä¸å¤„äºåŠ¨æ€æ¨¡å¼ä¸‹

const dynamicQuery = query.$dynamic();
withPagination(dynamicQuery, 1); // âœ… æ­£å¸¸
```

è¯·æ³¨æ„ï¼ŒwithPagination å‡½æ•°æ˜¯æ³›å‹çš„ï¼Œè¿™å…è®¸æ‚¨åœ¨å…¶ä¸­ä¿®æ”¹æŸ¥è¯¢æ„å»ºå™¨çš„ç»“æœç±»å‹ï¼Œä¾‹å¦‚é€šè¿‡æ·»åŠ  join:

```ts copy {2}
function withFriends<T extends PgSelect>(qb: T) {
  return qb.leftJoin(friends, eq(friends.userId, users.id));
}

let query = db.select().from(users).where(eq(users.id, 1)).$dynamic();
query = withFriends(query);
```

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/dynamic-query-building) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ å¯ä»¥æŒ‡å®šä¸»é”®å’Œå¤–é”®çš„åç§°

å½“çº¦æŸåè¶…è¿‡æ•°æ®åº“çš„ 64 ä¸ªå­—ç¬¦çš„é™åˆ¶æ—¶ï¼Œä¼šå‡ºç°é—®é¢˜ã€‚è¿™å¯¼è‡´æ•°æ®åº“å¼•æ“æˆªæ–­åç§°ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚ä» `0.29.0` å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä¸º `primaryKey()` å’Œ `foreignKey()` æŒ‡å®šè‡ªå®šä¹‰åç§°çš„é€‰é¡¹ã€‚æˆ‘ä»¬è¿˜å·²ç»å¼ƒç”¨äº†æ—§çš„ `primaryKey()` è¯­æ³•ï¼Œä½†ä»å¯ä½¿ç”¨ï¼Œä½†åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­å°†ä¼šè¢«åˆ é™¤

```ts copy {5,7}
const table = pgTable('table', {
  id: integer('id'),
  name: text('name'),
}, (table) => ({
  cpk: primaryKey({ name: 'composite_key', columns: [table.id, table.name] }),
  cfk: foreignKey({
    name: 'fkName',
    columns: [table.id],
    foreignColumns: [table.name],
  }),
}));
```

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/indexes-constraints#composite-primary-key) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ æ”¯æŒè¯»å‰¯æœ¬

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ Drizzle çš„ `withReplica` å‡½æ•°æ¥ä¸ºè¯»å‰¯æœ¬å’Œä¸»å®ä¾‹æŒ‡å®šä¸åŒçš„æ•°æ®åº“è¿æ¥ï¼Œä»¥è¿›è¡Œå†™æ“ä½œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`withReplicas` å°†åœ¨è¯»æ“ä½œä¸­ä½¿ç”¨éšæœºè¯»å‰¯æœ¬ï¼Œå¹¶åœ¨æ‰€æœ‰å…¶ä»–æ•°æ®ä¿®æ”¹æ“ä½œä¸­ä½¿ç”¨ä¸»å®ä¾‹ã€‚æ‚¨è¿˜å¯ä»¥æŒ‡å®šç”¨äºé€‰æ‹©è¦ä½¿ç”¨çš„è¯»å‰¯æœ¬è¿æ¥çš„è‡ªå®šä¹‰é€»è¾‘ã€‚æ‚¨å¯ä»¥è‡ªç”±åœ°è¿›è¡Œä»»ä½•åŠ æƒçš„è‡ªå®šä¹‰å†³ç­–ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä½¿ç”¨ç¤ºä¾‹ï¼š

```ts copy {5}
const primaryDb = drizzle(client);
const read1 = drizzle(client);
const read2 = drizzle(client);

const db = withReplicas(primaryDb, [read1, read2]);

// ä»ä¸»å®ä¾‹è¯»å–
db.$primary.select().from(usersTable);

// ä» read1 è¿æ¥æˆ– read2 è¿æ¥è¯»å–
db.select().from(usersTable)

// ä½¿ç”¨ä¸»æ•°æ®åº“è¿›è¡Œåˆ é™¤æ“ä½œ
db.delete(usersTable).where(eq(usersTable.id, 1))
```

é€‰æ‹©è¯»å‰¯æœ¬çš„è‡ªå®šä¹‰é€»è¾‘çš„å®ç°ç¤ºä¾‹ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªè¯»å‰¯æœ¬æœ‰ 70% çš„è¢«é€‰ä¸­çš„æ¦‚ç‡ï¼Œç¬¬äºŒä¸ªè¯»å‰¯æœ¬æœ‰ 30% çš„è¢«é€‰ä¸­çš„æ¦‚ç‡ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥ä¸ºè¯»å‰¯æœ¬å®ç°ä»»ä½•ç±»å‹çš„éšæœºé€‰æ‹©

```ts copy
const db = withReplicas(primaryDb, [read1, read2], (replicas) => {
    const weight = [0.7, 0.3];
    let cumulativeProbability = 0;
    const rand = Math.random();

    for (const [i, replica] of replicas.entries()) {
      cumulativeProbability += weight[i]!;
      if (rand < cumulativeProbability) return replica;
    }
    return replicas[0]!
});
```

`withReplicas` å‡½æ•°åœ¨ Drizzle ORM çš„æ‰€æœ‰æ–¹è¨€ä¸­éƒ½å¯ç”¨

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/read-replicas) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ æ”¯æŒé›†åˆæ“ä½œç¬¦ï¼ˆUNION, UNION ALL, INTERSECT, INTERSECT ALL, EXCEPT, EXCEPT ALLï¼‰

éå¸¸æ„Ÿè°¢ @Angelelz çš„é‡è¦è´¡çŒ®ï¼Œä» API è®¨è®ºåˆ°æ­£ç¡®çš„ç±»å‹æ£€æŸ¥å’Œè¿è¡Œæ—¶é€»è¾‘ï¼Œä»¥åŠå¤§é‡çš„æµ‹è¯•ã€‚è¿™å¤§å¤§å¸®åŠ©æˆ‘ä»¬åœ¨æ­¤ç‰ˆæœ¬ä¸­æä¾›äº†æ­¤åŠŸèƒ½

ä½¿ç”¨ç¤ºä¾‹ï¼š
æ‰€æœ‰é›†åˆæ“ä½œç¬¦éƒ½å¯ä»¥ä»¥ä¸¤ç§æ–¹å¼ä½¿ç”¨ï¼š`import approach` æˆ– `builder approach`

<Section>
```ts copy {2,7}
// Import approach
import { union } from 'drizzle-orm/pg-core'

const allUsersQuery = db.select().from(users);
const allCustomersQuery = db.select().from(customers);

const result = await union(allUsersQuery, allCustomersQuery)
```

```ts copy {2}
// Builder approach
const result = await db.select().from(users).union(db.select().from(customers));
```
</Section>

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/set-operations) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ æ–°çš„ MySQL ä»£ç†é©±åŠ¨ç¨‹åº

å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„é©±åŠ¨ç¨‹åºï¼Œå…è®¸æ‚¨ä½¿ç”¨ MySQL æ•°æ®åº“åˆ›å»ºè‡ªå·±çš„ HTTP é©±åŠ¨ç¨‹åºå®ç°ã€‚æ‚¨å¯ä»¥åœ¨ `./examples/mysql-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç”¨æ³•ç¤ºä¾‹

æ‚¨éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®ç°ä¸¤ä¸ªç«¯ç‚¹ï¼Œç”¨äºæŸ¥è¯¢å’Œè¿ç§»ï¼ˆå¦‚æœæ‚¨æƒ³ä½¿ç”¨ drizzle è¿ç§»ï¼Œè¿ç§»ç«¯ç‚¹æ˜¯å¯é€‰çš„ï¼‰ã€‚æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºå®ç°éƒ½æ˜¯ç”±æ‚¨å†³å®šçš„ï¼Œå› æ­¤æ‚¨æ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚æ‚¨å¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ˜ å°„ã€æ—¥å¿—è®°å½•ç­‰ç­‰

æ‚¨å¯ä»¥åœ¨ `./examples/mysql-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºå®ç°ç¤ºä¾‹

```ts copy {4,9}
// Driver
import axios from 'axios';
import { eq } from 'drizzle-orm/expressions';
import { drizzle } from 'drizzle-orm/mysql-proxy';
import { migrate } from 'drizzle-orm/mysql-proxy/migrator';
import { cities, users } from './schema';

async function main() {
  const db = drizzle(async (sql, params, method) => {
    try {
      const rows = await axios.post(`${process.env.REMOTE_DRIVER}/query`, {
        sql,
        params,
        method,
      });

      return { rows: rows.data };
    } catch (e: any) {
      console.error('Error from pg proxy server:', e.response.data);
      return { rows: [] };
    }
  });

  await migrate(db, async (queries) => {
    try {
      await axios.post(`${process.env.REMOTE_DRIVER}/migrate`, { queries });
    } catch (e) {
      console.log(e);
      throw new Error('Proxy server cannot run migrations');
    }
  }, { migrationsFolder: 'drizzle' });

  await db.insert(cities).values({ id: 1, name: 'name' });

  await db.insert(users).values({
    id: 1,
    name: 'name',
    email: 'email',
    cityId: 1,
  });

  const usersToCityResponse = await db.select().from(users).leftJoin(
    cities,
    eq(users.cityId, cities.id),
  );
}
```

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/get-started-mysql#http-proxy) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ æ–°çš„ PostgreSQL ä»£ç†é©±åŠ¨ç¨‹åº

ä¸ MySQL ä¸€æ ·ï¼Œæ‚¨ç°åœ¨å¯ä»¥ä¸º PostgreSQL æ•°æ®åº“å®ç°è‡ªå·±çš„ HTTP é©±åŠ¨ç¨‹åºã€‚æ‚¨å¯ä»¥åœ¨ `./examples/pg-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ç”¨æ³•ç¤ºä¾‹

æ‚¨éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®ç°ä¸¤ä¸ªç«¯ç‚¹ï¼Œç”¨äºæŸ¥è¯¢å’Œè¿ç§»ï¼ˆå¦‚æœæ‚¨æƒ³ä½¿ç”¨ drizzle è¿ç§»ï¼Œè¿ç§»ç«¯ç‚¹æ˜¯å¯é€‰çš„ï¼‰ã€‚æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºå®ç°éƒ½æ˜¯ç”±æ‚¨å†³å®šçš„ï¼Œå› æ­¤æ‚¨æ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚æ‚¨å¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ˜ å°„ã€æ—¥å¿—è®°å½•ç­‰ç­‰

æ‚¨å¯ä»¥åœ¨ `./examples/pg-proxy` æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æœåŠ¡å™¨å’Œé©±åŠ¨ç¨‹åºå®ç°ç¤ºä¾‹

```ts copy {3,8}
import axios from 'axios';
import { eq } from 'drizzle-orm/expressions';
import { drizzle } from 'drizzle-orm/pg-proxy';
import { migrate } from 'drizzle-orm/pg-proxy/migrator';
import { cities, users } from './schema';

async function main() {
  const db = drizzle(async (sql, params, method) => {
    try {
      const rows = await axios.post(`${process.env.REMOTE_DRIVER}/query`, { sql, params, method });

      return { rows: rows.data };
    } catch (e: any) {
      console.error('Error from pg proxy server:', e.response.data);
      return { rows: [] };
    }
  });

  await migrate(db, async (queries) => {
    try {
      await axios.post(`${process.env.REMOTE_DRIVER}/query`, { queries });
    } catch (e) {
      console.log(e);
      throw new Error('Proxy server cannot run migrations');
    }
  }, { migrationsFolder: 'drizzle' });

  const insertedCity = await db.insert(cities).values({ id: 1, name: 'name' }).returning();
  const insertedUser = await db.insert(users).values({ id: 1, name: 'name', email: 'email', cityId: 1 });
  const usersToCityResponse = await db.select().from(users).leftJoin(cities, eq(users.cityId, cities.id));
}
```

åœ¨ [æ–‡æ¡£](https://orm.drizzle.team/docs/get-started-postgresql#http-proxy) ä¸­äº†è§£æ›´å¤šä¿¡æ¯

### ğŸ‰ `D1` æ‰¹å¤„ç† API æ”¯æŒ

å‚è€ƒï¼šhttps://developers.cloudflare.com/d1/platform/client-api/#dbbatch

æ‰¹å¤„ç† API ä½¿ç”¨ç¤ºä¾‹ï¼š

<Section>
```ts copy {1}
const batchResponse = await db.batch([
  db.insert(usersTable).values({ id: 1, name: 'John' }).returning({
    id: usersTable.id,
  }),
  db.update(usersTable).set({ name: 'Dan' }).where(eq(usersTable.id, 1)),
  db.query.usersTable.findMany({}),
  db.select().from(usersTable).where(eq(usersTable.id, 1)),
  db.select({ id: usersTable.id, invitedBy: usersTable.invitedBy }).from(
    usersTable,
  ),
]);
```

```ts
type BatchResponse = [
  {
    id: number;
  }[],
  D1Result,
  {
    id: number;
    name: string;
    verified: number;
    invitedBy: number | null;
  }[],
  {
    id: number;
    name: string;
    verified: number;
    invitedBy: number | null;
  }[],
  {
    id: number;
    invitedBy: number | null;
  }[],
];
```
</Section>

æ‰€æœ‰å¯ä»¥åœ¨ `db.batch` å†…éƒ¨ä½¿ç”¨çš„å¯èƒ½çš„æ„å»ºå™¨ï¼š

```ts
`db.all()`,
`db.get()`,
`db.values()`,
`db.run()`,
`db.query.<table>.findMany()`,
`db.query.<table>.findFirst()`,
`db.select()...`,
`db.update()...`,
`db.delete()...`,
`db.insert()...`,
```

åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°æ›´å¤šçš„ä½¿ç”¨ç¤ºä¾‹ï¼š[integration-tests/tests/d1-batch.test.ts](https://github.com/drizzle-team/drizzle-orm/blob/beta/integration-tests/tests/d1-batch.test.ts) å’Œ [æ–‡æ¡£](https://orm.drizzle.team/docs/batch-api)

---
## Drizzle Kit 0.20.0

1. ä½¿ç”¨ `defineConfig` å‡½æ•°å®šä¹‰ drizzle.config çš„æ–°æ–¹å¼
2. ä½¿ç”¨ wrangler.toml æ–‡ä»¶å¯ä»¥åœ¨ Drizzle Studio ä¸­è®¿é—® Cloudflare D1
3. Drizzle Studio è¿ç§»åˆ° https://local.drizzle.studio/
4. `bigint unsigned` æ”¯æŒ
5. `primaryKeys` å’Œ `foreignKeys` ç°åœ¨å¯ä»¥æœ‰è‡ªå®šä¹‰åç§°
6. ç¯å¢ƒå˜é‡ç°åœ¨ä¼šè‡ªåŠ¨è·å–
7. ä¸€äº›é”™è¯¯ä¿®å¤å’Œæ”¹è¿›

æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æœ‰å…³ drizzle-kit æ›´æ–°çš„æ›´å¤šä¿¡æ¯ï¼š[here](https://github.com/drizzle-team/drizzle-kit-mirror/releases/tag/v0.20.0)
