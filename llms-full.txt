# Drizzle

> Drizzle is a modern TypeScript ORM developers wanna use in their next project. It is lightweight at only ~7.4kb minified+gzipped, and it's tree shakeable with exactly 0 dependencies. It supports every PostgreSQL, MySQL, SQLite and SingleStore database and is serverless-ready by design.

Source: https://drizzle.zhcndoc.com/docs/arktype

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';

# drizzle-arktype

`drizzle-arktype` æ˜¯ **[Drizzle ORM](https://github.com/drizzle-team/drizzle-orm)** çš„ä¸€ä¸ªæ’ä»¶ï¼Œå…è®¸ä½ ä» Drizzle ORM æ¨¡å¼ç”Ÿæˆ **[Arktype](https://arktype.io/)** æ¨¡å¼ã€‚

### å®‰è£…ä¾èµ–

<Npm>
drizzle-arktype
</Npm>

<Callout type="warning">
æœ¬æ–‡æ¡£é€‚ç”¨äº `drizzle-arktype@0.1.0` åŠæ›´é«˜ç‰ˆæœ¬

ä½ è¿˜å¿…é¡»å®‰è£… Drizzle ORM v0.36.0 æˆ–æ›´é«˜ç‰ˆæœ¬å’Œ Arktype v2.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
</Callout>

### é€‰æ‹© schema

å®šä¹‰ä»æ•°æ®åº“æŸ¥è¯¢çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¿”å›çš„æ•°æ®ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-arktype';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userSelectSchema = createSelectSchema(users);

const rows = await db.select({ id: users.id, name: users.name }).from(users).limit(1);
const parsed: { id: number; name: string; age: number } = userSelectSchema(rows[0]); // é”™è¯¯ï¼šä¸Šè¿°æŸ¥è¯¢æœªè¿”å› `age`

const rows = await db.select().from(users).limit(1);
const parsed: { id: number; name: string; age: number } = userSelectSchema(rows[0]); // è§£ææˆåŠŸ
```

è§†å›¾å’Œæšä¸¾ç±»å‹ä¹Ÿæ”¯æŒã€‚

```ts copy
import { pgEnum } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-arktype';

const roles = pgEnum('roles', ['admin', 'basic']);
const rolesSchema = createSelectSchema(roles);
const parsed: 'admin' | 'basic' = rolesSchema(...);

const usersView = pgView('users_view').as((qb) => qb.select().from(users).where(gt(users.age, 18)));
const usersViewSchema = createSelectSchema(usersView);
const parsed: { id: number; name: string; age: number } = usersViewSchema(...);
```

### æ’å…¥ schema

å®šä¹‰æ’å…¥æ•°æ®åº“æ•°æ®çš„å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createInsertSchema } from 'drizzle-arktype';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userInsertSchema = createInsertSchema(users);

const user = { name: 'John' };
const parsed: { name: string, age: number } = userInsertSchema(user); // é”™è¯¯ï¼š`age` æœªå®šä¹‰

const user = { name: 'Jane', age: 30 };
const parsed: { name: string, age: number } = userInsertSchema(user); // è§£ææˆåŠŸ
await db.insert(users).values(parsed);
```

### æ›´æ–° schema

å®šä¹‰æ›´æ–°æ•°æ®åº“æ•°æ®çš„å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createUpdateSchema } from 'drizzle-arktype';
import { parse } from 'arktype';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userUpdateSchema = createUpdateSchema(users);

const user = { id: 5, name: 'John' };
const parsed: { name?: string | undefined, age?: number | undefined } = userUpdateSchema(user); // é”™è¯¯ï¼š`id` æ˜¯ç”Ÿæˆåˆ—ï¼Œä¸èƒ½æ›´æ–°

const user = { age: 35 };
const parsed: { name?: string | undefined, age?: number | undefined } = userUpdateSchema(user); // è§£ææˆåŠŸ
await db.update(users).set(parsed).where(eq(users.name, 'Jane'));
```

### ç²¾ç»†åŒ–å®šåˆ¶

æ¯ä¸ª create schema å‡½æ•°éƒ½æ¥å—ä¸€ä¸ªé™„åŠ çš„å¯é€‰å‚æ•°ï¼Œç”¨äºæ‰©å±•ã€ä¿®æ”¹æˆ–å®Œå…¨è¦†ç›–å­—æ®µçš„ schemaã€‚å®šä¹‰å›è°ƒå‡½æ•°å°†æ‰©å±•æˆ–ä¿®æ”¹ schemaï¼Œç›´æ¥æä¾› arktype schema ä¼šè¦†ç›–åŸæœ‰å­—æ®µã€‚

```ts copy
import { pgTable, text, integer, json } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-arktype';
import { parse, pipe, maxLength, object, string } from 'arktype';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  bio: text(),
  preferences: json()
});

const userSelectSchema = createSelectSchema(users, {
  name: (schema) => pipe(schema, maxLength(20)), // æ‰©å±• schema
  bio: (schema) => pipe(schema, maxLength(1000)), // æ‰©å±• schemaï¼Œæ³¨æ„ç”Ÿæ•ˆå‰å­—æ®µå¯ç©º/å¯é€‰
  preferences: object({ theme: string() }) // è¦†ç›–å­—æ®µï¼ŒåŒ…å«å…¶å¯ç©ºæ€§
});

const parsed: {
  id: number;
  name: string,
  bio?: string | undefined;
  preferences: {
    theme: string;
  };
} = userSelectSchema(...);
```

### æ•°æ®ç±»å‹å‚è€ƒ

```ts
pg.boolean();

mysql.boolean();

sqlite.integer({ mode: 'boolean' });

// Schema
type.boolean;
```

```ts
pg.date({ mode: 'date' });
pg.timestamp({ mode: 'date' });

mysql.date({ mode: 'date' });
mysql.datetime({ mode: 'date' });
mysql.timestamp({ mode: 'date' });

sqlite.integer({ mode: 'timestamp' });
sqlite.integer({ mode: 'timestamp_ms' });

// Schema
type.Date;
```

```ts
pg.date({ mode: 'string' });
pg.timestamp({ mode: 'string' });
pg.cidr();
pg.inet();
pg.interval();
pg.macaddr();
pg.macaddr8();
pg.numeric();
pg.text();
pg.sparsevec();
pg.time();

mysql.binary();
mysql.date({ mode: 'string' });
mysql.datetime({ mode: 'string' });
mysql.decimal();
mysql.time();
mysql.timestamp({ mode: 'string' });
mysql.varbinary();

sqlite.numeric();
sqlite.text({ mode: 'text' });

// Schema
type.string;
```

```ts
pg.bit({ dimensions: ... });

// Schema
type(`/^[01]{${column.dimensions}}$/`);
```

```ts
pg.uuid();

// Schema
type(/^[\da-f]{8}(?:-[\da-f]{4}){3}-[\da-f]{12}$/iu);
```

```ts
pg.char({ length: ... });

mysql.char({ length: ... });

// Schema
type.string.exactlyLength(length);
```

```ts
pg.varchar({ length: ... });

mysql.varchar({ length: ... });

sqlite.text({ mode: 'text', length: ... });

// Schema
type.string.atMostLength(length);
```

```ts
mysql.tinytext();

// Schema
type.string.atMostLength(255); // æ— ç¬¦å· 8 ä½æ•´æ•°èŒƒå›´é™åˆ¶
```

```ts
mysql.text();

// Schema
type.string.atMostLength(65_535); // æ— ç¬¦å· 16 ä½æ•´æ•°èŒƒå›´é™åˆ¶
```

```ts
mysql.mediumtext();

// Schema
type.string.atMostLength(16_777_215); // æ— ç¬¦å· 24 ä½æ•´æ•°èŒƒå›´é™åˆ¶
```

```ts
mysql.longtext();

// Schema
type.string.atMostLength(4_294_967_295); // æ— ç¬¦å· 32 ä½æ•´æ•°èŒƒå›´é™åˆ¶
```

```ts
pg.text({ enum: ... });
pg.char({ enum: ... });
pg.varchar({ enum: ... });

mysql.tinytext({ enum: ... });
mysql.mediumtext({ enum: ... });
mysql.text({ enum: ... });
mysql.longtext({ enum: ... });
mysql.char({ enum: ... });
mysql.varchar({ enum: ... });
mysql.mysqlEnum(..., ...);

sqlite.text({ mode: 'text', enum: ... });

// Schema
type.enumerated(...enum);
```

```ts
mysql.tinyint();

// Schema
type.keywords.number.integer.atLeast(-128).atMost(127); // 8 ä½æœ‰ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.tinyint({ unsigned: true });

// Schema
type.keywords.number.integer.atLeast(0).atMost(255); // 8 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.smallint();
pg.smallserial();

mysql.smallint();

// Schema
type.keywords.number.integer.atLeast(-32_768).atMost(32_767); // 16 ä½æœ‰ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.smallint({ unsigned: true });

// Schema
type.keywords.number.integer.atLeast(0).atMost(65_535); // 16 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.real();

mysql.float();

// Schema
type.number.atLeast(-8_388_608).atMost(8_388_607); // 24 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.mediumint();

// Schema
type.keywords.number.integer.atLeast(-8_388_608).atMost(8_388_607); // 24 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.float({ unsigned: true });

// Schema
type.number.atLeast(0).atMost(16_777_215); // 24 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.mediumint({ unsigned: true });

// Schema
type.keywords.number.integer.atLeast(0).atMost(16_777_215); // 24 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.integer();
pg.serial();

mysql.int();

// Schema
type.keywords.number.integer.atLeast(-2_147_483_648).atMost(2_147_483_647); // 32 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.int({ unsigned: true });

// Schema
type.keywords.number.integer.atLeast(0).atMost(4_294_967_295); // 32 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.doublePrecision();

mysql.double();
mysql.real();

sqlite.real();

// Schema
type.number.atLeast(-140_737_488_355_328).atMost(140_737_488_355_327); // 48 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.double({ unsigned: true });

// Schema
type.number.atLeast(0).atMost(281_474_976_710_655); // 48 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.bigint({ mode: 'number' });
pg.bigserial({ mode: 'number' });

mysql.bigint({ mode: 'number' });
mysql.bigserial({ mode: 'number' });

sqlite.integer({ mode: 'number' });

// Schema
type.keywords.number.integer.atLeast(-9_007_199_254_740_991).atMost(9_007_199_254_740_991); // JavaScript æœ€å°æœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
mysql.serial();

// Schema
type.keywords.number.integer.atLeast(0).atMost(9_007_199_254_740_991); // JavaScript æœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
pg.bigint({ mode: 'bigint' });
pg.bigserial({ mode: 'bigint' });

mysql.bigint({ mode: 'bigint' });

sqlite.blob({ mode: 'bigint' });

// Schema
type.bigint.narrow(
  (value, ctx) => value < -9_223_372_036_854_775_808n ? ctx.mustBe('greater than') : value > 9_223_372_036_854_775_807n ? ctx.mustBe('less than') : true
); // 64 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.bigint({ mode: 'bigint', unsigned: true });

// Schema
type.bigint.narrow(
  (value, ctx) => value < 0n ? ctx.mustBe('greater than') : value > 18_446_744_073_709_551_615n ? ctx.mustBe('less than') : true
); // 64 ä½æ— ç¬¦å·æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.year();

// Schema
type.keywords.number.integer.atLeast(1_901).atMost(2_155);
```

```ts
pg.geometry({ type: 'point', mode: 'tuple' });
pg.point({ mode: 'tuple' });

// Schema
type([type.number, type.number]);
```

```ts
pg.geometry({ type: 'point', mode: 'xy' });
pg.point({ mode: 'xy' });

// Schema
type({ x: type.number, y: type.number });
```

```ts
pg.halfvec({ dimensions: ... });
pg.vector({ dimensions: ... });

// Schema
type.number.array().exactlyLength(dimensions);
```

```ts
pg.line({ mode: 'abc' });

// Schema
type({ a: type.number, b: type.number, c: type.number });
```

```ts
pg.line({ mode: 'tuple' });

// Schema
type([type.number, type.number, type.number]);
```

```ts
pg.json();
pg.jsonb();

mysql.json();

sqlite.blob({ mode: 'json' });
sqlite.text({ mode: 'json' });

// Schema
type('string | number | boolean | null').or(type('unknown.any[] | Record<string, unknown.any>'));
```

```ts
sqlite.blob({ mode: 'buffer' });

// Schema
type.instanceOf(Buffer);
```

```ts
pg.dataType().array(...);

// Schema
baseDataTypeSchema.array().exactlyLength(size);
```

Source: https://drizzle.zhcndoc.com/docs/batch-api

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';

# æ‰¹é‡ API

**LibSQL æ‰¹é‡ API è§£é‡Š**ï¼š
_[æ¥æº](https://docs.turso.tech/sdk/ts/reference#batch-transactions)_

> ä½¿ç”¨ libSQL å®¢æˆ·ç«¯åº“ï¼Œæ‰¹é‡æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª SQL è¯­å¥åœ¨éšå¼äº‹åŠ¡ä¸­æŒ‰é¡ºåºæ‰§è¡Œã€‚ 
äº‹åŠ¡ç”± libSQL åç«¯æ§åˆ¶ã€‚å¦‚æœæ‰€æœ‰è¯­å¥éƒ½æˆåŠŸï¼Œ 
äº‹åŠ¡å°†è¢«æäº¤ã€‚å¦‚æœä»»ä½•è¯­å¥å¤±è´¥ï¼Œåˆ™æ•´ä¸ªäº‹åŠ¡å°†å›æ»šï¼Œä¸”ä¸ä¼šè¿›è¡Œä»»ä½•æ›´æ”¹ã€‚

**D1 æ‰¹é‡ API è§£é‡Š**ï¼š
_[æ¥æº](https://developers.cloudflare.com/d1/worker-api/d1-database/#batch)_

> æ‰¹é‡å¤„ç†ä¼šå°†å¤šä¸ª SQL è¯­å¥å‘é€åˆ°æ•°æ®åº“ä¸­çš„å•ä¸ªè°ƒç”¨ã€‚ 
è¿™å¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºå®ƒå‡å°‘äº†ä¸ D1 ä¹‹é—´çš„ç½‘ç»œå¾€è¿”å»¶è¿Ÿã€‚ 
D1 åœ¨è‡ªåŠ¨æäº¤æ¨¡å¼ä¸‹è¿è¡Œã€‚æˆ‘ä»¬çš„å®ç°ä¿è¯åˆ—è¡¨ä¸­çš„æ¯ä¸ªè¯­å¥å°†æŒ‰é¡ºåºæ‰§è¡Œå’Œæäº¤ï¼Œ
è€Œä¸”ä¸ä¼šå¹¶å‘æ‰§è¡Œã€‚
æ‰¹é‡è¯­å¥æ˜¯ SQL äº‹åŠ¡ã€‚å¦‚æœåºåˆ—ä¸­çš„æŸä¸ªè¯­å¥å¤±è´¥ï¼Œ 
åˆ™ä¼šè¿”å›è¯¥ç‰¹å®šè¯­å¥çš„é”™è¯¯ï¼Œå¹¶ä¼šä¸­æ­¢æˆ–å›æ»šæ•´ä¸ªåºåˆ—ã€‚

Drizzle ORM æä¾›äº†ç”¨äº `LibSQL`ã€`Neon` å’Œ `D1` çš„æ‰¹é‡è¿è¡Œ SQL è¯­å¥çš„ APIï¼š
```ts
const batchResponse: BatchResponse = await db.batch([
	db.insert(usersTable).values({ id: 1, name: 'John' }).returning({ id: usersTable.id }),
	db.update(usersTable).set({ name: 'Dan' }).where(eq(usersTable.id, 1)),
	db.query.usersTable.findMany({}),
	db.select().from(usersTable).where(eq(usersTable.id, 1)),
	db.select({ id: usersTable.id, invitedBy: usersTable.invitedBy }).from(usersTable),
]);
```
è¿™ä¸ªä¾‹å­ä¸­çš„ `batchResponse` ç±»å‹å°†æ˜¯ï¼š
<Tabs items={["libSQL", "Neon", "D1"]}>
<Tab>
```ts
type BatchResponse = [
	{
		id: number;
	}[],
	ResultSet,
	{
		id: number;
		name: string;
		verified: number;
		invitedBy: number | null;
	}[],
	{
		id: number;
		name: string;
		verified: number;
		invitedBy: number | null;
	}[],
	{
		id: number;
		invitedBy: number | null;
	}[],
]
```
</Tab>
<Tab>
```ts
type BatchResponse = [
	{
		id: number;
	}[],
	NeonHttpQueryResult,
	{
		id: number;
		name: string;
		verified: number;
		invitedBy: number | null;
	}[],
	{
		id: number;
		name: string;
		verified: number;
		invitedBy: number | null;
	}[],
	{
		id: number;
		invitedBy: number | null;
	}[],
]
```
</Tab>
<Tab>
```ts
type BatchResponse = [
  {
    id: number;
  }[],
  D1Result,
  {
    id: number;
    name: string;
    verified: number;
    invitedBy: number | null;
  }[],
  {
    id: number;
    name: string;
    verified: number;
    invitedBy: number | null;
  }[],
  {
    id: number;
    invitedBy: number | null;
  }[],
]
```
</Tab>
</Tabs>

å¯ä»¥åœ¨ `db.batch` å†…ä½¿ç”¨çš„æ‰€æœ‰å¯èƒ½çš„æ„å»ºå™¨ï¼š
```ts
db.all(),
db.get(),
db.values(),
db.run(),
db.execute(),
db.query.<table>.findMany(),
db.query.<table>.findFirst(),
db.select()...,
db.update()...,
db.delete()...,
db.insert()...,
```


Source: https://drizzle.zhcndoc.com/docs/cache

import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';

# ç¼“å­˜

Drizzle é»˜è®¤å°†æ¯ä¸ªæŸ¥è¯¢ç›´æ¥å‘é€åˆ°ä½ çš„æ•°æ®åº“ã€‚æ²¡æœ‰éšè—çš„æ“ä½œï¼Œæ²¡æœ‰è‡ªåŠ¨ç¼“å­˜æˆ–å¤±æ•ˆ - ä½ å°†å§‹ç»ˆçœ‹åˆ°ç¡®åˆ‡çš„æ‰§è¡Œå†…å®¹ã€‚å¦‚æœä½ éœ€è¦ç¼“å­˜ï¼Œå¿…é¡»æ‰‹åŠ¨é€‰æ‹©ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrizzle ä½¿ç”¨ `explicit` ç¼“å­˜ç­–ç•¥ï¼ˆå³ `global: false`ï¼‰ï¼Œå› æ­¤é™¤éä½ è¯·æ±‚ï¼Œå¦åˆ™ä¸ä¼šç¼“å­˜ä»»ä½•å†…å®¹ã€‚è¿™é˜²æ­¢äº†åœ¨ä½ çš„åº”ç”¨ä¸­å‡ºç°æƒŠè®¶æˆ–éšè—çš„æ€§èƒ½é™·é˜±ã€‚æˆ–è€…ï¼Œä½ å¯ä»¥å¯ç”¨ `all` ç¼“å­˜ï¼ˆ`global: true`ï¼‰ï¼Œè¿™æ ·æ¯ä¸ªé€‰æ‹©éƒ½å°†é¦–å…ˆæŸ¥çœ‹ç¼“å­˜ã€‚

## å¿«é€Ÿå¼€å§‹

### Upstash é›†æˆ

Drizzle æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ `upstashCache()` è¾…åŠ©å‡½æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼Œå®ƒä½¿ç”¨ Upstash Redis è¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  cache: upstashCache(),
});
```

ä½ è¿˜å¯ä»¥æ˜¾å¼å®šä¹‰ä½ çš„ Upstash å‡­è¯ï¼Œé»˜è®¤å¯ç”¨æ‰€æœ‰æŸ¥è¯¢çš„å…¨å±€ç¼“å­˜æˆ–ä¼ é€’è‡ªå®šä¹‰ç¼“å­˜é€‰é¡¹ï¼š

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  cache: upstashCache({
    // ğŸ‘‡ Redis å‡­è¯ï¼ˆå¯é€‰ â€” ä¹Ÿå¯ä»¥ä»ç¯å¢ƒå˜é‡ä¸­æå–ï¼‰
    url: '<UPSTASH_URL>',
    token: '<UPSTASH_TOKEN>',

    // ğŸ‘‡ é»˜è®¤å¯ç”¨æ‰€æœ‰æŸ¥è¯¢çš„ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    global: true,

    // ğŸ‘‡ é»˜è®¤ç¼“å­˜è¡Œä¸ºï¼ˆå¯é€‰ï¼‰
    config: { ex: 60 }
  })
});
```

## ç¼“å­˜é…ç½®å‚è€ƒ

Drizzle æ”¯æŒä»¥ä¸‹ Upstash ç¼“å­˜é…ç½®é€‰é¡¹ï¼š

```ts
export type CacheConfig = {
  /**
   * è¿‡æœŸæ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½çš„æ­£æ•´æ•°ï¼‰
   */
  ex?: number;
  /**
   * åœ¨ç»™å®šå“ˆå¸Œé”®çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µä¸Šè®¾ç½®è¿‡æœŸï¼ˆTTL æˆ–ç”Ÿå­˜æ—¶é—´ï¼‰ã€‚
   * ç”¨äº HEXPIRE å‘½ä»¤
   */
  hexOptions?: "NX" | "nx" | "XX" | "xx" | "GT" | "gt" | "LT" | "lt";
};
```

## ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹

ä¸€æ—¦ä½ é…ç½®äº†ç¼“å­˜ï¼Œä¸‹é¢æ˜¯ç¼“å­˜çš„è¡Œä¸ºï¼š

**æ¡ˆä¾‹1ï¼šDrizzle ä½¿ç”¨ `global: false`ï¼ˆé»˜è®¤ï¼Œé€‰æ‹©æ€§ç¼“å­˜ï¼‰**

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  // ğŸ‘‡ æ²¡æœ‰ä¼ å…¥ `global: true`ï¼Œé»˜è®¤æ˜¯ false
  cache: upstashCache({ url: "", token: "" }),
});
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æŸ¥è¯¢ä¸ä¼šä»ç¼“å­˜è¯»å–

```ts
const res = await db.select().from(users);

// ä»»ä½•å˜æ›´æ“ä½œä»å°†è§¦å‘ç¼“å­˜çš„ onMutate å¤„ç†å™¨
// å°è¯•ä½¿ä»»ä½•æ¶‰åŠå—å½±å“è¡¨çš„ç¼“å­˜æŸ¥è¯¢å¤±æ•ˆ
await db.insert(users).value({ email: "cacheman@upstash.com" });
```

è¦ä½¿æ­¤æŸ¥è¯¢ä»ç¼“å­˜è¯»å–ï¼Œè°ƒç”¨ `.$withCache()`

```ts
const res = await db.select().from(users).$withCache();
```

`.$withCache` æœ‰ä¸€ç»„å¯ä¾›ä½ ä½¿ç”¨çš„é€‰é¡¹ï¼Œä»¥ç®¡ç†å’Œé…ç½®æ­¤ç‰¹å®šæŸ¥è¯¢ç­–ç•¥

```ts
// ä¸ºæ­¤ç‰¹å®šæŸ¥è¯¢é‡å†™é…ç½®
.$withCache({ config: {} })

// ç»™æ­¤æŸ¥è¯¢ä¸€ä¸ªè‡ªå®šä¹‰ç¼“å­˜é”®ï¼ˆè€Œä¸æ˜¯åœ¨åå°å“ˆå¸ŒæŸ¥è¯¢+å‚æ•°ï¼‰
.$withCache({ tag: 'custom_key' })

// å…³é—­æ­¤æŸ¥è¯¢çš„è‡ªåŠ¨å¤±æ•ˆ
// æ³¨æ„ï¼šè¿™ä¼šå¯¼è‡´æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¦‚ä¸‹æ‰€è¿°ï¼‰
.$withCache({ autoInvalidate: false })
```

<Callout>
**æœ€ç»ˆä¸€è‡´æ€§ç¤ºä¾‹**

æ­¤ç¤ºä¾‹ä»…åœ¨ä½ æ‰‹åŠ¨è®¾ç½® `autoInvalidate: false` æ—¶ç›¸å…³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨ `autoInvalidate`ã€‚

å¦‚æœä½ æƒ³å…³é—­ `autoInvalidate`ï¼Œä½ å¯èƒ½ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼š
- ä½ çš„æ•°æ®ä¸ç»å¸¸æ›´æ”¹ï¼Œå¹¶ä¸”å¯ä»¥æ¥å—è½»å¾®çš„è¿‡æ—¶ï¼ˆä¾‹å¦‚äº§å“åˆ—è¡¨ã€åšå®¢æ–‡ç« ï¼‰
- ä½ æ‰‹åŠ¨å¤„ç†ç¼“å­˜å¤±æ•ˆ

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå…³é—­å®ƒå¯ä»¥å‡å°‘ä¸å¿…è¦çš„ç¼“å­˜å¤±æ•ˆã€‚ç„¶è€Œï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®®ä¿ç•™é»˜è®¤å¯ç”¨ã€‚

ç¤ºä¾‹ï¼šå‡è®¾ä½ åœ¨ `usersTable` ä¸Šç¼“å­˜ä»¥ä¸‹æŸ¥è¯¢ï¼Œè¿‡æœŸæ—¶é—´ä¸º 3 ç§’ï¼š

``` ts
const recent = await db
  .select().from(usersTable)
  .$withCache({ config: { ex: 3 }, autoInvalidate: false });
```

å¦‚æœæœ‰äººè¿è¡Œ `db.insert(usersTable)...`ï¼Œç¼“å­˜ä¸ä¼šç«‹å³å¤±æ•ˆã€‚åœ¨æœ€å¤š 3 ç§’å†…ï¼Œä½ å°†ç»§ç»­çœ‹åˆ°æ—§æ•°æ®ï¼Œç›´åˆ°å®ƒæœ€ç»ˆå˜å¾—ä¸€è‡´ã€‚
</Callout>

**æ¡ˆä¾‹2ï¼šDrizzle ä½¿ç”¨ `global: true` é€‰é¡¹**

```ts
import { upstashCache } from "drizzle-orm/cache/upstash";
import { drizzle } from "drizzle-orm/...";

const db = drizzle(process.env.DB_URL!, {
  cache: upstashCache({ url: "", token: "", global: true }),
});
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æŸ¥è¯¢å°†ä»ç¼“å­˜è¯»å–

```ts
const res = await db.select().from(users);
```

å¦‚æœä½ æƒ³ç¦ç”¨æ­¤ç‰¹å®šæŸ¥è¯¢çš„ç¼“å­˜ï¼Œè°ƒç”¨ `.$withCache(false)`

```ts
// ç¦ç”¨æ­¤æŸ¥è¯¢çš„ç¼“å­˜
const res = await db.select().from(users).$withCache(false);
```

ä½ è¿˜å¯ä»¥ä½¿ç”¨æ¥è‡ª `db` çš„ç¼“å­˜å®ä¾‹æ¥ä½¿ç‰¹å®šè¡¨æˆ–æ ‡ç­¾å¤±æ•ˆã€‚

```ts
// ä½¿æ‰€æœ‰ä½¿ç”¨ `users` è¡¨çš„æŸ¥è¯¢å¤±æ•ˆã€‚ä½ å¯ä»¥ç”¨ Drizzle å®ä¾‹åšåˆ°è¿™ä¸€ç‚¹ã€‚
await db.$cache.invalidate({ tables: users });
// æˆ–
await db.$cache.invalidate({ tables: [users, posts] });

// ä½¿æ‰€æœ‰ä½¿ç”¨ `usersTable` çš„æŸ¥è¯¢å¤±æ•ˆã€‚ä½ å¯ä»¥ä½¿ç”¨è¡¨åç§°æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚
await db.$cache.invalidate({ tables: "usersTable" });
// æˆ–
await db.$cache.invalidate({ tables: ["usersTable", "postsTable"] });

// ä½ è¿˜å¯ä»¥ä½¿åœ¨ä»»ä½•ä¹‹å‰æ‰§è¡Œçš„é€‰æ‹©æŸ¥è¯¢ä¸­å®šä¹‰çš„è‡ªå®šä¹‰æ ‡ç­¾å¤±æ•ˆã€‚
await db.$cache.invalidate({ tags: "custom_key" });
// æˆ–
await db.$cache.invalidate({ tags: ["custom_key", "custom_key1"] });
```

## è‡ªå®šä¹‰ç¼“å­˜

æ­¤ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åœ¨ Drizzle ä¸­æ’å…¥è‡ªå®šä¹‰ `cache`ï¼šä½ æä¾›å‡½æ•°ä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€å°†ç»“æœå­˜å‚¨å›ç¼“å­˜ï¼Œå¹¶åœ¨æ¯æ¬¡æ‰§è¡Œå˜æ›´æ—¶ä½¿æ¡ç›®å¤±æ•ˆã€‚

ç¼“å­˜æ‰©å±•æä¾›æ­¤é…ç½®é€‰é¡¹é›†
```ts
export type CacheConfig = {
  /** è¿‡æœŸæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ */
  ex?: number;
  /** è¿‡æœŸæ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ */
  px?: number;
  /** é”®å°†åœ¨ Unix æ—¶é—´ï¼ˆç§’ï¼‰åˆ°æœŸ */
  exat?: number;
  /** é”®å°†åœ¨ Unix æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰åˆ°æœŸ */
  pxat?: number;
  /** æ›´æ–°é”®æ—¶ä¿ç•™ç°æœ‰çš„ TTL */
  keepTtl?: boolean;
  /** HEXPIREï¼ˆå“ˆå¸Œå­—æ®µ TTLï¼‰çš„é€‰é¡¹ */
  hexOptions?: 'NX' | 'XX' | 'GT' | 'LT' | 'nx' | 'xx' | 'gt' | 'lt';
};
```

```ts
const db = drizzle(process.env.DB_URL!, { cache: new TestGlobalCache() });
```

```ts
import Keyv from "keyv";

export class TestGlobalCache extends Cache {
  private globalTtl: number = 1000;
  // æ­¤å¯¹è±¡å°†ç”¨äºå­˜å‚¨ç‰¹å®šè¡¨ä½¿ç”¨çš„æŸ¥è¯¢é”®ï¼Œ
  // ä»¥ä¾¿æˆ‘ä»¬ä»¥åå¯ä»¥ç”¨äºå¤±æ•ˆå¤„ç†ã€‚
  private usedTablesPerKey: Record<string, string[]> = {};

  constructor(private kv: Keyv = new Keyv()) {
    super();
  }

  // å¯¹äºç­–ç•¥ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š
  // - 'explicit': ä»…å½“å¯¹æŸ¥è¯¢æ·»åŠ äº† .$withCache() æ—¶ä½¿ç”¨ç¼“å­˜ã€‚
  // - 'all': æ‰€æœ‰æŸ¥è¯¢è¢«å…¨å±€ç¼“å­˜ã€‚
  // é»˜è®¤è¡Œä¸ºæ˜¯ 'explicit'ã€‚
  override strategy(): "explicit" | "all" {
    return "all";
  }

  // æ­¤å‡½æ•°æ¥å—æŸ¥è¯¢å’Œå‚æ•°ï¼Œç¼“å­˜åˆ°é”®å‚æ•°ä¸­ï¼Œ
  // å…è®¸ä½ ä»ç¼“å­˜ä¸­æ£€ç´¢æ­¤æŸ¥è¯¢çš„å“åº”å€¼ã€‚
  override async get(key: string): Promise<any[] | undefined> {
    const res = (await this.kv.get(key)) ?? undefined;
    return res;
  }

  // æ­¤å‡½æ•°æ¥å—å¤šä¸ªé€‰é¡¹ä»¥å®šä¹‰ç¼“å­˜æ•°æ®å°†å¦‚ä½•å­˜å‚¨ï¼š
  // - 'key': å“ˆå¸ŒæŸ¥è¯¢å’Œå‚æ•°ã€‚
  // - 'response': Drizzle ä»æ•°æ®åº“è¿”å›çš„å€¼æ•°ç»„ã€‚
  // - 'tables': å‚ä¸é€‰æ‹©æŸ¥è¯¢çš„è¡¨æ•°ç»„ã€‚è¿™äº›ä¿¡æ¯å¯¹äºç¼“å­˜å¤±æ•ˆæ˜¯å¿…éœ€çš„ã€‚
  //
  // ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªæŸ¥è¯¢ä½¿ç”¨äº† "users" å’Œ "posts" è¡¨ï¼Œä½ å¯ä»¥å­˜å‚¨è¿™äº›ä¿¡æ¯ã€‚ç¨åï¼Œå½“åº”ç”¨ç¨‹åºæ‰§è¡Œ
  // åœ¨è¿™äº›è¡¨ä¸Šçš„ä»»ä½•å˜æ›´è¯­å¥æ—¶ï¼Œå¯ä»¥ä»ç¼“å­˜ä¸­åˆ é™¤ç›¸åº”çš„é”®ã€‚
  // å¦‚æœä½ å¯¹æŸ¥è¯¢çš„æœ€ç»ˆä¸€è‡´æ€§æ„Ÿåˆ°æ»¡æ„ï¼Œå¯ä»¥è·³è¿‡æ­¤é€‰é¡¹ã€‚
  override async put(
    key: string,
    response: any,
    tables: string[],
    config?: CacheConfig,
  ): Promise<void> {
    const ttl = config?.px ?? (config?.ex ? config.ex * 1000 : this.globalTtl);

    await this.kv.set(key, response, ttl);

    for (const table of tables) {
      const keys = this.usedTablesPerKey[table];
      if (keys === undefined) {
        this.usedTablesPerKey[table] = [key];
      } else {
        keys.push(key);
      }
    }
  }

  // å½“æ‰§è¡Œæ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤è¯­å¥æ—¶è°ƒç”¨æ­¤å‡½æ•°ã€‚
  // ä½ å¯ä»¥é€‰æ‹©è·³è¿‡æ­¤æ­¥éª¤æˆ–ä½¿ä½¿ç”¨å—å½±å“è¡¨çš„æŸ¥è¯¢å¤±æ•ˆã€‚
  //
  // è¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé”®çš„å¯¹è±¡ï¼š
  // - 'tags': ç”¨äºæ ‡è®°ä¸ºç‰¹å®šæ ‡ç­¾çš„æŸ¥è¯¢ï¼Œå…è®¸æŒ‰è¯¥æ ‡ç­¾å¤±æ•ˆã€‚
  // - 'tables': ç”±æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤è¯­å¥å½±å“çš„å®é™…è¡¨ï¼Œ
  //   å¸®åŠ©ä½ è·Ÿè¸ªè‡ªä¸Šæ¬¡ç¼“å­˜æ›´æ–°ä»¥æ¥å“ªäº›è¡¨å·²æ›´æ”¹ã€‚
  override async onMutate(params: {
    tags: string | string[];
    tables: string | string[] | Table<any> | Table<any>[];
  }): Promise<void> {
    const tagsArray = params.tags
      ? Array.isArray(params.tags)
        ? params.tags
        : [params.tags]
      : [];
    const tablesArray = params.tables
      ? Array.isArray(params.tables)
        ? params.tables
        : [params.tables]
      : [];

    const keysToDelete = new Set<string>();

    for (const table of tablesArray) {
      const tableName = is(table, Table)
        ? getTableName(table)
        : (table as string);
      const keys = this.usedTablesPerKey[tableName] ?? [];
      for (const key of keys) keysToDelete.add(key);
    }

    if (keysToDelete.size > 0 || tagsArray.length > 0) {
      for (const tag of tagsArray) {
        await this.kv.delete(tag);
      }

      for (const key of keysToDelete) {
        await this.kv.delete(key);
        for (const table of tablesArray) {
          const tableName = is(table, Table)
            ? getTableName(table)
            : (table as string);
          this.usedTablesPerKey[tableName] = [];
        }
      }
    }
  }
}
```

## é™åˆ¶

#### ä¸ä¼šè¢« `cache` æ‰©å±•å¤„ç†çš„æŸ¥è¯¢ï¼š

- ä½¿ç”¨åŸå§‹æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ï¼Œä¾‹å¦‚ï¼š

```ts
db.execute(sql`select 1`);
```

- åœ¨ `d1` å’Œ `libsql` ä¸­ä½¿ç”¨ `batch` åŠŸèƒ½æ—¶ä½¿ç”¨ç¼“å­˜

```ts
db.batch([
    db.insert(users).values(...),
    db.update(users).set(...).where()
])
```

- åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨ç¼“å­˜
```ts
await db.transaction(async (tx) => {
  await tx.update(accounts).set(...).where(...);
  await tx.update...
});
```

#### ç›®å‰æ˜¯ä¸´æ—¶é™åˆ¶ï¼Œç¨åå°†å¤„ç†ï¼š

- ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ—¶ä½¿ç”¨ç¼“å­˜
```ts
await db.query.users.findMany();
```

- ä¸ `better-sqlite3`ã€`Durable Objects`ã€`expo sqlite` ä¸€èµ·ä½¿ç”¨ç¼“å­˜
- ä¸ AWS æ•°æ® API é©±åŠ¨ç¨‹åºä¸€èµ·ä½¿ç”¨ç¼“å­˜
- ä¸è§†å›¾ä¸€èµ·ä½¿ç”¨ç¼“å­˜

Source: https://drizzle.zhcndoc.com/docs/column-types/cockroach


import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';

<Callout type='error'>
æœ¬é¡µä»‹ç»è‡ª drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠä»¥ä¸Šæ”¯æŒçš„æ¦‚å¿µã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

æˆ‘ä»¬å¯¹æ‰€æœ‰ç±»å‹éƒ½æä¾›äº†åŸç”Ÿæ”¯æŒï¼Œä½†å¦‚æœè¿™è¿˜ä¸èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæ¬¢è¿åˆ›å»º **[è‡ªå®šä¹‰ç±»å‹](/docs/custom-types)**ã€‚

<Callout title='é‡è¦' type='warning'>
æœ¬éƒ¨åˆ†æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç¤ºä¾‹å‡æœªä½¿ç”¨æ•°æ®åº“åˆ—ååˆ«åï¼Œåˆ—åå‡ç”± TypeScript çš„é”®ç”Ÿæˆã€‚

å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ•°æ®åº“åˆ«åä½œä¸ºåˆ—åï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `casing` å‚æ•°ä¸º Drizzle å®šä¹‰æ˜ å°„ç­–ç•¥ã€‚

æ›´å¤šå†…å®¹è¯·æŸ¥é˜… [è¿™é‡Œ](/docs/sql-schema-declaration#shape-your-data-schema)
</Callout>

### bigint
`int` `int8` `int64` `integer`

å¸¦ç¬¦å·çš„ 8 å­—èŠ‚æ•´æ•°     

å¦‚æœé¢„æœŸå€¼åœ¨ 2^31 ä»¥ä¸Šä½†ä½äº 2^53ï¼Œå¯ä»¥ä½¿ç”¨ `mode: 'number'`ï¼Œæ­¤æ—¶ä½¿ç”¨ JavaScript çš„ number è€Œé bigintã€‚
<Section>
```typescript
import { bigint, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	bigint: bigint({ mode: 'number' })
});

// å°†æ¨æ–­ä¸º `number`
bigint: bigint({ mode: 'number' })

// å°†æ¨æ–­ä¸º `bigint`
bigint: bigint({ mode: 'bigint' })
```

```sql
CREATE TABLE "table" (
	"bigint" bigint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { bigint, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	bigint1: bigint().default(10),
	bigint2: bigint().default(sql`'10'::bigint`)
});
```

```sql
CREATE TABLE "table" (
	"bigint1" bigint DEFAULT 10,
	"bigint2" bigint DEFAULT '10'::bigint
);
```
</Section>

### smallint
`smallint` `int2`  
å¸¦ç¬¦å·çš„ 2 å­—èŠ‚å°èŒƒå›´æ•´æ•°   

<Section>
```typescript
import { smallint, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	smallint: smallint()
});
```

```sql
CREATE TABLE "table" (
	"smallint" smallint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { smallint, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	smallint1: smallint().default(10),
	smallint2: smallint().default(sql`'10'::smallint`)
});
```

```sql
CREATE TABLE "table" (
	"smallint1" smallint DEFAULT 10,
	"smallint2" smallint DEFAULT '10'::smallint
);
```
</Section>

### int4

å¸¦ç¬¦å·çš„ 4 å­—èŠ‚æ•´æ•°     

<Section>
```typescript
import { int4, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	int4: int4()
});

```

```sql
CREATE TABLE "table" (
	"int4" int4
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { int4, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	int1: int4().default(10),
	int2: int4().default(sql`'10'::int4`)
});
```

```sql
CREATE TABLE "table" (
	"int1" int4 DEFAULT 10,
	"int2" int4 DEFAULT '10'::int4
);
```
</Section>


### int8

æ˜¯ **[bigint](#bigint)** çš„åˆ«å

### int2

æ˜¯ **[smallint](#smallint)** çš„åˆ«å

### ---

### bool
Cockroach æä¾›äº†æ ‡å‡†çš„ SQL ç±»å‹ boolã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒå®˜æ–¹ Cockroach **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/bool)**

<Section>
```typescript
import { bool, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	boolean: bool()
});

```

```sql
CREATE TABLE "table" (
	"boolean" bool
);
```
</Section>

## ---

### string
`text` `varchar`ï¼Œ`char`

`STRING` æ•°æ®ç±»å‹å­˜å‚¨ Unicode å­—ç¬¦ä¸²ã€‚

<Callout>
ä¸ºå…¼å®¹ PostgreSQLï¼ŒCockroachDB æ”¯æŒä»¥ä¸‹ STRING ç›¸å…³ç±»å‹åŠå…¶åˆ«åï¼š

`VARCHAR`ï¼ˆåŠå…¶åˆ«å `CHARACTER VARYING`ï¼‰  
`CHAR`ï¼ˆåŠå…¶åˆ«å `CHARACTER`ï¼‰  
`NAME`
</Callout>

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/string)**
  
æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ**ä¸ä¼š**æ£€æŸ¥è¿è¡Œæ—¶çš„å€¼ã€‚
<Section>
```typescript
import { string, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
  stringColumn: string(), // ç­‰åŒäº PostgreSQL çš„ `text` ç±»å‹
  stringColumn1: string({ length: 256 }), // ç­‰åŒäº PostgreSQL çš„ `varchar(256)` ç±»å‹
});

// å°†æ¨æ–­ä¸º text: "value1" | "value2" | null
stringColumn: string({ enum: ["value1", "value2"] })
```

```sql
CREATE TABLE "table" (
	"stringColumn" string,
    "stringColumn1" string(256),
);
```
</Section>

### text

CockroachDB å¯¹ `STRING` ç±»å‹çš„åˆ«åï¼š

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/string)**
  
æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ**ä¸ä¼š**æ£€æŸ¥è¿è¡Œæ—¶çš„å€¼ã€‚
<Section>
```typescript
import { text, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
  text: text()
});

// å°†æ¨æ–­ä¸º text: "value1" | "value2" | null
text: text({ enum: ["value1", "value2"] })
```

```sql
CREATE TABLE "table" (
	"text" text
);
```
</Section>

### varchar
`character varying(n)` `varchar(n)`  

`STRING` åˆ«åï¼Œç”¨äºä¿æŒä¸ PostgreSQL å…¼å®¹

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/string)**

æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ**ä¸ä¼š**æ£€æŸ¥è¿è¡Œæ—¶çš„å€¼ã€‚

`length` å‚æ•°ä¸ºå¯é€‰ï¼Œä¾æ® PostgreSQL æ–‡æ¡£ã€‚
<Section>
```typescript
import { varchar, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
  varchar1: varchar(),
  varchar2: varchar({ length: 256 }),
});

// å°†æ¨æ–­ä¸º text: "value1" | "value2" | null
varchar: varchar({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE "table" (
	"varchar1" varchar,
	"varchar2" varchar(256)
);
```
</Section>

### char
`character(n)` `char(n)`  

`STRING` åˆ«åï¼Œç”¨äºä¿æŒä¸ PostgreSQL å…¼å®¹

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/string)**

æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ**ä¸ä¼š**æ£€æŸ¥è¿è¡Œæ—¶çš„å€¼ã€‚

`length` å‚æ•°ä¸ºå¯é€‰ï¼Œä¾æ® PostgreSQL æ–‡æ¡£ã€‚
<Section>
```typescript
import { char, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
  char1: char(),
  char2: char({ length: 256 }),
});

// å°†æ¨æ–­ä¸º text: "value1" | "value2" | null
char: char({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE "table" (
	"char1" char,
	"char2" char(256)
);
```
</Section>

## ---

https://www.cockroachlabs.com/docs/stable/float

### decimal

`numeric` `decimal` `dec`  
DECIMAL æ•°æ®ç±»å‹å­˜å‚¨ç²¾ç¡®çš„å®šç‚¹æ•°å­—ã€‚å½“éœ€è¦ä¿æŒç²¾ç¡®åº¦ï¼ˆä¾‹å¦‚è´§å¸æ•°æ®ï¼‰æ—¶ä½¿ç”¨è¯¥ç±»å‹ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/decimal)**

<Section>
```typescript
import { decimal, cockroachTable } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
  decimal1: decimal(),
  decimal2: decimal({ precision: 100 }),
  decimal3: decimal({ precision: 100, scale: 20 }),
  decimalNum: decimal({ mode: 'number' }),
  decimalBig: decimal({ mode: 'bigint' }),
});
```

```sql
CREATE TABLE "table" (
	"decimal1" decimal,
	"decimal2" decimal(100),
	"decimal3" decimal(100, 20),
	"decimalNum" decimal,
	"decimalBig" decimal
);
```
</Section>

### numeric
æ˜¯ **[decimal](#decimal)** çš„åˆ«å

### float
`float` `float8` `double precision`  

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/float)**  

<Section>
```typescript
import { sql } from "drizzle-orm";
import { float, cockroachTable } from "drizzle-orm/cockroach-core";  

const table = cockroachTable('table', {
	float1: float(),
	float2: float().default(10.10),
	float3: float().default(sql`'10.10'::float`),
});
```

```sql
CREATE TABLE "table" (
	"float1" float,
	"float2" float default 10.10,
	"float3" float default '10.10'::float
);
```
</Section>

### real
`real` `float4`  
å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ4 å­—èŠ‚ï¼‰

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/float)**  

<Section>
```typescript
import { sql } from "drizzle-orm";
import { real, cockroachTable } from "drizzle-orm/cockroach-core";  

const table = cockroachTable('table', {
	real1: real(),
	real2: real().default(10.10),
	real3: real().default(sql`'10.10'::real`),
});
```

```sql
CREATE TABLE "table" (
	"real1" real,
	"real2" real default 10.10,
	"real3" real default '10.10'::real
);
```
</Section>

### double precision

æ˜¯ **[float](#float)** çš„åˆ«å

## ---

### jsonb
`jsonb`  

JSONB æ•°æ®ç±»å‹ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨ JSONï¼ˆJavaScript å¯¹è±¡è¡¨ç¤ºæ³•ï¼‰æ•°æ®ï¼Œæ¶ˆé™¤ç©ºç™½ç¬¦ã€é‡å¤é”®å’Œé”®æ’åºã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/jsonb)**
<Section>
```typescript
import { jsonb, cockroachTable } from "drizzle-orm/cockroach-core";

const table = cockroachTable('table', {
	jsonb1: jsonb(),
	jsonb2: jsonb().default({ foo: "bar" }),
	jsonb3: jsonb().default(sql`'{foo: "bar"}'::jsonb`),
});
```
```sql
CREATE TABLE "table" (
	"jsonb1" jsonb,
	"jsonb2" jsonb default '{"foo": "bar"}'::jsonb,
	"jsonb3" jsonb default '{"foo": "bar"}'::jsonb
);
```
</Section>

æ‚¨å¯ä»¥ä¸º JSON å¯¹è±¡æ¨æ–­æŒ‡å®š `.$type<..>()` ç±»å‹ï¼Œä½†å®ƒ**ä¸ä¼š**æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚  
æ­¤æ–¹å¼ä¸ºé»˜è®¤å€¼ã€æ’å…¥åŠæŸ¥è¯¢ schema æä¾›äº†ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚

```typescript
// å°†æ¨æ–­ä¸º { foo: string }
jsonb: jsonb().$type<{ foo: string }>();

// å°†æ¨æ–­ä¸º string[]
jsonb: jsonb().$type<string[]>();

// ä¸ä¼šç¼–è¯‘é€šè¿‡
jsonb: jsonb().$type<string[]>().default({});
```

## ---

### bit
`bit`  

BIT æ•°æ®ç±»å‹å­˜å‚¨ä½æ•°ç»„ã€‚BIT ç±»å‹é•¿åº¦å›ºå®šã€‚

<br />

**å¤§å°**

BIT çš„ä½æ•°æ ¹æ®å¦‚ä¸‹ç¡®å®šï¼š

| ç±»å‹å£°æ˜		| é€»è¾‘å¤§å°	|
|:------------------		|:--------------	|
| BIT						| 1 ä½				|
| BIT(N)					| N ä½			|

<br />

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/bit)**
<Section>
```typescript
import { sql } from "drizzle-orm";
import { cockroachTable, bit } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	bit1: bit(),
	bit2: bit({ length: 15 }),
	bit3: bit({ length: 15 }).default('10011'),
	bit4: bit({ length: 15 }).default(sql`'10011'`)
});
```
```sql
CREATE TABLE "table" (
	"bit1" bit,
	"bit2" bit(15),
	"bit3" bit(15) DEFAULT '10011',
	"bit4" bit(15) DEFAULT '10011'
);

```
</Section>

### varbit
`varbit`

VARBIT æ•°æ®ç±»å‹å­˜å‚¨ä½æ•°ç»„ã€‚VARBIT ç±»å‹é•¿åº¦å¯å˜ã€‚

<br />

**å¤§å°**

VARBIT çš„ä½æ•°æ ¹æ®å¦‚ä¸‹ç¡®å®šï¼š

| ç±»å‹å£°æ˜		| é€»è¾‘å¤§å°													|
|:------------------		|:--------------											|
| VARBIT					| å˜é‡é•¿åº¦ï¼Œæ— æœ€å¤§å€¼											|
| VARBIT(N)					| å˜é‡é•¿åº¦ï¼Œæœ€å¤§ä¸º N ä½										|

<br />

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/bit)**
<Section>
```typescript
import { sql } from "drizzle-orm";
import { cockroachTable, bit } from "drizzle-orm/cockroach-core";

export const table = cockroachTable('table', {
	varbit1: varbit(),
	varbit2: varbit({ length: 15 }),
	varbit3: varbit({ length: 15 }).default('10011'),
	varbit4: varbit({ length: 15 }).default(sql`'10011'`)
});
```
```sql
CREATE TABLE "table" (
	"varbit1" varbit,
	"varbit2" varbit(15),
	"varbit3" varbit(15) DEFAULT '10011',
	"varbit4" varbit(15) DEFAULT '10011'
);
```

</Section>

## ---

### uuid
`uuid`

UUIDï¼ˆå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰æ•°æ®ç±»å‹å­˜å‚¨ 128 ä½å€¼ï¼Œä¿è¯ç©ºé—´å’Œæ—¶é—´ä¸Šçš„å”¯ä¸€æ€§ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/uuid)**

```ts
import { uuid, cockroachTable } from "drizzle-orm/cockroach-core";

const table = cockroachTable('table', {
  uuid1: uuid(),
  uuid2: uuid().defaultRandom(),
  uuid3: uuid().default('a0ee-bc99-9c0b-4ef8-bb6d-6bb9-bd38-0a11')
});
```

```sql
CREATE TABLE "table" (
	"uuid1" uuid,
	"uuid2" uuid default gen_random_uuid(),
	"uuid3" uuid default 'a0ee-bc99-9c0b-4ef8-bb6d-6bb9-bd38-0a11'
);
```

## ---

### time
`time` `timetz` `time with timezone` `time without timezone`  

`TIME` æ•°æ®ç±»å‹å­˜å‚¨ UTC æ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼‰ã€‚  
`TIMETZ` æ•°æ®ç±»å‹å­˜å‚¨å¸¦æœ‰æ—¶åŒºåå·®çš„ UTC æ—¶é—´ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/time)**

<Section>
```typescript
import { time, cockroachTable } from "drizzle-orm/cockroach-core";

const table = cockroachTable('table', {
  time1: time(),
  time2: time({ withTimezone: true }),
  time3: time({ precision: 6 }),
  time4: time({ precision: 6, withTimezone: true })
});
```

```sql
CREATE TABLE "table" (
	"time1" time,
	"time2" time with timezone,
	"time3" time(6),
	"time4" time(6) with timezone
);
```
</Section>

### timestamp
`timestamp` `timestamptz` `timestamp with time zone` `timestamp without time zone`  

TIMESTAMP å’Œ TIMESTAMPTZ æ•°æ®ç±»å‹å­˜å‚¨ UTC çš„æ—¥æœŸå’Œæ—¶é—´ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/timestamp)**
<Section>
```typescript
import { sql } from "drizzle-orm";
import { timestamp, cockroachTable } from "drizzle-orm/cockroach-core";

const table = cockroachTable('table', {
  timestamp1: timestamp(),
	timestamp2: timestamp({ precision: 6, withTimezone: true }),
	timestamp3: timestamp().defaultNow(),
	timestamp4: timestamp().default(sql`now()`),
});
```
```sql
CREATE TABLE "table" (
	"timestamp1" timestamp,
	"timestamp2" timestamp (6) with time zone,
	"timestamp3" timestamp default now(),
	"timestamp4" timestamp default now()
);
```
</Section>

å¯æŒ‡å®š `date` æˆ– `string` æ¨æ–­æ¨¡å¼ï¼š
```typescript
// å°†æ¨æ–­ä¸º date ç±»å‹
timestamp: timestamp({ mode: "date" }),

// å°†æ¨æ–­ä¸º string ç±»å‹
timestamp: timestamp({ mode: "string" }),
```

> `string` æ¨¡å¼ä¸ä¼šä¸ºæ‚¨è¿›è¡Œä»»ä½•æ˜ å°„ã€‚æ·»åŠ æ­¤æ¨¡å¼æ˜¯ä¸ºå¼€å‘è€…æä¾›è‡ªè¡Œå¤„ç†æ—¥æœŸåŠæ˜ å°„çš„å¯èƒ½æ€§ï¼Œ  
å–å†³äºä»–ä»¬çš„éœ€è¦ã€‚Drizzle ä¼šä»¥å­—ç¬¦ä¸²å½¢å¼å°†æ—¥æœŸåŸæ ·ä¼ é€’ç»™æ•°æ®åº“å¹¶ä»æ•°æ®åº“æ¥æ”¶ï¼Œ  
å› æ­¤è¡Œä¸ºåº”å°½å¯èƒ½å¯é¢„æµ‹ï¼Œå¹¶ä¸”å®Œå…¨ç¬¦åˆæ•°æ®åº“è¡Œä¸ºã€‚

> `date` æ¨¡å¼ä¸ºå¸¸è§„å¤„ç†æ—¥æœŸçš„æ–¹å¼ã€‚Drizzle ä¼šè´Ÿè´£æ•°æ®åº“ä¸ JS Date å¯¹è±¡é—´çš„æ‰€æœ‰æ˜ å°„ã€‚

### date
`date`  

DATE æ•°æ®ç±»å‹å­˜å‚¨å¹´æœˆæ—¥ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/date)**
<Section>
```typescript
import { date, cockroachTable } from "drizzle-orm/cockroach-core";

const table = cockroachTable('table', {
	date: date(),
});
```

```sql
CREATE TABLE "table" (
	"date" date
);
```
</Section>
å¯æŒ‡å®š `date` æˆ– `string` æ¨æ–­æ¨¡å¼ï¼š
```typescript
// å°†æ¨æ–­ä¸º date ç±»å‹
date: date({ mode: "date" }),

// å°†æ¨æ–­ä¸º string ç±»å‹
date: date({ mode: "string" }),
```
### interval
`interval`  

å­˜å‚¨è¡¨ç¤ºä¸€æ®µæ—¶é—´è·¨åº¦çš„å€¼ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/interval)** 

<Section>
```typescript
import { interval, cockroachTable } from "drizzle-orm/cockroach-core";

const table = cockroachTable('table', {
	interval1: interval(),
  interval2: interval({ fields: 'day' }),
  interval3: interval({ fields: 'month' , precision: 6 }),
});

```

```sql
CREATE TABLE "table" (
	"interval1" interval,
	"interval2" interval day,
	"interval3" interval(6) month
);
```
</Section>

## ---

### enum 
`enum` `enumerated types`  
æšä¸¾ï¼ˆenumï¼‰ç±»å‹æ˜¯åŒ…å«é™æ€ã€æœ‰åºå€¼é›†åˆçš„æ•°æ®ç±»å‹ã€‚  
å®ƒä»¬ç­‰åŒäºå¤šç§ç¼–ç¨‹è¯­è¨€æ”¯æŒçš„æšä¸¾ç±»å‹ã€‚  
ç¤ºä¾‹åŒ…æ‹¬ä¸€å‘¨çš„æ˜ŸæœŸå‡ ï¼Œæˆ–æŸé¡¹æ•°æ®çš„ä¸€ç»„çŠ¶æ€å€¼ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ CockroachDB å®˜æ–¹ **[æ–‡æ¡£.](https://www.cockroachlabs.com/docs/stable/enum)**
<Section>
```typescript
import { cockroachEnum, cockroachTable } from "drizzle-orm/cockroach-core";

export const moodEnum = cockroachEnum('mood', ['sad', 'ok', 'happy']);

export const table = cockroachTable('table', {
  mood: moodEnum(),
});
```

```sql
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

CREATE TABLE "table" (
	"mood" mood
);
```
</Section>

## ---

### è‡ªå®šä¹‰æ•°æ®ç±»å‹
æ¯ä¸ªåˆ—æ„å»ºå™¨éƒ½æœ‰ä¸€ä¸ª `.$type()` æ–¹æ³•ï¼Œå¯ç”¨äºè‡ªå®šä¹‰åˆ—çš„æ•°æ®ç±»å‹ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºæœªçŸ¥æˆ–å¸¦å“ç‰Œçš„ç±»å‹éå¸¸æœ‰ç”¨ï¼š
```ts
type UserId = number & { __brand: 'user_id' };
type Data = {
	foo: string;
	bar: number;
};

const users = cockroachTable('users', {
  id: int().$type<UserId>().primaryKey(),
  jsonField: json().$type<Data>(),
});
```

### èº«ä»½åˆ—

<Callout type="info">
ä½¿ç”¨æ­¤åŠŸèƒ½éœ€è¦ `drizzle-orm@0.32.0` åŠä»¥ä¸Šç‰ˆæœ¬å’Œ `drizzle-kit@0.23.0` åŠä»¥ä¸Šç‰ˆæœ¬
</Callout>

PostgreSQL å’Œ CockroachDB æ”¯æŒèº«ä»½åˆ—ï¼Œä½œä¸ºè‡ªåŠ¨ç”Ÿæˆåˆ—å”¯ä¸€æ•´æ•°å€¼çš„æ–¹å¼ã€‚è¿™äº›å€¼ä½¿ç”¨åºåˆ—ç”Ÿæˆï¼Œå¹¶å¯é€šè¿‡ GENERATED AS IDENTITY å­å¥å®šä¹‰ã€‚

**èº«ä»½åˆ—ç±»å‹**
- `GENERATED ALWAYS AS IDENTITY`ï¼šæ•°æ®åº“æ€»æ˜¯è‡ªåŠ¨ç”Ÿæˆåˆ—çš„å€¼ï¼Œé™¤éä½¿ç”¨ OVERRIDING SYSTEM VALUEï¼Œå¦åˆ™ä¸å…è®¸æ‰‹åŠ¨æ’å…¥æˆ–æ›´æ–°è¯¥åˆ—ã€‚
- `GENERATED BY DEFAULT AS IDENTITY`ï¼šæ•°æ®åº“é»˜è®¤ç”Ÿæˆå€¼ï¼Œä½†ä¹Ÿå…è®¸æ‰‹åŠ¨æ’å…¥æˆ–æ›´æ–°è¯¥å€¼ã€‚è‹¥æä¾›æ‰‹åŠ¨å€¼ï¼Œå°†ä¼˜å…ˆä½¿ç”¨ã€‚

**ç¤ºä¾‹**
```ts
import { pgTable, integer, text } from 'drizzle-orm/pg-core' 

export const ingredients = pgTable("ingredients", {
  id: integer().primaryKey().generatedAlwaysAsIdentity({ startWith: 1000 }),
  name: text().notNull(),
  description: text(),
});
```

æ‚¨å¯ä»¥åœ¨ `.generatedAlwaysAsIdentity()` å‡½æ•°ä¸­æŒ‡å®šåºåˆ—çš„æ‰€æœ‰å±æ€§ï¼Œä¹Ÿå¯ä»¥ä¸ºåºåˆ—æŒ‡å®šè‡ªå®šä¹‰åç§°ã€‚

PostgreSQL æ–‡æ¡£ [å‚è€ƒ](https://www.postgresql.org/docs/current/sql-createtable.html#SQL-CREATETABLE-PARMS-GENERATED-IDENTITY)ã€‚

### é»˜è®¤å€¼
`DEFAULT` å­å¥æŒ‡å®šå½“ç”¨æˆ·æ‰§è¡Œ `INSERT` æ—¶ï¼Œå¦‚æœæœªæ˜¾å¼æä¾›åˆ—å€¼ï¼Œä½¿ç”¨çš„é»˜è®¤å€¼ã€‚  
å¦‚æœåˆ—å®šä¹‰æœªé™„å¸¦æ˜¾å¼çš„ `DEFAULT` å­å¥ï¼Œåˆ™è¯¥åˆ—çš„é»˜è®¤å€¼ä¸º `NULL`ã€‚

æ˜¾å¼çš„ `DEFAULT` å­å¥å¯æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€å­—ç¬¦ä¸²å¸¸é‡ã€äºŒè¿›åˆ¶å¸¸é‡ã€å¸¦ç¬¦å·æ•°å­—ï¼Œæˆ–æ‹¬å·å†…çš„ä»»ä½•å¸¸é‡è¡¨è¾¾å¼ã€‚

<Section>
```typescript
import { sql } from "drizzle-orm";
import { integer, pgTable, uuid } from "drizzle-orm/pg-core";

const table = pgTable('table', {
	integer1: integer().default(42),
	integer2: integer().default(sql`'42'::integer`),
	uuid1: uuid().defaultRandom(),
	uuid2: uuid().default(sql`gen_random_uuid()`),
});
```

```sql
CREATE TABLE IF NOT EXISTS "table" (
	"integer1" integer DEFAULT 42,
	"integer2" integer DEFAULT '42'::integer,
	"uuid1" uuid DEFAULT gen_random_uuid(),
	"uuid2" uuid DEFAULT gen_random_uuid()
);
```
</Section>

ä½¿ç”¨ `$default()` æˆ– `$defaultFn()`ï¼ˆä¸¤è€…æ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åï¼‰æ—¶ï¼Œ  
å¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ’å…¥æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚

è¿™äº›å‡½æ•°å¯ä»¥å¸®åŠ©æ‚¨åˆ©ç”¨å„ç§å®ç°ï¼Œå¦‚ `uuid`ã€`cuid`ã€`cuid2` ç­‰ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥é»˜è®¤å€¼ä¸å½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œä»…ç”¨äº `drizzle-orm` çš„è¿è¡Œæ—¶
</Callout>

```ts
import { text, pgTable } from "drizzle-orm/pg-core";
import { createId } from '@paralleldrive/cuid2';

const table = pgTable('table', {
	id: text().$defaultFn(() => createId()),
});
```

ä½¿ç”¨ `$onUpdate()` æˆ– `$onUpdateFn()`ï¼ˆä¸¤è€…æ˜¯åŒä¸€å‡½æ•°ä¸åŒåˆ«åï¼‰æ—¶ï¼Œ  
å¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ›´æ–°æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚

ä¸ºåˆ—æ·»åŠ åŠ¨æ€æ›´æ–°å€¼ã€‚å½“è¡Œè¢«æ›´æ–°æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼Œè‹¥æ²¡æœ‰æä¾›æ–°å€¼ï¼Œåˆ™ä½¿ç”¨å‡½æ•°è¿”å›å€¼ä½œä¸ºåˆ—å€¼ã€‚  
è‹¥æœªæä¾›é»˜è®¤å€¼ï¼ˆæˆ– $defaultFnï¼‰ï¼Œåˆ™è¯¥å‡½æ•°åœ¨æ’å…¥è¡Œæ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œè¿”å›å€¼ç”¨ä½œåˆ—å€¼ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸å½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œä»…ç”¨äº `drizzle-orm` çš„è¿è¡Œæ—¶
</Callout>

```ts
import { integer, timestamp, text, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
	updateCounter: integer().default(sql`1`).$onUpdateFn((): SQL => sql`${table.update_counter} + 1`),
	updatedAt: timestamp({ mode: 'date', precision: 3 }).$onUpdate(() => new Date()),
    	alwaysNull: text().$type<string | null>().$onUpdate(() => null),
});
```


### éç©º
`NOT NULL` çº¦æŸè¡¨ç¤ºå¯¹åº”åˆ—ä¸èƒ½åŒ…å« `NULL` å€¼ã€‚

<Section>
```typescript
import { integer, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
	integer: integer().notNull(),
});
```

```sql
CREATE TABLE IF NOT EXISTS "table" (
	"integer" integer NOT NULL
);
```
</Section>


### ä¸»é”®
ä¸»é”®çº¦æŸè¡¨ç¤ºä¸€åˆ—æˆ–å¤šåˆ—å¯ä½œä¸ºè¡¨ä¸­è¡Œçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œ  
è¦æ±‚è¿™äº›å€¼æ—¢å”¯ä¸€ä¸”éç©ºã€‚
<Section>
```typescript
import { serial, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
	id: serial().primaryKey(),
});
```

```sql
CREATE TABLE IF NOT EXISTS "table" (
	"id" serial PRIMARY KEY NOT NULL
);
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/column-types/mssql


import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';

<Callout type='error'>
æœ¬é¡µè¯´æ˜çš„æ˜¯ drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠæ›´é«˜ç‰ˆæœ¬æ”¯æŒçš„æ¦‚å¿µã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

æˆ‘ä»¬å¯¹æ‰€æœ‰è¿™äº›ç±»å‹éƒ½æä¾›äº†åŸç”Ÿæ”¯æŒï¼Œå¦‚æœè¿™äº›è¿˜ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œæ¬¢è¿åˆ›å»º **[è‡ªå®šä¹‰ç±»å‹](/docs/custom-types)**ã€‚

<Callout title='é‡è¦' type='warning'>
æœ¬éƒ¨åˆ†æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç¤ºä¾‹å‡æœªä½¿ç”¨æ•°æ®åº“åˆ—ååˆ«åï¼Œåˆ—åç”± TypeScript é”®è‡ªåŠ¨ç”Ÿæˆã€‚

å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨åˆ—åä¸­ä½¿ç”¨æ•°æ®åº“åˆ«åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `casing` å‚æ•°ä¸º Drizzle å®šä¹‰æ˜ å°„ç­–ç•¥ã€‚

ä½ å¯ä»¥åœ¨æ­¤å¤„äº†è§£æ›´å¤šç›¸å…³å†…å®¹ [here](/docs/sql-schema-declaration#shape-your-data-schema)
</Callout>

### int
æœ‰ç¬¦å· 4 å­—èŠ‚æ•´æ•°     

<Section>
```typescript
import { int, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	int: int()
});

```

```sql
CREATE TABLE [table] (
	[int] int
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { int, mssqlTable } from "drizzle-orm/mssql-core";

export const table = pgTable('table', {
	int1: int().default(10),
});

```

```sql
CREATE TABLE [table] (
	[int1] int DEFAULT 10
);
```
</Section>

### smallint
`smallint`

å°èŒƒå›´æœ‰ç¬¦å· 2 å­—èŠ‚æ•´æ•°   

<Section>
```typescript
import { smallint, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	smallint: smallint()
});
```

```sql
CREATE TABLE [table] (
	[smallint] smallint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { smallint, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	smallint1: smallint().default(10),
});
```

```sql
CREATE TABLE [table] (
	[smallint1] smallint DEFAULT 10
);
```
</Section>

### tinyint
`tinyint`

å°èŒƒå›´æœ‰ç¬¦å· 1 å­—èŠ‚æ•´æ•°   

<Section>
```typescript
import { tinyint, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	tinyint: tinyint()
});
```

```sql
CREATE TABLE [table] (
	[tinyint] tinyint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { tinyint, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	tinyint1: tinyint().default(10),
});
```

```sql
CREATE TABLE [table] (
	[tinyint1] tinyint DEFAULT 10
);
```
</Section>

### bigint
`bigint`

æœ‰ç¬¦å· 8 å­—èŠ‚æ•´æ•°  

å¦‚æœé¢„æœŸå€¼å¤§äº 2^31 ä½†å°äº 2^53ï¼Œå¯ä»¥ä½¿ç”¨ `mode: 'number'`ï¼Œè¿™æ ·å¯¹æ¥çš„æ˜¯ JavaScript `number` ç±»å‹è€Œé bigintã€‚
<Section>
```typescript
import { bigint, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	bigint: bigint({ mode: 'number' })
});

// ç±»å‹æ¨æ–­ä¸º `number`
bigint: bigint({ mode: 'number' })

// ç±»å‹æ¨æ–­ä¸º `bigint`
bigint: bigint({ mode: 'bigint' })

// ç±»å‹æ¨æ–­ä¸º `string`
bigint: bigint({ mode: 'string' })
```

```sql
CREATE TABLE [table] (
	[bigint] bigint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { bigint, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	bigint1: bigint({ mode: 'number' }).default(10)
});
```

```sql
CREATE TABLE [table] (
	[bigint1] bigint DEFAULT 10
);
```
</Section>

## ---

### bit

ä¸€ç§æ•´æ•°æ•°æ®ç±»å‹ï¼Œå€¼å¯ä»¥ä¸º `1`ã€`0` æˆ– `NULL`

Drizzle å…è®¸ä½¿ç”¨ `true` æˆ– `false` ä»£æ›¿ `1` å’Œ `0`

<Section>
```typescript
import { bit, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
	bit: bit()
});

```

```sql
CREATE TABLE [table] (
	[bit] bit
);
```
</Section>

## ---

### text
`text`  
æœåŠ¡å™¨ä»£ç é¡µä¸­çš„å˜é•¿é Unicode æ•°æ®ï¼Œæœ€å¤§å­—ç¬¦ä¸²é•¿åº¦ä¸º 2^31 - 1ï¼ˆ2,147,483,647ï¼‰

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/ntext-text-and-image-transact-sql?view=sql-server-ver17#text)**
  
å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œ**ä¸ä¼š**åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚
<Section>
```typescript
import { text, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  text: text()
});

// ç±»å‹æ¨æ–­ä¸º text: "value1" | "value2" | null
text: text({ enum: ["value1", "value2"] })
```

```sql
CREATE TABLE [table] (
	[text] text
);
```
</Section>

### ntext
`ntext`  
å˜é•¿ Unicode æ•°æ®ï¼Œæœ€å¤§å­—ç¬¦ä¸²é•¿åº¦ä¸º 2^30 - 1ï¼ˆ1,073,741,823ï¼‰ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/ntext-text-and-image-transact-sql?view=sql-server-ver17#text)**
  
å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œ**ä¸ä¼š**åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚
<Section>
```typescript
import { ntext, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  ntext: ntext()
});

// ç±»å‹æ¨æ–­ä¸º text: "value1" | "value2" | null
ntext: ntext({ enum: ["value1", "value2"] })
```

```sql
CREATE TABLE [table] (
	[ntext] ntext
);
```
</Section>

### varchar
`varchar(n|max)`  
å˜é•¿å­—ç¬¦ä¸²æ•°æ®ã€‚n æŒ‡å®šå­—ç¬¦ä¸²å¤§å°ï¼ˆå•ä½å­—èŠ‚ï¼‰ï¼Œå¯ä» 1 åˆ° 8,000 ä¹‹é—´ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/char-and-varchar-transact-sql?view=sql-server-ver17#varchar---n--max--)**

å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œ**ä¸ä¼š**åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚

æ ¹æ® MSSQL æ–‡æ¡£ï¼Œ`length` å‚æ•°ä¸ºå¯é€‰ã€‚
<Section>
```typescript
import { varchar, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  varchar1: varchar(),
  varchar2: varchar({ length: 256 }),
  varchar3: varchar({ length: 'max' })
});

// ç±»å‹æ¨æ–­ä¸º text: "value1" | "value2" | null
varchar: varchar({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE [table] (
	[varchar1] varchar,
	[varchar2] varchar(256),
	[varchar3] varchar(max)
);
```
</Section>

### nvarchar
`nvarchar(n|max)`  
å˜é•¿å­—ç¬¦ä¸²æ•°æ®ã€‚n æŒ‡å®šå­—ç¬¦ä¸²å¤§å°ï¼ˆå•ä½å­—èŠ‚å¯¹ï¼‰

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/nchar-and-nvarchar-transact-sql?view=sql-server-ver17#nvarchar---n--max--)**

å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œ**ä¸ä¼š**åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚

æ ¹æ® MSSQL æ–‡æ¡£ï¼Œ`length` å‚æ•°ä¸ºå¯é€‰ã€‚
<Section>
```typescript
import { nvarchar, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  nvarchar1: nvarchar(),
  nvarchar2: nvarchar({ length: 256 }),
});

// ç±»å‹æ¨æ–­ä¸º text: "value1" | "value2" | null
nvarchar: nvarchar({ enum: ["value1", "value2"] }),

// ç±»å‹æ¨æ–­ä¸º `json`
nvarchar: nvarchar({ mode: 'json' })
```

```sql
CREATE TABLE [table] (
	[nvarchar1] nvarchar,
	[nvarchar2] nvarchar(256)
);
```
</Section>

### char
`char(n)`  

å®šé•¿å­—ç¬¦ä¸²æ•°æ®ã€‚n æŒ‡å®šå­—ç¬¦ä¸²å¤§å°ï¼ˆå•ä½å­—èŠ‚ï¼‰ï¼Œå¿…é¡»æ˜¯ 1 åˆ° 8,000 ä¹‹é—´çš„å€¼ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/char-and-varchar-transact-sql?view=sql-server-ver17#char---n--)**

å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œ**ä¸ä¼š**åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚

æ ¹æ® MSSQL æ–‡æ¡£ï¼Œ`length` å‚æ•°ä¸ºå¯é€‰ã€‚
<Section>
```typescript
import { char, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  char1: char(),
  char2: char({ length: 256 }),
});

// ç±»å‹æ¨æ–­ä¸º text: "value1" | "value2" | null
char: char({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE [table] (
	[char1] char,
	[char2] char(256)
);
```
</Section>

### nchar
`nchar(n)`  

å®šé•¿å­—ç¬¦ä¸²æ•°æ®ã€‚n æŒ‡å®šå­—ç¬¦ä¸²å¤§å°ï¼ˆå•ä½å­—èŠ‚å¯¹ï¼‰ï¼Œå¿…é¡»æ˜¯ 1 åˆ° 4,000 ä¹‹é—´çš„å€¼ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/nchar-and-nvarchar-transact-sql?view=sql-server-ver17#nchar---n--)**

å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œ**ä¸ä¼š**åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚

æ ¹æ® MSSQL æ–‡æ¡£ï¼Œ`length` å‚æ•°ä¸ºå¯é€‰ã€‚
<Section>
```typescript
import { nchar, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  nchar1: nchar(),
  nchar2: nchar({ length: 256 }),
});

// ç±»å‹æ¨æ–­ä¸º text: "value1" | "value2" | null
nchar: nchar({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE [table] (
	[nchar1] nchar,
	[nchar2] nchar(256)
);
```
</Section>

## ---

### binary

å®šé•¿äºŒè¿›åˆ¶æ•°æ®ï¼Œé•¿åº¦ä¸º n å­—èŠ‚ï¼Œn çš„å–å€¼èŒƒå›´ä¸º 1 åˆ° 8,000ã€‚å­˜å‚¨å¤§å°ä¸º n å­—èŠ‚ã€‚

<Section>
```typescript
import { binary, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	binary: binary(),
	binary1: binary({ length: 256 })
});
```

```sql
CREATE TABLE [table] (
	[binary] binary,
	[binary1] binary(256)
);
```
</Section>

### varbinary

å˜é•¿äºŒè¿›åˆ¶æ•°æ®ã€‚n å¯ä»¥æ˜¯ 1 åˆ° 8,000 ä¹‹é—´çš„å€¼ã€‚max è¡¨ç¤ºæœ€å¤§å­˜å‚¨å¤§å°ä¸º 2^31-1 å­—èŠ‚ã€‚

<Section>
```typescript
import { varbinary, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	varbinary: varbinary(),
	varbinary1: varbinary({ length: 256 }),
	varbinary2: varbinary({ length: 'max' })
});
```

```sql
CREATE TABLE [table] (
	[varbinary] varbinary,
	[varbinary1] varbinary(256),
	[varbinary2] varbinary(max)
);
```
</Section>

## ---

### numeric
`numeric`

å›ºå®šç²¾åº¦å’Œå°æ•°ä½æ•°å­—ã€‚å½“ä½¿ç”¨æœ€å¤§ç²¾åº¦æ—¶ï¼Œåˆæ³•å€¼èŒƒå›´ä¸º -10^38 + 1 è‡³ 10^38 - 1ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/decimal-and-numeric-transact-sql?view=sql-server-ver17#decimal---p---s----and-numeric---p---s---)**

<Section>
```typescript
import { numeric, mssqlTable } from "drizzle-orm/mssql-core";

export const table = mssqlTable('table', {
  numeric1: numeric(),
  numeric2: numeric({ precision: 100 }),
  numeric3: numeric({ precision: 100, scale: 20 })
//   numericNum: numeric({ mode: 'number' }),
//   numericBig: numeric({ mode: 'bigint' }),
});
```

```sql
CREATE TABLE [table] (
	[numeric1] numeric,
	[numeric2] numeric(100),
	[numeric3] numeric(100, 20)
);
```
</Section>

### decimal
**[numeric](#numeric)** ç±»å‹åˆ«å

### real

real çš„ ISO åŒä¹‰è¯æ˜¯ float(24)ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/float-and-real-transact-sql?view=sql-server-ver17)**  

<Section>
```typescript
import { sql } from "drizzle-orm";
import { real, mssqlTable } from "drizzle-orm/mssql-core";  

const table = mssqlTable('table', {
	real1: real(),
	real2: real().default(10.10)
});
```

```sql
CREATE TABLE [table] (
	[real1] real,
	[real2] real default 10.10
);
```
</Section>

### float

float [ (n) ]ï¼Œå…¶ä¸­ n è¡¨ç¤ºç”¨äºå­˜å‚¨ä»¥ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤ºçš„æµ®ç‚¹æ•°å°¾æ•°çš„ä½æ•°ï¼Œå†³å®šäº†ç²¾åº¦å’Œå­˜å‚¨å¤§å°ã€‚è‹¥æŒ‡å®š nï¼Œå…¶å€¼å¿…é¡»åœ¨ 1 åˆ° 53 ä¹‹é—´ã€‚é»˜è®¤å€¼ä¸º 53ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/float-and-real-transact-sql?view=sql-server-ver17#syntax)**  

<Section>
```typescript
import { sql } from "drizzle-orm";
import { float, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	float1: float(),
	float1: float({ precision: 16 })
});
```

```sql
CREATE TABLE [table] (
	[float1] float,
	[float2] float(16)
);
```
</Section>

## ---

### time
`time`

å®šä¹‰ä¸€å¤©ä¸­çš„æ—¶é—´ã€‚æ­¤æ—¶é—´æ— æ—¶åŒºä¿¡æ¯ï¼Œæ˜¯åŸºäº 24 å°æ—¶åˆ¶çš„ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/time-transact-sql?view=sql-server-ver17#time-description)**

<Section>
```typescript
import { time, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
  time1: time(),
  time2: time({ mode: 'string' }),
  time3: time({ precision: 6 }),
  time4: time({ precision: 6, mode: 'date' })
});
```

```sql
CREATE TABLE [table] (
	[time1] time,
	[time2] time,
	[time3] time(6),
	[time4] time(6)
);
```
</Section>

### date
`date`  

æ—¥å†æ—¥æœŸï¼ˆå¹´ã€æœˆã€æ—¥ï¼‰

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/date-transact-sql?view=sql-server-ver17#date-description)**
<Section>
```typescript
import { date, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	date: date(),
});
```

```sql
CREATE TABLE [table] (
	[date] date
);
```
</Section>
å¯ä»¥æŒ‡å®šæ¨æ–­æ¨¡å¼ä¸º `date` æˆ– `string`ï¼š
```typescript
// æ¨æ–­ä¸º date ç±»å‹
date: date({ mode: "date" }),

// æ¨æ–­ä¸º string ç±»å‹
date: date({ mode: "string" }),
```

### datetime
`datetime`  

å®šä¹‰äº†æ—¥æœŸå’Œä¸€å¤©ä¸­çš„æ—¶é—´ï¼ˆå¯åŒ…å«ç§’çš„å°æ•°éƒ¨åˆ†ï¼‰ï¼ŒåŸºäº 24 å°æ—¶åˆ¶ã€‚

<Callout title='MSSQL æ–‡æ¡£'>
é¿å…ä¸ºæ–°å·¥ç¨‹ä½¿ç”¨ datetimeã€‚è¯·ä½¿ç”¨ timeã€dateã€datetime2 å’Œ datetimeoffset æ•°æ®ç±»å‹ã€‚è¿™äº›ç±»å‹ç¬¦åˆ SQL æ ‡å‡†ä¸”æ›´å…·å¯ç§»æ¤æ€§ã€‚timeã€datetime2 å’Œ datetimeoffset æä¾›æ›´é«˜çš„ç§’çº§ç²¾åº¦ã€‚datetimeoffset æ”¯æŒæ—¶åŒºï¼Œé€‚åˆå…¨çƒéƒ¨ç½²åº”ç”¨ã€‚
</Callout>

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetime-transact-sql?view=sql-server-ver17#description)**
<Section>
```typescript
import { datetime, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	datetime: datetime(),
});
```

```sql
CREATE TABLE [table] (
	[datetime] datetime
);
```
</Section>
å¯ä»¥æŒ‡å®šæ¨æ–­æ¨¡å¼ä¸º `date` æˆ– `string`ï¼š
```typescript
// æ¨æ–­ä¸º date ç±»å‹
datetime: datetime({ mode: "date" }),

// æ¨æ–­ä¸º string ç±»å‹
datetime: datetime({ mode: "string" }),
```

### datetime2
`datetime2`  

å®šä¹‰äº†æ—¥æœŸå’Œä¸€å¤©ä¸­çš„æ—¶é—´ï¼ŒåŸºäº 24 å°æ—¶åˆ¶ã€‚datetime2 æ˜¯ç°æœ‰ datetime ç±»å‹çš„æ‰©å±•ï¼Œå…·æœ‰æ›´å¤§çš„æ—¥æœŸèŒƒå›´ã€æ›´é«˜çš„é»˜è®¤ç§’åˆ†æ•°ç²¾åº¦ï¼Œä¸”æ”¯æŒç”¨æˆ·æŒ‡å®šç²¾åº¦ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetime2-transact-sql?view=sql-server-ver17#datetime2-description)**
<Section>
```typescript
import { datetime2, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	datetime2: datetime2(),
});
```

```sql
CREATE TABLE [table] (
	[datetime2] datetime2
);
```
</Section>
å¯ä»¥æŒ‡å®šæ¨æ–­æ¨¡å¼ä¸º `date` æˆ– `string`ï¼š
```typescript
// æ¨æ–­ä¸º date ç±»å‹
datetime2: datetime2({ mode: "date" }),

// æ¨æ–­ä¸º string ç±»å‹
datetime2: datetime2({ mode: "string" }),
```

### datetimeoffset
`datetimeoffset`  

å®šä¹‰äº†æ—¥æœŸå’Œä¸€å¤©ä¸­çš„æ—¶é—´ï¼ŒåŸºäº 24 å°æ—¶åˆ¶ï¼Œç±»ä¼¼ datetime2ï¼Œä½†å¢åŠ äº†åŸºäºåè°ƒä¸–ç•Œæ—¶ (UTC) çš„æ—¶åŒºä¿¡æ¯ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ MSSQL å®˜æ–¹ **[æ–‡æ¡£](https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql?view=sql-server-ver17#datetimeoffset-description)**
<Section>
```typescript
import { datetimeoffset, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	datetimeoffset: datetimeoffset(),
});
```

```sql
CREATE TABLE [table] (
	[datetimeoffset] datetimeoffset
);
```
</Section>
å¯ä»¥æŒ‡å®šæ¨æ–­æ¨¡å¼ä¸º `date` æˆ– `string`ï¼š
```typescript
// æ¨æ–­ä¸º date ç±»å‹
datetimeoffset: datetimeoffset({ mode: "date" }),

// æ¨æ–­ä¸º string ç±»å‹
datetimeoffset: datetimeoffset({ mode: "string" }),
```

## ---

### è‡ªå®šä¹‰æ•°æ®ç±»å‹
æ¯ä¸ªåˆ—æ„é€ å™¨éƒ½æœ‰ä¸€ä¸ª `.$type()` æ–¹æ³•ï¼Œå¯ä»¥ç”¨å®ƒè‡ªå®šä¹‰åˆ—çš„æ•°æ®ç±»å‹ã€‚

ä¾‹å¦‚ï¼Œå¯¹æœªçŸ¥ç±»å‹æˆ–å“ç‰Œç±»å‹éå¸¸æœ‰ç”¨ï¼š
```ts
type UserId = number & { __brand: 'user_id' };
type Data = {
	foo: string;
	bar: number;
};

const users = mssqlTable('users', {
  id: int().$type<UserId>().primaryKey(),
  jsonField: json().$type<Data>(),
});
```

### é»˜è®¤å€¼
`DEFAULT` å­å¥æŒ‡å®šå½“ç”¨æˆ·æ‰§è¡Œ `INSERT` æ—¶æœªæ˜¾å¼æä¾›è¯¥åˆ—å€¼æ—¶æ‰€ä½¿ç”¨çš„é»˜è®¤å€¼ã€‚
å¦‚æœåˆ—å®šä¹‰ä¸­æ²¡æœ‰æ˜¾å¼çš„ `DEFAULT` å­å¥ï¼Œåˆ™è¯¥åˆ—çš„é»˜è®¤å€¼ä¸º `NULL`ã€‚

æ˜¾å¼çš„ `DEFAULT` å­å¥å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€å­—ç¬¦ä¸²å¸¸é‡ã€äºŒè¿›åˆ¶å¸¸é‡ã€æœ‰ç¬¦å·æ•°å­—ï¼Œæˆ–ç”¨æ‹¬å·åŒ…è£¹çš„ä»»æ„å¸¸é‡è¡¨è¾¾å¼ã€‚

<Section>
```typescript
import { sql } from "drizzle-orm";
import { int, mssqlTable, text } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	integer: integer().default(42),
	text: text().default('text'),
});
```

```sql
CREATE TABLE [table] (
	[integer1] integer DEFAULT 42,
	[text] text DEFAULT 'text',
);
```
</Section>

ä½¿ç”¨ `$default()` æˆ– `$defaultFn()`ï¼ˆä¸¤è€…æ˜¯åŒä¸€ä¸ªå‡½æ•°çš„ä¸åŒåˆ«åï¼‰ï¼Œä½ å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ’å…¥ï¼ˆinsertï¼‰æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸ä¼šå½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œä»…åœ¨è¿è¡Œæ—¶ `drizzle-orm` ä¸­ç”Ÿæ•ˆã€‚
</Callout>

```ts
import { text, mssqlTable } from "drizzle-orm/mssql-core";
import { createId } from '@paralleldrive/cuid2';

const table = mssqlTable('table', {
	id: text().$defaultFn(() => createId()),
});
```

ä½¿ç”¨ `$onUpdate()` æˆ– `$onUpdateFn()`ï¼ˆä¸¤è€…æ˜¯åŒä¸€ä¸ªå‡½æ•°çš„ä¸åŒåˆ«åï¼‰ï¼Œä½ å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤çš„æ›´æ–°å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ›´æ–°ï¼ˆupdateï¼‰æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

è¯¥å‡½æ•°ä¼šåœ¨è¡Œæ›´æ–°æ—¶è°ƒç”¨ï¼Œå¦‚æœæœªæä¾›åˆ—å€¼ï¼Œåˆ™å‡½æ•°è¿”å›å€¼å°†ç”¨ä½œè¯¥åˆ—å€¼ã€‚
å¦‚æœæœªæä¾›é»˜è®¤å€¼ï¼ˆæˆ– $defaultFnï¼‰ï¼Œè¯¥å‡½æ•°åœ¨è¡Œæ’å…¥æ—¶ä¹Ÿä¼šè°ƒç”¨ï¼Œå¹¶è¿”å›è¯¥åˆ—çš„å€¼ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸ä¼šå½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œä»…åœ¨è¿è¡Œæ—¶ `drizzle-orm` ä¸­ç”Ÿæ•ˆã€‚
</Callout>

```ts
import { int, timestamp, text, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	updateCounter: int().default(sql`1`).$onUpdateFn((): SQL => sql`${table.update_counter} + 1`),
	updatedAt: timestamp({ mode: 'date', precision: 3 }).$onUpdate(() => new Date()),
    alwaysNull: text().$type<string | null>().$onUpdate(() => null),
});
```


### éç©º
`NOT NULL` çº¦æŸè§„å®šå…³è”åˆ—ä¸å¾—åŒ…å« `NULL` å€¼ã€‚

<Section>
```typescript
import { int, mssqlTable } from "drizzle-orm/mssql-core";

const table = mssqlTable('table', {
	int: int().notNull(),
});
```

```sql
CREATE TABLE [table] (
	[int] int NOT NULL
);
```
</Section>


### ä¸»é”®
ä¸»é”®çº¦æŸè¡¨æ˜ä¸€åˆ—æˆ–ä¸€ç»„åˆ—å¯ä»¥ä½œä¸ºè¡¨ä¸­è¡Œçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
è¿™è¦æ±‚å€¼å¿…é¡»å”¯ä¸€ä¸”éç©ºã€‚
<Section>
```typescript
import { int, mssqlTable } from "drizzle-orm/mssql-core";

const table = pgTable('table', {
	id: int().primaryKey(),
});
```

```sql
CREATE TABLE [table] (
	[id] int PRIMARY KEY
);
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/column-types/mysql

import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';

æˆ‘ä»¬å¯¹æ‰€æœ‰è¿™äº›ç±»å‹æä¾›åŸç”Ÿæ”¯æŒï¼Œå¦‚æœè¿™è¿˜ä¸è¶³ä»¥æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œè¯·éšæ„åˆ›å»º **[è‡ªå®šä¹‰ç±»å‹](/docs/custom-types)**ã€‚

<Callout title='important' type='warning'>
æœ¬éƒ¨åˆ†æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç¤ºä¾‹ä¸ä½¿ç”¨æ•°æ®åº“åˆ—ååˆ«åï¼Œåˆ—åæ˜¯æ ¹æ® TypeScript é”®ç”Ÿæˆçš„ã€‚

å¦‚æœä½ æƒ³ï¼Œå¯ä»¥åœ¨åˆ—åä¸­ä½¿ç”¨æ•°æ®åº“åˆ«åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `casing` å‚æ•°ä¸º Drizzle å®šä¹‰æ˜ å°„ç­–ç•¥ã€‚

ä½ å¯ä»¥åœ¨ [è¿™é‡Œ](/docs/sql-schema-declaration#shape-your-data-schema) é˜…è¯»æ›´å¤šä¿¡æ¯ã€‚
</Callout>

### æ•´æ•°

ä¸€ä¸ªæœ‰ç¬¦å·æ•´æ•°ï¼Œå­˜å‚¨åœ¨ `0`ã€`1`ã€`2`ã€`3`ã€`4`ã€`6` æˆ– `8` å­—èŠ‚ä¸­ï¼Œå…·ä½“å–å†³äºå€¼çš„å¤§å°ã€‚

<Section>
```typescript
import { int, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	int: int()
});
```

```sql
CREATE TABLE `table` (
	`int` int
);
```
</Section>

### tinyint

<Section>
```typescript
import { tinyint, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	tinyint: tinyint()
});
```

```sql
CREATE TABLE `table` (
	`tinyint` tinyint
);
```
</Section>

### smallint

<Section>
```typescript
import { smallint, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	smallint: smallint()
});
```

```sql
CREATE TABLE `table` (
	`smallint` smallint
);
```
</Section>

### mediumint

<Section>
```typescript
import { mediumint, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	mediumint: mediumint()
});
```

```sql
CREATE TABLE `table` (
	`mediumint` mediumint
);
```
</Section>

### bigint

<Section>
```typescript
import { bigint, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	bigint: bigint({ mode: 'number' })
	bigintUnsigned: bigint({ mode: 'number', unsigned: true })
});

bigint('...', { mode: 'number' | 'bigint' });

// ä½ è¿˜å¯ä»¥ä¸º bigint æŒ‡å®š unsigned é€‰é¡¹
bigint('...', { mode: 'number' | 'bigint', unsigned: true })
```

```sql
CREATE TABLE `table` (
	`bigint` bigint,
	`bigintUnsigned` bigint unsigned
);
```
</Section>

æˆ‘ä»¬çœç•¥äº† `bigint(M)` ä¸­çš„ `M` é…ç½®ï¼Œå› ä¸ºå®ƒè¡¨ç¤ºæ•°å­—ç±»å‹çš„æ˜¾ç¤ºå®½åº¦ã€‚

## ---

### real

<Section>
```typescript
import { real, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	real: real()
});
```

```sql
CREATE TABLE `table` (
	`real` real
);
```
</Section>

<Section>
```typescript
import { real, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	realPrecision: real({ precision: 1,}),
	realPrecisionScale: real({ precision: 1, scale: 1,}),
});
```

```sql
CREATE TABLE `table` (
	`realPrecision` real(1),
	`realPrecisionScale` real(1, 1)
);
```
</Section>

### decimal

<Section>
```typescript
import { decimal, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	decimal: decimal(),
	decimalNum: decimal({ scale: 30, mode: 'number' }),
	decimalBig: decimal({ scale: 30, mode: 'bigint' }),
});
```

```sql
CREATE TABLE `table` (
	`decimal` decimal,
	`decimalNum` decimal(30),
	`decimalBig` decimal(30)
);
```
</Section>

<Section>
```typescript
import { decimal, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	decimalPrecision: decimal({ precision: 1,}),
	decimalPrecisionScale: decimal({ precision: 1, scale: 1,}),
});
```

```sql
CREATE TABLE `table` (
	`decimalPrecision` decimal(1),
	`decimalPrecisionScale` decimal(1, 1)
);
```
</Section>

### double

<Section>
```typescript
import { double, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	double: double('double')
});
```

```sql
CREATE TABLE `table` (
	`double` double
);
```
</Section>

<Section>
```typescript
import { double, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	doublePrecision: double({ precision: 1,}),
	doublePrecisionScale: double({ precision: 1, scale: 1,}),
});
```

```sql
CREATE TABLE `table` (
	`doublePrecision` double(1),
	`doublePrecisionScale` double(1, 1)
);
```
</Section>

### float

<Section>
```typescript
import { float, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	float: float()
});
```

```sql
CREATE TABLE `table` (
	`float` float
);
```
</Section>

## ---

### serial

<Section>

`SERIAL` æ˜¯ `BIGINT UNSIGNED NOT NULL AUTO_INCREMENT UNIQUE` çš„åˆ«åã€‚

```typescript
import { serial, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	serial: serial()
});
```

```sql
CREATE TABLE `table` (
	`serial` serial AUTO_INCREMENT
);
```
</Section>

## ---

### binary
`BINARY(M)` stores a fixed-length byte string of exactly M bytes.  
On insert, shorter values are right-padded with `0x00` bytes to reach M bytes; on retrieval, no padding is stripped.
All bytesâ€”including trailing `0x00`â€”are significant in comparisons, `ORDER BY`, and `DISTINCT`
<Section>
```typescript
import { binary, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	binary: binary()
});
```

```sql
CREATE TABLE `table` (
	`binary` binary
);
```
</Section>

### varbinary
`VARBINARY(M)` stores a variable-length byte string of exactly M bytes.  
On insert, shorter values are right-padded with `0x00` bytes to reach M bytes; on retrieval, no padding is stripped.
All bytesâ€”including trailing `0x00`â€”are significant in comparisons, `ORDER BY`, and `DISTINCT`
<Section>
```typescript
import { varbinary, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	varbinary: varbinary({ length: 2}),
});
```

```sql
CREATE TABLE `table` (
	`varbinary` varbinary(2)
);
```
</Section>

## ---

### blob

<Callout type='warning'>
Available starting from `drizzle-orm@1.0.0-beta.2`
</Callout>

A `BLOB` is a binary large object that can hold a variable amount of data.
<Section>
```typescript
import { blob, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	blob: blob()
});
```

```sql
CREATE TABLE `table` (
	`blob` blob
);
```
</Section>

### tinyblob

<Callout type='warning'>
Available starting from `drizzle-orm@1.0.0-beta.2`
</Callout>

A `TINYBLOB` is a binary large object that can hold a variable amount of data.
<Section>
```typescript
import { tinyblob, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	tinyblob: tinyblob()
});
```

```sql
CREATE TABLE `table` (
	`tinyblob` tinyblob
);
```
</Section>

### mediumblob

<Callout type='warning'>
Available starting from `drizzle-orm@1.0.0-beta.2`
</Callout>

A `MEDIUMBLOB` is a binary large object that can hold a variable amount of data.
<Section>
```typescript
import { mediumblob, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	mediumblob: mediumblob()
});
```

```sql
CREATE TABLE `table` (
	`mediumblob` mediumblob
);
```
</Section>

### longblob

<Callout type='warning'>
Available starting from `drizzle-orm@1.0.0-beta.2`
</Callout>

A `LONGBLOB` is a binary large object that can hold a variable amount of data.
<Section>
```typescript
import { longblob, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	longblob: longblob()
});
```

```sql
CREATE TABLE `table` (
	`longblob` longblob
);
```
</Section>

## ---

### char

<Section>
```typescript
import { char, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	char: char(),
});
```

```sql
CREATE TABLE `table` (
	`char` char
);
```
</Section>

### varchar
ä½ å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶çš„å€¼ã€‚
<Section>
```typescript
import { varchar, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	varchar: varchar({ length: 2 }),
});

// å°†æ¨æ–­ä¸ºæ–‡æœ¬: "value1" | "value2" | null
varchar: varchar({ length: 6, enum: ["value1", "value2"] })
```

```sql
CREATE TABLE `table` (
	`varchar` varchar(2)
);
```
</Section>

### text

ä½ å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶çš„å€¼ã€‚

<Section>
```typescript
import { text, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	text: text(),
});

// å°†æ¨æ–­ä¸ºæ–‡æœ¬: "value1" | "value2" | null
text: text({ enum: ["value1", "value2"] });
```

```sql
CREATE TABLE `table` (
	`text` text
);
```
</Section>

## ---

### boolean

<Section>
```typescript
import { boolean, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	boolean: boolean(),
});
```

```sql
CREATE TABLE `table` (
	`boolean` boolean
);
```
</Section>

## ---

### date

<Section>
```typescript
import { boolean, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	date: date(),
});
```

```sql
CREATE TABLE `table` (
	`date` date
);
```
</Section>

### datetime

<Section>
```typescript
import { datetime, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	datetime: datetime(),
});

datetime('...', { mode: 'date' | "string"}),
datetime('...', { fsp : 0..6}),
```

```sql
CREATE TABLE `table` (
	`datetime` datetime
);
```
</Section>

<Section>
```typescript
import { datetime, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	datetime: datetime({ mode: 'date', fsp: 6 }),
});
```

```sql
CREATE TABLE `table` (
	`datetime` datetime(6)
);
```
</Section>

### time 

<Section>
```typescript
import { time, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	time: time(),
	timefsp: time({ fsp: 6 }),
});
	
time('...', { fsp: 0..6 }),
```

```sql
CREATE TABLE `table` (
	`time` time,
	`timefsp` time(6)
);
```
</Section>

### year

<Section>
```typescript
import { year, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	year: year(),
});
```

```sql
CREATE TABLE `table` (
	`year` year
);
```
</Section>

### timestamp

<Section>
```typescript
import { timestamp, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	timestamp: timestamp(),
});

timestamp('...', { mode: 'date' | "string"}),
timestamp('...', { fsp : 0..6}),
```

```sql
CREATE TABLE `table` (
	`timestamp` timestamp
);
```
</Section>

<Section>
```typescript
import { timestamp, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	timestamp: timestamp({ mode: 'date', fsp: 6 }),
});
```

```sql
CREATE TABLE `table` (
	`timestamp` timestamp(6)
);
```
</Section>

<Section>
```typescript
import { timestamp, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	timestamp: timestamp().defaultNow(),
});
```

```sql
CREATE TABLE `table` (
	`timestamp` timestamp DEFAULT (now())
);
```
</Section>

## ---

### json

<Section>
```typescript
import { json, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	json: json(),
});

```

```sql
CREATE TABLE `table` (
	`json` json
);
```
</Section>

ä½ å¯ä»¥æŒ‡å®š `.$type<..>()` è¿›è¡Œ json å¯¹è±¡æ¨æ–­ï¼Œå®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚
å®ƒåœ¨ç¼–è¯‘æ—¶æä¾›é»˜è®¤å€¼ã€æ’å…¥å’Œé€‰æ‹©æ¨¡å¼çš„ä¿æŠ¤ã€‚
```typescript
// å°†æ¨æ–­ä¸º { foo: string }
json: json().$type<{ foo: string }>();

// å°†æ¨æ–­ä¸º string[]
json: json().$type<string[]>();

// å°†æ— æ³•ç¼–è¯‘
json: json().$type<string[]>().default({});
```

## ---

### enum

<Section>
```typescript
import { mysqlEnum, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	popularity: mysqlEnum(['unknown', 'known', 'popular']),
});
```

```sql
CREATE TABLE `table` (
	`popularity` enum('unknown','known','popular')
);
```
</Section>

## ---

### è‡ªå®šä¹‰æ•°æ®ç±»å‹

æ¯ä¸ªåˆ—æ„å»ºå™¨éƒ½æœ‰ä¸€ä¸ª `.$type()` æ–¹æ³•ï¼Œå…è®¸ä½ è‡ªå®šä¹‰åˆ—çš„æ•°æ®ç±»å‹ã€‚è¿™åœ¨å¤„ç†æœªçŸ¥æˆ–å“ç‰Œç±»å‹æ—¶éå¸¸æœ‰ç”¨ã€‚

```ts
type UserId = number & { __brand: 'user_id' };
type Data = {
	foo: string;
	bar: number;
};

const users = mysqlTable('users', {
  id: int().$type<UserId>().primaryKey(),
  jsonField: json().$type<Data>(),
});
```

### éç©º
`NOT NULL` çº¦æŸè§„å®šç›¸å…³è”çš„åˆ—ä¸èƒ½åŒ…å« `NULL` å€¼ã€‚

<Section>
```typescript
import { int, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	int: int().notNull(),
});
```

```sql
CREATE TABLE `table` (
	`int` int NOT NULL
);
```
</Section>

### é»˜è®¤å€¼

`DEFAULT` å­å¥æŒ‡å®šåœ¨ç”¨æˆ·è¿›è¡Œ
`INSERT` æ—¶å¦‚æœä¸æ˜¾å¼æä¾›å€¼ï¼Œåˆ™ä½¿ç”¨çš„åˆ—çš„é»˜è®¤å€¼ã€‚
å¦‚æœæ²¡æœ‰æ˜¾å¼çš„ `DEFAULT` å­å¥é™„åŠ åˆ°åˆ—å®šä¹‰ï¼Œ
åˆ™åˆ—çš„é»˜è®¤å€¼ä¸º `NULL`ã€‚

ä¸€ä¸ªæ˜¾å¼çš„ `DEFAULT` å­å¥å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€
å­—ç¬¦ä¸²å¸¸é‡ã€blob å¸¸é‡ã€æœ‰ç¬¦å·æ•°å­—æˆ–ä»»ä½•ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„å¸¸é‡è¡¨è¾¾å¼ã€‚

<Section>
```typescript
import { int, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	int: int().default(3),
});
```

```sql
CREATE TABLE `table` (
	`int` int DEFAULT 3
);
```
</Section>

ä½¿ç”¨ `$default()` æˆ– `$defaultFn()` æ—¶ï¼Œå®ƒä»¬åªæ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åï¼Œ
ä½ å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ’å…¥æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚
è¿™äº›å‡½æ•°å¯ä»¥å¸®åŠ©ä½ åˆ©ç”¨å„ç§å®ç°ï¼Œä¾‹å¦‚ `uuid`ã€`cuid`ã€`cuid2` ç­‰ç­‰ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸ä¼šå½±å“ `drizzle-kit` è¡Œä¸ºï¼Œä»…åœ¨ `drizzle-orm` çš„è¿è¡Œæ—¶ä½¿ç”¨ã€‚
</Callout>

```ts
import { varchar, mysqlTable } from "drizzle-orm/mysql-core";
import { createId } from '@paralleldrive/cuid2';

const table = mysqlTable('table', {
	id: varchar({ length: 128 }).$defaultFn(() => createId()),
});
```

ä½¿ç”¨ `$onUpdate()` æˆ– `$onUpdateFn()` æ—¶ï¼Œå®ƒä»¬ä¹Ÿæ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åï¼Œ
ä½ å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ›´æ–°æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚

å‘åˆ—æ·»åŠ åŠ¨æ€æ›´æ–°å€¼ã€‚å½“æ›´æ–°è¡Œæ—¶å°†è°ƒç”¨è¯¥å‡½æ•°ï¼Œ
å¦‚æœæ²¡æœ‰æä¾›å€¼ï¼Œåˆ™è¿”å›çš„å€¼å°†ç”¨ä½œåˆ—å€¼ã€‚
å¦‚æœæœªæä¾›é»˜è®¤å€¼ï¼ˆæˆ– $defaultFnï¼‰ï¼Œåˆ™åœ¨æ’å…¥è¡Œæ—¶ä¹Ÿå°†è°ƒç”¨è¯¥å‡½æ•°ï¼Œ
å¹¶ä¸”è¿”å›çš„å€¼å°†ç”¨ä½œåˆ—å€¼ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸ä¼šå½±å“ `drizzle-kit` è¡Œä¸ºï¼Œä»…åœ¨ `drizzle-orm` çš„è¿è¡Œæ—¶ä½¿ç”¨ã€‚
</Callout>

```ts
import { text, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
    alwaysNull: text().$type<string | null>().$onUpdate(() => null),
});
```

### ä¸»é”® 

<Section>
```typescript
import { int, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	int: int().primaryKey(),
});
```

```sql
CREATE TABLE `table` (
	`int` int PRIMARY KEY NOT NULL
);
```
</Section>

### è‡ªå¢

<Section>
```typescript
import { int, mysqlTable } from "drizzle-orm/mysql-core";

const table = mysqlTable('table', {
	int: int().autoincrement(),
});
```

```sql
CREATE TABLE `table` (
	`int` int AUTO_INCREMENT
);
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/column-types/pg


import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';

æˆ‘ä»¬å¯¹æ‰€æœ‰è¿™äº›éƒ½æä¾›åŸç”Ÿæ”¯æŒï¼Œå¦‚æœè¿™äº›ä¸å¤Ÿæ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæ¬¢è¿åˆ›å»º **[è‡ªå®šä¹‰ç±»å‹](/docs/custom-types)**ã€‚

<Callout title='important' type='warning'>
æœ¬éƒ¨åˆ†æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç¤ºä¾‹éƒ½ä¸ä½¿ç”¨æ•°æ®åº“åˆ—ååˆ«åï¼Œåˆ—åæ˜¯ä» TypeScript é”®ç”Ÿæˆçš„ã€‚

å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨åˆ—åä¸­ä½¿ç”¨æ•°æ®åº“åˆ«åï¼Œå¹¶ä¸”æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `casing` å‚æ•°å®šä¹‰ Drizzle çš„æ˜ å°„ç­–ç•¥ã€‚

æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ](/docs/sql-schema-declaration#shape-your-data-schema) é˜…è¯»æ›´å¤šç›¸å…³ä¿¡æ¯ã€‚
</Callout>

### æ•´æ•°
`integer` `int` `int4`  
å¸¦ç¬¦å·çš„ 4 å­—èŠ‚æ•´æ•°

å¦‚æœæ‚¨éœ€è¦ `integer è‡ªå¢`ï¼Œè¯·å‚è€ƒ **[serial.](#serial)**

<Section>
```typescript
import { integer, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
    int: integer()
});

```

```sql
CREATE TABLE "table" (
	"int" integer
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { integer, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
	int1: integer().default(10),
    int2: integer().default(sql`'10'::int`)
});

```

```sql
CREATE TABLE "table" (
	"int1" integer DEFAULT 10,
    "int2" integer DEFAULT '10'::int
);
```
</Section>

### å°æ•´æ•°
`smallint` `int2`  
å°èŒƒå›´å¸¦ç¬¦å·çš„ 2 å­—èŠ‚æ•´æ•°

å¦‚æœæ‚¨éœ€è¦ `smallint è‡ªå¢`ï¼Œè¯·å‚è€ƒ **[smallserial.](#smallserial)**
<Section>
```typescript
import { smallint, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
    smallint: smallint()
});
```

```sql
CREATE TABLE "table" (
	"smallint" smallint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { smallint, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
	smallint1: smallint().default(10),
    smallint2: smallint().default(sql`'10'::smallint`)
});
```

```sql
CREATE TABLE "table" (
	"smallint1" smallint DEFAULT 10,
    "smallint2" smallint DEFAULT '10'::smallint
);
```
</Section>

### å¤§æ•´æ•°
`bigint` `int8`  
å¸¦ç¬¦å·çš„ 8 å­—èŠ‚æ•´æ•°

å¦‚æœæ‚¨éœ€è¦ `bigint è‡ªå¢`ï¼Œè¯·å‚è€ƒ **[bigserial.](#bigserial)**

å¦‚æœæ‚¨é¢„æœŸçš„å€¼åœ¨ 2^31 ä»¥ä¸Šä½†ä½äº 2^53ï¼Œå¯ä»¥åˆ©ç”¨ `mode: 'number'` å¹¶å¤„ç† JavaScript æ•°å­—è€Œä¸æ˜¯ bigintã€‚
<Section>
```typescript
import { bigint, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
    bigint: bigint({ mode: 'number' })
});

// å°†æ¨å¯¼ä¸º `number`
bigint: bigint({ mode: 'number' })

// å°†æ¨å¯¼ä¸º `bigint`
bigint: bigint({ mode: 'bigint' })
```

```sql
CREATE TABLE "table" (
	"bigint" bigint
);
```
</Section>

<Section>
```typescript
import { sql } from "drizzle-orm";
import { bigint, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
	bigint1: bigint().default(10),
    bigint2: bigint().default(sql`'10'::bigint`)
});
```

```sql
CREATE TABLE "table" (
	"bigint1" bigint DEFAULT 10,
    "bigint2" bigint DEFAULT '10'::bigint
);
```
</Section>

## ---

### è‡ªå¢æ•´æ•°
`serial` `serial4`  
è‡ªåŠ¨é€’å¢çš„ 4 å­—èŠ‚æ•´æ•°ï¼Œä¸ºåˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦åˆ—æä¾›ä¹¦é¢æ–¹ä¾¿ï¼ˆç±»ä¼¼äºä¸€äº›å…¶ä»–æ•°æ®åº“æ”¯æŒçš„ `AUTO_INCREMENT` å±æ€§ï¼‰ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL)**
<Section>
```typescript
import { serial, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  serial: serial(),
});
```

```sql
CREATE TABLE "table" (
	"serial" serial NOT NULL
);
```
</Section>

### å°è‡ªå¢æ•´æ•°
`smallserial` `serial2`  
è‡ªåŠ¨é€’å¢çš„ 2 å­—èŠ‚æ•´æ•°ï¼Œä¸ºåˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦åˆ—æä¾›ä¹¦é¢æ–¹ä¾¿ï¼ˆç±»ä¼¼äºä¸€äº›å…¶ä»–æ•°æ®åº“æ”¯æŒçš„ `AUTO_INCREMENT` å±æ€§ï¼‰ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL)**
<Section>
```typescript
import { smallserial, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  smallserial: smallserial(),
});
```

```sql
CREATE TABLE "table" (
	"smallserial" smallserial NOT NULL
);
```
</Section>

### å¤§è‡ªå¢æ•´æ•°
`bigserial` `serial8`  
è‡ªåŠ¨é€’å¢çš„ 8 å­—èŠ‚æ•´æ•°ï¼Œä¸ºåˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦åˆ—æä¾›ä¹¦é¢æ–¹ä¾¿ï¼ˆç±»ä¼¼äºä¸€äº›å…¶ä»–æ•°æ®åº“æ”¯æŒçš„ `AUTO_INCREMENT` å±æ€§ï¼‰ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL)**

å¦‚æœæ‚¨é¢„æœŸçš„å€¼åœ¨ 2^31 ä»¥ä¸Šä½†ä½äº 2^53ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨ `mode: 'number'` å¹¶å¤„ç† JavaScript æ•°å­—è€Œä¸æ˜¯ bigintã€‚
<Section>
```typescript
import { bigserial, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  bigserial: bigserial({ mode: 'number' }),
});
```

```sql
CREATE TABLE "table" (
	"bigserial" bigserial NOT NULL
);
```
</Section>

### ---

### å¸ƒå°”å€¼
PostgreSQL æä¾›æ ‡å‡† SQL ç±»å‹å¸ƒå°”å€¼ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-boolean.html)**

<Section>
```typescript
import { boolean, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
    boolean: boolean()
});

```

```sql
CREATE TABLE "table" (
	"boolean" boolean
);
```
</Section>

## ---

### bytea

PostgreSQL æä¾›æ ‡å‡† SQL ç±»å‹ byteaã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-binary.html)**

<Section>
```typescript
import { bytea, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
	bytea: bytea()
});

```

```sql
CREATE TABLE "table" (
	"bytea" bytea,
);
```
</Section>

## ---

### text
`text`  
å¯å˜é•¿åº¦ï¼ˆæ— é™åˆ¶ï¼‰å­—ç¬¦å­—ç¬¦ä¸²ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-character.html)**

æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®ä»¥æ¨å¯¼ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚
<Section>
```typescript
import { text, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  text: text()
});

// å°†æ¨å¯¼ä¸º text: "value1" | "value2" | null
text: text({ enum: ["value1", "value2"] })
```

```sql
CREATE TABLE "table" (
	"text" text
);
```
</Section>

### å¯å˜å­—ç¬¦
`character varying(n)` `varchar(n)`  
å¯å˜é•¿åº¦å­—ç¬¦å­—ç¬¦ä¸²ï¼Œå¯ä»¥å­˜å‚¨æœ€å¤š **`n`** ä¸ªå­—ç¬¦ï¼ˆä¸æ˜¯å­—èŠ‚ï¼‰ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-character.html)**

æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®ä»¥æ¨å¯¼ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚

æ ¹æ® PostgreSQL æ–‡æ¡£ï¼Œ`length` å‚æ•°æ˜¯å¯é€‰çš„ã€‚
<Section>
```typescript
import { varchar, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  varchar1: varchar(),
  varchar2: varchar({ length: 256 }),
});

// å°†æ¨å¯¼ä¸º text: "value1" | "value2" | null
varchar: varchar({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE "table" (
	"varchar1" varchar,
	"varchar2" varchar(256)
);
```
</Section>

### å›ºå®šå­—ç¬¦
`character(n)` `char(n)`  
å›ºå®šé•¿åº¦ï¼Œå¸¦ç©ºæ ¼å¡«å……çš„å­—ç¬¦å­—ç¬¦ä¸²ï¼Œå¯ä»¥å­˜å‚¨æœ€å¤š **`n`** ä¸ªå­—ç¬¦ï¼ˆä¸æ˜¯å­—èŠ‚ï¼‰ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-character.html)**

æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®ä»¥æ¨å¯¼ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚

æ ¹æ® PostgreSQL æ–‡æ¡£ï¼Œ`length` å‚æ•°æ˜¯å¯é€‰çš„ã€‚
<Section>
```typescript
import { char, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  char1: char(),
  char2: char({ length: 256 }),
});

// å°†æ¨å¯¼ä¸º text: "value1" | "value2" | null
char: char({ enum: ["value1", "value2"] }),
```

```sql
CREATE TABLE "table" (
	"char1" char,
	"char2" char(256)
);
```
</Section>

## ---

### æ•°å€¼
`numeric` `decimal`  
å¯é€‰ç²¾åº¦çš„ç²¾ç¡®æ•°å€¼ã€‚å¯ä»¥å­˜å‚¨å…·æœ‰éå¸¸å¤§æ•°å­—çš„æ•°å­—ï¼Œåœ¨å°æ•°ç‚¹å‰æœ€å¤šå¯è¾¾ 131072 ä½ï¼Œåæœ€å¤šå¯è¾¾ 16383 ä½ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-NUMERIC-DECIMAL)**

<Section>
```typescript
import { numeric, pgTable } from "drizzle-orm/pg-core";

export const table = pgTable('table', {
  numeric1: numeric(),
  numeric2: numeric({ precision: 100 }),
  numeric3: numeric({ precision: 100, scale: 20 }),
  numericNum: numeric({ mode: 'number' }),
  numericBig: numeric({ mode: 'bigint' }),
});
```

```sql
CREATE TABLE "table" (
	"numeric1" numeric,
	"numeric2" numeric(100),
	"numeric3" numeric(100, 20),
	"numericNum" numeric,
	"numericBig" numeric
);
```
</Section>

### åè¿›åˆ¶
**[numeric.](#numeric)** çš„åˆ«å

### å®æ•°
`real` `float4`  
å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ4 å­—èŠ‚ï¼‰

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-numeric.html)**  

<Section>
```typescript
import { sql } from "drizzle-orm";
import { real, pgTable } from "drizzle-orm/pg-core";  

const table = pgTable('table', {
    real1: real(),
    real2: real().default(10.10),
	real3: real().default(sql`'10.10'::real`),
});
```

```sql
CREATE TABLE "table" (
	"real1" real,
	"real2" real default 10.10,
	"real3" real default '10.10'::real
);
```
</Section>

### åŒç²¾åº¦
`double precision` `float8`  
åŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ8 å­—èŠ‚ï¼‰

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-numeric.html)**  

<Section>
```typescript
import { sql } from "drizzle-orm";
import { doublePrecision, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    double1: doublePrecision(),
    double2: doublePrecision().default(10.10),
    double3: doublePrecision().default(sql`'10.10'::double precision`),
});
```

```sql
CREATE TABLE "table" (
	"double1" double precision,
	"double2" double precision default 10.10,
	"double3" double precision default '10.10'::double precision
);
```
</Section>

## ---


### JSON
`json`  
æ–‡æœ¬ JSON æ•°æ®ï¼Œå¦‚ **[RFC 7159.](https://tools.ietf.org/html/rfc7159)** ä¸­æ‰€è§„å®šã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-json.html)**
<Section>
```typescript
import { sql } from "drizzle-orm";
import { json, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    json1: json(),
    json2: json().default({ foo: "bar" }),
    json3: json().default(sql`'{foo: "bar"}'::json`),
});
```

```sql
CREATE TABLE "table" (
	"json1" json,
	"json2" json default '{"foo": "bar"}'::json,
	"json3" json default '{"foo": "bar"}'::json
);
```
</Section>
  
æ‚¨å¯ä»¥æŒ‡å®š `.$type<..>()` è¿›è¡Œ JSON å¯¹è±¡æ¨å¯¼ï¼Œå®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚ 
å®ƒä¸ºé»˜è®¤å€¼ã€æ’å…¥å’Œé€‰æ‹© ÑÑ…ĞµĞ¼Ğ° æä¾›ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚
```typescript
// å°†æ¨å¯¼ä¸º { foo: string }
json: json().$type<{ foo: string }>();

// å°†æ¨å¯¼ä¸º string[]
json: json().$type<string[]>();

// ä¸ä¼šç¼–è¯‘
json: json().$type<string[]>().default({});
```

### JSONB
`jsonb`  
äºŒè¿›åˆ¶ JSON æ•°æ®ï¼Œå·²è§£æ„ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-json.html)**
<Section>
```typescript
import { jsonb, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    jsonb1: jsonb(),
    jsonb2: jsonb().default({ foo: "bar" }),
    jsonb3: jsonb().default(sql`'{foo: "bar"}'::jsonb`),
});
```
```sql
CREATE TABLE "table" (
	"jsonb1" jsonb,
	"jsonb2" jsonb default '{"foo": "bar"}'::jsonb,
	"jsonb3" jsonb default '{"foo": "bar"}'::jsonb
);
```
</Section>

æ‚¨å¯ä»¥æŒ‡å®š `.$type<..>()` è¿›è¡Œ JSON å¯¹è±¡æ¨å¯¼ï¼Œå®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚ 
å®ƒä¸ºé»˜è®¤å€¼ã€æ’å…¥å’Œé€‰æ‹© ÑÑ…ĞµĞ¼Ğ° æä¾›ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚

```typescript
// å°†æ¨å¯¼ä¸º { foo: string }
jsonb: jsonb().$type<{ foo: string }>();

// å°†æ¨å¯¼ä¸º string[]
jsonb: jsonb().$type<string[]>();

// ä¸ä¼šç¼–è¯‘
jsonb: jsonb().$type<string[]>().default({});
```

## ---

### uuid
`uuid`

UUID æ•°æ®ç±»å‹ï¼Œå­˜å‚¨ç¬¦åˆ RFC 4122ã€ISO/IEC 9834-8:2005 åŠç›¸å…³æ ‡å‡†çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-uuid.html)**

```ts
import { uuid, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
  uuid1: uuid(),
  uuid2: uuid().defaultRandom(),
  uuid3: uuid().default('a0ee-bc99-9c0b-4ef8-bb6d-6bb9-bd38-0a11')
});
```

```sql
CREATE TABLE "table" (
	"uuid1" uuid,
	"uuid2" uuid default gen_random_uuid(),
	"uuid3" uuid default 'a0ee-bc99-9c0b-4ef8-bb6d-6bb9-bd38-0a11'
);
```

## ---

### æ—¶é—´
`time` `timetz` `å¸¦æ—¶åŒºçš„æ—¶é—´` `ä¸å¸¦æ—¶åŒºçš„æ—¶é—´`  
ä¸€å¤©ä¸­çš„æ—¶é—´ï¼Œå¯ä»¥å¸¦æ—¶åŒºæˆ–ä¸å¸¦æ—¶åŒºã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-datetime.html)**

<Section>
```typescript
import { time, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
  time1: time(),
  time2: time({ withTimezone: true }),
  time3: time({ precision: 6 }),
  time4: time({ precision: 6, withTimezone: true })
});
```

```sql
CREATE TABLE "table" (
	"time1" time,
	"time2" time with timezone,
	"time3" time(6),
	"time4" time(6) with timezone
);
```
</Section>

### æ—¶é—´æˆ³
`timestamp` `timestamptz` `å¸¦æ—¶åŒºçš„æ—¶é—´æˆ³` `ä¸å¸¦æ—¶åŒºçš„æ—¶é—´æˆ³`  
å¸¦æ—¶åŒºæˆ–ä¸å¸¦æ—¶åŒºçš„æ—¥æœŸå’Œæ—¶é—´ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-datetime.html)**
<Section>
```typescript
import { sql } from "drizzle-orm";
import { timestamp, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    timestamp1: timestamp(),
    timestamp2: timestamp({ precision: 6, withTimezone: true }),
    timestamp3: timestamp().defaultNow(),
    timestamp4: timestamp().default(sql`now()`),
});
```
```sql
CREATE TABLE "table" (
	"timestamp1" timestamp,
	"timestamp2" timestamp (6) with time zone,
	"timestamp3" timestamp default now(),
	"timestamp4" timestamp default now()
);
```
</Section>

æ‚¨å¯ä»¥æŒ‡å®š `date` æˆ– `string` æ¨å¯¼æ¨¡å¼ï¼š
```typescript
// å°†æ¨å¯¼ä¸º date
timestamp: timestamp({ mode: "date" }),

// å°†æ¨å¯¼ä¸º string
timestamp: timestamp({ mode: "string" }),
```

> `string` æ¨¡å¼å¹¶ä¸ä¼šä¸ºæ‚¨æ‰§è¡Œä»»ä½•æ˜ å°„ã€‚
æ­¤æ¨¡å¼æ˜¯ä¸ºäº†è®©å¼€å‘è€…èƒ½å¤Ÿæ ¹æ®å…¶éœ€æ±‚è‡ªå·±å¤„ç†æ—¥æœŸå’Œæ—¥æœŸæ˜ å°„è€Œæ·»åŠ ç»™ Drizzle ORM çš„ã€‚
Drizzle å°†åŸæ ·ä¼ é€’åŸå§‹æ—¥æœŸä½œä¸ºå­—ç¬¦ä¸²ï¼Œ`to` å’Œ `from` æ•°æ®åº“ï¼Œ
å› æ­¤å…¶è¡Œä¸ºåº”å°½å¯èƒ½å¯é¢„æµ‹ï¼Œä¸”ä¸æ•°æ®åº“è¡Œä¸º 100% ä¸€è‡´ã€‚

> `date` æ¨¡å¼æ˜¯å¤„ç†æ—¥æœŸçš„å¸¸è§„æ–¹å¼ã€‚Drizzle å°†å¤„ç†æ•°æ®åº“å’Œ JS Date å¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰æ˜ å°„ã€‚

<Callout type='info' emoji='â„¹ï¸'>
 å¦‚ä½•æ˜ å°„ `timestamp` å’Œ `å¸¦æ—¶åŒºçš„æ—¶é—´æˆ³` çš„æ–¹å¼ï¼š

 æ­£å¦‚ PostgreSQL æ–‡æ¡£æ‰€è¿°ï¼š
 > åœ¨è¢«ç¡®å®šä¸ºä¸å¸¦æ—¶åŒºçš„æ—¶é—´æˆ³çš„å­—é¢é‡ä¸­ï¼ŒPostgreSQL å°†é™é»˜å¿½ç•¥ä»»ä½•æ—¶åŒºæŒ‡ç¤ºã€‚
 > ä¹Ÿå°±æ˜¯è¯´ï¼Œç»“æœå€¼æ˜¯æ ¹æ®è¾“å…¥å€¼ä¸­çš„æ—¥æœŸ/æ—¶é—´å­—æ®µå¾—å‡ºçš„ï¼Œå¹¶ä¸”æœªæ ¹æ®æ—¶åŒºè¿›è¡Œè°ƒæ•´ã€‚
 >
 > å¯¹äºå¸¦æ—¶åŒºçš„æ—¶é—´æˆ³æ¥è¯´ï¼Œå†…éƒ¨å­˜å‚¨çš„å€¼å§‹ç»ˆä¸º UTCï¼ˆåè°ƒä¸–ç•Œæ—¶é—´ï¼Œä¼ ç»Ÿä¸Šç§°ä¸ºæ ¼æ—å¨æ²»æ ‡å‡†æ—¶é—´ GMTï¼‰ã€‚
 æŒ‡å®šäº†æ˜¾å¼æ—¶åŒºçš„è¾“å…¥å€¼å°†ä½¿ç”¨è¯¥æ—¶åŒºçš„é€‚å½“åç§»é‡è½¬æ¢ä¸º UTCã€‚
 å¦‚æœè¾“å…¥å­—ç¬¦ä¸²ä¸­æœªæŒ‡å®šæ—¶åŒºï¼Œåˆ™å‡å®šå…¶åœ¨ç³»ç»Ÿçš„ TimeZone å‚æ•°æŒ‡ç¤ºçš„æ—¶åŒºï¼Œ
 å¹¶ä½¿ç”¨è¯¥æ—¶åŒºåŒºåŸŸçš„åç§»å€¼è½¬æ¢ä¸º UTCã€‚

 å› æ­¤ï¼Œå¯¹äº `å¸¦æ—¶åŒºçš„æ—¶é—´æˆ³`ï¼Œæ‚¨å°†æ”¶åˆ°è½¬æ¢ä¸ºæ‚¨ Postgres å®ä¾‹ä¸­è®¾ç½®çš„æ—¶åŒºçš„å­—ç¬¦ä¸²ã€‚
 æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ SQL æŸ¥è¯¢æ£€æŸ¥æ—¶åŒºï¼š 

```sql 
show timezone;
```


</Callout>

### æ—¥æœŸ
`date`  
æ—¥å†æ—¥æœŸï¼ˆå¹´ï¼Œæœˆï¼Œæ—¥ï¼‰

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-datetime.html)**
<Section>
```typescript
import { date, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    date: date(),
});
```

```sql
CREATE TABLE "table" (
	"date" date
);
```
</Section>
æ‚¨å¯ä»¥æŒ‡å®š `date` æˆ– `string` æ¨å¯¼æ¨¡å¼ï¼š
```typescript
// å°†æ¨å¯¼ä¸º date
date: date({ mode: "date" }),

// å°†æ¨å¯¼ä¸º string
date: date({ mode: "string" }),
```
### æ—¶é—´é—´éš”
`interval`  
æ—¶é—´è·¨åº¦

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-datetime.html)** 

<Section>
```typescript
import { interval, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    interval1: interval(),
    interval2: interval({ fields: 'day' }),
    interval3: interval({ fields: 'month' , precision: 6 }),
});

```

```sql
CREATE TABLE "table" (
	"interval1" interval,
	"interval2" interval day,
	"interval3" interval(6) month
);
```
</Section>

## ---

### ç‚¹
`point`  
å‡ ä½•ç‚¹ç±»å‹

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-geometric.html#DATATYPE-GEOMETRIC-POINTS)** 

ç±»å‹ `point` æœ‰ 2 ç§ä»æ•°æ®åº“æ˜ å°„çš„æ¨¡å¼ï¼š`tuple` å’Œ `xy`ã€‚

- `tuple` å°†è¢«æ¥å—æ’å…¥å¹¶åœ¨é€‰æ‹©æ—¶æ˜ å°„ä¸ºä¸€ä¸ªå…ƒç»„ã€‚å› æ­¤ï¼Œæ•°æ®åº“çš„ Point(1,2) å°†è¢« Drizzle è§†ä¸º [1, 2]ã€‚

- `xy` å°†è¢«æ¥å—æ’å…¥å¹¶åœ¨é€‰æ‹©æ—¶æ˜ å°„ä¸ºå…·æœ‰ xï¼Œy åæ ‡çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œæ•°æ®åº“çš„ Point(1,2) å°†è¢« Drizzle è§†ä¸º `{ x: 1, y: 2 }`ã€‚

<Section>
```typescript
const items = pgTable('items', {
    point: point(),
    pointObj: point({ mode: 'xy' }),
});
```

```sql
CREATE TABLE "items" (
	"point" point,
	"pointObj" point
);
```
</Section>

### çº¿
`line`  
å‡ ä½•çº¿ç±»å‹

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-geometric.html#DATATYPE-LINE)** 

ç±»å‹ `line` æœ‰ 2 ç§ä»æ•°æ®åº“æ˜ å°„çš„æ¨¡å¼ï¼š`tuple` å’Œ `abc`ã€‚

- `tuple` å°†è¢«æ¥å—æ’å…¥å¹¶åœ¨é€‰æ‹©æ—¶æ˜ å°„ä¸ºä¸€ä¸ªå…ƒç»„ã€‚å› æ­¤ï¼Œæ•°æ®åº“çš„ Line{1,2,3} å°†è¢« Drizzle è§†ä¸º [1,2,3]ã€‚

- `abc` å°†è¢«æ¥å—æ’å…¥å¹¶åœ¨é€‰æ‹©æ—¶æ˜ å°„ä¸ºå…·æœ‰æ–¹ç¨‹å¼ `Ax + By + C = 0` çš„å¸¸æ•° aï¼Œb å’Œ c çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œæ•°æ®åº“çš„ Line{1,2,3} å°†è¢« Drizzle è§†ä¸º `{ a: 1, b: 2, c: 3 }`ã€‚

<Section>
```typescript
const items = pgTable('items', {
    line: line(),
    lineObj: line({ mode: 'abc' }),
});
```

```sql
CREATE TABLE "items" (
	"line" line,
	"lineObj" line
);
```
</Section>

## ---

### æšä¸¾
`enum` `æšä¸¾ç±»å‹`  
æšä¸¾ï¼ˆenumï¼‰ç±»å‹æ˜¯ç”±é™æ€ã€æ’åºçš„ä¸€ç»„å€¼ç»„æˆçš„æ•°æ®ç±»å‹ã€‚ 
å®ƒä»¬ç­‰åŒäºè®¸å¤šç¼–ç¨‹è¯­è¨€æ”¯æŒçš„æšä¸¾ç±»å‹ã€‚ 
æšä¸¾ç±»å‹çš„ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯ä¸€å‘¨çš„å¤©æ•°ï¼Œæˆ–è€…ä¸€ç»„æ•°æ®çš„çŠ¶æ€å€¼ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostgreSQL **[æ–‡æ¡£.](https://www.postgresql.org/docs/current/datatype-enum.html)**
<Section>
```typescript
import { pgEnum, pgTable } from "drizzle-orm/pg-core";

export const moodEnum = pgEnum('mood', ['sad', 'ok', 'happy']);

export const table = pgTable('table', {
    mood: moodEnum(),
});
```

```sql
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

CREATE TABLE "table" (
	"mood" mood
);
```
</Section>

## ---

### è‡ªå®šä¹‰æ•°æ®ç±»å‹
æ¯ä¸ªåˆ—æ„å»ºå™¨éƒ½æœ‰ä¸€ä¸ª `.$type()` æ–¹æ³•ï¼Œå…è®¸æ‚¨è‡ªå®šä¹‰åˆ—çš„æ•°æ®ç±»å‹ã€‚

è¿™åœ¨å¤„ç†æœªçŸ¥æˆ–å“ç‰Œç±»å‹æ—¶å¾ˆæœ‰ç”¨ï¼š
```ts
type UserId = number & { __brand: 'user_id' };
type Data = {
    foo: string;
    bar: number;
};

const users = pgTable('users', {
    id: serial().$type<UserId>().primaryKey(),
    jsonField: json().$type<Data>(),
});
```

### èº«ä»½åˆ—

<Callout type="info">
è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œæ‚¨éœ€è¦å®‰è£… `drizzle-orm@0.32.0` æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥åŠ `drizzle-kit@0.23.0` æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
</Callout>

PostgreSQL æ”¯æŒèº«ä»½åˆ—ä½œä¸ºè‡ªåŠ¨ç”Ÿæˆåˆ—çš„å”¯ä¸€æ•´æ•°å€¼çš„æ–¹å¼ã€‚è¿™äº›å€¼æ˜¯ä½¿ç”¨åºåˆ—ç”Ÿæˆçš„ï¼Œå¯ä»¥ä½¿ç”¨ GENERATED AS IDENTITY å­å¥å®šä¹‰ã€‚

**èº«ä»½åˆ—çš„ç±»å‹**
- `GENERATED ALWAYS AS IDENTITY`: æ•°æ®åº“å§‹ç»ˆä¸ºåˆ—ç”Ÿæˆå€¼ã€‚é™¤éä½¿ç”¨ OVERRIDING SYSTEM VALUE å­å¥ï¼Œå¦åˆ™ä¸å…è®¸æ‰‹åŠ¨æ’å…¥æˆ–æ›´æ–°æ­¤åˆ—ã€‚
- `GENERATED BY DEFAULT AS IDENTITY`: æ•°æ®åº“é»˜è®¤ç”Ÿæˆä¸€ä¸ªå€¼ï¼Œä½†ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ’å…¥æˆ–æ›´æ–°å€¼ã€‚å¦‚æœæä¾›äº†æ‰‹åŠ¨å€¼ï¼Œå®ƒå°†æ›¿ä»£ç³»ç»Ÿç”Ÿæˆçš„å€¼ã€‚

**ä¸»è¦ç‰¹æ€§**
- è‡ªåŠ¨å€¼ç”Ÿæˆï¼šåˆ©ç”¨åºåˆ—ä¸ºæ¯ä¸ªæ–°è¡Œç”Ÿæˆå”¯ä¸€å€¼ã€‚
- å¯è‡ªå®šä¹‰åºåˆ—é€‰é¡¹ï¼šæ‚¨å¯ä»¥å®šä¹‰èµ·å§‹å€¼ã€å¢é‡å’Œå…¶ä»–åºåˆ—é€‰é¡¹ã€‚
- æ”¯æŒå¤šä¸ªèº«ä»½åˆ—ï¼šPostgreSQL å…è®¸æ¯ä¸ªè¡¨æœ‰å¤šä¸ªèº«ä»½åˆ—ã€‚

**é™åˆ¶**
- æ‰‹åŠ¨æ’å…¥é™åˆ¶ï¼šå¯¹äºå®šä¹‰ä¸º GENERATED ALWAYS AS IDENTITY çš„åˆ—ï¼Œæ‰‹åŠ¨æ’å…¥æˆ–æ›´æ–°éœ€è¦ä½¿ç”¨ OVERRIDING SYSTEM VALUE å­å¥ã€‚
- åºåˆ—çº¦æŸï¼šèº«ä»½åˆ—ä¾èµ–äºåºåˆ—ï¼Œå¿…é¡»æ­£ç¡®ç®¡ç†ä»¥é¿å…å†²çªæˆ–é—´éš”ã€‚

**ä½¿ç”¨ç¤ºä¾‹**
```ts
import { pgTable, integer, text } from 'drizzle-orm/pg-core'; 

export const ingredients = pgTable("ingredients", {
    id: integer().primaryKey().generatedAlwaysAsIdentity({ startWith: 1000 }),
    name: text().notNull(),
    description: text(),
});
```

æ‚¨å¯ä»¥åœ¨ `.generatedAlwaysAsIdentity()` å‡½æ•°ä¸­æŒ‡å®šåºåˆ—çš„æ‰€æœ‰å¯ç”¨å±æ€§ã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä¸ºè¿™äº›åºåˆ—æŒ‡å®šè‡ªå®šä¹‰åç§°ã€‚

[PostgreSQL æ–‡æ¡£å‚è€ƒ](https://www.postgresql.org/docs/current/sql-createtable.html#SQL-CREATETABLE-PARMS-GENERATED-IDENTITY)ã€‚

### é»˜è®¤å€¼
`DEFAULT` å­å¥æŒ‡å®šåœ¨ç”¨æˆ·æ‰§è¡Œ
`INSERT` æ—¶æœªæ˜¾å¼æä¾›å€¼çš„æƒ…å†µä¸‹ä½¿ç”¨çš„é»˜è®¤å€¼ã€‚
å¦‚æœåˆ—å®šä¹‰ä¸­æœªé™„åŠ æ˜¾å¼çš„ `DEFAULT` å­å¥ï¼Œ
åˆ™åˆ—çš„é»˜è®¤å€¼ä¸º `NULL`ã€‚

æ˜¾å¼çš„ `DEFAULT` å­å¥å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€
å­—ç¬¦ä¸²å¸¸é‡ã€blob å¸¸é‡ã€å¸¦ç¬¦å·çš„æ•°å­—æˆ–ç”¨æ‹¬å·æ‹¬èµ·çš„ä»»ä½•å¸¸é‡è¡¨è¾¾å¼ã€‚

<Section>
```typescript
import { sql } from "drizzle-orm";
import { integer, pgTable, uuid } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    integer1: integer().default(42),
    integer2: integer().default(sql`'42'::integer`),
    uuid1: uuid().defaultRandom(),
    uuid2: uuid().default(sql`gen_random_uuid()`),
});
```

```sql
CREATE TABLE "table" (
	"integer1" integer DEFAULT 42,
	"integer2" integer DEFAULT '42'::integer,
	"uuid1" uuid DEFAULT gen_random_uuid(),
	"uuid2" uuid DEFAULT gen_random_uuid()
);
```
</Section>

å½“ä½¿ç”¨ `$default()` æˆ– `$defaultFn()` æ—¶ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åªæ˜¯åŒä¸€ä¸ªå‡½æ•°çš„ä¸åŒåˆ«åï¼Œ 
æ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼å¹¶åœ¨æ‰€æœ‰æ’å…¥æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚

è¿™äº›å‡½æ•°å¯ä»¥å¸®åŠ©æ‚¨åˆ©ç”¨å„ç§å®ç°ï¼Œä¾‹å¦‚ `uuid`ã€`cuid`ã€`cuid2` ç­‰ç­‰ã€‚

<Callout type="info" emoji="â„¹ï¸">
    æ³¨æ„ï¼šæ­¤å€¼ä¸ä¼šå½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œå®ƒä»…åœ¨è¿è¡Œæ—¶ç”¨äº `drizzle-orm`ã€‚
</Callout>

```ts
import { text, pgTable } from "drizzle-orm/pg-core";
import { createId } from '@paralleldrive/cuid2';

const table = pgTable('table', {
    id: text().$defaultFn(() => createId()),
});
```

å½“ä½¿ç”¨ `$onUpdate()` æˆ– `$onUpdateFn()` æ—¶ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åªæ˜¯åŒä¸€ä¸ªå‡½æ•°çš„ä¸åŒåˆ«åï¼Œ 
æ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼å¹¶åœ¨æ‰€æœ‰æ›´æ–°æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚ 

å®ƒå‘åˆ—æ·»åŠ åŠ¨æ€æ›´æ–°å€¼ã€‚è¯¥å‡½æ•°å°†åœ¨è¡Œæ›´æ–°æ—¶è°ƒç”¨ï¼Œ
è¿”å›çš„å€¼å°†ç”¨ä½œåˆ—å€¼ï¼ˆå¦‚æœæœªæä¾›ï¼‰ã€‚
å¦‚æœæœªæä¾›é»˜è®¤å€¼ï¼ˆæˆ– $defaultFnï¼‰å€¼ï¼Œ
åˆ™è¯¥å‡½æ•°åœ¨è¡Œæ’å…¥æ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œè¿”å›çš„å€¼å°†ç”¨ä½œåˆ—å€¼ã€‚

<Callout type="info" emoji="â„¹ï¸">
    æ³¨æ„ï¼šæ­¤å€¼ä¸ä¼šå½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œå®ƒä»…åœ¨è¿è¡Œæ—¶ç”¨äº `drizzle-orm`ã€‚
</Callout>

```ts
import { integer, timestamp, text, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    updateCounter: integer().default(sql`1`).$onUpdateFn((): SQL => sql`${table.update_counter} + 1`),
    updatedAt: timestamp({ mode: 'date', precision: 3 }).$onUpdate(() => new Date()),
    alwaysNull: text().$type<string | null>().$onUpdate(() => null),
});
```


### éç©º
`NOT NULL` çº¦æŸè§„å®šç›¸å…³åˆ—ä¸å¾—åŒ…å« `NULL` å€¼ã€‚

<Section>
```typescript
import { integer, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    integer: integer().notNull(),
});
```

```sql
CREATE TABLE "table" (
	"integer" integer NOT NULL
);
```
</Section>


### ä¸»é”®
ä¸»é”®çº¦æŸè¡¨ç¤ºåˆ—æˆ–åˆ—ç»„å¯ç”¨ä½œè¡¨ä¸­è¡Œçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ 
è¿™è¦æ±‚å€¼æ—¢ç‹¬ç‰¹åˆéç©ºã€‚
<Section>
```typescript
import { serial, pgTable } from "drizzle-orm/pg-core";

const table = pgTable('table', {
    id: serial().primaryKey(),
});
```

```sql
CREATE TABLE "table" (
	"id" serial PRIMARY KEY NOT NULL
);
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/column-types/singlestore

import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';

æˆ‘ä»¬å¯¹æ‰€æœ‰ç±»å‹å‡æœ‰åŸç”Ÿæ”¯æŒï¼Œå¦‚æœè¿™äº›è¿˜ä¸èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œè¯·éšæ—¶åˆ›å»º **[è‡ªå®šä¹‰ç±»å‹](/docs/custom-types)**ã€‚

<Callout title='é‡è¦' type='warning'>
æœ¬ç« èŠ‚æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç¤ºä¾‹å‡æœªä½¿ç”¨æ•°æ®åº“åˆ—ååˆ«åï¼Œåˆ—åå‡ç”± TypeScript é”®åç”Ÿæˆã€‚

å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥åœ¨åˆ—åä¸­ä½¿ç”¨æ•°æ®åº“åˆ«åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `casing` å‚æ•°ä¸º Drizzle å®šä¹‰æ˜ å°„ç­–ç•¥ã€‚

æ‚¨å¯åœ¨æ­¤å¤„äº†è§£æ›´å¤šå†…å®¹ [here](/docs/sql-schema-declaration#shape-your-data-schema)
</Callout>

### integer

æœ‰ç¬¦å·æ•´æ•°ï¼Œæ ¹æ®å€¼çš„å¤§å°ï¼Œå­˜å‚¨åœ¨ `0`ã€`1`ã€`2`ã€`3`ã€`4`ã€`6` æˆ– `8` å­—èŠ‚ä¸­ã€‚

<Section>
```typescript
import { int, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	int: int()
});
```

```sql
CREATE TABLE `table` (
	`int` int
);
```
</Section>

### tinyint

<Section>
```typescript
import { tinyint, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	tinyint: tinyint()
});
```

```sql
CREATE TABLE `table` (
	`tinyint` tinyint
);
```
</Section>

### smallint

<Section>
```typescript
import { smallint, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	smallint: smallint()
});
```

```sql
CREATE TABLE `table` (
	`smallint` smallint
);
```
</Section>

### mediumint

<Section>
```typescript
import { mediumint, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	mediumint: mediumint()
});
```

```sql
CREATE TABLE `table` (
	`mediumint` mediumint
);
```
</Section>

### bigint

<Section>
```typescript
import { bigint, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	bigint: bigint({ mode: 'number' })
	bigintUnsigned: bigint({ mode: 'number', unsigned: true })
});

bigint('...', { mode: 'number' | 'bigint' });

// ä¹Ÿå¯ä»¥ä¸º bigint æŒ‡å®š unsigned é€‰é¡¹
bigint('...', { mode: 'number' | 'bigint', unsigned: true })
```

```sql
CREATE TABLE `table` (
	`bigint` bigint,
	`bigintUnsigned` bigint unsigned
);
```
</Section>

æˆ‘ä»¬çœç•¥äº† `bigint(M)` ä¸­çš„ `M` é…ç½®ï¼Œå› ä¸ºå®ƒè¡¨ç¤ºæ•°å­—ç±»å‹çš„æ˜¾ç¤ºå®½åº¦ã€‚

## ---

### real

<Section>
```typescript
import { real, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	real: real()
});
```

```sql
CREATE TABLE `table` (
	`real` real
);
```
</Section>

<Section>
```typescript
import { real, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	realPrecision: real({ precision: 1,}),
	realPrecisionScale: real({ precision: 1, scale: 1,}),
});
```

```sql
CREATE TABLE `table` (
	`realPrecision` real(1),
	`realPrecisionScale` real(1, 1)
);
```
</Section>

### decimal

<Section>
```typescript
import { decimal, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	decimal: decimal(),
	decimalNum: decimal({ scale: 30, mode: 'number' }),
	decimalBig: decimal({ scale: 30, mode: 'bigint' }),
});
```

```sql
CREATE TABLE `table` (
	`decimal` decimal,
	`decimalNum` decimal(30),
	`decimalBig` decimal(30)
);
```
</Section>

<Section>
```typescript
import { decimal, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	decimalPrecision: decimal({ precision: 1,}),
	decimalPrecisionScale: decimal({ precision: 1, scale: 1,}),
});
```

```sql
CREATE TABLE `table` (
	`decimalPrecision` decimal(1),
	`decimalPrecisionScale` decimal(1, 1)
);
```
</Section>

### double

<Section>
```typescript
import { double, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	double: double('double')
});
```

```sql
CREATE TABLE `table` (
	`double` double
);
```
</Section>

<Section>
```typescript
import { double, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	doublePrecision: double({ precision: 1,}),
	doublePrecisionScale: double({ precision: 1, scale: 1,}),
});
```

```sql
CREATE TABLE `table` (
	`doublePrecision` double(1),
	`doublePrecisionScale` double(1, 1)
);
```
</Section>

### float

<Section>
```typescript
import { float, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	float: float()
});
```

```sql
CREATE TABLE `table` (
	`float` float
);
```
</Section>

## ---

### serial

<Section>

`SERIAL` æ˜¯ `BIGINT UNSIGNED NOT NULL AUTO_INCREMENT UNIQUE` çš„åˆ«åã€‚

```typescript
import { serial, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	serial: serial()
});
```

```sql
CREATE TABLE `table` (
	`serial` serial AUTO_INCREMENT
);
```
</Section>

## ---

### binary

<Section>
```typescript
import { binary, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	binary: binary()
});
```

```sql
CREATE TABLE `table` (
	`binary` binary
);
```
</Section>

### varbinary

<Section>
```typescript
import { varbinary, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	varbinary: varbinary({ length: 2}),
});
```

```sql
CREATE TABLE `table` (
	`varbinary` varbinary(2)
);
```
</Section>

## ---

### char

<Section>
```typescript
import { char, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	char: char(),
});
```

```sql
CREATE TABLE `table` (
	`char` char
);
```
</Section>

### varchar
æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®ä»¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€¼ã€‚
<Section>
```typescript
import { varchar, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	varchar: varchar({ length: 2 }),
});

// æ¨æ–­ä¸ºæ–‡æœ¬ç±»å‹: "value1" | "value2" | null
varchar: varchar({ length: 6, enum: ["value1", "value2"] })
```

```sql
CREATE TABLE `table` (
	`varchar` varchar(2)
);
```
</Section>

### text

æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®ä»¥æ¨æ–­ `insert` å’Œ `select` ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€¼ã€‚

<Section>
```typescript
import { text, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	text: text(),
});

// æ¨æ–­ä¸ºæ–‡æœ¬ç±»å‹: "value1" | "value2" | null
text: text({ enum: ["value1", "value2"] });
```

```sql
CREATE TABLE `table` (
	`text` text
);
```
</Section>

## ---

### boolean

<Section>
```typescript
import { boolean, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	boolean: boolean(),
});
```

```sql
CREATE TABLE `table` (
	`boolean` boolean
);
```
</Section>

## ---

### date

<Section>
```typescript
import { boolean, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	date: date(),
});
```

```sql
CREATE TABLE `table` (
	`date` date
);
```
</Section>

### datetime

<Section>
```typescript
import { datetime, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	datetime: datetime(),
});

datetime('...', { mode: 'date' | "string"}),
```

```sql
CREATE TABLE `table` (
	`datetime` datetime
);
```
</Section>

### time 

<Section>
```typescript
import { time, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	time: time(),
});
```

```sql
CREATE TABLE `table` (
	`time` time
);
```
</Section>

### year

<Section>
```typescript
import { year, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	year: year(),
});
```

```sql
CREATE TABLE `table` (
	`year` year
);
```
</Section>

### timestamp

<Section>
```typescript
import { timestamp, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	timestamp: timestamp(),
});

timestamp('...', { mode: 'date' | "string"}),
```

```sql
CREATE TABLE `table` (
	`timestamp` timestamp
);
```
</Section>

<Section>
```typescript
import { timestamp, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	timestamp: timestamp().defaultNow(),
});
```

```sql
CREATE TABLE `table` (
	`timestamp` timestamp DEFAULT (now())
);
```
</Section>

## ---

### json

<Section>
```typescript
import { json, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	json: json(),
});

```

```sql
CREATE TABLE `table` (
	`json` json
);
```
</Section>

æ‚¨å¯ä»¥æŒ‡å®š `.$type<..>()` æ¥æ¨æ–­ json å¯¹è±¡ç±»å‹ï¼Œä½†å®ƒ **ä¸ä¼š** åœ¨è¿è¡Œæ—¶æ ¡éªŒå€¼ã€‚
æ­¤åŠŸèƒ½ä¸ºé»˜è®¤å€¼ã€æ’å…¥å’ŒæŸ¥è¯¢çš„ç±»å‹æä¾›ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚
```typescript
// æ¨æ–­ä¸º { foo: string }
json: json().$type<{ foo: string }>();

// æ¨æ–­ä¸º string[]
json: json().$type<string[]>();

// æ— æ³•ç¼–è¯‘
json: json().$type<string[]>().default({});
```

## ---

### enum

<Section>
```typescript
import { singlestoreEnum, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	popularity: singlestoreEnum(['unknown', 'known', 'popular']),
});
```

```sql
CREATE TABLE `table` (
	`popularity` enum('unknown','known','popular')
);
```
</Section>

## ---

### è‡ªå®šä¹‰æ•°æ®ç±»å‹

æ¯ä¸ªåˆ—æ„å»ºå™¨éƒ½æ‹¥æœ‰ `.$type()` æ–¹æ³•ï¼Œå…è®¸æ‚¨è‡ªå®šä¹‰åˆ—çš„æ•°æ®ç±»å‹ã€‚è¿™åœ¨ä½¿ç”¨æœªçŸ¥ç±»å‹æˆ–æ ‡è®°ç±»å‹æ—¶éå¸¸æœ‰ç”¨ã€‚

```ts
type UserId = number & { __brand: 'user_id' };
type Data = {
	foo: string;
	bar: number;
};

const users = singlestoreTable('users', {
  id: int().$type<UserId>().primaryKey(),
  jsonField: json().$type<Data>(),
});
```

### éç©º

`NOT NULL` çº¦æŸè§„å®šè¡¨ä¸­å¯¹åº”åˆ—ä¸å¯åŒ…å« `NULL` å€¼ã€‚

<Section>
```typescript
import { int, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	int: int().notNull(),
});
```

```sql
CREATE TABLE `table` (
	`int` int NOT NULL
);
```
</Section>

### é»˜è®¤å€¼

`DEFAULT` å­å¥æŒ‡å®šåœ¨ `INSERT` æ“ä½œæ—¶è‹¥ç”¨æˆ·æœªæä¾›æ˜ç¡®å€¼ï¼Œåˆ—é»˜è®¤ä½¿ç”¨çš„å€¼ã€‚
è‹¥å®šä¹‰æ—¶æœªæ˜¾å¼æŒ‡å®š `DEFAULT` å­å¥ï¼Œé»˜è®¤å€¼ä¸º `NULL`ã€‚

æ˜¾å¼çš„ `DEFAULT` å­å¥å…è®¸æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€å­—ç¬¦ä¸²å¸¸é‡ã€äºŒè¿›åˆ¶å¸¸é‡ã€å¸¦ç¬¦å·æ•°å­—æˆ–ä»»æ„æ‹¬å·æ‹¬èµ·çš„å¸¸é‡è¡¨è¾¾å¼ã€‚

<Section>
```typescript
import { int, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	int: int().default(3),
});
```

```sql
CREATE TABLE `table` (
	`int` int DEFAULT 3
);
```
</Section>

ä½¿ç”¨ `$default()` æˆ– `$defaultFn()` å¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼ï¼Œå¹¶åœ¨æ‰€æœ‰æ’å…¥æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚å®ƒä»¬æ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åã€‚
è¿™äº›å‡½æ•°å¸®åŠ©æ‚¨ä½¿ç”¨ `uuid`ã€`cuid`ã€`cuid2` ç­‰å¤šç§å®ç°ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šæ­¤å€¼ä¸å½±å“ `drizzle-kit` è¡Œä¸ºï¼Œä»…åœ¨ `drizzle-orm` è¿è¡Œæ—¶ä½¿ç”¨ã€‚
</Callout>

```ts
import { varchar, singlestoreTable } from "drizzle-orm/singlestore-core";
import { createId } from '@paralleldrive/cuid2';

const table = singlestoreTable('table', {
	id: varchar({ length: 128 }).$defaultFn(() => createId()),
});
```

ä½¿ç”¨ `$onUpdate()` æˆ– `$onUpdateFn()` å¯åœ¨æ›´æ–°è¡Œæ—¶ç”ŸæˆåŠ¨æ€å€¼ã€‚è¿™ä¸¤ä¸ªæ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åã€‚

è¯¥å‡½æ•°å°†åœ¨è¡Œæ›´æ–°æ—¶è°ƒç”¨ï¼Œè‹¥æœªæä¾›è¯¥åˆ—å€¼ï¼Œä½¿ç”¨å‡½æ•°è¿”å›å€¼ä½œä¸ºå€¼ã€‚
å¦‚æœæœªæä¾›é»˜è®¤å€¼ï¼ˆ`$default` æˆ– `$defaultFn`ï¼‰ï¼Œè¯¥å‡½æ•°åœ¨æ’å…¥æ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œä½¿ç”¨è¿”å›å€¼ä½œä¸ºåˆ—å€¼ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šæ­¤å€¼ä¸å½±å“ `drizzle-kit` è¡Œä¸ºï¼Œä»…åœ¨ `drizzle-orm` è¿è¡Œæ—¶ä½¿ç”¨ã€‚
</Callout>

```ts
import { text, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
    alwaysNull: text().$type<string | null>().$onUpdate(() => null),
});
```

### ä¸»é”®

<Section>
```typescript
import { int, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	int: int().primaryKey(),
});
```

```sql
CREATE TABLE `table` (
	`int` int PRIMARY KEY NOT NULL
);
```
</Section>

### è‡ªå¢

<Section>
```typescript
import { int, singlestoreTable } from "drizzle-orm/singlestore-core";

const table = singlestoreTable('table', {
	int: int().autoincrement(),
});
```

```sql
CREATE TABLE `table` (
	`int` int AUTO_INCREMENT
);
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/column-types/sqlite


import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';

æ ¹æ®å®˜æ–¹ **[SQLite æ–‡æ¡£](https://www.sqlite.org/datatype3.html)**ï¼Œ
æ¯ä¸ªå­˜å‚¨åœ¨ SQLite æ•°æ®åº“ä¸­çš„å€¼ï¼ˆæˆ–è¢«æ•°æ®åº“å¼•æ“æ“ä½œçš„å€¼ï¼‰
éƒ½å…·æœ‰ä»¥ä¸‹å­˜å‚¨ç±»åˆ«ä¹‹ä¸€ï¼š`NULL`ã€`INTEGER`ã€`REAL`ã€`TEXT` å’Œ `BLOB`ã€‚

æˆ‘ä»¬å¯¹å®ƒä»¬éƒ½æä¾›äº†åŸç”Ÿæ”¯æŒï¼Œå¦‚æœè¿™è¿˜ä¸å¤Ÿï¼Œæ¬¢è¿åˆ›å»º **[è‡ªå®šä¹‰ç±»å‹](/docs/custom-types)**ã€‚

<Callout title='important' type='warning'>
æœ¬éƒ¨åˆ†æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç¤ºä¾‹å‡æœªä½¿ç”¨æ•°æ®åº“åˆ—ååˆ«åï¼Œåˆ—åæ˜¯ä» TypeScript é”®ç”Ÿæˆçš„ã€‚

å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨åˆ—åä¸­ä½¿ç”¨æ•°æ®åº“åˆ«åï¼Œå¹¶ä¸”æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `casing` å‚æ•°ä¸º Drizzle å®šä¹‰æ˜ å°„ç­–ç•¥ã€‚

æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ](/docs/sql-schema-declaration#shape-your-data-schema) äº†è§£æ›´å¤šä¿¡æ¯ã€‚
</Callout>

### æ•´æ•°

ä¸€ä¸ªæœ‰ç¬¦å·æ•´æ•°ï¼Œå­˜å‚¨ä¸º `0`ã€`1`ã€`2`ã€`3`ã€`4`ã€`6` æˆ– `8` å­—èŠ‚ï¼Œå…·ä½“å–å†³äºå€¼çš„å¤§å°ã€‚

<Section>
```typescript
import { integer, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	id: integer()
});

// æ‚¨å¯ä»¥è‡ªå®šä¹‰æ•´æ•°æ¨¡å¼ä¸º numberã€booleanã€timestampã€timestamp_ms
integer({ mode: 'number' })
integer({ mode: 'boolean' })
integer({ mode: 'timestamp_ms' })
integer({ mode: 'timestamp' }) // Date

```

```sql
CREATE TABLE `table` (
	`id` integer
);
```

</Section>

<Section>
```typescript
// ä½¿æ•´æ•°ä¸»é”®è‡ªåŠ¨é€’å¢
integer({ mode: 'number' }).primaryKey({ autoIncrement: true })
```
```sql
CREATE TABLE `table` (
	`id` integer PRIMARY KEY AUTOINCREMENT NOT NULL
);
```
</Section>

### å®æ•°

ä¸€ä¸ªæµ®ç‚¹å€¼ï¼Œå­˜å‚¨ä¸º `8-byte IEEE` æµ®ç‚¹æ•°ã€‚

<Section>
```typescript
import { real, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	real: real()
});

```

```sql
CREATE TABLE `table` (
	`real` real
);
```

</Section>

### æ–‡æœ¬

ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä½¿ç”¨æ•°æ®åº“ç¼–ç ï¼ˆ`UTF-8`ã€`UTF-16BE` æˆ– `UTF-16LE`ï¼‰å­˜å‚¨ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ‚¨å¯ä»¥å®šä¹‰ `{ enum: ["value1", "value2"] }` é…ç½®æ¥æ¨å¯¼ `insert` å’Œ `select` ç±»å‹ï¼Œå®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚
</Callout>

<Section>
```typescript
import { text, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	text: text()
});

// å°†æ¨å¯¼ä¸º text: "value1" | "value2" | null
text({ enum: ["value1", "value2"] })
text({ mode: 'json' })
text({ mode: 'json' }).$type<{ foo: string }>()
```

```sql
CREATE TABLE `table` (
	`text` text
);
```

</Section>

### BLOB

ä¸€ä¸ªæ•°æ®å—ï¼Œå‡†ç¡®åœ°æŒ‰ç…§è¾“å…¥å­˜å‚¨ã€‚

<Callout type="info" emoji="â„¹ï¸">
	å»ºè®®ä½¿ç”¨ `text('', { mode: 'json' })` è€Œä¸æ˜¯ `blob('', { mode: 'json' })`ï¼Œ 
	å› ä¸ºå®ƒæ”¯æŒ JSON å‡½æ•°ï¼š

	ç›®å‰æ‰€æœ‰ JSON å‡½æ•°åœ¨å…¶ä»»ä½•å‚æ•°ä¸º BLOB æ—¶éƒ½ä¼šæŠ›å‡ºé”™è¯¯ï¼Œ
	å› ä¸º BLOB ä¿ç•™ç”¨äºå°†æ¥å¢å¼ºåŠŸèƒ½ï¼Œå…¶ä¸­ BLOB å°†å­˜å‚¨ JSON çš„äºŒè¿›åˆ¶ç¼–ç ã€‚

	è¯·å‚é˜… **https://www.sqlite.org/json1.html**ã€‚
</Callout>

<Section>
```typescript
import { blob, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	blob: blob()
});

blob()
blob({ mode: 'buffer' })
blob({ mode: 'bigint' })

blob({ mode: 'json' })
blob({ mode: 'json' }).$type<{ foo: string }>()

```

```sql
CREATE TABLE `table` (
	`blob` blob
);
```

æ‚¨å¯ä»¥ä¸º blob æ¨å¯¼æŒ‡å®š `.$type<..>()`ï¼Œå®ƒ **ä¸ä¼š** æ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚
å®ƒä¸ºé»˜è®¤å€¼ã€æ’å…¥å’Œé€‰æ‹©æ¨¡å¼æä¾›ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚

```typescript
// å°†æ¨å¯¼ä¸º { foo: string }
json: blob({ mode: 'json' }).$type<{ foo: string }>();

// å°†æ¨å¯¼ä¸º string[]
json: blob({ mode: 'json' }).$type<string[]>();

// ä¸ä¼šç¼–è¯‘
json: blob({ mode: 'json' }).$type<string[]>().default({});
```

</Section>

### å¸ƒå°”å€¼

SQLite æ²¡æœ‰åŸç”Ÿçš„ `boolean` æ•°æ®ç±»å‹ï¼Œä½†æ‚¨å¯ä»¥æŒ‡å®š `integer` åˆ—ä¸º `boolean` æ¨¡å¼ã€‚
è¿™ä½¿æ‚¨èƒ½å¤Ÿåœ¨ä»£ç ä¸­æ“ä½œå¸ƒå°”å€¼ï¼Œ
Drizzle å°†å®ƒä»¬å­˜å‚¨ä¸ºæ•°æ®åº“ä¸­çš„ 0 å’Œ 1 æ•´æ•°å€¼ã€‚


<Section>
```typescript
import { integer, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	id: integer({ mode: 'boolean' })
});
```

```sql
CREATE TABLE `table` (
	`id` integer
);
```

</Section>

### å¤§æ•´æ•°

ç”±äº SQLite ä¸­æ²¡æœ‰ `bigint` æ•°æ®ç±»å‹ï¼ŒDrizzle ä¸º `blob` åˆ—æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„ `bigint` æ¨¡å¼ã€‚
è¿™ç§æ¨¡å¼å…è®¸æ‚¨åœ¨ä»£ç ä¸­å¤„ç† BigInt å®ä¾‹ï¼Œè€Œ Drizzle å°†å®ƒä»¬ä½œä¸º blob å€¼å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚


<Section>
```typescript
import { blob, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	id: blob({ mode: 'bigint' })
});

```

```sql
CREATE TABLE `table` (
	`id` blob
);
```
</Section>

### Numeric

<Section>
```typescript
import { blob, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	numeric: numeric(),
	numericNum: numeric({ mode: 'number' }),
	numericBig: numeric({ mode: 'bigint' }),
});

```

```sql
CREATE TABLE `table` (
	`numeric` numeric,
	`numericNum` numeric,
	`numericBig` numeric
);
```
</Section>

## ---

### è‡ªå®šä¹‰æ•°æ®ç±»å‹
æ¯ä¸ªåˆ—æ„å»ºå™¨éƒ½æœ‰ä¸€ä¸ª `.$type()` æ–¹æ³•ï¼Œå¯ä»¥è®©æ‚¨è‡ªå®šä¹‰åˆ—çš„æ•°æ®ç±»å‹ã€‚è¿™åœ¨å¤„ç†æœªçŸ¥æˆ–å“ç‰Œç±»å‹æ—¶éå¸¸æœ‰ç”¨ã€‚
```ts
type UserId = number & { __brand: 'user_id' };
type Data = {
	foo: string;
	bar: number;
};

const users = sqliteTable('users', {
  id: integer().$type<UserId>().primaryKey(),
  jsonField: blob().$type<Data>(),
});
```

### éç©º
`NOT NULL` çº¦æŸæŒ‡ç¤ºå…³è”åˆ—ä¸å¾—åŒ…å« `NULL` å€¼ã€‚
<Section>
```typescript
const table = sqliteTable('table', { 
	numInt: integer().notNull() 
});
```

```sql
CREATE TABLE table (
	`numInt` integer NOT NULL
);
```
</Section>

### é»˜è®¤å€¼

`DEFAULT` å­å¥æŒ‡å®šåœ¨ç”¨æˆ·åœ¨æ‰§è¡Œ `INSERT` 
æ“ä½œæ—¶æœªæ˜ç¡®æä¾›å€¼æ—¶ï¼Œä½¿ç”¨çš„é»˜è®¤å€¼ã€‚
å¦‚æœåˆ—å®šä¹‰ä¸­æ²¡æœ‰æ˜ç¡®çš„ `DEFAULT` å­å¥ï¼Œ
åˆ™åˆ—çš„é»˜è®¤å€¼ä¸º `NULL`ã€‚

ä¸€ä¸ªæ˜ç¡®çš„ `DEFAULT` å­å¥å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€
å­—ç¬¦ä¸²å¸¸é‡ã€blob å¸¸é‡ã€æœ‰ç¬¦å·æ•°å­—æˆ–ä»»ä½•ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„å¸¸é‡è¡¨è¾¾å¼ã€‚

<Section>
```typescript
import { sql } from "drizzle-orm";
import { integer, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
	int1: integer().default(42),
	int2: integer().default(sql`(abs(42))`)
});

```
```sql
CREATE TABLE `table` (
	`int1` integer DEFAULT 42,
	`int2` integer DEFAULT (abs(42))
);
```
</Section>

é»˜è®¤å€¼ä¹Ÿå¯ä»¥æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ç‰¹æ®Šå…³é”®å­— `CURRENT_TIME`ã€`CURRENT_DATE` æˆ– `CURRENT_TIMESTAMP`ã€‚

<Section>
```typescript
import { sql } from "drizzle-orm";
import { text, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable("table", {
  time: text().default(sql`(CURRENT_TIME)`),
  date: text().default(sql`(CURRENT_DATE)`),
  timestamp: text().default(sql`(CURRENT_TIMESTAMP)`),
});
```

```sql
CREATE TABLE `table` (
	`time` text DEFAULT (CURRENT_TIME),
	`date` text DEFAULT (CURRENT_DATE),
	`timestamp` text DEFAULT (CURRENT_TIMESTAMP)
);
```
</Section>

ä½¿ç”¨ `$default()` æˆ– `$defaultFn()`ï¼Œå®ƒä»¬åªæ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åï¼Œ
æ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼å¹¶åœ¨æ‰€æœ‰æ’å…¥æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚
è¿™äº›å‡½æ•°å¯ä»¥å¸®åŠ©æ‚¨åˆ©ç”¨å„ç§å®ç°ï¼Œä¾‹å¦‚ `uuid`ã€`cuid`ã€`cuid2` ç­‰ç­‰ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸å½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œå®ƒä»…åœ¨ `drizzle-orm` ä¸­ç”¨äºè¿è¡Œæ—¶ã€‚
</Callout>

```ts
import { text, sqliteTable } from "drizzle-orm/sqlite-core";
import { createId } from '@paralleldrive/cuid2';

const table = sqliteTable('table', {
	id: text().$defaultFn(() => createId()),
});
```

ä½¿ç”¨ `$onUpdate()` æˆ– `$onUpdateFn()`ï¼Œå®ƒä»¬åªæ˜¯åŒä¸€å‡½æ•°çš„ä¸åŒåˆ«åï¼Œ
æ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶ç”Ÿæˆé»˜è®¤å€¼å¹¶åœ¨æ‰€æœ‰æ›´æ–°æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›å€¼ã€‚

å‘è¯¥åˆ—æ·»åŠ åŠ¨æ€æ›´æ–°å€¼ã€‚å½“è¡Œè¢«æ›´æ–°æ—¶ï¼Œå°†è°ƒç”¨è¯¥å‡½æ•°ï¼Œ
å¦‚æœæœªæä¾›ä»»ä½•å€¼ï¼Œåˆ™è¿”å›çš„å€¼å°†ç”¨ä½œåˆ—å€¼ã€‚
å¦‚æœæœªæä¾›é»˜è®¤å€¼ï¼ˆæˆ– $defaultFn å€¼ï¼‰ï¼Œ
å½“è¡Œè¢«æ’å…¥æ—¶ä¹Ÿä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶ä¸”è¿”å›çš„å€¼å°†ç”¨ä½œåˆ—å€¼ã€‚

<Callout type="info" emoji="â„¹ï¸">
	æ³¨æ„ï¼šè¯¥å€¼ä¸å½±å“ `drizzle-kit` çš„è¡Œä¸ºï¼Œå®ƒä»…åœ¨ `drizzle-orm` ä¸­ç”¨äºè¿è¡Œæ—¶ã€‚
</Callout>

```ts
import { text, sqliteTable } from "drizzle-orm/sqlite-core";

const table = sqliteTable('table', {
    alwaysNull: text().$type<string | null>().$onUpdate(() => null),
});
```


Source: https://drizzle.zhcndoc.com/docs/connect-aws-data-api-mysql

import Callout from '@mdx/Callout.astro';


# Drizzle \<\> AWS æ•°æ® API MySQL

<Callout>
ç›®å‰ AWS æ•°æ® API for MySQL åœ¨ Drizzle ORM ä¸­å°šæœªå®ç°
</Callout>

Source: https://drizzle.zhcndoc.com/docs/connect-aws-data-api-pg

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> AWS æ•°æ® API Postgres

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- AWS æ•°æ® API - [å®˜ç½‘](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/data-api.html)
- AWS SDK - [å®˜ç½‘](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-rds-data/)
</Prerequisites>

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm @aws-sdk/client-rds-data
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨ç¨‹åºå¹¶è¿›è¡ŒæŸ¥è¯¢
```typescript copy
import { drizzle } from 'drizzle-orm/aws-data-api/pg';

// è¿™ä¸‰ä¸ªå±æ€§æ˜¯å¿…éœ€çš„ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨è¿æ¥å¯¹è±¡ä¸­æŒ‡å®š
// RDSDataClient ç±»å‹çš„ä»»ä½•å±æ€§ã€‚
const db = drizzle({ connection: {
  database: process.env['DATABASE']!,
  secretArn: process.env['SECRET_ARN']!,
  resourceArn: process.env['RESOURCE_ARN']!,
}});

await db.select().from(...);
```

å¦‚æœæ‚¨éœ€è¦æä¾›æ‚¨ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy
import { drizzle } from 'drizzle-orm/aws-data-api/pg';
import { RDSDataClient } from '@aws-sdk/client-rds-data';

const rdsClient = new RDSDataClient({ region: 'us-east-1' });

const db = drizzle(rdsClient, {
  database: process.env['DATABASE']!,
  secretArn: process.env['SECRET_ARN']!,
  resourceArn: process.env['RESOURCE_ARN']!,
});

await db.select().from(...);
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>


Source: https://drizzle.zhcndoc.com/docs/connect-bun-sql

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> Bun SQL

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- Bun - [ç½‘ç«™](https://bun.zhcndoc.com)
- Bun SQL - ç”¨äºå¤„ç† PostgreSQL æ•°æ®åº“çš„åŸç”Ÿç»‘å®š - [åœ¨è¿™é‡Œé˜…è¯»](https://bun.zhcndoc.com/runtime/sql)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://bun.zhcndoc.com/)**ï¼ŒBun æ˜¯ä¸€ä¸ªå¿«é€Ÿçš„å…¨åŠŸèƒ½ JavaScript è¿è¡Œæ—¶ã€‚

Drizzle ORM åŸç”Ÿæ”¯æŒ **[`bun sql`](https://bun.zhcndoc.com/runtime/sql)** æ¨¡å—ï¼Œé€Ÿåº¦éå¸¸å¿« ğŸš€

#### æ­¥éª¤ 1 - å®‰è£…è½¯ä»¶åŒ…
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

#### æ­¥éª¤ 2 - åˆå§‹åŒ–é©±åŠ¨ç¨‹åºå¹¶è¿›è¡ŒæŸ¥è¯¢
```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/bun-sql';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.select().from(...);
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š
```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/bun-sql';
import { SQL } from 'bun';

const client = new SQL(process.env.DATABASE_URL!);
const db = drizzle({ client });
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>


Source: https://drizzle.zhcndoc.com/docs/connect-bun-sqlite

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> Bun SQLite

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- Bun - [ç½‘ç«™](https://bun.zhcndoc.com)
- Bun SQLite é©±åŠ¨ - [æ–‡æ¡£](https://bun.zhcndoc.com/runtime/sqlite)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://bun.zhcndoc.com)**ï¼ŒBun æ˜¯ä¸€ä¸ªå¿«é€Ÿçš„å…¨èƒ½ JavaScript è¿è¡Œæ—¶ã€‚

Drizzle ORM åŸç”Ÿæ”¯æŒ **[`bun:sqlite`](https://bun.zhcndoc.com/runtime/sqlite)** æ¨¡å—ï¼Œé€Ÿåº¦éå¸¸å¿« ğŸš€

æˆ‘ä»¬æ”¯æŒ SQL æ–¹è¨€ä»¥åŠç‰¹å®šæ–¹è¨€çš„é©±åŠ¨ç¨‹åºå’Œè¯­æ³•ï¼Œä¸å…¶ä»– ORM ä¸åŒï¼Œ

å¯¹äºåƒ `bun:sqlite` è¿™æ ·çš„åŒæ­¥é©±åŠ¨ï¼Œæˆ‘ä»¬æä¾›äº† **async** å’Œ **sync** APIï¼Œå¹¶ä¸”æˆ‘ä»¬é•œåƒäº†æœ€æµè¡Œçš„

SQLite ç±»çš„ `all`ã€`get`ã€`values` å’Œ `run` æŸ¥è¯¢æ–¹æ³•çš„è¯­æ³•ã€‚

#### æ­¥éª¤ 1 - å®‰è£…è½¯ä»¶åŒ…
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

#### æ­¥éª¤ 2 - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
```typescript copy
import { drizzle } from 'drizzle-orm/bun-sqlite';

const db = drizzle();

const result = await db.select().from(...);
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š
```typescript copy
import { drizzle } from 'drizzle-orm/bun-sqlite';
import { Database } from 'bun:sqlite';

const sqlite = new Database('sqlite.db');
const db = drizzle({ client: sqlite });

const result = await db.select().from(...);
```

å¦‚æœä½ æƒ³ä½¿ç”¨ **åŒæ­¥** APIï¼š
```typescript copy
import { drizzle } from 'drizzle-orm/bun-sqlite';
import { Database } from 'bun:sqlite';

const sqlite = new Database('sqlite.db');
const db = drizzle({ client: sqlite });

const result = db.select().from(users).all();
const result = db.select().from(users).get();
const result = db.select().from(users).values();
const result = db.select().from(users).run();
```

#### æ¥ä¸‹æ¥åšä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-cloudflare-d1

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> Cloudflare D1

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- D1 æ•°æ®åº“ - [å®˜ç½‘](https://developers.cloudflare.com/d1/)
- D1 é©±åŠ¨ - [å®˜ç½‘](https://developers.cloudflare.com/d1/build-with-d1/d1-client-api/)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://developers.cloudflare.com/d1/)**ï¼Œ  
D1 æ˜¯ Cloudflare é¦–ä¸ªå¯æŸ¥è¯¢çš„å…³ç³»æ•°æ®åº“ã€‚  
  
Drizzle ORM å®Œå…¨æ”¯æŒ Cloudflare D1 æ•°æ®åº“å’Œ Cloudflare Workers ç¯å¢ƒã€‚  
æˆ‘ä»¬æ”¯æŒ SQL æ–¹è¨€ä»¥åŠç‰¹å®šé©±åŠ¨å’Œè¯­æ³•ï¼Œ
å¹¶ä¸”æ˜ å°„å¤§å¤šæ•°æµè¡Œçš„ SQLite ç±» `all`ã€`get`ã€`values` å’Œ `run` æŸ¥è¯¢æ–¹æ³•çš„è¯­æ³•ã€‚

è¦ä¸ºæ‚¨çš„ Cloudflare D1 è®¾ç½®é¡¹ç›®ï¼Œè¯·å‚è€ƒ **[å®˜æ–¹æ–‡æ¡£ã€‚](https://developers.cloudflare.com/d1/)**

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢

æ‚¨éœ€è¦æœ‰ä¸€ä¸ª `wrangler.json` æˆ– `wrangler.toml` æ–‡ä»¶ç”¨äº D1 æ•°æ®åº“ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š
<CodeTabs items={["wrangler.json", "wrangler.toml"]}>
```json
{
    "name": "YOUR_PROJECT_NAME",
    "main": "src/index.ts",
    "compatibility_date": "2024-09-26",
    "compatibility_flags": [
        "nodejs_compat"
    ],
    "d1_databases": [
        {
            "binding": "BINDING_NAME",
            "database_name": "YOUR_DB_NAME",
            "database_id": "YOUR_DB_ID",
            "migrations_dir": "drizzle/migrations"
        }
    ]
}
```
```toml
name = "YOUR_PROJECT_NAME"
main = "src/index.ts"
compatibility_date = "2022-11-07"
node_compat = true

[[ d1_databases ]]
binding = "BINDING_NAME"
database_name = "YOUR_DB_NAME"
database_id = "YOUR_DB_ID"
migrations_dir = "drizzle/migrations"
```
</CodeTabs>

è¿›è¡Œæ‚¨çš„ç¬¬ä¸€ä¸ª D1 æŸ¥è¯¢ï¼š
```typescript copy
import { drizzle } from 'drizzle-orm/d1';

export interface Env {
  <ç»‘å®šåç§°>: D1Database;
}

export default {
  async fetch(request: Request, env: Env) {
    const db = drizzle(env.<ç»‘å®šåç§°>);
    const result = await db.select().from(users).all()
    return Response.json(result);
  },
};
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-cloudflare-do

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> Cloudflare Durable Objects SQLite

<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- **Cloudflare SQLite Durable Objects** - åµŒå…¥åœ¨ Durable Object ä¸­çš„ SQLite æ•°æ®åº“ - [è¯¦æƒ…è¯·é˜…è¯»](https://developers.cloudflare.com/durable-objects/best-practices/access-durable-objects-storage/#sqlite-storage-backend)
</Prerequisites>
  
Drizzle ORM å®Œå…¨æ”¯æŒ Cloudflare Durable Objects æ•°æ®åº“å’Œ Cloudflare Workers ç¯å¢ƒã€‚
æˆ‘ä»¬æ”¯æŒ SQL æ–¹è¨€åŠç‰¹å®šé©±åŠ¨ä¸è¯­æ³•ï¼Œå¹¶ä¸”æ”¯æŒå¤§å¤šæ•°æµè¡Œçš„ç±»ä¼¼ SQLite çš„ `all`ã€`get`ã€`values` å’Œ `run` æŸ¥è¯¢æ–¹æ³•è¯­æ³•ã€‚

è¦ä¸ºæ‚¨çš„ Cloudflare Durable Objects è®¾ç½®é¡¹ç›®ï¼Œè¯·å‚é˜… **[å®˜æ–¹æ–‡æ¡£ã€‚](https://developers.cloudflare.com/durable-objects)**

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢

æ‚¨éœ€è¦ä¸º Durable Objects æ•°æ®åº“åˆ›å»ºä¸€ä¸ª `wrangler.toml` æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š
```toml {16-18,21-24}
#:schema node_modules/wrangler/config-schema.json
name = "sqlite-durable-objects"
main = "src/index.ts"
compatibility_date = "2024-11-12"
compatibility_flags = [ "nodejs_compat" ]

# ç»‘å®š Durable Objectã€‚Durable Object æ˜¯ä¸€ç§åŸºäº actor æ¨¡å‹çš„å¯éšéœ€ç¼©æ”¾è®¡ç®—åŸè¯­ã€‚
# Durable Object å¯ä»¥é•¿æ—¶é—´è¿è¡Œã€‚é€‚ç”¨äºéœ€è¦é•¿æ—¶é—´è¿è¡Œâ€œæœåŠ¡å™¨â€çš„åœºæ™¯ï¼Œå¦‚å®æ—¶åº”ç”¨ã€‚
# æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[[durable_objects.bindings]]
name = "MY_DURABLE_OBJECT"
class_name = "MyDurableObject"

# Durable Object è¿ç§»ã€‚
# æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/wrangler/configuration/#migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["MyDurableObject"]

# æˆ‘ä»¬éœ€è¦è§„åˆ™ä»¥ä¾¿ä¸‹ä¸€æ­¥å¯¼å…¥è¿ç§»æ–‡ä»¶
[[rules]] 
type = "Text"
globs = ["**/*.sql"]
fallthrough = true
```

æ‰§è¡Œæ‚¨çš„ç¬¬ä¸€ä¸ª Durable Objects SQLite æŸ¥è¯¢ï¼š
```typescript copy
/// <reference types="@cloudflare/workers-types" />
import { drizzle, DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';
import { usersTable } from './db/schema';

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase<any>;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });

		// ç¡®ä¿æ‰€æœ‰è¿ç§»å®Œæˆåå†æ¥å—æŸ¥è¯¢ã€‚
		// å¦åˆ™ï¼Œä»»ä½•è®¿é—® Drizzle æ•°æ®åº“ `this.db` çš„å‡½æ•°ä¸­éƒ½éœ€è°ƒç”¨ `this.migrate()`ã€‚
		ctx.blockConcurrencyWhile(async () => {
			await this._migrate();
		});
	}

	async insertAndList(user: typeof usersTable.$inferInsert) {
		await this.insert(user);
		return this.select();
	}

	async insert(user: typeof usersTable.$inferInsert) {
		await this.db.insert(usersTable).values(user);
	}

	async select() {
		return this.db.select().from(usersTable);
	}

	async _migrate() {
		migrate(this.db, migrations);
	}
}

export default {
	/**
	 * è¿™æ˜¯ Cloudflare Worker çš„æ ‡å‡† fetch å¤„ç†å‡½æ•°
	 *
	 * @param request - å®¢æˆ·ç«¯æäº¤åˆ° Worker çš„è¯·æ±‚
	 * @param env - ç”¨äºå¼•ç”¨ wrangler.toml ä¸­å£°æ˜çš„ç»‘å®š
	 * @param ctx - Worker çš„æ‰§è¡Œä¸Šä¸‹æ–‡
	 * @returns è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”
	 */
	async fetch(request: Request, env: Env): Promise<Response> {
		const id: DurableObjectId = env.MY_DURABLE_OBJECT.idFromName('durable-object');
		const stub = env.MY_DURABLE_OBJECT.get(id);

		// é€‰é¡¹ A - æœ€å¤§æ€§èƒ½ã€‚
		// å°†æ‰€æœ‰æ•°æ®åº“æ“ä½œæ‰“åŒ…åœ¨å•ä¸ª Durable Object è°ƒç”¨ä¸­ä»¥è·å¾—æœ€å¤§æ€§èƒ½ï¼Œ
		// å› ä¸ºåœ¨ DO å†…éƒ¨è®¿é—®æ•°æ®åº“éå¸¸å¿«ã€‚
		const usersAll = await stub.insertAndList({
			name: 'John',
			age: 30,
			email: 'john@example.com',
		});
		console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºã€‚ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users);

		// é€‰é¡¹ B - é€Ÿåº¦è¾ƒæ…¢ä½†æœ‰æ—¶å¯¹è°ƒè¯•æœ‰ç”¨ã€‚
		// ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨å•ä¸ªæš´éœ²çš„ Drizzle æŸ¥è¯¢ï¼Œ
		// ä½†è¯·æ³¨æ„ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½ç›¸å½“äºå¾€è¿”è°ƒç”¨ Durable Object å®ä¾‹ã€‚
		await stub.insert({
			name: 'John',
			age: 30,
			email: 'john@example.com',
		});
		console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼');
	
		const users = await stub.select();
		console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users);

		return Response.json(users);
	}
}
```

#### ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-drizzle-proxy

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";

# Drizzle HTTP ä»£ç†

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
</Prerequisites>

HTTP ä»£ç†çš„å·¥ä½œåŸç†ä»¥åŠæ‚¨å¯èƒ½éœ€è¦å®ƒçš„åŸå› 

Drizzle Proxy åœ¨æ‚¨éœ€è¦å®ç°è‡ªå·±çš„é©±åŠ¨ç¨‹åºä¸æ•°æ®åº“çš„é€šä¿¡æ—¶ä½¿ç”¨ã€‚ 
å®ƒå¯ä»¥åœ¨å‡ ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨ç°æœ‰é©±åŠ¨ç¨‹åºçš„æŸ¥è¯¢é˜¶æ®µæ·»åŠ è‡ªå®šä¹‰é€»è¾‘ã€‚ 
æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ä¸ HTTP é©±åŠ¨ç¨‹åºä¸€èµ·ä½¿ç”¨ï¼Œå®ƒå°†æŸ¥è¯¢å‘é€åˆ°æ‚¨çš„æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ‰§è¡ŒæŸ¥è¯¢ 
å¹¶ä»¥åŸå§‹æ•°æ®å“åº”ï¼ŒDrizzle ORM ç„¶åå¯ä»¥å°†å…¶æ˜ å°„ä¸ºç»“æœã€‚

<Callout collapsed="å®ƒæ˜¯å¦‚ä½•åœ¨åº•å±‚å·¥ä½œçš„ï¼Ÿ">
```                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              
â”‚       Drizzle ORM         â”‚                 â”‚  å¸¦æ•°æ®åº“çš„ HTTP æœåŠ¡å™¨    â”‚             
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜             
  â”‚                                                ^                    â”‚
  â”‚-- 1. æ„å»ºæŸ¥è¯¢         2. å‘é€æ„å»ºçš„æŸ¥è¯¢ --â”‚                    â”‚
  â”‚                                                â”‚                    â”‚
  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚â”€â”€â”€â”€â”€â”˜                    â”‚ 
                 â”‚      HTTP ä»£ç†é©±åŠ¨        â”‚                          â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
  â”‚                                                  3. æ‰§è¡ŒæŸ¥è¯¢ + è¿”å›åŸå§‹ç»“æœ
  â”‚-- 4. æ˜ å°„æ•°æ®å¹¶è¿”å›        
  â”‚                   
  v
```
</Callout>

Drizzle ORM è¿˜æ”¯æŒç®€å•åœ°ä½¿ç”¨å¼‚æ­¥å›è°ƒå‡½æ•°æ¥æ‰§è¡Œ SQLã€‚

- `sql` æ˜¯å¸¦å ä½ç¬¦çš„æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚
- `params` æ˜¯å‚æ•°æ•°ç»„ã€‚
- æ ¹æ® SQL è¯­å¥ï¼Œ`method` å°†è¢«è®¾ç½®ä¸º `run`ã€`all`ã€`values` æˆ– `get` ä¹‹ä¸€ã€‚

Drizzle æ€»æ˜¯ç­‰å¾…è¿”å›å€¼ä¸º `{rows: string[][]}` æˆ– `{rows: string[]}`ã€‚

- å½“ `method` ä¸º `get` æ—¶ï¼Œæ‚¨åº”è¯¥è¿”å›ä¸€ä¸ªä½œä¸º `{rows: string[]}` çš„å€¼ã€‚
- å¦åˆ™ï¼Œæ‚¨åº”è¯¥è¿”å› `{rows: string[][]}`ã€‚

<br/>

<CodeTabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Section>
```typescript copy
// é©±åŠ¨ç¨‹åºå®ç°ç¤ºä¾‹
import { drizzle } from 'drizzle-orm/pg-proxy';

const db = drizzle(async (sql, params, method) => {
  try {
    const rows = await axios.post('http://localhost:3000/query', { sql, params, method });

    return { rows: rows.data };
  } catch (e: any) {
    console.error('æ¥è‡ª pg ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯ï¼š', e.response.data)
    return { rows: [] };
  }
});
```
```ts
// æœåŠ¡å™¨å®ç°ç¤ºä¾‹
import { Client } from 'pg';
import express from 'express';

const app = express();

app.use(express.json());
const port = 3000;

const client = new Client('postgres://postgres:postgres@localhost:5432/postgres');

app.post('/query', async (req, res) => {
  const { sql, params, method } = req.body;

  // prevent multiple queries
  const sqlBody = sql.replace(/;/g, '');

  try {
    const result = await client.query({
      text: sqlBody,
      values: params,
      rowMode: method === 'all' ? 'array': undefined,
    });
    res.send(result.rows);
  } catch (e: any) {
    res.status(500).json({ error: e });
  }

  res.status(500).json({ error: 'Unknown method value' });
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```
</Section>
<Section>
```typescript copy
// é©±åŠ¨ç¨‹åºå®ç°ç¤ºä¾‹
import { drizzle } from 'drizzle-orm/mysql-proxy';

const db = drizzle(async (sql, params, method) => {
  try {
    const rows = await axios.post('http://localhost:3000/query', { sql, params, method });

    return { rows: rows.data };
  } catch (e: any) {
    console.error('æ¥è‡ª mysql ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯ï¼š', e.response.data)
    return { rows: [] };
  }
});
```
```ts
// æœåŠ¡å™¨å®ç°ç¤ºä¾‹
import * as mysql from 'mysql2/promise';
import express from 'express';

const app = express();

app.use(express.json());
const port = 3000;

const main = async () => {
    const connection = await mysql.createConnection('mysql://root:mysql@127.0.0.1:5432/drizzle');

    app.post('/query', async (req, res) => {
      const { sql, params, method } = req.body;

      // prevent multiple queries
      const sqlBody = sql.replace(/;/g, '');

      try {
            const result = await connection.query({
                sql: sqlBody,
                values: params,
                rowsAsArray: method === 'all',
                typeCast: function(field: any, next: any) {
                    if (field.type === 'TIMESTAMP' || field.type === 'DATETIME' || field.type === 'DATE') {
                        return field.string();
                    }
                    return next();
                },
            });
      } catch (e: any) {
        res.status(500).json({ error: e });
      }

      if (method === 'all') {
        res.send(result[0]);
      } else if (method === 'execute') {
        res.send(result);
      }
      res.status(500).json({ error: 'Unknown method value' });
    });

    app.listen(port, () => {
      console.log(`Example app listening on port ${port}`);
    });
}

main();
```
</Section>
<Section>
```typescript copy
import { drizzle } from 'drizzle-orm/sqlite-proxy';

const db = drizzle(async (sql, params, method) => {
  try {
    const rows = await axios.post('http://localhost:3000/query', { sql, params, method });

    return { rows: rows.data };
  } catch (e: any) {
    console.error('æ¥è‡ª sqlite ä»£ç†æœåŠ¡å™¨çš„é”™è¯¯ï¼š', e.response.data)
    return { rows: [] };
  }
});
```

**æ‰¹é‡æ”¯æŒ**

Sqlite Proxy æ”¯æŒæ‰¹é‡è¯·æ±‚ï¼Œå’Œå…¶ä»–é©±åŠ¨ç¨‹åºçš„å¤„ç†æ–¹å¼ç›¸åŒã€‚è¯·æŸ¥çœ‹å®Œæ•´çš„ [æ–‡æ¡£](/docs/batch-api)

æ‚¨éœ€è¦ä¸ºæ‰¹é‡æŸ¥è¯¢æŒ‡å®šç‰¹å®šçš„å›è°ƒï¼Œå¹¶å¤„ç†å¯¹ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚ï¼š

```ts
import { drizzle } from 'drizzle-orm/sqlite-proxy';

type ResponseType = { rows: any[][] | any[] }[];

const db = drizzle(async (sql, params, method) => {
  // å•æŸ¥è¯¢é€»è¾‘ã€‚å’Œä¸Šé¢çš„ä»£ç ç›¸åŒ
}, async (queries: { sql: string, params: any[], method: 'all' | 'run' | 'get' | 'values'}[]) => {
    try {
      const result: ResponseType = await axios.post('http://localhost:3000/batch', { queries });

      return result;
    } catch (e: any) {
      console.error('Error from sqlite proxy server:', e);
      throw e;
    }
  });
```

ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨ `db.batch([])` æ–¹æ³•ï¼Œè¿™å°†ä»£ç†æ‰€æœ‰æŸ¥è¯¢ã€‚

<Callout>
  æ‰¹é‡å“åº”åº”ä¸ºåŸå§‹å€¼çš„æ•°ç»„ï¼ˆæ•°ç»„ä¸­çš„æ•°ç»„ï¼‰ï¼Œé¡ºåºä¸å®ƒä»¬å‘é€åˆ°ä»£ç†æœåŠ¡å™¨æ—¶ç›¸åŒã€‚
</Callout>

é™¤éæ‚¨æ‰“ç®—æ‰‹åŠ¨ç¼–å†™æ¯ä¸ª SQL æŸ¥è¯¢ï¼Œå¦åˆ™è¡¨å£°æ˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼š
```typescript copy
import { sql } from "drizzle-orm";
import { text, integer, sqliteTable } from "drizzle-orm/sqlite-core";

const users = sqliteTable('users', {
  id: text('id'),
  textModifiers: text('text_modifiers').notNull().default(sql`CURRENT_TIMESTAMP`),
  intModifiers: integer('int_modifiers', { mode: 'boolean' }).notNull().default(false),
});
```
æœ‰å…³åˆ—ç±»å‹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ **[SQLite ä¸­çš„åˆ—ç±»å‹åœ¨ Drizzle.](/docs/column-types/sqlite)**
</Section>
</CodeTabs>



Source: https://drizzle.zhcndoc.com/docs/connect-expo-sqlite

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';


# Drizzle \<\> Expo SQLite
æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://expo.dev/)**ï¼ŒExpoæ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ã€æ„å»ºå’Œå‘å¸ƒReact Nativeåº”ç”¨ç¨‹åºçš„å·¥å…·ç”Ÿæ€ç³»ç»Ÿã€‚ 
å®ƒç”±Hermes JavaScriptè¿è¡Œæ—¶å’ŒMetroæ†ç»‘å™¨æä¾›æ”¯æŒï¼ŒDrizzle Expoé©±åŠ¨ç¨‹åºæ—¨åœ¨åŸç”Ÿæ”¯æŒè¿™ä¸¤è€…ã€‚  
  
Drizzle ORMä¸ºExpo SQLiteæä¾›äº†ä¸šç•Œæœ€ä½³çš„å·¥å…·åŒ…ï¼š
- Expo SQLiteçš„åŸç”ŸORMé©±åŠ¨ç¨‹åº âœ…
- [Drizzle Kit](/docs/kit-overview)æ”¯æŒè¿ç§»ç”Ÿæˆå’Œåº”ç”¨ç¨‹åºä¸­çš„æ†ç»‘ âœ…
- [Drizzle Studio](https://github.com/drizzle-team/drizzle-studio-expo)å¼€å‘å·¥å…·æ’ä»¶ï¼Œç”¨äºæµè§ˆè®¾å¤‡æ•°æ®åº“ âœ…
- å®æ—¶æŸ¥è¯¢ âœ…
  
<Npm>
drizzle-orm expo-sqlite@next
-D drizzle-kit 
</Npm>

```ts
import { drizzle } from "drizzle-orm/expo-sqlite";
import { openDatabaseSync } from "expo-sqlite";

const expo = openDatabaseSync("db.db");
const db = drizzle(expo);

await db.select().from(users);
```
#### å®æ—¶æŸ¥è¯¢
ä½¿ç”¨ `useLiveQuery` é’©å­ï¼Œæ‚¨å¯ä»¥ä½¿ä»»ä½•DrizzleæŸ¥è¯¢å˜ä¸ºå“åº”å¼ï¼š
```ts
import { useLiveQuery, drizzle } from 'drizzle-orm/expo-sqlite';
import { openDatabaseSync } from 'expo-sqlite';
import { Text } from 'react-native';
import * as schema from './schema';

const expo = openDatabaseSync('db.db', { enableChangeListener: true }); // <-- å¯ç”¨æ›´æ”¹ç›‘å¬å™¨
const db = drizzle(expo);

const App = () => {
  // å½“æ•°æ®æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“
  const { data } = useLiveQuery(db.select().from(schema.users));
  return <Text>{JSON.stringify(data)}</Text>;
};

export default App;
```

#### ä½¿ç”¨Drizzle Kitè¿›è¡ŒExpo SQLiteè¿ç§»
æ‚¨å¯ä»¥ä½¿ç”¨Drizzle Kitè¿›è¡ŒSQLè¿ç§»ç”Ÿæˆã€‚  
åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ£€æŸ¥[Drizzleè¿ç§»](/docs/kit-overview)çš„å·¥ä½œåŸç†ã€‚  
Expo / React Nativeè¦æ±‚æ‚¨å°†SQLè¿ç§»æ†ç»‘åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸ºæ‚¨æä¾›æ”¯æŒã€‚  

<Steps>
#### å®‰è£…babelæ’ä»¶
å°†SQLè¿ç§»æ–‡ä»¶ä½œä¸ºå­—ç¬¦ä¸²ç›´æ¥æ‰“åŒ…åˆ°æ‚¨çš„åŒ…ä¸­æ˜¯å¿…è¦çš„ã€‚
```shell
npm install babel-plugin-inline-import
```

#### æ›´æ–°é…ç½®æ–‡ä»¶ã€‚
æ‚¨éœ€è¦æ›´æ–° `babel.config.js`ã€`metro.config.js` å’Œ `drizzle.config.ts` æ–‡ä»¶
```js filename='babel.config.js'
module.exports = function(api) {
  api.cache(true);

  return {
    presets: ['babel-preset-expo'],
    plugins: [["inline-import", { "extensions": [".sql"] }]] // <-- æ·»åŠ æ­¤é¡¹
  };
};
```

```js filename="metro.config.js"
const { getDefaultConfig } = require('expo/metro-config');

/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);

config.resolver.sourceExts.push('sql'); // <--- æ·»åŠ æ­¤é¡¹

module.exports = config;
```

ç¡®ä¿åœ¨Drizzle Kité…ç½®ä¸­è®¾ç½® `dialect: 'sqlite'` å’Œ `driver: 'expo'`
```ts filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
	schema: './db/schema.ts',
	out: './drizzle',
  dialect: 'sqlite',
	driver: 'expo', // <--- éå¸¸é‡è¦
});
```

#### ç”Ÿæˆè¿ç§»
åœ¨åˆ›å»ºSQLæ¨¡å¼æ–‡ä»¶å’Œdrizzle.config.tsæ–‡ä»¶åï¼Œæ‚¨å¯ä»¥ç”Ÿæˆè¿ç§»
```bash
npx drizzle-kit generate
```

#### å°†è¿ç§»æ·»åŠ åˆ°æ‚¨çš„åº”ç”¨ç¨‹åº
ç°åœ¨æ‚¨éœ€è¦ä» `./drizzle` æ–‡ä»¶å¤¹ä¸­å°† `migrations.js` æ–‡ä»¶å¯¼å…¥åˆ°æ‚¨çš„Expo/React Nativeåº”ç”¨ä¸­ã€‚ 
æ‚¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ `useMigrations` è¿ç§»é’©å­åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿è¡Œè¿ç§»ï¼Œæ‰‹åŠ¨åœ¨ `useEffect` é’©å­ä¸­æŒ‰æ‚¨å¸Œæœ›çš„æ–¹å¼è¿›è¡Œã€‚

```ts filename="App.tsx"
import { drizzle } from "drizzle-orm/expo-sqlite";
import { openDatabaseSync } from "expo-sqlite";
import { useMigrations } from 'drizzle-orm/expo-sqlite/migrator';
import migrations from './drizzle/migrations';

const expoDb = openDatabaseSync("db.db");

const db = drizzle(expoDb);

export default function App() {
  const { success, error } = useMigrations(db, migrations);

  if (error) {
    return (
      <View>
        <Text>è¿ç§»é”™è¯¯: {error.message}</Text>
      </View>
    );
  }

  if (!success) {
    return (
      <View>
        <Text>è¿ç§»æ­£åœ¨è¿›è¡Œä¸­...</Text>
      </View>
    );
  }

  return ...ä½ çš„åº”ç”¨ç»„ä»¶;
}
```
</Steps>

Source: https://drizzle.zhcndoc.com/docs/connect-neon

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> Neon Postgres
<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- Neon æ— æœåŠ¡å™¨æ•°æ®åº“ - [ç½‘ç«™](https://neon.tech)
- Neon æ— æœåŠ¡å™¨é©±åŠ¨ - [æ–‡æ¡£](https://neon.tech/docs/serverless/serverless-driver) & [GitHub](https://github.com/neondatabase/serverless)
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `neon-http` å’Œ `neon-websockets` é©±åŠ¨è¿æ¥ Neonã€‚è¿™äº›é©±åŠ¨åœ¨åº•å±‚ä½¿ç”¨ **neon-serverless** é©±åŠ¨ã€‚  
  
ä½¿ç”¨ `neon-http` å’Œ `neon-websockets` é©±åŠ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ HTTP æˆ– WebSockets ä»æ— æœåŠ¡å™¨ç¯å¢ƒè®¿é—® Neon æ•°æ®åº“ï¼Œè€Œä¸æ˜¯é€šè¿‡ TCPã€‚  
é€šè¿‡ HTTP æŸ¥è¯¢å¯¹äºå•ä¸ªéäº¤äº’äº‹åŠ¡æ¥è¯´é€Ÿåº¦æ›´å¿«ã€‚  
  
å¦‚æœæ‚¨éœ€è¦ä¼šè¯æˆ–äº¤äº’äº‹åŠ¡æ”¯æŒï¼Œæˆ–éœ€è¦ä¸€ä¸ªå®Œå…¨å…¼å®¹çš„å¯æ›¿æ¢ `pg` é©±åŠ¨, é‚£æ‚¨å¯ä»¥ä½¿ç”¨åŸºäº WebSocket çš„ `neon-serverless` é©±åŠ¨ã€‚  
æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ [Postgres](/docs/get-started/postgresql-new) è¿æ¥åˆ° Neon æ•°æ®åº“ã€‚
  
æœ‰å…³åœ¨ Cloudflare Worker ä¸­ä½¿ç”¨ Drizzle ORM å’Œ Neon æ— æœåŠ¡å™¨é©±åŠ¨çš„ç¤ºä¾‹ï¼Œ**[è¯·è§è¿™é‡Œ](http://driz.link/neon-cf-ex)**ã€‚  
è¦ä»æœ‰æœåŠ¡å™¨ç¯å¢ƒä½¿ç”¨ Neonï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ PostgresJS é©±åŠ¨ï¼Œæ­£å¦‚ Neon çš„ **[å®˜æ–¹ Node.js æ–‡æ¡£](https://neon.tech/docs/guides/node)** ä¸­æ‰€æè¿°çš„ â€” å‚è§ **[æ–‡æ¡£](#postgresjs)**ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm @neondatabase/serverless
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢
<CodeTabs items={["Neon HTTP", "Neon Websockets", "node-postgres", "postgres.js"]}>
```typescript
import { drizzle } from 'drizzle-orm/neon-http';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');
```
<Section> 
```typescript 
import { drizzle } from 'drizzle-orm/neon-serverless';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');
```
```typescript
// å¯¹äº Node.js - ç¡®ä¿å®‰è£… 'ws' å’Œ 'bufferutil' åŒ…
import { drizzle } from 'drizzle-orm/neon-serverless';
import ws from 'ws';

const db = drizzle({
  connection: process.env.DATABASE_URL,
  ws: ws,
});

const result = await db.execute('select 1');
```
<Callout type="warning" emoji="âš™ï¸"> 
åœ¨ `WebSocket` å…¨å±€æœªå®šä¹‰çš„ç¯å¢ƒï¼ˆä¾‹å¦‚ Node.jsï¼‰ä¸­ä½¿ç”¨ WebSockets éœ€è¦é¢å¤–çš„é…ç½®ã€‚ 
å°† `ws` å’Œ `bufferutil` åŒ…æ·»åŠ åˆ°é¡¹ç›®çš„ä¾èµ–ä¸­ï¼Œå¹¶åœ¨ Drizzle é…ç½®ä¸­è®¾ç½® `ws`ã€‚ 
</Callout>
</Section> 
```typescript 
// ç¡®ä¿å®‰è£… 'pg' åŒ… 
import { drizzle } from 'drizzle-orm/node-postgres';

const db = drizzle(process.env.DATABASE_URL);
 
const result = await db.execute('select 1');
```
```typescript
// ç¡®ä¿å®‰è£… 'postgres' åŒ…
import { drizzle } from 'drizzle-orm/postgres-js';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

<CodeTabs items={["Neon HTTP", "Neon Websockets", "node-postgres", "postgres.js"]}>
```typescript
import { neon } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';

const sql = neon(process.env.DATABASE_URL!);
const db = drizzle({ client: sql });

const result = await db.execute('select 1');
```
<Section> 
```typescript 
import { Pool } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle({ client: pool });

const result = await db.execute('select 1');
```
```typescript
// å¯¹äº Node.js - ç¡®ä¿å®‰è£… 'ws' å’Œ 'bufferutil' åŒ…
import { Pool, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';

neonConfig.webSocketConstructor = ws;

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle({ client: pool });

const result = await db.execute('select 1');
```
<Callout type="warning" emoji="âš™ï¸"> 
åœ¨ `WebSocket` å…¨å±€æœªå®šä¹‰çš„ç¯å¢ƒï¼ˆä¾‹å¦‚ Node.jsï¼‰ä¸­ä½¿ç”¨ WebSockets éœ€è¦é¢å¤–çš„é…ç½®ã€‚ 
å°† `ws` å’Œ `bufferutil` åŒ…æ·»åŠ åˆ°é¡¹ç›®çš„ä¾èµ–ä¸­ï¼Œå¹¶åœ¨ Drizzle é…ç½®ä¸­è®¾ç½® `ws`ã€‚ 
</Callout>
</Section> 
```typescript 
// ç¡®ä¿å®‰è£… 'pg' åŒ… 
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });
 
const result = await db.execute('select 1');
```
```typescript
// ç¡®ä¿å®‰è£… 'postgres' åŒ…
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const queryClient = postgres(process.env.DATABASE_URL);
const db = drizzle({ client: queryClient });

const result = await db.execute('select 1');
```
</CodeTabs>

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>


Source: https://drizzle.zhcndoc.com/docs/connect-nile

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> Nile

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- Nile æ•°æ®åº“ - [ç½‘ç«™](https://thenile.dev)
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://thenile.dev)**ï¼ŒNile æ˜¯ä¸ºå¤šç§Ÿæˆ·åº”ç”¨é‡æ–°è®¾è®¡çš„ PostgreSQLã€‚

è¯·æŸ¥çœ‹å®˜æ–¹ **[Nile + Drizzle å¿«é€Ÿå…¥é—¨](https://www.thenile.dev/docs/getting-started/languages/drizzle)** å’Œ **[è¿ç§»](https://www.thenile.dev/docs/getting-started/schema_migrations/drizzle)** æ–‡æ¡£ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ Nile ä¸ä»»ä½• Drizzle çš„ Postgres é©±åŠ¨ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹æ–‡ä¸­å±•ç¤º `node-postgres` çš„ä½¿ç”¨ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…è½¯ä»¶åŒ…

<Npm>
drizzle-orm postgres
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢

```typescript copy filename="index.ts"
// ç¡®ä¿å®‰è£…äº† 'pg' åŒ…
import { drizzle } from 'drizzle-orm/node-postgres'

const db = drizzle(process.env.NILEDB_URL);

const response = await db.select().from(...);
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ï¼š

```typescript copy filename="index.ts"
// ç¡®ä¿å®‰è£…äº† 'pg' åŒ…
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });

const response = await db.select().from(...);
```

#### è¿æ¥åˆ°è™šæ‹Ÿç§Ÿæˆ·æ•°æ®åº“

Nile æä¾›è™šæ‹Ÿç§Ÿæˆ·æ•°æ®åº“ï¼Œå½“æ‚¨è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡æ—¶ï¼ŒNile ä¼šå°†æ‚¨çš„æŸ¥è¯¢å®šå‘åˆ°è¯¥ç‰¹å®šç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“ï¼Œæ‰€æœ‰æŸ¥è¯¢éƒ½å°†åº”ç”¨äºè¯¥ç§Ÿæˆ·ï¼ˆå³ `select * from table` å°†ä»…è¿”å›è¯¥ç§Ÿæˆ·çš„è®°å½•ï¼‰ã€‚

ä¸ºäº†è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæŸ¥è¯¢åŒ…è£…åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œåœ¨è¿è¡Œäº‹åŠ¡ä¹‹å‰è®¾ç½®é€‚å½“çš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€‚

å¯ä»¥å°†ç§Ÿæˆ· ID ä½œä¸ºå‚æ•°ç®€å•åœ°ä¼ é€’ç»™åŒ…è£…å™¨ï¼š

```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import { todosTable, tenants } from "./db/schema";
import { sql } from 'drizzle-orm';
import 'dotenv/config';

const db = drizzle(process.env.NILEDB_URL);

function tenantDB<T>(tenantId: string, cb: (tx: any) => T | Promise<T>): Promise<T> {
  return db.transaction(async (tx) => {
    if (tenantId) {
      await tx.execute(sql`set local nile.tenant_id = '${sql.raw(tenantId)}'`);
    }

    return cb(tx);
  }) as Promise<T>;
}

// åœ¨ Web åº”ç”¨ä¸­ï¼Œæ‚¨å¯èƒ½ä¼šä»è¯·æ±‚è·¯å¾„å‚æ•°æˆ–å¤´è·å–ç§Ÿæˆ· ID
const tenantId = '01943e56-16df-754f-a7b6-6234c368b400'

const response = await tenantDB(tenantId, async (tx) => {
    // è¿™é‡Œä¸éœ€è¦ "where" å­å¥
    return await tx.select().from(todosTable);
});

console.log(response);
```

å¦‚æœæ‚¨ä½¿ç”¨æ”¯æŒçš„ Web æ¡†æ¶ï¼Œå¯ä»¥è®¾ç½® [AsyncLocalStorage](https://nodejs.org/api/async_context.html) å¹¶ä½¿ç”¨ä¸­é—´ä»¶å°†å…¶å¡«å……ç§Ÿæˆ· IDã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨çš„ Drizzle å®¢æˆ·ç«¯è®¾ç½®å°†æ˜¯ï¼š

```typescript copy filename="db/index.ts
import { drizzle } from 'drizzle-orm/node-postgres';
import dotenv from "dotenv/config";
import { sql } from "drizzle-orm";
import { AsyncLocalStorage } from "async_hooks";

export const db = drizzle(process.env.NILEDB_URL);
export const tenantContext = new AsyncLocalStorage<string | undefined>();

export function tenantDB<T>(cb: (tx: any) => T | Promise<T>): Promise<T> {
  return db.transaction(async (tx) => {
    const tenantId = tenantContext.getStore();
    console.log("æ‰§è¡ŒæŸ¥è¯¢çš„ç§Ÿæˆ·: " + tenantId);
    // å¦‚æœå­˜åœ¨ç§Ÿæˆ· IDï¼Œå°†å…¶è®¾ç½®åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­
    if (tenantId) {
      await tx.execute(sql`set local nile.tenant_id = '${sql.raw(tenantId)}'`);
    }

    return cb(tx);
  }) as Promise<T>;
}
```

ç„¶åï¼Œé…ç½®ä¸­é—´ä»¶ä»¥å¡«å…… AsyncLocalStorageï¼Œå¹¶åœ¨å¤„ç†è¯·æ±‚æ—¶ä½¿ç”¨ `tenantDB` æ–¹æ³•ï¼š

```typescript copy filename="app.ts"
// ä¸­é—´ä»¶ä»¥è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
app.use("/api/tenants/:tenantId/*", async (c, next) => {
  const tenantId = c.req.param("tenantId");
  console.log("å°†ä¸Šä¸‹æ–‡è®¾ç½®ä¸ºç§Ÿæˆ·: " + tenantId);
  return tenantContext.run(tenantId, () => next());
});

// è·¯ç”±å¤„ç†ç¨‹åº
app.get("/api/tenants/:tenantId/todos", async (c) => {
    const todos = await tenantDB(c, async (tx) => {
      return await tx
        .select({
          id: todoSchema.id,
          tenant_id: todoSchema.tenantId,
          title: todoSchema.title,
          estimate: todoSchema.estimate,
        })
        .from(todoSchema);
    });
    return c.json(todos);
});
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>





Source: https://drizzle.zhcndoc.com/docs/connect-op-sqlite

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';

# Drizzle \<\> OP SQLite
æ ¹æ® **[å®˜æ–¹ GitHub é¡µé¢](https://github.com/OP-Engineering/op-sqlite)**ï¼Œ 
OP-SQLite åµŒå…¥äº†æœ€æ–°ç‰ˆæœ¬çš„ SQLiteï¼Œå¹¶æä¾›äº†æ‰§è¡Œ SQL æŸ¥è¯¢çš„ä½çº§ APIã€‚

<Npm>
drizzle-orm @op-engineering/op-sqlite
-D drizzle-kit 
</Npm>

```ts
import { drizzle } from "drizzle-orm/op-sqlite";
import { open } from '@op-engineering/op-sqlite';

const opsqlite = open({
  name: 'myDB',
});
const db = drizzle(opsqlite);

await db.select().from(users);
```

ä½ å¯ä»¥ä½¿ç”¨ Drizzle Kit æ¥ç”Ÿæˆ SQL è¿ç§»ã€‚  
åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿æŸ¥çœ‹ [Drizzle Kit è¿ç§»](/docs/kit-overview) çš„å·¥ä½œåŸç†ã€‚  
OP SQLite è¦æ±‚ä½ å°† SQL è¿ç§»æ†ç»‘åˆ°åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†ã€‚

<Steps>

#### å®‰è£… babel æ’ä»¶
å°† SQL è¿ç§»æ–‡ä»¶ç›´æ¥æ†ç»‘ä¸ºå­—ç¬¦ä¸²åˆ°ä½ çš„åŒ…ä¸­æ˜¯å¿…è¦çš„ã€‚
```shell
npm install babel-plugin-inline-import
```

#### æ›´æ–°é…ç½®æ–‡ä»¶ã€‚
ä½ éœ€è¦æ›´æ–° `babel.config.js`ã€`metro.config.js` å’Œ `drizzle.config.ts` æ–‡ä»¶
```js filename='babel.config.js'
module.exports = {
  presets: ['module:@react-native/babel-preset'],
  plugins: [
    [
      'inline-import',
      {
        extensions: ['.sql'],
      },
    ],
  ],
};
```

```js filename="metro.config.js"
const { getDefaultConfig } = require('@react-native/metro-config');

const config = getDefaultConfig(__dirname);

config.resolver.sourceExts.push('sql');

module.exports = config;
```

ç¡®ä¿åœ¨ Drizzle Kit é…ç½®ä¸­æœ‰ `dialect: 'sqlite'` å’Œ `driver: 'expo'`
```ts filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
	schema: './db/schema.ts',
	out: './drizzle',
  dialect: 'sqlite',
	driver: 'expo', // <--- éå¸¸é‡è¦
});
```

#### ç”Ÿæˆè¿ç§»
åœ¨åˆ›å»º SQL æ¶æ„æ–‡ä»¶å’Œ drizzle.config.ts æ–‡ä»¶åï¼Œä½ å¯ä»¥ç”Ÿæˆè¿ç§»
```bash
npx drizzle-kit generate
```

#### å°†è¿ç§»æ·»åŠ åˆ°ä½ çš„åº”ç”¨
ç°åœ¨ä½ éœ€è¦ä» `./drizzle` æ–‡ä»¶å¤¹å°† `migrations.js` æ–‡ä»¶å¯¼å…¥åˆ°ä½ çš„ Expo/React Native åº”ç”¨ä¸­ã€‚ 
ä½ å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨æ—¶ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ `useMigrations` è¿ç§»é’©å­åœ¨ `useEffect` é’©å­ä¸­æ‰‹åŠ¨è¿è¡Œè¿ç§»ã€‚

```ts filename="App.tsx"
import { drizzle } from "drizzle-orm/op-sqlite";
import { open } from '@op-engineering/op-sqlite';
import { useMigrations } from 'drizzle-orm/op-sqlite/migrator';
import migrations from './drizzle/migrations';

const opsqliteDb = open({
  name: 'myDB',
});

const db = drizzle(opsqliteDb);

export default function App() {
  const { success, error } = useMigrations(db, migrations);

  if (error) {
    return (
      <View>
        <Text>è¿ç§»é”™è¯¯ï¼š{error.message}</Text>
      </View>
    );
  }

  if (!success) {
    return (
      <View>
        <Text>è¿ç§»æ­£åœ¨è¿›è¡Œä¸­...</Text>
      </View>
    );
  }

  return ...ä½ çš„åº”ç”¨ç»„ä»¶;
}
```

</Steps>



Source: https://drizzle.zhcndoc.com/docs/connect-overview

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from "@mdx/Section.astro";
import LinksList from "@mdx/LinksList.astro"
import Flex from "@mdx/Flex.astro"

# ä¸ Drizzle çš„æ•°æ®åº“è¿æ¥
Drizzle ORM é€šè¿‡ **æ•°æ®åº“é©±åŠ¨** åœ¨æ‚¨çš„æ•°æ®åº“ä¸Šè¿è¡Œ SQL æŸ¥è¯¢ã€‚
<CodeTabs items={["index.ts", "schema.ts"]}>

<CodeTab>
```ts
import { drizzle } from "drizzle-orm/node-postgres"
import { users } from "./schema"

const db = drizzle(process.env.DATABASE_URL);
const usersCount = await db.$count(users);
```
```  
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   db.$count(users)   â”‚ <--- drizzle æŸ¥è¯¢
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     
                            â”‚               ÊŒ
select count(*) from users -â”‚               â”‚
                            â”‚               â”‚- [{ count: 0 }]
                            v               â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    node-postgres    â”‚ <--- æ•°æ®åº“é©±åŠ¨
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚               ÊŒ
01101000 01100101 01111001 -â”‚               â”‚
                            â”‚               â”‚- 01110011 01110101 01110000
                            v               â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚      æ•°æ®åº“        â”‚ 
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</CodeTab>

```ts
import { pgTable, integer, text } from "drizzle-orm";

export const users = pgTable("users", {
  id: integer("id").generateAlwaysAsIdentity(),
  name: text("name"),
})
```
</CodeTabs>

åœ¨åå°ï¼ŒDrizzle ä¼šåˆ›å»ºä¸€ä¸ª **node-postgres** é©±åŠ¨å®ä¾‹ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥é€šè¿‡ `db.$client` è®¿é—®å®ƒã€‚
<Section>
```ts
import { drizzle } from "drizzle-orm/node-postgres"

const db = drizzle(process.env.DATABASE_URL);
const pool = db.$client;
```
```ts
// ä»¥ä¸Šä»£ç ç­‰ä»·äº
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });
```
</Section>

Drizzle çš„è®¾è®¡ä½¿å…¶ä¸æ¯ä¸€ç§ **è¾¹ç¼˜** æˆ– **æ— æœåŠ¡å™¨** è¿è¡Œæ—¶æœ¬åœ°å…¼å®¹ï¼Œæ— è®ºä½•æ—¶æ‚¨éœ€è¦è®¿é—®æ— æœåŠ¡å™¨æ•°æ®åº“ - æˆ‘ä»¬éƒ½ä¼šä¸ºæ‚¨æä¾›æ”¯æŒã€‚

<CodeTabs items={["Neon HTTP", "Neon with websockets", "Vercel Postgres", "PlanetScale HTTP", "Cloudflare d1"]}>
```ts
import { drizzle } from "drizzle-orm/neon-http";

const db = drizzle(process.env.DATABASE_URL);
```
```ts
import { drizzle } from "drizzle-orm/neon-serverless";

const db = drizzle(process.env.DATABASE_URL);
```
```ts
import { drizzle } from "drizzle-orm/vercel-postgres";

const db = drizzle();
```
```ts
import { drizzle } from "drizzle-orm/planetscale";

const db = drizzle(process.env.DATABASE_URL);
```
```ts
import { drizzle } from "drizzle-orm/d1";

const db = drizzle({ connection: env.DB });
```
</CodeTabs>

ç¡®å®ï¼Œæˆ‘ä»¬æ”¯æŒç‰¹å®šäºè¿è¡Œæ—¶çš„é©±åŠ¨ç¨‹åºï¼Œå¦‚ [Bun SQLite](/docs/connect-bun-sqlite) æˆ– [Expo SQLite](/docs/connect-expo-sqlite)ï¼š
<Section>
```ts
import { drizzle } from "drizzle-orm/bun-sqlite"

const db = drizzle(); // <--- will create an in-memory db
const db = drizzle("./sqlite.db");
```
```ts
import { drizzle } from "drizzle-orm/expo-sqlite";
import { openDatabaseSync } from "expo-sqlite";

const expo = openDatabaseSync("db.db");
const db = drizzle(expo);
```
</Section>

#### æ•°æ®åº“è¿æ¥ URL
ä»¥é˜²æ‚¨å¯¹æ•°æ®åº“è¿æ¥ URL æ¦‚å¿µä¸ç†Ÿæ‚‰
```
postgresql://alex:AbC123dEf@ep-cool-darkness-123456.us-east-2.aws.neon.tech/dbname
             â””â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜
              ÊŒ    ÊŒ          ÊŒ                                              ÊŒ
        è§’è‰² -â”‚    â”‚          â”‚- ä¸»æœºå                                    â”‚- æ•°æ®åº“
                   â”‚
                   â”‚- å¯†ç 

```
#### ä¸‹ä¸€æ­¥
æ¬¢è¿æŸ¥çœ‹æ¯ä¸ªé©±åŠ¨ç¨‹åºçš„æ–‡æ¡£  

<rem/>
<Flex>
  <LinksList 
    title='PostgreSQL é©±åŠ¨'
    links={[
        ["PostgreSQL", "/docs/get-started-postgresql"], 
        ["Neon", "/docs/connect-neon"], 
        ["Vercel Postgres", "/docs/connect-vercel-postgres"],
        ["Supabase", "/docs/connect-supabase"],
        ["Xata", "/docs/connect-xata"],
        ["PGLite", "/docs/connect-pglite"],
      ]}
  />
  <LinksList 
    title='MySQL é©±åŠ¨'
    links={[
        ["MySQL", "/docs/get-started-mysql"], 
        ["PlanetsScale", "/docs/connect-planetscale"], 
        ["TiDB", "/docs/connect-tidb"],
      ]}
  />
  <LinksList 
  title='SQLite é©±åŠ¨'
  links={[
      ["SQLite", "/docs/get-started-sqlite"], 
      ["Turso Cloud", "/docs/connect-turso"], 
      ["Turso Database", "/docs/connect-turso-database"], 
      ["Cloudflare D1", "/docs/connect-cloudflare-d1"],
      ["Bun SQLite", "/docs/connect-bun-sqlite"],
      ["SQLite Cloud", "/docs/connect-sqlite-cloud"],
    ]}
  />
  <LinksList 
  title='åŸç”Ÿ SQLite'
  links={[
      ["Expo SQLite", "/docs/get-started/expo-new"], 
      ["OP SQLite", "/docs/connect-op-sqlite"], 
      ["React Native SQLite", "/docs/connect-react-native-sqlite"],
    ]}
  />
  <LinksList 
  title='å…¶ä»–'
  links={[
      ["Drizzle Proxy", "/docs/connect-drizzle-proxy"], 
    ]}
  />
</Flex>
{/* TODO: @AndriiSherman ["AWS Data API", "/docs/get-started/aws-data-api"],  */}


Source: https://drizzle.zhcndoc.com/docs/connect-pglite

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> PGlite

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€çŸ¥è¯†](/docs/connect-overview) ä¸ Drizzle
- ElectricSQL - [ç½‘ç«™](https://electric-sql.com/)
- PgLite é©±åŠ¨ - [æ–‡æ¡£](https://pglite.dev/) & [GitHub](https://github.com/electric-sql/pglite)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ä»“åº“](https://github.com/electric-sql/pglite)**ï¼ŒPGlite æ˜¯ä¸€ä¸ªå°† Postgres æ‰“åŒ…åˆ° TypeScript å®¢æˆ·ç«¯åº“ä¸­çš„ WASM æ„å»ºï¼Œä½¿æ‚¨èƒ½å¤Ÿåœ¨æµè§ˆå™¨ã€Node.js å’Œ Bun ä¸­è¿è¡Œ Postgresï¼Œè€Œæ— éœ€å®‰è£…ä»»ä½•å…¶ä»–ä¾èµ–é¡¹ã€‚å‹ç¼©ååªæœ‰ 2.6mbã€‚

å®ƒå¯ä»¥ç”¨ä½œçŸ­æš‚çš„å†…å­˜æ•°æ®åº“ï¼Œæˆ–æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆNode/Bunï¼‰æˆ– indexedDBï¼ˆæµè§ˆå™¨ï¼‰ã€‚

ä¸ä¹‹å‰çš„â€œæµè§ˆå™¨ä¸­çš„ Postgresâ€é¡¹ç›®ä¸åŒï¼ŒPGlite ä¸ä½¿ç”¨ Linux è™šæ‹Ÿæœº - å®ƒåªæ˜¯ WASM ä¸­çš„ Postgresã€‚

#### ç¬¬ 1 æ­¥ - å®‰è£…è½¯ä»¶åŒ…

<Npm>
drizzle-orm @electric-sql/pglite
-D drizzle-kit
</Npm>

#### ç¬¬ 2 æ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢
<CodeTabs items={["å†…å­˜ä¸­", "ç›®å½•ä¸­", "ä½¿ç”¨é¢å¤–é…ç½®é€‰é¡¹"]}>
```typescript copy"
import { drizzle } from 'drizzle-orm/pglite';

const db = drizzle();

await db.select().from(...);
```
```typescript copy"
import { drizzle } from 'drizzle-orm/pglite';

const db = drizzle('path-to-dir');

await db.select().from(...);
```
```typescript copy"
import { drizzle } from 'drizzle-orm/pglite';

// connection æ˜¯ä¸€ä¸ªæœ¬åœ° PGLite é…ç½®
const db = drizzle({ connection: { dataDir: 'path-to-dir' }});

await db.select().from(...);
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy"
import { PGlite } from '@electric-sql/pglite';
import { drizzle } from 'drizzle-orm/pglite';

// å†…å­˜ä¸­çš„ Postgres
const client = new PGlite();
const db = drizzle({ client });

await db.select().from(users);
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>


Source: https://drizzle.zhcndoc.com/docs/connect-planetscale-postgres

import Npm from "@mdx/Npm.astro";
import Callout from "@mdx/Callout.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> PlanetScale Postgres

<Prerequisites>

- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- PlanetScale Postgres æ•°æ®åº“ - [æ–‡æ¡£](https://planetscale.com/docs/postgres)
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)

</Prerequisites>

PlanetScale åŒæ—¶æä¾› MySQLï¼ˆVitessï¼‰å’Œ PostgreSQL æ•°æ®åº“ã€‚æœ¬é¡µä»‹ç»å¦‚ä½•è¿æ¥åˆ° PlanetScale Postgresã€‚

å¯¹äº PlanetScale MySQLï¼Œè¯·å‚è§[PlanetScale MySQL è¿æ¥æŒ‡å—](/docs/connect-planetscale)ã€‚

ä½¿ç”¨ Drizzle ORMï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿æ¥ PlanetScale Postgresï¼š

- æ ‡å‡†çš„ `node-postgres` é©±åŠ¨
- ç”¨äºæ— æœåŠ¡å™¨ç¯å¢ƒçš„ `@neondatabase/serverless` é©±åŠ¨

æœ‰å…³åˆ›å»º PlanetScale Postgres æ•°æ®åº“åŠè·å–å‡­æ®çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚é˜…[PlanetScale Postgres æ–‡æ¡£](https://planetscale.com/docs/postgres/tutorials/planetscale-postgres-drizzle)ã€‚

## node-postgres

#### ç¬¬ 1 æ­¥ - å®‰è£…ä¾èµ–åŒ…

<Npm>drizzle-orm pg -D drizzle-kit @types/pg</Npm>

#### ç¬¬ 2 æ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢

<CodeTabs items={["è¿æ¥ URL", "ä½¿ç”¨é…ç½®", "ä½¿ç”¨å·²å­˜åœ¨å®¢æˆ·ç«¯"]}>
```typescript copy
import { drizzle } from 'drizzle-orm/node-postgres';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');

```
```typescript copy
import { drizzle } from 'drizzle-orm/node-postgres';

const db = drizzle({
  connection: {
    connectionString: process.env.DATABASE_URL,
    ssl: true
  }
});

const result = await db.execute('select 1');
```

```typescript copy
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });

const result = await db.execute("select 1");
```

</CodeTabs>

## Neon æ— æœåŠ¡å™¨é©±åŠ¨

PlanetScale Postgres ä¹Ÿæ”¯æŒé€šè¿‡[Neon æ— æœåŠ¡å™¨é©±åŠ¨](https://planetscale.com/docs/postgres/connecting/neon-serverless-driver)è¿æ¥ã€‚è¿™æ˜¯é’ˆå¯¹ Vercel Functionsã€Cloudflare Workers æˆ– AWS Lambda ç­‰æ— æœåŠ¡å™¨ç¯å¢ƒçš„ä¸é”™é€‰æ‹©ã€‚

è¯¥é©±åŠ¨æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

- **HTTP æ¨¡å¼** â€” å¯¹å•æ¡æŸ¥è¯¢å’Œéäº¤äº’å¼äº‹åŠ¡æ›´å¿«
- **WebSocket æ¨¡å¼** â€” é€‚ç”¨äºäº¤äº’å¼äº‹åŠ¡æˆ–åŸºäºä¼šè¯çš„åŠŸèƒ½

#### ç¬¬ 1 æ­¥ - å®‰è£…ä¾èµ–åŒ…

<Npm>drizzle-orm @neondatabase/serverless -D drizzle-kit</Npm>

#### ç¬¬ 2 æ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢

<CodeTabs items={["Neon HTTP", "Neon WebSockets"]}>
```typescript copy
import { neon, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';

// PlanetScale Postgres è¿æ¥æ‰€éœ€
neonConfig.fetchEndpoint = (host) => `https://${host}/sql`;

const sql = neon(process.env.DATABASE_URL!);
const db = drizzle({ client: sql });

const result = await db.execute('select 1');

```
<Section>
```typescript copy
import { Pool, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';

// PlanetScale Postgres è¿æ¥æ‰€éœ€
neonConfig.pipelineConnect = false;
neonConfig.wsProxy = (host, port) => `${host}/v2?address=${host}:${port}`;

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle({ client: pool });

const result = await db.execute('select 1');
```

```typescript copy
// é€‚ç”¨äº Node.js ç¯å¢ƒ - éœ€å®‰è£… 'ws' åŒ…
import ws from "ws";
import { Pool, neonConfig } from "@neondatabase/serverless";
import { drizzle } from "drizzle-orm/neon-serverless";

neonConfig.webSocketConstructor = ws;
// PlanetScale Postgres è¿æ¥æ‰€éœ€
neonConfig.pipelineConnect = false;
neonConfig.wsProxy = (host, port) => `${host}/v2?address=${host}:${port}`;

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle({ client: pool });

const result = await db.execute("select 1");
```

</Section>
</CodeTabs>

<Callout title="è¿æ¥ URL æ ¼å¼">
  {`postgresql://{ç”¨æˆ·å}:{å¯†ç }@{ä¸»æœº}:{ç«¯å£}/postgres?sslmode=verify-full`}
</Callout>

<Callout title="è¿æ¥ç«¯å£" type="info">
  PlanetScale Postgres æ”¯æŒä¸¤ä¸ªè¿æ¥ç«¯å£ï¼š

`5432`ï¼šç›´æ¥è¿æ¥åˆ° PostgreSQLã€‚è¿æ¥æ€»æ•°å—æ‚¨çš„é›†ç¾¤ `max_connections` è®¾ç½®é™åˆ¶ã€‚

`6432`ï¼šé€šè¿‡ PgBouncer è¿æ¥ä»¥å®ç°è¿æ¥æ± ã€‚æ¨èåœ¨å­˜åœ¨å¤§é‡å¹¶å‘è¿æ¥æ—¶ä½¿ç”¨ã€‚

</Callout>

#### æ¥ä¸‹æ¥ï¼Ÿ

<WhatsNextPostgres />

Source: https://drizzle.zhcndoc.com/docs/connect-planetscale

import Npm from "@mdx/Npm.astro";
import Callout from "@mdx/Callout.astro";
import Tabs from "@mdx/Tabs.astro";
import Tab from "@mdx/Tab.astro";
import AnchorCards from "@mdx/AnchorCards.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> PlanetScale MySQL

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- PlanetScale æ•°æ®åº“ - [å®˜ç½‘](https://planetscale.com/docs)
- PlanetScale HTTP é©±åŠ¨ - [GitHub](https://github.com/planetscale/database-js)
- Drizzle MySQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-mysql)
</Prerequisites>

PlanetScale æä¾› MySQLï¼ˆVitessï¼‰å’Œ PostgreSQL æ•°æ®åº“ã€‚æœ¬é¡µä»‹ç»å¦‚ä½•è¿æ¥ PlanetScale MySQLã€‚

å…³äº PlanetScale Postgresï¼Œè¯·å‚é˜… [PlanetScale Postgres è¿æ¥æŒ‡å—](/docs/connect-planetscale-postgres)ã€‚

ä½¿ç”¨ Drizzle ORMï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»–ä»¬å®˜æ–¹çš„ **[`database-js`](https://github.com/planetscale/database-js)** é©±åŠ¨ï¼Œä»æ— æœåŠ¡å™¨å’Œæœ‰æœåŠ¡å™¨ç¯å¢ƒè®¿é—® PlanetScale MySQLï¼Œä½¿ç”¨æˆ‘ä»¬çš„ `drizzle-orm/planetscale-serverless` åŒ…ã€‚

æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ TCP ä½¿ç”¨ `mysql2` é©±åŠ¨è®¿é—® PlanetScale MySQL â€” **[è¯·è§æ­¤å¤„](/docs/get-started-mysql)**

#### æ­¥éª¤ 1 - å®‰è£…è½¯ä»¶åŒ…

<Npm>drizzle-orm @planetscale/database -D drizzle-kit</Npm>

#### æ­¥éª¤ 2 - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢

```typescript copy"
import { drizzle } from "drizzle-orm/planetscale-serverless";

const db = drizzle({ connection: {
  host: process.env["DATABASE_HOST"],
  username: process.env["DATABASE_USERNAME"],
  password: process.env["DATABASE_PASSWORD"],
}});

const response = await db.select().from(...)
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy"
import { drizzle } from "drizzle-orm/planetscale-serverless";
import { Client } from "@planetscale/database";

const client = new Client({
  host: process.env["DATABASE_HOST"],
  username: process.env["DATABASE_USERNAME"],
  password: process.env["DATABASE_PASSWORD"],
});

const db = drizzle({ client });
```

è¯·åŠ¡å¿…æŸ¥çœ‹ PlanetScale å®˜æ–¹çš„ **[MySQL è¯¾ç¨‹](https://planetscale.com/courses/mysql-for-developers)**ï¼Œ  
æˆ‘ä»¬è®¤ä¸ºå®ƒä»¬éå¸¸ç²¾å½© ğŸ™Œ

#### æ¥ä¸‹æ¥åšä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres />

Source: https://drizzle.zhcndoc.com/docs/connect-prisma-postgres

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> Prisma Postgres
<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- Prisma Postgres æ— æœåŠ¡å™¨æ•°æ®åº“ - [å®˜ç½‘](https://prisma.io/postgres)
- Prisma Postgres ç›´æ¥è¿æ¥ - [æ–‡æ¡£](https://www.prisma.io/docs/postgres/database/direct-connections) 
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)
</Prerequisites>

Prisma Postgres æ˜¯ä¸€ä¸ªåŸºäº [unikernels](https://www.prisma.io/blog/announcing-prisma-postgres-early-access) æ„å»ºçš„æ— æœåŠ¡å™¨æ•°æ®åº“ã€‚å®ƒæ‹¥æœ‰å¤§é‡çš„å…è´¹é¢åº¦ï¼Œ[åŸºäºæ“ä½œçš„å®šä»·](https://www.prisma.io/blog/operations-based-billing) å¹¶ä¸”æ²¡æœ‰å†·å¯åŠ¨ã€‚

ä½ å¯ä»¥ä½¿ç”¨ PostgreSQL çš„ [`node-postgres`](https://node-postgres.com/) æˆ– [`postgres.js`](https://github.com/porsager/postgres) é©±åŠ¨è¿›è¡Œè¿æ¥ã€‚

<Callout type="info">
Prisma Postgres ä¹Ÿæœ‰ä¸€ä¸ª[æ— æœåŠ¡å™¨é©±åŠ¨](https://www.prisma.io/docs/postgres/database/serverless-driver)ï¼Œå°†æ¥ Drizzle ORM ä¼šæ”¯æŒå®ƒã€‚
</Callout>

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<CodeTabs items={["node-postgres (pg)", "postgres.js"]}>
<Npm>
drizzle-orm pg
-D drizzle-kit
</Npm>

<Npm>
drizzle-orm postres
-D drizzle-kit
</Npm>

</CodeTabs>


#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
<CodeTabs items={["node-postgres (pg)", "postgres.js"]}>
```typescript 
// ç¡®ä¿å®‰è£…äº† 'pg' åŒ… 
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });
 
const result = await db.execute('select 1');
```
```typescript
// ç¡®ä¿å®‰è£…äº† 'postgres' åŒ…
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const queryClient = postgres(process.env.DATABASE_URL);
const db = drizzle({ client: queryClient });

const result = await db.execute('select 1');
```
</CodeTabs>

#### æ¥ä¸‹æ¥ï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-react-native-sqlite

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';

# Drizzle \<\> React Native SQLite
è¯·ä½¿ç”¨ [`Expo SQLite`](#expo-sqlite) åœ¨ React Native åº”ç”¨ä¸­è¿è¡Œ Drizzle ORMã€‚  
æˆ‘ä»¬å‘ç°çš„å”¯ä¸€ [æµè¡Œåº“](https://github.com/andpor/react-native-sqlite-storage) ä¸æ”¯æŒæ–°çš„ Hermes JavaScript è¿è¡Œæ—¶ï¼Œ
è€Œ Hermes ç°åœ¨æ˜¯ React Native å’Œ Expo çš„é»˜è®¤æ ‡å‡†è¿è¡Œæ—¶ã€‚




Source: https://drizzle.zhcndoc.com/docs/connect-sqlite-cloud

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> SQLite äº‘ç«¯
<Prerequisites>
- ä½¿ç”¨ Drizzle è¿›è¡Œæ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- **SQLite äº‘æ•°æ®åº“** - [æ–‡æ¡£](https://docs.sqlitecloud.io/docs/overview)
- **SQLite äº‘é©±åŠ¨** - [æ–‡æ¡£](https://docs.sqlitecloud.io/docs/sdk-js-introduction) & [GitHub](https://github.com/sqlitecloud/sqlitecloud-js)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://docs.sqlitecloud.io/docs/overview)**ï¼ŒSQLite Clouds æ˜¯ä¸€ä¸ªæ‰˜ç®¡çš„ã€åˆ†å¸ƒå¼çš„å…³ç³»æ•°æ®åº“ç³»ç»Ÿï¼Œæ„å»ºäº SQLite æ•°æ®åº“å¼•æ“ä¹‹ä¸Šã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm@beta @sqlitecloud/drivers
-D drizzle-kit@beta
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
```typescript
import { drizzle } from 'drizzle-orm/sqlite-cloud';

const db = drizzle(process.env.SQLITE_CLOUD_CONNECTION_STRING);

const result = await db.execute('select 1');
```

å¦‚æœéœ€è¦æä¾›ä½ ç°æœ‰çš„é©±åŠ¨ï¼š

```typescript
import { Database } from '@sqlitecloud/drivers';
import { drizzle } from 'drizzle-orm/sqlite-cloud';

const client = new Database(process.env.SQLITE_CLOUD_CONNECTION_STRING!);
const db = drizzle({ client });

const result = await db.execute('select 1');
```

#### æ¥ä¸‹æ¥åšä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-supabase

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> Supabase

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://supabase.com/docs)**ï¼ŒSupabase æ˜¯ä¸€ä¸ªå¼€æºçš„ Firebase æ›¿ä»£å“ï¼Œæ—¨åœ¨ä½¿ç”¨æœ€å°çš„é…ç½®æ„å»ºå®‰å…¨ä¸”é«˜æ€§èƒ½çš„ Postgres åç«¯ã€‚

æŸ¥çœ‹å®˜æ–¹ **[Supabase + Drizzle](https://supabase.com/docs/guides/database/connecting-to-postgres#connecting-with-drizzle)** æ–‡æ¡£ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…è½¯ä»¶åŒ…

<Npm>
drizzle-orm postgres
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢

```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/postgres-js'

const db = drizzle(process.env.DATABASE_URL);

const allUsers = await db.select().from(...);
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š
```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

const client = postgres(process.env.DATABASE_URL)
const db = drizzle({ client });

const allUsers = await db.select().from(...);
```

å¦‚æœæ‚¨å†³å®šé€šè¿‡ Supabase ä½¿ç”¨è¿æ¥æ± ï¼ˆåœ¨ [è¿™é‡Œ](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler) æè¿°ï¼‰ï¼Œå¹¶å¯ç”¨äº†â€œäº‹åŠ¡â€æ± æ¨¡å¼ï¼Œåˆ™ç¡®ä¿å°† prepare å…³é—­ï¼Œå› ä¸ºä¸æ”¯æŒé¢„ç¼–è¯‘è¯­å¥ã€‚

```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

// ç¦ç”¨é¢„å–ï¼Œå› ä¸ºåœ¨â€œäº‹åŠ¡â€æ± æ¨¡å¼ä¸‹ä¸æ”¯æŒ 
const client = postgres(process.env.DATABASE_URL, { prepare: false })
const db = drizzle({ client });

const allUsers = await db.select().from(...);
```

ä½¿ç”¨è¿æ¥æ± è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“ä»¥é€‚åº” **æ— æœåŠ¡å™¨ç¯å¢ƒ**ï¼Œè€Œåœ¨ **é•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨** ä¸­ä½¿ç”¨ç›´æ¥è¿æ¥ã€‚

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>



Source: https://drizzle.zhcndoc.com/docs/connect-tidb

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Tabs from '@mdx/Tabs.astro';
import Tab from '@mdx/Tab.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> TiDB Serverless

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- TiDB æ•°æ®åº“ - [å®˜ç½‘](https://docs.pingcap.com/)
- TiDB HTTP é©±åŠ¨ - [å®˜ç½‘](https://docs.pingcap.com/tidbcloud/serverless-driver)
- Drizzle MySQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-mysql)
</Prerequisites>

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://www.pingcap.com/tidb-serverless/)**, 
TiDB Serverless æ˜¯ä¸€æ¬¾å®Œå…¨æ‰˜ç®¡ã€è‡ªä¸»çš„ DBaaSï¼Œå…·å¤‡ç¬æ—¶é›†ç¾¤é…ç½®å’ŒåŸºäºæ¶ˆè´¹çš„å®šä»·ã€‚

<Callout type="info" emoji="â„¹ï¸">
TiDB Serverless å…¼å®¹ MySQLï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨ [MySQL è¿æ¥æŒ‡å—](/docs/get-started-mysql) è¿›è¡Œè¿æ¥ã€‚
</Callout>

TiDB Serverless æä¾›äº†ä¸€ç§ [HTTP é©±åŠ¨](https://docs.pingcap.com/tidbcloud/serverless-driver) ç”¨äºè¾¹ç¼˜ç¯å¢ƒã€‚å®ƒé€šè¿‡ `drizzle-orm/tidb-serverless` åŒ…è¢« Drizzle ORM åŸç”Ÿæ”¯æŒã€‚

#### æ­¥éª¤ 1 - å®‰è£…åŒ…
<Npm>
drizzle-orm @tidbcloud/serverless
-D drizzle-kit
</Npm>

#### æ­¥éª¤ 2 - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/tidb-serverless';

const db = drizzle({ connection: { url: process.env.TIDB_URL }});

const response = await db.select().from(...)
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š
```typescript copy"
import { connect } from '@tidbcloud/serverless';
import { drizzle } from 'drizzle-orm/tidb-serverless';

const client = connect({ url: process.env.TIDB_URL });
const db = drizzle({ client });
```

#### ä¸‹ä¸€æ­¥ï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-turso-database

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import LibsqlTable from "@mdx/LibsqlTable.mdx";
import LibsqlTabs from "@mdx/LibsqlTabs.mdx";

# Drizzle \<\> Turso æ•°æ®åº“

<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- Turso æ•°æ®åº“ - [å®˜ç½‘](https://docs.turso.tech/introduction)
- Turso æ•°æ®åº“é©±åŠ¨ - [å®˜ç½‘](https://docs.turso.tech/connect/javascript) & [GitHub](https://github.com/tursodatabase/turso/tree/main/bindings/javascript)
</Prerequisites>

æ ¹æ®**[å®˜ç½‘](https://docs.turso.tech/introduction)**ï¼Œ  
Turso æ˜¯åœ¨ AI æ—¶ä»£åŠ©åŠ›ä½ å®ç°ä¼Ÿå¤§æ¢¦æƒ³çš„å°å‹æ•°æ®åº“ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm@beta @tursodatabase/database
-D drizzle-kit@beta
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢
```typescript
import { drizzle } from 'drizzle-orm/tursodatabase/database';

const db = drizzle('sqlite.db');

const result = await db.execute('select 1');
```

å¦‚æœä½ éœ€è¦æä¾›ä½ å·²æœ‰çš„é©±åŠ¨ï¼š

```typescript
import { Database } from '@tursodatabase/drivers';
import { drizzle } from 'drizzle-orm/tursodatabase/database';

const client = new Database('sqlite.db');
const db = drizzle({ client });

const result = await db.execute('select 1');
```

#### ä¸‹ä¸€æ­¥ï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-turso

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import LibsqlTable from "@mdx/LibsqlTable.mdx";
import LibsqlTabs from "@mdx/LibsqlTabs.mdx";

# Drizzle \<\> Turso äº‘ç«¯

<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- Turso äº‘ç«¯ - [å®˜ç½‘](https://docs.turso.tech/turso-cloud)
- Turso äº‘ç«¯é©±åŠ¨ - [å®˜ç½‘](https://docs.turso.tech/sdk/ts/reference) & [GitHub](https://github.com/tursodatabase/libsql-client-ts)
</Prerequisites>

æ ¹æ®**[å®˜æ–¹ç½‘ç«™](https://turso.tech/drizzle)**ï¼Œ  
Turso æ˜¯ä¸€ä¸ªåŸºäº **[libSQL](https://github.com/libsql/libsql)** çš„è¾¹ç¼˜ SQLite æ•°æ®åº“å³æœåŠ¡ã€‚

Drizzle ORM åŸç”Ÿæ”¯æŒ libSQL é©±åŠ¨ï¼Œ  
æˆ‘ä»¬æ”¯æŒ SQL æ–¹è¨€å’Œç‰¹å®šæ–¹è¨€çš„é©±åŠ¨å’Œè¯­æ³•ï¼Œå¹¶é•œåƒæœ€æµè¡Œçš„  
ç±»ä¼¼ SQLite çš„ `all`ã€`get`ã€`values` å’Œ `run` æŸ¥è¯¢æ–¹æ³•è¯­æ³•ã€‚

#### ç¬¬ 1 æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm @libsql/client
-D drizzle-kit
</Npm>

#### ç¬¬ 2 æ­¥ - åˆå§‹åŒ–é©±åŠ¨
Drizzle åŸç”Ÿæ”¯æŒæ‰€æœ‰ `@libsql/client` é©±åŠ¨å˜ä½“ï¼š

<LibsqlTable />

<br />

<LibsqlTabs />

å¦‚æœæ‚¨éœ€è¦æä¾›æ‚¨ç°æœ‰çš„é©±åŠ¨ï¼š

<CodeTabs items={["default", "web"]}>
```typescript copy
import { drizzle } from 'drizzle-orm/libsql';
import { createClient } from '@libsql/client';

const client = createClient({ 
  url: process.env.DATABASE_URL,
  authToken: process.env.DATABASE_AUTH_TOKEN
});

const db = drizzle({ client });

const result = await db.select().from(users).all()
```
```typescript copy
import { drizzle } from 'drizzle-orm/libsql/web';
import { createClient } from '@libsql/client/web';

const client = createClient({ 
  url: process.env.DATABASE_URL,
  authToken: process.env.DATABASE_AUTH_TOKEN
});

const db = drizzle({ client });

const result = await db.select().from(users).all()
```
</CodeTabs>

#### ç¬¬ 3 æ­¥ - æ‰§è¡ŒæŸ¥è¯¢

```ts
import { drizzle } from 'drizzle-orm/libsql';
import * as s from 'drizzle-orm/sqlite-core';

const db = drizzle({ connection: {
  url: process.env.DATABASE_URL, 
  authToken: process.env.DATABASE_AUTH_TOKEN 
}});

const users = s.sqliteTable("users", {
  id: s.integer(),
  name: s.text(),
})

const result = await db.select().from(users);
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/connect-vercel-postgres

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> Vercel Postgres

<Prerequisites>
- æ•°æ®åº“ [è¿æ¥åŸºç¡€](/docs/connect-overview) ä¸ Drizzle
- Vercel Postgres æ•°æ®åº“ - [ç½‘ç«™](https://vercel.com/docs/storage/vercel-postgres)
- Vercel Postgres é©±åŠ¨ - [æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/sdk) & [GitHub](https://github.com/vercel/storage/tree/main/packages/postgres)
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)
</Prerequisites>

æ ¹æ®ä»–ä»¬çš„ **[å®˜æ–¹ç½‘ç«™](https://vercel.com/docs/storage/vercel-postgres)**ï¼Œ
Vercel Postgres æ˜¯ä¸€ä¸ªæ— æœåŠ¡å™¨ SQL æ•°æ®åº“ï¼Œæ—¨åœ¨ä¸ Vercel Functions é›†æˆã€‚

Drizzle ORM åŸç”Ÿæ”¯æŒ **[@vercel/postgres](https://vercel.com/docs/storage/vercel-postgres)** æ— æœåŠ¡å™¨
é©±åŠ¨ä»¥åŠ `drizzle-orm/vercel-postgres` åŒ…å’Œ **[`postgres`](#postgresjs)** æˆ– **[`pg`](#node-postgres)**
é©±åŠ¨é€šè¿‡ `postgesql://` è®¿é—® Vercel Postgresã€‚

æŸ¥çœ‹å®˜æ–¹ **[Vercel Postgres + Drizzle](https://vercel.com/docs/storage/vercel-postgres/using-an-orm#drizzle)** æ–‡æ¡£ã€‚

#### æ­¥éª¤ 1 - å®‰è£…åŒ…

<Npm>
drizzle-orm @vercel/postgres
-D drizzle-kit
</Npm>

#### æ­¥éª¤ 2 - å‡†å¤‡ Vercel Postgres

æ ¹æ® **[å®˜æ–¹æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/quickstart)** è®¾ç½®é¡¹ç›®ã€‚

#### æ­¥éª¤ 3 - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢

```typescript copy
import { drizzle } from 'drizzle-orm/vercel-postgres';

const db = drizzle();

const result = await db.execute('select 1');
```

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy
import { sql } from '@vercel/postgres';
import { drizzle } from 'drizzle-orm/vercel-postgres';

const db = drizzle({ client: sql })

const result = await db.execute('select 1');
```

ä½¿ç”¨ **[@vercel/postgres](https://vercel.com/docs/storage/vercel-postgres)** æ— æœåŠ¡å™¨åŒ…
æ‚¨å¯ä»¥é€šè¿‡ websockets ä»æ—  TCP å¯ç”¨çš„æœåŠ¡å™¨å’Œæ— æœåŠ¡å™¨ç¯å¢ƒè®¿é—® Vercel Postgresï¼Œ
å¦‚ Cloudflare Workersã€‚
  
å¦‚æœæ‚¨æ‰“ç®—ä» _æœåŠ¡å™¨_ ç¯å¢ƒä½¿ç”¨ Vercel Postgresï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨ `@vercel/postgres` 
æˆ–ç›´æ¥é€šè¿‡ `postgesql://` è®¿é—®æ•°æ®åº“ï¼Œä½¿ç”¨ 
**[`postgres`](#postgresjs)** æˆ– **[`pg`](#node-postgres)**ã€‚

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>


Source: https://drizzle.zhcndoc.com/docs/connect-xata

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import CodeTabs from "@mdx/CodeTabs.astro";

# Drizzle \<\> Xata

<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- Drizzle PostgreSQL é©±åŠ¨ - [æ–‡æ¡£](/docs/get-started-postgresql)
</Prerequisites>

**[Xata](https://xata.io)** æ˜¯ä¸€ä¸ª PostgreSQL æ•°æ®åº“å¹³å°ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…ä»¥æ›´é«˜çš„ç”Ÿäº§åŠ›å’Œæ€§èƒ½ç®¡ç†å’Œæ‰©å±•æ•°æ®åº“ã€‚Xata æä¾›çš„åŠŸèƒ½åŒ…æ‹¬å³æ—¶çš„å†™æ—¶å¤åˆ¶æ•°æ®åº“åˆ†æ”¯ã€é›¶åœæœºæ¶æ„å˜æ›´ã€æ•°æ®åŒ¿ååŒ–ã€AI é©±åŠ¨çš„æ€§èƒ½ç›‘æ§ä»¥åŠè‡ªå¸¦äº‘ï¼ˆBYOCï¼‰ã€‚

æŸ¥çœ‹å®˜æ–¹ **[Xata + Drizzle](https://xata.io/documentation/quickstarts/drizzle)** æ–‡æ¡£ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…

<Npm>
drizzle-orm postgres
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢

```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/postgres-js'

const db = drizzle(process.env.DATABASE_URL);

const allUsers = await db.select().from(...);
```

å¦‚æœéœ€è¦æä¾›å·²æœ‰é©±åŠ¨ï¼š
```typescript copy filename="index.ts"
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

const client = postgres(process.env.DATABASE_URL)
const db = drizzle({ client });

const allUsers = await db.select().from(...);
```

#### ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/custom-types

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro'

# å®šä¹‰è‡ªå®šä¹‰ç±»å‹çš„å¸¸ç”¨æ–¹æ³•

## ç¤ºä¾‹

æŸ¥çœ‹ `customType` å®šä¹‰å¦‚ä½•å·¥ä½œçš„æœ€ä½³æ–¹æ³•æ˜¯æ£€æŸ¥å¦‚ä½•ä½¿ç”¨ Drizzle ORM ä¸­çš„ `customType` å‡½æ•°å®šä¹‰ç°æœ‰çš„æ•°æ®ç±»å‹ã€‚


<Callout title='info'>
æ¯ä¸ªæ–¹è¨€éƒ½æš´éœ²äº† `customType` å‡½æ•°

```ts
import { customType } from 'drizzle-orm/pg-core';
...
import { customType } from 'drizzle-orm/mysql-core';
...
import { customType } from 'drizzle-orm/sqlite-core';
...
import { customType } from 'drizzle-orm/gel-core';
...
import { customType } from 'drizzle-orm/singlestore-core';
```
</Callout>

**æ•´æ•°ï¼ˆIntegerï¼‰**
```typescript copy
import { customType } from 'drizzle-orm/pg-core';

const customSerial = customType<{ data: number; }>(
  {
    dataType() {
      return 'integer';
    },
  },
);
```

**æ–‡æœ¬ï¼ˆTextï¼‰**

```typescript copy
import { customType } from 'drizzle-orm/pg-core';

const customText = customType<{ data: string }>({
  dataType() {
    return 'text';
  },
});
```

**å¸ƒå°”å€¼ï¼ˆBooleanï¼‰**

```typescript copy
import { customType } from 'drizzle-orm/pg-core';

const customBoolean = customType<{ data: boolean }>({
  dataType() {
    return 'boolean';
  },
});
```

**Jsonb**

```typescript copy
import { customType } from 'drizzle-orm/pg-core';

const customJsonb = <TData>(name: string) =>
  customType<{ data: TData; driverData: string }>({
    dataType() {
      return 'jsonb';
    },
    toDriver(value: TData): string {
      return JSON.stringify(value);
    },
  })(name);
```

**æ—¶é—´æˆ³ï¼ˆTimestampï¼‰**

```typescript copy
import { customType } from 'drizzle-orm/pg-core';

const customTimestamp = customType<
  {
    data: Date;
    driverData: string;
    config: { withTimezone: boolean; precision?: number };
  }
>({
  dataType(config) {
    const precision = typeof config.precision !== 'undefined'
      ? ` (${config.precision})`
      : '';
    return `timestamp${precision}${
      config.withTimezone ? ' with time zone' : ''
    }`;
  },
  fromDriver(value: string): Date {
    return new Date(value);
  },
});
```

æ‰€æœ‰ç±»å‹çš„ç”¨æ³•ä¸ Drizzle ORM ä¸­å®šä¹‰çš„å‡½æ•°ç›¸åŒã€‚ä¾‹å¦‚ï¼š

```typescript copy
const usersTable = pgTable('users', {
  id: customSerial('id').primaryKey(),
  name: customText('name').notNull(),
  verified: customBoolean('verified').notNull().default(false),
  jsonb: customJsonb<string[]>('jsonb'),
  createdAt: customTimestamp('created_at', { withTimezone: true }).notNull()
    .default(sql`now()`),
});
```



## è‡ªå®šä¹‰ç±»å‹å®šä¹‰çš„ TS æ–‡æ¡£

æ‚¨å¯ä»¥æŸ¥çœ‹ `types` å’Œ `param` å®šä¹‰çš„ ts-docã€‚

```typescript
export interface CustomTypeValues = {
  /**
   * è‡ªå®šä¹‰åˆ—æ‰€éœ€çš„ç±»å‹ï¼Œå°†æ¨æ–­é€‚å½“çš„ç±»å‹æ¨¡å‹
   *
   * ç¤ºä¾‹ï¼š
   *
   * å¦‚æœæ‚¨å¸Œæœ›æ‚¨çš„åˆ—åœ¨é€‰æ‹©/æ’å…¥åä¸º `string` ç±»å‹ - ä½¿ç”¨ `data: string`ã€‚å¦‚ `text`ï¼Œ`varchar`
   *
   * å¦‚æœæ‚¨å¸Œæœ›æ‚¨çš„åˆ—åœ¨é€‰æ‹©/æ’å…¥åä¸º `number` ç±»å‹ - ä½¿ç”¨ `data: number`ã€‚å¦‚ `integer`
   */
  data: unknown;

  /**
 	 * ç±»å‹åŠ©æ‰‹ï¼Œè¡¨ç¤ºæ•°æ®åº“é©±åŠ¨ç¨‹åºé’ˆå¯¹ç‰¹å®šæ•°æ®åº“æ•°æ®ç±»å‹è¿”å›çš„æ•°æ®ç±»å‹
 	 *
 	 * ä»…åœ¨é©±åŠ¨ç¨‹åºçš„è¾“å‡ºå’Œè¾“å…¥ç±»å‹ä¸åŒçš„æƒ…å†µä¸‹éœ€è¦
 	 *
 	 * é»˜è®¤ä¸º {@link driverData}
 	 */
 	driverOutput?: unknown;

  /**
   * ç±»å‹åŠ©æ‰‹ï¼Œè¡¨ç¤ºæ•°æ®åº“é©±åŠ¨ç¨‹åºæ¥å—ç‰¹å®šæ•°æ®åº“æ•°æ®ç±»å‹çš„ç±»å‹
   */
  driverData?: unknown;

  /**
 	 * ç±»å‹åŠ©æ‰‹ï¼Œè¡¨ç¤ºå…³ç³»æŸ¥è¯¢èšåˆä¸º JSON åå­—æ®µè¿”å›çš„ç±»å‹
 	 */
 	jsonData?: unknown;

  /**
   * {@link CustomTypeParams} `dataType` ç”Ÿæˆåº”ä½¿ç”¨ä»€ä¹ˆé…ç½®ç±»å‹
   */
  config?: Record<string, unknown>;

  /**
   * å¦‚æœæ‚¨çš„è‡ªå®šä¹‰æ•°æ®ç±»å‹åº”é»˜è®¤ä¸ä¸ºç©ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `notNull: true`
   *
   * @example
   * const customSerial = customType<{ data: number, notNull: true, default: true }>({
   *    dataType() {
   *      return 'serial';
   *    },
   * });
   */
  notNull?: boolean;

  /**
   * å¦‚æœæ‚¨çš„è‡ªå®šä¹‰æ•°æ®ç±»å‹æœ‰é»˜è®¤å€¼ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `default: true`
   *
   * @example
   * const customSerial = customType<{ data: number, notNull: true, default: true }>({
   *    dataType() {
   *      return 'serial';
   *    },
   * });
   */
  default?: boolean;
};

export interface CustomTypeParams<T extends CustomTypeValues> {
  /**
   * ç”¨äºè¿ç§»çš„æ•°æ®åº“æ•°æ®ç±»å‹å­—ç¬¦ä¸²è¡¨ç¤º
   * @example
   * ```
   * `jsonb`, `text`
   * ```
   *
   * å¦‚æœæ•°æ®åº“æ•°æ®ç±»å‹éœ€è¦é™„åŠ å‚æ•°ï¼Œæ‚¨å¯ä»¥ä» `config` å‚æ•°ä¸­ä½¿ç”¨å®ƒä»¬
   * @example
   * ```
   * `varchar(256)`, `numeric(2,3)`
   * ```
   *
   * è¦ä½¿ `config` ä¸ºç‰¹å®šç±»å‹ï¼Œè¯·åœ¨ {@link CustomTypeValues} ä¸­ä½¿ç”¨é…ç½®æ³›å‹
   *
   * @example
   * ä½¿ç”¨ç¤ºä¾‹
   * ```
   *   dataType() {
   *     return 'boolean';
   *   },
   * ```
   * æˆ–
   * ```
   *   dataType(config) {
   *     return typeof config.length !== 'undefined' ? `varchar(${config.length})` : `varchar`;
   *   }
   * ```
   */
  dataType: (config: T['config']) => string;

  /**
   * å¯é€‰çš„æ˜ å°„å‡½æ•°ï¼Œä»‹äºç”¨æˆ·è¾“å…¥å’Œé©±åŠ¨ç¨‹åºä¹‹é—´
   * @example
   * ä¾‹å¦‚ï¼Œå½“ä½¿ç”¨ jsonb æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°† JS/TS å¯¹è±¡æ˜ å°„ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åå†™å…¥æ•°æ®åº“
   * ```
   * toDriver(value: TData): string {
   *   return JSON.stringify(value);
   * }
   * ```
   */
  toDriver?: (value: T['data']) => T['driverData'];

  /**
   * å¯é€‰çš„æ˜ å°„å‡½æ•°ï¼Œè´Ÿè´£å°†æ•°æ®ä»æ•°æ®åº“æ˜ å°„åˆ° JS/TS ä»£ç 
   * @example
   * ä¾‹å¦‚ï¼Œå½“ä½¿ç”¨æ—¶é—´æˆ³æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å­—ç¬¦ä¸²æ—¥æœŸè¡¨ç¤ºæ˜ å°„ä¸º JS æ—¥æœŸ
   * ```
   * fromDriver(value: string): Date {
   *  return new Date(value);
   * },
   * ```
   * 
   * è¿™ä¼šå°†è¿”å›çš„æ•°æ®ä»ï¼š
 	 * ```
 	 * {
 	 * 	customField: "2025-04-07T03:25:16.635Z";
 	 * }
 	 * ```
 	 * æ”¹å˜ä¸ºï¼š
 	 * ```
 	 * {
 	 * 	customField: new Date("2025-04-07T03:25:16.635Z");
 	 * }
 	 * ```
   */
  fromDriver?: (value: T['driverData']) => T['data'];

  /**
 	 * å¯é€‰çš„æ˜ å°„å‡½æ•°ï¼Œç”¨äºå°†æ•°æ®åº“ä¸­ä»¥ JSON å½¢å¼è¿”å›çš„æ•°æ®è½¬æ¢ä¸ºæœŸæœ›çš„æ ¼å¼
 	 *
 	 * ç”¨äº[å…³ç³»æŸ¥è¯¢](https://orm.drizzle.team/docs/rqb-v2)
 	 *
 	 * é»˜è®¤ä¸º {@link fromDriver} å‡½æ•°
 	 * @example
 	 * ä¾‹å¦‚ï¼Œå½“é€šè¿‡ [RQB](https://orm.drizzle.team/docs/rqb-v2) æˆ– [JSON å‡½æ•°](https://orm.drizzle.team/docs/json-functions) æŸ¥è¯¢ bigint åˆ—æ—¶ï¼Œç»“æœå­—æ®µä¼šä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ï¼Œè€Œä¸æ˜¯å¸¸è§„æŸ¥è¯¢çš„ bigint ç±»å‹
 	 * é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°æ¥å¤„ç†å­—æ®µæ˜ å°„ï¼š
 	 * ```
 	 * fromJson(value: string): bigint {
 	 * 	return BigInt(value);
 	 * },
 	 * ```
 	 *
 	 * è¿™ä¼šå°†è¿”å›çš„æ•°æ®ä»ï¼š
 	 * ```
 	 * {
 	 * 	customField: "5044565289845416380";
 	 * }
 	 * ```
 	 * æ”¹å˜ä¸ºï¼š
 	 * ```
 	 * {
 	 * 	customField: 5044565289845416380n;
 	 * }
 	 * ```
 	 */
 	fromJson?: (value: T['jsonData']) => T['data'];

  /**
 	 * å¯é€‰çš„é€‰æ‹©å™¨ä¿®æ”¹å‡½æ•°ï¼Œç”¨äºä¿®æ”¹ [JSON å‡½æ•°](https://orm.drizzle.team/docs/json-functions) ä¸­åˆ—çš„é€‰æ‹©
 	 *
 	 * é¢å¤–çš„æ˜ å°„éœ€æ±‚å¯é€šè¿‡ {@link fromJson} å‡½æ•°å¤„ç†
 	 *
 	 * ç”¨äº[å…³ç³»æŸ¥è¯¢](https://orm.drizzle.team/docs/rqb-v2)
 	 * @example
 	 * ä¾‹å¦‚ï¼Œä½¿ç”¨ bigint æ—¶éœ€è¦å°†å­—æ®µè½¬æ¢ä¸ºæ–‡æœ¬ä»¥ä¿æŒæ•°æ®å®Œæ•´æ€§
 	 * ```
 	 * forJsonSelect(identifier: SQL, sql: SQLGenerator, arrayDimensions?: number): SQL {
 	 * 	return sql`${identifier}::text`
 	 * },
 	 * ```
 	 *
 	 * è¿™ä¼šå°†æŸ¥è¯¢ä»ï¼š
 	 * ```
 	 * SELECT
 	 * 	row_to_json("t".*)
 	 * 	FROM
 	 * 	(
 	 * 		SELECT
 	 * 		"table"."custom_bigint" AS "bigint"
 	 * 		FROM
 	 * 		"table"
 	 * 	) AS "t"
 	 * ```
 	 * æ”¹å˜ä¸ºï¼š
 	 * ```
 	 * SELECT
 	 * 	row_to_json("t".*)
 	 * 	FROM
 	 * 	(
 	 * 		SELECT
 	 * 		"table"."custom_bigint"::text AS "bigint"
 	 * 		FROM
 	 * 		"table"
 	 * 	) AS "t"
 	 * ```
 	 *
 	 * æŸ¥è¯¢å¯¹è±¡è¿”å›çš„æ•°æ®ä¼šä»ï¼š
 	 * ```
 	 * {
 	 * 	bigint: 5044565289845416000; // ç”±äºç›´æ¥è½¬æ¢ä¸º JSON æ ¼å¼å¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±
 	 * }
 	 * ```
 	 * æ”¹å˜ä¸ºï¼š
 	 * ```
 	 * {
 	 * 	bigint: "5044565289845416380"; // ç”±äºè½¬æ¢å­—æ®µä¸ºæ–‡æœ¬å†è¿›è¡Œ JSON åŒ–ï¼Œæ•°æ®å¾—åˆ°ä¿ç•™
 	 * }
 	 * ```
 	 */
 	forJsonSelect?: (identifier: SQL, sql: SQLGenerator, arrayDimensions?: number) => SQL;
}
```

Source: https://drizzle.zhcndoc.com/docs/data-querying

import Callout from '@mdx/Callout.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from '@mdx/Section.astro';
import Flex from "@mdx/Flex.astro"
import LinksList from "@mdx/LinksList.astro"
import Prerequisites from "@mdx/Prerequisites.astro";

# Drizzle æŸ¥è¯¢ + CRUD

<Prerequisites>
  - å¦‚ä½•å®šä¹‰ä½ çš„æ¶æ„ - [æ¶æ„åŸºç¡€](/docs/sql-schema-declaration)
  - å¦‚ä½•è¿æ¥æ•°æ®åº“ - [è¿æ¥åŸºç¡€](/docs/connect-overview)
</Prerequisites>

Drizzle æä¾›äº†å‡ ç§æŸ¥è¯¢æ•°æ®åº“çš„æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ ¹æ®ä¸‹ä¸€ä¸ªé¡¹ç›®çš„éœ€è¦é€‰æ‹©åˆé€‚çš„æ–¹å¼ã€‚

å®ƒå¯ä»¥æ˜¯ç±»ä¼¼ SQL çš„è¯­æ³•æˆ–å…³ç³»è¯­æ³•ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬ï¼š

## ä¸ºä»€ä¹ˆé€‰æ‹© SQL ç±»ä¼¼è¯­æ³•ï¼Ÿ
\
**å¦‚æœä½ çŸ¥é“ SQLï¼Œä½ å°±èƒ½æŒæ¡ Drizzleã€‚**

å…¶ä»– ORM å’Œæ•°æ®æ¡†æ¶å¾€å¾€åç¦»æˆ–æŠ½è±¡ SQLï¼Œè¿™å¯¼è‡´äº†åŒé‡å­¦ä¹ æ›²çº¿ï¼šä½ éœ€è¦åŒæ—¶å­¦ä¹  SQL å’Œæ¡†æ¶çš„ APIã€‚

Drizzle åˆ™æ°æ°ç›¸åã€‚
æˆ‘ä»¬æ‹¥æŠ± SQLï¼Œå¹¶å°† Drizzle çš„æ ¸å¿ƒæ„å»ºæˆç±»ä¼¼ SQL çš„å½¢å¼ï¼Œä»¥ä¾¿ä½ å‡ ä¹æ²¡æœ‰å­¦ä¹ æ›²çº¿ï¼Œå¹¶èƒ½å®Œå…¨åˆ©ç”¨ SQL çš„å¼ºå¤§åŠŸèƒ½ã€‚

<Section>
```typescript copy
// è®¿é—®ä½ çš„æ•°æ®
await db
  .select()
	.from(posts)
	.leftJoin(comments, eq(posts.id, comments.post_id))
	.where(eq(posts.id, 10))
```
```sql
SELECT * 
FROM posts
LEFT JOIN comments ON posts.id = comments.post_id
WHERE posts.id = 10
```
</Section>

ä½¿ç”¨ SQL ç±»ä¼¼è¯­æ³•ï¼Œä½ å¯ä»¥å¤åˆ¶å¤§éƒ¨åˆ†çº¯ SQL ä¸­å¯ä»¥åšçš„äº‹æƒ…ï¼Œ
å¹¶æ¸…æ¥šçŸ¥é“ Drizzle å°†æ‰§è¡Œä»€ä¹ˆä»¥åŠä¼šç”Ÿæˆä»€ä¹ˆæŸ¥è¯¢ã€‚ä½ å¯ä»¥æ‰§è¡Œå„ç§èŒƒå›´çš„æŸ¥è¯¢ï¼Œ
åŒ…æ‹¬é€‰æ‹©ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼Œä»¥åŠä½¿ç”¨åˆ«åã€WITH å­å¥ã€å­æŸ¥è¯¢ã€å‡†å¤‡è¯­å¥ç­‰ã€‚
è®©æˆ‘ä»¬çœ‹æ›´å¤šç¤ºä¾‹ã€‚

<CodeTabs items={['æ’å…¥', 'æ›´æ–°', 'åˆ é™¤']}>
<Section>
```ts
await db.insert(users).values({ email: 'user@gmail.com' })
```
```sql
INSERT INTO users (email) VALUES ('user@gmail.com')
```
</Section>
<Section>
```ts
await db.update(users)
        .set({ email: 'user@gmail.com' })
        .where(eq(users.id, 1))
```
```sql
UPDATE users 
SET email = 'user@gmail.com'
WHERE users.id = 1
```
</Section>
<Section>
```ts
await db.delete(users).where(eq(users.id, 1))
```
```sql
DELETE FROM users WHERE users.id = 1
```
</Section>
</CodeTabs>

## ä¸ºä»€ä¹ˆä¸é€‰æ‹© SQL ç±»ä¼¼è¯­æ³•ï¼Ÿ

æˆ‘ä»¬å§‹ç»ˆåœ¨è¿½æ±‚ä¸€ä¸ªå®Œç¾å¹³è¡¡çš„è§£å†³æ–¹æ¡ˆã€‚è™½ç„¶ SQL ç±»ä¼¼æŸ¥è¯¢å¯ä»¥æ»¡è¶³ 100% çš„éœ€æ±‚ï¼Œ
ä½†åœ¨æŸäº›å¸¸è§åœºæ™¯ä¸­ï¼Œæ•°æ®çš„æŸ¥è¯¢å¯ä»¥æ›´é«˜æ•ˆã€‚

æˆ‘ä»¬æ„å»ºäº†æŸ¥è¯¢ APIï¼Œä»¥ä¾¿ä½ å¯ä»¥ä»¥æœ€æ–¹ä¾¿å’Œé«˜æ•ˆçš„æ–¹å¼ä»æ•°æ®åº“ä¸­è·å–å…³ç³»å‹ã€åµŒå¥—æ•°æ®ï¼Œ
è€Œæ— éœ€æ‹…å¿ƒè”æ¥æˆ–æ•°æ®æ˜ å°„ã€‚

**Drizzle æ€»æ˜¯è¾“å‡ºç¡®åˆ‡çš„ä¸€ä¸ª SQL æŸ¥è¯¢**ã€‚å¯ä»¥æ”¾å¿ƒåœ°ä¸æ— æœåŠ¡å™¨æ•°æ®åº“ä¸€èµ·ä½¿ç”¨ï¼Œ
è€Œæ— éœ€æ‹…å¿ƒæ€§èƒ½æˆ–å¾€è¿”æˆæœ¬ï¼

<Section>
```ts
const result = await db.query.users.findMany({
	with: {
		posts: true
	},
});
```
{/* ```sql
SELECT * FROM users ...
``` */}
</Section>

## é«˜çº§
ä½¿ç”¨ Drizzleï¼ŒæŸ¥è¯¢å¯ä»¥ä»¥ä½ æƒ³è¦çš„ä»»ä½•æ–¹å¼ç»„åˆå’Œåˆ†åŒºã€‚
ä½ å¯ä»¥ç‹¬ç«‹äºä¸»æŸ¥è¯¢ç»„åˆè¿‡æ»¤å™¨ï¼Œåˆ†ç¦»å­æŸ¥è¯¢æˆ–æ¡ä»¶è¯­å¥ï¼Œç­‰ç­‰ã€‚
è®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªé«˜çº§ç¤ºä¾‹ï¼š

#### ç»„åˆä¸€ä¸ª WHERE è¯­å¥ï¼Œç„¶ååœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒ
```ts
async function getProductsBy({
  name,
  category,
  maxPrice,
}: {
  name?: string;
  category?: string;
  maxPrice?: string;
}) {
  const filters: SQL[] = [];

  if (name) filters.push(ilike(products.name, name));
  if (category) filters.push(eq(products.category, category));
  if (maxPrice) filters.push(lte(products.price, maxPrice));

  return db
    .select()
    .from(products)
    .where(and(...filters));
}
```

#### å°†å­æŸ¥è¯¢åˆ†ç¦»åˆ°ä¸åŒå˜é‡ä¸­ï¼Œç„¶ååœ¨ä¸»æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒä»¬
```ts
const subquery = db
	.select()
	.from(internalStaff)
	.leftJoin(customUser, eq(internalStaff.userId, customUser.id))
	.as('internal_staff');

const mainQuery = await db
	.select()
	.from(ticket)
	.leftJoin(subquery, eq(subquery.internal_staff.userId, ticket.staffId));
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ
<br/>
<Flex>
  <LinksList 
    title='è®¿é—®ä½ çš„æ•°æ®'
    links={[
        ["æŸ¥è¯¢", "/docs/rqb"], 
        ["é€‰æ‹©", "/docs/select"],
        ["æ’å…¥", "/docs/insert"],
        ["æ›´æ–°", "/docs/update"],
        ["åˆ é™¤", "/docs/delete"],
        ["è¿‡æ»¤å™¨", "/docs/operators"],
        ["è”æ¥", "/docs/joins"],
        ["sql`` æ“ä½œç¬¦", "/docs/sql"],
      ]}
  />
  <LinksList 
    title='ä»é›¶åˆ°è‹±é›„'
    links={[
        ["è¿ç§»", "/docs/migrations"], 
      ]}
  />
</Flex>


Source: https://drizzle.zhcndoc.com/docs/delete

import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';

# SQL åˆ é™¤
æ‚¨å¯ä»¥åˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼š
```typescript copy
await db.delete(users);
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨å’Œæ¡ä»¶åˆ é™¤ï¼š
```typescript copy
await db.delete(users).where(eq(users.name, 'Dan'));
```

### é™åˆ¶

<IsSupportedChipGroup chips={{ 'PostgreSQL': false, 'MySQL': true, 'SQLite': true, 'SingleStore': true, 'MSSQL': false, 'CockroachDB': false }} />

ä½¿ç”¨ `.limit()` å‘æŸ¥è¯¢æ·»åŠ  `limit` å­å¥ - ä¾‹å¦‚ï¼š
<Section>
```typescript
await db.delete(users).where(eq(users.name, 'Dan')).limit(2);
```
```sql
delete from "users" where "users"."name" = $1 limit $2;
```
</Section>

### æŒ‰é¡ºåºæ’åˆ—
ä½¿ç”¨ `.orderBy()` å°† `order by` å­å¥æ·»åŠ åˆ°æŸ¥è¯¢ä¸­ï¼ŒæŒ‰æŒ‡å®šå­—æ®µå¯¹ç»“æœè¿›è¡Œæ’åºï¼š
<Section>
```typescript
import { asc, desc } from 'drizzle-orm';

await db.delete(users).where(eq(users.name, 'Dan')).orderBy(users.name);
await db.delete(users).where(eq(users.name, 'Dan')).orderBy(desc(users.name));

// æŒ‰å¤šä¸ªå­—æ®µæ’åº
await db.delete(users).where(eq(users.name, 'Dan')).orderBy(users.name, users.name2);
await db.delete(users).where(eq(users.name, 'Dan')).orderBy(asc(users.name), desc(users.name2));
```
```sql
delete from "users" where "users"."name" = $1 order by "name";
delete from "users" where "users"."name" = $1 order by "name" desc;

delete from "users" where "users"."name" = $1 order by "name", "name2";
delete from "users" where "users"."name" = $1 order by "name" asc, "name2" desc;
```
</Section>

### å¸¦è¿”å›å€¼çš„åˆ é™¤
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': true }} />
æ‚¨å¯ä»¥åœ¨ PostgreSQL å’Œ SQLite ä¸­åˆ é™¤ä¸€è¡Œå¹¶è·å–è¿”å›å€¼ï¼š
```typescript copy
const deletedUser = await db.delete(users)
  .where(eq(users.name, 'Dan'))
  .returning();

// éƒ¨åˆ†è¿”å›
const deletedUserIds: { deletedId: number }[] = await db.delete(users)
  .where(eq(users.name, 'Dan'))
  .returning({ deletedId: users.id });
```

## è¾“å‡º
<IsSupportedChipGroup chips={{ 'MSSQL': true }} />
æ‚¨ä¹Ÿå¯ä»¥åœ¨ PostgreSQL å’Œ SQLite ä¸­æ’å…¥ä¸€è¡Œå¹¶è·å–è¿”å›å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```typescript copy
await db.insert(users).values({ name: "Dan" }).output();

// éƒ¨åˆ†è¿”å›
await db.insert(users).values({ name: "Partial Dan" }).output({ insertedId: users.id });
```

## ä½¿ç”¨ WITH DELETE å­å¥

<Callout>
  æŸ¥çœ‹å¦‚ä½•ä½¿ç”¨ WITH è¯­å¥ä¸ [é€‰æ‹©](/docs/select#with-clause)ã€[æ’å…¥](/docs/insert#with-insert-clause)ã€[æ›´æ–°](/docs/update#with-update-clause)
</Callout>

ä½¿ç”¨ `with` å­å¥å¯ä»¥é€šè¿‡å°†å¤æ‚æŸ¥è¯¢åˆ†å‰²æˆç§°ä¸ºå…¬å…±è¡¨è¡¨è¾¾å¼ï¼ˆCTEï¼‰çš„å°å­æŸ¥è¯¢æ¥ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼š
<Section>
```typescript copy
const averageAmount = db.$with('average_amount').as(
  db.select({ value: sql`avg(${orders.amount})`.as('value') }).from(orders)
);

const result = await db
	.with(averageAmount)
	.delete(orders)
	.where(gt(orders.amount, sql`(select * from ${averageAmount})`))
	.returning({
		id: orders.id
	});
```
```sql
with "average_amount" as (select avg("amount") as "value" from "orders") 
delete from "orders" 
where "orders"."amount" > (select * from "average_amount") 
returning "id"
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/drizzle-config-file

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import SchemaFilePaths from "@mdx/SchemaFilePaths.mdx"
import Prerequisites from "@mdx/Prerequisites.astro"
import Dialects from "@mdx/Dialects.mdx"
import Drivers from "@mdx/Drivers.mdx"
import DriversExamples from "@mdx/DriversExamples.mdx"
import Npx from "@mdx/Npx.astro"

# Drizzle Kit é…ç½®æ–‡ä»¶
<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [é˜…è¯»è¿™é‡Œ](/docs/get-started)
- Drizzle æ¨¡å¼åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) ä»¥åŠ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
</Prerequisites>

Drizzle Kit å…è®¸æ‚¨åœ¨ `TypeScript` æˆ– `JavaScript` é…ç½®æ–‡ä»¶ä¸­å£°æ˜é…ç½®é€‰é¡¹ã€‚

<Section>
```plaintext {5}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ...
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```
<CodeTabs items={["drizzle.config.ts", "drizzle.config.js"]}>
<CodeTab>
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  out: "./drizzle",
});
```
</CodeTab>
<CodeTab>
```js
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  out: "./drizzle",
});
```
</CodeTab>
</CodeTabs>
</Section>

æ‰©å±•é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹
```ts collapsable
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  out: "./drizzle",
  dialect: "postgresql",
  schema: "./src/schema.ts",

  driver: "pglite",
  dbCredentials: {
    url: "./database/",
  },

  extensionsFilters: ["postgis"],
  schemaFilter: "public",
  tablesFilter: "*",

  introspect: {
    casing: "camel",
  },

  migrations: {
    prefix: "timestamp",
    table: "__drizzle_migrations__",
    schema: "public",
  },

  entities: {
    roles: {
      provider: '',
      exclude: [],
      include: []
    }
  },

  breakpoints: true,
  strict: true,
  verbose: true,
});
```

### å¤šä¸ªé…ç½®æ–‡ä»¶
æ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™åœ¨æ‚¨æœ‰å¤šä¸ªæ•°æ®åº“ç¯å¢ƒã€å¤šä¸ªæ•°æ®åº“æˆ–åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­æœ‰ä¸åŒæ•°æ®åº“æ—¶éå¸¸æœ‰ç”¨ï¼š
<Npx>
  drizzle-kit generate --config=drizzle-dev.config.ts
  drizzle-kit generate --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### è¿ç§»æ–‡ä»¶å¤¹
`out` å‚æ•°è®©æ‚¨å®šä¹‰è¿ç§»æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œè¿™æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤æ˜¯ `drizzle`ã€‚  
è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºæ‚¨å¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­æœ‰è®¸å¤šé’ˆå¯¹ä¸åŒæ•°æ®åº“çš„ç‹¬ç«‹æ¶æ„ï¼Œ
å¹¶ä¸ºå®ƒä»¬è®¾ç½®ä¸åŒçš„è¿ç§»æ–‡ä»¶å¤¹ã€‚  
  
è¿ç§»æ–‡ä»¶å¤¹åŒ…å« `.sql` è¿ç§»æ–‡ä»¶å’Œ `_meta` æ–‡ä»¶å¤¹ï¼Œåè€…ç”± `drizzle-kit` ä½¿ç”¨ã€‚

<Section>
```plaintext {3}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ...
 â”œ ğŸ“‚ drizzle
 â”‚ â”œ ğŸ“‚ 20242409125510_premium_mister_fear
 â”‚ â”œ ğŸ“œ user.ts 
 â”‚ â”œ ğŸ“œ post.ts 
 â”‚ â”” ğŸ“œ comment.ts 
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```
```ts {5}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql", // "mysql" | "sqlite" | "postgresql" | "turso" | "singlestore" | "mssql"
  schema: "./src/schema/*",
  out: "./drizzle",
});
```
</Section>

## ---

### `dialect`
<rem025/>

æ‚¨ä½¿ç”¨çš„æ•°æ®åº“çš„æ–¹è¨€ 
|               |                                                 |
| :------------ | :-----------------------------------            |
| ç±»å‹         | <Dialects/>                                     |
| é»˜è®¤        | --                                     |
| å‘½ä»¤        | `generate` `migrate` `push` `pull` `check` `up` |

<rem025/>
```ts {4}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "mysql", 
});
```


### `schema`
<rem025/>

[`glob`](https://www.digitalocean.com/community/tools/glob?comments=true&glob=/**/*.js&matches=false&tests=//%20This%20will%20match%20as%20it%20ends%20with%20'.js'&tests=/hello/world.js&tests=//%20This%20won't%20match!&tests=/test/some/globs)
 åŸºäºè·¯å¾„çš„ Drizzle æ¨¡å¼æ–‡ä»¶æˆ–åŒ…å«æ¨¡å¼æ–‡ä»¶çš„æ–‡ä»¶å¤¹ã€‚
|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `string` `string[]` |
| é»˜è®¤        | --                    |
| å‘½ä»¤        | `generate` `push`    |

<rem025/>
<SchemaFilePaths />


### `out`
<rem025/>

å®šä¹‰æ‚¨çš„ SQL è¿ç§»æ–‡ä»¶ã€æ¨¡å¼çš„ json å¿«ç…§ä»¥åŠæ¥è‡ª `drizzle-kit pull` å‘½ä»¤çš„ `schema.ts` çš„è¾“å‡ºæ–‡ä»¶å¤¹ã€‚
|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `string` `string[]` |
| é»˜è®¤        | `drizzle`                    |
| å‘½ä»¤        | `generate` `migrate` `push` `pull` `check` `up`    |

<rem025/>
```ts {4}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  out: "./drizzle", 
});
```

### `driver`
<rem025/>

Drizzle Kit ä¼šæ ¹æ®æä¾›çš„ `dialect` è‡ªåŠ¨é€‰æ‹©å½“å‰é¡¹ç›®ä¸­å¯ç”¨çš„æ•°æ®åº“é©±åŠ¨ï¼Œ
ä½†æŸäº›ä¾›åº”å•†ç‰¹å®šçš„æ•°æ®åº“éœ€è¦ä¸åŒçš„è¿æ¥å‚æ•°å­é›†ã€‚

`driver` é€‰é¡¹å…è®¸æ‚¨æ˜ç¡®é€‰æ‹©è¿™äº›ä¾‹å¤–é©±åŠ¨ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | <Drivers/> |
| é»˜è®¤        | --                    |
| å‘½ä»¤        | `migrate` `push` `pull`   |

<rem025/>

<DriversExamples />

## ---

### `dbCredentials`
<rem025/>

ä»¥ `url` çš„å½¢å¼æä¾›æ•°æ®åº“è¿æ¥å‡­æ®ï¼Œ
`user:password@host:port/db` å‚æ•°æˆ–ç‰¹å®šé©±åŠ¨ï¼ˆ<Drivers/>ï¼‰çš„è¿æ¥é€‰é¡¹ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | é©±åŠ¨è¿æ¥é€‰é¡¹çš„è”åˆ |
| é»˜è®¤       | --                    |
| å‘½ä»¤      | `migrate` `push` `pull`   |

<rem025/>

<CodeTabs items={["PostgreSQL", "MySQL", "SQLite", "Turso", "Cloudflare D1", "AWS Data API", "PGLite"]}>
<Section>
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "postgresql",
  dbCredentials: {
    url: "postgres://user:password@host:port/db",
  }
});
```
```ts
import { defineConfig } from 'drizzle-kit'

// é€šè¿‡è¿æ¥å‚æ•°
export default defineConfig({
  dialect: "postgresql",
  dbCredentials: {
    host: "host",
    port: 5432,
    user: "user",
    password: "password",
    database: "dbname",
    ssl: true, // å¯ä»¥æ˜¯å¸ƒå°”å€¼ | "require" | "allow" | "prefer" | "verify-full" | node:tls ä¸­çš„é€‰é¡¹
  }
});
```
</Section>
<Section>
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "mysql",
  dbCredentials: {
    url: "mysql://user:password@host:port/db",
  }
});
```
```ts
import { defineConfig } from 'drizzle-kit'

// é€šè¿‡è¿æ¥å‚æ•°
export default defineConfig({
  dialect: "mysql",
  dbCredentials: {
    host: "host",
    port: 5432,
    user: "user",
    password: "password",
    database: "dbname",
    ssl: "...", // å¯ä»¥æ˜¯: string | SslOptions (æ¥è‡ª mysql2 åŒ…çš„ ssl é€‰é¡¹)
  }
});
```
</Section>
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "sqlite",
  dbCredentials: {
    url: ":memory:", // å†…å­˜æ•°æ®åº“
    // æˆ–
    url: "sqlite.db", 
    // æˆ–
    url: "file:sqlite.db" // file: å‰ç¼€æ˜¯ libsql æ‰€éœ€çš„
  }
});
```
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "turso",
  dbCredentials: {
    url: "libsql://acme.turso.io" // è¿œç¨‹ Turso æ•°æ®åº“ url
    authToken: "...",

    // æˆ–å¦‚æœæ‚¨éœ€è¦æœ¬åœ°æ•°æ®åº“

    url: ":memory:", // å†…å­˜æ•°æ®åº“
    // æˆ–
    url: "file:sqlite.db", // file: å‰ç¼€æ˜¯ libsql æ‰€éœ€çš„
  }
});
```
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "sqlite",
  driver: "d1-http",
  dbCredentials: {
    accountId: "",
    databaseId: "",
    token: "",
  }
});
```
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "postgresql",
  driver: "aws-data-api",
  dbCredentials: {
    database: "database",
    resourceArn: "resourceArn",
    secretArn: "secretArn",
  },
});
```
```ts
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  dialect: "postgresql",
  driver: "pglite",
  dbCredentials: {
    url: "./database/", // æ•°æ®åº“æ–‡ä»¶å¤¹è·¯å¾„
  }
});
```
</CodeTabs>

### `migrations`
<rem025/>

è¿è¡Œ `drizzle-kit migrate` æ—¶ï¼ŒDrizzle ä¼šåœ¨æ‚¨çš„æ•°æ®åº“ä¸­è®°å½•æˆåŠŸåº”ç”¨è¿ç§»çš„æ—¥å¿—ï¼Œ
åä¸º `__drizzle_migrations` çš„æ—¥å¿—è¡¨åœ¨ `public` æ¨¡å¼ä¸‹ï¼ˆä»…é€‚ç”¨äº PostgreSQLï¼‰ã€‚

`migrations` é…ç½®é€‰é¡¹è®©æ‚¨å¯ä»¥æ›´æ”¹è¿ç§»æ—¥å¿— `table` åç§°å’Œ `schema`ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `{ table: string, schema: string }` |
| é»˜è®¤       | `{ table: "__drizzle_migrations", schema: "drizzle" }`                    |
| å‘½ä»¤      | `migrate`   |

<rem025/>

```ts
export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  migrations: {
    table: 'my-migrations-table', // é»˜è®¤æ˜¯ `__drizzle_migrations`
    schema: 'public', // ä»…åœ¨ PostgreSQL ä¸­ä½¿ç”¨ï¼Œé»˜è®¤æ˜¯ `drizzle`
  },
});
```

### `introspect`
<rem025/>

`drizzle-kit pull` å‘½ä»¤çš„é…ç½®ã€‚

`casing` è´Ÿè´£ä»£ç ä¸­çš„åˆ—é”®å¤§å°å†™

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `{ casing: "preserve" \| "camel" }` |
| é»˜è®¤       | `{ casing: "camel" }`                    |
| å‘½ä»¤      | `pull`   |

<rem025/>

<CodeTabs items={["camel", "preserve"]}>
<Section>
```ts
import * as p from "drizzle-orm/pg-core"

export const users = p.pgTable("users", {
  id: p.serial(),
  firstName: p.text("first-name"),
  lastName: p.text("LastName"),
  email: p.text(),
  phoneNumber: p.text("phone_number"),
});
```
```sql
SELECT a.attname AS column_name, format_type(a.atttypid, a.atttypmod) as data_type FROM pg_catalog.pg_attribute a;
```
``` 
 column_name   | data_type        
---------------+------------------------
 id            | serial
 first-name    | text
 LastName      | text
 email         | text
 phone_number  | text
```
</Section>
<Section>
```ts
import * as p from "drizzle-orm/pg-core"

export const users = p.pgTable("users", {
  id: p.serial(),
  "first-name": p.text("first-name"),
  LastName: p.text("LastName"),
  email: p.text(),
  phone_number: p.text("phone_number"),
});
```
```sql
SELECT a.attname AS column_name, format_type(a.atttypid, a.atttypmod) as data_type FROM pg_catalog.pg_attribute a;
```
``` 
 column_name   | data_type        
---------------+------------------------
 id            | serial
 first-name    | text
 LastName      | text
 email         | text
 phone_number  | text
```
</Section>
</CodeTabs>


## --- 

### `tablesFilter`
<Callout>
å¦‚æœæ‚¨æƒ³åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­è¿è¡Œå¤šä¸ªé¡¹ç›® - æŸ¥çœ‹ [æˆ‘ä»¬çš„æŒ‡å—](/docs/goodies#multi-project-schema)ã€‚
</Callout>
<rem025/>
`drizzle-kit push` å’Œ `drizzle-kit pull` é»˜è®¤ä¼šç®¡ç† `public` æ¨¡å¼ä¸‹çš„æ‰€æœ‰è¡¨ã€‚
æ‚¨å¯ä»¥é€šè¿‡ `tablesFilters`ã€`schemaFilter` å’Œ `extensionFilters` é€‰é¡¹é…ç½®è¡¨ã€æ¨¡å¼å’Œæ‰©å±•çš„åˆ—è¡¨ã€‚

`tablesFilter` é€‰é¡¹è®©æ‚¨æŒ‡å®šåŸºäº [`glob`](https://www.digitalocean.com/community/tools/glob?comments=true&glob=/**/*.js&matches=false&tests=//%20This%20will%20match%20as%20it%20ends%20with%20'.js'&tests=/hello/world.js&tests=//%20This%20won't%20match!&tests=/test/some/globs) çš„è¡¨åè¿‡æ»¤ï¼Œ
ä¾‹å¦‚ `["users", "user_info"]` æˆ–è€… `"user*"`

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `string` `string[]` |
| é»˜è®¤       | --                    |
| å‘½ä»¤      | `generate` `push` `pull`   |

<rem025/>
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  tablesFilter: ["users", "posts", "project1_*"],
});
```

### `schemaFilter`

è‡ª `1.0.0-beta.1` ç‰ˆæœ¬å¼€å§‹æœ‰æ‰€æ›´æ”¹ï¼

<Callout type='warning' collapsed="0.x ç‰ˆæœ¬ä¸­çš„è¡Œä¸º">
`drizzle-kit push` å’Œ `drizzle-kit pull` é»˜è®¤ä¼šç®¡ç† `public` æ¨¡å¼ä¸­çš„æ‰€æœ‰è¡¨ã€‚
æ‚¨å¯ä»¥é€šè¿‡ `tablesFilters`ã€`schemaFilter` å’Œ `extensionFilters` é€‰é¡¹é…ç½®è¡¨ã€æ¨¡å¼å’Œæ‰©å±•çš„åˆ—è¡¨ã€‚

`schemaFilter` é€‰é¡¹è®©æ‚¨æŒ‡å®š Drizzle Kit è¦ç®¡ç†çš„æ¨¡å¼åˆ—è¡¨

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `string[]` |
| é»˜è®¤       | `["public"]`                    |
| å‘½ä»¤      | `push` `pull`   |

</Callout>

<Callout>
å¦‚æœæ‚¨æƒ³åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­è¿è¡Œå¤šä¸ªé¡¹ç›® - æŸ¥çœ‹ [æˆ‘ä»¬çš„æŒ‡å—](/docs/goodies#multi-project-schema)ã€‚
</Callout>

`drizzle-kit push` å’Œ `drizzle-kit pull` é»˜è®¤ä¼šç®¡ç†æ‰€æœ‰æ¨¡å¼ã€‚

`schemaFilter` é€‰é¡¹å…è®¸æ‚¨æŒ‡å®šåŸºäº [`glob`](https://www.digitalocean.com/community/tools/glob?comments=true&glob=/**/*.js&matches=false&tests=//%20This%20will%20match%20as%20it%20ends%20with%20'.js'&tests=/hello/world.js&tests=//%20This%20won't%20match!&tests=/test/some/globs) çš„æ¨¡å¼åè¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ `["public", "auth"]` æˆ– `"tenant_*"`

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `string[]` |
| å‘½ä»¤          | `push` `pull`   |

<rem025/>

```ts
export default defineConfig({
  dialect: "postgresql",
  schemaFilter: ["public", "schema1", "schema2"],
});
```

### `extensionsFilters`
<rem025/>

æŸäº›æ‰©å±•å¦‚ [`postgis`](https://postgis.net/)ï¼Œåœ¨æ•°æ®åº“ä¸­å®‰è£…åï¼Œä¼šåœ¨å…¬å…±æ¨¡å¼ä¸­åˆ›å»ºå…¶è‡ªå·±çš„è¡¨ã€‚
è¿™äº›è¡¨å¿…é¡»è¢« `drizzle-kit push` æˆ– `drizzle-kit pull` å¿½ç•¥ã€‚

`extensionsFilters` é€‰é¡¹å…è®¸æ‚¨å£°æ˜ä¸€ä¸ªå®‰è£…æ‰©å±•çš„åˆ—è¡¨ï¼Œä»¥ä¾¿ Drizzle Kit å¿½ç•¥å…¶åœ¨æ¨¡å¼ä¸­çš„è¡¨ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `["postgis"]` |
| é»˜è®¤       | `[]`                    |
| å‘½ä»¤      | `push` `pull`   |

<rem025/>

```ts
export default defineConfig({
  dialect: "postgresql",
  extensionsFilters: ["postgis"],
});
```

## ---

### `entities`

æ­¤é…ç½®ç”¨äºè®¾ç½®æ•°æ®åº“ä¸­ç‰¹å®š `å®ä½“` çš„ç®¡ç†è®¾ç½®ã€‚

ç›®å‰ï¼Œå®ƒä»…åŒ…æ‹¬ `è§’è‰²`ï¼Œä½†æœ€ç»ˆæ‰€æœ‰æ•°æ®åº“å®ä½“å°†è¿ç§»åˆ°è¿™é‡Œï¼Œä¾‹å¦‚ `è¡¨`ã€`æ¨¡å¼`ã€`æ‰©å±•`ã€`å‡½æ•°`ã€`è§¦å‘å™¨` ç­‰ã€‚

#### `roles`

<rem025/>

å¦‚æœæ‚¨ä½¿ç”¨ Drizzle Kit æ¥ç®¡ç†æ‚¨çš„æ¶æ„ï¼Œç‰¹åˆ«æ˜¯å®šä¹‰çš„è§’è‰²ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›è§’è‰²æœªåœ¨ Drizzle æ¶æ„ä¸­å®šä¹‰çš„æƒ…å†µã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ› Drizzle Kit è·³è¿‡é‚£äº› `roles`ï¼Œè€Œæ— éœ€åœ¨æ‚¨çš„ Drizzle æ¶æ„ä¸­é€ä¸€å†™å‡ºæ¯ä¸ªè§’è‰²å¹¶ç”¨ `.existing()` æ ‡è®°ã€‚

`roles` é€‰é¡¹è®©æ‚¨å¯ä»¥ï¼š

- å¯ç”¨æˆ–ç¦ç”¨ä¸ Drizzle Kit çš„è§’è‰²ç®¡ç†ã€‚
- æ’é™¤ç‰¹å®šè§’è‰²ä¸è¢« Drizzle Kit ç®¡ç†ã€‚
- åŒ…å«ç‰¹å®šè§’è‰²ä»¥ä¾› Drizzle Kit ç®¡ç†ã€‚
- ä¸ºåƒ `Neon` å’Œ `Supabase` è¿™æ ·çš„æä¾›è€…å¯ç”¨æ¨¡å¼ï¼Œè¿™äº›æä¾›è€…ä¸ç®¡ç†å…¶ç‰¹å®šè§’è‰²ã€‚
- ç»„åˆä¸Šè¿°æ‰€æœ‰é€‰é¡¹ã€‚

|               |                       |
| :------------ | :-----------------    |
| ç±»å‹          | `boolean \| { provider: "neon" \| "supabase", include: string[], exclude: string[]}`|
| é»˜è®¤         | `false`                  |
| å‘½ä»¤          | `push` `pull` `generate` |

<rem025/>

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`drizzle-kit` ä¸ä¼šä¸ºæ‚¨ç®¡ç†è§’è‰²ï¼Œå› æ­¤æ‚¨éœ€è¦åœ¨ `drizzle.config.ts` ä¸­å¯ç”¨è¯¥åŠŸèƒ½ã€‚
```ts
export default defineConfig({
  dialect: "postgresql",
  entities: {
    roles: true
  }
});
```

**æ‚¨æœ‰ä¸€ä¸ªè§’è‰² `admin`ï¼Œå¹¶å¸Œæœ›å°†å…¶æ’é™¤åœ¨å¯ç®¡ç†è§’è‰²åˆ—è¡¨ä¹‹å¤–**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      exclude: ['admin']
    }
  }
});
```

**æ‚¨æ‹¥æœ‰ä¸€ä¸ªè§’è‰² `admin`ï¼Œå¹¶å¸Œæœ›å°†å…¶åŒ…å«åœ¨å¯ç®¡ç†è§’è‰²çš„åˆ—è¡¨ä¸­**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      include: ['admin']
    }
  }
});
```

å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ `Neon` å¹¶å¸Œæœ›æ’é™¤ç”± `Neon` å®šä¹‰çš„è§’è‰²ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æä¾›è€…é€‰é¡¹ã€‚

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      provider: 'neon'
    }
  }
});
```

**å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ `Supabase` å¹¶å¸Œæœ›æ’é™¤ç”± `Supabase` å®šä¹‰çš„è§’è‰²ï¼Œå¯ä»¥ä½¿ç”¨æä¾›è€…é€‰é¡¹**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      provider: 'supabase'
    }
  }
});
```

<Callout title='é‡è¦'>
æ‚¨å¯èƒ½ä¼šé‡åˆ° Drizzle ç›¸å¯¹äºæ•°æ®åº“æä¾›è€…æŒ‡å®šçš„æ–°è§’è‰²ç•¥æ˜¾è¿‡æ—¶çš„æƒ…å†µï¼Œ
å› æ­¤æ‚¨å¯èƒ½éœ€è¦åŒæ—¶ä½¿ç”¨ `provider` é€‰é¡¹å’Œ `exclude` é™„åŠ è§’è‰²ã€‚æ‚¨å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ Drizzle æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      provider: 'supabase',
      exclude: ['new_supabase_role']
    }
  }
});
```
</Callout>

## ---

### `strict`
<rem025/>

åœ¨è¿è¡Œ `drizzle-kit push` å‘½ä»¤æ—¶æç¤ºç¡®è®¤æ‰§è¡Œæ‰“å°çš„ SQL è¯­å¥ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `boolean` |
| é»˜è®¤         | `false`                    |
| å‘½ä»¤          | `push`   |

<rem025/>

```ts
export default defineConfig({
  dialect: "postgresql",
  strict: false,
});
```

### `verbose`
<rem025/>

åœ¨ `drizzle-kit push` å‘½ä»¤æœŸé—´æ‰“å°æ‰€æœ‰ SQL è¯­å¥ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `boolean` |
| é»˜è®¤         | `true`                    |
| å‘½ä»¤          | `generate` `pull`   |

<rem025/>

```ts
export default defineConfig({
  dialect: "postgresql",
  verbose: false,
});
```

### `breakpoints`
<rem025/>

Drizzle Kit å°†è‡ªåŠ¨åœ¨ç”Ÿæˆçš„ SQL è¿ç§»æ–‡ä»¶ä¸­åµŒå…¥ `--> statement-breakpoint`ï¼Œ
è¿™å¯¹äºä¸æ”¯æŒåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡Œå¤šä¸ª DDL æ›´æ”¹è¯­å¥çš„æ•°æ®åº“ï¼ˆMySQL å’Œ SQLiteï¼‰æ˜¯å¿…è¦çš„ã€‚

`breakpoints` é€‰é¡¹æ ‡å¿—å…è®¸æ‚¨å¼€å…³æ­¤åŠŸèƒ½ã€‚

|               |                      |
| :------------ | :-----------------   |
| ç±»å‹          | `boolean` |
| é»˜è®¤         | `true`                    |
| å‘½ä»¤          | `generate` `pull`   |

<rem025/>

```ts
export default defineConfig({
  dialect: "postgresql",
  breakpoints: false,
});
```

Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-check

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";


# `drizzle-kit check`

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [æŸ¥çœ‹è¿™é‡Œ](/docs/get-started)
- Drizzle schema åŸºç¡€çŸ¥è¯† - [æŸ¥çœ‹è¿™é‡Œ](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€çŸ¥è¯† - [æŸ¥çœ‹è¿™é‡Œ](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€çŸ¥è¯† - [æŸ¥çœ‹è¿™é‡Œ](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
- `drizzle-kit generate` å‘½ä»¤ - [æŸ¥çœ‹è¿™é‡Œ](/docs/drizzle-kit-generate)
</Prerequisites>

`drizzle-kit check` å‘½ä»¤å¯ä»¥è®©ä½ æ£€æŸ¥ç”Ÿæˆçš„ SQL è¿ç§»å†å²çš„ä¸€è‡´æ€§ã€‚

å½“å¤šä¸ªå¼€å‘è€…åœ¨é¡¹ç›®ä¸­å·¥ä½œå¹¶åœ¨ä¸åŒçš„åˆ†æ”¯ä¸Šæ›´æ”¹æ•°æ®åº“æ¨¡å¼æ—¶ï¼Œ
è¿™éå¸¸æœ‰ç”¨ - äº†è§£æ›´å¤šæœ‰å…³ [å›¢é˜Ÿè¿ç§»](/docs/kit-migrations-for-teams)ã€‚

<br/>
<hr/>
<br/>

`drizzle-kit check` å‘½ä»¤è¦æ±‚ä½ æŒ‡å®š `dialect` å’Œæ•°æ®åº“è¿æ¥å‡­æ®ï¼Œ
ä½ å¯ä»¥é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ– CLI é€‰é¡¹æä¾›å®ƒä»¬ã€‚

<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½œä¸º CLI é€‰é¡¹"]}>
<Section>
```ts {5,8}
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
});
```
```shell
npx drizzle-kit check
```
</Section>
```shell
npx drizzle-kit check --dialect=postgresql
```
</CodeTabs>

### åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶
ä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå½“ä½ æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µæˆ–åœ¨åŒä¸€é¡¹ç›®ä¸­æœ‰å¤šä¸ªæ•°æ®åº“æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼š
<Npx>
  drizzle-kit migrate --config=drizzle-dev.config.ts
  drizzle-kit migrate --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### æ‰©å±•é…ç½®é€‰é¡¹åˆ—è¡¨
æˆ‘ä»¬æ¨èé€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) æ–‡ä»¶é…ç½® `drizzle-kit`ï¼Œ
ä½†å¦‚æœ‰å¿…è¦ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ CLI æä¾›æ‰€æœ‰é…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨ CI/CD ç®¡é“ä¸­ç­‰ã€‚
<rem025/>
|           |            |                                                                         |
| :-------- | :--------- | :---------------------------------------------------------------------- |
| `dialect` | `required` | ä½ æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“æ–¹è¨€ã€‚å¯ä»¥æ˜¯ `postgresql`ã€`mysql` æˆ– `sqlite` |
| `out`     |            | è¿ç§»æ–‡ä»¶å¤¹ï¼Œé»˜è®¤ä¸º `./drizzle`                                       |
| `config`  |            | é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸º `drizzle.config.ts`                             |
<br/>
<Npx>
drizzle-kit check --dialect=postgresql
drizzle-kit check --dialect=postgresql --out=./migrations-folder
</Npx>


Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-export

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro"
import Npx from "@mdx/Npx.astro";
import SchemaFilePaths from "@mdx/SchemaFilePaths.mdx"
import Dialects from "@mdx/Dialects.mdx"

# `drizzle-kit export`

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [é˜…è¯»è¿™é‡Œ](/docs/get-started)
- Drizzle æ¶æ„åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
</Prerequisites>

<br/>

`drizzle-kit export` è®©ä½ å¯¼å‡º Drizzle æ¶æ„çš„ SQL è¡¨ç¤ºï¼Œå¹¶åœ¨æ§åˆ¶å°æ‰“å°å…¶ SQL DDL è¡¨ç¤ºã€‚
<Callout collapsed="å®ƒæ˜¯å¦‚ä½•åœ¨åå°å·¥ä½œçš„ï¼Ÿ">
Drizzle Kit `export` å‘½ä»¤è§¦å‘ä¸€ç³»åˆ—äº‹ä»¶ï¼š
1. å®ƒå°†è¯»å–ä½ çš„ Drizzle æ¶æ„æ–‡ä»¶å¹¶ç”Ÿæˆæ¶æ„çš„ JSON å¿«ç…§
3. åŸºäº JSON å·®å¼‚ï¼Œå®ƒå°†ç”Ÿæˆ SQL DDL è¯­å¥
4. è¾“å‡º SQL DDL è¯­å¥åˆ°æ§åˆ¶å°
</Callout>

å®ƒæ—¨åœ¨è¦†ç›– [ä»£ç ä¼˜å…ˆ](/docs/migrations) çš„ Drizzle è¿ç§»ç®¡ç†æ–¹æ³•ã€‚  
ä½ å¯ä»¥å¯¼å‡º Drizzle æ¶æ„çš„ SQL è¡¨ç¤ºï¼Œå…è®¸åƒ Atlas è¿™æ ·çš„å¤–éƒ¨å·¥å…·ä¸ºä½ å¤„ç†æ‰€æœ‰è¿ç§»ã€‚

`drizzle-kit export` å‘½ä»¤è¦æ±‚ä½ æä¾› `dialect` å’Œ `schema` è·¯å¾„é€‰é¡¹ï¼Œ  
ä½ å¯ä»¥é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ–é€šè¿‡ CLI é€‰é¡¹è®¾ç½®å®ƒä»¬ã€‚
<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½œä¸º CLI é€‰é¡¹"]}>
<Section>
```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
});
```
```shell
npx drizzle-kit export
```
</Section>

```shell
npx drizzle-kit export --dialect=postgresql --schema=./src/schema.ts
```
</CodeTabs>

### æ¶æ„æ–‡ä»¶è·¯å¾„
ä½ å¯ä»¥æ‹¥æœ‰ä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œæˆ–è€…æ ¹æ®éœ€è¦åœ¨é¡¹ç›®ä¸­åˆ†å¸ƒå¤šä¸ªæ¶æ„æ–‡ä»¶ã€‚  
Drizzle Kit è¦æ±‚ä½ é€šè¿‡ `schema` é…ç½®é€‰é¡¹æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨ [glob](https://www.digitalocean.com/community/tools/glob?comments=true&glob=/**/*.js&matches=false&tests=//%20This%20will%20match%20as%20it%20ends%20with%20'.js'&tests=/hello/world.js&tests=//%20This%20won't%20match!&tests=/test/some/globs) æ¥æŒ‡å®šè·¯å¾„ã€‚

<SchemaFilePaths/>

### ä¸€ä¸ªé¡¹ç›®ä¸­çš„å¤šä¸ªé…ç½®æ–‡ä»¶
ä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™åœ¨æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µæˆ–å¤šä¸ªæ•°æ®åº“ï¼Œæˆ–åŒä¸€é¡¹ç›®ä¸­ä½¿ç”¨ä¸åŒæ•°æ®åº“æ—¶éå¸¸æœ‰ç”¨ï¼š
<Npx>
  drizzle-kit export --config=drizzle-dev.config.ts
  drizzle-kit export --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### å¯ç”¨é…ç½®é¡¹çš„æ‰©å±•åˆ—è¡¨
`drizzle-kit export` æœ‰ä¸€ä¸ªä»…é™ CLI çš„é€‰é¡¹åˆ—è¡¨

<rem025/>

|               |                                                      |
| :--------     | :--------------------------------------------------- |
| `--sql`       | ç”Ÿæˆ Drizzle æ¶æ„çš„ SQL è¡¨ç¤º                              |

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrizzle Kit è¾“å‡º SQL æ–‡ä»¶ï¼Œä½†æœªæ¥æˆ‘ä»¬å¸Œæœ›æ”¯æŒä¸åŒçš„æ ¼å¼

<rem025/>

<Npx>
drizzle-kit push --name=init
drizzle-kit push --name=seed_users --custom
</Npx>

<br/>
<hr/>
<br/>
æˆ‘ä»¬æ¨èé€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) æ–‡ä»¶é…ç½® `drizzle-kit`ï¼Œ  
ä½†å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ CLI æä¾›æ‰€æœ‰é…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨ CI/CD ç®¡é“ä¸­ç­‰ã€‚

|               |            |                                                                            |
| :------------ | :-------   | :----------------------------------------------------------------------    |
| `dialect`     | `å¿…éœ€`     | æ•°æ®åº“æ–¹è¨€ï¼Œå¯é€‰å€¼è§ <Dialects/>                                       |
| `schema`      | `å¿…éœ€`     | TypeScript æ¶æ„æ–‡ä»¶æˆ–åŒ…å«å¤šä¸ªæ¶æ„æ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„                        |
| `config`      |            | é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤æ˜¯ `drizzle.config.ts`                                |

### ç¤ºä¾‹
å¦‚ä½•å°† Drizzle æ¶æ„å¯¼å‡ºåˆ°æ§åˆ¶å°ï¼ŒDrizzle æ¶æ„ä½äº `./src/schema.ts`

æˆ‘ä»¬è¿˜å°†æŠŠ Drizzle é…ç½®æ–‡ä»¶æ”¾åœ¨ `configs` æ–‡ä»¶å¤¹ä¸­ã€‚

è®©æˆ‘ä»¬åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

```plaintext {4}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ configs
 â”‚ â”” ğŸ“œ drizzle.config.ts
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ schema.ts
 â”” â€¦
```
```ts filename='drizzle.config.ts'
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
});
```

```ts filename='schema.ts'
import { pgTable, serial, text } from 'drizzle-orm/pg-core'

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	email: text('email').notNull(),
	name: text('name')
});
```

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œï¼š
```shell
npx drizzle-kit export --config=./configs/drizzle.config.ts
```
å®ƒå°†æˆåŠŸè¾“å‡º Drizzle æ¶æ„çš„ SQL è¡¨ç¤ºï¼š
```bash
CREATE TABLE "users" (
        "id" serial PRIMARY KEY NOT NULL,
        "email" text NOT NULL,
        "name" text
);
```

Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-generate

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro"
import Npx from "@mdx/Npx.astro";
import SchemaFilePaths from "@mdx/SchemaFilePaths.mdx"
import Dialects from "@mdx/Dialects.mdx"

# `drizzle-kit generate`

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/get-started)
- Drizzle æ¨¡å¼åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
</Prerequisites>


<br/>

`drizzle-kit generate` å…è®¸æ‚¨æ ¹æ® Drizzle æ¨¡å¼åœ¨å£°æ˜æ—¶æˆ–åç»­æ¨¡å¼æ›´æ”¹æ—¶ç”Ÿæˆ SQL è¿ç§»ã€‚
<Callout collapsed="å®ƒæ˜¯å¦‚ä½•åœ¨åå°å·¥ä½œçš„ï¼Ÿ">
Drizzle Kit `generate` å‘½ä»¤è§¦å‘ä»¥ä¸‹äº‹ä»¶åºåˆ—ï¼š
1. å®ƒå°†è¯»å–æ‚¨çš„ Drizzle æ¨¡å¼æ–‡ä»¶å¹¶åˆ›å»ºæ¨¡å¼çš„ JSON å¿«ç…§
2. å®ƒå°†è¯»å–æ‚¨å…ˆå‰çš„è¿ç§»æ–‡ä»¶å¤¹å¹¶å°†å½“å‰ JSON å¿«ç…§ä¸æœ€æ–°çš„å¿«ç…§è¿›è¡Œæ¯”è¾ƒ
3. åŸºäº JSON å·®å¼‚ï¼Œå®ƒå°†ç”Ÿæˆ SQL è¿ç§»
4. ä¿å­˜ `migration.sql` å’Œ `snapshot.json` åœ¨ä»¥å½“å‰æ—¶é—´æˆ³å‘½åçš„è¿ç§»æ–‡ä»¶å¤¹ä¸­

<Section>
```typescript filename="src/schema.ts"
import * as p from "./drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(), 
};
```
```                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit generate â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           
  â”” 1. è¯»å–å…ˆå‰çš„è¿ç§»æ–‡ä»¶å¤¹
    2. æ‰¾åˆ°å½“å‰å’Œå…ˆå‰æ¨¡å¼ä¹‹é—´çš„å·®å¼‚
    3. å¦‚æœéœ€è¦ï¼Œæç¤ºå¼€å‘è€…é‡å‘½å
  â”Œ 4. ç”Ÿæˆ SQL è¿ç§»å¹¶æŒä¹…åŒ–åˆ°æ–‡ä»¶
  â”‚    â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
  â”‚      ğŸ“‚ drizzle       
  â”‚      â”” ğŸ“‚ 20242409125510_premium_mister_fear
  â”‚        â”œ ğŸ“œ migration.sql
  â”‚        â”” ğŸ“œ snapshot.json
  v
```
```sql
-- drizzle/20242409125510_premium_mister_fear/migration.sql

CREATE TABLE "users" (
 "id" SERIAL PRIMARY KEY,
 "name" TEXT,
 "email" TEXT UNIQUE
);
```
</Section>
</Callout>

å®ƒæ—¨åœ¨è¦†ç›– [ä»£ç ä¼˜å…ˆ](/docs/migrations) çš„ Drizzle è¿ç§»ç®¡ç†æ–¹æ³•ã€‚
æ‚¨å¯ä»¥ä½¿ç”¨ [`drizzle-kit migrate`](/docs/drizzle-kit-migrate) åº”ç”¨ç”Ÿæˆçš„è¿ç§»ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ drizzle-orm çš„ `migrate()`ï¼Œ
ä½¿ç”¨å¤–éƒ¨è¿ç§»å·¥å…·ï¼Œå¦‚ [bytebase](https://www.bytebase.com/)ï¼Œæˆ–è€…ç›´æ¥åœ¨æ•°æ®åº“ä¸Šæ‰§è¡Œè¿ç§»ã€‚

`drizzle-kit generate` å‘½ä»¤è¦æ±‚æ‚¨æä¾› `dialect` å’Œ `schema` è·¯å¾„é€‰é¡¹ï¼Œ
æ‚¨å¯ä»¥é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ–é€šè¿‡ CLI é€‰é¡¹è®¾ç½®å®ƒä»¬ã€‚
<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½œä¸º CLI é€‰é¡¹"]}>
<Section>
```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
});
```
```shell
npx drizzle-kit generate
```
</Section>

```shell
npx drizzle-kit generate --dialect=postgresql --schema=./src/schema.ts
```
</CodeTabs>

### æ¨¡å¼æ–‡ä»¶è·¯å¾„
æ‚¨å¯ä»¥æœ‰ä¸€ä¸ªå•ç‹¬çš„ `schema.ts` æ–‡ä»¶ï¼Œæˆ–è€…åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰ä»»æ„æ•°é‡çš„æ¨¡å¼æ–‡ä»¶ã€‚
Drizzle Kit è¦æ±‚æ‚¨é€šè¿‡ `schema` é…ç½®é€‰é¡¹ä»¥ [glob](https://www.digitalocean.com/community/tools/glob?comments=true&glob=/**/*.js&matches=false&tests=//%20This%20will%20match%20as%20it%20ends%20with%20'.js'&tests=/hello/world.js&tests=//%20This%20won't%20match!&tests=/test/some/globs) æŒ‡å®šè·¯å¾„ã€‚

<SchemaFilePaths/>


### è‡ªå®šä¹‰è¿ç§»æ–‡ä»¶å
æ‚¨å¯ä»¥é€šè¿‡æä¾› `--name` CLI é€‰é¡¹è®¾ç½®è‡ªå®šä¹‰è¿ç§»æ–‡ä»¶åã€‚
```shell
npx drizzle-kit generate --name=init
```
```plaintext {4}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”‚ â”” ğŸ“‚ 20242409125510_init
 â”‚   â”œ ğŸ“œ snapshot.json
 â”‚   â”” ğŸ“œ migration.sql
 â”œ ğŸ“‚ src
 â”” â€¦
```

### é¡¹ç›®ä¸­çš„å¤šä¸ªé…ç½®æ–‡ä»¶
æ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™åœ¨æ‚¨æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µã€å¤šä¸ªæ•°æ®åº“æˆ–è€…åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸Šæœ‰ä¸åŒæ•°æ®åº“æ—¶éå¸¸æœ‰ç”¨ï¼š
<Npx>
  drizzle-kit generate --config=drizzle-dev.config.ts
  drizzle-kit generate --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### è‡ªå®šä¹‰è¿ç§»
æ‚¨å¯ä»¥ç”Ÿæˆç©ºçš„è¿ç§»æ–‡ä»¶ä»¥ç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰ SQL è¿ç§»
ç”¨äºå½“å‰ä¸è¢« Drizzle Kit æ”¯æŒçš„ DDL æ›´æ”¹æˆ–æ•°æ®å¡«å……ã€‚æœ‰å…³è‡ªå®šä¹‰è¿ç§»çš„æ‰©å±•æ–‡æ¡£ - [ç‚¹å‡»è¿™é‡Œ](/docs/kit-custom-migrations)

```shell
drizzle-kit generate --custom --name=seed-users
```
<Section>
```plaintext {5}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”‚ â”œ ğŸ“‚ 20242409125510_init
 â”‚ â”” ğŸ“‚ 20242409125510_seed-users
 â”œ ğŸ“‚ src
 â”” â€¦
```
```sql
-- ./drizzle/20242409125510_seed/migration.sql

INSERT INTO "users" ("name") VALUES('Dan');
INSERT INTO "users" ("name") VALUES('Andrew');
INSERT INTO "users" ("name") VALUES('Dandrew');
```
</Section>

### å¯ç”¨é…ç½®çš„æ‰©å±•åˆ—è¡¨
`drizzle-kit generate` æœ‰ä¸€ç³»åˆ—ä»…é™ cli çš„é€‰é¡¹ã€‚

<rem025/>

|               |                                                      |
| :--------     | :--------------------------------------------------- |
| `custom`      | ç”Ÿæˆè‡ªå®šä¹‰è¿ç§»çš„ç©º SQL æ–‡ä»¶                     |
| `name`        | ç”Ÿæˆè‡ªå®šä¹‰åç§°çš„è¿ç§»                             |

<rem025/>

<Npx>
drizzle-kit generate --name=init
drizzle-kit generate --name=seed_users --custom
</Npx>

<br/>
<hr/>
<br/>
æˆ‘ä»¬æ¨èé€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) æ–‡ä»¶æ¥é…ç½® `drizzle-kit`ï¼Œ
ä½†å¦‚æœæœ‰å¿…è¦ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ CLI æä¾›æ‰€æœ‰é…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨ CI/CD ç®¡é“ç­‰ä¸­ã€‚

|               |            |                                                                            |
| :------------ | :-------   | :----------------------------------------------------------------------    |
| `dialect`     | `required` | æ•°æ®åº“æ–¹è¨€ï¼Œå–å€¼ä¹‹ä¸€ <Dialects/>                                       |
| `schema`      | `required` | æŒ‡å‘ TypeScript æ¨¡å¼æ–‡ä»¶æˆ–åŒ…å«å¤šä¸ªæ¨¡å¼æ–‡ä»¶çš„æ–‡ä»¶å¤¹çš„è·¯å¾„             |
| `out`         |            | è¿ç§»è¾“å‡ºæ–‡ä»¶å¤¹ï¼Œé»˜è®¤ä¸º `./drizzle`                                       |
| `config`      |            | é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸º `drizzle.config.ts`                                  |
| `breakpoints` |            | SQL è¯­å¥æ–­ç‚¹ï¼Œé»˜è®¤å€¼ä¸º `true`                                            |


### æ‰©å±•ç¤ºä¾‹
å¦‚ä½•åˆ›å»ºä¸€ä¸ªåä¸º `0001_seed-users.sql` çš„è‡ªå®šä¹‰ PostgreSQL è¿ç§»æ–‡ä»¶çš„ç¤ºä¾‹ã€‚
Drizzle æ¨¡å¼ä½äº `./src/schema.ts`ï¼Œè¿ç§»æ–‡ä»¶å¤¹åä¸º `./migrations`ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ `./drizzle`ã€‚

æˆ‘ä»¬è¿˜å°†åœ¨ `configs` æ–‡ä»¶å¤¹ä¸­æ”¾ç½® drizzle é…ç½®æ–‡ä»¶ã€‚

è®©æˆ‘ä»¬åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

```plaintext {4}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ migrations
 â”œ ğŸ“‚ configs
 â”‚ â”” ğŸ“œ drizzle.config.ts
 â”œ ğŸ“‚ src
 â”” â€¦
```
```ts filename='drizzle.config.ts'
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  out: "./migrations",
});
```

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œï¼š
```shell
npx drizzle-kit generate --config=./configs/drizzle.config.ts --name=seed-users --custom
```
å®ƒå°†æˆåŠŸç”Ÿæˆï¼š
<Section>
```plaintext {6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ â€¦
 â”œ ğŸ“‚ migrations
 â”‚ â”œ ğŸ“‚ 20242409125510_init
 â”‚ â”” ğŸ“‚ 20242409125510_seed-users
 â”” â€¦
```
```sql
-- ./drizzle/20242409125510_seed-users/migration.sql

INSERT INTO "users" ("name") VALUES('Dan');
INSERT INTO "users" ("name") VALUES('Andrew');
INSERT INTO "users" ("name") VALUES('Dandrew');
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-migrate

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Npx from "@mdx/Npx.astro";

# `drizzle-kit migrate`
<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/get-started)
- Drizzle æ¨¡å¼åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
- `drizzle-kit generate` å‘½ä»¤ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/drizzle-kit-generate)
</Prerequisites>
<br/>


`drizzle-kit migrate` å…è®¸æ‚¨åº”ç”¨ç”± [`drizzle-kit generate`](/docs/drizzle-kit-generate) ç”Ÿæˆçš„ SQL è¿ç§»ã€‚
å®ƒè®¾è®¡ç”¨äºæ”¯æŒç®¡ç† Drizzle è¿ç§»çš„ [ä»£ç ä¼˜å…ˆï¼ˆé€‰é¡¹ 3ï¼‰](/docs/migrations) æ–¹æ³•ã€‚

<Callout collapsed="å®ƒæ˜¯å¦‚ä½•åœ¨åå°å·¥ä½œçš„ï¼Ÿ">
Drizzle Kit `migrate` å‘½ä»¤è§¦å‘ä¸€ç³»åˆ—äº‹ä»¶ï¼š
1. è¯»å–è¿ç§»æ–‡ä»¶å¤¹å¹¶è¯»å–æ‰€æœ‰ `.sql` è¿ç§»æ–‡ä»¶
2. è¿æ¥åˆ°æ•°æ®åº“å¹¶ä» drizzle è¿ç§»æ—¥å¿—è¡¨ä¸­è·å–æ¡ç›®
3. æ ¹æ®ä¹‹å‰åº”ç”¨çš„è¿ç§»å†³å®šè¦è¿è¡Œå“ªäº›æ–°è¿ç§»
4. è¿è¡Œ SQL è¿ç§»å¹¶å°†å·²åº”ç”¨çš„è¿ç§»è®°å½•åˆ° drizzle è¿ç§»è¡¨

<Section>
```plaintext
  â”œ ğŸ“‚ drizzle       
  â”‚ â”œ ğŸ“‚ 20242409125510_premium_mister_fear
  â”‚ â”” ğŸ“‚ 20242409135510_delicate_professor_xavie
  â”” â€¦
```
```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit migrate â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         
  â”” 1. è¯»å–è¿ç§».sql æ–‡ä»¶åœ¨è¿ç§»æ–‡ä»¶å¤¹ä¸­       â”‚                          â”‚
    2. ä»æ•°æ®åº“è·å–è¿ç§»å†å² -------------> â”‚                          â”‚
  â”Œ 3. é€‰æ‹©ä¹‹å‰æœªåº”ç”¨çš„è¿ç§» <-------------- â”‚         æ•°æ®åº“         â”‚
  â”” 4. å°†æ–°è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“ ---------------> â”‚                          â”‚
                                                            â”‚                          â”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[âœ“] å®Œæˆ!        
```
</Section>
</Callout>

`drizzle-kit migrate` å‘½ä»¤è¦æ±‚æ‚¨æŒ‡å®š `dialect` å’Œæ•°æ®åº“è¿æ¥å‡­æ®ï¼Œ
æ‚¨å¯ä»¥é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ– CLI é€‰é¡¹æä¾›è¿™äº›ä¿¡æ¯ã€‚

<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½œä¸º CLI é€‰é¡¹"]}>
<Section>
```ts {5,8}
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname"
  },
});
```
```shell
npx drizzle-kit migrate
```
</Section>
```shell
npx drizzle-kit migrate --dialect=postgresql --url=postgresql://user:password@host:port/dbname
```
</CodeTabs>

### æ•°æ®åº“ä¸­çš„å·²åº”ç”¨è¿ç§»æ—¥å¿—
åœ¨è¿è¡Œè¿ç§»åï¼ŒDrizzle Kit å°†åœ¨æ‚¨çš„æ•°æ®åº“ä¸­æŒä¹…åŒ–å…³äºæˆåŠŸåº”ç”¨è¿ç§»çš„è®°å½•ã€‚
å®ƒå°†æŠŠè¿™äº›è®°å½•å­˜å‚¨åœ¨åä¸º `__drizzle_migrations` çš„è¿ç§»æ—¥å¿—è¡¨ä¸­ã€‚

æ‚¨å¯ä»¥é€šè¿‡ drizzle é…ç½®æ–‡ä»¶è‡ªå®šä¹‰è¯¥è¡¨çš„ **è¡¨** å’Œ **æ¨¡å¼**ï¼ˆä»…ç”¨äº PostgreSQLï¼‰ï¼š
```ts filename="drizzle.config.ts" {8-9}
export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname"
  },
  migrations: {
    table: 'my-migrations-table', // é»˜è®¤æ˜¯ `__drizzle_migrations`
    schema: 'public', // ä»…åœ¨ PostgreSQL ä¸­ä½¿ç”¨ï¼Œé»˜è®¤æ˜¯ `drizzle`
  },
});
```

### ä¸€ä¸ªé¡¹ç›®ä¸­çš„å¤šä¸ªé…ç½®æ–‡ä»¶
æ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå½“æ‚¨æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µæˆ–åœ¨åŒä¸€é¡¹ç›®ä¸­æœ‰å¤šä¸ªæ•°æ®åº“æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼š
<Npx>
  drizzle-kit migrate --config=drizzle-dev.config.ts
  drizzle-kit migrate --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### æ‰©å±•ç¤ºä¾‹
è®©æˆ‘ä»¬ç”Ÿæˆ SQL è¿ç§»å¹¶ä½¿ç”¨ `drizzle-kit generate` å’Œ `drizzle-kit migrate` å‘½ä»¤å°†å…¶åº”ç”¨åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”‚ â”œ ğŸ“œ schema.ts
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”” â€¦
```
<CodeTabs items={["drizzle.config.ts", "src/schema.ts"]}>
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname"
  },
  migrations: {
    table: 'journal', 
    schema: 'drizzle', 
  },
});
```
```ts 
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
})
```
</CodeTabs>

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œ
```shell
npx drizzle-kit generate --name=init
```
å®ƒå°†ç”Ÿæˆ
<Section>
```plaintext {5}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ â€¦
 â”œ ğŸ“‚ migrations
 â”‚ â”œ ğŸ“‚ 20242409125510_init
 â”” â€¦
```
```sql
-- ./drizzle/0000_init.sql

CREATE TABLE "users"(
  id serial primary key,
  name text
)
```
</Section>

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œ
```shell
npx drizzle-kit migrate
```

æˆ‘ä»¬çš„ SQL è¿ç§»ç°åœ¨å·²æˆåŠŸåº”ç”¨åˆ°æ•°æ®åº“ âœ…


Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-pull

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Drivers from "@mdx/Drivers.mdx"
import Dialects from "@mdx/Dialects.mdx"
import Npm from "@mdx/Npm.astro"
import Npx from "@mdx/Npx.astro"

# `drizzle-kit pull`

<Prerequisites>
  - å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [é˜…è¯»è¿™é‡Œ](/docs/get-started)
  - Drizzle æ¨¡å¼åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/sql-schema-declaration) 
  - æ•°æ®åº“è¿æ¥åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/connect-overview) 
  - Drizzle è¿ç§»åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/migrations) 
  - Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) ä»¥åŠ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file) æ–‡æ¡£
</Prerequisites>

`drizzle-kit pull` å…è®¸ä½ ä»ç°æœ‰æ•°æ®åº“æ¨¡å¼ä¸­æå–ï¼ˆè‡ªçœï¼‰æ•°æ®ï¼Œç”Ÿæˆ `schema.ts` drizzle æ¨¡å¼æ–‡ä»¶ï¼Œ
å®ƒè®¾è®¡ç”¨äºæ”¯æŒ Drizzle è¿ç§»çš„ [æ•°æ®åº“ä¼˜å…ˆ](/docs/migrations) æ–¹æ³•ã€‚

<Callout collapsed="å®ƒèƒŒåæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ">
å½“ä½ è¿è¡Œ Drizzle Kit çš„ `pull` å‘½ä»¤æ—¶ï¼Œå®ƒä¼šï¼š
1. ä»ç°æœ‰æ•°æ®åº“ä¸­æå–æ•°æ®åº“æ¨¡å¼ï¼ˆDDLï¼‰
2. ç”Ÿæˆ `schema.ts` drizzle æ¨¡å¼æ–‡ä»¶å¹¶å°†å…¶ä¿å­˜åœ¨ `out` æ–‡ä»¶å¤¹ä¸­

<Section>
```
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
                                  â”‚                        â”‚ <---  CREATE TABLE "users" (
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                        â”‚        "id" SERIAL PRIMARY KEY,
â”‚ ~ drizzle-kit pull       â”‚      â”‚                        â”‚        "name" TEXT,
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚        DATABASE        â”‚        "email" TEXT UNIQUE
  â”‚                               â”‚                        â”‚       );
  â”” Pull æ•°æ®åº“æ¨¡å¼ --------> â”‚                        â”‚
  â”Œ ç”Ÿæˆ Drizzle æ‰€éœ€       <----- â”‚                        â”‚
  â”‚ æ¨¡å¼ TypeScript æ–‡ä»¶        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  v
```
```typescript
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(), 
};
```
</Section>
</Callout>

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ï¼Œé€‚åˆéœ€è¦åœ¨ TypeScript é¡¹ç›®ä¹‹å¤–ç®¡ç†æ•°æ®åº“æ¨¡å¼çš„æƒ…å†µï¼Œæˆ–è€…
æ‚¨æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªç”±å…¶ä»–äººç®¡ç†çš„æ•°æ®åº“ã€‚

<br/>
<hr/>
<br/>

`drizzle-kit pull` è¦æ±‚æ‚¨æŒ‡å®š `dialect` ä»¥åŠ
æ•°æ®åº“è¿æ¥ `url` æˆ– `user:password@host:port/db` å‚æ•°ï¼Œæ‚¨å¯ä»¥é€šè¿‡
[drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ–é€šè¿‡ CLI é€‰é¡¹æä¾›å®ƒä»¬ï¼š

<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½¿ç”¨ CLI é€‰é¡¹"]}>
<Section>
```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname",
  },
});
```
```shell
npx drizzle-kit pull
```
</Section>

```shell
npx drizzle-kit pull --dialect=postgresql --url=postgresql://user:password@host:port/dbname
```
</CodeTabs>

### åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶

æ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå½“æ‚¨æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µã€å¤šä¸ªæ•°æ®åº“æˆ–åŒä¸€é¡¹ç›®ä¸­çš„ä¸åŒæ•°æ®åº“æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼š

<Npx>
  drizzle-kit pull --config=drizzle-dev.config.ts
  drizzle-kit pull --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### æŒ‡å®šæ•°æ®åº“é©±åŠ¨
<Callout type="warning">
**Expo SQLite** å’Œ **OP SQLite** æ˜¯è®¾å¤‡å†…ï¼ˆæ¯ç”¨æˆ·ï¼‰æ•°æ®åº“ï¼Œæ— æ³•ä»ä¸­ `pull` æ•°æ®åº“æ¨¡å¼ã€‚<br/>
å¯¹äºåµŒå…¥å¼æ•°æ®åº“ï¼ŒDrizzle æä¾› **åµŒå…¥å¼è¿ç§»** - è¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [å¼€å§‹ä½¿ç”¨](/docs/get-started/expo-new) æŒ‡å—ã€‚
</Callout>
Drizzle Kit ä¸è‡ªå¸¦é¢„æ‰“åŒ…çš„æ•°æ®åº“é©±åŠ¨ï¼Œ
å®ƒä¼šæ ¹æ®å½“å‰é¡¹ç›®ä¸­çš„ `dialect` è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„æ•°æ®åº“é©±åŠ¨ - [æŸ¥çœ‹è®¨è®º](https://github.com/drizzle-team/drizzle-orm/discussions/2203)ã€‚

å¤§å¤šæ•°ç›¸åŒæ–¹è¨€çš„é©±åŠ¨å…±äº«ç›¸åŒçš„è¿æ¥å‚æ•°é›†ï¼Œ
å¯¹äºåƒ `aws-data-api`ã€`pglight` å’Œ `d1-http` è¿™æ ·çš„ä¾‹å¤–æƒ…å†µ - æ‚¨éœ€è¦æ˜ç¡®æŒ‡å®š `driver` å‚æ•°ã€‚

<CodeTabs items={["AWS Data API", "PGLite", "Cloudflare D1 HTTP"]}>
```ts {6}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  driver: "aws-data-api",
  dbCredentials: {
    database: "database",
    resourceArn: "resourceArn",
    secretArn: "secretArn",
  },
};
```
```ts {6}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  driver: "pglite",
  dbCredentials: {
    // å†…å­˜ä¸­
    url: ":memory:"
    
    // æˆ–æ•°æ®åº“æ–‡ä»¶å¤¹
    url: "./database/"
  },
};
```
```ts {6}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "sqlite",
  driver: "d1-http",
  dbCredentials: {
    accountId: "accountId",
    databaseId: "databaseId",
    token: "token",
  },
};
```
</CodeTabs>

### Initial pull

<Callout type='error'>
è¯¥åŠŸèƒ½ä»…åœ¨ `1.0.0-beta.2` åŠæ›´é«˜ç‰ˆæœ¬å¯ç”¨ã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

æ‚¨å¯ä»¥ä½¿ç”¨ `--init` æ ‡å¿—å°†æ‹‰å–çš„æ¨¡å¼æ ‡è®°ä¸ºæ•°æ®åº“ä¸­çš„å·²åº”ç”¨è¿ç§»ï¼Œ
è¿™æ ·æ‰€æœ‰åç»­è¿ç§»éƒ½ä¼šåŸºäºè¯¥åˆå§‹è¿ç§»è¿›è¡Œå·®å¼‚åŒ–ã€‚

```shell
npx drizzle-kit push --init
```

### åŒ…å«è¡¨ã€æ¨¡å¼å’Œæ‰©å±•
`drizzle-kit push` é»˜è®¤ä¼šç®¡ç† `public` æ¨¡å¼ä¸­çš„æ‰€æœ‰è¡¨ã€‚
æ‚¨å¯ä»¥é€šè¿‡ `tablesFilters`ã€`schemaFilter` å’Œ `extensionFilters` é€‰é¡¹é…ç½®è¡¨ã€æ¨¡å¼å’Œæ‰©å±•çš„åˆ—è¡¨ã€‚

|                     |                                                                                               |
| :------------------ | :-------------------------------------------------------------------------------------------- |
| `tablesFilter`      | åŸºäº `glob` çš„è¡¨åè¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ `["users", "user_info"]` æˆ– `"user*"`ã€‚é»˜è®¤ä¸º `"*"` |
| `schemaFilter`      | åŸºäº `glob` çš„æ¨¡å¼åè¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ `["public", "drizzle"]` æˆ– `"drizzle*"`ã€‚é»˜è®¤ä¸º `"*"` |
| `extensionsFilters` | å·²å®‰è£…çš„æ•°æ®åº“æ‰©å±•åˆ—è¡¨ï¼Œä¾‹å¦‚ `["postgis"]`ã€‚é»˜è®¤ä¸º `[]`                    |
<br/>

è®©æˆ‘ä»¬é…ç½® drizzle-kit åªæ“ä½œ **public** æ¨¡å¼ä¸­çš„ **æ‰€æœ‰è¡¨**ï¼Œ
å¹¶å‘ŠçŸ¥ drizzle-kit å·²å®‰è£…äº† **postgis** æ‰©å±•ï¼Œ
ä»¥ä½¿å…¶å¯ä»¥å¿½ç•¥åœ¨å…¬å…±æ¨¡å¼ä¸­åˆ›å»ºè‡ªå·±çš„è¡¨ã€‚

<Section>
```ts filename="drizzle.config.ts" {9-11}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname",
  },
  extensionsFilters: ["postgis"],
  schemaFilter: ["public"],
  tablesFilter: ["*"],
});
```
```shell
npx drizzle-kit push
```
</Section>

### æ‰©å±•çš„é…ç½®åˆ—è¡¨
æˆ‘ä»¬å»ºè®®é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) æ–‡ä»¶æ¥é…ç½® `drizzle-kit`ï¼Œ 
ä¸è¿‡å¦‚æœå¿…è¦çš„è¯ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ CLI æä¾›æ‰€æœ‰é…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨ CI/CD ç®¡é“ä¸­ç­‰ã€‚

|                     |            |                                                                           |
| :------------------ | :--------- | :------------------------------------------------------------------------ |
| `dialect`           | `å¿…éœ€`     | æ•°æ®åº“æ–¹è¨€, é€‰é¡¹ä¹‹ä¸€ <Dialects/>                                      |
| `driver`            |            | é©±åŠ¨ç¨‹åºä¾‹å¤– <Drivers/>                                             |
| `out`               |            | è¿ç§»è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„ï¼Œé»˜è®¤æ˜¯ `./drizzle`                     |
| `url`               |            | æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²                                                |
| `user`              |            | æ•°æ®åº“ç”¨æˆ·                                                             |
| `password`          |            | æ•°æ®åº“å¯†ç                                                          |
| `host`              |            | ä¸»æœº                                                                      |
| `port`              |            | ç«¯å£                                                                      |
| `database`          |            | æ•°æ®åº“åç§°                                                             |
| `config`            |            | é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤æ˜¯ `drizzle.config.ts`                          |
| `introspect-casing` |            | åˆ—ã€è¡¨ç­‰ä¸­ JS é”®åˆ›å»ºçš„ç­–ç•¥ï¼Œ`preserve` `camel` |
| `tablesFilter`      |            | è¡¨åè¿‡æ»¤å™¨                                                         |
| `schemaFilter`      |            | æ¨¡å¼åè¿‡æ»¤å™¨ã€‚é»˜è®¤ä¸º `["public"]`                                 |
| `extensionsFilters` |            | æ•°æ®åº“æ‰©å±•çš„å†…éƒ¨æ•°æ®åº“è¿‡æ»¤å™¨                             |

<Npx>
drizzle-kit pull --dialect=postgresql --url=postgresql://user:password@host:port/dbname
drizzle-kit pull --dialect=postgresql --driver=pglite url=database/
drizzle-kit pull --dialect=postgresql --tablesFilter='user*' --extensionsFilters=postgis url=postgresql://user:password@host:port/dbname
</Npx>

![](@/assets/gifs/introspect_mysql.gif)


Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-push

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Npx from "@mdx/Npx.astro";
import SchemaFilePaths from "@mdx/SchemaFilePaths.mdx";
import Drivers from "@mdx/Drivers.mdx"
import Dialects from "@mdx/Dialects.mdx"
import DriversExamples from "@mdx/DriversExamples.mdx"

# `drizzle-kit push`

<Prerequisites>
  - ä» Drizzle å’Œ `drizzle-kit` å¼€å§‹ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/get-started)
  - Drizzle æ¨¡å¼åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/sql-schema-declaration) 
  - æ•°æ®åº“è¿æ¥åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/connect-overview) 
  - Drizzle è¿ç§»åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/migrations) 
  - Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file) æ–‡æ¡£
</Prerequisites>


`drizzle-kit push` å…è®¸ä½ ç›´æ¥å°†ä½ çš„æ¨¡å¼åŠåç»­çš„æ¨¡å¼å˜åŒ–æ¨é€åˆ°æ•°æ®åº“ï¼Œ
åŒæ—¶çœç•¥ SQL æ–‡ä»¶çš„ç”Ÿæˆï¼Œ
æ—¨åœ¨è¦†ç›– Drizzle è¿ç§»çš„ [ä»£ç ä¼˜å…ˆ](/docs/migrations) æ–¹æ³•ã€‚

<Callout collapsed="å®ƒæ˜¯å¦‚ä½•åœ¨å†…éƒ¨å·¥ä½œçš„ï¼Ÿ">
å½“ä½ è¿è¡Œ Drizzle Kit çš„ `push` å‘½ä»¤æ—¶ï¼Œå®ƒä¼šï¼š
1. è¯»å–ä½ çš„ Drizzle æ¨¡å¼æ–‡ä»¶å¹¶ç»„æˆä¸€ä¸ª JSON å¿«ç…§
2. æ‹‰å–ï¼ˆå†…çœï¼‰æ•°æ®åº“æ¨¡å¼ 
3. æ ¹æ®è¿™ä¸¤è€…ä¹‹é—´çš„å·®å¼‚ç”Ÿæˆ SQL è¿ç§»
4. å°† SQL è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“

<Section>
```typescript filename="src/schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
};
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ ~ drizzle-kit push  â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”” Pull current datatabase schema ---------> â”‚                          â”‚
                                              â”‚                          â”‚
  â”Œ Generate alternations based on diff <---- â”‚         DATABASE         â”‚
  â”‚                                           â”‚                          â”‚
  â”” Apply migrations to the database -------> â”‚                          â”‚
                                       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   create table users(id serial primary key, name text);
```
</Section>
</Callout>

è¿™æ˜¯å¿«é€ŸåŸå‹è®¾è®¡çš„æœ€ä½³æ–¹æ³•ï¼Œ
æˆ‘ä»¬å·²ç»çœ‹åˆ°æ•°åä¸ªå›¢é˜Ÿå’Œç‹¬ç«‹å¼€å‘è€…æˆåŠŸåœ°å°†å…¶ä½œä¸ºä»–ä»¬ç”Ÿäº§åº”ç”¨ä¸­çš„ä¸»è¦è¿ç§»æµç¨‹ã€‚
å®ƒä¸è“ç»¿éƒ¨ç½²ç­–ç•¥å’Œæ— æœåŠ¡å™¨æ•°æ®åº“å¦‚
[Planetscale](https://planetscale.com)ã€[Neon](https://neon.tech)ã€[Turso](https://turso.tech/drizzle) ç­‰éå¸¸å¥‘åˆã€‚

<br/>
<hr/>
<br/>


`drizzle-kit push` éœ€è¦ä½ æŒ‡å®š `dialect`ã€æ¨¡å¼æ–‡ä»¶çš„è·¯å¾„ï¼Œ
å¹¶æä¾›æ•°æ®åº“è¿æ¥çš„ `url` æˆ– `user:password@host:port/db` å‚æ•°ï¼Œ
ä½ å¯ä»¥é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ– CLI é€‰é¡¹æä¾›å®ƒä»¬ï¼š

<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½¿ç”¨ CLI é€‰é¡¹"]}>
<Section>
```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname",
  },
});
```
```shell
npx drizzle-kit push
```
</Section>

```shell
npx drizzle-kit push --dialect=postgresql --schema=./src/schema.ts --url=postgresql://user:password@host:port/dbname
```

</CodeTabs>

### æ¨¡å¼æ–‡ä»¶è·¯å¾„

ä½ å¯ä»¥æœ‰ä¸€ä¸ªå•ç‹¬çš„ `schema.ts` æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦åœ¨é¡¹ç›®ä¸­åˆ†æ•£å¤šä¸ªæ¨¡å¼æ–‡ä»¶ã€‚
Drizzle Kit è¦æ±‚ä½ é€šè¿‡ `schema` é…ç½®é€‰é¡¹ä½œä¸º [glob](https://www.digitalocean.com/community/tools/glob?comments=true&glob=/**/*.js&matches=false&tests=//%20This%20will%20match%20as%20it%20ends%20with%20'.js'&tests=/hello/world.js&tests=//%20This%20won't%20match!&tests=/test/some/globs) æŒ‡å®šå®ƒä»¬çš„è·¯å¾„ã€‚

<SchemaFilePaths />

### é¡¹ç›®ä¸­å¤šä¸ªé…ç½®æ–‡ä»¶

ä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå½“ä½ æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µã€å¤šä¸ªæ•°æ®åº“æˆ–åŒä¸€é¡¹ç›®ä¸­çš„ä¸åŒæ•°æ®åº“æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼š

<Npx>
  drizzle-kit push --config=drizzle-dev.config.ts
  drizzle-kit push --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### æŒ‡å®šæ•°æ®åº“é©±åŠ¨
<Callout type="warning">
**Expo SQLite** å’Œ **OP SQLite** æ˜¯è®¾å¤‡ä¸Šçš„ï¼ˆæ¯ç”¨æˆ·ï¼‰æ•°æ®åº“ï¼Œæ— æ³•åœ¨å…¶ä¸­ `push` è¿ç§»ã€‚<br/>
å¯¹äºåµŒå…¥å¼æ•°æ®åº“ï¼ŒDrizzle æä¾›äº† **åµŒå…¥å¼è¿ç§»** - æŸ¥çœ‹æˆ‘ä»¬çš„ [å¿«é€Ÿå¼€å§‹](/docs/get-started/expo-new) æŒ‡å—ã€‚
</Callout>
Drizzle Kit ä¸åŒ…å«é¢„æ‰“åŒ…çš„æ•°æ®åº“é©±åŠ¨ï¼Œ
å®ƒå°†æ ¹æ®å½“å‰é¡¹ç›®çš„ `dialect` è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„æ•°æ®åº“é©±åŠ¨ - [æŸ¥çœ‹è®¨è®º](https://github.com/drizzle-team/drizzle-orm/discussions/2203)ã€‚

å¤§å¤šæ•°åŒä¸€æ–¹è¨€çš„é©±åŠ¨ç¨‹åºå…±äº«ç›¸åŒçš„è¿æ¥å‚æ•°ï¼Œ
è‡³äºåƒ `aws-data-api`ã€`pglight` å’Œ `d1-http` çš„ä¾‹å¤–æƒ…å†µï¼Œä½ å°†éœ€è¦æ˜¾å¼æŒ‡å®š `driver` å‚æ•°ã€‚

<DriversExamples/>

### åŒ…æ‹¬è¡¨ã€æ¨¡å¼å’Œæ‰©å±•
`drizzle-kit push` é»˜è®¤ç®¡ç† `public` æ¨¡å¼ä¸­çš„æ‰€æœ‰è¡¨ã€‚
ä½ å¯ä»¥é€šè¿‡ `tablesFilters`ã€`schemaFilter` å’Œ `extensionFilters` é€‰é¡¹é…ç½®è¡¨ã€æ¨¡å¼å’Œæ‰©å±•çš„åˆ—è¡¨ã€‚

|                     |                                                                                               |
| :------------------ | :-------------------------------------------------------------------------------------------- |
| `tablesFilter`      | åŸºäº `glob` çš„è¡¨åè¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ `["users", "user_info"]` æˆ– `"user*" `ã€‚é»˜è®¤æ˜¯ `"*"` |
| `schemaFilter`      | æ¨¡å¼åè¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ `["public", "drizzle"]`ã€‚é»˜è®¤æ˜¯ `["public"]`                    |
| `extensionsFilters` | å·²å®‰è£…æ•°æ®åº“æ‰©å±•çš„åˆ—è¡¨ï¼Œä¾‹å¦‚ `["postgis"]`ã€‚é»˜è®¤æ˜¯ `[]`                    |
<br/>

è®©æˆ‘ä»¬é…ç½® drizzle-kit åªæ“ä½œ **public** æ¨¡å¼ä¸­çš„ **æ‰€æœ‰è¡¨**ï¼Œ
å¹¶è®© drizzle-kit çŸ¥é“æœ‰ä¸€ä¸ªå®‰è£…çš„ **postgis** æ‰©å±•ï¼Œ
å®ƒä¼šåœ¨ public æ¨¡å¼ä¸­åˆ›å»ºè‡ªå·±çš„è¡¨ï¼Œå› æ­¤ drizzle å¯ä»¥å¿½ç•¥å®ƒä»¬ã€‚

<Section>
```ts filename="drizzle.config.ts" {9-11}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname",
  },
  extensionsFilters: ["postgis"],
  schemaFilter: ["public"],
  tablesFilter: ["*"],
});
```
```shell
npx drizzle-kit push
```
</Section>

### æ‰©å±•çš„é…ç½®é€‰é¡¹åˆ—è¡¨

`drizzle-kit push` æœ‰ä¸€äº›ä»…é™äº CLI çš„é€‰é¡¹

<rem025/>

|           |                                                          |
| :-------- | :---------------------------------------------------     |
| `verbose` | æ‰§è¡Œå‰æ‰“å°æ‰€æœ‰ SQL è¯­å¥                                   |
| `strict`  | æ‰§è¡Œ SQL è¯­å¥å‰å§‹ç»ˆè¦æ±‚ç¡®è®¤                             |
| `force`   | è‡ªåŠ¨æ¥å—æ‰€æœ‰æ•°æ®ä¸¢å¤±çš„è¯­å¥                               |
<br/>
<Npx>
drizzle-kit push --strict --verbose --force
</Npx>

<br/>
<hr/>
<br/>
æˆ‘ä»¬æ¨èé€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) æ–‡ä»¶é…ç½® `drizzle-kit`ï¼Œ
ä½†å¦‚æœæœ‰å¿…è¦ï¼Œä½ å¯ä»¥é€šè¿‡ CLI æä¾›æ‰€æœ‰é…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨ CI/CD ç®¡é“ä¸­ç­‰ã€‚

|                     |            |                                                                           |
| :------------------ | :--------- | :------------------------------------------------------------------------ |
| `dialect`           | `required` | æ•°æ®åº“æ–¹è¨€ï¼Œå¿…é¡»æ˜¯ <Dialects/>                                      |
| `schema`            | `required` | æŒ‡å‘ TypeScript æ¨¡å¼æ–‡ä»¶æˆ–åŒ…å«å¤šä¸ªæ¨¡å¼æ–‡ä»¶çš„æ–‡ä»¶å¤¹çš„è·¯å¾„ |
| `driver`            |            | é©±åŠ¨ç¨‹åºä¾‹å¤– <Drivers/>                                             |
| `tablesFilter`      |            | è¡¨åè¿‡æ»¤å™¨                                                         |
| `schemaFilter`      |            | æ¨¡å¼åç§°è¿‡æ»¤å™¨ã€‚é»˜è®¤ï¼š`["public"]`                                 |
| `extensionsFilters` |            | æ•°æ®åº“æ‰©å±•å†…éƒ¨æ•°æ®åº“è¿‡æ»¤å™¨                             |
| `url`               |            | æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²                                                |
| `user`              |            | æ•°æ®åº“ç”¨æˆ·                                                             |
| `password`          |            | æ•°æ®åº“å¯†ç                                                          |
| `host`              |            | ä¸»æœº                                                                      |
| `port`              |            | ç«¯å£                                                                      |
| `database`          |            | æ•°æ®åº“åç§°                                                             |
| `config`            |            | é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤=`drizzle.config.ts`                             |

<Npx>
drizzle-kit push dialect=postgresql schema=src/schema.ts url=postgresql://user:password@host:port/dbname
drizzle-kit push dialect=postgresql schema=src/schema.ts driver=pglite url=database/
drizzle-kit push dialect=postgresql schema=src/schema.ts --tablesFilter='user*' --extensionsFilters=postgis url=postgresql://user:password@host:port/dbname
</Npx>


### æ‰©å±•ç¤ºä¾‹
è®©æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å£°æ˜ drizzle æ¨¡å¼å¹¶é€šè¿‡ `drizzle-kit push` å‘½ä»¤å°†å…¶æ¨é€åˆ°æ•°æ®åº“

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚ â”œ ğŸ“œ schema.ts
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”” â€¦
```
<CodeTabs items={["drizzle.config.ts", "src/schema.ts"]}>
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname"
  },
});
```
```ts 
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
})
```
</CodeTabs>

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œ
```shell
npx drizzle-kit push
```

å®ƒå°†ä»æ•°æ®åº“ä¸­æ‹‰å–ç°æœ‰ï¼ˆç©ºï¼‰æ¨¡å¼ï¼Œç”Ÿæˆ SQL è¿ç§»å¹¶åœ¨åå°åº”ç”¨å®ƒ
```sql
CREATE TABLE "users"(
  id serial primary key,
  name text
)
```

å®Œæˆ âœ…


Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-studio

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";


# `drizzle-kit studio`
<Prerequisites>
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
- Drizzle Studioï¼Œæˆ‘ä»¬çš„æ•°æ®åº“æµè§ˆå™¨ - [é˜…è¯»è¿™é‡Œ](/drizzle-studio/overview)
</Prerequisites>

`drizzle-kit studio` å‘½ä»¤å¯åŠ¨ä¸€ä¸ªç”¨äº [Drizzle Studio](/drizzle-studio/overview) çš„æœåŠ¡å™¨ï¼Œæ‰˜ç®¡åœ¨ [local.drizzle.studio](https://local.drizzle.studio)ã€‚ 
å®ƒè¦æ±‚æ‚¨é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æŒ‡å®šæ•°æ®åº“è¿æ¥å‡­æ®ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨ `127.0.0.1:4983` å¯åŠ¨ Drizzle Studio æœåŠ¡å™¨ã€‚
<Section>
```ts {6}
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  dbCredentials: {
    url: "postgresql://user:password@host:port/dbname"
  },
});
```
```shell
npx drizzle-kit migrate
```
</Section>

### é…ç½® `host` å’Œ `port`
é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrizzle Studio æœåŠ¡å™¨åœ¨ `127.0.0.1:4983` å¯åŠ¨ï¼Œ 
æ‚¨å¯ä»¥é€šè¿‡ CLI é€‰é¡¹é…ç½® `host` å’Œ `port`ã€‚

<Npx>
drizzle-kit studio --port=3000
drizzle-kit studio --host=0.0.0.0
drizzle-kit studio --host=0.0.0.0 --port=3000
</Npx>


### æ—¥å¿—è®°å½•
æ‚¨å¯ä»¥é€šè¿‡æä¾› `verbose` æ ‡å¿—æ¥å¯ç”¨æ¯ä¸ª SQL è¯­å¥çš„æ—¥å¿—è®°å½•ã€‚

<Npx>
drizzle-kit studio --verbose
</Npx>

### Safari å’Œ Brave æ”¯æŒ
Safari å’Œ Brave é»˜è®¤é˜»æ­¢å¯¹ localhost çš„è®¿é—®ã€‚ 
æ‚¨éœ€è¦å®‰è£… [mkcert](https://github.com/FiloSottile/mkcert) å¹¶ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼š

1. æŒ‰ç…§ mkcert [å®‰è£…æ­¥éª¤](https://github.com/FiloSottile/mkcert#installation) æ“ä½œ
2. è¿è¡Œ `mkcert -install`
3. é‡å¯æ‚¨çš„ `drizzle-kit studio`

### å¯åµŒå…¥çš„ Drizzle Studio ç‰ˆæœ¬
è™½ç„¶æœ¬åœ°å¼€å‘çš„ Drizzle Studio æ‰˜ç®¡ç‰ˆæœ¬æ˜¯å…è´¹ä½¿ç”¨çš„ï¼Œå¹¶æ—¨åœ¨ä¸°å¯Œ Drizzle ç”Ÿæ€ç³»ç»Ÿï¼Œ 
æˆ‘ä»¬ä¹Ÿæä¾› B2B çš„å¯åµŒå…¥ç‰ˆ Drizzle Studio ä¾›ä¼ä¸šä½¿ç”¨ã€‚

**Drizzle Studio ç»„ä»¶** - æ˜¯ä¸€ä¸ªé¢„æ‰“åŒ…çš„æ¡†æ¶æ— å…³çš„ Drizzle Studio ç½‘é¡µç»„ä»¶ï¼Œ 
æ‚¨å¯ä»¥å°†å…¶åµŒå…¥åˆ°æ‚¨çš„ UI ä¸­ï¼Œå¦‚ `React` `Vue` `Svelte` `VanillaJS` ç­‰ç­‰ã€‚

è¿™æ˜¯ä¸€ä¸ªæå…·åŠ›é‡çš„ UI å…ƒç´ ï¼Œå¯ä»¥æå‡æ‚¨çš„äº§å“ 
å¦‚æœæ‚¨æä¾›çš„æ˜¯æ•°æ®åº“ä½œä¸º SaaS æˆ–åŸºäº SQL çš„æ•°æ®ä¸­å¿ƒ SaaS è§£å†³æ–¹æ¡ˆï¼Œ 
æˆ–è€…ç”¨äºç§æœ‰çš„éå®¢æˆ·å¯è§çš„å†…éƒ¨ä½¿ç”¨ã€‚

ä½¿ç”¨ Drizzle Studio çš„æ•°æ®åº“å¹³å°ï¼š
- [Turso](https://turso.tech/)ï¼Œè‡ª 2023 å¹´ 10 æœˆä»¥æ¥æˆ‘ä»¬çš„ç¬¬ä¸€ä½å®¢æˆ·ï¼
- [Neon](https://neon.tech/)ï¼Œ[å‘å¸ƒå¸–å­](https://neon.tech/docs/changelog/2024-05-24)
- [Hydra](https://www.hydra.so/)

ä½¿ç”¨ Drizzle Studio çš„æ•°æ®ä¸­å¿ƒå¹³å°ï¼š
- [Nuxt Hub](https://hub.nuxt.com/)ï¼ŒSÃ©bastien Chopin çš„ [å‘å¸ƒå¸–å­](https://x.com/Atinux/status/1768663789832929520)
- [Deco.cx](https://deco.cx/)

æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ](https://www.npmjs.com/package/@drizzle-team/studio) é˜…è¯»è¯¦ç»†æ¦‚è¿°ï¼Œ 
å¦‚æœæ‚¨æ„Ÿå…´è¶£ - å¯ä»¥é€šè¿‡ [Twitter](https://x.com/drizzleorm) çš„ç§ä¿¡ä¸æˆ‘ä»¬è”ç³»ï¼Œæˆ–åœ¨ [Discord #drizzle-studio](https://driz.link/discord) é¢‘é“ä¸­ä¸æˆ‘ä»¬äº¤æµã€‚

### Drizzle Studio Chrome æ‰©å±•
Drizzle Studio [Chrome æ‰©å±•](https://chromewebstore.google.com/detail/drizzle-studio/mjkojjodijpaneehkgmeckeljgkimnmd) 
è®©æ‚¨å¯ä»¥ç›´æ¥åœ¨å…¶ä¾›åº”å•†ç®¡ç†é¢æ¿ä¸­æµè§ˆæ‚¨çš„ [PlanetScale](https://planetscale.com)ã€ 
[Cloudflare](https://developers.cloudflare.com/d1/) å’Œ [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres) 
æ— æœåŠ¡å™¨æ•°æ®åº“ï¼

### é™åˆ¶
æˆ‘ä»¬çš„æ‰˜ç®¡ç‰ˆæœ¬ Drizzle Studio æ—¨åœ¨ç”¨äºæœ¬åœ°å¼€å‘ï¼Œä¸é€‚ç”¨äºè¿œç¨‹ï¼ˆVPS ç­‰ï¼‰ã€‚

å¦‚æœæ‚¨å¸Œæœ›å°† Drizzle Studio éƒ¨ç½²åˆ° VPS - æˆ‘ä»¬æœ‰ä¸€ä¸ª Drizzle Studio Gateway çš„ alpha ç‰ˆæœ¬ï¼Œ 
æ¬¢è¿é€šè¿‡ [Twitter](https://x.com/drizzleorm) çš„ç§ä¿¡ä¸æˆ‘ä»¬è”ç³»ï¼Œæˆ–åœ¨ [Discord #drizzle-studio](https://driz.link/discord) é¢‘é“ä¸­ä¸æˆ‘ä»¬è¯¢é—®ã€‚

### å®ƒæ˜¯å¼€æºçš„å—ï¼Ÿ
ä¸æ˜¯ã€‚Drizzle ORM å’Œ Drizzle Kit å®Œå…¨å¼€æºï¼Œè€Œ Studio ä¸æ˜¯ã€‚

Drizzle Studio ç”¨äºæœ¬åœ°å¼€å‘æ°¸ä¹…å…è´¹ï¼Œä»¥ä¸°å¯Œ Drizzle ç”Ÿæ€ç³»ç»Ÿï¼Œå¼€æºä¸€ä¸ªå°†æ‰“ç ´æˆ‘ä»¬æä¾› B2B æœåŠ¡å’Œç›ˆåˆ©çš„èƒ½åŠ›ï¼Œä¸å¹¸çš„æ˜¯ã€‚

Source: https://drizzle.zhcndoc.com/docs/drizzle-kit-up

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Npx from "@mdx/Npx.astro";

# `drizzle-kit up`

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [é˜…è¯»è¿™é‡Œ](/docs/get-started)
- Drizzle æ¨¡å¼åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
- `drizzle-kit generate` å‘½ä»¤ - [é˜…è¯»è¿™é‡Œ](/docs/drizzle-kit-generate)
</Prerequisites>

`drizzle-kit up` å‘½ä»¤å…è®¸æ‚¨å°† drizzle æ¨¡å¼å¿«ç…§å‡çº§åˆ°æ–°ç‰ˆæœ¬ã€‚
æ¯å½“æˆ‘ä»¬å¼•å…¥å¯¹æ¨¡å¼çš„ json å¿«ç…§çš„ç ´åæ€§æ›´æ”¹å¹¶å‡çº§å†…éƒ¨ç‰ˆæœ¬æ—¶ï¼Œéƒ½ä¼šè¦æ±‚ä½¿ç”¨æ­¤å‘½ä»¤ã€‚

<br/>
<hr/>
<br/>

`drizzle-kit up` å‘½ä»¤è¦æ±‚æ‚¨æŒ‡å®š `dialect` å’Œæ•°æ®åº“è¿æ¥å‡­æ®ï¼Œ
æ‚¨å¯ä»¥é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ–é€šè¿‡ CLI é€‰é¡¹æä¾›å®ƒä»¬ã€‚

<CodeTabs items={["ä½¿ç”¨é…ç½®æ–‡ä»¶", "ä½œä¸º CLI é€‰é¡¹"]}>
<Section>
```ts {5,8}
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
});
```
```shell
npx drizzle-kit up
```
</Section>
```shell
npx drizzle-kit up --dialect=postgresql
```
</CodeTabs>

### ä¸€ä¸ªé¡¹ç›®ä¸­çš„å¤šä¸ªé…ç½®æ–‡ä»¶
æ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‹¥æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™åœ¨æ‚¨æœ‰å¤šä¸ªæ•°æ®åº“ç¯å¢ƒæˆ–åœ¨åŒä¸€é¡¹ç›®ä¸­ä½¿ç”¨å¤šä¸ªæ•°æ®åº“æ—¶éå¸¸æœ‰ç”¨ï¼š
<Npx>
  drizzle-kit migrate --config=drizzle-dev.config.ts
  drizzle-kit migrate --config=drizzle-prod.config.ts
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

### æ‰©å±•çš„é…ç½®é€‰é¡¹åˆ—è¡¨
æˆ‘ä»¬æ¨èé€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) æ–‡ä»¶é…ç½® `drizzle-kit`ï¼Œ
ä½†æ˜¯å¦‚æœéœ€è¦ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ CLI æä¾›æ‰€æœ‰é…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚åœ¨ CI/CD æµæ°´çº¿ä¸­ç­‰ã€‚
<rem025/>
|           |            |                                                                         |
| :-------- | :--------- | :---------------------------------------------------------------------- |
| `dialect` | `å¿…éœ€`    | æ‚¨æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“æ–¹è¨€ã€‚å¯ä»¥æ˜¯ `postgresql`, `mysql` æˆ– `sqlite`      |
| `out`     |            | è¿ç§»æ–‡ä»¶å¤¹ï¼Œé»˜è®¤=`./drizzle`                                          |
| `config`  |            | é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤=`drizzle.config.ts`                               |
<br/>
<Npx>
drizzle-kit up --dialect=postgresql
drizzle-kit up --dialect=postgresql --out=./migrations-folder
</Npx>

![](@/assets/gifs/up_mysql.gif)



Source: https://drizzle.zhcndoc.com/docs/dynamic-query-building

import Callout from '@mdx/Callout.astro';

# åŠ¨æ€æŸ¥è¯¢æ„å»º

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrizzle ä¸­çš„æ‰€æœ‰æŸ¥è¯¢æ„å»ºå™¨å°½é‡éµå¾ª SQLï¼Œå› æ­¤å¤§å¤šæ•°æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚
ä¾‹å¦‚ï¼Œåœ¨ `SELECT` è¯­å¥ä¸­ï¼Œå¯èƒ½åªæœ‰ä¸€ä¸ª `WHERE` å­å¥ï¼Œå› æ­¤ä½ åªèƒ½è°ƒç”¨ä¸€æ¬¡ `.where()`ï¼š

```ts
const query = db
	.select()
	.from(users)
	.where(eq(users.id, 1))
	.where(eq(users.name, 'John')); // âŒ ç±»å‹é”™è¯¯ - where() åªèƒ½è°ƒç”¨ä¸€æ¬¡
```

åœ¨ä»¥å‰çš„ ORM ç‰ˆæœ¬ä¸­ï¼Œç”±äºæ²¡æœ‰å®ç°è¿™äº›é™åˆ¶ï¼Œç‰¹åˆ«æ˜¯è¿™ä¸ªä¾‹å­å¯¹è®¸å¤šç”¨æˆ·æ¥è¯´æ˜¯ä¸ªå›°æƒ‘ï¼Œå› ä¸ºä»–ä»¬æœŸæœ›æŸ¥è¯¢æ„å»ºå™¨èƒ½å¤Ÿâ€œåˆå¹¶â€å¤šä¸ª `.where()` è°ƒç”¨æˆä¸ºä¸€ä¸ªæ¡ä»¶ã€‚

è¿™ç§è¡Œä¸ºå¯¹äºä¼ ç»ŸæŸ¥è¯¢æ„å»ºå¾ˆæœ‰ç”¨ï¼Œå³åœ¨ä¸€æ¬¡æ€§åˆ›å»ºæ•´ä¸ªæŸ¥è¯¢æ—¶ã€‚
ç„¶è€Œï¼Œå½“ä½ æƒ³åŠ¨æ€æ„å»ºæŸ¥è¯¢æ—¶ï¼Œæ¯”å¦‚æ‹¥æœ‰ä¸€ä¸ªæ¥æ”¶æŸ¥è¯¢æ„å»ºå™¨å¹¶è¿›è¡Œå¢å¼ºçš„å…±äº«å‡½æ•°æ—¶ï¼Œè¿™å°±æˆäº†ä¸€ä¸ªé—®é¢˜ã€‚
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDrizzle æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„â€œåŠ¨æ€â€æ¨¡å¼ï¼Œç”¨äºæŸ¥è¯¢æ„å»ºå™¨ï¼Œè¿™æ¶ˆé™¤äº†åªèƒ½è°ƒç”¨æ–¹æ³•ä¸€æ¬¡çš„é™åˆ¶ã€‚
è¦å¯ç”¨å®ƒï¼Œä½ éœ€è¦åœ¨æŸ¥è¯¢æ„å»ºå™¨ä¸Šè°ƒç”¨ `.$dynamic()`ã€‚

è®©æˆ‘ä»¬é€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„ `withPagination` å‡½æ•°æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¯¥å‡½æ•°æ ¹æ®æä¾›çš„é¡µç å’Œå¯é€‰çš„é¡µé¢å¤§å°ï¼Œä¸ºæŸ¥è¯¢æ·»åŠ  `LIMIT` å’Œ `OFFSET` å­å¥ï¼š

```ts
function withPagination<T extends PgSelect>(
	qb: T,
	page: number = 1,
	pageSize: number = 10,
) {
	return qb.limit(pageSize).offset((page - 1) * pageSize);
}

const query = db.select().from(users).where(eq(users.id, 1));
withPagination(query, 1); // âŒ ç±»å‹é”™è¯¯ - æŸ¥è¯¢æ„å»ºå™¨æœªå¤„äºåŠ¨æ€æ¨¡å¼

const dynamicQuery = query.$dynamic();
withPagination(dynamicQuery, 1); // âœ… æ­£å¸¸
```

è¯·æ³¨æ„ï¼Œ`withPagination` å‡½æ•°æ˜¯æ³›å‹çš„ï¼Œè¿™ä½¿ä½ èƒ½å¤Ÿåœ¨å…¶ä¸­ä¿®æ”¹æŸ¥è¯¢æ„å»ºå™¨çš„ç»“æœç±»å‹ï¼Œä¾‹å¦‚é€šè¿‡æ·»åŠ è¿æ¥ï¼š

```ts
function withFriends<T extends PgSelect>(qb: T) {
	return qb.leftJoin(friends, eq(friends.userId, users.id));
}

let query = db.select().from(users).where(eq(users.id, 1)).$dynamic();
query = withFriends(query);
```

è¿™å¯èƒ½æ˜¯å› ä¸º `PgSelect` å’Œå…¶ä»–ç±»ä¼¼ç±»å‹ä¸“é—¨è®¾è®¡ç”¨äºåŠ¨æ€æŸ¥è¯¢æ„å»ºã€‚å®ƒä»¬åªèƒ½åœ¨åŠ¨æ€æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚

ä»¥ä¸‹æ˜¯å¯ä»¥ä½œä¸ºæ³›å‹å‚æ•°ç”¨äºåŠ¨æ€æŸ¥è¯¢æ„å»ºçš„æ‰€æœ‰ç±»å‹åˆ—è¡¨ï¼š

{

<table>
	<thead align='center'>
		<tr>
			<td>
				<b>æ–¹è¨€</b>
			</td>
			<td colspan='4'>
				<b>ç±»å‹</b>
			</td>
		</tr>
		<tr>
			<td>
				<b>æŸ¥è¯¢</b>
			</td>
			<td>
				<b>é€‰æ‹©</b>
			</td>
			<td>
				<b>æ’å…¥</b>
			</td>
			<td>
				<b>æ›´æ–°</b>
			</td>
			<td>
				<b>åˆ é™¤</b>
			</td>
		</tr>
	</thead>
	<tbody>
		<tr align='center'>
			<td rowspan='2'>Postgres</td>
			<td>
				<code>PgSelect</code>
			</td>
			<td rowspan='2'>
				<code>PgInsert</code>
			</td>
			<td rowspan='2'>
				<code>PgUpdate</code>
			</td>
			<td rowspan='2'>
				<code>PgDelete</code>
			</td>
		</tr>
		<tr align='center'>
			<td>
				<code>PgSelectQueryBuilder</code>
			</td>
		</tr>
		<tr align='center'>
			<td rowspan='2'>MySQL</td>
			<td>
				<code>MySqlSelect</code>
			</td>
			<td rowspan='2'>
				<code>MySqlInsert</code>
			</td>
			<td rowspan='2'>
				<code>MySqlUpdate</code>
			</td>
			<td rowspan='2'>
				<code>MySqlDelete</code>
			</td>
		</tr>
		<tr align='center'>
			<td>
				<code>MySqlSelectQueryBuilder</code>
			</td>
		</tr>
		<tr align='center'>
			<td rowspan='2'>SQLite</td>
			<td>
				<code>SQLiteSelect</code>
			</td>
			<td rowspan='2'>
				<code>SQLiteInsert</code>
			</td>
			<td rowspan='2'>
				<code>SQLiteUpdate</code>
			</td>
			<td rowspan='2'>
				<code>SQLiteDelete</code>
			</td>
		</tr>
		<tr align='center'>
			<td>
				<code>SQLiteSelectQueryBuilder</code>
			</td>
		</tr>
	</tbody>
</table>

}

<Callout type='info'>
	`...QueryBuilder` ç±»å‹ç”¨äºä¸ [ç‹¬ç«‹æŸ¥è¯¢æ„å»ºå™¨å®ä¾‹](/docs/goodies#standalone-query-builder) ä¸€èµ·ä½¿ç”¨ã€‚
	æ•°æ®åº“æŸ¥è¯¢æ„å»ºå™¨æ˜¯å®ƒä»¬çš„å­ç±»ï¼Œ
	å› æ­¤ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚

    ```ts
    	import { QueryBuilder } from 'drizzle-orm/pg-core';

    	function withFriends<T extends PgSelectQueryBuilder>(qb: T) {
    		return qb.leftJoin(friends, eq(friends.userId, users.id));
    	}

    	const qb = new QueryBuilder();
    	let query = qb.select().from(users).where(eq(users.id, 1)).$dynamic();
    	query = withFriends(query);
    ```

</Callout>


Source: https://drizzle.zhcndoc.com/docs/eslint-plugin

import Tabs from '@mdx/Tabs.astro';
import Tab from '@mdx/Tab.astro';
import Npm from '@mdx/Npm.astro';

# ESLint Drizzle æ’ä»¶

å¯¹äºæ— æ³•è¿›è¡Œç‰¹å®šåœºæ™¯ç±»å‹æ£€æŸ¥çš„æƒ…å†µï¼Œæˆ–è€…è™½ç„¶å¯ä»¥è¿›è¡Œä½†é”™è¯¯æ¶ˆæ¯éš¾ä»¥ç†è§£çš„æƒ…å†µï¼Œæˆ‘ä»¬å†³å®šåˆ›å»ºä¸€ä¸ªåŒ…å«æ¨èè§„åˆ™çš„ ESLint åŒ…ã€‚è¿™ä¸ªåŒ…æ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜åœ¨å¼€å‘ä¸­å¤„ç†å…³é”®åœºæ™¯ã€‚

## å®‰è£…

<Npm>
eslint-plugin-drizzle
@typescript-eslint/eslint-plugin @typescript-eslint/parser
</Npm>

## ç”¨æ³•

**`.eslintrc.yml` ç¤ºä¾‹**
```yml
root: true
parser: '@typescript-eslint/parser'
parserOptions:
  project: './tsconfig.json'
plugins:
  - drizzle
rules:
  'drizzle/enforce-delete-with-where': "error"
  'drizzle/enforce-update-with-where': "error"
```

**æ‰€æœ‰é…ç½®**

æ­¤æ’ä»¶å¯¼å‡ºä¸€ä¸ª `all`ï¼Œå®ƒä½¿ç”¨æ‰€æœ‰è§„åˆ™ï¼ˆé™¤å·²å¼ƒç”¨çš„è§„åˆ™å¤–ï¼‰ã€‚

```yml
root: true
extends:
  - "plugin:drizzle/all"
parser: '@typescript-eslint/parser'
parserOptions:
  project: './tsconfig.json'
plugins:
  - drizzle
```

**æ¨èé…ç½®**

ç›®å‰ï¼Œ`all` ç­‰åŒäº `recommended`ã€‚

```yml
root: true
extends:
  - "plugin:drizzle/recommended"
parser: '@typescript-eslint/parser'
parserOptions:
  project: './tsconfig.json'
plugins:
  - drizzle
```

## è§„åˆ™

### **enforce-delete-with-where**

å¼ºåˆ¶åœ¨ `.delete()` è¯­å¥ä¸­ä½¿ç”¨ `delete` å’Œ `.where()` å­å¥ã€‚
å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨ä¸éœ€è¦åˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œéœ€è¦æŸç§ `WHERE` æ¡ä»¶ã€‚

å¯é€‰åœ°ï¼Œæ‚¨å¯ä»¥åœ¨æ’ä»¶é€‰é¡¹ä¸­å®šä¹‰ä¸€ä¸ª `drizzleObjectName`ï¼Œå®ƒå¯ä»¥æ¥å—ä¸€ä¸ª `string` æˆ– `string[]`ã€‚
è¿™åœ¨æ‚¨æœ‰åˆ é™¤æ–¹æ³•çš„å¯¹è±¡æˆ–ç±»æ—¶å¾ˆæœ‰ç”¨ï¼Œè€Œè¯¥åˆ é™¤æ–¹æ³•ä¸æ˜¯æ¥è‡ª Drizzleã€‚
è¿™æ ·çš„ `delete` æ–¹æ³•å°†è§¦å‘ ESLint è§„åˆ™ã€‚
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥å®šä¹‰æ‚¨åœ¨ä»£ç åº“ä¸­ä½¿ç”¨çš„ Drizzle å¯¹è±¡çš„åç§°ï¼ˆä¾‹å¦‚ dbï¼‰ï¼Œ
è¿™æ ·è§„åˆ™ä»…åœ¨åˆ é™¤æ–¹æ³•æ¥è‡ªæ­¤å¯¹è±¡æ—¶æ‰ä¼šè§¦å‘ï¼š

ç¤ºä¾‹ï¼Œé…ç½® 1:
```yml
rules:
  'drizzle/enforce-delete-with-where': "error"
```

```ts
class MyClass {
  public delete() {
    return {}
  }
}

const myClassObj = new MyClass();

// ---> å°†è¢« ESLint è§„åˆ™è§¦å‘
myClassObj.delete()

const db = drizzle(...)
// ---> å°†è¢« ESLint è§„åˆ™è§¦å‘
db.delete()
```

ç¤ºä¾‹ï¼Œé…ç½® 2:
```yml
rules:
  'drizzle/enforce-delete-with-where':
    - "error"
    - "drizzleObjectName": 
      - "db"
```
```ts
class MyClass {
  public delete() {
    return {}
  }
}

const myClassObj = new MyClass();

// ---> ä¸ä¼šè¢« ESLint è§„åˆ™è§¦å‘
myClassObj.delete()

const db = drizzle(...)
// ---> å°†è¢« ESLint è§„åˆ™è§¦å‘
db.delete()
```

### **enforce-update-with-where**: 

å¼ºåˆ¶åœ¨ `.update()` è¯­å¥ä¸­ä½¿ç”¨ `update` å’Œ `.where()` å­å¥ã€‚
å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨ä¸éœ€è¦æ›´æ–°è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œ
å¹¶éœ€è¦æŸç§ `WHERE` è¯­å¥ã€‚

å¯é€‰åœ°ï¼Œæ‚¨å¯ä»¥åœ¨æ’ä»¶é€‰é¡¹ä¸­å®šä¹‰ä¸€ä¸ª `drizzleObjectName`ï¼Œå®ƒå¯ä»¥æ¥å—ä¸€ä¸ª `string` æˆ– `string[]`ã€‚
è¿™åœ¨æ‚¨æœ‰æ›´æ–°æ–¹æ³•çš„å¯¹è±¡æˆ–ç±»æ—¶å¾ˆæœ‰ç”¨ï¼Œè€Œè¯¥æ›´æ–°æ–¹æ³•ä¸æ˜¯æ¥è‡ª Drizzleã€‚
è¿™æ ·çš„ `update` æ–¹æ³•å°†è§¦å‘ ESLint è§„åˆ™ã€‚
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥å®šä¹‰æ‚¨åœ¨ä»£ç åº“ä¸­ä½¿ç”¨çš„ Drizzle å¯¹è±¡çš„åç§°ï¼ˆä¾‹å¦‚ dbï¼‰ï¼Œ
è¿™æ ·è§„åˆ™ä»…åœ¨æ›´æ–°æ–¹æ³•æ¥è‡ªæ­¤å¯¹è±¡æ—¶æ‰ä¼šè§¦å‘ï¼š

ç¤ºä¾‹ï¼Œé…ç½® 1:
```yml
rules:
  'drizzle/enforce-update-with-where': "error"
```

```ts
class MyClass {
  public update() {
    return {}
  }
}

const myClassObj = new MyClass();

// ---> å°†è¢« ESLint è§„åˆ™è§¦å‘
myClassObj.update()

const db = drizzle(...)
// ---> å°†è¢« ESLint è§„åˆ™è§¦å‘
db.update()
```

ç¤ºä¾‹ï¼Œé…ç½® 2:
```yml
rules:
  'drizzle/enforce-update-with-where':
    - "error"
    - "drizzleObjectName": 
      - "db"
```
```ts
class MyClass {
  public update() {
    return {}
  }
}

const myClassObj = new MyClass();

// ---> ä¸ä¼šè¢« ESLint è§„åˆ™è§¦å‘
myClassObj.update()

const db = drizzle(...)
// ---> å°†è¢« ESLint è§„åˆ™è§¦å‘
db.update()
```

Source: https://drizzle.zhcndoc.com/docs/extensions/mysql


import Callout from '@mdx/Callout.astro';

<Callout>
ç›®å‰ï¼ŒDrizzle ä¸æ”¯æŒä»»ä½•åŸç”Ÿçš„ MySQL æ‰©å±•ã€‚ä¸€æ—¦æ·»åŠ äº†è¿™äº›æ‰©å±•ï¼Œæˆ‘ä»¬å°†åœ¨è¿™é‡Œæ›´æ–°ï¼
</Callout>

Source: https://drizzle.zhcndoc.com/docs/extensions/pg


import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';

### `pg_vector`

<Callout>
åœ¨ Drizzle æ¨¡å¼ä¸‹ï¼Œæ²¡æœ‰ç‰¹å®šçš„ä»£ç ç”¨äºåˆ›å»ºæ‰©å±•ã€‚æˆ‘ä»¬å‡è®¾æ‚¨æ­£åœ¨ä½¿ç”¨å‘é‡ç±»å‹ã€ç´¢å¼•å’ŒæŸ¥è¯¢ï¼Œ
å¹¶ä¸”æ‚¨æœ‰ä¸€ä¸ªå®‰è£…äº† pg_vector æ‰©å±•çš„ PostgreSQL æ•°æ®åº“ã€‚
</Callout>

[`pg_vector`](https://github.com/pgvector/pgvector) æ˜¯ç”¨äº Postgres çš„å¼€æºå‘é‡ç›¸ä¼¼æ€§æœç´¢

å°†å‘é‡ä¸å…¶ä»–æ•°æ®ä¸€èµ·å­˜å‚¨ã€‚æ”¯æŒï¼š

- ç²¾ç¡®å’Œè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢
- å•ç²¾åº¦ã€åŠç²¾åº¦ã€äºŒè¿›åˆ¶å’Œç¨€ç–å‘é‡
- L2 è·ç¦»ã€å†…ç§¯ã€ä½™å¼¦è·ç¦»ã€L1 è·ç¦»ã€æ±‰æ˜è·ç¦»å’Œæ°å¡å¾·è·ç¦»

#### åˆ—ç±»å‹

**`vector`**

å°†å‘é‡ä¸å…¶ä»–æ•°æ®ä¸€èµ·å­˜å‚¨

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ pg_vector æ–‡æ¡£ **[docs.](https://github.com/pgvector/pgvector)**


<Section>
```ts
const table = pgTable('table', {
    embedding: vector({ dimensions: 3 })
})
```

```sql
CREATE TABLE IF NOT EXISTS "table" (
	"embedding" vector(3)
);
```
</Section>

#### ç´¢å¼•

ç°åœ¨æ‚¨å¯ä»¥ä¸º `pg_vector` æŒ‡å®šç´¢å¼•ï¼Œå¹¶åˆ©ç”¨ `pg_vector` å‡½æ•°è¿›è¡ŒæŸ¥è¯¢ã€æ’åºç­‰ã€‚

è®©æˆ‘ä»¬ä» `pg_vector` æ–‡æ¡£ä¸­è·å–å‡ ä¸ª `pg_vector` ç´¢å¼•çš„ç¤ºä¾‹å¹¶ç¿»è¯‘æˆ Drizzle

#### L2 è·ç¦»ã€å†…ç§¯å’Œä½™å¼¦è·ç¦»

```ts
// CREATE INDEX ON items USING hnsw (embedding vector_l2_ops);
// CREATE INDEX ON items USING hnsw (embedding vector_ip_ops);
// CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);

const table = pgTable('items', {
    embedding: vector({ dimensions: 3 })
}, (table) => [
  index('l2_index').using('hnsw', table.embedding.op('vector_l2_ops'))
  index('ip_index').using('hnsw', table.embedding.op('vector_ip_ops'))
  index('cosine_index').using('hnsw', table.embedding.op('vector_cosine_ops'))
])
```

#### L1 è·ç¦»ã€æ±‰æ˜è·ç¦»å’Œæ°å¡å¾·è·ç¦» - åœ¨ pg_vector 0.7.0 ç‰ˆæœ¬ä¸­æ·»åŠ 

```ts
// CREATE INDEX ON items USING hnsw (embedding vector_l1_ops);
// CREATE INDEX ON items USING hnsw (embedding bit_hamming_ops);
// CREATE INDEX ON items USING hnsw (embedding bit_jaccard_ops);

const table = pgTable('table', {
    embedding: vector({ dimensions: 3 })
}, (table) => [
  index('l1_index').using('hnsw', table.embedding.op('vector_l1_ops')),
  index('hamming_index').using('hnsw', table.embedding.op('bit_hamming_ops')),
  index('bit_jaccard_index').using('hnsw', table.embedding.op('bit_jaccard_ops'))
])
```

#### è¾…åŠ©å‡½æ•°

å¯¹äºæŸ¥è¯¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é¢„å®šä¹‰çš„å‘é‡å‡½æ•°ï¼Œæˆ–ä½¿ç”¨ SQL æ¨¡æ¿è¿ç®—ç¬¦åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¾…åŠ©åŠŸèƒ½ï¼š

```ts
import { l2Distance, l1Distance, innerProduct, 
          cosineDistance, hammingDistance, jaccardDistance } from 'drizzle-orm'

l2Distance(table.column, [3, 1, 2]) // table.column <-> '[3, 1, 2]'
l1Distance(table.column, [3, 1, 2]) // table.column <+> '[3, 1, 2]'

innerProduct(table.column, [3, 1, 2]) // table.column <#> '[3, 1, 2]'
cosineDistance(table.column, [3, 1, 2]) // table.column <=> '[3, 1, 2]'

hammingDistance(table.column, '101') // table.column <~> '101'
jaccardDistance(table.column, '101') // table.column <%> '101'
```

å¦‚æœ `pg_vector` æœ‰å…¶ä»–å‡½æ•°å¯ç”¨ï¼Œæ‚¨å¯ä»¥å¤åˆ¶ç°æœ‰çš„å®ç°ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å®ç°å®ƒã€‚

```ts
export function l2Distance(
  column: SQLWrapper | AnyColumn,
  value: number[] | string[] | TypedQueryBuilder<any> | string,
): SQL {
  if (is(value, TypedQueryBuilder<any>) || typeof value === 'string') {
    return sql`${column} <-> ${value}`;
  }
  return sql`${column} <-> ${JSON.stringify(value)}`;
}
```

æ‚¨å¯ä»¥éšæ„å‘½åå¹¶æ›´æ”¹è¿ç®—ç¬¦ã€‚æ­¤ç¤ºä¾‹å…è®¸æ•°å­—æ•°ç»„ã€å­—ç¬¦ä¸²æ•°ç»„ã€å­—ç¬¦ä¸²ï¼Œæˆ–ç”šè‡³é€‰æ‹©æŸ¥è¯¢ã€‚è¯·éšæ„åˆ›å»ºå…¶ä»–ç±»å‹ï¼Œæˆ–ç”šè‡³è´¡çŒ®å¹¶æäº¤ PRã€‚

#### ç¤ºä¾‹

è®©æˆ‘ä»¬ä» `pg_vector` æ–‡æ¡£ä¸­è·å–å‡ ä¸ª `pg_vector` æŸ¥è¯¢çš„ç¤ºä¾‹å¹¶ç¿»è¯‘æˆ Drizzleã€‚

```ts
import { l2Distance } from 'drizzle-orm';

// SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
db.select().from(items).orderBy(l2Distance(items.embedding, [3,1,2]))

// SELECT embedding <-> '[3,1,2]' AS distance FROM items;
db.select({ distance: l2Distance(items.embedding, [3,1,2]) })

// SELECT * FROM items ORDER BY embedding <-> (SELECT embedding FROM items WHERE id = 1) LIMIT 5;
const subquery = db.select({ embedding: items.embedding }).from(items).where(eq(items.id, 1));
db.select().from(items).orderBy(l2Distance(items.embedding, subquery)).limit(5)

// SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;
db.select({ innerProduct: sql`(${maxInnerProduct(items.embedding, [3,1,2])}) * -1` }).from(items)

// è¿˜æœ‰æ›´å¤šï¼
```

### `postgis`

<Callout>
åœ¨ Drizzle æ¨¡å¼ä¸‹ï¼Œæ²¡æœ‰ç‰¹å®šçš„ä»£ç ç”¨äºåˆ›å»ºæ‰©å±•ã€‚æˆ‘ä»¬å‡è®¾æ‚¨æ­£åœ¨ä½¿ç”¨ postgis ç±»å‹ã€ç´¢å¼•å’ŒæŸ¥è¯¢ï¼Œå¹¶ä¸”æ‚¨æœ‰ä¸€ä¸ªå®‰è£…äº† `postgis` æ‰©å±•çš„ PostgreSQL æ•°æ®åº“ã€‚
</Callout>

æ­£å¦‚ [PostGIS](https://postgis.net/) ç½‘ç«™æ‰€æåˆ°çš„ï¼š

> PostGIS é€šè¿‡å¢åŠ å¯¹å­˜å‚¨ã€ç´¢å¼•å’ŒæŸ¥è¯¢åœ°ç†ç©ºé—´æ•°æ®çš„æ”¯æŒï¼Œæ‰©å±•äº† PostgreSQL å…³ç³»æ•°æ®åº“çš„åŠŸèƒ½ã€‚

<Callout type="info">
å¦‚æœæ‚¨åœ¨ä½¿ç”¨ PostGIS æ‰©å±•æ—¶ä½¿ç”¨ `introspect` æˆ– `push` å‘½ä»¤ä¸”ä¸å¸Œæœ›åŒ…å« PostGIS è¡¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [`extensionsFilters`](/docs/drizzle-config-file#extensionsfilters) æ¥å¿½ç•¥æ‰€æœ‰ PostGIS è¡¨ã€‚
</Callout>

#### åˆ—ç±»å‹

**`geometry`**

å°†æ‚¨çš„å‡ ä½•æ•°æ®ä¸å…¶ä»–æ•°æ®ä¸€èµ·å­˜å‚¨ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…å®˜æ–¹ PostGIS æ–‡æ¡£ **[docs.](https://postgis.net/workshops/postgis-intro/geometries.html)**

```ts
const items = pgTable('items', {
  geo: geometry('geo', { type: 'point' }),
  geoObj: geometry('geo_obj', { type: 'point', mode: 'xy' }),
  geoSrid: geometry('geo_options', { type: 'point', mode: 'xy', srid: 4000 }),
});
```

**mode**

`geometry` ç±»å‹æœ‰ 2 ç§æ¨¡å¼å¯ç”¨äºæ•°æ®åº“æ˜ å°„ï¼š`tuple` å’Œ `xy`ã€‚

- `tuple` å°†è¢«æ¥å—ç”¨äºæ’å…¥ï¼Œå¹¶åœ¨é€‰æ‹©æ—¶æ˜ å°„åˆ°å…ƒç»„ã€‚å› æ­¤ï¼Œæ•°æ®åº“å‡ ä½•å°†è¢«è§†ä¸º [1,2] ä¸ drizzleã€‚
- `xy` å°†è¢«æ¥å—ç”¨äºæ’å…¥ï¼Œå¹¶åœ¨é€‰æ‹©æ—¶æ˜ å°„åˆ°å…·æœ‰ xã€y åæ ‡çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œæ•°æ®åº“å‡ ä½•å°†è¢«è§†ä¸º `{ x: 1, y: 2 }` ä¸ drizzleã€‚

**type**

å½“å‰ç‰ˆæœ¬æœ‰ä¸€ä¸ªé¢„å®šä¹‰ç±»å‹ï¼š`point`ï¼Œè¿™æ˜¯ PostgreSQL PostGIS æ‰©å±•ä¸­çš„ `geometry(Point)` ç±»å‹ã€‚å¦‚æœæƒ³ä½¿ç”¨å…¶ä»–ç±»å‹ï¼Œå¯ä»¥æŒ‡å®šä»»ä½•å­—ç¬¦ä¸²ã€‚

#### ç´¢å¼•

ä½¿ç”¨å¯ç”¨çš„ Drizzle ç´¢å¼• APIï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿä¸º PostGIS ç¼–å†™ä»»ä½•ç´¢å¼•ã€‚

**ç¤ºä¾‹**

```ts
// CREATE INDEX custom_idx ON table USING GIST (geom);

const table = pgTable('table', {
  	geo: geometry({ type: 'point' }),
}, (table) => [
  index('custom_idx').using('gist', table.geo)
])
```

Source: https://drizzle.zhcndoc.com/docs/extensions/singlestore


import Callout from '@mdx/Callout.astro';

<Callout>
ç›®å‰ï¼ŒDrizzle åŸç”Ÿä¸æ”¯æŒä»»ä½• SingleStore æ‰©å±•ã€‚ä¸€æ—¦æ·»åŠ ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™é‡Œå±•ç¤ºï¼
</Callout>

Source: https://drizzle.zhcndoc.com/docs/extensions/sqlite


import Callout from '@mdx/Callout.astro';

<Callout>
ç›®å‰ï¼ŒDrizzle åŸç”Ÿä¸æ”¯æŒä»»ä½• SQLite æ‰©å±•ã€‚ä¸€æ—¦è¿™äº›æ‰©å±•è¢«æ·»åŠ ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™é‡Œæä¾›å®ƒä»¬ï¼
</Callout>

Source: https://drizzle.zhcndoc.com/docs/faq

import Callout from '@mdx/Callout.astro';

# å¸¸è§é—®é¢˜ä¸æ•…éšœæ’é™¤

## **æˆ‘åº”è¯¥ä½¿ç”¨ `generate` è¿˜æ˜¯ `push`ï¼Ÿ**

è¿™ä¸¤ä¸ªå‘½ä»¤åœ¨é€»è¾‘ä¸Šæ˜¯ä¸åŒçš„ã€‚`generate` ç”¨äºåˆ›å»ºä¸€ä¸ª SQL æ–‡ä»¶ï¼Œ
å¹¶é™„å¸¦ `drizzle-kit` ï¼ˆæˆ–ä»»ä½•å…¶ä»–è¿ç§»å·¥å…·ï¼‰æ‰€éœ€çš„é¢å¤–ä¿¡æ¯ã€‚

åœ¨ç”Ÿæˆè¿™äº›è¿ç§»åï¼Œå®ƒä»¬ä¸ä¼šè¢«åº”ç”¨åˆ°æ•°æ®åº“ã€‚ ä½ éœ€è¦åœ¨ä¸‹ä¸€æ­¥ä¸­æ‰§è¡Œæ­¤æ“ä½œã€‚
ä½ å¯ä»¥åœ¨ **[è¿™é‡Œ](/docs/migrations)** äº†è§£æ›´å¤šä¿¡æ¯ã€‚

å¦ä¸€æ–¹é¢ï¼Œ`push` ä¸éœ€è¦ç”Ÿæˆä»»ä½•è¿ç§»ã€‚
å®ƒä¼šç®€å•åœ°å°†ä½ çš„æ¨¡å¼ä¸æ•°æ®åº“æ¨¡å¼åŒæ­¥ã€‚
ä½¿ç”¨æ—¶è¯·å°å¿ƒï¼›æˆ‘ä»¬å»ºè®®ä»…åœ¨æœ¬åœ°å¼€å‘å’Œæœ¬åœ°æ•°æ®åº“ä¸­ä½¿ç”¨ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ **[`drizzle-kit push`](/docs/drizzle-kit-push)**ã€‚

## `push` å’Œ `generate` åœ¨ PostgreSQL ç´¢å¼•ä¸­çš„å·¥ä½œåŸç†

### é™åˆ¶

1. **å¦‚æœåœ¨è‡³å°‘ä¸€ä¸ªè¡¨è¾¾å¼ä¸Šæœ‰ç´¢å¼•ï¼Œä½ åº”è¯¥æ‰‹åŠ¨æŒ‡å®šç´¢å¼•åç§°**

ç¤ºä¾‹

```ts
index().on(table.id, table.email) // å°†æ­£å¸¸å·¥ä½œï¼Œåç§°å°†è¢«è‡ªåŠ¨ç”Ÿæˆ
index('my_name').on(table.id, table.email) // å°†æ­£å¸¸å·¥ä½œ

// ä½†æ˜¯

index().on(sql`lower(${table.email})`) // é”™è¯¯
index('my_name').on(sql`lower(${table.email})`) // å°†æ­£å¸¸å·¥ä½œ
```

2. **å¦‚æœä»¥ä¸‹å­—æ®µåœ¨ç°æœ‰ç´¢å¼•ä¸­å‘ç”Ÿäº†æ›´æ”¹ï¼ŒPush å°†ä¸ä¼šç”Ÿæˆè¯­å¥ï¼š**

- `.on()` å’Œ `.using()` ä¸­çš„è¡¨è¾¾å¼
- `.where()` è¯­å¥
- åˆ—ä¸Šçš„æ“ä½œç¬¦ç±» `.op()`

å¦‚æœä½ ä½¿ç”¨ `push` å·¥ä½œæµå¹¶æƒ³æ›´æ”¹ç´¢å¼•ä¸­çš„è¿™äº›å­—æ®µï¼Œä½ éœ€è¦ï¼š

1. æ³¨é‡Šæ‰ç´¢å¼•
2. Push
3. å–æ¶ˆæ³¨é‡Šç´¢å¼•å¹¶æ›´æ”¹è¿™äº›å­—æ®µ
4. å†æ¬¡ Push

å¯¹äº `generate` å‘½ä»¤ï¼Œä»»ä½•åœ¨æ–° drizzle ç´¢å¼• API ä¸­å¯¹ç´¢å¼•çš„ä»»ä½•å±æ€§çš„æ›´æ”¹éƒ½ä¼šè§¦å‘ `drizzle-kit`ï¼Œå› æ­¤åœ¨è¿™é‡Œæ²¡æœ‰é™åˆ¶ã€‚

Source: https://drizzle.zhcndoc.com/docs/generated-columns

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

# ç”Ÿæˆåˆ—

<Callout type="info">
è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œæ‚¨éœ€è¦å®‰è£… `drizzle-orm@0.32.0` æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥åŠ `drizzle-kit@0.23.0` æˆ–æ›´é«˜ç‰ˆæœ¬
</Callout>

SQL ä¸­çš„ç”Ÿæˆåˆ—æ˜¯ä¸€é¡¹åŠŸèƒ½ï¼Œå…è®¸æ‚¨åœ¨è¡¨ä¸­åˆ›å»ºåˆ—ï¼Œå…¶å€¼åŸºäºåŒä¸€è¡¨ä¸­å…¶ä»–åˆ—çš„è¡¨è¾¾å¼è‡ªåŠ¨è®¡ç®—ã€‚è¿™æœ‰åŠ©äºç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œç®€åŒ–æ•°æ®åº“è®¾è®¡ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

ç”Ÿæˆåˆ—æœ‰ä¸¤ç§ç±»å‹ï¼š

1. è™šæ‹Ÿï¼ˆæˆ–éæŒä¹…æ€§ï¼‰ç”Ÿæˆåˆ—ï¼šè¿™äº›åˆ—åœ¨æŸ¥è¯¢æ—¶åŠ¨æ€è®¡ç®—ã€‚å®ƒä»¬åœ¨æ•°æ®åº“ä¸­ä¸å ç”¨å­˜å‚¨ç©ºé—´ã€‚
2. å­˜å‚¨ï¼ˆæˆ–æŒä¹…æ€§ï¼‰ç”Ÿæˆåˆ—ï¼šè¿™äº›åˆ—åœ¨æ’å…¥æˆ–æ›´æ–°è¡Œæ—¶è®¡ç®—ï¼Œå¹¶å°†å…¶å€¼å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚è¿™ä½¿å®ƒä»¬å¯ä»¥è¢«ç´¢å¼•ï¼Œå¹¶ä¸”å¯ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå› ä¸ºå€¼ä¸éœ€è¦åœ¨æ¯ä¸ªæŸ¥è¯¢ä¸­é‡æ–°è®¡ç®—ã€‚

ç”Ÿæˆåˆ—å¯¹äºä»¥ä¸‹æƒ…å†µç‰¹åˆ«æœ‰ç”¨ï¼š

- ä»ç°æœ‰åˆ—æ´¾ç”Ÿæ–°æ•°æ®
- è‡ªåŠ¨åŒ–è®¡ç®—ä»¥é¿å…æ‰‹åŠ¨æ›´æ–°
- å¼ºåˆ¶æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- é€šè¿‡å°†å¤æ‚è®¡ç®—ä¿ç•™åœ¨æ•°æ®åº“æ¶æ„ä¸­ç®€åŒ–åº”ç”¨é€»è¾‘

<Callout type="info">
    ç”Ÿæˆåˆ—çš„å®ç°å’Œä½¿ç”¨åœ¨ä¸åŒçš„ SQL æ•°æ®åº“ä¸­å¯èƒ½æœ‰æ˜¾è‘—å·®å¼‚ã€‚PostgreSQLã€MySQL å’Œ SQLite åœ¨ç”Ÿæˆåˆ—æ–¹é¢å„è‡ªæœ‰ç‹¬ç‰¹çš„ç‰¹æ€§ã€èƒ½åŠ›å’Œé™åˆ¶ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†æ¢è®¨è¿™äº›å·®å¼‚ï¼Œä»¥å¸®åŠ©æ‚¨äº†è§£å¦‚ä½•åœ¨æ¯ä¸ªæ•°æ®åº“ç³»ç»Ÿä¸­æœ€å¥½åœ°åˆ©ç”¨ç”Ÿæˆåˆ—ã€‚
</Callout>

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore(WIP)", "MSSQL", "CockroachDB"]}>
  <Tab>
    #### æ•°æ®åº“ç«¯
    **ç±»å‹**: `STORED` ä»…

    **å·¥ä½œåŸç†**
    - åœ¨æ’å…¥æˆ–æ›´æ–°æ—¶è‡ªåŠ¨è®¡ç®—åŸºäºå…¶ä»–åˆ—çš„å€¼ã€‚

    **èƒ½åŠ›**
    - é€šè¿‡é¢„è®¡ç®—å¤æ‚è¡¨è¾¾å¼ç®€åŒ–æ•°æ®è®¿é—®ã€‚
    - é€šè¿‡ç”Ÿæˆåˆ—çš„ç´¢å¼•æ”¯æŒå¢å¼ºæŸ¥è¯¢æ€§èƒ½ã€‚

    **é™åˆ¶**
    - ä¸èƒ½æŒ‡å®šé»˜è®¤å€¼ã€‚
    - è¡¨è¾¾å¼ä¸èƒ½å¼•ç”¨å…¶ä»–ç”Ÿæˆåˆ—æˆ–åŒ…å«å­æŸ¥è¯¢ã€‚
    - ä¿®æ”¹ç”Ÿæˆåˆ—è¡¨è¾¾å¼éœ€è¦æ›´æ”¹æ¶æ„ã€‚
    - ä¸èƒ½ç›´æ¥ç”¨äºä¸»é”®ã€å¤–é”®æˆ–å”¯ä¸€çº¦æŸã€‚

    æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [PostgreSQL](https://www.postgresql.org/docs/current/ddl-generated-columns.html) æ–‡æ¡£ã€‚

    #### Drizzle ç«¯
    åœ¨ Drizzle ä¸­ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•åˆ—ç±»å‹ä¸ŠæŒ‡å®š `.generatedAlwaysAs()` å‡½æ•°ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ”¯æŒçš„ SQL æŸ¥è¯¢ï¼Œè¿™å°†ä¸ºä½ ç”Ÿæˆè¯¥åˆ—çš„æ•°æ®ã€‚

    #### ç‰¹æ€§ 
    æ­¤å‡½æ•°å¯ä»¥ä»¥ä¸‰ç§æ–¹å¼æ¥å—ç”Ÿæˆè¡¨è¾¾å¼ï¼š

    **`string`**
    <CodeTab>
    ```ts
    export const test = pgTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(`hello world!`),
    });
    ```
    ```sql
    CREATE TABLE IF NOT EXISTS "test" (
	    "gen_name" text GENERATED ALWAYS AS (hello world!) STORED
    );
    ```
    </CodeTab>

    **`sql`** æ ‡ç­¾ - å¦‚æœæ‚¨å¸Œæœ› Drizzle ä¸ºæ‚¨è½¬ä¹‰ä¸€äº›å€¼

    <CodeTab>
    ```ts
    export const test = pgTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(sql`hello "world"!`),
    });
    ```
    ```sql
    CREATE TABLE IF NOT EXISTS "test" (
	    "gen_name" text GENERATED ALWAYS AS (hello "world"!) STORED
    );
    ```
    </CodeTab>

    **`callback`** - å¦‚æœæ‚¨éœ€è¦å¼•ç”¨è¡¨ä¸­çš„åˆ—
    <CodeTab>
    ```ts
    export const test = pgTable("test", {
        name: text("first_name"),
        generatedName: text("gen_name").generatedAlwaysAs(
          (): SQL => sql`hi, ${test.name}!`
        ),
    });
    ```
    ```sql
    CREATE TABLE IF NOT EXISTS "test" (
	    "first_name" text,
	    "gen_name" text GENERATED ALWAYS AS (hi, "test"."first_name"!) STORED
    );
    ```
    </CodeTab>

    **ç¤ºä¾‹** ç”Ÿæˆåˆ—ä¸å…¨æ–‡æœç´¢
   <CodeTabs items={["schema.ts"]}>
	<CodeTab>
	```typescript copy {17-19}
    import { SQL, sql } from "drizzle-orm";
    import { customType, index, integer, pgTable, text } from "drizzle-orm/pg-core";

    const tsVector = customType<{ data: string }>({
      dataType() {
        return "tsvector";
      },
    });

    export const test = pgTable(
      "test",
      {
        id: integer("id").primaryKey().generatedAlwaysAsIdentity(),
        content: text("content"),
        contentSearch: tsVector("content_search", {
          dimensions: 3,
        }).generatedAlwaysAs(
          (): SQL => sql`to_tsvector('english', ${test.content})`
        ),
      },
      (t) => [
        index("idx_content_search").using("gin", t.contentSearch)
      ]
    );
    ```
    ```sql {4}
    CREATE TABLE IF NOT EXISTS "test" (
    	"id" integer PRIMARY KEY GENERATED ALWAYS AS IDENTITY (sequence name "test_id_seq" INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START WITH 1 CACHE 1),
    	"content" text,
    	"content_search" "tsvector" GENERATED ALWAYS AS (to_tsvector('english', "test"."content")) STORED
    );
    --> statement-breakpoint
    CREATE INDEX IF NOT EXISTS "idx_content_search" ON "test" USING gin ("content_search");
    ```
    </CodeTab>
   </CodeTabs>
  </Tab> 
  <Tab>
    #### æ•°æ®åº“ç«¯
    **ç±»å‹**: `STORED`, `VIRTUAL`

    **å·¥ä½œåŸç†**
    - é€šè¿‡è¡¨æ¶æ„ä¸­çš„è¡¨è¾¾å¼å®šä¹‰ã€‚
    - è™šæ‹Ÿåˆ—åœ¨è¯»å–æ“ä½œæ—¶è®¡ç®—ã€‚
    - å­˜å‚¨åˆ—åœ¨å†™å…¥æ“ä½œæ—¶è®¡ç®—å¹¶å­˜å‚¨ã€‚

    **èƒ½åŠ›**
    - å¯ç”¨äº SELECTã€INSERTã€UPDATE å’Œ DELETE è¯­å¥ã€‚
    - å¯ä»¥è¢«ç´¢å¼•ï¼ŒåŒ…æ‹¬è™šæ‹Ÿå’Œå­˜å‚¨åˆ—ã€‚
    - å¯ä»¥æŒ‡å®š NOT NULL å’Œå…¶ä»–çº¦æŸã€‚
    
    **é™åˆ¶**
    - æ— æ³•ç›´æ¥æ’å…¥æˆ–æ›´æ–°ç”Ÿæˆåˆ—ä¸­çš„å€¼ã€‚

    æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [MySQL Alter Generated](https://dev.mysql.com/doc/refman/8.4/en/alter-table-generated-columns.html) æ–‡æ¡£å’Œ [MySQL create generated](https://dev.mysql.com/doc/refman/8.4/en/create-table-generated-columns.html) æ–‡æ¡£ã€‚

    #### Drizzle ç«¯

    #### ç‰¹æ€§ 

    **`string`**
    <CodeTab>
    ```ts
    export const test = mysqlTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(`hello world!`),
    });
    ```
    ```sql
    CREATE TABLE `test` (
	    `gen_name` text GENERATED ALWAYS AS (hello world!) VIRTUAL
    );
    ```
    </CodeTab>

    **`sql`** æ ‡ç­¾ - å¦‚æœæ‚¨å¸Œæœ› Drizzle ä¸ºæ‚¨è½¬ä¹‰ä¸€äº›å€¼

    <CodeTab>
    ```ts
    export const test = mysqlTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(sql`hello "world"!`),
    });
    ```
    ```sql
    CREATE TABLE `test` (
	    `gen_name` text GENERATED ALWAYS AS (hello "world"!) VIRTUAL
    );
    ```
    </CodeTab>

    **`callback`** - å¦‚æœæ‚¨éœ€è¦å¼•ç”¨è¡¨ä¸­çš„åˆ—

    <CodeTab>
    ```ts
    export const test = mysqlTable("test", {
        name: text("first_name"),
        generatedName: text("gen_name").generatedAlwaysAs(
          (): SQL => sql`hi, ${test.name}!`
        ),
    });
    ```
    ```sql
    CREATE TABLE `test` (
    	`first_name` text,
    	`gen_name` text GENERATED ALWAYS AS (hi, `test`.`first_name`!) VIRTUAL
    );
    ```
    </CodeTab>
    #### é™åˆ¶
    Drizzle Kit ä¹Ÿå°†åœ¨ `push` å‘½ä»¤ä¸­æœ‰é™åˆ¶ï¼š
    1. æ‚¨ä¸èƒ½ä½¿ç”¨ `push` æ›´æ”¹ç”Ÿæˆçº¦æŸè¡¨è¾¾å¼å’Œç±»å‹ã€‚Drizzle-kit ä¼šå¿½ç•¥æ­¤æ›´æ”¹ã€‚è¦ä½¿å…¶å·¥ä½œï¼Œæ‚¨éœ€è¦å…ˆ `drop` åˆ—ï¼Œ`push`ï¼Œç„¶å `add` å¸¦æœ‰æ–°è¡¨è¾¾å¼çš„åˆ—ã€‚è¿™æ˜¯ç”±äºæ•°æ®åº“ç«¯å¤æ‚çš„æ˜ å°„ï¼Œå…¶ä¸­æ¶æ„è¡¨è¾¾å¼å°†åœ¨æ•°æ®åº“ç«¯è¢«ä¿®æ”¹ï¼Œè€Œåœ¨åå‘å·¥ç¨‹æ—¶ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸åŒçš„å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬æ— æ³•ç¡®å®šæ‚¨æ˜¯æ›´æ”¹äº†æ­¤è¡¨è¾¾å¼ï¼Œè¿˜æ˜¯å®ƒè¢«æ•°æ®åº“æ›´æ”¹å’Œæ ¼å¼åŒ–ã€‚ç”±äºè¿™äº›æ˜¯ç”Ÿæˆåˆ—ä¸” `push` é€šå¸¸ç”¨äºæœ¬åœ°æ•°æ®åº“çš„åŸå‹ï¼Œ`drop` å’Œ `create` ç”Ÿæˆåˆ—åº”è¯¥æ˜¯å¿«é€Ÿçš„ã€‚ç”±äºè¿™äº›åˆ—æ˜¯ `generated`ï¼Œæ‰€æœ‰æ•°æ®å°†ä¼šè¢«æ¢å¤ã€‚
    2. `generate` åº”è¯¥æ²¡æœ‰é™åˆ¶ã€‚

  <CodeTabs items={["schema.ts"]}>
	<CodeTab>
	```typescript copy
    export const users = mysqlTable("users", {
        id: int("id"),
        id2: int("id2"),
        name: text("name"),
        storedGenerated: text("stored_gen").generatedAlwaysAs(
          (): SQL => sql`${users.name} || 'hello'`,
          { mode: "stored" }
        ),
        virtualGenerated: text("virtual_gen").generatedAlwaysAs(
          (): SQL => sql`${users.name} || 'hello'`,
          { mode: "virtual" }
        ),
    })
    ```
    ```sql
    CREATE TABLE `users` (
	    `id` int,
	    `id2` int,
	    `name` text,
	    `stored_gen` text GENERATED ALWAYS AS (`users`.`name` || 'hello') STORED,
	    `virtual_gen` text GENERATED ALWAYS AS (`users`.`name` || 'hello') VIRTUAL
    );
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
    #### æ•°æ®åº“ç«¯
    **ç±»å‹**: `STORED`, `VIRTUAL`

    **å·¥ä½œåŸç†**
    - é€šè¿‡è¡¨æ¶æ„ä¸­çš„è¡¨è¾¾å¼å®šä¹‰ã€‚
    - è™šæ‹Ÿåˆ—åœ¨è¯»å–æ“ä½œæ—¶è®¡ç®—ã€‚
    - å­˜å‚¨åˆ—åœ¨å†™å…¥æ“ä½œæ—¶è®¡ç®—å¹¶å­˜å‚¨ã€‚

    **èƒ½åŠ›**
    - å¯ç”¨äº SELECTã€INSERTã€UPDATE å’Œ DELETE è¯­å¥ã€‚
    - å¯ä»¥è¢«ç´¢å¼•ï¼ŒåŒ…æ‹¬è™šæ‹Ÿå’Œå­˜å‚¨åˆ—ã€‚
    - å¯ä»¥æŒ‡å®š NOT NULL å’Œå…¶ä»–çº¦æŸã€‚
    
    **é™åˆ¶**
    - æ— æ³•ç›´æ¥æ’å…¥æˆ–æ›´æ–°ç”Ÿæˆåˆ—ä¸­çš„å€¼ã€‚

    æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [SQLite](https://www.sqlite.org/gencol.html) æ–‡æ¡£ã€‚

    #### Drizzle ç«¯

    #### ç‰¹æ€§
    **`string`**
    ```ts
    export const test = sqliteTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(`hello world!`),
    });
    ```
    ```sql
    CREATE TABLE `test` (
	    `gen_name` text GENERATED ALWAYS AS (hello world!) VIRTUAL
    );
    ```

    **`sql`** æ ‡ç­¾ - å¦‚æœæ‚¨å¸Œæœ› Drizzle ä¸ºæ‚¨è½¬ä¹‰ä¸€äº›å€¼

    ```ts
    export const test = sqliteTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(sql`hello "world"!`),
    });
    ```
    ```sql
    CREATE TABLE `test` (
	    `gen_name` text GENERATED ALWAYS AS (hello "world"!) VIRTUAL
    );
    ```

    **`callback`** - å¦‚æœæ‚¨éœ€è¦å¼•ç”¨è¡¨ä¸­çš„åˆ—

    ```ts
    export const test = sqliteTable("test", {
        name: text("first_name"),
        generatedName: text("gen_name").generatedAlwaysAs(
          (): SQL => sql`hi, ${test.name}!`
        ),
    });
    ```
    ```sql
    CREATE TABLE `test` (
	    `first_name` text,
	    `gen_name` text GENERATED ALWAYS AS (hi, "first_name"!) VIRTUAL
    );
    ```

    #### é™åˆ¶
    Drizzle Kit ä¹Ÿå°†åœ¨ `push` å’Œ `generate` å‘½ä»¤ä¸­æœ‰é™åˆ¶ï¼š
    1. æ‚¨ä¸èƒ½ä½¿ç”¨å­˜å‚¨ç±»å‹æ›´æ”¹ç°æœ‰è¡¨ä¸­çš„ç”Ÿæˆçº¦æŸè¡¨è¾¾å¼ã€‚æ‚¨éœ€è¦åˆ é™¤æ­¤è¡¨å¹¶é‡æ–°åˆ›å»ºã€‚è¿™æ˜¯ç”±äº SQLite å¯¹æ­¤ç±»æ“ä½œçš„é™åˆ¶ã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å¤„ç†æ­¤æƒ…å†µï¼ˆè¿™å°†æ¶‰åŠåˆ›å»ºä¸€ä¸ªæ–°è¡¨å¹¶è¿›è¡Œæ•°æ®è¿ç§»ï¼‰ã€‚
    2. æ‚¨ä¸èƒ½å°† `stored` ç”Ÿæˆè¡¨è¾¾å¼æ·»åŠ åˆ°ç°æœ‰åˆ—ä¸­ï¼Œç”±äºä»¥ä¸ŠåŸå› ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥å‘ç°æœ‰åˆ—æ·»åŠ  `virtual` è¡¨è¾¾å¼ã€‚
    3. æ‚¨ä¸èƒ½æ›´æ”¹ç°æœ‰åˆ—ä¸­çš„ `stored` ç”Ÿæˆè¡¨è¾¾å¼ï¼Œç”±äºä»¥ä¸ŠåŸå› ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥æ›´æ”¹ `virtual` è¡¨è¾¾å¼ã€‚
    4. æ‚¨ä¸èƒ½å°†ç”Ÿæˆçº¦æŸç±»å‹ä» `virtual` æ›´æ”¹ä¸º `stored`ï¼Œç”±äºä»¥ä¸ŠåŸå› ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä» `stored` æ›´æ”¹ä¸º `virtual`ã€‚

   <CodeTabs items={["index.ts", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    export const users = sqliteTable("users", {
      id: int("id"),
      name: text("name"),
      storedGenerated: text("stored_gen").generatedAlwaysAs(
        (): SQL => sql`${users.name} || 'hello'`,
        { mode: "stored" }
      ),
      virtualGenerated: text("virtual_gen").generatedAlwaysAs(
        (): SQL => sql`${users.name} || 'hello'`,
        { mode: "virtual" }
      ),
    });
    ```
    ```sql
    CREATE TABLE `users` (
	    `id` integer,
	    `name` text,
	    `stored_gen` text GENERATED ALWAYS AS ("name" || 'hello') STORED,
	    `virtual_gen` text GENERATED ALWAYS AS ("name" || 'hello') VIRTUAL
    );
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  è¿›è¡Œä¸­
  </Tab>
<Tab>
    #### æ•°æ®åº“ç«¯
    **ç±»å‹**: `PERSISTED`, `VIRTUAL`

    **å·¥ä½œåŸç†**
    - é€šè¿‡è¡¨æ¶æ„ä¸­çš„è¡¨è¾¾å¼å®šä¹‰ã€‚
    - è™šæ‹Ÿåˆ—åœ¨è¯»å–æ“ä½œæ—¶è®¡ç®—ã€‚
    - æŒä¹…åˆ—åœ¨å†™å…¥æ“ä½œæ—¶è®¡ç®—å¹¶å­˜å‚¨ã€‚

    æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [MSSQL](https://learn.microsoft.com/en-us/sql/relational-databases/tables/specify-computed-columns-in-a-table?view=sql-server-ver17) æ–‡æ¡£

    #### Drizzle ç«¯

    #### ç‰¹æ€§ 

    **`string`**
    <CodeTab>
    ```ts
    export const test = mssqlTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(`hello world!`),
    });
    ```
    ```sql
    CREATE TABLE [test] (
	    [gen_name] AS ('hello world!') VIRTUAL
    );
    ```
    </CodeTab>

    **`sql`** æ ‡ç­¾ - å¦‚æœæ‚¨å¸Œæœ› Drizzle ä¸ºæ‚¨è½¬ä¹‰ä¸€äº›å€¼

    <CodeTab>
    ```ts
    export const test = mssqlTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(sql`hello "world"!`),
    });
    ```
    ```sql
    CREATE TABLE [test] (
	    [gen_name] AS ('hello "world"!') VIRTUAL
    );
    ```
    </CodeTab>

    **`callback`** - å¦‚æœæ‚¨éœ€è¦å¼•ç”¨è¡¨ä¸­çš„åˆ—

    <CodeTab>
    ```ts
    export const test = mssqlTable("test", {
        name: text("first_name"),
        generatedName: text("gen_name").generatedAlwaysAs(
          (): SQL => sql`hi, ${test.name}!`
        ),
    });
    ```
    ```sql
    CREATE TABLE [test] (
    	[first_name] text,
    	[gen_name] AS ('hi, [test].[first_name]!') VIRTUAL
    );
    ```
    </CodeTab>
  </Tab>
  <Tab>
    åœ¨ Drizzle ä¸­ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•åˆ—ç±»å‹ä¸ŠæŒ‡å®š `.generatedAlwaysAs()` å‡½æ•°ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ”¯æŒçš„ SQL æŸ¥è¯¢ï¼Œ
    è¿™å°†ä¸ºä½ ç”Ÿæˆè¯¥åˆ—çš„æ•°æ®ã€‚

    #### ç‰¹æ€§ 
    æ­¤å‡½æ•°å¯ä»¥ä»¥ä¸‰ç§æ–¹å¼æ¥å—ç”Ÿæˆè¡¨è¾¾å¼ï¼š

    **`string`**
    <CodeTab>
    ```ts
    export const test = cockroachTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(`hello world!`),
    });
    ```
    ```sql
    CREATE TABLE "test" (
	    "gen_name" text GENERATED ALWAYS AS (hello world!) STORED
    );
    ```
    </CodeTab>

    **`sql`** æ ‡ç­¾ - å¦‚æœæ‚¨å¸Œæœ› Drizzle ä¸ºæ‚¨è½¬ä¹‰ä¸€äº›å€¼

    <CodeTab>
    ```ts
    export const test = cockroachTable("test", {
        generatedName: text("gen_name").generatedAlwaysAs(sql`hello "world"!`),
    });
    ```
    ```sql
    CREATE TABLE "test" (
	    "gen_name" text GENERATED ALWAYS AS (hello "world"!) STORED
    );
    ```
    </CodeTab>

    **`callback`** - å¦‚æœæ‚¨éœ€è¦å¼•ç”¨è¡¨ä¸­çš„åˆ—
    <CodeTab>
    ```ts
    export const test = cockroachTable("test", {
        name: text("first_name"),
        generatedName: text("gen_name").generatedAlwaysAs(
          (): SQL => sql`hi, ${test.name}!`
        ),
    });
    ```
    ```sql
    CREATE TABLE "test" (
	    "first_name" text,
	    "gen_name" text GENERATED ALWAYS AS (hi, "test"."first_name"!) STORED
    );
    ```
    </CodeTab>

    **ç¤ºä¾‹** ç”Ÿæˆåˆ—ä¸å…¨æ–‡æœç´¢
   <CodeTabs items={["schema.ts"]}>
	<CodeTab>
	```typescript copy {17-19}
    import { SQL, sql } from "drizzle-orm";
    import { customType, index, int4, cockroachTable, text } from "drizzle-orm/cockroach-core";

    const tsVector = customType<{ data: string }>({
      dataType() {
        return "tsvector";
      },
    });

    export const test = cockroachTable(
      "test",
      {
        id: int4().primaryKey().generatedAlwaysAsIdentity(),
        content: text("content"),
        contentSearch: tsVector("content_search", {
          dimensions: 3,
        }).generatedAlwaysAs(
          (): SQL => sql`to_tsvector('english', ${test.content})`
        ),
      },
      (t) => [
        index("idx_content_search").using("gin", t.contentSearch)
      ]
    );
    ```
    ```sql {4}
    CREATE TABLE "test" (
    	"id" integer PRIMARY KEY GENERATED ALWAYS AS IDENTITY (sequence name "test_id_seq" INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START WITH 1 CACHE 1),
    	"content" text,
    	"content_search" "tsvector" GENERATED ALWAYS AS (to_tsvector('english', "test"."content")) STORED
    );
    --> statement-breakpoint
    CREATE INDEX "idx_content_search" ON "test" USING gin ("content_search");
    ```
    </CodeTab>
   </CodeTabs>
  </Tab> 
</Tabs>


Source: https://drizzle.zhcndoc.com/docs/get-started-cockroach

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> PostgreSQL

<Callout type='error'>
æœ¬é¡µé¢ä»‹ç»çš„æ¦‚å¿µé€‚ç”¨äº Drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠä»¥ä¸Šã€‚
</Callout>

<br/>

<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- node-postgres çš„[åŸºç¡€çŸ¥è¯†](https://node-postgres.com/)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `node-postgres` é©±åŠ¨çš„ PostgreSQL è¿æ¥ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm@beta pg
-D drizzle-kit@beta @types/pg
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
<CodeTabs items={["node-postgres", "å¸¦é…ç½®çš„ node-postgres"]}>
```typescript copy
// è¯·ç¡®ä¿å®‰è£…äº† 'pg' åŒ… 
import { drizzle } from 'drizzle-orm/cockroach';

const db = drizzle(process.env.DATABASE_URL);
 
const result = await db.execute('select 1');
```
```typescript copy
// è¯·ç¡®ä¿å®‰è£…äº† 'pg' åŒ… 
import { drizzle } from 'drizzle-orm/cockroach';

// ä½ å¯ä»¥æŒ‡å®š node-postgres è¿æ¥é€‰é¡¹ä¸­çš„ä»»æ„å±æ€§
const db = drizzle({ 
  connection: { 
    connectionString: process.env.DATABASE_URL,
    ssl: true
  }
});
 
const result = await db.execute('select 1');
```
</CodeTabs>

å¦‚æœä½ éœ€è¦ä¼ å…¥å·²æœ‰çš„é©±åŠ¨ï¼š

```typescript copy
// è¯·ç¡®ä¿å®‰è£…äº† 'pg' åŒ… 
import { drizzle } from "drizzle-orm/cockroach";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });
 
const result = await db.execute('select 1');
```

#### æ¥ä¸‹æ¥æ€ä¹ˆåšï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/get-started-gel

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> Gel
<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- gel-js çš„[åŸºç¡€](https://github.com/geldata/gel-js)
</Prerequisites>

Drizzle å¯¹ `gel-js` å®¢æˆ·ç«¯çš„ Gel è¿æ¥æä¾›äº†åŸç”Ÿæ”¯æŒã€‚

#### ç¬¬ 1 æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm gel
-D drizzle-kit
</Npm>

#### ç¬¬ 2 æ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
<CodeTabs items={["gel", "å¸¦é…ç½®çš„ gel"]}>
```typescript copy
// ç¡®ä¿å·²å®‰è£… 'gel' åŒ…
import { drizzle } from 'drizzle-orm/gel';

const db = drizzle(process.env.DATABASE_URL);
 
const result = await db.execute('select 1');
```
```typescript copy
// ç¡®ä¿å·²å®‰è£… 'gel' åŒ…
import { drizzle } from "drizzle-orm/gel";

// å¯ä»¥æŒ‡å®š gel è¿æ¥é€‰é¡¹ä¸­çš„ä»»æ„å±æ€§
const db = drizzle({
  connection: {
    dsn: process.env.DATABASE_URL,
    tlsSecurity: "default",
  },
});

const result = await db.execute("select 1");
```
</CodeTabs>

å¦‚æœéœ€è¦æä¾›å·²æœ‰çš„é©±åŠ¨ï¼š

```typescript copy
// ç¡®ä¿å·²å®‰è£… 'gel' åŒ… 
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";

const gelClient = createClient();
const db = drizzle({ client: gelClient });

const result = await db.execute('select 1');
```

#### ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/get-started-mssql

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextMSSQL from "@mdx/WhatsNextMSSQL.astro";

# Drizzle \<\> MSSQL

<Callout type='error'>
æœ¬é¡µè®²è§£çš„æ¦‚å¿µé€‚ç”¨äº Drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠä»¥ä¸Šç‰ˆæœ¬ã€‚
</Callout>

<br/>

<Prerequisites>
- ä½¿ç”¨ Drizzle è¿›è¡Œæ•°æ®åº“[è¿æ¥åŸºç¡€](/docs/connect-overview)
- node-mssql çš„[åŸºç¡€çŸ¥è¯†](https://github.com/tediousjs/node-mssql)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒåŸºäº `mssql` é©±åŠ¨çš„ MSSQL è¿æ¥ã€‚

#### ç¬¬1æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm@beta mssql
-D drizzle-kit@beta
</Npm>

#### ç¬¬2æ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
<CodeTabs items={["mssql", "å¸¦é…ç½®çš„ mssql"]}>
```typescript copy
// ç¡®ä¿å·²å®‰è£… 'mssql' åŒ…
import { drizzle } from 'drizzle-orm/node-mssql';

const db = drizzle(process.env.DATABASE_URL);
 
const result = await db.execute('select 1');
```
```typescript copy
// ç¡®ä¿å·²å®‰è£… 'pg' åŒ…
import { drizzle } from 'drizzle-orm/node-mssql';

// ä½ å¯ä»¥æŒ‡å®š mssql è¿æ¥é€‰é¡¹ä¸­çš„ä»»æ„å±æ€§
const db = drizzle({ 
  connection: { 
    connectionString: process.env.DATABASE_URL,
    ssl: true
  }
});
 
const result = await db.execute('select 1');
```
</CodeTabs>

<Callout type='warning'>
ç”±äº `node-mssql` é©±åŠ¨åœ¨åˆå§‹åŒ– `Pool` æ—¶éœ€è¦ `await`ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è¯·æ±‚å‰å¯¹å…¶è¿›è¡Œ `await` â€”â€” é™¤éä½ ä¸º Drizzle æä¾›äº†è‡ªå·±çš„ Pool å®ä¾‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ä½ æƒ³è®¿é—® `db.$client` æ—¶ï¼Œéœ€è¦å…ˆ `await` å®ƒï¼Œç„¶åå†ä½¿ç”¨å®ƒï¼š

```ts
const awaitedClient = await db.$client;
const response = awaitedClient.query...
```
</Callout>

å¦‚æœä½ éœ€è¦æä¾›ä½ å·²æœ‰çš„é©±åŠ¨ï¼š

```typescript copy
// ç¡®ä¿å·²å®‰è£… 'mssql' åŒ…
import { drizzle } from "drizzle-orm/node-mssql";
import type { ConnectionPool } from 'mssql';

const pool = await mssql.connect(connectionString);
const db = drizzle({ client: pool });
 
const result = await db.execute('select 1');
```

#### ä¸‹ä¸€æ­¥ï¼Ÿ

<WhatsNextMSSQL/>

Source: https://drizzle.zhcndoc.com/docs/get-started-mysql

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> MySQL

è¦åœ¨ MySQL æ•°æ®åº“ä¸­ä½¿ç”¨ Drizzleï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ `mysql2` é©±åŠ¨ç¨‹åºã€‚

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://github.com/sidorares/node-mysql2)**ï¼Œ 
`mysql2` æ˜¯ä¸€ä¸ªä¸“æ³¨äºæ€§èƒ½çš„ Node.js MySQL å®¢æˆ·ç«¯ã€‚

Drizzle ORM åŸç”Ÿæ”¯æŒ `mysql2`ï¼Œä½¿ç”¨ `drizzle-orm/mysql2` åŒ…ã€‚

#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm mysql2
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶è¿›è¡ŒæŸ¥è¯¢
<CodeTabs items={['mysql2', 'mysql with config']}>
```typescript copy
import { drizzle } from "drizzle-orm/mysql2";

const db = drizzle(process.env.DATABASE_URL);

const response = await db.select().from(...)
```
```typescript copy
import { drizzle } from "drizzle-orm/mysql2";

// æ‚¨å¯ä»¥æŒ‡å®š mysql2 è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db = drizzle({ connection:{ uri: process.env.DATABASE_URL }});

const response = await db.select().from(...)
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

<CodeTabs items={['Client connection', 'Pool connection']}>
  ```typescript copy
  import { drizzle } from "drizzle-orm/mysql2";
  import mysql from "mysql2/promise";

  const connection = await mysql.createConnection({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle({ client: connection });
  ```
  ```typescript copy
  import { drizzle } from "drizzle-orm/mysql2";
  import mysql from "mysql2/promise";

  const poolConnection = mysql.createPool({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle({ client: poolConnection });
  ```
</CodeTabs>

<Callout type="warning" emoji="âš™ï¸">
  å¯¹äºå†…ç½®çš„ `migrate` å‡½æ•°ä»¥åŠ DDL è¿ç§»ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨ä½¿ç”¨å•ä¸ª `client` è¿æ¥ã€‚

  å¯¹äºæŸ¥è¯¢ç›®çš„ï¼Œå¯ä»¥æ ¹æ®æ‚¨çš„ä¸šåŠ¡éœ€æ±‚ä½¿ç”¨ `client` æˆ– `pool`ã€‚
</Callout>

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/get-started-postgresql

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> PostgreSQL
<Prerequisites>
- ä½¿ç”¨ Drizzle çš„æ•°æ®åº“ [è¿æ¥åŸºç¡€](https://docs/connect-overview)
- node-postgres [åŸºç¡€](https://node-postgres.com/)
- postgres.js [åŸºç¡€](https://github.com/porsager/postgres?tab=readme-ov-file#usage)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `node-postgres` å’Œ `postgres.js` é©±åŠ¨ç¨‹åºè¿æ¥ PostgreSQLã€‚

åœ¨æˆ‘ä»¬ä½¿ç”¨è¿™ä¸¤è€…å¹¶å°†å®ƒä»¬ä¸ Drizzle ORM é›†æˆæ—¶ï¼Œå‘ç°äº†å®ƒä»¬ä¹‹é—´çš„ä¸€äº›å·®å¼‚ã€‚ä¾‹å¦‚ï¼š

- ä½¿ç”¨ `node-postgres`ï¼Œæ‚¨å¯ä»¥å®‰è£… `pg-native`ï¼Œå°† `node-postgres` å’Œ Drizzle çš„é€Ÿåº¦æé«˜çº¦ 10%ã€‚
- `node-postgres` æ”¯æŒæŒ‰æŸ¥è¯¢æä¾›ç±»å‹è§£æå™¨ï¼Œè€Œæ— éœ€å…¨å±€ä¿®æ”¹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [ç±»å‹æ–‡æ¡£](https://node-postgres.com/features/queries#types)ã€‚
- `postgres.js` é»˜è®¤ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼Œæ‚¨å¯èƒ½éœ€è¦é€‰æ‹©ä¸ä½¿ç”¨ã€‚åœ¨ AWS ç¯å¢ƒç­‰ä¸­ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨é—®é¢˜ï¼Œå› æ­¤è¯·è®°ä½è¿™ä¸€ç‚¹ã€‚
- å¦‚æœæ‚¨æœ‰å…¶ä»–æƒ³è¦è´¡çŒ®çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¬¢è¿æ‚¨åœ¨ [è¿™é‡Œ](https://github.com/drizzle-team/drizzle-orm-docs/pulls)æäº¤ PRã€‚

## node-postgres
#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm pg
-D drizzle-kit @types/pg
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨ç¨‹åºå¹¶è¿›è¡ŒæŸ¥è¯¢
<CodeTabs items={["node-postgres", "node-postgres with config"]}>
```typescript copy
// ç¡®ä¿å®‰è£… 'pg' åŒ… 
import { drizzle } from 'drizzle-orm/node-postgres';

const db = drizzle(process.env.DATABASE_URL);
 
const result = await db.execute('select 1');
```
```typescript copy
// ç¡®ä¿å®‰è£… 'pg' åŒ… 
import { drizzle } from 'drizzle-orm/node-postgres';

// æ‚¨å¯ä»¥æŒ‡å®š node-postgres è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db = drizzle({ 
  connection: { 
    connectionString: process.env.DATABASE_URL,
    ssl: true
  }
});
 
const result = await db.execute('select 1');
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy
// ç¡®ä¿å®‰è£… 'pg' åŒ… 
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle({ client: pool });
 
const result = await db.execute('select 1');
```

## postgres.js
#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm postgres
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨ç¨‹åºå¹¶è¿›è¡ŒæŸ¥è¯¢
<CodeTabs items={["postgres.js", "postgres.js with config"]}>
```typescript copy
import { drizzle } from 'drizzle-orm/postgres-js';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');
```
```typescript copy
import { drizzle } from 'drizzle-orm/postgres-js';

// æ‚¨å¯ä»¥æŒ‡å®š postgres-js è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db = drizzle({ 
  connection: { 
    url: process.env.DATABASE_URL, 
    ssl: true 
  }
});

const result = await db.execute('select 1');
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy
// ç¡®ä¿å®‰è£… 'postgres' åŒ…
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const queryClient = postgres(process.env.DATABASE_URL);
const db = drizzle({ client: queryClient });

const result = await db.execute('select 1');
```

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/get-started-singlestore

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";

# Drizzle \<\> SingleStore

è¦åœ¨ SingleStore æ•°æ®åº“ä¸­ä½¿ç”¨ Drizzleï¼Œåº”è¯¥ä½¿ç”¨ `mysql2` é©±åŠ¨ã€‚

Drizzle ORM ä½¿ç”¨ `drizzle-orm/singlestore` åŒ…åŸç”Ÿæ”¯æŒ `mysql2`ã€‚

#### ç¬¬ 1 æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm mysql2
-D drizzle-kit
</Npm>

#### ç¬¬ 2 æ­¥ - åˆå§‹åŒ–é©±åŠ¨å¹¶æ‰§è¡ŒæŸ¥è¯¢
<CodeTabs items={['mysql2', 'å«é…ç½®çš„ mysql']}>
```typescript copy
import { drizzle } from "drizzle-orm/singlestore";

const db = drizzle(process.env.DATABASE_URL);

const response = await db.select().from(...)
```
```typescript copy
import { drizzle } from "drizzle-orm/singlestore";

// ä½ å¯ä»¥æŒ‡å®šæ¥è‡ª mysql2 è¿æ¥é€‰é¡¹çš„ä»»ä½•å±æ€§
const db = drizzle({ connection:{ uri: process.env.DATABASE_URL }});

const response = await db.select().from(...)
```
</CodeTabs>

å¦‚æœéœ€è¦æä¾›ä½ ç°æœ‰çš„é©±åŠ¨ï¼š

<CodeTabs items={['å®¢æˆ·ç«¯è¿æ¥', 'è¿æ¥æ± è¿æ¥']}>
  ```typescript copy
  import { drizzle } from "drizzle-orm/singlestore";
  import mysql from "mysql2/promise";

  const connection = await mysql.createConnection({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle({ client: connection });
  ```
  ```typescript copy
  import { drizzle } from "drizzle-orm/singlestore";
  import mysql from "mysql2/promise";

  const poolConnection = mysql.createPool({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle({ client: poolConnection });
  ```
</CodeTabs>

<Callout type="warning" emoji="âš™ï¸">
  å¯¹äºå†…ç½®å¸¦æœ‰ DDL è¿ç§»çš„ `migrate` åŠŸèƒ½ï¼Œæˆ‘ä»¬å’Œé©±åŠ¨å¼ºçƒˆå»ºè®®ä½ ä½¿ç”¨å•ä¸€çš„ `client` è¿æ¥ã€‚

  é’ˆå¯¹æŸ¥è¯¢ç”¨é€”ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è‡ªç”±é€‰æ‹©ä½¿ç”¨ `client` æˆ– `pool`ã€‚
</Callout>

#### é™åˆ¶

å½“å‰ï¼ŒSingleStore æ–¹è¨€å­˜åœ¨ä¸€ç³»åˆ—é™åˆ¶å’Œç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§åœ¨ SingleStore æ•°æ®åº“ç«¯ä¸å¯ç”¨ï¼š

- SingleStore çš„ serial åˆ—ç±»å‹åªä¿è¯åˆ—å€¼çš„å”¯ä¸€æ€§ã€‚
- `ORDER BY` å’Œ `LIMIT` ä¸èƒ½è¿é”ä½¿ç”¨ã€‚
- ä¸æ”¯æŒå¤–é”®ï¼ˆæ­£åœ¨æ£€æŸ¥ä¸­ï¼‰ã€‚
- SingleStore ä¸æ”¯æŒ `INTERSECT ALL` å’Œ `EXCEPT ALL` æ“ä½œã€‚
- SingleStore ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡ï¼ˆè¯¦è§[å®˜æ–¹æ–‡æ¡£](https://docs.singlestore.com/cloud/reference/sql-reference/procedural-sql-reference/transactions-in-stored-procedures/)ï¼‰ã€‚
- SingleStore [åªæ”¯æŒ](https://docs.singlestore.com/cloud/getting-started-with-singlestore-helios/about-singlestore-helios/singlestore-helios-faqs/durability/)ä¸€ä¸ª `isolationLevel`ã€‚
- `DATE`ã€`TIMESTAMP` å’Œ `DATETIME` ç±»å‹ä¸­çš„ FSP é€‰é¡¹ä¸è¢«æ”¯æŒã€‚
- å…³ç³»å‹ API ä¸è¢«æ”¯æŒï¼Œå¾… SingleStore å›¢é˜Ÿå¼€å‘å®Œæ‰€æœ‰å¿…éœ€çš„ç›¸å…³ API åå°†å®ç°ã€‚
- ç”±äº SingleStore ä¸ MySQL å¹¶é 100% å…¼å®¹ï¼Œå¯èƒ½å­˜åœ¨æ›´å¤šé™åˆ¶ã€‚

#### æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>

Source: https://drizzle.zhcndoc.com/docs/get-started-sqlite

import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Steps from '@mdx/Steps.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import LibsqlTable from '@mdx/LibsqlTable.mdx';
import LibsqlTabs from '@mdx/LibsqlTabs.mdx';

# Drizzle \<\> SQLite

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `libsql` å’Œ `better-sqlite3` é©±åŠ¨ç¨‹åºè¿æ¥ SQLiteã€‚

åœ¨ä½¿ç”¨è¿™ä¸¤ç§é©±åŠ¨ç¨‹åºå¹¶å°†å…¶ä¸ Drizzle ORM é›†æˆæ—¶ï¼Œæˆ‘ä»¬å‘ç°å®ƒä»¬ä¹‹é—´æœ‰ä¸€äº›å·®å¼‚ã€‚ä¾‹å¦‚ï¼š

åœ¨é©±åŠ¨ç¨‹åºå±‚é¢ï¼Œè¿™ä¸¤è€…ä¹‹é—´å¯èƒ½æ²¡æœ‰å¤ªå¤šå·®å¼‚ï¼Œä½†ä¸»è¦çš„åŒºåˆ«åœ¨äº `libSQL` å¯ä»¥è¿æ¥åˆ° SQLite æ–‡ä»¶å’Œ `Turso` è¿œç¨‹æ•°æ®åº“ã€‚LibSQL æ˜¯ SQLite çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œæä¾›äº†æ¯”æ ‡å‡† SQLite æ›´å¤šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

- `libSQL` é©±åŠ¨ç¨‹åºæ”¯æŒæ›´å¤šçš„ ALTER è¯­å¥ï¼Œä½¿æ‚¨èƒ½å¤Ÿæ¯”ä»…ä½¿ç”¨ `better-sqlite3` æ›´è½»æ¾åœ°ç®¡ç†æ‚¨çš„æ¨¡å¼ã€‚
- æ‚¨å¯ä»¥åŸç”Ÿé…ç½®é™æ€åŠ å¯†åŠŸèƒ½ã€‚
- `libSQL` è¿˜æ”¯æŒ SQLite æ•°æ®åº“æ”¯æŒçš„å¤§é‡æ‰©å±•ã€‚

## libsql
#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm @libsql/client
-D drizzle-kit
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨ç¨‹åºå¹¶æ‰§è¡ŒæŸ¥è¯¢
Drizzle åŸç”Ÿæ”¯æŒæ‰€æœ‰ @libsql/client é©±åŠ¨ç¨‹åºå˜ä½“ï¼š

<LibsqlTable />
<br/>
<LibsqlTabs />

#### Step 3 - make a query
<CodeTabs items={["libsql", "libsql with config"]}>
```typescript copy
import { drizzle } from 'drizzle-orm/libsql';

const db = drizzle(process.env.DATABASE_URL);
 
const result = await db.execute('select 1');
```
```typescript copy
import { drizzle } from 'drizzle-orm/libsql';

// æ‚¨å¯ä»¥æŒ‡å®š libsql è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db = drizzle({ connection: { url:'', authToken: '' }});
 
const result = await db.execute('select 1');
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦åŒæ­¥è¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„é¢å¤–è¿æ¥ APIï¼Œ
åœ¨è¯¥ API ä¸­æ‚¨æŒ‡å®šé©±åŠ¨ç¨‹åºè¿æ¥å¹¶å°†å…¶ä¼ é€’ç»™ Drizzle å®ä¾‹ã€‚

```typescript copy
import { drizzle } from 'drizzle-orm/libsql';
import { createClient } from '@libsql/client';

const client = createClient({ url: process.env.DATABASE_URL, authToken: process.env.DATABASE_AUTH_TOKEN });
const db = drizzle(client);

const result = await db.execute('select 1');
```

## better-sqlite3
#### ç¬¬ä¸€æ­¥ - å®‰è£…åŒ…
<Npm>
drizzle-orm better-sqlite3
-D drizzle-kit @types/better-sqlite3
</Npm>

#### ç¬¬äºŒæ­¥ - åˆå§‹åŒ–é©±åŠ¨ç¨‹åºå¹¶æ‰§è¡ŒæŸ¥è¯¢
<CodeTabs items={["better-sqlite3", "better-sqlite3 with config"]}>
```typescript copy
import { drizzle } from 'drizzle-orm/better-sqlite3';

const db = drizzle(process.env.DATABASE_URL);

const result = await db.execute('select 1');
```
```typescript copy
import { drizzle } from 'drizzle-orm/better-sqlite3';

// æ‚¨å¯ä»¥æŒ‡å®š better-sqlite3 è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db =  drizzle({ connection: { source: process.env.DATABASE_URL }});

const result = await db.execute('select 1');
```
</CodeTabs>

å¦‚æœæ‚¨éœ€è¦æä¾›ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š
```typescript copy
import { drizzle } from 'drizzle-orm/better-sqlite3';
import Database from 'better-sqlite3';

const sqlite = new Database('sqlite.db');
const db = drizzle({ client: sqlite });

const result = await db.execute('select 1');
```

#### ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

<WhatsNextPostgres/>


Source: https://drizzle.zhcndoc.com/docs/get-started

import Callout from '@mdx/Callout.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import YoutubeCards from '@mdx/YoutubeCards.astro';
import GetStartedLinks from '@mdx/GetStartedLinks/index.astro';

# å¼€å§‹ä½¿ç”¨ Drizzle
<GetStartedLinks />

Source: https://drizzle.zhcndoc.com/docs/get-started/bun-sql-existing

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import ConnectBun from '@mdx/get-started/postgresql/ConnectBun.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ SQLite

<Prerequisites>  
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **bun** - JavaScript ä¸€ä½“åŒ–å·¥å…·åŒ… - [é˜…è¯»è¿™é‡Œ](https://bun.zhcndoc.com/)
  - **Bun SQL** - ç”¨äºå¤„ç† PostgreSQL æ•°æ®åº“çš„åŸç”Ÿç»‘å®š - [é˜…è¯»è¿™é‡Œ](https://bun.zhcndoc.com/runtime/sql)
</Prerequisites>

<Callout type='error'>
åœ¨ç‰ˆæœ¬ `1.2.0` ä¸­ï¼ŒBun åœ¨æ‰§è¡Œå¹¶å‘è¯­å¥æ—¶å­˜åœ¨é—®é¢˜ï¼Œå¦‚æœæ‚¨å°è¯•åŒæ—¶è¿è¡Œå¤šä¸ªæŸ¥è¯¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ã€‚
æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª [github é—®é¢˜](https://github.com/oven-sh/bun/issues/16774)ï¼Œæ‚¨å¯ä»¥è·Ÿè¸ªã€‚ä¸€æ—¦ä¿®å¤ï¼Œæ‚¨åœ¨ Bun çš„ SQL æ–¹é¢å°†ä¸å†é‡åˆ°æ­¤ç±»é”™è¯¯ã€‚
</Callout>

<FileStructure />

#### æ­¥éª¤ 1 - å®‰è£…æ‰€éœ€çš„åŒ…

<Npm>
  drizzle-orm dotenv
  -D drizzle-kit @types/bun
</Npm>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### æ­¥éª¤ 3 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 4 - åæ€ä½ çš„æ•°æ®åº“

<IntrospectPostgreSQL/>

#### æ­¥éª¤ 5 - å°†ä»£ç è½¬ç§»åˆ°æ‚¨çš„å®é™…æ¨¡å¼æ–‡ä»¶ä¸­

<TransferCode/>

#### æ­¥éª¤ 6 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectBun/>

#### æ­¥éª¤ 7 - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='bun-sql' env_variable='DATABASE_URL' />

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

è¦ä½¿ç”¨ `bun` è¿è¡Œè„šæœ¬ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash copy
bun src/index.ts
```

#### æ­¥éª¤ 9 - æ›´æ–°æ‚¨çš„è¡¨æ¶æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### æ­¥éª¤ 9 - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### æ­¥éª¤ 10 - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='bun-sql' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/bun-sql-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx';
import ConnectBun from '@mdx/get-started/postgresql/ConnectBun.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Bun:SQLite

<Prerequisites>  
  - **bun** - javaScript ä¸€ä½“åŒ–å·¥å…·åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://bun.zhcndoc.com/)
  - **Bun SQL** - ç”¨äºä¸ PostgreSQL æ•°æ®åº“è¿›è¡Œäº¤äº’çš„æœ¬æœºç»‘å®š - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://bun.zhcndoc.com/runtime/sql)
</Prerequisites>

<Callout type='error'>
åœ¨ç‰ˆæœ¬ `1.2.0` ä¸­ï¼ŒBun åœ¨æ‰§è¡Œå¹¶å‘è¯­å¥æ—¶å­˜åœ¨é—®é¢˜ï¼Œå¦‚æœæ‚¨å°è¯•åŒæ—¶è¿è¡Œå¤šä¸ªæŸ¥è¯¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ã€‚
æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª [github é—®é¢˜](https://github.com/oven-sh/bun/issues/16774) ä¾›æ‚¨è·Ÿè¸ªã€‚ä¸€æ—¦ä¿®å¤ï¼Œæ‚¨åº”è¯¥ä¸å†åœ¨ Bun çš„ SQL æ–¹é¢é‡åˆ°æ­¤ç±»é”™è¯¯ã€‚
</Callout>

<FileStructure />

#### æ­¥éª¤ 1 - å®‰è£…æ‰€éœ€çš„è½¯ä»¶åŒ…
<Npm>
  drizzle-orm
  -D drizzle-kit @types/bun
</Npm>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectBun/>

#### æ­¥éª¤ 4 - åˆ›å»ºè¡¨æ ¼

<CreateTable/>

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - åˆå§‹åŒ–å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='bun-sql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

è¦ä½¿ç”¨ `bun` è¿è¡Œè„šæœ¬ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash copy
bun src/index.ts
```

Source: https://drizzle.zhcndoc.com/docs/get-started/bun-sqlite-existing

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import IntrospectSqlite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import ConnectBun from '@mdx/get-started/sqlite/ConnectBun.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ Bun:SQLite å…¥é—¨

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://tsx.is/)
  - **bun** - ä¸€ä½“åŒ– JavaScript å·¥å…·åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://bun.zhcndoc.com/)
  - **bun:sqlite** - é«˜æ€§èƒ½ SQLite3 é©±åŠ¨çš„åŸç”Ÿå®ç° - [åœ¨è¿™é‡Œé˜…è¯»](https://bun.zhcndoc.com/runtime/sqlite)
</Prerequisites>

<FileStructure />

#### ç¬¬ä¸€æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…

<Npm>
  drizzle-orm dotenv
  -D drizzle-kit tsx @types/bun
</Npm>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DB_FILE_NAME' />

<Callout type='info' title='é‡è¦'>
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„é¡¹ç›®æ ¹ç›®å½•ä¸­æœ‰ä¸€ä¸ª SQLite æ•°æ®åº“æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç¤ºä¾‹ï¼š
```plaintext copy
DB_FILE_NAME=mydb.sqlite
```
</Callout>


#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='DB_FILE_NAME'/>

#### ç¬¬å››æ­¥ - å¯¹æ‚¨çš„æ•°æ®åº“è¿›è¡Œè‡ªçœ

<IntrospectSqlite/>

#### ç¬¬äº”æ­¥ - å°†ä»£ç è½¬ç§»åˆ°æ‚¨çš„å®é™…æ¶æ„æ–‡ä»¶ä¸­

<TransferCode/>

#### ç¬¬å…­æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectBun/>

#### ç¬¬ä¸ƒæ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='bun-sqlite' env_variable='DB_FILE_NAME' />

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

è¦ä½¿ç”¨ `bun` è¿è¡Œè„šæœ¬ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash copy
bun src/index.ts
```

#### ç¬¬ä¹æ­¥ - æ›´æ–°æ‚¨çš„è¡¨æ¶æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ä¹æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### ç¬¬åæ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='bun-sqlite' env_variable='DB_FILE_NAME' />

Source: https://drizzle.zhcndoc.com/docs/get-started/bun-sqlite-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectBun from '@mdx/get-started/sqlite/ConnectBun.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Bun:SQLite å…¥é—¨

<Prerequisites>  
  - **bun** - JavaScript ä¸€ä½“åŒ–å·¥å…·åŒ… - [ç‚¹å‡»é˜…è¯»](https://bun.zhcndoc.com/)
  - **bun:sqlite** - é«˜æ€§èƒ½ SQLite3 é©±åŠ¨çš„åŸç”Ÿå®ç° - [ç‚¹å‡»é˜…è¯»](https://bun.zhcndoc.com/runtime/sqlite)
</Prerequisites>

<FileStructure />

#### æ­¥éª¤ 1 - å®‰è£…æ‰€éœ€çš„åŒ…
<Npm>
  drizzle-orm
  -D drizzle-kit @types/bun
</Npm>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DB_FILE_NAME' />

<Callout type='info' title='é‡è¦'>
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª SQLite æ•°æ®åº“æ–‡ä»¶ä»¥è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç¤ºä¾‹ï¼š
```plaintext copy
DB_FILE_NAME=mydb.sqlite
```
</Callout>

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectBun/>

#### æ­¥éª¤ 4 - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='DB_FILE_NAME' />

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - ç”Ÿæˆå¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='bun-sqlite' env_variable='DB_FILE_NAME' />

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

è¦ä½¿ç”¨ `bun` è¿è¡Œè„šæœ¬ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash copy
bun src/index.ts
```

Source: https://drizzle.zhcndoc.com/docs/get-started/cockroach-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectCockroach from '@mdx/get-started/cockroach/IntrospectCockroach.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectCockroach from '@mdx/get-started/cockroach/ConnectCockroach.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/cockroach/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ CockroachDB å…¥é—¨

<Callout type='error'>
æœ¬é¡µé¢è§£é‡Šçš„æ˜¯åœ¨ drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠæ›´é«˜ç‰ˆæœ¬ä¸­å¯ç”¨çš„æ¦‚å¿µã€‚
</Callout>

<br/>

<Prerequisites>
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **node-postgres** - ç”¨äºæŸ¥è¯¢ä½ çš„ PostgreSQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://node-postgres.com/)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **node-postgres** åŒ…
<Npm>
  drizzle-orm@beta pg dotenv
  -D drizzle-kit@beta tsx @types/pg
</Npm>


#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

<Callout title='æç¤º'>
å¦‚æœä½ è¿˜æ²¡æœ‰ PostgreSQL æ•°æ®åº“ï¼Œä¸”æƒ³åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ Docker ä¸­è®¾ç½® PostgreSQL çš„æŒ‡å—ã€‚

Docker ä¸­çš„ PostgreSQL æŒ‡å—è§ [è¿™é‡Œ](/docs/guides/postgresql-local-setup)ã€‚æŒ‰ç…§æŒ‡å—å®Œæˆè®¾ç½®å¹¶ç”Ÿæˆæ•°æ®åº“ URLï¼ˆæŒ‡å—ä¸­æœ‰è¯¦ç»†è¯´æ˜ï¼‰ï¼Œå®Œæˆåè¿”å›ç»§ç»­ä¸‹ä¸€æ­¥ã€‚
</Callout>

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='cockroach' env_variable='DATABASE_URL'/>

#### ç¬¬ 4 æ­¥ - åå‘å·¥ç¨‹ä½ çš„æ•°æ®åº“

<IntrospectCockroach/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°ä½ çš„å®é™… schema æ–‡ä»¶ä¸­

<TransferCode/>

#### ç¬¬ 6 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectCockroach/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='cockroach' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°ä½ çš„è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - åº”ç”¨æ›´æ”¹åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='cockroach' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/cockroach-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectCockroach from '@mdx/get-started/cockroach/ConnectCockroach.mdx'
import CreateTable from '@mdx/get-started/cockroach/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ CockroachDB å…¥é—¨

<Callout type='error'>
æ­¤é¡µé¢ä»‹ç»çš„æ¦‚å¿µé€‚ç”¨äº drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠæ›´é«˜ç‰ˆæœ¬ã€‚
</Callout>

<br/>

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **node-postgres** - è®¿é—® PostgreSQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://node-postgres.com/)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `node-postgres` å’Œ `postgres.js` é©±åŠ¨è¿æ¥ CockroachDBã€‚

æœ¬å…¥é—¨ç¤ºä¾‹å°†ä½¿ç”¨ `node-postgres`ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šè¿æ¥ PostgreSQL çš„æ–¹å¼ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [CockroachDB è¿æ¥](/docs/get-started-cockroach) é¡µé¢ã€‚

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **node-postgres** åŒ…
<Npm>
  drizzle-orm@beta pg dotenv
  -D drizzle-kit@beta tsx @types/pg
</Npm>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ 3 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectCockroach/>

#### ç¬¬ 4 æ­¥ - åˆ›å»ºæ•°æ®è¡¨

<CreateTable />

#### ç¬¬ 5 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='cockroach' env_variable='DATABASE_URL'/>

#### ç¬¬ 6 æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´

<ApplyChanges />

#### ç¬¬ 7 æ­¥ - å¡«å……å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='cockroach' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/d1-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectSQLite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectSQLiteCloud from '@mdx/get-started/sqlite/ConnectSQLiteCloud.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨å·²æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ D1 å¿«é€Ÿå…¥é—¨

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **Cloudflare D1** - Serverless SQL æ•°æ®åº“ï¼Œå¯ä¾›æ‚¨çš„ Workers å’Œ Pages é¡¹ç›®æŸ¥è¯¢ - [æŸ¥çœ‹è¿™é‡Œ](https://developers.cloudflare.com/d1/)
  - **wrangler** - Cloudflare å¼€å‘è€…å¹³å°å‘½ä»¤è¡Œå·¥å…· - [æŸ¥çœ‹è¿™é‡Œ](https://developers.cloudflare.com/workers/wrangler)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£…å¿…éœ€çš„åŒ…
<InstallPackages lib=''/>

#### ç¬¬ 2 æ­¥ - é…ç½® wrangler.toml

æ‚¨éœ€è¦ä¸º D1 æ•°æ®åº“åˆ›å»º `wrangler.toml` æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š

```toml
name = "YOUR PROJECT NAME"
main = "src/index.ts"
compatibility_date = "2022-11-07"
node_compat = true

[[ d1_databases ]]
binding = "DB"
database_name = "YOUR DB NAME"
database_id = "YOUR DB ID"
migrations_dir = "drizzle"
```

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** æ˜¯ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'sqlite',
  driver: 'd1-http',
  dbCredentials: {
    accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
    databaseId: process.env.CLOUDFLARE_DATABASE_ID!,
    token: process.env.CLOUDFLARE_D1_TOKEN!,
  },
});
```
<Callout title='æç¤º'>
æ‚¨å¯ä»¥æŸ¥çœ‹[æˆ‘ä»¬çš„æ•™ç¨‹](/docs/guides/d1-http-with-drizzle-kit)ï¼Œäº†è§£å¦‚ä½•ä» Cloudflare è·å–ç¯å¢ƒå˜é‡
</Callout>

#### ç¬¬ 4 æ­¥ - åå‘è§£ææ•°æ®åº“

<IntrospectSQLite/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è¿ç§»åˆ°å®é™…çš„ schema æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

```typescript copy
import { drizzle } from 'drizzle-orm/d1';

export interface Env {
  <BINDING_NAME>: D1Database;
}
export default {
  async fetch(request: Request, env: Env) {
    const db = drizzle(env.<BINDING_NAME>);
  },
};
```

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy
import { drizzle } from 'drizzle-orm/d1';

export interface Env {
  <BINDING_NAME>: D1Database;
}
export default {
  async fetch(request: Request, env: Env) {
    const db = drizzle(env.<BINDING_NAME>);

    const user: typeof usersTable.$inferInsert = {
      name: 'John',
      age: 30,
      email: 'john@example.com',
    };

    await db.insert(usersTable).values(user);
    console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼');

    const users = await db.select().from(usersTable);
    console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users);
    /*
    const users: {
      id: number;
      name: string;
      age: number;
      email: string;
    }[]
    */

    await db
      .update(usersTable)
      .set({
        age: 31,
      })
      .where(eq(usersTable.email, user.email));
    console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼');

    await db.delete(usersTable).where(eq(usersTable.email, user.email));
    console.log('ç”¨æˆ·å·²åˆ é™¤ï¼');

    return Response.json(users);
  },
};
```

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/sqlite-cloud';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle(env.<BINDING_NAME>);

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼');

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users);
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼');

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼');

  return Response.json(users);
}

main();
```

Source: https://drizzle.zhcndoc.com/docs/get-started/d1-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryTurso from '@mdx/get-started/sqlite/QueryTurso.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ D1

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **Cloudflare D1** - ç”¨äºä»æ‚¨çš„ Workers å’Œ Pages é¡¹ç›®ä¸­æŸ¥è¯¢çš„æ— æœåŠ¡å™¨ SQL æ•°æ®åº“ - [æŸ¥çœ‹è¿™é‡Œ](https://developers.cloudflare.com/d1/)
  - **wrangler** - Cloudflare å¼€å‘è€…å¹³å°å‘½ä»¤è¡Œç•Œé¢ - [æŸ¥çœ‹è¿™é‡Œ](https://developers.cloudflare.com/workers/wrangler)
</Prerequisites>

<FileStructure />

#### ç¬¬ä¸€æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…
<InstallPackages lib='wrangler'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½® wrangler.toml

æ‚¨éœ€è¦ä¸€ä¸ª `wrangler.toml` æ–‡ä»¶ç”¨äº D1 æ•°æ®åº“ï¼Œå…¶å†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š
```toml
name = "æ‚¨çš„é¡¹ç›®åç§°"
main = "src/index.ts"
compatibility_date = "2022-11-07"
node_compat = true

[[ d1_databases ]]
binding = "DB"
database_name = "æ‚¨çš„æ•°æ®åº“åç§°"
database_id = "æ‚¨çš„æ•°æ®åº“ ID"
migrations_dir = "drizzle"
```

#### ç¬¬ä¸‰æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

```typescript copy
import { drizzle } from 'drizzle-orm/d1';

export interface Env {
  <BINDING_NAME>: D1Database;
}
export default {
  async fetch(request: Request, env: Env) {
    const db = drizzle(env.<BINDING_NAME>);
  },
};
```

#### ç¬¬å››æ­¥ - ç”Ÿæˆ wrangler ç±»å‹å®šä¹‰

<Npx>
wrangler types
</Npx>

<Callout>
è¯¥å‘½ä»¤çš„è¾“å‡ºå°†æ˜¯ä¸€ä¸ª `worker-configuration.d.ts` æ–‡ä»¶ã€‚
</Callout>

#### ç¬¬äº”æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### ç¬¬å…­æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªä¾› [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'sqlite',
  driver: 'd1-http',
  dbCredentials: {
    accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
    databaseId: process.env.CLOUDFLARE_DATABASE_ID!,
    token: process.env.CLOUDFLARE_D1_TOKEN!,
  },
});
```
<Callout title='æç¤º'>
æ‚¨å¯ä»¥æŸ¥çœ‹ [æˆ‘ä»¬çš„æ•™ç¨‹](/docs/guides/d1-http-with-drizzle-kit)ï¼Œäº†è§£å¦‚ä½•ä» CloudFlare è·å–ç¯å¢ƒå˜é‡
</Callout>

#### ç¬¬ä¸ƒæ­¥ - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

<ApplyChanges />

#### ç¬¬å…«æ­¥ - åˆå§‹åŒ–å¹¶æŸ¥è¯¢æ•°æ®åº“

```typescript copy
import { drizzle } from 'drizzle-orm/d1';

export interface Env {
  <BINDING_NAME>: D1Database;
}
export default {
  async fetch(request: Request, env: Env) {
    const db = drizzle(env.<BINDING_NAME>);
    const result = await db.select().from(users).all()
    return Response.json(result);
  },
};
```

#### ç¬¬ä¹æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/do-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectSQLite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectSQLiteCloud from '@mdx/get-started/sqlite/ConnectSQLiteCloud.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ SQLite Durable Objects å¿«é€Ÿå¼€å§‹

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://tsx.is/)
  - **Cloudflare SQLite Durable Objects** - åµŒå…¥åœ¨ Durable Object å†…çš„ SQLite æ•°æ®åº“ - [ç‚¹å‡»é˜…è¯»](https://developers.cloudflare.com/durable-objects/api/sql-storage/)
  - **wrangler** - Cloudflare å¼€å‘è€…å¹³å°å‘½ä»¤è¡Œå·¥å…· - [ç‚¹å‡»é˜…è¯»](https://developers.cloudflare.com/workers/wrangler)
</Prerequisites>

<FileStructure/>

#### ç¬¬1æ­¥ - å®‰è£…æ‰€éœ€åŒ…
<InstallPackages lib=''/>

#### ç¬¬2æ­¥ - é…ç½® wrangler.toml

ä½ éœ€è¦ä¸€ä¸ªé…ç½® D1 æ•°æ®åº“çš„ `wrangler.toml` æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š
```toml
#:schema node_modules/wrangler/config-schema.json
name = "sqlite-durable-objects"
main = "src/index.ts"
compatibility_date = "2024-11-12"
compatibility_flags = [ "nodejs_compat" ]

# ç»‘å®š Durable Objectã€‚Durable Object æ˜¯åŸºäºæ¼”å‘˜æ¨¡å‹çš„æŒ‰éœ€æ‰©ç¼©è®¡ç®—åŸè¯­ã€‚
# Durable Objects å¯ä»¥é•¿æœŸå­˜åœ¨ã€‚ç”¨äºéœ€è¦é•¿æ—¶é—´è¿è¡Œâ€œæœåŠ¡å™¨â€çš„åœºæ™¯ï¼Œä¾‹å¦‚å®æ—¶åº”ç”¨ã€‚
# æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[[durable_objects.bindings]]
name = "MY_DURABLE_OBJECT"
class_name = "MyDurableObject"

# Durable Object è¿ç§»é…ç½®
# æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/wrangler/configuration/#migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["MyDurableObject"]

# è§„åˆ™é…ç½®ï¼Œä¾¿äºåç»­æ­¥éª¤ä¸­å¯¼å…¥è¿ç§»æ–‡ä»¶
[[rules]] 
type = "Text"
globs = ["**/*.sql"]
fallthrough = true
```

#### ç¬¬3æ­¥ - é…ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶ç­‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'sqlite',
  driver: 'durable-sqlite',
});
```
<Callout title='æç¤º'>
ä½ å¯ä»¥æŸ¥çœ‹[æˆ‘ä»¬çš„æ•™ç¨‹](/docs/guides/d1-http-with-drizzle-kit)äº†è§£å¦‚ä½•ä» Cloudflare è·å–ç¯å¢ƒå˜é‡
</Callout>

#### ç¬¬4æ­¥ - åå‘åˆ†ææ•°æ®åº“æ¨¡å¼

<IntrospectSQLite/>

#### ç¬¬5æ­¥ - æŠŠä»£ç è½¬ç§»åˆ°ä½ çš„å®é™… schema æ–‡ä»¶

<TransferCode/>

#### ç¬¬6æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

```typescript copy
import { drizzle, type DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });
	}
}
```

#### ç¬¬7æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy
import { drizzle, DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';
import { usersTable } from './db/schema';

export class MyDurableObject extends DurableObject {
  storage: DurableObjectStorage;
  db: DrizzleSqliteDODatabase<any>;

  constructor(ctx: DurableObjectState, env: Env) {
    super(ctx, env);
    this.storage = ctx.storage;
    this.db = drizzle(this.storage, { logger: false });

    // ä¿è¯æ‰€æœ‰è¿ç§»å®Œæˆåå†æ¥å—æŸ¥è¯¢è¯·æ±‚ã€‚
    // å¦åˆ™ä½ éœ€è¦åœ¨è®¿é—® Drizzle æ•°æ®åº“ this.db çš„å‡½æ•°ä¸­è°ƒç”¨ this.migrate()ã€‚
    ctx.blockConcurrencyWhile(async () => {
      await this._migrate();
    });
  }

  async insertAndList(user: typeof usersTable.$inferInsert) {
    await this.insert(user);
    return this.select();
  }

  async insert(user: typeof usersTable.$inferInsert) {
    await this.db.insert(usersTable).values(user);
  }

  async select() {
    return this.db.select().from(usersTable);
  }

  async _migrate() {
    migrate(this.db, migrations);
  }
}

export default {
  /**
   * è¿™æ˜¯ Cloudflare Worker çš„æ ‡å‡† fetch å¤„ç†å‡½æ•°
   *
   * @param request - ä»å®¢æˆ·ç«¯å‘é€åˆ° Worker çš„è¯·æ±‚
   * @param env - å¼•ç”¨ wrangler.toml ä¸­å£°æ˜çš„ç»‘å®šæ¥å£
   * @param ctx - Worker çš„æ‰§è¡Œä¸Šä¸‹æ–‡
   * @returns è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”
   */
  async fetch(request: Request, env: Env): Promise<Response> {
    const id: DurableObjectId = env.MY_DURABLE_OBJECT.idFromName('durable-object');
    const stub = env.MY_DURABLE_OBJECT.get(id);

    // æ–¹æ¡ˆ A - æ€§èƒ½æœ€ä½³ã€‚
    // æ¨èå°†æ‰€æœ‰æ•°æ®åº“äº¤äº’æ‰“åŒ…æˆå•ä¸ª Durable Object è°ƒç”¨ï¼Œ
    // å› ä¸ºåœ¨ DO å†…æ•°æ®åº“è®¿é—®é€Ÿåº¦éå¸¸å¿«ã€‚
    const usersAll = await stub.insertAndList({
      name: 'John',
      age: 30,
      email: 'john@example.com',
    });
    console.log('æ–°å¢ç”¨æˆ·ï¼Œè·å–æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç”¨æˆ·: ', users);
    /*
    const users: {
      id: number;
      name: string;
      age: number;
      email: string;
      phone: string | null;
    }[]
    */

    // æ–¹æ¡ˆ B - è¾ƒæ…¢ï¼Œä½†æœ‰æ—¶é€‚ç”¨äºè°ƒè¯•ã€‚
    // ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨å•ä¸ªå…¬å¼€çš„ Drizzle æŸ¥è¯¢ï¼Œ
    // ä½†æ¯ä¸ªæŸ¥è¯¢éƒ½æ˜¯ä¸€æ¬¡ Durable Object å®ä¾‹çš„å¾€è¿”è¯·æ±‚ã€‚
    await stub.insert({
      name: 'John',
      age: 30,
      email: 'john@example.com',
    });
    console.log('æ–°å¢ç”¨æˆ·ï¼');

    const users = await stub.select();
    console.log('è·å–æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç”¨æˆ·: ', users);
    /*
    const users: {
      id: number;
      name: string;
      age: number;
      email: string;
      phone: string | null;
    }[]
    */

    return Response.json(users);
  }
}
```

#### ç¬¬8æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬9æ­¥ - æ›´æ–°ä½ çš„è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬10æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬11æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```typescript copy filename="src/index.ts"
import { drizzle, DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';
import { usersTable } from './db/schema';

export class MyDurableObject extends DurableObject {
  storage: DurableObjectStorage;
  db: DrizzleSqliteDODatabase<any>;

  constructor(ctx: DurableObjectState, env: Env) {
    super(ctx, env);
    this.storage = ctx.storage;
    this.db = drizzle(this.storage, { logger: false });

    // ä¿è¯æ‰€æœ‰è¿ç§»å®Œæˆåå†æ¥å—æŸ¥è¯¢è¯·æ±‚ã€‚
    // å¦åˆ™ä½ éœ€è¦åœ¨è®¿é—® Drizzle æ•°æ®åº“ this.db çš„å‡½æ•°ä¸­è°ƒç”¨ this.migrate()ã€‚
    ctx.blockConcurrencyWhile(async () => {
      await this._migrate();
    });
  }

  async insertAndList(user: typeof usersTable.$inferInsert) {
    await this.insert(user);
    return this.select();
  }

  async insert(user: typeof usersTable.$inferInsert) {
    await this.db.insert(usersTable).values(user);
  }

  async select() {
    return this.db.select().from(usersTable);
  }

  async _migrate() {
    migrate(this.db, migrations);
  }
}

export default {
  /**
   * è¿™æ˜¯ Cloudflare Worker çš„æ ‡å‡† fetch å¤„ç†å‡½æ•°
   *
   * @param request - ä»å®¢æˆ·ç«¯å‘é€åˆ° Worker çš„è¯·æ±‚
   * @param env - å¼•ç”¨ wrangler.toml ä¸­å£°æ˜çš„ç»‘å®šæ¥å£
   * @param ctx - Worker çš„æ‰§è¡Œä¸Šä¸‹æ–‡
   * @returns è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”
   */
  async fetch(request: Request, env: Env): Promise<Response> {
    const id: DurableObjectId = env.MY_DURABLE_OBJECT.idFromName('durable-object');
    const stub = env.MY_DURABLE_OBJECT.get(id);

    // æ–¹æ¡ˆ A - æ€§èƒ½æœ€ä½³ã€‚
    // æ¨èå°†æ‰€æœ‰æ•°æ®åº“äº¤äº’æ‰“åŒ…æˆå•ä¸ª Durable Object è°ƒç”¨ï¼Œ
    // å› ä¸ºåœ¨ DO å†…æ•°æ®åº“è®¿é—®é€Ÿåº¦éå¸¸å¿«ã€‚
    const usersAll = await stub.insertAndList({
      name: 'John',
      age: 30,
      email: 'john@example.com',
      phone: '123-456-7890',
    });
    console.log('æ–°å¢ç”¨æˆ·ï¼Œè·å–æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç”¨æˆ·: ', users);
    /*
    const users: {
      id: number;
      name: string;
      age: number;
      email: string;
      phone: string | null;
    }[]
    */

    // æ–¹æ¡ˆ B - è¾ƒæ…¢ï¼Œä½†æœ‰æ—¶é€‚ç”¨äºè°ƒè¯•ã€‚
    // ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨å•ä¸ªå…¬å¼€çš„ Drizzle æŸ¥è¯¢ï¼Œ
    // ä½†æ¯ä¸ªæŸ¥è¯¢éƒ½æ˜¯ä¸€æ¬¡ Durable Object å®ä¾‹çš„å¾€è¿”è¯·æ±‚ã€‚
    await stub.insert({
      name: 'John',
      age: 30,
      email: 'john@example.com',
      phone: '123-456-7890',
    });
    console.log('æ–°å¢ç”¨æˆ·ï¼');

    const users = await stub.select();
    console.log('è·å–æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç”¨æˆ·: ', users);
    /*
    const users: {
      id: number;
      name: string;
      age: number;
      email: string;
      phone: string | null;
    }[]
    */

    return Response.json(users);
  }
}
```

Source: https://drizzle.zhcndoc.com/docs/get-started/do-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryTurso from '@mdx/get-started/sqlite/QueryTurso.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ SQLite Durable Objects å¿«é€Ÿå…¥é—¨

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **Cloudflare SQLite Durable Objects** - åµŒå…¥äº Durable Object ä¸­çš„ SQLite æ•°æ®åº“ - [é˜…è¯»è¿™é‡Œ](https://developers.cloudflare.com/durable-objects/api/sql-storage/)
  - **wrangler** - Cloudflare å¼€å‘è€…å¹³å°å‘½ä»¤è¡Œæ¥å£ - [é˜…è¯»è¿™é‡Œ](https://developers.cloudflare.com/workers/wrangler)
</Prerequisites>

<FileStructure />

#### ç¬¬ 1 æ­¥ - å®‰è£…å¿…éœ€çš„åŒ…
<InstallPackages lib='wrangler'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½® wrangler.toml

ä½ éœ€è¦æœ‰ä¸€ä¸ªç”¨äº D1 æ•°æ®åº“çš„ `wrangler.toml` æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š
```toml
#:schema node_modules/wrangler/config-schema.json
name = "sqlite-durable-objects"
main = "src/index.ts"
compatibility_date = "2024-11-12"
compatibility_flags = [ "nodejs_compat" ]

# ç»‘å®šä¸€ä¸ª Durable Objectã€‚Durable Object æ˜¯åŸºäº actor æ¨¡å‹çš„æŒ‰éœ€ä¼¸ç¼©è®¡ç®—åŸè¯­ã€‚
# Durable Object å¯ä»¥æŒç»­å­˜åœ¨ã€‚é€‚ç”¨äºéœ€è¦é•¿æ—¶é—´è¿è¡Œâ€œæœåŠ¡å™¨â€çš„åœºæ™¯ï¼Œå¦‚å®æ—¶åº”ç”¨ã€‚
# æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[[durable_objects.bindings]]
name = "MY_DURABLE_OBJECT"
class_name = "MyDurableObject"

# Durable Object è¿ç§»ã€‚
# æ–‡æ¡£ï¼šhttps://developers.cloudflare.com/workers/wrangler/configuration/#migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["MyDurableObject"]

# éœ€è¦è§„åˆ™ä»¥ä¾¿åœ¨åç»­æ­¥éª¤ä¸­å¯¼å…¥è¿ç§»
[[rules]] 
type = "Text"
globs = ["**/*.sql"]
fallthrough = true
```

#### ç¬¬ 3 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

```ts
import { drizzle, type DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });
	}
}
```

#### ç¬¬ 4 æ­¥ - ç”Ÿæˆ wrangler ç±»å‹

<Npx>
wrangler types
</Npx>

<Callout>
è¯¥å‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ª `worker-configuration.d.ts` æ–‡ä»¶ã€‚
</Callout>

#### ç¬¬ 5 æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### ç¬¬ 6 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** æ˜¯ä¸€ä¸ªç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'sqlite',
  driver: 'durable-sqlite',
});
```

#### ç¬¬ 7 æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´

ç”Ÿæˆè¿ç§»ï¼š
```bash copy
npx drizzle-kit generate
```

è¿ç§»åªèƒ½ä» Cloudflare Workers åº”ç”¨ã€‚
ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨ MyDurableObject ä¸­å®šä¹‰è¿ç§»åŠŸèƒ½ï¼š
```ts copy {4-5,17-19}
import { drizzle, type DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });
	}

	async migrate() {
		migrate(this.db, migrations);
	}
}
```

#### ç¬¬ 8 æ­¥ - è¿ç§»å¹¶æŸ¥è¯¢æ•°æ®åº“

```typescript copy
import { drizzle, DrizzleSqliteDODatabase } from 'drizzle-orm/durable-sqlite';
import { DurableObject } from 'cloudflare:workers'
import { migrate } from 'drizzle-orm/durable-sqlite/migrator';
import migrations from '../drizzle/migrations';
import { usersTable } from './db/schema';

export class MyDurableObject extends DurableObject {
	storage: DurableObjectStorage;
	db: DrizzleSqliteDODatabase<any>;

	constructor(ctx: DurableObjectState, env: Env) {
		super(ctx, env);
		this.storage = ctx.storage;
		this.db = drizzle(this.storage, { logger: false });

		// ç¡®ä¿æ‰€æœ‰è¿ç§»åœ¨æ¥å—æŸ¥è¯¢å‰å®Œæˆã€‚
		// å¦åˆ™ä½ éœ€è¦åœ¨ä»»ä½•è®¿é—® Drizzle æ•°æ®åº“ this.db çš„å‡½æ•°ä¸­è°ƒç”¨ `this.migrate()`ã€‚
		ctx.blockConcurrencyWhile(async () => {
			await this._migrate();
		});
	}

	async insertAndList(user: typeof usersTable.$inferInsert) {
		await this.insert(user);
		return this.select();
	}

	async insert(user: typeof usersTable.$inferInsert) {
		await this.db.insert(usersTable).values(user);
	}

	async select() {
		return this.db.select().from(usersTable);
	}

	async _migrate() {
		migrate(this.db, migrations);
	}
}

export default {
	/**
	 * è¿™æ˜¯ Cloudflare Worker çš„æ ‡å‡† fetch å¤„ç†å™¨
	 *
	 * @param request - Client å‘é€åˆ° Worker çš„è¯·æ±‚
	 * @param env - ç”¨äºå¼•ç”¨ wrangler.toml ä¸­å£°æ˜ç»‘å®šçš„æ¥å£
	 * @param ctx - Worker çš„æ‰§è¡Œä¸Šä¸‹æ–‡
	 * @returns è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”
	 */
	async fetch(request: Request, env: Env): Promise<Response> {
		const id: DurableObjectId = env.MY_DURABLE_OBJECT.idFromName('durable-object');
		const stub = env.MY_DURABLE_OBJECT.get(id);

		// é€‰é¡¹ A - æœ€å¤§æ€§èƒ½ã€‚
		// ä¼˜å…ˆå°†æ‰€æœ‰æ•°æ®åº“äº¤äº’å°è£…åœ¨ä¸€æ¬¡ Durable Object è°ƒç”¨ä¸­
		// ä»¥è·å¾—æœ€å¤§æ€§èƒ½ï¼Œå› ä¸º DO å†…çš„æ•°æ®åº“è®¿é—®éå¸¸å¿«ã€‚
		const usersAll = await stub.insertAndList({
			name: 'John',
			age: 30,
			email: 'john@example.com',
		});
		console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºã€‚æ­£åœ¨ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·ï¼š', users);

		// é€‰é¡¹ B - æ…¢é€Ÿï¼Œä½†åœ¨æŸäº›è°ƒè¯•åœºæ™¯ä¸‹å¯èƒ½æœ‰ç”¨ã€‚
		// ä½ ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨å•ä¸ª Drizzle æŸ¥è¯¢ï¼ˆå¦‚æœæš´éœ²äº†çš„è¯ï¼‰ï¼Œ
		// ä½†è¯·è®°ä½æ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯å¯¹ Durable Object å®ä¾‹çš„ä¸€æ¬¡å¾€è¿”ã€‚
		await stub.insert({
			name: 'John',
			age: 30,
			email: 'john@example.com',
		});
		console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼');
	
		const users = await stub.select();
		console.log('æ­£åœ¨ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·ï¼š', users);

		return Response.json(users);
	}
}
```

Source: https://drizzle.zhcndoc.com/docs/get-started/expo-existing

import Breadcrumbs from '@mdx/Breadcrumbs.astro';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ Expo å…¥é—¨

æˆ‘ä»¬æ²¡æœ‰å…³äºåœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Expo çš„å®Œæ•´æŒ‡å—ï¼Œä½†æˆ‘ä»¬ç›¸ä¿¡
æ¥è‡ªè¿™ä¸ª [å…¥é—¨æŒ‡å—](/docs/get-started/expo-new) çš„æ‰€æœ‰ä¿¡æ¯åº”è¯¥è¶³å¤Ÿäº†

Source: https://drizzle.zhcndoc.com/docs/get-started/expo-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Expo

<Prerequisites>  
  - **Expo SQLite** - ä¸€ä¸ªå¯é€šè¿‡ SQLite API æŸ¥è¯¢çš„æ•°æ®åº“è®¿é—®åº“ - [åœ¨æ­¤é˜…è¯»](https://docs.expo.dev/versions/latest/sdk/sqlite/)
</Prerequisites>


#### æ­¥éª¤ 1 - ä» Expo æ¨¡æ¿è®¾ç½®é¡¹ç›®
<Npx>
create expo-app --template blank-typescript
</Npx>

æ‚¨å¯ä»¥åœ¨ [æ­¤å¤„](https://docs.expo.dev/more/create-expo/#create-a-new-project) äº†è§£æ›´å¤šå…³äºæ­¤æ¨¡æ¿çš„ä¿¡æ¯ã€‚

#### åŸºæœ¬æ–‡ä»¶ç»“æ„

å®‰è£…æ¨¡æ¿å¹¶æ·»åŠ  `db` æ–‡ä»¶å¤¹åï¼Œæ‚¨å°†æ‰¾åˆ°ä»¥ä¸‹å†…å®¹ï¼šåœ¨ `db/schema.ts` æ–‡ä»¶ä¸­å®šä¹‰çš„ drizzle è¡¨ã€‚`drizzle` æ–‡ä»¶å¤¹åŒ…å« SQL è¿ç§»æ–‡ä»¶å’Œå¿«ç…§

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ assets
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ db
 â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“œ .gitignore
 â”œ ğŸ“œ .npmrc
 â”œ ğŸ“œ app.json
 â”œ ğŸ“œ App.tsx
 â”œ ğŸ“œ babel.config.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### æ­¥éª¤ 2 - å®‰è£… expo-sqlite åŒ…
<Npx>
expo install expo-sqlite
</Npx>

#### æ­¥éª¤ 3 - å®‰è£…æ‰€éœ€çš„åŒ…
<Npm>
  drizzle-orm
  -D drizzle-kit
</Npm>

#### æ­¥éª¤ 4 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `App.tsx` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```ts
import * as SQLite from 'expo-sqlite';
import { drizzle } from 'drizzle-orm/expo-sqlite';

const expo = SQLite.openDatabaseSync('db.db');

const db = drizzle(expo);
```

#### æ­¥éª¤ 5 - åˆ›å»ºè¡¨

åœ¨ `db` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable("users_table", {
  id: int().primaryKey({ autoIncrement: true }),
  name: text().notNull(),
  age: int().notNull(),
  email: text().notNull().unique(),
});
```

#### æ­¥éª¤ 6 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªç”¨äº [Drizzle Kit](/docs/kit-overview) çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'sqlite',
  driver: 'expo',
  schema: './db/schema.ts',
  out: './drizzle',
});
```

#### æ­¥éª¤ 7 - è®¾ç½® `metro` é…ç½®

åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `metro.config.js` å¹¶åœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```js copy filename="metro.config.js"
const { getDefaultConfig } = require('expo/metro-config');
/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);
config.resolver.sourceExts.push('sql');
module.exports = config;
```

#### æ­¥éª¤ 8 - æ›´æ–° `babel` é…ç½®
```js copy filename="babel.config.js"
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [["inline-import", { "extensions": [".sql"] }]] // <-- æ·»åŠ æ­¤è¡Œ
  };
};
```

#### æ­¥éª¤ 9 - å¯¹æ•°æ®åº“åº”ç”¨æ›´æ”¹

ä½¿ç”¨ Expoï¼Œæ‚¨éœ€è¦é€šè¿‡ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œå¹¶é€šè¿‡ `drizzle-orm` çš„ `migrate()` å‡½æ•°åœ¨è¿è¡Œæ—¶åº”ç”¨å®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š
```bash copy
npx drizzle-kit generate
```

#### æ­¥éª¤ 10 - åº”ç”¨è¿ç§»å¹¶æŸ¥è¯¢æ•°æ®åº“ï¼š

è®©æˆ‘ä»¬åœ¨ **App.tsx** æ–‡ä»¶ä¸­æ‰§è¡Œè¿ç§»å’ŒæŸ¥è¯¢ï¼Œä»¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤ç”¨æˆ·ã€‚

```ts copy
import { Text, View } from 'react-native';
import * as SQLite from 'expo-sqlite';
import { useEffect, useState } from 'react';
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { usersTable } from './db/schema';
import { useMigrations } from 'drizzle-orm/expo-sqlite/migrator';
import migrations from './drizzle/migrations';

const expo = SQLite.openDatabaseSync('db.db');

const db = drizzle(expo);

export default function App() {
  const { success, error } = useMigrations(db, migrations);
  const [items, setItems] = useState<typeof usersTable.$inferSelect[] | null>(null);

  useEffect(() => {
    if (!success) return;

    (async () => {
      await db.delete(usersTable);

      await db.insert(usersTable).values([
        {
            name: 'John',
            age: 30,
            email: 'john@example.com',
        },
      ]);

      const users = await db.select().from(usersTable);
      setItems(users);
    })();
  }, [success]);

  if (error) {
    return (
      <View>
        <Text>è¿ç§»é”™è¯¯: {error.message}</Text>
      </View>
    );
  }

  if (!success) {
    return (
      <View>
        <Text>è¿ç§»è¿›è¡Œä¸­...</Text>
      </View>
    );
  }

  if (items === null || items.length === 0) {
    return (
      <View>
        <Text>ç©º</Text>
      </View>
    );
  }

  return (
    <View
      style={{
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        width: '100%',
        height: '100%',
        justifyContent: 'center',
      }}
    >
      {items.map((item) => (
        <Text key={item.id}>{item.email}</Text>
      ))}
    </View>
  );
}
```

#### æ­¥éª¤ 11 - é¢„æ„å»ºå¹¶è¿è¡Œ expo åº”ç”¨

<CodeTabs items={['npm', 'yarn', 'pnpm', 'bun']}>
```bash copy
npx expo run:ios
```
```bash copy
yarn expo run:ios
```
```bash copy
pnpm expo run:ios
```
```bash copy
bun expo run:ios
```
</CodeTabs>


Source: https://drizzle.zhcndoc.com/docs/get-started/gel-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPostgreSQL from '@mdx/get-started/postgresql/ConnectPostgreSQL.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# åœ¨å·²æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ Gel å…¥é—¨

<Prerequisites>
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **gel-js** - ç”¨äºæŸ¥è¯¢ä½ çš„ Gel æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://github.com/geldata/gel-js)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `gel` å®¢æˆ·ç«¯è¿æ¥ Gelã€‚

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src` ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æœ‰ `index.ts` ä¸­çš„è¡¨å®šä¹‰ã€‚åœ¨ `drizzle` æ–‡ä»¶å¤¹ä¸­æ˜¯ç”Ÿæˆçš„ Gel åˆ° Drizzle çš„ schemaã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ dbschema
 â”‚ â”œ ğŸ“‚ migrations
 â”‚ â”œ ğŸ“œ default.esdl
 â”‚ â”” ğŸ“œ scoping.esdl
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ edgedb.toml
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### ç¬¬ 1 æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…
<Npm>
  drizzle-orm gel
  -D drizzle-kit tsx
</Npm>

#### ç¬¬ 2 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - è¿™æ˜¯ä¸€ä¸ªç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†å…³äºä½ çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œ schema æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
});
```

#### ç¬¬ 3 æ­¥ - å°† Gel ç±»å‹æ‹‰å–åˆ° Drizzle schema

æ‹‰å–ä½ çš„æ•°æ®åº“ schemaï¼š
<Npx>
drizzle-kit pull
</Npx>

ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„ schema.ts æ–‡ä»¶ç¤ºä¾‹ï¼š

```typescript filename="drizzle/schema.ts"
import { gelTable, uniqueIndex, uuid, smallint, text } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const users = gelTable("users", {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	age: smallint(),
	email: text().notNull(),
	name: text(),
}, (table) => [
	uniqueIndex("a8c6061c-f37f-11ef-9249-0d78f6c1807b;schemaconstr").using("btree", table.id.asc().nullsLast().op("uuid_ops")),
]);
```

#### ç¬¬ 4 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

åœ¨ `src` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```typescript copy filename="src/index.ts"
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";

const gelClient = createClient();
const db = drizzle({ client: gelClient });
```

#### ç¬¬ 5 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";
import { users } from "../drizzle/schema";

const gelClient = createClient();
const db = drizzle({ client: gelClient });

async function main() {
  const user: typeof users.$inferInsert = {
    name: "John",
    age: 30,
    email: "john@example.com",
  };

  await db.insert(users).values(user);
  console.log("æ–°ç”¨æˆ·å·²åˆ›å»ºï¼");

  const usersResponse = await db.select().from(users);
  console.log("è·å–æ•°æ®åº“ä¸­æ‰€æœ‰ç”¨æˆ·: ", usersResponse);
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(users)
    .set({
      age: 31,
    })
    .where(eq(users.email, user.email));
  console.log("ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼");

  await db.delete(users).where(eq(users.email, user.email));
  console.log("ç”¨æˆ·å·²åˆ é™¤ï¼");
}

main();
```

#### ç¬¬ 6 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/gel-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPostgreSQL from '@mdx/get-started/postgresql/ConnectPostgreSQL.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Gel å¿«é€Ÿå…¥é—¨

<Prerequisites>
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://tsx.is/)
  - **gel-js** - ç”¨äºæŸ¥è¯¢ Gel æ•°æ®åº“çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://github.com/geldata/gel-js)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `gel` å®¢æˆ·ç«¯è¿æ¥ Gelã€‚

è¿™æ˜¯é¡¹ç›®çš„åŸºç¡€æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ `index.ts` æ–‡ä»¶ï¼Œç”¨äºè¡¨çš„å®šä¹‰ã€‚åœ¨ `drizzle` æ–‡ä»¶å¤¹ä¸­åˆ™å­˜æ”¾äº†ä» Gel ç”Ÿæˆçš„ Drizzle schemaã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### ç¬¬1æ­¥ - å®‰è£…å¹¶åˆå§‹åŒ– **Gel** é¡¹ç›®

<Npx>
gel project init
</Npx>

#### ç¬¬2æ­¥ - å®šä¹‰åŸºç¡€ Gel schema

åœ¨ `dbschema/default.esdl` æ–‡ä»¶ä¸­æ·»åŠ åŸºç¡€çš„ Gel schema

```esdl
module default {
    type user {
        name: str;
        required email: str;
        age: int16;
    }
}
```

#### ç¬¬3æ­¥ - æ¨é€ Gel schema åˆ°æ•°æ®åº“

ç”Ÿæˆ Gel è¿ç§»æ–‡ä»¶ï¼š
```bash
gel migration create
```

åº”ç”¨ Gel è¿ç§»åˆ°æ•°æ®åº“ï¼š
```bash
gel migration apply
```

<Callout>
ç°åœ¨ä½ çš„æ–‡ä»¶ç»“æ„åº”è¯¥æ˜¯è¿™æ ·

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ dbschema
 â”‚ â”œ ğŸ“‚ migrations
 â”‚ â”œ ğŸ“œ default.esdl
 â”‚ â”” ğŸ“œ scoping.esdl
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ index.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ edgedb.toml
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```
</Callout>

#### ç¬¬4æ­¥ - å®‰è£…æ‰€éœ€åŒ…
<Npm>
  drizzle-orm gel
  -D drizzle-kit tsx
</Npm>

#### ç¬¬5æ­¥ - é…ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®æ–‡ä»¶** æ˜¯ [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹åŠ schema æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
});
```

#### ç¬¬6æ­¥ - ä» Gel åŒæ­¥ç±»å‹åˆ° Drizzle schema

åŒæ­¥ä½ çš„æ•°æ®åº“ schemaï¼š
<Npx>
drizzle-kit pull
</Npx>

è¿™æ˜¯ç¤ºä¾‹ç”Ÿæˆçš„ schema.ts æ–‡ä»¶ï¼š

```typescript filename="drizzle/schema.ts"
import { gelTable, uniqueIndex, uuid, smallint, text } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const users = gelTable("users", {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	age: smallint(),
	email: text().notNull(),
	name: text(),
}, (table) => [
	uniqueIndex("a8c6061c-f37f-11ef-9249-0d78f6c1807b;schemaconstr").using("btree", table.id.asc().nullsLast().op("uuid_ops")),
]);
```

#### ç¬¬7æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

åœ¨ `src` ç›®å½•ä¸‹åˆ›å»º `index.ts` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```typescript copy filename="src/index.ts"
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";

const gelClient = createClient();
const db = drizzle({ client: gelClient });
```

#### ç¬¬8æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import { eq } from "drizzle-orm";
import { drizzle } from "drizzle-orm/gel";
import { createClient } from "gel";
import { users } from "../drizzle/schema";

const gelClient = createClient();
const db = drizzle({ client: gelClient });

async function main() {
  const user: typeof users.$inferInsert = {
    name: "John",
    age: 30,
    email: "john@example.com",
  };

  await db.insert(users).values(user);
  console.log("æ–°ç”¨æˆ·å·²åˆ›å»ºï¼");

  const usersResponse = await db.select().from(users);
  console.log("ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·ï¼š", usersResponse);
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(users)
    .set({
      age: 31,
    })
    .where(eq(users.email, user.email));
  console.log("ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼");

  await db.delete(users).where(eq(users.email, user.email));
  console.log("ç”¨æˆ·å·²åˆ é™¤ï¼");
}

main();
```

#### ç¬¬9æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/mssql-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectMSSQL from '@mdx/get-started/mssql/IntrospectMSSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectMSSQL from '@mdx/get-started/mssql/ConnectMSSQL.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/mssql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ MSSQL å¿«é€Ÿå¼€å§‹

<Callout type='error'>
æœ¬é¡µå†…å®¹é€‚ç”¨äº drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠä»¥ä¸Šã€‚
</Callout>

<br/>

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **node-mssql** - ç”¨äºæŸ¥è¯¢ MSSQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://github.com/tediousjs/node-mssql)
</Prerequisites>

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **mssql** åŒ…
<Npm>
  drizzle-orm@beta mssql dotenv
  -D drizzle-kit@beta tsx
</Npm>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### æ­¥éª¤ 3 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mssql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 4 - è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“ç»“æ„

<IntrospectMSSQL/>

#### æ­¥éª¤ 5 - å°†ä»£ç è½¬ç§»åˆ°å®é™…çš„ schema æ–‡ä»¶ä¸­

<TransferCode/>

#### æ­¥éª¤ 6 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectMSSQL/>

#### æ­¥éª¤ 7 - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='node-mssql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### æ­¥éª¤ 9 - æ›´æ–°è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### æ­¥éª¤ 10 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### æ­¥éª¤ 11 - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='node-mssql' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/mssql-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectMSSQL from '@mdx/get-started/mssql/ConnectMSSQL.mdx'
import CreateTable from '@mdx/get-started/mssql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ MSSQL å…¥é—¨

<Callout type='error'>
æœ¬é¡µé¢è®²è§£é€‚ç”¨äº drizzle ç‰ˆæœ¬ `1.0.0-beta.2` åŠä»¥ä¸Šçš„æ¦‚å¿µã€‚
</Callout>

<br/>

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **node-mssql** - æŸ¥è¯¢ MSSQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://github.com/tediousjs/node-mssql)
</Prerequisites>

Drizzle åŸç”Ÿæ”¯æŒä½¿ç”¨ `node-mssql` é©±åŠ¨è¿æ¥ PostgreSQLã€‚

<FileStructure/>

#### ç¬¬1æ­¥ - å®‰è£… **mssql** åŒ…
<Npm>
  drizzle-orm@beta mssql dotenv
  -D drizzle-kit@beta tsx
</Npm>

#### ç¬¬2æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

{/* <Callout title='å°è´´å£«'>
å¦‚æœä½ è¿˜æ²¡æœ‰ PostgreSQL æ•°æ®åº“ä¸”æƒ³åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ PostgreSQL Docker è®¾ç½®æŒ‡å—ã€‚

PostgreSQL Docker è®¾ç½®æŒ‡å—è¯¦è§[æ­¤å¤„](/docs/guides/postgresql-local-setup)ã€‚è¯·å…ˆå®Œæˆè®¾ç½®ï¼Œç”Ÿæˆæ•°æ®åº“ URLï¼ˆæŒ‡å—ä¸­æœ‰è¯´æ˜ï¼‰ï¼Œç„¶åå†å›æ¥ç»§ç»­åç»­æ­¥éª¤ã€‚
</Callout> */}

#### ç¬¬3æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectMSSQL/>

#### ç¬¬4æ­¥ - åˆ›å»ºè¡¨

<CreateTable />

#### ç¬¬5æ­¥ - é…ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mssql' env_variable='DATABASE_URL'/>

#### ç¬¬6æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´

<ApplyChanges />

#### ç¬¬7æ­¥ - å¡«å……å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='node-mssql' env_variable='DATABASE_URL'/>

#### ç¬¬8æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/mysql-existing

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectMySQL from '@mdx/get-started/mysql/ConnectMySQL.mdx';
import CreateTable from '@mdx/get-started/mysql/CreateTable.mdx';
import UpdateSchema from '@mdx/get-started/mysql/UpdateSchema.mdx';
import IntrospectMySQL from '@mdx/get-started/mysql/IntrospectMySQL.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ MySQL å¿«é€Ÿå…¥é—¨

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://tsx.is/)
  - **mysql2** - æŸ¥è¯¢æ‚¨çš„ MySQL æ•°æ®åº“çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://github.com/sidorares/node-mysql2)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… `mysql2` åŒ…

<InstallPackages lib='mysql2'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mysql' env_variable='DATABASE_URL'/>

#### ç¬¬ 4 æ­¥ - å†…çœæ‚¨çš„æ•°æ®åº“

<IntrospectMySQL/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°æ‚¨çš„å®é™…æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectMySQL/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='mysql2' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°æ‚¨çš„è¡¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='mysql2' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/mysql-new

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectMySQL from '@mdx/get-started/mysql/ConnectMySQL.mdx';
import CreateTable from '@mdx/get-started/mysql/CreateTable.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ MySQL

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **mysql2** - æŸ¥è¯¢æ‚¨çš„ MySQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://github.com/sidorares/node-mysql2)
</Prerequisites>

è¦ä½¿ç”¨ Drizzle ä¸ MySQL æ•°æ®åº“ï¼Œæ‚¨åº”ä½¿ç”¨ `mysql2` é©±åŠ¨

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://github.com/sidorares/node-mysql2)**ï¼Œ 
`mysql2` æ˜¯ä¸€ä¸ªä¸“æ³¨äºæ€§èƒ½çš„ Node.js MySQL å®¢æˆ·ç«¯ã€‚  

Drizzle ORM åŸç”Ÿæ”¯æŒ `mysql2`ï¼Œä½¿ç”¨ `drizzle-orm/mysql2` åŒ…ã€‚

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **mysql2** åŒ…

<InstallPackages lib='mysql2'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

<Callout title='æç¤º'>
å¦‚æœæ‚¨è¿˜æ²¡æœ‰ MySQL æ•°æ®åº“å¹¶æƒ³è¦åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬å…³äºå¦‚ä½•åœ¨ Docker ä¸­è®¾ç½® MySQL çš„æŒ‡å—ã€‚

Docker ä¸­çš„ MySQL æŒ‡å—å¯ä»¥åœ¨ [è¿™é‡Œ](/docs/guides/mysql-local-setup) æ‰¾åˆ°ã€‚å»è®¾ç½®ä¸€ä¸‹ï¼Œç”Ÿæˆä¸€ä¸ªæ•°æ®åº“ URLï¼ˆæŒ‡å—ä¸­æœ‰è§£é‡Šï¼‰ï¼Œç„¶åå›æ¥è¿›è¡Œä¸‹ä¸€æ­¥
</Callout>

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectMySQL/>

#### æ­¥éª¤ 4 - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mysql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - å¡«å……å’ŒæŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='mysql2' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/neon-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectNeon from '@mdx/get-started/postgresql/ConnectNeon.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Neon

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://tsx.is/)
  - **Neon** - æ— æœåŠ¡å™¨çš„ Postgres å¹³å° - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://neon.tech/docs/introduction)
</Prerequisites>

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **@neondatabase/serverless** åŒ…
<InstallPackages lib='@neondatabase/serverless'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### æ­¥éª¤ 3 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 4 - å¯¹æ•°æ®åº“è¿›è¡Œæ¢æµ‹

<IntrospectPostgreSQL/>

#### æ­¥éª¤ 5 - å°†ä»£ç è½¬ç§»åˆ°å®é™…çš„æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### æ­¥éª¤ 6 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectNeon/>

#### æ­¥éª¤ 7 - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='neon-http' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### æ­¥éª¤ 9 - æ›´æ–°ä½ çš„è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### æ­¥éª¤ 10 - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### æ­¥éª¤ 11 - ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='neon-http' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/neon-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectNeon from '@mdx/get-started/postgresql/ConnectNeon.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Neon

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **Neon** - æ— æœåŠ¡å™¨çš„ Postgres å¹³å° - [é˜…è¯»è¿™é‡Œ](https://neon.tech/docs/introduction)
</Prerequisites>

Drizzle å¯¹ Neon è¿æ¥æœ‰åŸç”Ÿæ”¯æŒï¼Œä½¿ç”¨ `neon-http` å’Œ `neon-websockets` é©±åŠ¨ã€‚è¿™äº›é©±åŠ¨åœ¨åº•å±‚ä½¿ç”¨ **neon-serverless** é©±åŠ¨ã€‚  
  
é€šè¿‡ `neon-http` å’Œ `neon-websockets` é©±åŠ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ HTTP æˆ– WebSockets ä»æ— æœåŠ¡å™¨ç¯å¢ƒè®¿é—® Neon æ•°æ®åº“ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ TCPã€‚é€šè¿‡ HTTP æŸ¥è¯¢å¯¹äºå•ä¸ªéäº¤äº’å¼äº‹åŠ¡è€Œè¨€é€Ÿåº¦æ›´å¿«ã€‚  
  
å¦‚æœæ‚¨éœ€è¦ä¼šè¯æˆ–äº¤äº’å¼äº‹åŠ¡æ”¯æŒï¼Œæˆ–è€…å®Œå…¨å…¼å®¹çš„ `pg` é©±åŠ¨æ›¿ä»£å“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åŸºäº WebSocket çš„ `neon-serverless` é©±åŠ¨ã€‚æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ [Postgres](/docs/get-started/postgresql-new) è¿æ¥åˆ° Neon æ•°æ®åº“ã€‚

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **@neondatabase/serverless** åŒ…
<InstallPackages lib='@neondatabase/serverless'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectNeon/>

#### æ­¥éª¤ 4 - åˆ›å»ºè¡¨

<CreateTable />

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - ç§å­å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='neon-http' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/nile-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectNile from '@mdx/get-started/postgresql/ConnectNile.mdx';
import QueryNile from '@mdx/get-started/postgresql/QueryNile.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Nile

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **Nile** - é’ˆå¯¹å¤šç§Ÿæˆ·åº”ç”¨é‡æ–°è®¾è®¡çš„ PostgreSQL - [é˜…è¯»è¿™é‡Œ](https://thenile.dev/)
</Prerequisites>

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **postgres** åŒ…
<InstallPackages lib='pg' devlib=' @types/pg'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='NILEDB_URL' />

#### æ­¥éª¤ 3 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='NILEDB_URL'/>

#### æ­¥éª¤ 4 - æ¢æŸ¥æ•°æ®åº“

Drizzle Kit æä¾›äº†ä¸€ä¸ª CLI å‘½ä»¤æ¥æ¢æŸ¥ä½ çš„æ•°æ®åº“ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªåŒ…å«è¿ç§»çš„æ¨¡å¼æ–‡ä»¶ã€‚æ¨¡å¼æ–‡ä»¶åŒ…å«æ•°æ®åº“è¡¨ã€åˆ—ã€å…³ç³»å’Œç´¢å¼•çš„æ‰€æœ‰ä¿¡æ¯ã€‚

ä¾‹å¦‚, ä½ çš„æ•°æ®åº“ä¸­æœ‰è¿™æ ·ä¸€å¼ è¡¨:

```sql copy
CREATE TABLE IF NOT EXISTS "todos" (
  "id" uuid DEFAULT gen_random_uuid(),
  "tenant_id" uuid,
  "title" varchar(256),
  "estimate" varchar(256),
  "embedding" vector(3),
  "complete" boolean
);
```

æ‹‰å–ä½ çš„æ•°æ®åº“æ¨¡å¼:

```bash copy
npx drizzle-kit pull
```

æ¢æŸ¥çš„ç»“æœå°†æ˜¯ä¸€ä¸ª `schema.ts` æ–‡ä»¶, `meta` æ–‡ä»¶å¤¹ä¸­åŒ…å«æ•°æ®åº“æ¨¡å¼çš„å¿«ç…§, ä¸€ä¸ªåŒ…å«è¿ç§»çš„ sql æ–‡ä»¶å’Œä¸€ä¸ªç”¨äº [å…³ç³»æŸ¥è¯¢](/docs/rqb) çš„ `relations.ts` æ–‡ä»¶ã€‚

<Callout title='å†…ç½®è¡¨'>
Nile æœ‰å‡ ä¸ªå†…ç½®è¡¨ï¼Œå®ƒä»¬æ˜¯æ¯ä¸ªæ•°æ®åº“çš„ä¸€éƒ¨åˆ†ã€‚å½“ä½ æ¢æŸ¥ä¸€ä¸ª Nile æ•°æ®åº“æ—¶ï¼Œå†…ç½®è¡¨å°†è¢«åŒ…å«åœ¨å†…ã€‚
ä¾‹å¦‚ï¼Œä¸‹é¢ç¤ºä¾‹ä¸­çœ‹åˆ°çš„ `tenants` è¡¨ã€‚è¿™å°†ä½¿ä½ èƒ½å¤Ÿè½»æ¾åˆ›å»ºæ–°ç§Ÿæˆ·ã€åˆ—å‡ºç§Ÿæˆ·å’Œè¿›è¡Œå…¶ä»–æ“ä½œã€‚
</Callout>

ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„ `schema.ts` æ–‡ä»¶çš„ç¤ºä¾‹:

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡æ¢æŸ¥ç”Ÿæˆçš„è¡¨æ¨¡å¼
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});

export const todos = pgTable("todos", {
	id: uuid().defaultRandom(),
	tenantId: uuid("tenant_id"),
	title: varchar({ length: 256 }),
	estimate: varchar({ length: 256 }),
	embedding: vector({ dimensions: 3 }),
	complete: boolean(),
});
```

äº†è§£æ›´å¤šå…³äºæ¢æŸ¥çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](/docs/drizzle-kit-pull)ã€‚

#### æ­¥éª¤ 5 - å°†ä»£ç è½¬ç§»åˆ°æ‚¨çš„å®é™…æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### æ­¥éª¤ 6 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectNile/>

#### æ­¥éª¤ 7 - æŸ¥è¯¢æ•°æ®åº“

<QueryNile />

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### æ­¥éª¤ 9 - æ›´æ–°æ‚¨çš„è¡¨æ¨¡å¼ (å¯é€‰)

å¦‚æœä½ æƒ³æ›´æ–°è¡¨æ¨¡å¼ï¼Œå¯ä»¥åœ¨ `schema.ts` æ–‡ä»¶ä¸­è¿›è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ¥ç»™ `todos` è¡¨æ·»åŠ ä¸€ä¸ªæ–°åˆ— `deadline`:

```typescript copy filename="src/db/schema.ts" {19}
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});

export const todos = pgTable("todos", {
	id: uuid().defaultRandom(),
	tenantId: uuid("tenant_id"),
	title: varchar({ length: 256 }),
	estimate: varchar({ length: 256 }),
	embedding: vector({ dimensions: 3 }),
	complete: boolean(),
  deadline: timestamp({ mode: 'string' })
});
```

#### æ­¥éª¤ 10 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ (å¯é€‰)

<ApplyChanges />

#### æ­¥éª¤ 11 - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ (å¯é€‰)

å¦‚æœä½ å†æ¬¡è¿è¡Œ `index.ts` æ–‡ä»¶ï¼Œä½ å°†èƒ½å¤Ÿçœ‹åˆ°ä½ åˆšåˆšæ·»åŠ çš„æ–°å­—æ®µã€‚
è¯¥å­—æ®µå°†ä¸º `null`ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¹‹å‰æ’å…¥ todos æ—¶æ²¡æœ‰å¡«å……æˆªæ­¢æ—¥æœŸã€‚

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/nile-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectNile from '@mdx/get-started/postgresql/ConnectNile.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryNile from '@mdx/get-started/postgresql/QueryNile.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';


<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Nile å¼€å§‹å…¥é—¨

<Prerequisites>
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»æ­¤å¤„](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»æ­¤å¤„](https://tsx.is/)
  - **Nile** - é’ˆå¯¹å¤šç§Ÿæˆ·åº”ç”¨é‡æ–°è®¾è®¡çš„ PostgreSQL - [é˜…è¯»æ­¤å¤„](https://thenile.dev/)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **postgres** åŒ…
<InstallPackages lib='pg' devlib=' @types/pg'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='NILEDB_URL' />

#### ç¬¬ 3 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectNile />

#### ç¬¬ 4 æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜ä½ çš„è¡¨ã€‚ç”±äº Nile æ˜¯å¤šç§Ÿæˆ·åº”ç”¨çš„ PostgreSQLï¼Œæˆ‘ä»¬çš„æ¨¡å¼åŒ…æ‹¬ä¸€ä¸ªç”¨äºç§Ÿæˆ·çš„è¡¨å’Œä¸€ä¸ªå¸¦æœ‰ `tenant_id` åˆ—çš„å¾…åŠäº‹é¡¹è¡¨ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºç§Ÿæˆ·æ„ŸçŸ¥è¡¨ï¼‰ï¼š

```typescript copy filename="src/db/schema.ts"
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenantsTable = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});

export const todos = pgTable("todos", {
	id: uuid().defaultRandom(),
	tenantId: uuid("tenant_id"),
	title: varchar({ length: 256 }),
	estimate: varchar({ length: 256 }),
	embedding: vector({ dimensions: 3 }),
	complete: boolean(),
});
```

#### ç¬¬ 5 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='NILEDB_URL'/>

#### ç¬¬ 6 æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges dialect='postgresql'/>

#### ç¬¬ 7 æ­¥ - å¡«å……å’ŒæŸ¥è¯¢æ•°æ®åº“

<QueryNile />

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/op-sqlite-existing

import Breadcrumbs from '@mdx/Breadcrumbs.astro';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ OP-SQLite å¼€å§‹

æˆ‘ä»¬æ²¡æœ‰å…³äºåœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ OP-SQLite çš„æ­£å¼æŒ‡å—ï¼Œæˆ‘ä»¬ç›¸ä¿¡
æ¥è‡ª [å…¥é—¨æŒ‡å—](/docs/get-started/op-sqlite-new) çš„æ‰€æœ‰ä¿¡æ¯åº”è¯¥è¶³å¤Ÿäº†ã€‚

Source: https://drizzle.zhcndoc.com/docs/get-started/op-sqlite-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ OP-SQLite å¼€å§‹

<Prerequisites>  
  - **OP-SQLite** - React-native çš„ SQLite åº“ - [åœ¨æ­¤é˜…è¯»](https://github.com/OP-Engineering/op-sqlite)
</Prerequisites>


#### ç¬¬ä¸€æ­¥ - ä» Expo æ¨¡æ¿è®¾ç½®é¡¹ç›®
<Npx>
create expo-app --template blank-typescript
</Npx>

æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ](https://docs.expo.dev/more/create-expo/#create-a-new-project) é˜…è¯»æ›´å¤šå…³äºæ­¤æ¨¡æ¿çš„ä¿¡æ¯ã€‚

#### åŸºæœ¬æ–‡ä»¶ç»“æ„

å®‰è£…æ¨¡æ¿å¹¶æ·»åŠ  `db` æ–‡ä»¶å¤¹åï¼Œæ‚¨å°†æ‰¾åˆ°ä»¥ä¸‹å†…å®¹ï¼šåœ¨ `db/schema.ts` æ–‡ä»¶ä¸­çš„ drizzle è¡¨å®šä¹‰ã€‚ `drizzle` æ–‡ä»¶å¤¹åŒ…å« SQL è¿ç§»æ–‡ä»¶å’Œå¿«ç…§

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ assets
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ db
 â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“œ .gitignore
 â”œ ğŸ“œ .npmrc
 â”œ ğŸ“œ app.json
 â”œ ğŸ“œ App.tsx
 â”œ ğŸ“œ babel.config.ts
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

#### ç¬¬äºŒæ­¥ - å®‰è£…æ‰€éœ€åŒ…
<Npm>
  drizzle-orm @op-engineering/op-sqlite
  -D drizzle-kit
</Npm>

#### ç¬¬ä¸‰æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `App.tsx` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```ts
import { open } from '@op-engineering/op-sqlite';
import { drizzle } from 'drizzle-orm/op-sqlite';

const opsqliteDb = open({
  name: 'db',
});

const db = drizzle(opsqliteDb);
```

#### ç¬¬å››æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable("users_table", {
  id: int().primaryKey({ autoIncrement: true }),
  name: text().notNull(),
  age: int().notNull(),
  email: text().notNull().unique(),
});
```

#### ç¬¬äº”æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - è¿™æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”¨äº [Drizzle Kit](/docs/kit-overview)ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'sqlite',
  driver: 'expo',
  schema: './db/schema.ts',
  out: './drizzle',
});
```

#### ç¬¬å…­æ­¥ - è®¾ç½® `metro` é…ç½®

åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `metro.config.js` æ–‡ä»¶å¹¶æ·»åŠ æ­¤ä»£ç ï¼š

```js copy filename="metro.config.js"
const { getDefaultConfig } = require('expo/metro-config');
/** @type {import('expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);
config.resolver.sourceExts.push('sql');
module.exports = config;
```

#### ç¬¬ä¸ƒæ­¥ - æ›´æ–° `babel` é…ç½®
```js copy filename="babel.config.js"
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [["inline-import", { "extensions": [".sql"] }]] // <-- æ·»åŠ è¿™ä¸€è¡Œ
  };
};
```

#### ç¬¬å…«æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

åœ¨ Expo ä¸­ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œå¹¶ä½¿ç”¨ `drizzle-orm` çš„ `migrate()` å‡½æ•°åœ¨è¿è¡Œæ—¶åº”ç”¨å®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š
```bash copy
npx drizzle-kit generate
```

#### ç¬¬ä¹æ­¥ - åº”ç”¨è¿ç§»å¹¶æŸ¥è¯¢æ‚¨çš„æ•°æ®åº“ï¼š

è®©æˆ‘ä»¬åœ¨ **App.tsx** æ–‡ä»¶ä¸­æ·»åŠ è¿ç§»å’ŒæŸ¥è¯¢ä»¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤ç”¨æˆ·

```ts copy
import { Text, View } from 'react-native';
import { open } from '@op-engineering/op-sqlite';
import { useEffect, useState } from 'react';
import { drizzle } from 'drizzle-orm/op-sqlite';
import { usersTable } from './db/schema';
import { useMigrations } from 'drizzle-orm/op-sqlite/migrator';
import migrations from './drizzle/migrations';

const opsqliteDb = open({
  name: 'db',
});

const db = drizzle(opsqliteDb);

export default function App() {
  const { success, error } = useMigrations(db, migrations);
  const [items, setItems] = useState<typeof usersTable.$inferSelect[] | null>(null);

  useEffect(() => {
    if (!success) return;

    (async () => {
      await db.delete(usersTable);

      await db.insert(usersTable).values([
        {
            name: 'John',
            age: 30,
            email: 'john@example.com',
        },
      ]);

      const users = await db.select().from(usersTable);
      setItems(users);
    })();
  }, [success]);

  if (error) {
    return (
      <View>
        <Text>Migration error: {error.message}</Text>
      </View>
    );
  }

  if (!success) {
    return (
      <View>
        <Text>Migration is in progress...</Text>
      </View>
    );
  }

  if (items === null || items.length === 0) {
    return (
      <View>
        <Text>Empty</Text>
      </View>
    );
  }

  return (
    <View
      style={{
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        width: '100%',
        height: '100%',
        justifyContent: 'center',
      }}
    >
      {items.map((item) => (
        <Text key={item.id}>{item.email}</Text>
      ))}
    </View>
  );
}
```

#### ç¬¬åæ­¥ - é¢„æ„å»ºå¹¶è¿è¡Œ Expo åº”ç”¨

<CodeTabs items={['npm', 'yarn', 'pnpm', 'bun']}>
```bash copy
npx expo run:ios
```
```bash copy
yarn expo run:ios
```
```bash copy
pnpm expo run:ios
```
```bash copy
bun expo run:ios
```
</CodeTabs>

Source: https://drizzle.zhcndoc.com/docs/get-started/pglite-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectPgLite from '@mdx/get-started/postgresql/ConnectPgLite.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ PGLite

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **ElectricSQL** - [ç½‘ç«™](https://electric-sql.com/)
  - **pglite é©±åŠ¨** - [æ–‡æ¡£](https://pglite.dev/) å’Œ [GitHub](https://github.com/electric-sql/pglite)
</Prerequisites>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£…æ‰€æœ‰éœ€è¦çš„åŒ…
<InstallPackages lib='@electric-sql/pglite' />

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬å››æ­¥ - ç›´è§‚åŒ–ä½ çš„æ•°æ®åº“

<IntrospectPostgreSQL/>

#### ç¬¬äº”æ­¥ - è½¬ç§»ä»£ç åˆ°ä½ çš„å®é™…æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### ç¬¬å…­æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectPgLite/>

#### ç¬¬ä¸ƒæ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='pglite' env_variable='DATABASE_URL'/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ä¹æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬åæ­¥ - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬åä¸€æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='pglite' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/pglite-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPgLite from '@mdx/get-started/postgresql/ConnectPgLite.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# å¿«é€Ÿå¼€å§‹ Drizzle å’Œ PGlite

<Prerequisites>
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **ElectricSQL** - [å®˜ç½‘](https://electric-sql.com/)
  - **pglite é©±åŠ¨** - [æ–‡æ¡£](https://pglite.dev/) & [GitHub](https://github.com/electric-sql/pglite)
</Prerequisites>

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£…æ‰€æœ‰æ‰€éœ€çš„åŒ…
<InstallPackages lib='@electric-sql/pglite' />

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectPgLite/>

#### æ­¥éª¤ 4 - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable />

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - æ·»åŠ æ•°æ®å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='pglite' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/planetscale-existing

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectPlanetScale from '@mdx/get-started/mysql/ConnectPlanetScale.mdx';
import CreateTable from '@mdx/get-started/mysql/CreateTable.mdx';
import UpdateSchema from '@mdx/get-started/mysql/UpdateSchema.mdx';
import IntrospectMySQL from '@mdx/get-started/mysql/IntrospectMySQL.mdx';
import QueryPlanetScale from '@mdx/get-started/mysql/QueryPlanetScale.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ PlanetScale

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„è½¯ä»¶åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„è½¯ä»¶åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is)
  - **PlanetScale** - MySQL æ•°æ®åº“å¹³å° - [æŸ¥çœ‹è¿™é‡Œ](https://planetscale.com)
  - **database-js** - PlanetScale æ— æœåŠ¡å™¨é©±åŠ¨ - [æŸ¥çœ‹è¿™é‡Œ](https://github.com/planetscale/database-js)
</Prerequisites>

<Callout title='PlanetScale ä¹Ÿæä¾› Postgres' type='info'>
å¯»æ‰¾ PostgreSQLï¼ŸæŸ¥çœ‹æˆ‘ä»¬çš„[PlanetScale Postgres æŒ‡å—](/docs/get-started/planetscale-postgres-existing)
</Callout>

<Callout title='é‡è¦' type='warning'>
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `database-js` é©±åŠ¨ç¨‹åºé€šè¿‡ **HTTP** è°ƒç”¨ PlanetScale æ•°æ®åº“ã€‚å¦‚æœæ‚¨éœ€è¦
é€šè¿‡ TCP è¿æ¥åˆ° PlanetScaleï¼Œæ‚¨å¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ [MySQL å¼€å§‹ä½¿ç”¨](/docs/get-started/mysql-new) é¡µé¢ã€‚
</Callout>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£… **@planetscale/database** è½¯ä»¶åŒ…

<InstallPackages lib='@planetscale/database'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mysql' env_variable='DATABASE_URL'/>

#### ç¬¬å››æ­¥ - å®¡è§†ä½ çš„æ•°æ®åº“

<IntrospectMySQL/>

#### ç¬¬äº”æ­¥ - å°†ä»£ç è½¬ç§»åˆ°ä½ çš„å®é™…æ¶æ„æ–‡ä»¶

<TransferCode/>

#### ç¬¬å…­æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectPlanetScale/>

#### ç¬¬ä¸ƒæ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryPlanetScale />

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ä¹æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¶æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬åæ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### ç¬¬åä¸€æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/planetscale-serverless';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle({ connection: {
      host: process.env.DATABASE_HOST!,
      username: process.env.DATABASE_USERNAME!,
      password: process.env.DATABASE_PASSWORD!,
    }});

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```


Source: https://drizzle.zhcndoc.com/docs/get-started/planetscale-new

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectPlanetScale from '@mdx/get-started/mysql/ConnectPlanetScale.mdx';
import CreateTable from '@mdx/get-started/mysql/CreateTable.mdx';
import QueryPlanetScale from '@mdx/get-started/mysql/QueryPlanetScale.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ PlanetScale

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://tsx.is)
  - **PlanetScale** - MySQL æ•°æ®åº“å¹³å° - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://planetscale.com)
  - **database-js** - PlanetScale æ— æœåŠ¡å™¨é©±åŠ¨ç¨‹åº - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://github.com/planetscale/database-js)
</Prerequisites>

<Callout title='PlanetScale åŒæ—¶æ”¯æŒ Postgres' type='info'>
å¯»æ‰¾ PostgreSQL ç›¸å…³å†…å®¹ï¼Ÿè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [PlanetScale Postgres æŒ‡å—](/docs/get-started/planetscale-postgres-new)
</Callout>

<Callout title='é‡è¦' type='warning'>
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `database-js` é©±åŠ¨ç¨‹åºé€šè¿‡ **HTTP** è°ƒç”¨ PlanetScale æ•°æ®åº“ã€‚å¦‚æœæ‚¨éœ€è¦é€šè¿‡ TCP è¿æ¥åˆ° PlanetScaleï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ [MySQL å…¥é—¨](/docs/get-started/mysql-new) é¡µé¢ã€‚
</Callout>

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **@planetscale/database** åŒ…

<InstallPackages lib='@planetscale/database'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ æ‚¨çš„æ•°æ®åº“è¿æ¥å˜é‡ï¼š

```plaintext copy
DATABASE_HOST=
DATABASE_USERNAME=
DATABASE_PASSWORD=
```

<Callout title='æç¤º'>
è¦è·å–é€šè¿‡ `database-js` é©±åŠ¨ç¨‹åºè¿æ¥æ‰€éœ€çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œè¯·æŸ¥çœ‹ [PlanetScale æ–‡æ¡£](https://planetscale.com/docs/tutorials/planetscale-serverless-driver-node-example#use-the-sample-repository)
</Callout>

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectPlanetScale/>

#### æ­¥éª¤ 4 - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mysql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - ç§å­æ•°æ®å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryPlanetScale />

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/planetscale-postgres-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectPlanetScalePostgres from '@mdx/get-started/postgresql/ConnectPlanetScalePostgres.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ PlanetScale Postgres

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://tsx.is/)
  - **PlanetScale Postgres** - PostgreSQL æ•°æ®åº“å¹³å° - [ç‚¹å‡»é˜…è¯»](https://planetscale.com/docs/postgres)
  - **node-postgres** - ç”¨äºæŸ¥è¯¢æ‚¨çš„ PostgreSQL æ•°æ®åº“çš„åŒ… - [ç‚¹å‡»é˜…è¯»](https://node-postgres.com/)
</Prerequisites>

<Callout title='PlanetScale è¿˜æä¾› MySQL' type='info'>
å¯»æ‰¾ MySQLï¼Ÿè¯·æŸ¥çœ‹æˆ‘ä»¬çš„[PlanetScale MySQL æŒ‡å—](/docs/get-started/planetscale-existing)
</Callout>

PlanetScale åŒæ—¶æä¾› MySQLï¼ˆVitessï¼‰å’Œ PostgreSQL æ•°æ®åº“ã€‚æœ¬æŒ‡å—æ¶µç›–ä½¿ç”¨æ ‡å‡†çš„ `node-postgres` é©±åŠ¨è¿æ¥ PlanetScale Postgresã€‚

æœ‰å…³åˆ›å»º PlanetScale Postgres æ•°æ®åº“å’Œè·å–å‡­è¯çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚è§[PlanetScale Postgres æ–‡æ¡£](https://planetscale.com/docs/postgres/tutorials/planetscale-postgres-drizzle)ã€‚

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **node-postgres** åŒ…
<InstallPackages lib='pg' devlib=' @types/pg'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ æ‚¨çš„æ•°æ®åº“è¿æ¥å˜é‡ï¼š

```plaintext copy
DATABASE_URL=postgresql://{username}:{password}@{host}:{port}/postgres?sslmode=verify-full
```

<Callout title='æç¤º'>
æ‚¨å¯ä»¥é€šè¿‡ PlanetScale æ§åˆ¶é¢æ¿è¿›å…¥æ‚¨çš„æ•°æ®åº“ï¼Œç‚¹å‡» **â€œè¿æ¥â€**ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª **â€œé»˜è®¤è§’è‰²â€** æ¥è·å–è¿æ¥å‡­è¯ã€‚è¯¦è§[PlanetScale è¿æ¥æŒ‡å—](https://planetscale.com/docs/postgres/tutorials/planetscale-postgres-drizzle#create-credentials-and-connect)ã€‚
</Callout>

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬ 4 æ­¥ - åå‘æ¨æ–­æ•°æ®åº“ç»“æ„

<IntrospectPostgreSQL/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»è‡³æ‚¨çš„å®é™… schema æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectPlanetScalePostgres/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='node-postgres' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - åº”ç”¨æ›´æ”¹åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='node-postgres' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/planetscale-postgres-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPlanetScalePostgres from '@mdx/get-started/postgresql/ConnectPlanetScalePostgres.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ PlanetScale Postgres

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **PlanetScale Postgres** - PostgreSQL æ•°æ®åº“å¹³å° - [æŸ¥çœ‹è¿™é‡Œ](https://planetscale.com/docs/postgres)
  - **node-postgres** - ç”¨äºæŸ¥è¯¢ PostgreSQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://node-postgres.com/)
</Prerequisites>

<Callout title='PlanetScale åŒæ—¶æ”¯æŒ MySQL' type='info'>
åœ¨æ‰¾ MySQL å—ï¼ŸæŸ¥çœ‹æˆ‘ä»¬çš„[PlanetScale MySQL æŒ‡å—](/docs/get-started/planetscale-new)
</Callout>

PlanetScale åŒæ—¶æä¾› MySQLï¼ˆVitessï¼‰å’Œ PostgreSQL æ•°æ®åº“ã€‚æœ¬æŒ‡å—æ¶µç›–å¦‚ä½•ä½¿ç”¨æ ‡å‡†çš„ `node-postgres` é©±åŠ¨è¿æ¥ PlanetScale Postgresã€‚

å…³äºå¦‚ä½•åˆ›å»º PlanetScale Postgres æ•°æ®åº“å’Œè·å–å‡­è¯çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚é˜…[PlanetScale Postgres æ–‡æ¡£](https://planetscale.com/docs/postgres/tutorials/planetscale-postgres-drizzle)ã€‚

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£… **node-postgres** åŒ…
<InstallPackages lib='pg' devlib=' @types/pg'/>

#### æ­¥éª¤ 2 - é…ç½®è¿æ¥å˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `.env` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ æ•°æ®åº“è¿æ¥å˜é‡ï¼š

```plaintext copy
DATABASE_URL=postgresql://{username}:{password}@{host}:{port}/postgres?sslmode=verify-full
```

<Callout title='æç¤º'>
ä½ å¯ä»¥é€šè¿‡è®¿é—® PlanetScale ä»ªè¡¨æ¿ï¼Œè¿›å…¥ä½ çš„æ•°æ®åº“ï¼Œç‚¹å‡» **â€œConnectâ€** å¹¶åˆ›å»º **â€œDefault roleâ€** æ¥è·å–è¿æ¥å‡­è¯ã€‚è¯¦ç»†æ­¥éª¤è¯·å‚é˜…[PlanetScale è¿æ¥æŒ‡å—](https://planetscale.com/docs/postgres/tutorials/planetscale-postgres-drizzle#create-credentials-and-connect)ã€‚
</Callout>

#### æ­¥éª¤ 3 - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectPlanetScalePostgres/>

#### æ­¥éª¤ 4 - åˆ›å»ºæ•°æ®è¡¨

<CreateTable />

#### æ­¥éª¤ 5 - é…ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 6 - åº”ç”¨æ•°æ®åº“å˜æ›´

<ApplyChanges />

#### æ­¥éª¤ 7 - æ•°æ®åº“ç§å­å’ŒæŸ¥è¯¢

<QueryDatabase dialect='node-postgres' env_variable='DATABASE_URL'/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/postgresql-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectPostgreSQL from '@mdx/get-started/postgresql/ConnectPostgreSQL.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ PostgreSQL

<Prerequisites>
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **node-postgres** - ç”¨äºæŸ¥è¯¢ PostgreSQL æ•°æ®åº“çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://node-postgres.com/)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **node-postgres** åŒ…
<InstallPackages lib='pg' devlib=' @types/pg'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

<Callout title='æç¤º'>
å¦‚æœæ‚¨è¿˜æ²¡æœ‰ PostgreSQL æ•°æ®åº“å¹¶æƒ³åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•ï¼Œæ‚¨å¯ä»¥å‚è€ƒæˆ‘ä»¬çš„æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åœ¨ Docker ä¸­è®¾ç½® PostgreSQLã€‚

Docker ä¸­çš„ PostgreSQL æŒ‡å—å¯åœ¨ [è¿™é‡Œ](/docs/guides/postgresql-local-setup) è·å–ã€‚å»è®¾ç½®å®ƒï¼Œç”Ÿæˆæ•°æ®åº“ URLï¼ˆåœ¨æŒ‡å—ä¸­æœ‰è¯´æ˜ï¼‰ï¼Œç„¶åå›æ¥è¿›è¡Œä¸‹ä¸€æ­¥ã€‚
</Callout>

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬ 4 æ­¥ - ç›´è§‚æ£€æŸ¥æ‚¨çš„æ•°æ®åº“

<IntrospectPostgreSQL/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°æ‚¨çš„å®é™…æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectPostgreSQL/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='node-postgres' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°æ‚¨çš„è¡¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='node-postgres' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/postgresql-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectPostgreSQL from '@mdx/get-started/postgresql/ConnectPostgreSQL.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ PostgreSQL å¼€å§‹

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://tsx.is/)
  - **node-postgres** - æŸ¥è¯¢ PostgreSQL æ•°æ®åº“çš„åŒ… - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://node-postgres.com/)
</Prerequisites>

Drizzle å¯¹ `node-postgres` å’Œ `postgres.js` é©±åŠ¨ç¨‹åºçš„ PostgreSQL è¿æ¥æä¾›åŸç”Ÿæ”¯æŒã€‚

æˆ‘ä»¬å°†åœ¨è¿™ä¸ªå…¥é—¨ç¤ºä¾‹ä¸­ä½¿ç”¨ `node-postgres`ã€‚ä½†å¦‚æœä½ æƒ³æ‰¾åˆ°æ›´å¤šè¿æ¥ PostgreSQL çš„æ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ä»¬çš„ [PostgreSQL è¿æ¥](/docs/get-started-postgresql) é¡µé¢ã€‚

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **node-postgres** åŒ…
<InstallPackages lib='pg' devlib=' @types/pg'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

<Callout title='æç¤º'>
å¦‚æœä½ è¿˜æ²¡æœ‰ PostgreSQL æ•°æ®åº“å¹¶æƒ³åˆ›å»ºä¸€ä¸ªè¿›è¡Œæµ‹è¯•ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ‘ä»¬çš„æŒ‡å—ï¼Œäº†è§£å¦‚ä½•åœ¨ Docker ä¸­è®¾ç½® PostgreSQLã€‚

Docker ä¸­çš„ PostgreSQL è®¾ç½®æŒ‡å—å¯ä»¥åœ¨ [è¿™é‡Œ](/docs/guides/postgresql-local-setup) æ‰¾åˆ°ã€‚å»è®¾ç½®å®ƒï¼Œç”Ÿæˆä¸€ä¸ªæ•°æ®åº“ URLï¼ˆåœ¨æŒ‡å—ä¸­æœ‰è¯´æ˜ï¼‰ï¼Œç„¶åå›æ¥è¿›è¡Œä¸‹ä¸€æ­¥ã€‚
</Callout>

#### ç¬¬ 3 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectPostgreSQL/>

#### ç¬¬ 4 æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable />

#### ç¬¬ 5 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬ 6 æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### ç¬¬ 7 æ­¥ - å‘æ•°æ®åº“å¡«å……æ•°æ®å¹¶æŸ¥è¯¢

<QueryDatabase dialect='node-postgres' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/singlestore-existing

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectSingleStore from '@mdx/get-started/singlestore/ConnectSingleStore.mdx';
import UpdateSchema from '@mdx/get-started/singlestore/UpdateSchema.mdx';
import IntrospectSingleStore from '@mdx/get-started/singlestore/IntrospectSingleStore.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';

<Breadcrumbs/>

# Get Started with Drizzle and SingleStore in existing project

<Prerequisites>  
  - **dotenv** - package for managing environment variables - [read here](https://www.npmjs.com/package/dotenv)
  - **tsx** - package for running TypeScript files - [read here](https://tsx.is/)
  - **mysql2** - package for querying your SingleStore database - [read here](https://github.com/sidorares/node-mysql2)
</Prerequisites>

<FileStructure/>

#### Step 1 - Install the `mysql2` package

<InstallPackages lib='mysql2'/>

#### Step 2 - Setup connection variables

<SetupEnv env_variable='DATABASE_URL' />

#### Step 3 - Setup Drizzle config file

<SetupConfig dialect='singlestore' env_variable='DATABASE_URL'/>

#### Step 4 - Introspect your database

<IntrospectSingleStore/>

#### Step 5 - Transfer code to your actual schema file

<TransferCode/>

#### Step 6 - Connect Drizzle ORM to the database

<ConnectSingleStore/>

#### Step 7 - Query the database

<QueryDatabase dialect='singlestore' env_variable='DATABASE_URL'/>

#### Step 8 - Run index.ts file

<RunFile/>

#### Step 9 - Update your table schema (optional)

<UpdateSchema/>

#### Step 10 - Applying changes to the database (optional)

<ApplyChanges/>

#### Step 11 - Query the database with a new field (optional)

<QueryDatabaseUpdated dialect='singlestore' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/singlestore-new

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectSingleStore from '@mdx/get-started/singlestore/ConnectSingleStore.mdx';
import CreateSingleStoreTable from '@mdx/get-started/singlestore/CreateSingleStoreTable.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ SingleStore å…¥é—¨

<Prerequisites>  
  - **dotenv** â€”â€” ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… â€”â€” [ç‚¹å‡»æŸ¥çœ‹](https://www.npmjs.com/package/dotenv)
  - **tsx** â€”â€” ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… â€”â€” [ç‚¹å‡»æŸ¥çœ‹](https://tsx.is/)
  - **mysql2** â€”â€” ç”¨äºæŸ¥è¯¢ MySQL æ•°æ®åº“çš„åŒ… â€”â€” [ç‚¹å‡»æŸ¥çœ‹](https://github.com/sidorares/node-mysql2)
</Prerequisites>

è¦å°† Drizzle ç”¨äº SingleStore æ•°æ®åº“ï¼Œæ‚¨åº”ä½¿ç”¨ `singlestore` é©±åŠ¨ã€‚

æ ¹æ® **[å®˜æ–¹ç½‘ç«™](https://github.com/sidorares/node-mysql2)**ï¼Œ  
`mysql2` æ˜¯ä¸€ä¸ªä¸“æ³¨äºæ€§èƒ½çš„ Node.js MySQL å®¢æˆ·ç«¯ã€‚

Drizzle ORM åŸç”Ÿæ”¯æŒ `mysql2`ï¼Œå¹¶æä¾›äº†ç”¨äº SingleStore æ•°æ®åº“çš„ `drizzle-orm/singlestore` åŒ…ã€‚

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **mysql2** åŒ…

<InstallPackages lib='mysql2'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ 3 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectSingleStore/>

#### ç¬¬ 4 æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateSingleStoreTable/>

#### ç¬¬ 5 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='singlestore' env_variable='DATABASE_URL'/>

#### ç¬¬ 6 æ­¥ - åº”ç”¨æ•°æ®åº“æ›´æ”¹

<ApplyChanges />

#### ç¬¬ 7 æ­¥ - å¡«å……å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='singlestore' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/sqlite-cloud-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectSQLite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectSQLiteCloud from '@mdx/get-started/sqlite/ConnectSQLiteCloud.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ SQLite Cloud å…¥é—¨

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»æŸ¥çœ‹](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»æŸ¥çœ‹](https://tsx.is/)
  - **SQLite Cloud æ•°æ®åº“** - [ç‚¹å‡»æŸ¥çœ‹](https://docs.sqlitecloud.io/docs/overview)
  - **SQLite Cloud é©±åŠ¨** - [ç‚¹å‡»æŸ¥çœ‹](https://docs.sqlitecloud.io/docs/sdk-js-introduction) & [GitHub](https://github.com/sqlitecloud/sqlitecloud-js)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£…æ‰€éœ€åŒ…
<Npm>
  drizzle-orm@beta @sqlitecloud/drivers dotenv
  -D drizzle-kit@beta tsx
</Npm>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='SQLITE_CLOUD_CONNECTION_STRING' />

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='SQLITE_CLOUD_CONNECTION_STRING'/>

#### ç¬¬ 4 æ­¥ - åå‘åˆ†ææ•°æ®åº“

<IntrospectSQLite/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°å®é™…çš„ schema æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectSQLiteCloud/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/sqlite-cloud';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»º!')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°!')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤!')
}

main();
```

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/sqlite-cloud';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»º!')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°!')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤!')
}

main();
```

Source: https://drizzle.zhcndoc.com/docs/get-started/sqlite-cloud-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectSQLiteCloud from '@mdx/get-started/sqlite/ConnectSQLiteCloud.mdx'
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ SQLite Cloud å¿«é€Ÿå¼€å§‹

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **SQLite Cloud æ•°æ®åº“** - [æŸ¥çœ‹è¿™é‡Œ](https://docs.sqlitecloud.io/docs/overview)
  - **SQLite Cloud é©±åŠ¨** - [æŸ¥çœ‹è¿™é‡Œ](https://docs.sqlitecloud.io/docs/sdk-js-introduction) & [GitHub](https://github.com/sqlitecloud/sqlitecloud-js)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£…æ‰€éœ€åŒ…
<Npm>
  drizzle-orm@beta @sqlitecloud/drivers dotenv
  -D drizzle-kit@beta tsx
</Npm>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='SQLITE_CLOUD_CONNECTION_STRING' />

#### ç¬¬ 3 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectSQLiteCloud/>

#### ç¬¬ 4 æ­¥ - åˆ›å»ºæ•°æ®è¡¨

<CreateTable />

#### ç¬¬ 5 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='SQLITE_CLOUD_CONNECTION_STRING'/>

#### ç¬¬ 6 æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´

<ApplyChanges />

#### ç¬¬ 7 æ­¥ - å¡«å……å¹¶æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/sqlite-cloud';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('å·²åˆ›å»ºæ–°ç”¨æˆ·ï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/sqlite-existing

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import IntrospectSqlite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ SQLite å¼€å§‹

<Prerequisites>  
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„è½¯ä»¶åŒ… - [äº†è§£æ›´å¤š](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„è½¯ä»¶åŒ… - [äº†è§£æ›´å¤š](https://tsx.is/)
  - **libsql** - ä¸€ä¸ªé’ˆå¯¹ä½æŸ¥è¯¢å»¶è¿Ÿè¿›è¡Œä¼˜åŒ–çš„ SQLite åˆ†æ”¯ï¼Œé€‚åˆå…¨çƒåº”ç”¨ - [äº†è§£æ›´å¤š](https://docs.turso.tech/libsql)
</Prerequisites>

<FileStructure />

#### ç¬¬ 1 æ­¥ - å®‰è£…æ‰€éœ€çš„è½¯ä»¶åŒ…

<InstallPackages lib='@libsql/client'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DB_FILE_NAME' />

<Callout type='info' title='é‡è¦'>
ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª SQLite æ•°æ®åº“æ–‡ä»¶ç”¨äºæµ‹è¯•ï¼Œä½ éœ€è¦åœ¨å®é™…æ–‡ä»¶åä¹‹å‰ä½¿ç”¨ `file:`ï¼Œå› ä¸ºè¿™æ˜¯ `LibSQL` æ‰€éœ€çš„æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```plaintext copy
DB_FILE_NAME=file:local.db
```
ä½ å¯ä»¥æŸ¥çœ‹ **[LibSQL æ–‡æ¡£](https://docs.turso.tech/sdk/ts/reference#local-development)** è·å–æ›´å¤šä¿¡æ¯ã€‚
</Callout>

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='DB_FILE_NAME'/>

#### ç¬¬ 4 æ­¥ - æ£€æŸ¥ä½ çš„æ•°æ®åº“

<IntrospectSqlite/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°ä½ çš„å®é™…æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectLibsql/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='libsql' env_variable='DB_FILE_NAME' />

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - åœ¨æ•°æ®åº“ä¸­åº”ç”¨æ›´æ”¹ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='libsql' env_variable='DB_FILE_NAME' />

Source: https://drizzle.zhcndoc.com/docs/get-started/sqlite-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ SQLite

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **libsql** - é’ˆå¯¹ä½æŸ¥è¯¢å»¶è¿Ÿä¼˜åŒ–çš„ SQLite åˆ†æ”¯ï¼Œä½¿å…¶é€‚åˆå…¨çƒåº”ç”¨ - [é˜…è¯»è¿™é‡Œ](https://docs.turso.tech/libsql)
</Prerequisites>

Drizzle å¯¹ `libsql` å’Œ `better-sqlite3` é©±åŠ¨ç¨‹åºçš„ SQLite è¿æ¥æä¾›åŸç”Ÿæ”¯æŒã€‚

æˆ‘ä»¬å°†åœ¨è¿™ä¸ªå…¥é—¨ç¤ºä¾‹ä¸­ä½¿ç”¨ `libsql`ã€‚ä½†æ˜¯å¦‚æœæƒ³äº†è§£æ›´å¤šè¿æ¥ SQLite çš„æ–¹å¼ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [SQLite è¿æ¥](/docs/get-started-sqlite) é¡µé¢ã€‚

<FileStructure />

#### ç¬¬ä¸€æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…
<InstallPackages lib='@libsql/client'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DB_FILE_NAME' />

<Callout type='info' title='é‡è¦'>
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª SQLite æ•°æ®åº“æ–‡ä»¶ä»¥è¿›è¡Œæµ‹è¯•ï¼Œæ‚¨éœ€è¦åœ¨å®é™…æ–‡ä»¶åä¹‹å‰ä½¿ç”¨ `file:`ï¼Œè¿™æ˜¯ `LibSQL` è¦æ±‚çš„æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```plaintext copy
DB_FILE_NAME=file:local.db
```
æ‚¨å¯ä»¥æŸ¥çœ‹ **[LibSQL æ–‡æ¡£](https://docs.turso.tech/sdk/ts/reference#local-development)** ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚
</Callout>

#### ç¬¬ä¸‰æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectLibsql/>

#### ç¬¬å››æ­¥ - åˆ›å»ºè¡¨

<CreateTable/>

#### ç¬¬äº”æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='DB_FILE_NAME'/>

#### ç¬¬å…­æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### ç¬¬ä¸ƒæ­¥ - å¡«å……å’ŒæŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='libsql' env_variable='DB_FILE_NAME'/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/supabase-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectSupabase from '@mdx/get-started/postgresql/ConnectSupabase.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Supabase

<Prerequisites>
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **Supabase** - å¼€æºçš„ Firebase æ›¿ä»£æ–¹æ¡ˆ - [é˜…è¯»è¿™é‡Œ](https://supabase.com/)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **postgres** åŒ…
<InstallPackages lib='postgres'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬ 4 æ­¥ - å†…çœä½ çš„æ•°æ®åº“

<IntrospectPostgreSQL/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°ä½ çš„å®é™…æ¶æ„æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectSupabase/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='postgres-js' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¶æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='postgres-js' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/supabase-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectSupabase from '@mdx/get-started/postgresql/ConnectSupabase.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Supabase

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://tsx.is/)
  - **Supabase** - å¼€æºçš„ Firebase æ›¿ä»£å“ - [åœ¨è¿™é‡Œé˜…è¯»](https://supabase.com/)
</Prerequisites>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£… **postgres** åŒ…
<InstallPackages lib='postgres'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ä¸‰æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectSupabase/>

#### ç¬¬å››æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable />

#### ç¬¬äº”æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬å…­æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### ç¬¬ä¸ƒæ­¥ - å¡«å……å’ŒæŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='postgres-js' env_variable='DATABASE_URL'/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/tidb-existing

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectTiDB from '@mdx/get-started/mysql/ConnectTiDB.mdx';
import CreateTable from '@mdx/get-started/mysql/CreateTable.mdx';
import UpdateSchema from '@mdx/get-started/mysql/UpdateSchema.mdx';
import IntrospectMySQL from '@mdx/get-started/mysql/IntrospectMySQL.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ TiDB

<Prerequisites>  
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [è¯¦ç»†é˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - ç”¨äºè¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [è¯¦ç»†é˜…è¯»](https://tsx.is/)
  - **TiDB** - PingCAP æä¾›çš„åˆ†å¸ƒå¼ SQL æ•°æ®åº“ - [è¯¦ç»†é˜…è¯»](https://www.pingcap.com/)
  - **serverless-js** - ç”¨äºéœ€è¦ HTTP å¤–éƒ¨è¿æ¥çš„æ— æœåŠ¡å™¨å’Œè¾¹ç¼˜è®¡ç®—å¹³å°çš„åŒ… - [è¯¦ç»†é˜…è¯»](https://github.com/tidbcloud/serverless-js)
</Prerequisites>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£… **@tidbcloud/serverless** åŒ…

<InstallPackages lib='@tidbcloud/serverless'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mysql' env_variable='DATABASE_URL'/>

#### ç¬¬å››æ­¥ - åå‘å·¥ç¨‹æ•°æ®åº“

<IntrospectMySQL/>

#### ç¬¬äº”æ­¥ - å°†ä»£ç è½¬ç§»åˆ°å®é™…çš„æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### ç¬¬å…­æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectTiDB/>

#### ç¬¬ä¸ƒæ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='tidb-serverless' env_variable='DATABASE_URL'/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ä¹æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬åæ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### ç¬¬åä¸€æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='tidb-serverless' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/tidb-new

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import ConnectTiDB from '@mdx/get-started/mysql/ConnectTiDB.mdx';
import CreateTable from '@mdx/get-started/mysql/CreateTable.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ TiDB

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **TiDB** - PingCAP çš„åˆ†å¸ƒå¼ SQL æ•°æ®åº“ - [æŸ¥çœ‹è¿™é‡Œ](https://www.pingcap.com/)
  - **serverless-js** - ç”¨äºéœ€è¦ HTTP å¤–éƒ¨è¿æ¥çš„æ— æœåŠ¡å™¨å’Œè¾¹ç¼˜è®¡ç®—å¹³å°çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://github.com/tidbcloud/serverless-js)
</Prerequisites>

<Callout title='é‡è¦' type='warning'>
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `@tidbcloud/serverless` é©±åŠ¨ç¨‹åºè¿›è¡Œ **HTTP** è°ƒç”¨ã€‚å¦‚æœæ‚¨éœ€è¦é€šè¿‡ TCP è¿æ¥åˆ° TiDBï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ [MySQL å¼€å§‹ä½¿ç”¨](/docs/get-started/mysql-new) é¡µé¢
</Callout>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£… **@tidbcloud/serverless** åŒ…

<InstallPackages lib='@tidbcloud/serverless'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

#### ç¬¬ä¸‰æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectTiDB/>

#### ç¬¬å››æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### ç¬¬äº”æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='mysql' env_variable='DATABASE_URL'/>

#### ç¬¬å…­æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### ç¬¬ä¸ƒæ­¥ - å¡«å……å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='tidb-serverless' env_variable='DATABASE_URL'/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/turso-database-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectSQLite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectTursoDatabase from '@mdx/get-started/sqlite/ConnectTursoDatabase.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Turso æ•°æ®åº“

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [ç‚¹å‡»æŸ¥çœ‹](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [ç‚¹å‡»æŸ¥çœ‹](https://tsx.is/)
  - Turso æ•°æ®åº“ - [å®˜ç½‘](https://docs.turso.tech/introduction)
  - Turso æ•°æ®åº“é©±åŠ¨ - [å®˜ç½‘](https://docs.turso.tech/connect/javascript) & [GitHub](https://github.com/tursodatabase/turso/tree/main/bindings/javascript)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…
<Npm>
  drizzle-orm@beta @tursodatabase/database dotenv
  -D drizzle-kit@beta tsx
</Npm>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DB_FILE_NAME' />

<Callout type='info' title='é‡è¦'>
ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„ SQLite æ•°æ®åº“æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ç¤ºä¾‹ï¼š
```plaintext copy
DB_FILE_NAME=mydb.sqlite
```
</Callout>

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='DB_FILE_NAME'/>

#### ç¬¬ 4 æ­¥ - åå°„æ•°æ®åº“ç»“æ„

<IntrospectSQLite/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è½¬ç§»åˆ°ä½ å®é™…çš„ schema æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectTursoDatabase/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/tursodatabase/database';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°ä½ çš„è¡¨ç»“æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/tursodatabase/database';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

Source: https://drizzle.zhcndoc.com/docs/get-started/turso-database-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectTursoDatabase from '@mdx/get-started/sqlite/ConnectTursoDatabase.mdx'
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Turso æ•°æ®åº“å¿«é€Ÿå…¥é—¨

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¯¦æƒ…](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¯¦æƒ…](https://tsx.is/)
  - Turso æ•°æ®åº“ - [å®˜ç½‘](https://docs.turso.tech/introduction)
  - Turso æ•°æ®åº“é©±åŠ¨ - [å®˜ç½‘](https://docs.turso.tech/connect/javascript) & [GitHub](https://github.com/tursodatabase/turso/tree/main/bindings/javascript)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…
<Npm>
  drizzle-orm@beta @tursodatabase/database dotenv
  -D drizzle-kit@beta tsx
</Npm>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DB_FILE_NAME' />

<Callout type='info' title='é‡è¦æç¤º'>
ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„ SQLite æ•°æ®åº“æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ç¤ºä¾‹ï¼š
```plaintext copy
DB_FILE_NAME=mydb.sqlite
```
</Callout>

#### ç¬¬ 3 æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectTursoDatabase/>

#### ç¬¬ 4 æ­¥ - åˆ›å»ºæ•°æ®è¡¨

<CreateTable />

#### ç¬¬ 5 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='sqlite' env_variable='DB_FILE_NAME'/>

#### ç¬¬ 6 æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### ç¬¬ 7 æ­¥ - åˆå§‹åŒ–æ•°æ®å¹¶æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/tursodatabase/database';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–çš„æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/turso-existing

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import IntrospectSqlite from '@mdx/get-started/sqlite/IntrospectSqlite.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';
import UpdateSchema from '@mdx/get-started/sqlite/UpdateSchema.mdx';
import QueryTurso from '@mdx/get-started/sqlite/QueryTurso.mdx';
import QueryTursoUpdated from '@mdx/get-started/sqlite/QueryTursoUpdated.mdx';
import LibsqlTable from '@mdx/LibsqlTable.mdx';
import LibsqlTabs from '@mdx/LibsqlTabs.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Drizzle å’Œ Turso å¼€å§‹

<Prerequisites>  
  - **dotenv** - ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **turso** - ç”Ÿäº§ç¯å¢ƒä¸­çš„ SQLite - [é˜…è¯»è¿™é‡Œ](https://turso.tech/)
  - **libsql** - æ€§èƒ½ä¼˜åŒ–çš„ SQLite åˆ†æ”¯ï¼Œé€‚åˆå…¨çƒåº”ç”¨ - [é˜…è¯»è¿™é‡Œ](https://docs.turso.tech/libsql)
</Prerequisites>

<FileStructure />

#### ç¬¬ä¸€æ­¥ - å®‰è£…æ‰€éœ€çš„åŒ…

<InstallPackages lib='@libsql/client'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä½ çš„ Turso æ•°æ®åº“ URL å’Œè®¤è¯ä»¤ç‰Œï¼š

```plaintext copy
TURSO_DATABASE_URL=
TURSO_AUTH_TOKEN=
```

<Callout type='info' title='é‡è¦'>
å¦‚æœä½ ä¸çŸ¥é“ä½ çš„ `TURSO_DATABASE_URL` å’Œ `TURSO_AUTH_TOKEN` å€¼ï¼Œå¯ä»¥å‚è€ƒ LibSQL Driver SDK æ•™ç¨‹ã€‚ 
æŸ¥çœ‹ [è¿™é‡Œ](https://docs.turso.tech/sdk/ts/quickstart)ï¼Œå®Œæˆåå†å›æ¥å°†æ‰€æœ‰ç”Ÿæˆçš„å€¼æ·»åŠ åˆ° `.env` æ–‡ä»¶ä¸­
</Callout>

#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”¨äº [Drizzle Kit](/docs/kit-overview) çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«ä½ çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'turso',
  dbCredentials: {
    url: process.env.TURSO_DATABASE_URL,
    authToken: process.env.TURSO_AUTH_TOKEN,
  },
});
```

#### ç¬¬å››æ­¥ - åå‘å·¥ç¨‹ä½ çš„æ•°æ®åº“

<IntrospectSqlite/>

#### ç¬¬äº”æ­¥ - å°†ä»£ç è½¬ç§»åˆ°ä½ çš„å®é™…æ¨¡å¼æ–‡ä»¶

<TransferCode/>

#### ç¬¬å…­æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“
Drizzle åŸç”Ÿæ”¯æŒæ‰€æœ‰ @libsql/client é©±åŠ¨ç¨‹åºå˜ä½“ï¼š

<LibsqlTable />
<br/>
<LibsqlTabs />

åœ¨ `src` ç›®å½•åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/libsql';

// ä½ å¯ä»¥æŒ‡å®š libsql è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db = drizzle({ 
  connection: { 
    url: process.env.TURSO_DATABASE_URL!, 
    authToken: process.env.TURSO_AUTH_TOKEN!
  }
});
```

å¦‚æœæ‚¨éœ€è¦æä¾›æ‚¨ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š

```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/libsql';
import { createClient } from '@libsql/client';

const client = createClient({ 
  url: process.env.TURSO_DATABASE_URL!, 
  authToken: process.env.TURSO_AUTH_TOKEN!
});

const db = drizzle({ client });
```

#### ç¬¬ä¸ƒæ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryTurso/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ä¹æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¨¡å¼ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ä¹æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges/>

#### ç¬¬åæ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryTursoUpdated />

Source: https://drizzle.zhcndoc.com/docs/get-started/turso-new

import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import QueryTurso from '@mdx/get-started/sqlite/QueryTurso.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import CreateTable from '@mdx/get-started/sqlite/CreateTable.mdx';
import ConnectLibsql from '@mdx/get-started/sqlite/ConnectLibsql.mdx';
import LibsqlTable from '@mdx/LibsqlTable.mdx';
import LibsqlTabs from '@mdx/LibsqlTabs.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Turso å¼€å§‹

<Prerequisites>  
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [åœ¨è¿™é‡Œé˜…è¯»](https://tsx.is/)
  - **turso** - ç”¨äºç”Ÿäº§çš„ SQLite - [åœ¨è¿™é‡Œé˜…è¯»](https://turso.tech/)
  - **libsql** - ä¼˜åŒ–äº†ä½æŸ¥è¯¢å»¶è¿Ÿçš„ SQLite åˆ†æ”¯ï¼Œé€‚åˆå…¨çƒåº”ç”¨ - [åœ¨è¿™é‡Œé˜…è¯»](https://docs.turso.tech/libsql)
</Prerequisites>

<FileStructure />

#### æ­¥éª¤ 1 - å®‰è£…æ‰€éœ€çš„åŒ…
<InstallPackages lib='@libsql/client'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä½ çš„ Turso æ•°æ®åº“ URL å’Œæˆæƒä»¤ç‰Œï¼š

```plaintext copy
TURSO_DATABASE_URL=
TURSO_AUTH_TOKEN=
```

<Callout type='info' title='é‡è¦'>
å¦‚æœä½ ä¸çŸ¥é“ `TURSO_DATABASE_URL` å’Œ `TURSO_AUTH_TOKEN` çš„å€¼ï¼Œå¯ä»¥å‚è€ƒ LibSQL é©±åŠ¨ SDK æ•™ç¨‹ã€‚ 
æŸ¥çœ‹ [è¿™é‡Œ](https://docs.turso.tech/sdk/ts/quickstart)ï¼Œç„¶åå¸¦ç€ç”Ÿæˆçš„æ‰€æœ‰å€¼è¿”å›å¹¶æ·»åŠ åˆ° `.env` æ–‡ä»¶ä¸­
</Callout>

#### æ­¥éª¤ 3 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“
Drizzle åŸç”Ÿæ”¯æŒæ‰€æœ‰ @libsql/client é©±åŠ¨ç¨‹åºå˜ä½“ï¼š

<LibsqlTable />
<br/>
<LibsqlTabs />

åœ¨ `src` ç›®å½•åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶åˆå§‹åŒ–è¿æ¥ï¼š

```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/libsql';

// ä½ å¯ä»¥æŒ‡å®š libsql è¿æ¥é€‰é¡¹ä¸­çš„ä»»ä½•å±æ€§
const db = drizzle({ 
  connection: { 
    url: process.env.TURSO_DATABASE_URL!, 
    authToken: process.env.TURSO_AUTH_TOKEN!
  }
});
```

å¦‚æœæ‚¨éœ€è¦æä¾›æ‚¨ç°æœ‰çš„é©±åŠ¨ç¨‹åºï¼š
```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/libsql';
import { createClient } from '@libsql/client';

const client = createClient({ 
  url: process.env.TURSO_DATABASE_URL!, 
  authToken: process.env.TURSO_AUTH_TOKEN!
});
const db = drizzle({ client });
```

#### æ­¥éª¤ 4 - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable/>

#### æ­¥éª¤ 5 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³ä½ çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'turso',
  dbCredentials: {
    url: process.env.TURSO_DATABASE_URL,
    authToken: process.env.TURSO_AUTH_TOKEN,
  },
});
```

#### æ­¥éª¤ 6 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### æ­¥éª¤ 7 - ç§å­å’ŒæŸ¥è¯¢æ•°æ®åº“

<QueryTurso/>

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>


Source: https://drizzle.zhcndoc.com/docs/get-started/vercel-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectVercel from '@mdx/get-started/postgresql/ConnectVercel.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Vercel Postgres

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **Vercel Postgres æ•°æ®åº“** - [æŸ¥çœ‹è¿™é‡Œ](https://vercel.com/docs/storage/vercel-postgres)
  - **Vercel Postgres é©±åŠ¨** - [æŸ¥çœ‹è¿™é‡Œ](https://vercel.com/docs/storage/vercel-postgres/sdk) & [GitHub](https://github.com/vercel/storage/tree/main/packages/postgres)
</Prerequisites>

<FileStructure/>

#### æ­¥éª¤ 1 - å®‰è£…æ‰€éœ€åŒ…
<InstallPackages lib='@vercel/postgres'/>

#### æ­¥éª¤ 2 - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='POSTGRES_URL' />

<Callout title='è­¦å‘Š'>
åŠ¡å¿…å°†å˜é‡å‘½åä¸º `POSTGRES_URL`ï¼Œä»¥ç”¨äº Vercel Postgresã€‚

åœ¨ Vercel Postgres å­˜å‚¨æ ‡ç­¾ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° `.env.local` æ ‡ç­¾å¹¶å¤åˆ¶ `POSTGRES_URL` å˜é‡ã€‚
</Callout>

#### æ­¥éª¤ 3 - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='POSTGRES_URL'/>

#### æ­¥éª¤ 4 - åå‘å·¥ç¨‹æ‚¨çš„æ•°æ®åº“

<IntrospectPostgreSQL/>

#### æ­¥éª¤ 5 - å°†ä»£ç è½¬ç§»åˆ°æ‚¨çš„å®é™…æ¶æ„æ–‡ä»¶ä¸­

<TransferCode/>

#### æ­¥éª¤ 6 - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectVercel/>

#### æ­¥éª¤ 7 - æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

#### æ­¥éª¤ 8 - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### æ­¥éª¤ 9 - æ›´æ–°æ‚¨çš„è¡¨æ¶æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### æ­¥éª¤ 10 - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### æ­¥éª¤ 11 - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

Source: https://drizzle.zhcndoc.com/docs/get-started/vercel-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectVercel from '@mdx/get-started/postgresql/ConnectVercel.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# ä½¿ç”¨ Drizzle å’Œ Vercel Postgres å¼€å§‹

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **Vercel Postgres æ•°æ®åº“** - [é˜…è¯»è¿™é‡Œ](https://vercel.com/docs/storage/vercel-postgres)
  - **Vercel Postgres é©±åŠ¨ç¨‹åº** - [é˜…è¯»è¿™é‡Œ](https://vercel.com/docs/storage/vercel-postgres/sdk) & [GitHub](https://github.com/vercel/storage/tree/main/packages/postgres)
</Prerequisites>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£…å¿…éœ€çš„åŒ…
<InstallPackages lib='@vercel/postgres'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='POSTGRES_URL' />

<Callout title='è­¦å‘Š'>
å°†å˜é‡å‘½åä¸º `POSTGRES_URL` å¯¹äº Vercel Postgres å¾ˆé‡è¦ã€‚

åœ¨ Vercel Postgres å­˜å‚¨é€‰é¡¹å¡ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° `.env.local` é€‰é¡¹å¡å¹¶å¤åˆ¶ `POSTGRES_URL` å˜é‡ã€‚
</Callout>

#### ç¬¬ä¸‰æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectVercel/>

#### ç¬¬å››æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable />

#### ç¬¬äº”æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='POSTGRES_URL'/>

#### ç¬¬å…­æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### ç¬¬ä¸ƒæ­¥ - å¡«å……å¹¶æŸ¥è¯¢æ•°æ®åº“

```typescript copy filename="src/index.ts"
import 'dotenv/config';
import { eq } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { usersTable } from './db/schema';

async function main() {
  const db = drizzle();

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('æ–°ç”¨æˆ·å·²åˆ›å»ºï¼')

  const users = await db.select().from(usersTable);
  console.log('ä»æ•°æ®åº“è·å–æ‰€æœ‰ç”¨æˆ·: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('ç”¨æˆ·å·²åˆ é™¤ï¼')
}

main();
```

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/get-started/xata-existing

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IntrospectPostgreSQL from '@mdx/get-started/postgresql/IntrospectPostgreSQL.mdx';
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import ConnectXata from '@mdx/get-started/postgresql/ConnectXata.mdx'
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import QueryDatabaseUpdated from '@mdx/get-started/QueryDatabaseUpdated.mdx';
import UpdateSchema from '@mdx/get-started/postgresql/UpdateSchema.mdx';

<Breadcrumbs/>

# åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Xata

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [æŸ¥çœ‹è¿™é‡Œ](https://tsx.is/)
  - **Xata Postgres æ•°æ®åº“** - [æŸ¥çœ‹è¿™é‡Œ](https://xata.io/documentation)
</Prerequisites>

<FileStructure/>

#### ç¬¬ 1 æ­¥ - å®‰è£… **postgres** åŒ…
<InstallPackages lib='postgres'/>

#### ç¬¬ 2 æ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

ä½ å¯ä»¥é€šè¿‡å‚è€ƒ [Xata æ–‡æ¡£](https://xata.io/documentation/getting-started) æ¥è·å–è¿æ¥å­—ç¬¦ä¸²ã€‚

#### ç¬¬ 3 æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬ 4 æ­¥ - æ£€æŸ¥ä½ çš„æ•°æ®åº“

<IntrospectPostgreSQL/>

#### ç¬¬ 5 æ­¥ - å°†ä»£ç è¿ç§»åˆ°å®é™…çš„æ¶æ„æ–‡ä»¶

<TransferCode/>

#### ç¬¬ 6 æ­¥ - å°† Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“

<ConnectXata/>

#### ç¬¬ 7 æ­¥ - æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='postgres-js' env_variable='DATABASE_URL'/>

#### ç¬¬ 8 æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

#### ç¬¬ 9 æ­¥ - æ›´æ–°ä½ çš„è¡¨æ¶æ„ï¼ˆå¯é€‰ï¼‰

<UpdateSchema/>

#### ç¬¬ 10 æ­¥ - å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<ApplyChanges />

#### ç¬¬ 11 æ­¥ - ä½¿ç”¨æ–°å­—æ®µæŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

<QueryDatabaseUpdated dialect='postgres-js' env_variable='DATABASE_URL' />

Source: https://drizzle.zhcndoc.com/docs/get-started/xata-new

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from "@mdx/Npm.astro";
import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import AnchorCards from '@mdx/AnchorCards.astro';
import Breadcrumbs from '@mdx/Breadcrumbs.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import FileStructure from '@mdx/get-started/FileStructure.mdx';
import InstallPackages from '@mdx/get-started/InstallPackages.mdx';
import ConnectXata from '@mdx/get-started/postgresql/ConnectXata.mdx'
import CreateTable from '@mdx/get-started/postgresql/CreateTable.mdx'
import SetupConfig from '@mdx/get-started/SetupConfig.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';
import QueryDatabase from '@mdx/get-started/QueryDatabase.mdx';
import SetupEnv from '@mdx/get-started/SetupEnv.mdx';

<Breadcrumbs/>

# å¼€å§‹ä½¿ç”¨ Drizzle å’Œ Xata

<Prerequisites>
  - **dotenv** - ç®¡ç†ç¯å¢ƒå˜é‡çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
  - **tsx** - è¿è¡Œ TypeScript æ–‡ä»¶çš„åŒ… - [é˜…è¯»è¿™é‡Œ](https://tsx.is/)
  - **Xata Postgres æ•°æ®åº“** - [é˜…è¯»è¿™é‡Œ](https://xata.io/documentation)
</Prerequisites>

<FileStructure/>

#### ç¬¬ä¸€æ­¥ - å®‰è£… **postgres** åŒ…
<InstallPackages lib='postgres'/>

#### ç¬¬äºŒæ­¥ - è®¾ç½®è¿æ¥å˜é‡

<SetupEnv env_variable='DATABASE_URL' />

ä½ å¯ä»¥é€šè¿‡éµå¾ª [Xata æ–‡æ¡£](https://xata.io/documentation/getting-started) æ¥è·å–è¿æ¥å­—ç¬¦ä¸²ã€‚

#### ç¬¬ä¸‰æ­¥ - è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

<ConnectXata/>

#### ç¬¬å››æ­¥ - åˆ›å»ºä¸€ä¸ªè¡¨

<CreateTable />

#### ç¬¬äº”æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

<SetupConfig dialect='postgresql' env_variable='DATABASE_URL'/>

#### ç¬¬å…­æ­¥ - åº”ç”¨æ•°æ®åº“å˜æ›´

<ApplyChanges />

#### ç¬¬ä¸ƒæ­¥ - å¡«å……æ•°æ®å¹¶æŸ¥è¯¢æ•°æ®åº“

<QueryDatabase dialect='postgres-js' env_variable='DATABASE_URL'/>

#### ç¬¬å…«æ­¥ - è¿è¡Œ index.ts æ–‡ä»¶

<RunFile/>

Source: https://drizzle.zhcndoc.com/docs/goodies

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';
import CodeTabs from '@mdx/CodeTabs.astro';

## ç±»å‹ API
è¦ä»ä½ çš„è¡¨æ¶æ„ä¸­æ£€ç´¢ `select` å’Œ `insert` æŸ¥è¯¢çš„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ç±»å‹è¾…åŠ©å·¥å…·ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
<Tab>
```ts
import { serial, text, pgTable } from 'drizzle-orm/pg-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// æˆ–
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// æˆ–
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
<Tab>
```ts
import { int, text, mysqlTable } from 'drizzle-orm/mysql-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = mysqlTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// æˆ–
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// æˆ–
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
<Tab>
```ts
import { int, text, sqliteTable } from 'drizzle-orm/sqlite-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = sqliteTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// æˆ–
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// æˆ–
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
<Tab>
```ts
import { int, text, singlestoreTable } from 'drizzle-orm/singlestore-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = singlestoreTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// æˆ–
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// æˆ–
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
<Tab>
```ts
import { int, text, singlestoreTable } from 'drizzle-orm/singlestore-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = singlestoreTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// æˆ–
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// æˆ–
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
<Tab>
```ts
import { int, text, mssqlTable } from 'drizzle-orm/mssql-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = mssqlTable('users', {
  id: int().primaryKey(),
  name: text().notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// or
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// or
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
<Tab>
```ts
import { int4, text, cockroachTable } from 'drizzle-orm/cockroach-core';
import { type InferSelectModel, type InferInsertModel } from 'drizzle-orm'

const users = cockroachTable('users', {
  id: int4().primaryKey(),
  name: text().notNull(),
});

type SelectUser = typeof users.$inferSelect;
type InsertUser = typeof users.$inferInsert;
// or
type SelectUser = typeof users._.$inferSelect;
type InsertUser = typeof users._.$inferInsert;
// or
type SelectUser = InferSelectModel<typeof users>;
type InsertUser = InferInsertModel<typeof users>;
```
</Tab>
</Tabs>


## æ—¥å¿—è®°å½•
è¦å¯ç”¨é»˜è®¤çš„æŸ¥è¯¢æ—¥å¿—è®°å½•ï¼Œåªéœ€å°† `{ logger: true }` ä¼ é€’ç»™ `drizzle` åˆå§‹åŒ–å‡½æ•°ï¼š
```typescript copy
import { drizzle } from 'drizzle-orm/...'; // é©±åŠ¨ç‰¹å®šçš„

const db = drizzle({ logger: true });
```

ä½ å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª `DefaultLogger` å®ä¾‹å¹¶æä¾›è‡ªå®šä¹‰çš„ `writer` æ¥æ›´æ”¹æ—¥å¿—çš„ç›®çš„åœ°ï¼š
```typescript copy
import { DefaultLogger, LogWriter } from 'drizzle-orm/logger';
import { drizzle } from 'drizzle-orm/...'; // é©±åŠ¨ç‰¹å®šçš„

class MyLogWriter implements LogWriter {
  write(message: string) {
    // å†™å…¥æ–‡ä»¶ã€æ ‡å‡†è¾“å‡ºç­‰ã€‚
  }
}

const logger = new DefaultLogger({ writer: new MyLogWriter() });
const db = drizzle({ logger });
```

ä½ è¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„æ—¥å¿—è®°å½•å™¨ï¼š
```typescript copy
import { Logger } from 'drizzle-orm/logger';
import { drizzle } from 'drizzle-orm/...'; // é©±åŠ¨ç‰¹å®šçš„

class MyLogger implements Logger {
  logQuery(query: string, params: unknown[]): void {
    console.log({ query, params });
  }
}

const db = drizzle({ logger: new MyLogger() });
```


## å¤šé¡¹ç›®æ¶æ„
**è¡¨åˆ›å»ºè€…** API è®©ä½ å®šä¹‰è‡ªå®šä¹‰è¡¨åã€‚  
å½“ä½ éœ€è¦å°†ä¸åŒé¡¹ç›®çš„æ¶æ„ä¿å­˜åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­æ—¶ï¼Œå®ƒéå¸¸æœ‰ç”¨ã€‚

<CodeTabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
```ts {3}
import { serial, text, pgTableCreator } from 'drizzle-orm/pg-core';

const pgTable = pgTableCreator((name) => `project1_${name}`);

const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});
```
```ts {3}
import { int, text, mysqlTableCreator } from 'drizzle-orm/mysql-core';

const mysqlTable = mysqlTableCreator((name) => `project1_${name}`);

const users = mysqlTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});
```
```ts {3}
import { int, text, sqliteTableCreator } from 'drizzle-orm/sqlite-core';

const sqliteTable = sqliteTableCreator((name) => `project1_${name}`);

const users = sqliteTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});
```
```ts {3}
import { int, text, singlestoreTableCreator } from 'drizzle-orm/singlestore-core';

const singlestoreTable = singlestoreTableCreator((name) => `project1_${name}`);

const users = singlestoreTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
});
```
```ts {3}
import { int, text, mssqlTableCreator } from 'drizzle-orm/mssql-core';

const mssqlTable = mssqlTableCreator((name) => `project1_${name}`);

const users = mssqlTable('users', {
  id: int().primaryKey(),
  name: text().notNull(),
});
```
```ts {3}
import { int4, text, cockroachTableCreator } from 'drizzle-orm/cockroach-core';

const pgTable = cockroachTableCreator((name) => `project1_${name}`);

const users = pgTable('users', {
  id: int4().primaryKey(),
  name: text().notNull(),
});
```
</CodeTabs>
```ts {10}
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/schema/*",
  out: "./drizzle",
  dialect: "mysql", 
  dbCredentials: {
    url: process.env.DATABASE_URL,
  }
  tablesFilter: ["project1_*"],
});
```

ä½ å¯ä»¥åº”ç”¨å¤šä¸ª `or` è¿‡æ»¤å™¨ï¼š
```ts
tablesFilter: ["project1_*", "project2_*"]
```


## æ‰“å° SQL æŸ¥è¯¢
ä½ å¯ä»¥é€šè¿‡ `db` å®ä¾‹æˆ–ä½¿ç”¨ **[`ç‹¬ç«‹æŸ¥è¯¢æ„å»ºå™¨`](#standalone-query-builder)** æ‰“å° SQL æŸ¥è¯¢ã€‚
```typescript copy
const query = db
  .select({ id: users.id, name: users.name })
  .from(users)
  .groupBy(users.id)
  .toSQL();
// æŸ¥è¯¢ï¼š
{
  sql: 'select 'id', 'name' from 'users' group by 'users'.'id'',
  params: [],
}
```

## åŸå§‹ SQL æŸ¥è¯¢æ‰§è¡Œ
å¦‚æœä½ æœ‰ä¸€äº›å¤æ‚çš„æŸ¥è¯¢éœ€è¦æ‰§è¡Œï¼Œè€Œ `drizzle-orm` ç›®å‰æ— æ³•å¤„ç†ï¼Œ
ä½ å¯ä»¥ä½¿ç”¨ `db.execute` æ–¹æ³•æ‰§è¡ŒåŸå§‹çš„ `parametrized` æŸ¥è¯¢ã€‚

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
    <Tab>
    ```ts
    const statement = sql`select * from ${users} where ${users.id} = ${userId}`;
    const res: postgres.RowList<Record<string, unknown>[]> = await db.execute(statement)
    ```
    </Tab>
    <Tab>
    ```typescript copy
    import { ..., MySqlQueryResult } from "drizzle-orm/mysql2";

    const statement = sql`select * from ${users} where ${users.id} = ${userId}`;
    const res: MySqlRawQueryResult = await db.execute(statement);
    ```
    </Tab>
    <Tab>
    ```ts
    const statement = sql`select * from ${users} where ${users.id} = ${userId}`;

    const res: unknown[] = db.all(statement)
    const res: unknown = db.get(statement)
    const res: unknown[][] = db.values(statement)
    const res: Database.RunResult = db.run(statement)
    ```
    </Tab>
    <Tab>
    ```typescript copy
    import { ..., SingleStoreQueryResult } from "drizzle-orm/singlestore";

    const statement = sql`select * from ${users} where ${users.id} = ${userId}`;
    const res: SingleStoreRawQueryResult = await db.execute(statement);
    ```
    </Tab>
        <Tab>
    ```typescript copy
    import { sql } from "drizzle-orm";

    const statement = sql`select * from ${users} where ${users.id} = ${userId}`;
    const res = await db.execute(statement);
    ```
    </Tab>
    <Tab>
    ```ts
    const statement = sql`select * from ${users} where ${users.id} = ${userId}`;
    const res = await db.execute(statement)
    ```
    </Tab>
</Tabs>


## ç‹¬ç«‹æŸ¥è¯¢æ„å»ºå™¨
Drizzle ORM æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢æ„å»ºå™¨ï¼Œ
å…è®¸ä½ åœ¨ä¸åˆ›å»ºæ•°æ®åº“å®ä¾‹çš„æƒ…å†µä¸‹æ„å»ºæŸ¥è¯¢å¹¶è·å–ç”Ÿæˆçš„ SQLã€‚
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', "SingleStore", "MSSQL", "CockroachDB"]}>
    <Tab>
        ```typescript copy
        import { QueryBuilder } from 'drizzle-orm/pg-core';

        const qb = new QueryBuilder();

        const query = qb.select().from(users).where(eq(users.name, 'Dan'));
        const { sql, params } = query.toSQL();
        ```
    </Tab>
    <Tab>
        ```typescript copy
        import { QueryBuilder } from 'drizzle-orm/mysql-core';

        const qb = new QueryBuilder();

        const query = qb.select().from(users).where(eq(users.name, 'Dan'));
        const { sql, params } = query.toSQL();
        ```
    </Tab>
    <Tab>
        ```typescript copy
        import { QueryBuilder } from 'drizzle-orm/sqlite-core';

        const qb = new QueryBuilder();

        const query = qb.select().from(users).where(eq(users.name, 'Dan'));
        const { sql, params } = query.toSQL();
        ```
    </Tab>
    <Tab>
        ```typescript copy
        import { QueryBuilder } from 'drizzle-orm/singlestore-core';

        const qb = new QueryBuilder();

        const query = qb.select().from(users).where(eq(users.name, 'Dan'));
        const { sql, params } = query.toSQL();
        ```
    </Tab>
    <Tab>
        ```typescript copy
        import { QueryBuilder } from 'drizzle-orm/mssql-core';

        const qb = new QueryBuilder();

        const query = qb.select().from(users).where(eq(users.name, 'Dan'));
        const { sql, params } = query.toSQL();
        ```
    </Tab>
    <Tab>
        ```typescript copy
        import { QueryBuilder } from 'drizzle-orm/cockroach-core';

        const qb = new QueryBuilder();

        const query = qb.select().from(users).where(eq(users.name, 'Dan'));
        const { sql, params } = query.toSQL();
        ```
    </Tab>
</Tabs>

## è·å–ç±»å‹åŒ–è¡¨å­—æ®µ
ä½ å¯ä»¥è·å–ä¸€ä¸ªç±»å‹åŒ–çš„è¡¨å­—æ®µæ˜ å°„ï¼Œ
å½“ä½ éœ€è¦åœ¨é€‰æ‹©æ—¶çœç•¥æŸäº›å­—æ®µæ—¶éå¸¸æœ‰ç”¨ã€‚
<Callout type='warning'>
`getColumns` ä» `drizzle-orm@1.0.0-beta.2` å¼€å§‹å¯ç”¨ï¼ˆè¯¦æƒ…è§ [æ­¤å¤„](/docs/upgrade-v1)ï¼‰

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ 1.0 ä¹‹å‰çš„ç‰ˆæœ¬ï¼ˆå¦‚ `0.45.1`ï¼‰ï¼Œåˆ™ä½¿ç”¨ `getTableColumns`
</Callout>

<br/>

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
      <CodeTabs items={["index.ts", "schema.ts"]}>
        ```ts
        import { getColumns } from "drizzle-orm";
        import { user } from "./schema";

        const { password, role, ...rest } = getColumns(user);

        await db.select({ ...rest }).from(users);
        ```
        ```ts
        import { serial, text, pgTable } from "drizzle-orm/pg-core";

        export const user = pgTable("user", {
          id: serial("id").primaryKey(),
          name: text("name"),
          email: text("email"),
          password: text("password"),
          role: text("role").$type<"admin" | "customer">(),
        });
        ```
      </CodeTabs>
  </Tab>
  <Tab>
      <CodeTabs items={["index.ts", "schema.ts"]}>
        ```ts
        import { getColumns } from "drizzle-orm";
        import { user } from "./schema";

        const { password, role, ...rest } = getColumns(user);

        await db.select({ ...rest }).from(users);
        ```
        ```ts
        import { int, text, mysqlTable } from "drizzle-orm/mysql-core";

        export const user = mysqlTable("user", {
          id: int("id").primaryKey().autoincrement(),
          name: text("name"),
          email: text("email"),
          password: text("password"),
          role: text("role").$type<"admin" | "customer">(),
        });
        ```
      </CodeTabs>
  </Tab>
  <Tab>
      <CodeTabs items={["index.ts", "schema.ts"]}>
        ```ts
        import { getColumns } from "drizzle-orm";
        import { user } from "./schema";

        const { password, role, ...rest } = getColumns(user);

        await db.select({ ...rest }).from(users);
        ```
        ```ts
        import { integer, text, sqliteTable } from "drizzle-orm/sqlite-core";

        export const user = sqliteTable("user", {
          id: integer("id").primaryKey({ autoIncrement: true }),
          name: text("name"),
          email: text("email"),
          password: text("password"),
          role: text("role").$type<"admin" | "customer">(),
        });
        ```
      </CodeTabs>
  </Tab>
  <Tab>
      <CodeTabs items={["index.ts", "schema.ts"]}>
        ```ts
        import { getColumns } from "drizzle-orm";
        import { user } from "./schema";

        const { password, role, ...rest } = getColumns(user);

        await db.select({ ...rest }).from(users);
        ```
        ```ts
        import { int, text, singlestoreTable } from "drizzle-orm/singlestore-core";

        export const user = singlestoreTable("user", {
          id: int("id").primaryKey().autoincrement(),
          name: text("name"),
          email: text("email"),
          password: text("password"),
          role: text("role").$type<"admin" | "customer">(),
        });
        ```
      </CodeTabs>
  </Tab>
  <Tab>
      <CodeTabs items={["index.ts", "schema.ts"]}>
        ```ts
        import { getColumns } from "drizzle-orm";
        import { user } from "./schema";

        const { password, role, ...rest } = getColumns(user);

        await db.select({ ...rest }).from(users);
        ```
        ```ts
        import { int, text, mssqlTable } from "drizzle-orm/mssql-core";

        export const user = mssqlTable("user", {
          id: int().primaryKey(),
          name: text(),
          email: text(),
          password: text(),
          role: text().$type<"admin" | "customer">(),
        });
        ```
      </CodeTabs>
  </Tab>
  <Tab>
      <CodeTabs items={["index.ts", "schema.ts"]}>
        ```ts
        import { getColumns } from "drizzle-orm";
        import { user } from "./schema";

        const { password, role, ...rest } = getColumns(user);

        await db.select({ ...rest }).from(users);
        ```
        ```ts
        import { int4, text, pgTable } from "drizzle-orm/cockroach-core";

        export const user = pgTable("user", {
          id: int4().primaryKey(),
          name: text(),
          email: text(),
          password: text(),
          role: text().$type<"admin" | "customer">(),
        });
        ```
      </CodeTabs>
  </Tab>
</Tabs>

## è·å–è¡¨ä¿¡æ¯
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
    ```ts copy
    import { getTableConfig, pgTable } from 'drizzle-orm/pg-core';

    export const table = pgTable(...);

    const {
      columns,
      indexes,
      foreignKeys,
      checks,
      primaryKeys,
      name,
      schema,
    } = getTableConfig(table);
    ```
  </Tab>
  <Tab>
  ```ts copy
  import { getTableConfig, mysqlTable } from 'drizzle-orm/mysql-core';

  export const table = mysqlTable(...);

  const {
    columns,
    indexes,
    foreignKeys,
    checks,
    primaryKeys,
    name,
    schema,
  } = getTableConfig(table);
  ```
  </Tab>
  <Tab>
  ```ts copy
  import { getTableConfig, sqliteTable } from 'drizzle-orm/sqlite-core';

  export const table = sqliteTable(...);

  const {
    columns,
    indexes,
    foreignKeys,
    checks,
    primaryKeys,
    name,
    schema,
  } = getTableConfig(table);
  ```
  </Tab>
  <Tab>
  ```ts copy
  import { getTableConfig, mysqlTable } from 'drizzle-orm/singlestore-core';

  export const table = singlestoreTable(...);

  const {
    columns,
    indexes,
    checks,
    primaryKeys,
    name,
    schema,
  } = getTableConfig(table);
  ```
  </Tab>
  <Tab>
  ```ts copy
  import { getTableConfig, mssqlTable } from 'drizzle-orm/mssql-core';

  export const table = mssqlTable(...);

  const {
    columns,
    indexes,
    checks,
    primaryKeys,
    name,
    schema,
  } = getTableConfig(table);
  ```
  </Tab>
  <Tab>
    ```ts copy
    import { getTableConfig, cockroachTable } from 'drizzle-orm/cockroach-core';

    export const table = cockroachTable(...);

    const {
      columns,
      indexes,
      foreignKeys,
      checks,
      primaryKeys,
      name,
      schema,
    } = getTableConfig(table);
    ```
  </Tab>
</Tabs>

## æ¯”è¾ƒå¯¹è±¡ç±»å‹ï¼ˆ`instanceof` çš„æ›¿ä»£æ–¹æ¡ˆï¼‰

ä½ å¯ä»¥ä½¿ç”¨ `is()` å‡½æ•°æ£€æŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºç‰¹å®šçš„ Drizzle ç±»å‹ã€‚ 
ä½ å¯ä»¥ä¸ Drizzle ä¸­çš„ä»»ä½•å¯ç”¨ç±»å‹ä¸€èµ·ä½¿ç”¨ã€‚

<Callout type="warning" emoji="â­ï¸">
  ä½ åº”è¯¥å§‹ç»ˆä½¿ç”¨ `is()` è€Œä¸æ˜¯ `instanceof`
</Callout>

**å‡ ä¸ªä¾‹å­**
```ts
import { Column, is } from 'drizzle-orm';

if (is(value, Column)) {
  // value çš„ç±»å‹è¢«ç¼©å°ä¸º Column
}
```

### æ¨¡æ‹Ÿé©±åŠ¨ç¨‹åº
è¯¥ API æ˜¯ä¸€ä¸ªç»§æ‰¿äºæœªå®šä¹‰çš„ `drizzle({} as any)` API çš„åç»­ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åœ¨ Drizzle æµ‹è¯•ä¸­å†…éƒ¨ä½¿ç”¨è¿‡ï¼Œå¹¶å¾ˆå°‘æ¨èç»™å¤–éƒ¨å¼€å‘è€…ã€‚

æˆ‘ä»¬å†³å®šæ„å»ºå¹¶å…¬å¼€ä¸€ä¸ªé€‚å½“çš„ APIï¼Œç°åœ¨æ¯ä¸ª `drizzle` é©±åŠ¨ç¨‹åºéƒ½æœ‰ `drizzle.mock()`ï¼š
```ts
import { drizzle } from "drizzle-orm/...";

const db = drizzle.mock();
```

å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æä¾›ç±»å‹çš„æ¶æ„ã€‚
```ts
import { drizzle } from "drizzle-orm/...";
import * as schema from "./schema"

const db = drizzle.mock({ schema });
```


Source: https://drizzle.zhcndoc.com/docs/gotchas

import CodeTab from "@mdx/CodeTab.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";

# Drizzle æ³¨æ„äº‹é¡¹

è¿™å°†æ˜¯ä¸€ä¸ªå…³äº Drizzle ä½¿ç”¨æ¡ˆä¾‹ä¸­çš„ `æ³¨æ„äº‹é¡¹` åº“

Source: https://drizzle.zhcndoc.com/docs/graphql

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Npm from '@mdx/Npm.astro';

# drizzle-graphql

é€šè¿‡ä¸€è¡Œä»£ç ä» Drizzle æ¨¡å¼åˆ›å»º GraphQL æœåŠ¡å™¨ï¼Œå¹¶è½»æ¾å¢å¼ºè‡ªå®šä¹‰æŸ¥è¯¢å’Œå˜æ›´ã€‚

## å¿«é€Ÿå¼€å§‹

ç¡®ä¿ä½ çš„ `drizzle-orm` ç‰ˆæœ¬è‡³å°‘ä¸º `0.30.9`ï¼Œå¦‚æœ‰éœ€è¦è¯·æ›´æ–°ï¼š
<Npm>drizzle-orm@latest</Npm>

### Apollo æœåŠ¡å™¨

<Npm>drizzle-graphql @apollo/server graphql</Npm>

<CodeTabs items={['server.ts', 'schema.ts']}>
<CodeTab>
```ts copy {1, 10}
import { buildSchema } from 'drizzle-graphql';
import { drizzle } from 'drizzle-orm/...';
import client from './db';
import { ApolloServer } from '@apollo/server';
import { startStandaloneServer } from '@apollo/server/standalone';

import * as dbSchema from './schema';

const db = drizzle({ client, schema: dbSchema });

const { schema } = buildSchema(db);

const server = new ApolloServer({ schema });
const { url } = await startStandaloneServer(server);

console.log(`ğŸš€ æœåŠ¡å™¨å·²å‡†å¤‡å¥½ï¼Œåœ°å€ä¸º ${url}`);
```
</CodeTab>
<CodeTab>
```typescript copy
import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, { fields: [posts.authorId], references: [users.id] }),
}));
```
</CodeTab>
</CodeTabs>

### GraphQL Yoga

<Npm>drizzle-graphql graphql-yoga graphql</Npm>

<CodeTabs items={['server.ts', 'schema.ts']}>
<CodeTab>
```ts copy {1, 10}
import { buildSchema } from 'drizzle-graphql';
import { drizzle } from 'drizzle-orm/...';
import { createYoga } from 'graphql-yoga';
import { createServer } from 'node:http';

import * as dbSchema from './schema';

const db = drizzle({ schema: dbSchema });

const { schema } = buildSchema(db);

const yoga = createYoga({ schema });
const server = createServer(yoga);

server.listen(4000, () => {
  console.info('æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ http://localhost:4000/graphql');
});
```
</CodeTab>
<CodeTab>
```typescript copy
import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, { fields: [posts.authorId], references: [users.id] }),
}));
```
</CodeTab>
</CodeTabs>

## è‡ªå®šä¹‰æ¨¡å¼

<Callout type='info' emoji='â„¹ï¸'>
`buildSchema()` ä½¿ç”¨æ ‡å‡†çš„ `graphql` SDK ç”Ÿæˆæ¨¡å¼å’Œç±»å‹ï¼Œå› æ­¤å…¶è¾“å‡ºä¸ä»»ä½•æ”¯æŒè¯¥è¾“å‡ºçš„åº“å…¼å®¹ã€‚
</Callout>

å¦‚æœä½ æƒ³è‡ªå®šä¹‰ä½ çš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ `entities` å¯¹è±¡æ¥æ„å»ºä½ è‡ªå·±çš„æ–°æ¨¡å¼ï¼š

<CodeTabs items={['server.ts', 'schema.ts']}>
<CodeTab>
```ts {1, 11}
import { buildSchema } from 'drizzle-graphql';
import { drizzle } from 'drizzle-orm/...';
import { GraphQLList, GraphQLNonNull, GraphQLObjectType, GraphQLSchema } from 'graphql';
import { createYoga } from 'graphql-yoga';
import { createServer } from 'node:http';

import * as dbSchema from './schema';

const db = drizzle({ schema: dbSchema });

const { entities } = buildSchema(db);

// ä½ å¯ä»¥è‡ªå®šä¹‰æŸ¥è¯¢æˆ–å˜æ›´çš„éƒ¨åˆ†
const schema = new GraphQLSchema({
  query: new GraphQLObjectType({
    name: 'Query',
    fields: {
      // ä»æ‰€æœ‰ç”Ÿæˆçš„æŸ¥è¯¢ä¸­é€‰æ‹©æ‰€éœ€çš„æŸ¥è¯¢
      users: entities.queries.users,
      customer: entities.queries.customersSingle,

      // åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æŸ¥è¯¢
      customUsers: {
        // ä½ å¯ä»¥é‡æ–°ä½¿ç”¨å¹¶è‡ªå®šä¹‰æ¥è‡ªåŸå§‹æ¨¡å¼çš„ç±»å‹
        type: new GraphQLList(new GraphQLNonNull(entities.types.UsersItem)),
        args: {
          // ä½ ä¹Ÿå¯ä»¥é‡æ–°ä½¿ç”¨è¾“å…¥
          where: {
            type: entities.inputs.UsersFilters
          },
        },
        resolve: async (source, args, context, info) => {
          // ä½ çš„è‡ªå®šä¹‰é€»è¾‘åœ¨è¿™é‡Œ...
          const result = await db.select(schema.users).where()...

          return result;
        },
      },
    },
  }),
  // ç›¸åŒçš„è§„åˆ™é€‚ç”¨äºå˜æ›´
  mutation: new GraphQLObjectType({
    name: 'Mutation',
    fields: entities.mutations,
  }),
  // å¦‚æœä½ éœ€è¦ç±»å‹åœ¨ä½ çš„æ¨¡å¼å†…
  types: [...Object.values(entities.types), ...Object.values(entities.inputs)],
});

const yoga = createYoga({
  schema,
});

const server = createServer(yoga);

server.listen(4000, () => {
  console.info('æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ http://localhost:4000/graphql');
})
```
</CodeTab>
<CodeTab>
```typescript copy
import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const usersRelations = relations(users, ({ many }) => ({
  posts: many(posts),
}));

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  content: text('content').notNull(),
  authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
  author: one(users, { fields: [posts.authorId], references: [users.id] }),
}));
```
</CodeTab>
</CodeTabs>


Source: https://drizzle.zhcndoc.com/docs/guides

import Guides from "@components/Guides.astro";

<Guides/>

Source: https://drizzle.zhcndoc.com/docs/conditional-filters-in-query

import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite);
- [é€‰æ‹©è¯­å¥](/docs/select);
- [è¿‡æ»¤](/docs/select#filtering) å’Œ [è¿‡æ»¤æ“ä½œç¬¦](/docs/operators);
</Prerequisites>

è¦åœ¨æŸ¥è¯¢ä¸­ä¼ é€’æ¡ä»¶è¿‡æ»¤å™¨ï¼Œå¯ä»¥ä½¿ç”¨ `.where()` æ–¹æ³•å’Œé€»è¾‘è¿ç®—ç¬¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```ts copy {9}
import { ilike } from 'drizzle-orm';

const db = drizzle(...)

const searchPosts = async (term?: string) => {
  await db
    .select()
    .from(posts)
    .where(term ? ilike(posts.title, term) : undefined);
};

await searchPosts();
await searchPosts('AI');
```


```sql
select * from posts;
select * from posts where title ilike 'AI';
```
</Section>

è¦ç»„åˆæ¡ä»¶è¿‡æ»¤å™¨ï¼Œå¯ä»¥ä½¿ç”¨ `and()` æˆ– `or()` è¿ç®—ç¬¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```ts copy {7,8,9,10,11,12,13}
import { and, gt, ilike, inArray } from 'drizzle-orm';

const searchPosts = async (term?: string, categories: string[] = [], views = 0) => {
  await db
    .select()
    .from(posts)
    .where(
      and(
        term ? ilike(posts.title, term) : undefined,
        categories.length > 0 ? inArray(posts.category, categories) : undefined,
        views > 100 ? gt(posts.views, views) : undefined,
      ),
    );
};

await searchPosts();
await searchPosts('AI', ['Tech', 'Art', 'Science'], 200);
```

```sql
select * from posts;
select * from posts
  where (
    title ilike 'AI'
    and category in ('Tech', 'Science', 'Art')
    and views > 200
  );
```
</Section>

å¦‚æœä½ éœ€è¦åœ¨é¡¹ç›®çš„ä¸åŒåœ°æ–¹ç»„åˆæ¡ä»¶è¿‡æ»¤å™¨ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå˜é‡ï¼Œæ¨å…¥è¿‡æ»¤å™¨ï¼Œç„¶ååœ¨ `.where()` æ–¹æ³•ä¸­ä½¿ç”¨ `and()` æˆ– `or()` è¿ç®—ç¬¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```ts copy {7,10}
import { SQL, ... } from 'drizzle-orm';

const searchPosts = async (filters: SQL[]) => {
  await db
    .select()
    .from(posts)
    .where(and(...filters));
};

const filters: SQL[] = [];
filters.push(ilike(posts.title, 'AI'));
filters.push(inArray(posts.category, ['Tech', 'Art', 'Science']));
filters.push(gt(posts.views, 200));

await searchPosts(filters);
```

Drizzle å…·æœ‰æœ‰ç”¨ä¸”çµæ´»çš„ APIï¼Œå¯ä»¥è®©ä½ åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯ä½ å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰è¿‡æ»¤å™¨æ“ä½œç¬¦çš„æ–¹æ³•ï¼š

<Section>

```ts copy {5,14}
import { AnyColumn, ... } from 'drizzle-orm';

// é•¿åº¦å°äº
const lenlt = (column: AnyColumn, value: number) => {
  return sql`length(${column}) < ${value}`;
};

const searchPosts = async (maxLen = 0, views = 0) => {
  await db
    .select()
    .from(posts)
    .where(
      and(
        maxLen ? lenlt(posts.title, maxLen) : undefined,
        views > 100 ? gt(posts.views, views) : undefined,
      ),
    );
};

await searchPosts(8);
await searchPosts(8, 200);
```

```sql
select * from posts where length(title) < 8;
select * from posts where (length(title) < 8 and views > 200);
```
</Section>

Drizzle çš„è¿‡æ»¤å™¨æ“ä½œç¬¦åœ¨åº•å±‚åªæ˜¯ SQL è¡¨è¾¾å¼ã€‚è¿™æ˜¯ `lt` æ“ä½œç¬¦åœ¨ Drizzle ä¸­å®ç°çš„ç¤ºä¾‹ï¼š

```js
const lt = (left, right) => {
  return sql`${left} < ${bindIfParam(right, left)}`; // bindIfParam æ˜¯å†…éƒ¨é­”æ³•å‡½æ•°
};
```


Source: https://drizzle.zhcndoc.com/docs/count-rows

import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [é€‰æ‹©è¯­å¥](/docs/select)
- [ç­›é€‰å™¨](/docs/operators) å’Œ [SQL æ“ä½œç¬¦](/docs/sql)
- [èšåˆ](/docs/select#aggregations) å’Œ [èšåˆåŠ©æ‰‹](/docs/select#aggregations-helpers)
- [è¿æ¥](/docs/joins)
</Prerequisites>

è¦ç»Ÿè®¡è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `count()` å‡½æ•°æˆ– `sql` æ“ä½œç¬¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {6,9}
    import { count, sql } from 'drizzle-orm';
    import { products } from './schema';

    const db = drizzle(...);

    await db.select({ count: count() }).from(products);

    // åœ¨åº•å±‚ï¼Œcount() å‡½æ•°ä¼šåœ¨è¿è¡Œæ—¶å°†å…¶ç»“æœè½¬æ¢ä¸ºæ•°å­—ã€‚
    await db.select({ count: sql`count(*)`.mapWith(Number) }).from(products);
    ```

    ```ts
    // ç»“æœç±»å‹
    type Result = {
      count: number;
    }[];
    ```

    ```sql
    select count(*) from products;
    ```
  </CodeTab>
  ```ts
  import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const products = pgTable('products', {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
    discount: integer('discount'),
    price: integer('price').notNull(),
  });
  ```
</CodeTabs>

è¦ç»Ÿè®¡æŒ‡å®šåˆ—åŒ…å«é NULL å€¼çš„è¡Œï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰åˆ—çš„ `count()` å‡½æ•°ï¼š

<Section>
```ts copy {1}
await db.select({ count: count(products.discount) }).from(products);
```

```ts
// ç»“æœç±»å‹
type Result = {
  count: number;
}[];
```

```sql
select count("discount") from products;
```
</Section>

Drizzle æ‹¥æœ‰ç®€å•çµæ´»çš„ APIï¼Œå¯ä»¥è®©æ‚¨åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚åœ¨ PostgreSQL å’Œ MySQL ä¸­ï¼Œ`count()` å‡½æ•°è¿”å› bigintï¼Œè¯¥å€¼ç”±å…¶é©±åŠ¨ç¨‹åºè§£é‡Šä¸ºå­—ç¬¦ä¸²ï¼Œå› æ­¤åº”è½¬æ¢ä¸ºæ•´æ•°ï¼š

<Section>
```ts copy {5,7,11,12}
import { AnyColumn, sql } from 'drizzle-orm';

const customCount = (column?: AnyColumn) => {
  if (column) {
    return sql<number>`cast(count(${column}) as integer)`; // åœ¨ MySQL ä¸­è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°
  } else {
    return sql<number>`cast(count(*) as integer)`; // åœ¨ MySQL ä¸­è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°
  }
};

await db.select({ count: customCount() }).from(products);
await db.select({ count: customCount(products.discount) }).from(products);
```

```sql
select cast(count(*) as integer) from products;
select cast(count("discount") as integer) from products;
```
</Section>

åœ¨ SQLite ä¸­ï¼Œ`count()` çš„ç»“æœä½œä¸ºæ•´æ•°è¿”å›ã€‚

<Section>
```ts copy {3,4}
import { sql } from 'drizzle-orm';

await db.select({ count: sql<number>`count(*)` }).from(products);
await db.select({ count: sql<number>`count(${products.discount})` }).from(products);
```

```sql
select count(*) from products;
select count("discount") from products;
```
</Section>

<Callout type="warning">
é€šè¿‡æŒ‡å®š `sql<number>`ï¼Œæ‚¨å‘Šè¯‰ Drizzle å­—æ®µçš„ **é¢„æœŸ** ç±»å‹æ˜¯ `number`ã€‚<br />
å¦‚æœæ‚¨æŒ‡å®šé”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œå¯¹å°†ä»¥æ•°å­—è¿”å›çš„å­—æ®µä½¿ç”¨ `sql<string>`ï¼‰ï¼Œè¿è¡Œæ—¶å€¼å°†ä¸åŒ¹é…é¢„æœŸç±»å‹ã€‚
Drizzle ä¸èƒ½æ ¹æ®æä¾›çš„ç±»å‹æ³›å‹æ‰§è¡Œä»»ä½•ç±»å‹è½¬æ¢ï¼Œå› ä¸ºè¯¥ä¿¡æ¯åœ¨è¿è¡Œæ—¶ä¸å¯ç”¨ã€‚

å¦‚æœæ‚¨éœ€è¦å¯¹è¿”å›å€¼åº”ç”¨è¿è¡Œæ—¶è½¬æ¢ï¼Œå¯ä»¥ä½¿ç”¨ [`.mapWith()`](/docs/sql#sqlmapwith) æ–¹æ³•ã€‚
</Callout>

è¦ç»Ÿè®¡åŒ¹é…æ¡ä»¶çš„è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `.where()` æ–¹æ³•ï¼š

<Section>
```ts copy {4,6}
import { count, gt } from 'drizzle-orm';

await db
  .select({ count: count() })
  .from(products)
  .where(gt(products.price, 100));
```

```sql
select count(*) from products where price > 100
```
</Section>

ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ `count()` å‡½æ•°ç»“åˆè¿æ¥å’Œèšåˆï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
	<CodeTab>
    ```ts copy {8,11,12,13}
    import { count, eq } from 'drizzle-orm';
    import { countries, cities } from './schema';

    // ç»Ÿè®¡æ¯ä¸ªå›½å®¶çš„åŸå¸‚æ•°é‡
    await db
      .select({
        country: countries.name,
        citiesCount: count(cities.id),
      })
      .from(countries)
      .leftJoin(cities, eq(countries.id, cities.countryId))
      .groupBy(countries.id)
      .orderBy(countries.name);
    ```

    ```sql
    select countries.name, count("cities"."id") from countries
      left join cities on countries.id = cities.country_id
      group by countries.id
      order by countries.name;
    ```
  </CodeTab>
  ```ts
  import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const countries = pgTable('countries', {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
  });

  export const cities = pgTable('cities', {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
    countryId: integer('country_id').notNull().references(() => countries.id),
  });
  ```
</CodeTabs>


Source: https://drizzle.zhcndoc.com/docs/cursor-based-pagination


import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- äº†è§£å¦‚ä½•ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite) 
- ä½¿ç”¨ [order by å­å¥](/docs/select#order-by) çš„ [é€‰æ‹©è¯­å¥](/docs/select)
- ä½¿ç”¨ [order by å­å¥](/docs/rqb#order-by) çš„ [å…³ç³»æŸ¥è¯¢](/docs/rqb)
- [ç´¢å¼•](/docs/indexes-constraints)
</Prerequisites>

æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•åœ¨ Drizzle ä¸­å®ç° `åŸºäºæ¸¸æ ‡` çš„åˆ†é¡µï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
  ```ts copy {10,11,12}
  import { asc, gt } from 'drizzle-orm';
  import { users } from './schema';

  const db = drizzle(...);

  const nextUserPage = async (cursor?: number, pageSize = 3) => {
    await db
      .select()
      .from(users)
      .where(cursor ? gt(users.id, cursor) : undefined) // å¦‚æœæä¾›äº†æ¸¸æ ‡ï¼Œåˆ™è·å–å…¶åçš„è¡Œ
      .limit(pageSize) // è¿”å›çš„è¡Œæ•°
      .orderBy(asc(users.id)); // æ’åº
  };

  // ä¼ é€’å‰ä¸€é¡µæœ€åä¸€è¡Œçš„æ¸¸æ ‡ (id)
  await nextUserPage(3);
  ```

  ```sql
  select * from users order by id asc limit 3;
  ```

  ```ts
  // ä¸‹ä¸€é¡µï¼Œè¿”å›ç¬¬ 4-6 è¡Œ
  [
    {
      id: 4,
      firstName: 'Brian',
      lastName: 'Brown',
      createdAt: 2024-03-08T12:34:55.182Z
    },
    {
      id: 5,
      firstName: 'Beth',
      lastName: 'Davis',
      createdAt: 2024-03-08T12:40:55.182Z
    },
    {
      id: 6,
      firstName: 'Charlie',
      lastName: 'Miller',
      createdAt: 2024-03-08T13:04:55.182Z
    }
  ]
  ```
  </CodeTab>
  <CodeTab>
  ```ts copy
  import { pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

  export const users = pgTable('users', {
    id: serial('id').primaryKey(),
    firstName: text('first_name').notNull(),
    lastName: text('last_name').notNull(),
    createdAt: timestamp('created_at').notNull().defaultNow(),
  });
  ```

  ```plaintext
  +----+------------+------------+----------------------------+
  | id | first_name | last_name  |         created_at         |
  +----+------------+------------+----------------------------+
  |  1 | Alice      | Johnson    | 2024-03-08 12:23:55.251797 |
  +----+------------+------------+----------------------------+
  |  2 | Alex       | Smith      | 2024-03-08 12:25:55.182    |
  +----+------------+------------+----------------------------+
  |  3 | Aaron      | Williams   | 2024-03-08 12:28:55.182    |
  +----+------------+------------+----------------------------+
  |  4 | Brian      | Brown      | 2024-03-08 12:34:55.182    |
  +----+------------+------------+----------------------------+
  |  5 | Beth       | Davis      | 2024-03-08 12:40:55.182    |
  +----+------------+------------+----------------------------+
  |  6 | Charlie    | Miller     | 2024-03-08 13:04:55.182    |
  +----+------------+------------+----------------------------+
  |  7 | Clara      | Wilson     | 2024-03-08 13:22:55.182    |
  +----+------------+------------+----------------------------+
  |  8 | David      | Moore      | 2024-03-08 13:34:55.182    |
  +----+------------+------------+----------------------------+
  |  9 | Aaron      | Anderson   | 2024-03-08 12:40:33.677235 |
  +----+------------+------------+----------------------------+
  ```
  </CodeTab>

</CodeTabs>

å¦‚æœéœ€è¦åŠ¨æ€æ’åºï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·åšï¼š

```ts copy {6,8}
const nextUserPage = async (order: 'asc' | 'desc' = 'asc', cursor?: number, pageSize = 3) => {
  await db
    .select()
    .from(users)
    // æ¸¸æ ‡æ¯”è¾ƒ
    .where(cursor ? (order === 'asc' ? gt(users.id, cursor) : lt(users.id, cursor)) : undefined)
    .limit(pageSize)
    .orderBy(order === 'asc' ? asc(users.id) : desc(users.id));
};

await nextUserPage();
await nextUserPage('asc', 3);
// é™åº
await nextUserPage('desc');
await nextUserPage('desc', 7);
```

è¿™ç§åˆ†é¡µçš„ä¸»è¦æ€æƒ³æ˜¯ä½¿ç”¨æ¸¸æ ‡ä½œä¸ºæ•°æ®é›†ä¸­æŸä¸€è¡Œçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºä¸Šä¸€é¡µçš„ç»“æŸã€‚ä¸ºäº†ç¡®ä¿æ­£ç¡®çš„æ’åºå’Œæ¸¸æ ‡æ¯”è¾ƒï¼Œæ¸¸æ ‡åº”è¯¥æ˜¯å”¯ä¸€çš„ä¸”æ˜¯é¡ºåºçš„ã€‚

å¦‚æœéœ€è¦æŒ‰éå”¯ä¸€ä¸”éé¡ºåºçš„åˆ—æ’åºï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªåˆ—ä½œä¸ºæ¸¸æ ‡ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åšçš„ï¼š

<Section>
```ts copy {14,15,16,17,18,19,22}
import { and, asc, eq, gt, or } from 'drizzle-orm';

const nextUserPage = async (
  cursor?: {
    id: number;
    firstName: string;
  },
  pageSize = 3,
) => {
  await db
    .select()
    .from(users)
    .where(
      cursor
        ? or(
            gt(users.firstName, cursor.firstName),
            and(eq(users.firstName, cursor.firstName), gt(users.id, cursor.id)),
          )
        : undefined,
    )
    .limit(pageSize)
    .orderBy(asc(users.firstName), asc(users.id));
};

// ä¼ é€’æ¥è‡ªå‰ä¸€é¡µçš„æ¸¸æ ‡ (id & firstName)
await nextUserPage({
  id: 2,
  firstName: 'Alex',
});
```

```sql
select * from users
  where (first_name > 'Alex' or (first_name = 'Alex' and id > 2))
  order by first_name asc, id asc limit 3;
```

```ts
// ä¸‹ä¸€é¡µï¼Œè¿”å›ç¬¬ 4-6 è¡Œ
[
  {
    id: 1,
    firstName: 'Alice',
    lastName: 'Johnson',
    createdAt: 2024-03-08T12:23:55.251Z
  },
  {
    id: 5,
    firstName: 'Beth',
    lastName: 'Davis',
    createdAt: 2024-03-08T12:40:55.182Z
  },
  {
    id: 4,
    firstName: 'Brian',
    lastName: 'Brown',
    createdAt: 2024-03-08T12:34:55.182Z
  }
]
```
</Section>

ç¡®ä¿ä¸ºç”¨äºæ¸¸æ ‡çš„åˆ—åˆ›å»ºç´¢å¼•ï¼Œä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

<Section>
```ts copy {7,8}
import { index, ...imports } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  // åˆ—å£°æ˜
},
(t) => [
  index('first_name_index').on(t.firstName).asc(),
  index('first_name_and_id_index').on(t.firstName, t.id).asc(),
]);
```

```sql
-- ç›®å‰ drizzle-kit åªæ”¯æŒç´¢å¼•åå’Œ on() å‚æ•°ï¼Œæ‰€ä»¥æ‚¨éœ€è¦æ‰‹åŠ¨æ·»åŠ é¡ºåº
CREATE INDEX IF NOT EXISTS "first_name_index" ON "users" ("first_name" ASC);
CREATE INDEX IF NOT EXISTS "first_name_and_id_index" ON "users" ("first_name" ASC,"id" ASC);
```
</Section>

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯éé¡ºåºçš„ä¸»é”®ï¼ˆä¾‹å¦‚ `UUIDv4`ï¼‰ï¼Œæ‚¨åº”è¯¥æ·»åŠ ä¸€ä¸ªé¡ºåºåˆ—ï¼ˆä¾‹å¦‚ `created_at` åˆ—ï¼‰å¹¶ä½¿ç”¨å¤šä¸ªæ¸¸æ ‡ã€‚
ä»¥ä¸‹æ˜¯å¦‚ä½•åšçš„ï¼š

<Section>
```ts copy {12,13,14,15,16,17,18,21}

const nextUserPage = async (
  cursor?: {
    id: string;
    createdAt: Date;
  },
  pageSize = 3,
) => {
  await db
    .select()
    .from(users)
    .where(
      // ç¡®ä¿ä¸ºæ‚¨ç”¨äºæ¸¸æ ‡çš„åˆ—æ·»åŠ ç´¢å¼•
      cursor
        ? or(
            gt(users.createdAt, cursor.createdAt),
            and(eq(users.createdAt, cursor.createdAt), gt(users.id, cursor.id)),
          )
        : undefined,
    )
    .limit(pageSize)
    .orderBy(asc(users.createdAt), asc(users.id));
};

// ä¼ é€’æ¥è‡ªå‰ä¸€é¡µçš„æ¸¸æ ‡ (id & createdAt)
await nextUserPage({
  id: '66ed00a4-c020-4dfd-a1ca-5d2e4e54d174',
  createdAt: new Date('2024-03-09T17:59:36.406Z'),
});
```
</Section>

Drizzle å…·æœ‰æœ‰ç”¨çš„å…³ç³»æŸ¥è¯¢ APIï¼Œä½¿æ‚¨å¯ä»¥è½»æ¾å®ç° `åŸºäºæ¸¸æ ‡` çš„åˆ†é¡µï¼š

```ts copy {7,8,9}
import * as schema from './db/schema';

const db = drizzle(..., { schema });

const nextUserPage = async (cursor?: number, pageSize = 3) => {
  await db.query.users.findMany({
    where: (users, { gt }) => (cursor ? gt(users.id, cursor) : undefined),
    orderBy: (users, { asc }) => asc(users.id),
    limit: pageSize,
  });
};

// ä¸‹ä¸€é¡µï¼Œå‰ä¸€é¡µæœ€åä¸€è¡Œçš„æ¸¸æ ‡ (id = 3)
await nextUserPage(3);
```

**åŸºäºæ¸¸æ ‡çš„** åˆ†é¡µçš„ **ä¼˜ç‚¹**ï¼šä¸€è‡´çš„æŸ¥è¯¢ç»“æœï¼Œæ²¡æœ‰å› æ’å…¥æˆ–åˆ é™¤æ“ä½œå¯¼è‡´çš„è·³è¿‡æˆ–é‡å¤çš„è¡Œï¼Œå¹¶ä¸”ç›¸æ¯”äº `limit/offset` åˆ†é¡µæ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºå®ƒä¸éœ€è¦æ‰«æå’Œè·³è¿‡å…ˆå‰çš„è¡Œæ¥è®¿é—®ä¸‹ä¸€é¡µã€‚

**åŸºäºæ¸¸æ ‡çš„** åˆ†é¡µçš„ **ç¼ºç‚¹**ï¼šæ— æ³•ç›´æ¥å¯¼èˆªåˆ°ç‰¹å®šé¡µé¢ï¼Œä¸”å®ç°å¤æ‚ã€‚ç”±äºæ‚¨å°†æ›´å¤šåˆ—æ·»åŠ åˆ°æ’åºé¡ºåºä¸­ï¼Œåˆ™éœ€è¦åœ¨ `where` å­å¥ä¸­æ·»åŠ æ›´å¤šè¿‡æ»¤å™¨ä»¥è¿›è¡Œæ¸¸æ ‡æ¯”è¾ƒï¼Œä»¥ç¡®ä¿åˆ†é¡µçš„ä¸€è‡´æ€§ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨éœ€è¦ç›´æ¥å¯¼èˆªåˆ°ç‰¹å®šé¡µé¢æˆ–éœ€è¦æ›´ç®€å•çš„åˆ†é¡µå®ç°ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ä½¿ç”¨ [offset/limit](/docs/guides/limit-offset-pagination) åˆ†é¡µã€‚


Source: https://drizzle.zhcndoc.com/docs/d1-http-with-drizzle-kit


import Prerequisites from "@mdx/Prerequisites.astro";

<Prerequisites>
- [Drizzle Kit](/docs/kit-overview)
- [Drizzle Studio](/docs/kit-overview#drizzle-studio)
- [Drizzle Chrome æ‰©å±•ç¨‹åº](https://chromewebstore.google.com/detail/drizzle-studio/mjkojjodijpaneehkgmeckeljgkimnmd)
- æ‚¨åº”è¯¥å·²ç»å®‰è£… `drizzle-kit@0.21.3` æˆ–æ›´é«˜ç‰ˆæœ¬
- æ‚¨åº”è¯¥æ‹¥æœ‰ [Cloudflare è´¦å·](https://dash.cloudflare.com/login)ï¼Œå·²éƒ¨ç½² [D1 æ•°æ®åº“](https://developers.cloudflare.com/d1/) å¹¶è·å–å…·æœ‰ D1 ç¼–è¾‘æƒé™çš„ä»¤ç‰Œ
</Prerequisites>

è¦å°† Drizzle Kit ä¸ Cloudflare D1 HTTP API ä¸€èµ·ä½¿ç”¨ï¼Œæ‚¨éœ€è¦åƒè¿™æ ·é…ç½® `drizzle.config.ts` æ–‡ä»¶ï¼š

```ts copy filename="drizzle.config.ts" {7, 9-11}
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './src/schema.ts',
  out: './migrations',
  dialect: 'sqlite',
  driver: 'd1-http',
  dbCredentials: {
    accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
    databaseId: process.env.CLOUDFLARE_DATABASE_ID!,
    token: process.env.CLOUDFLARE_D1_TOKEN!,
  },
});
```

æ‚¨å¯ä»¥åœ¨ [Cloudflare ä»ªè¡¨ç›˜](https://dash.cloudflare.com/login?) ä¸­æ‰¾åˆ° `accountId`ã€`databaseId` å’Œ `token`ã€‚

1. è¦è·å– `accountId`ï¼Œè¯·å‰å¾€ **Workers & Pages** -> **Overview** -> ä»å³ä¾§è¾¹æ å¤åˆ¶ **Account ID**ã€‚
2. è¦è·å– `databaseId`ï¼Œæ‰“å¼€æ‚¨è¦è¿æ¥çš„ D1 æ•°æ®åº“å¹¶å¤åˆ¶ **Database ID**ã€‚
3. è¦è·å– `token`ï¼Œå‰å¾€ **My profile** -> **API Tokens** å¹¶åˆ›å»ºä¸€ä¸ªå…·æœ‰ D1 ç¼–è¾‘æƒé™çš„ä»¤ç‰Œã€‚

é…ç½®å®Œ `drizzle.config.ts` æ–‡ä»¶åï¼ŒDrizzle Kit å…è®¸æ‚¨ä½¿ç”¨ Cloudflare D1 HTTP API è¿è¡Œ `migrate`ã€`push`ã€`introspect` å’Œ `studio` å‘½ä»¤ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ [Drizzle Chrome æ‰©å±•ç¨‹åº](https://chromewebstore.google.com/detail/drizzle-studio/mjkojjodijpaneehkgmeckeljgkimnmd) ç›´æ¥åœ¨å…¶ç®¡ç†é¢æ¿ä¸­æµè§ˆ Cloudflare D1 æ•°æ®åº“ã€‚




Source: https://drizzle.zhcndoc.com/docs/å‡å°‘å€¼

import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ï¼Œ[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [æ›´æ–°è¯­å¥](/docs/update)
- [è¿‡æ»¤å™¨](/docs/operators) å’Œ [SQL æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

è¦å‡å°‘åˆ—çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `update().set()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```ts copy {8}
import { eq, sql } from 'drizzle-orm';

const db = drizzle(...)
  
await db
  .update(table)
  .set({
    counter: sql`${table.counter} - 1`,
  })
  .where(eq(table.id, 1));
```

```sql
update "table" set "counter" = "counter" - 1 where "id" = 1;
```
</Section>

Drizzle å…·æœ‰ç®€å•çµæ´»çš„ APIï¼Œå¯ä»¥è®©ä½ è½»æ¾åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å®ç°è‡ªå®šä¹‰å‡å°‘å‡½æ•°çš„æ–¹æ³•ï¼š

```ts copy {4,10,11}
import { AnyColumn } from 'drizzle-orm';

const decrement = (column: AnyColumn, value = 1) => {
  return sql`${column} - ${value}`;
};

await db
  .update(table)
  .set({
    counter1: decrement(table.counter1),
    counter2: decrement(table.counter2, 10),
  })
  .where(eq(table.id, 1));
```


Source: https://drizzle.zhcndoc.com/docs/empty-array-default-value


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- äº†è§£ [PostgreSQL](/docs/column-types/pg)ã€[MySQL](/docs/column-types/mysql) å’Œ [SQLite](/docs/column-types/sqlite) çš„åˆ—æ•°æ®ç±»å‹
- [sql æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

### PostgreSQL

è¦åœ¨ PostgreSQL ä¸­å°†ç©ºæ•°ç»„è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `sql` æ“ä½œç¬¦å’Œ `'{}'` æˆ– `ARRAY[]` è¯­æ³•ï¼š

<Section>
```ts copy {10,14}
import { sql } from 'drizzle-orm';
import { pgTable, serial, text } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  tags1: text('tags1')
    .array()
    .notNull()
    .default(sql`'{}'::text[]`),
  tags2: text('tags2')
    .array()
    .notNull()
    .default(sql`ARRAY[]::text[]`),
});
```

```sql
CREATE TABLE IF NOT EXISTS "users" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"tags1" text[] DEFAULT '{}'::text[] NOT NULL,
	"tags2" text[] DEFAULT ARRAY[]::text[] NOT NULL
);
```
</Section>


### MySQL

MySQL æ²¡æœ‰æ•°ç»„æ•°æ®ç±»å‹ï¼Œä½†å¯ä»¥ä½¿ç”¨ `json` æ•°æ®ç±»å‹æ¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚è¦åœ¨ MySQL ä¸­å°†ç©ºæ•°ç»„è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `JSON_ARRAY()` å‡½æ•°æˆ– `sql` æ“ä½œç¬¦å’Œ `('[]')` è¯­æ³•ï¼š

<Section>
```ts copy {7,11,15}
import { sql } from 'drizzle-orm';
import { json, mysqlTable, serial, varchar } from 'drizzle-orm/mysql-core';

export const users = mysqlTable('users', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 255 }).notNull(),
  tags1: json('tags1').$type<string[]>().notNull().default([]),
  tags2: json('tags2')
    .$type<string[]>()
    .notNull()
    .default(sql`('[]')`), // ä¸ default([]) ç›¸åŒ
  tags3: json('tags3')
    .$type<string[]>()
    .notNull()
    .default(sql`(JSON_ARRAY())`),
});
```

```sql
CREATE TABLE `users` (
	`id` serial AUTO_INCREMENT NOT NULL,
	`name` varchar(255) NOT NULL,
	`tags1` json NOT NULL DEFAULT ('[]'),
	`tags2` json NOT NULL DEFAULT ('[]'),
	`tags3` json NOT NULL DEFAULT (JSON_ARRAY()),
	CONSTRAINT `users_id` PRIMARY KEY(`id`)
);
```
</Section>

`mode` é€‰é¡¹å®šä¹‰äº†åº”ç”¨ä¸­å¦‚ä½•å¤„ç†å€¼ã€‚åœ¨ `json` æ¨¡å¼ä¸‹ï¼Œå€¼è¢«è§†ä¸º JSON å¯¹è±¡å­—é¢é‡ã€‚

æ‚¨å¯ä»¥ä¸º JSON å¯¹è±¡æ¨æ–­æŒ‡å®š `.$type<..>()`ï¼Œå®ƒä¸ä¼šæ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚å®ƒä¸ºé»˜è®¤å€¼ã€æ’å…¥å’Œé€‰æ‹©æ¨¡å¼æä¾›äº†ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚

### SQLite

SQLite æ²¡æœ‰æ•°ç»„æ•°æ®ç±»å‹ï¼Œä½†å¯ä»¥ä½¿ç”¨ `text` æ•°æ®ç±»å‹æ¥è¾¾åˆ°ç›¸åŒç›®çš„ã€‚è¦åœ¨ SQLite ä¸­å°†ç©ºæ•°ç»„è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `json_array()` å‡½æ•°æˆ– `sql` æ“ä½œç¬¦å’Œ `'[]'` è¯­æ³•ï¼š

<Section>
```ts copy {9,13}
import { sql } from 'drizzle-orm';
import { integer, sqliteTable, text } from 'drizzle-orm/sqlite-core';

export const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  tags1: text('tags1', { mode: 'json' })
    .notNull()
    .$type<string[]>()
    .default(sql`(json_array())`),
  tags2: text('tags2', { mode: 'json' })
    .notNull()
    .$type<string[]>()
    .default(sql`'[]'`),
});
```

```sql
CREATE TABLE `users` (
	`id` integer PRIMARY KEY NOT NULL,
	`tags1` text DEFAULT (json_array()) NOT NULL,
	`tags2` text DEFAULT '[]' NOT NULL
);
```
</Section>

`mode` é€‰é¡¹å®šä¹‰äº†åº”ç”¨ä¸­å¦‚ä½•å¤„ç†å€¼ã€‚åœ¨ `json` æ¨¡å¼ä¸‹ï¼Œå€¼è¢«è§†ä¸º JSON å¯¹è±¡å­—é¢é‡ã€‚

æ‚¨å¯ä»¥ä¸º JSON å¯¹è±¡æ¨æ–­æŒ‡å®š `.$type<..>()`ï¼Œå®ƒä¸ä¼šæ£€æŸ¥è¿è¡Œæ—¶å€¼ã€‚å®ƒä¸ºé»˜è®¤å€¼ã€æ’å…¥å’Œé€‰æ‹©æ¨¡å¼æä¾›äº†ç¼–è¯‘æ—¶ä¿æŠ¤ã€‚


Source: https://drizzle.zhcndoc.com/docs/full-text-search-with-generated-columns


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)
- [é€‰æ‹©è¯­å¥](/docs/select)
- [ç´¢å¼•](/docs/indexes-constraints#indexes)
- [sql æ“ä½œç¬¦](/docs/sql) 
- [å…¨æ–‡æœç´¢](/learn/guides/postgresql-full-text-search)
- [ç”Ÿæˆåˆ—](/docs/generated-columns)
</Prerequisites>

æœ¬æŒ‡å—æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle å’Œç”Ÿæˆåˆ—åœ¨ PostgreSQL ä¸­å®ç°å…¨æ–‡æœç´¢ã€‚ç”Ÿæˆåˆ—æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åˆ—ï¼Œå®ƒæ€»æ˜¯ä»å…¶ä»–åˆ—è®¡ç®—å¾—å‡ºã€‚å®ƒçš„å¥½å¤„åœ¨äºä½ ä¸å¿…æ¯æ¬¡æŸ¥è¯¢è¡¨æ—¶éƒ½è®¡ç®—è¯¥åˆ—çš„å€¼ï¼š

<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {18,19,20,23}
import { SQL, sql } from 'drizzle-orm';
import { index, pgTable, serial, text, customType } from 'drizzle-orm/pg-core';

export const tsvector = customType<{
  data: string;
}>({
  dataType() {
    return `tsvector`;
  },
});

export const posts = pgTable(
  'posts',
  {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    body: text('body').notNull(),
    bodySearch: tsvector('body_search')
      .notNull()
      .generatedAlwaysAs((): SQL => sql`to_tsvector('english', ${posts.body})`),
  },
  (t) => [
    index('idx_body_search').using('gin', t.bodySearch),
  ]
);
  ```
  </CodeTab>
  ```sql
CREATE TABLE "posts" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"body" text NOT NULL,
	"body_search" "tsvector" GENERATED ALWAYS AS (to_tsvector('english', "posts"."body")) STORED NOT NULL
);
--> statement-breakpoint
CREATE INDEX "idx_body_search" ON "posts" USING gin ("body_search");
  ```
</CodeTabs>

å½“ä½ å‘è¡¨ä¸­æ’å…¥ä¸€è¡Œæ—¶ï¼Œç”Ÿæˆåˆ—çš„å€¼æ˜¯ä»åˆ›å»ºåˆ—æ—¶æä¾›çš„è¡¨è¾¾å¼è®¡ç®—å¾—å‡ºçš„ï¼š

<Section>
```ts 
import { posts } from './schema';

const db = drizzle(...);

const body = "é‡‘è‰²çš„æ ‘å¶è¦†ç›–äº†å®é™çš„è¡—é“ï¼Œæ¸…è„†çš„å¾®é£å……æ»¡ç©ºæ°”ï¼Œå¸¦æ¥äº†é›¨çš„æ°”æ¯å’Œå˜åŒ–çš„æ‰¿è¯º"

await db.insert(posts).values({
    body,
    title: "ç§‹å¤©çš„ç¾ä¸½",
  }
).returning();
```

```json
[
  {
    id: 1,
    title: 'ç§‹å¤©çš„ç¾ä¸½',
    body: 'é‡‘è‰²çš„æ ‘å¶è¦†ç›–äº†å®é™çš„è¡—é“ï¼Œæ¸…è„†çš„å¾®é£å……æ»¡ç©ºæ°”ï¼Œå¸¦æ¥äº†é›¨çš„æ°”æ¯å’Œå˜åŒ–çš„æ‰¿è¯º',
    bodySearch: "'air':13 'breez':10 'bring':14 'chang':23 'cover':3 'crisp':9 'fill':11 'golden':1 'leav':2 'promis':21 'quiet':5 'rain':18 'scent':16 'street':6"
  }
]
```
</Section>

è¿™å°±æ˜¯å¦‚ä½•é€šè¿‡ç”Ÿæˆåˆ—åœ¨ PostgreSQL ä¸­ä½¿ç”¨ Drizzle ORM å®ç°å…¨æ–‡æœç´¢çš„æ–¹æ³•ã€‚`@@` æ“ä½œç¬¦ç”¨äºç›´æ¥åŒ¹é…ï¼š

<Section>
```ts copy {6}
const searchParam = "bring";

await db
  .select()
  .from(posts)
  .where(sql`${posts.bodySearch} @@ to_tsquery('english', ${searchParam})`);
```

```sql
select * from posts where body_search @@ to_tsquery('english', 'bring');
```
</Section>

è¿™æ˜¯ä¸€ä¸ªæ›´é«˜çº§çš„æ¨¡å¼ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªç”Ÿæˆåˆ—ã€‚`search` åˆ—æ˜¯ç”± `title` å’Œ `body` åˆ—ç”Ÿæˆçš„ï¼Œ`setweight()` å‡½æ•°ç”¨äºä¸ºå…¨æ–‡æœç´¢åˆ†é…ä¸åŒçš„æƒé‡ã€‚è¿™é€šå¸¸ç”¨äºæ ‡è®°æ¥è‡ªæ–‡æ¡£ä¸åŒéƒ¨åˆ†çš„æ¡ç›®ï¼Œå¦‚æ ‡é¢˜ä¸æ­£æ–‡ã€‚

<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {18,19,20,21,22,23,24,28}
import { SQL, sql } from 'drizzle-orm';
import { index, pgTable, serial, text, customType } from 'drizzle-orm/pg-core';

export const tsvector = customType<{
  data: string;
}>({
  dataType() {
    return `tsvector`;
  },
});

export const posts = pgTable(
 'posts',
 {
   id: serial('id').primaryKey(),
   title: text('title').notNull(),
   body: text('body').notNull(),
   search: tsvector('search')
     .notNull()
     .generatedAlwaysAs(
        (): SQL =>
         sql`setweight(to_tsvector('english', ${posts.title}), 'A')
          ||
          setweight(to_tsvector('english', ${posts.body}), 'B')`,
     ),
  },
  (t) => [
    index('idx_search').using('gin', t.search),
  ],
);
  ```
  </CodeTab>
  ```sql
CREATE TABLE "posts" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"body" text NOT NULL,
	"search" "tsvector" GENERATED ALWAYS AS (setweight(to_tsvector('english', "posts"."title"), 'A')
          ||
          setweight(to_tsvector('english', "posts"."body"), 'B')) STORED NOT NULL
);
--> statement-breakpoint
CREATE INDEX "idx_search" ON "posts" USING gin ("search");
  ```
</CodeTabs>

è¿™å°±æ˜¯å¦‚ä½•ä½¿ç”¨å…¨æ–‡æœç´¢æŸ¥è¯¢è¡¨çš„æ–¹æ³•ï¼š

<Section>
```ts copy {6}
const search = 'travel';

await db
  .select()
  .from(posts)
  .where(sql`${posts.search} @@ to_tsquery('english', ${search})`);
```

```sql
select * from posts where search @@ to_tsquery('english', 'travel');
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/gel-ext-auth

import Prerequisites from "@mdx/Prerequisites.astro";
import Callout from "@mdx/Callout.astro";
import Npx from "@mdx/Npx.astro";

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [Gel](/docs/get-started-gel)
- ä½¿ç”¨ [drizzle-kit pull](/docs/drizzle-kit-pull)
</Prerequisites>

#### ç¬¬ä¸€æ­¥ - å®šä¹‰ Gel è®¤è¯ schema

åœ¨ `dbschema/default.esdl` æ–‡ä»¶ä¸­æ·»åŠ å¸¦æœ‰è®¤è¯æ‰©å±•çš„ Gel schema

```esdl
using extension auth;

module default {
  global current_user := (
    assert_single((
      select User { id, username, email }
      filter .identity = global ext::auth::ClientTokenIdentity
    ))
  );

  type User {
    required identity: ext::auth::Identity;
    required username: str;
    required email: str;
  }
}
```

#### ç¬¬äºŒæ­¥ - å°† Gel schema æ¨é€åˆ°æ•°æ®åº“

ç”Ÿæˆ Gel è¿ç§»æ–‡ä»¶ï¼š
```bash
gel migration create
```

å°† Gel è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“
```bash
gel migration apply
```

#### ç¬¬ä¸‰æ­¥ - è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - æ˜¯ä¸€ä¸ªè¢« [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å…³äºæ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œ schema æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'gel',
  // ä¸º drizzle-kit å¯ç”¨ auth schema
  schemaFilter: ['ext::auth', 'public']
});
```

#### ç¬¬å››æ­¥ - å°† Gel ç±»å‹æ‹‰å–åˆ° Drizzle schema

æ‹‰å–ä½ çš„æ•°æ®åº“ schemaï¼š
<Npx>
drizzle-kit pull
</Npx>

ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„ schema.ts æ–‡ä»¶ç¤ºä¾‹ï¼š

<Callout type="warning">
ä½ ä¸ä»…ä¼šè·å¾—æ¥è‡ª `ext::auth` çš„ `Identity` è¡¨ï¼ŒDrizzle ä¼šæ‹‰å–æ‰€æœ‰ä½ å¯ä»¥ä½¿ç”¨çš„ `auth` è¡¨ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»…å±•ç¤ºå…¶ä¸­ä¸€ä¸ªã€‚
</Callout>

```ts
import { gelTable, uniqueIndex, uuid, text, gelSchema, timestamptz, foreignKey } from "drizzle-orm/gel-core"
import { sql } from "drizzle-orm"

export const extauth = gelSchema('ext::auth');

export const identityInExtauth = extauth.table('Identity', {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	createdAt: timestamptz('created_at').default(sql`(clock_timestamp())`).notNull(),
	issuer: text().notNull(),
	modifiedAt: timestamptz('modified_at').notNull(),
	subject: text().notNull(),
}, (table) => [
	uniqueIndex('6bc2dd19-bce4-5810-bb1b-7007afe97a11;schemaconstr').using(
		'btree',
		table.id.asc().nullsLast().op('uuid_ops'),
	),
]);

export const user = gelTable('User', {
	id: uuid().default(sql`uuid_generate_v4()`).primaryKey().notNull(),
	email: text().notNull(),
	identityId: uuid('identity_id').notNull(),
	username: text().notNull(),
}, (table) => [
	uniqueIndex('d504514c-26a7-11f0-b836-81aa188c0abe;schemaconstr').using(
		'btree',
		table.id.asc().nullsLast().op('uuid_ops'),
	),
	foreignKey({
		columns: [table.identityId],
		foreignColumns: [identityInExtauth.id],
		name: 'User_fk_identity',
	}),
]);
```

ğŸ‰ ç°åœ¨ä½ å¯ä»¥åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ `auth` è¡¨äº†ï¼

Source: https://drizzle.zhcndoc.com/docs/include-or-exclude-columns


import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [é€‰æ‹©è¯­å¥](/docs/select)
- [è·å–ç±»å‹åŒ–è¡¨åˆ—](/docs/goodies#get-typed-table-columns)
- [è¿æ¥](/docs/joins)
- [å…³ç³»æŸ¥è¯¢](/docs/rqb)
- [ä½¿ç”¨å…³ç³»æŸ¥è¯¢çš„éƒ¨åˆ†é€‰æ‹©](/docs/rqb#partial-fields-select)
</Prerequisites>

Drizzle æä¾›äº†çµæ´»çš„ API ç”¨äºåœ¨æŸ¥è¯¢ä¸­åŒ…å«æˆ–æ’é™¤åˆ—ã€‚è¦åŒ…å«æ‰€æœ‰åˆ—ï¼Œå¯ä»¥ä½¿ç”¨ `.select()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
	<CodeTab>
    ```ts copy {5}
    import { posts } from './schema';

    const db = drizzle(...);

    await db.select().from(posts);
    ```

    ```ts
    // ç»“æœç±»å‹
    type Result = {
      id: number;
      title: string;
      content: string;
      views: number;
    }[];
    ```
  </CodeTab>

  ```ts
  import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const posts = pgTable('posts', {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    content: text('content').notNull(),
    views: integer('views').notNull().default(0),
  });
	```
</CodeTabs>

è¦åŒ…å«ç‰¹å®šåˆ—ï¼Œå¯ä»¥ä½¿ç”¨ `.select()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
  ```ts copy {1}
  await db.select({ title: posts.title }).from(posts);
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    title: string;
  }[];
  ```
</Section>

è¦åŒ…å«æ‰€æœ‰åˆ—å¹¶æ·»åŠ é¢å¤–åˆ—ï¼Œå¯ä»¥ä½¿ç”¨ `getColumns()` å·¥å…·å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Callout type='warning'>
`getColumns` ä» `drizzle-orm@1.0.0-beta.2` å¼€å§‹æä¾›ï¼ˆè¯¦ç»†ä¿¡æ¯è¯·å‚è§ [è¿™é‡Œ](/docs/upgrade-v1)ï¼‰

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ 1 ç‰ˆæœ¬ä¹‹å‰ï¼ˆæ¯”å¦‚ `0.45.1`ï¼‰ï¼Œè¯·ä½¿ç”¨ `getTableColumns`
</Callout>

<Section>
  ```ts copy {5,6}
  import { getColumns, sql } from 'drizzle-orm';

  await db
    .select({
      ...getColumns(posts),
      titleLength: sql<number>`length(${posts.title})`,
    })
    .from(posts);
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    id: number;
    title: string;
    content: string;
    views: number;
    titleLength: number;
  }[];
  ```
</Section>

è¦æ’é™¤åˆ—ï¼Œå¯ä»¥ä½¿ç”¨ `getColumns()` å·¥å…·å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Callout type='warning'>
`getColumns` ä» `drizzle-orm@1.0.0-beta.2` å¼€å§‹æä¾›ï¼ˆè¯¦ç»†ä¿¡æ¯è¯·å‚è§ [è¿™é‡Œ](/docs/upgrade-v1)ï¼‰

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ 1 ç‰ˆæœ¬ä¹‹å‰ï¼ˆæ¯”å¦‚ `0.45.1`ï¼‰ï¼Œè¯·ä½¿ç”¨ `getTableColumns`
</Callout>

<Section>
  ```ts copy {3,5}
  import { getColumns } from 'drizzle-orm';

  const { content, ...rest } = getColumns(posts); // æ’é™¤ "content" åˆ—

  await db.select({ ...rest }).from(posts); // é€‰æ‹©æ‰€æœ‰å…¶ä»–åˆ—
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    id: number;
    title: string;
    views: number;
  }[];
  ```
</Section>

è¿™å°±æ˜¯å¦‚ä½•åœ¨è¿æ¥ä¸­åŒ…å«æˆ–æ’é™¤åˆ—ï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {5,9,10,11}
    import { eq, getColumns } from 'drizzle-orm';
    import { comments, posts, users } from './db/schema';

    // ä» "comments" ä¸­æ’é™¤ "userId" å’Œ "postId" åˆ—
    const { userId, postId, ...rest } = getColumns(comments);

    await db
      .select({
        postId: posts.id, // åŒ…å« "posts" ä¸­çš„ "id" åˆ—
        comment: { ...rest }, // åŒ…å«æ‰€æœ‰å…¶ä»–åˆ—
        user: users, // ç­‰åŒäº getColumns(users)
      })
      .from(posts)
      .leftJoin(comments, eq(posts.id, comments.postId))
      .leftJoin(users, eq(users.id, posts.userId));
    ```

    ```ts
    // ç»“æœç±»å‹
    type Result = {
      postId: number;
      comment: {
        id: number;
        content: string;
        createdAt: Date;
      } | null;
      user: {
        id: number;
        name: string;
        email: string;
      } | null;
    }[];
    ```
  </CodeTab>

  ```ts copy
  import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

  export const users = pgTable('users', {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
    email: text('email').notNull(),
  });

  export const posts = pgTable('posts', {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    content: text('content').notNull(),
    views: integer('views').notNull().default(0),
    userId: integer('user_id').notNull().references(() => users.id),
  });

  export const comments = pgTable('comments', {
    id: serial('id').primaryKey(),
    postId: integer('post_id').notNull().references(() => posts.id),
    userId: integer('user_id').notNull().references(() => users.id),
    content: text('content').notNull(),
    createdAt: timestamp('created_at').notNull().defaultNow(),
  });
  ```
</CodeTabs>

Drizzle æä¾›äº†æœ‰ç”¨çš„å…³ç³»æŸ¥è¯¢ APIï¼Œä½¿æ‚¨å¯ä»¥è½»æ¾åŒ…å«æˆ–æ’é™¤æŸ¥è¯¢ä¸­çš„åˆ—ã€‚è¿™å°±æ˜¯å¦‚ä½•åŒ…å«æ‰€æœ‰åˆ—ï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {5,7,8,9,12,13,14,17,18,19,20,21,22}
    import * as schema from './schema';

    const db = drizzle(..., { schema });

    await db.query.posts.findMany();
    ```

    ```ts
    // ç»“æœç±»å‹
    type Result = {
      id: number;
      title: string;
      content: string;
      views: number;
    }[]
    ```
  </CodeTab>

  ```ts copy
  import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const posts = pgTable('posts', {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    content: text('content').notNull(),
    views: integer('views').notNull().default(0),
  });
	```
</CodeTabs>

è¿™å°±æ˜¯å¦‚ä½•ä½¿ç”¨å…³ç³»æŸ¥è¯¢åŒ…å«ç‰¹å®šåˆ—ï¼š

<Section>
  ```ts copy {2,3,4}
  await db.query.posts.findMany({
    columns: {
      title: true,
    },
  });
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    title: string;
  }[]
  ```
</Section>

è¿™å°±æ˜¯å¦‚ä½•ä½¿ç”¨å…³ç³»æŸ¥è¯¢åŒ…å«æ‰€æœ‰åˆ—å¹¶æ·»åŠ é¢å¤–åˆ—ï¼š

<Section>
  ```ts copy {4,5,6}
  import { sql } from 'drizzle-orm';

  await db.query.posts.findMany({
    extras: {
      titleLength: sql<number>`length(${posts.title})`.as('title_length'),
    },
  });
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    id: number;
    title: string;
    content: string;
    views: number;
    titleLength: number;
  }[];
  ```
</Section>

è¿™å°±æ˜¯å¦‚ä½•ä½¿ç”¨å…³ç³»æŸ¥è¯¢æ’é™¤åˆ—ï¼š

<Section>
  ```ts copy {2,3,4}
  await db.query.posts.findMany({
    columns: {
      content: false,
    },
  });
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    id: number;
    title: string;
    views: number;
  }[]
  ```
</Section>

è¿™å°±æ˜¯å¦‚ä½•ä½¿ç”¨å…³ç³»æŸ¥è¯¢åŒ…å«æˆ–æ’é™¤ä¸å…³ç³»ç›¸å…³çš„åˆ—ï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
  ```ts copy {7,12,13,16}
  import * as schema from './schema';

  const db = drizzle(..., { schema });

  await db.query.posts.findMany({
    columns: {
      id: true, // åŒ…å« "id" åˆ—
    },
    with: {
      comments: {
        columns: {
          userId: false, // æ’é™¤ "userId" åˆ—
          postId: false, // æ’é™¤ "postId" åˆ—
        },
      },
      user: true, // åŒ…å« "users" è¡¨ä¸­çš„æ‰€æœ‰åˆ—
    },
  });
  ```

  ```ts
  // ç»“æœç±»å‹
  type Result = {
    id: number;
    user: {
      id: number;
      name: string;
      email: string;
    };
    comments: {
      id: number;
      content: string;
      createdAt: Date;
    }[];
  }[]
  ```
  </CodeTab>

  ```ts copy
  import { relations } from 'drizzle-orm';
  import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

  export const users = pgTable('users', {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
    email: text('email').notNull(),
  });

  export const posts = pgTable('posts', {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    content: text('content').notNull(),
    views: integer('views').notNull().default(0),
    userId: integer('user_id').notNull().references(() => users.id),
  });

  export const comments = pgTable('comments', {
    id: serial('id').primaryKey(),
    postId: integer('post_id').notNull().references(() => posts.id),
    userId: integer('user_id').notNull().references(() => users.id),
    content: text('content').notNull(),
    createdAt: timestamp('created_at').notNull().defaultNow(),
  });

  export const usersRelations = relations(users, ({ many }) => ({
    posts: many(posts),
    comments: many(comments),
  }));

  export const postsRelations = relations(posts, ({ many, one }) => ({
    comments: many(comments),
    user: one(users, { fields: [posts.userId], references: [users.id] }),
  }));

  export const commentsRelations = relations(comments, ({ one }) => ({
    post: one(posts, { fields: [comments.postId], references: [posts.id] }),
    user: one(users, { fields: [comments.userId], references: [users.id] }),
  }));
  ```
</CodeTabs>

è¿™å°±æ˜¯å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰æ¡ä»¶é€‰æ‹©è§£å†³æ–¹æ¡ˆï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {7}
    import { posts } from './schema';

    const searchPosts = async (withTitle = false) => {
      await db
        .select({
          id: posts.id,
          ...(withTitle && { title: posts.title }),
        })
        .from(posts);
    };

    await searchPosts();
    await searchPosts(true);
    ```

    ```ts
    // ç»“æœç±»å‹
    type Result = {
      id: number;
      title?: string | undefined;
    }[];
    ```
  </CodeTab>

  ```ts copy
  import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const posts = pgTable('posts', {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    content: text('content').notNull(),
    views: integer('views').notNull().default(0),
  });
	```
</CodeTabs>

Source: https://drizzle.zhcndoc.com/docs/incrementing-a-value

import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [æ›´æ–°è¯­å¥](/docs/update)
- [è¿‡æ»¤å™¨](/docs/operators) å’Œ [SQL æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

è¦å¢åŠ åˆ—çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `update().set()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```ts copy {8}
import { eq, sql } from 'drizzle-orm';

const db = drizzle(...)
  
await db
  .update(table)
  .set({
    counter: sql`${table.counter} + 1`,
  })
  .where(eq(table.id, 1));
```

```sql
update "table" set "counter" = "counter" + 1 where "id" = 1;
```
</Section>

Drizzle å…·æœ‰ç®€å•ä¸”çµæ´»çš„ APIï¼Œå…è®¸æ‚¨è½»æ¾åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰å¢é‡å‡½æ•°ï¼š

```ts copy {4,10,11}
import { AnyColumn } from 'drizzle-orm';

const increment = (column: AnyColumn, value = 1) => {
  return sql`${column} + ${value}`;
};

await db
  .update(table)
  .set({
    counter1: increment(table.counter1),
    counter2: increment(table.counter2, 10),
  })
  .where(eq(table.id, 1));
```


Source: https://drizzle.zhcndoc.com/docs/limit-offset-pagination


import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ï¼Œ[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [é€‰æ‹©è¯­å¥](/docs/select) ä¸­ä½¿ç”¨ [æ’åºå­å¥](/docs/select#order-by) å’Œ [é™åˆ¶ä¸åç§»å­å¥](/docs/select#limit--offset)
- ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢](/docs/rqb) çš„ [æ’åºå­å¥](/docs/rqb#order-by) å’Œ [é™åˆ¶ä¸åç§»å­å¥](/docs/rqb#limit--offset)
- [åŠ¨æ€æŸ¥è¯¢æ„å»º](/docs/dynamic-query-building)
</Prerequisites>

æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•åœ¨ Drizzle ä¸­å®ç° `limit/offset` åˆ†é¡µï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {9,10,11}
    import { asc } from 'drizzle-orm';
    import { users } from './schema';

    const db = drizzle(...);

    await db
      .select()
      .from(users)
      .orderBy(asc(users.id)) // å¿…é¡»æœ‰æ’åº
      .limit(4) // è¿”å›çš„è¡Œæ•°
      .offset(4); // è·³è¿‡çš„è¡Œæ•°
    ```

    ```sql
    select * from users order by id asc limit 4 offset 4;
    ```

    ```ts
    // è¿”å›ç¬¬5-8è¡Œ
    [
      {
        id: 5,
        firstName: 'Beth',
        lastName: 'Davis',
        createdAt: 2024-03-11T20:51:46.787Z
      },
      {
        id: 6,
        firstName: 'Charlie',
        lastName: 'Miller',
        createdAt: 2024-03-11T21:15:46.787Z
      },
      {
        id: 7,
        firstName: 'Clara',
        lastName: 'Wilson',
        createdAt: 2024-03-11T21:33:46.787Z
      },
      {
        id: 8,
        firstName: 'David',
        lastName: 'Moore',
        createdAt: 2024-03-11T21:45:46.787Z
      }
    ]
    ```
  </CodeTab>
  <CodeTab>
    ```ts copy
    import { pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

    export const users = pgTable('users', {
      id: serial('id').primaryKey(),
      firstName: text('first_name').notNull(),
      lastName: text('last_name').notNull(),
      createdAt: timestamp('created_at').notNull().defaultNow(),
    });
    ```

    ```plaintext
    +----+------------+-----------+----------------------------+
    | id | first_name | last_name |         created_at         |
    +----+------------+-----------+----------------------------+
    |  1 | Alice      | Johnson   | 2024-03-08 12:23:55.251797 |
    +----+------------+-----------+----------------------------+
    |  2 | Alex       | Smith     | 2024-03-08 12:25:55.182    |
    +----+------------+-----------+----------------------------+
    |  3 | Aaron      | Williams  | 2024-03-08 12:28:55.182    |
    +----+------------+-----------+----------------------------+
    |  4 | Brian      | Brown     | 2024-03-08 12:34:55.182    |
    +----+------------+-----------+----------------------------+
    |  5 | Beth       | Davis     | 2024-03-08 12:40:55.182    |
    +----+------------+-----------+----------------------------+
    |  6 | Charlie    | Miller    | 2024-03-08 13:04:55.182    |
    +----+------------+-----------+----------------------------+
    |  7 | Clara      | Wilson    | 2024-03-08 13:22:55.182    |
    +----+------------+-----------+----------------------------+
    |  8 | David      | Moore     | 2024-03-08 13:34:55.182    |
    +----+------------+-----------+----------------------------+
    ```
  </CodeTab>
</CodeTabs>

é™åˆ¶æ˜¯è¦è¿”å›çš„è¡Œæ•°ï¼ˆ`é¡µé¢å¤§å°`ï¼‰ï¼Œè€Œåç§»æ˜¯è¦è·³è¿‡çš„è¡Œæ•°ï¼ˆ`(é¡µé¢å· - 1) * é¡µé¢å¤§å°`ï¼‰ã€‚ 
ä¸ºäº†ç¡®ä¿åˆ†é¡µä¸€è‡´æ€§ï¼Œå¿…é¡»æŒ‰å”¯ä¸€åˆ—æ’åºã€‚å¦åˆ™ï¼Œç»“æœå¯èƒ½ä¼šä¸ä¸€è‡´ã€‚

å¦‚æœéœ€è¦æŒ‰ç…§éå”¯ä¸€åˆ—æ’åºï¼Œä¹Ÿåº”åœ¨æ’åºä¸­é™„åŠ ä¸€ä¸ªå”¯ä¸€åˆ—ã€‚

ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ä¸¤ä¸ªåˆ—å®ç° `limit/offset` åˆ†é¡µçš„ç¤ºä¾‹ï¼š

<Section>
```ts copy {5}
const getUsers = async (page = 1, pageSize = 3) => {
  await db
    .select()
    .from(users)
    .orderBy(asc(users.firstName), asc(users.id)) // æŒ‰ first_nameï¼ˆéå”¯ä¸€ï¼‰å’Œ idï¼ˆä¸»é”®ï¼‰æ’åº
    .limit(pageSize) 
    .offset((page - 1) * pageSize);
}

await getUsers();
```
</Section>

Drizzle å…·æœ‰å®ç”¨çš„å…³ç³»æŸ¥è¯¢ APIï¼Œå¯ä»¥è½»æ¾å®ç° `limit/offset` åˆ†é¡µï¼š

<Section>
```ts copy {7,8,9}
import * as schema from './db/schema';

const db = drizzle({ schema });

const getUsers = async (page = 1, pageSize = 3) => {
  await db.query.users.findMany({
    orderBy: (users, { asc }) => asc(users.id),
    limit: pageSize,
    offset: (page - 1) * pageSize,
  });
};

await getUsers();
```
</Section>

Drizzle æä¾›ç®€å•ä¸”çµæ´»çš„ APIï¼Œè®©æ‚¨å¯ä»¥è½»æ¾åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ `.$dynamic()` å‡½æ•°åˆ›å»ºè‡ªå®šä¹‰åˆ†é¡µåŠŸèƒ½ï¼š

<Section>
```ts copy {11,12,13,16}
import { SQL, asc } from 'drizzle-orm';
import { PgColumn, PgSelect } from 'drizzle-orm/pg-core';

function withPagination<T extends PgSelect>(
  qb: T,
  orderByColumn: PgColumn | SQL | SQL.Aliased,
  page = 1,
  pageSize = 3,
) {
  return qb
    .orderBy(orderByColumn)
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

const query = db.select().from(users); // éœ€è¦è¿›è¡Œåˆ†é¡µçš„æŸ¥è¯¢

await withPagination(query.$dynamic(), asc(users.id));
```

</Section>

æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `å»¶è¿Ÿè¿æ¥` æŠ€æœ¯æ¥æé«˜ `limit/offset` åˆ†é¡µçš„æ€§èƒ½ã€‚æ­¤æ–¹æ³•åœ¨æ•°æ®çš„ä¸€ä¸ªå­é›†ä¸Šæ‰§è¡Œåˆ†é¡µï¼Œè€Œä¸æ˜¯åœ¨æ•´ä¸ªè¡¨ä¸Šã€‚

æ‚¨å¯ä»¥è¿™æ ·å®ç°ï¼š

```ts copy {10}
const getUsers = async (page = 1, pageSize = 10) => {
   const sq = db
    .select({ id: users.id })
    .from(users)
    .orderBy(users.id)
    .limit(pageSize)
    .offset((page - 1) * pageSize)
    .as('subquery');

   await db.select().from(users).innerJoin(sq, eq(users.id, sq.id)).orderBy(users.id);
};
```

**`limit/offset` åˆ†é¡µçš„å¥½å¤„**ï¼šå®ç°ç®€å•ï¼Œé¡µé¢å®¹æ˜“è®¿é—®ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä¸ä¿å­˜å…ˆå‰é¡µé¢çŠ¶æ€çš„æƒ…å†µä¸‹å¯¼èˆªåˆ°ä»»ä½•é¡µé¢ã€‚

**`limit/offset` åˆ†é¡µçš„ç¼ºç‚¹**ï¼šéšç€åç§»é‡çš„å¢åŠ ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™ï¼Œå› ä¸ºæ•°æ®åº“å¿…é¡»æ‰«ææ‰€æœ‰åœ¨åç§»é‡ä¹‹å‰çš„è¡Œä»¥è·³è¿‡å®ƒä»¬ï¼Œä»¥åŠç”±äºæ•°æ®ç§»åŠ¨é€ æˆçš„ä¸ä¸€è‡´æ€§ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒä¸€è¡Œåœ¨ä¸åŒé¡µé¢ä¸Šè¢«è¿”å›æˆ–è¡Œè¢«è·³è¿‡ã€‚

å®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

<Section>
```ts copy
const getUsers = async (page = 1, pageSize = 3) => {
  await db
    .select()
    .from(users)
    .orderBy(asc(users.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
};

// ç”¨æˆ·æ­£åœ¨æµè§ˆç¬¬ä¸€é¡µ
await getUsers();
```

```ts
// ç¬¬ä¸€é¡µçš„ç»“æœ
[
  {
    id: 1,
    firstName: 'Alice',
    lastName: 'Johnson',
    createdAt: 2024-03-10T17:17:06.148Z
  },
  {
    id: 2,
    firstName: 'Alex',
    lastName: 'Smith',
    createdAt: 2024-03-10T17:19:06.147Z
  },
  {
    id: 3,
    firstName: 'Aaron',
    lastName: 'Williams',
    createdAt: 2024-03-10T17:22:06.147Z
  }
]
```

```ts
// å½“ç”¨æˆ·æµè§ˆç¬¬ä¸€é¡µæ—¶ï¼Œåˆ é™¤äº† id ä¸º 2 çš„è¡Œ
await db.delete(users).where(eq(users.id, 2));

// ç”¨æˆ·å¯¼èˆªåˆ°ç¬¬äºŒé¡µ
await getUsers(2);
```

```ts
// ç¬¬äºŒé¡µï¼Œid ä¸º 3 çš„è¡Œè¢«è·³è¿‡
[
  {
    id: 5,
    firstName: 'Beth',
    lastName: 'Davis',
    createdAt: 2024-03-10T17:34:06.147Z
  },
  {
    id: 6,
    firstName: 'Charlie',
    lastName: 'Miller',
    createdAt: 2024-03-10T17:58:06.147Z
  },
  {
    id: 7,
    firstName: 'Clara',
    lastName: 'Wilson',
    createdAt: 2024-03-10T18:16:06.147Z
  }
]
```
</Section>

å› æ­¤ï¼Œå¦‚æœæ‚¨çš„æ•°æ®åº“åœ¨å®æ—¶ä¸­é¢‘ç¹æ‰§è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œæˆ–è€…æ‚¨éœ€è¦å¯¹å¤§å‹è¡¨è¿›è¡Œé«˜æ€§èƒ½åˆ†é¡µï¼Œæ‚¨åº”è¯¥è€ƒè™‘ä½¿ç”¨ [åŸºäºæ¸¸æ ‡](/docs/guides/cursor-based-pagination) çš„åˆ†é¡µã€‚

è¦äº†è§£æœ‰å…³ `å»¶è¿Ÿè¿æ¥` æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å‚è€ƒä»¥ä¸‹æŒ‡å—ï¼š[Planetscale åˆ†é¡µæŒ‡å—](https://planetscale.com/blog/mysql-pagination) å’Œ [Aaron Francis çš„é«˜æ•ˆåˆ†é¡µæŒ‡å—](https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins)ã€‚


Source: https://drizzle.zhcndoc.com/docs/mysql-local-setup


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Steps from '@mdx/Steps.astro';

<Prerequisites>
- å®‰è£…æœ€æ–°çš„ [Docker Desktop](https://www.docker.com/products/docker-desktop/)ã€‚è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»ŸæŒ‰ç…§è¯´æ˜è¿›è¡Œå®‰è£…ã€‚
</Prerequisites>

<Steps>

#### æ‹‰å– MySQL é•œåƒ

ä» Docker Hub æ‹‰å–æœ€æ–°çš„ MySQL é•œåƒã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œ `docker pull mysql` å‘½ä»¤æ¥æ‹‰å–æœ€æ–°çš„ MySQL ç‰ˆæœ¬ï¼š

```bash copy
docker pull mysql
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥æŒ‰ç‰¹å®šæ ‡ç­¾æ‹‰å–æ‰€éœ€çš„ç‰ˆæœ¬ï¼š

```bash copy
docker pull mysql:8.2
```

å½“ MySQL é•œåƒä¸‹è½½å®Œæˆåï¼Œæ‚¨å¯ä»¥åœ¨ Docker Desktop çš„â€œImagesâ€é€‰é¡¹å¡ä¸­æŸ¥çœ‹ï¼Œæˆ–é€šè¿‡è¿è¡Œ `docker images` å‘½ä»¤æ¥æŸ¥çœ‹ï¼š

<Section>
```bash copy
docker images
```

```plaintext
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
mysql        latest    4e8a34aea708   2 months ago   609MB
```
</Section>

#### å¯åŠ¨ MySQL å®ä¾‹

è¦å¯åŠ¨ä¸€ä¸ªæ–°çš„ MySQL å®¹å™¨ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
docker run --name drizzle-mysql -e MYSQL_ROOT_PASSWORD=mypassword -d -p 3306:3306 mysql
```

1. `--name` é€‰é¡¹ç»™å®¹å™¨åˆ†é…åç§° `drizzle-mysql`ã€‚
2. `-e MYSQL_ROOT_PASSWORD=` é€‰é¡¹è®¾ç½® `MYSQL_ROOT_PASSWORD` ç¯å¢ƒå˜é‡ä¸ºæŒ‡å®šçš„å€¼ã€‚è¿™æ˜¯æ ¹ç”¨æˆ·çš„å¯†ç ã€‚
3. `-d` æ ‡å¿—ä½¿å®¹å™¨åœ¨åˆ†ç¦»æ¨¡å¼ä¸‹è¿è¡Œï¼ˆåœ¨åå°ï¼‰ã€‚
4. `-p` é€‰é¡¹å°†å®¹å™¨çš„ `3306` ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ `3306` ç«¯å£ï¼Œä½¿ MySQL å¯ä»¥é€šè¿‡è¯¥ç«¯å£ä»ä¸»æœºç³»ç»Ÿè®¿é—®ã€‚
5. `mysql` å‚æ•°æŒ‡å®šç”¨äºå®¹å™¨çš„é•œåƒã€‚æ‚¨ä¹Ÿå¯ä»¥æŒ‡å®šå…¶ä»–ç‰ˆæœ¬ï¼Œå¦‚ `mysql:8.2`ã€‚

æ‚¨è¿˜å¯ä»¥æŒ‡å®šå…¶ä»–å‚æ•°ï¼Œä¾‹å¦‚ï¼š

1. `-e MYSQL_DATABASE=` åœ¨åˆ›å»ºå®¹å™¨æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚é»˜è®¤å€¼ä¸º `mysql`ã€‚
2. `-e MYSQL_USER=` å’Œ `-e MYSQL_PASSWORD=` åœ¨åˆ›å»ºå®¹å™¨æ—¶åˆ›å»ºä¸€ä¸ªå…·æœ‰å¯†ç çš„æ–°ç”¨æˆ·ã€‚ä¸è¿‡ï¼Œæ‚¨ä»éœ€ä¸º `root` ç”¨æˆ·æŒ‡å®š `MYSQL_ROOT_PASSWORD`ã€‚

è¦æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œè¯·æŸ¥çœ‹ Docker Desktop çš„â€œContainersâ€é€‰é¡¹å¡æˆ–ä½¿ç”¨ `docker ps` å‘½ä»¤ï¼š

```plaintext
CONTAINER ID   IMAGE         COMMAND                  CREATED          STATUS          PORTS                               NAMES
19506a8dc12b   mysql         "docker-entrypoint.sâ€¦"   4 seconds ago    Up 3 seconds    33060/tcp, 0.0.0.0:3306->3306/tcp   drizzle-mysql
```

#### é…ç½®æ•°æ®åº“ URL

è¦è¿æ¥åˆ° MySQL æ•°æ®åº“ï¼Œæ‚¨éœ€è¦æä¾›æ•°æ®åº“ URLã€‚URL æ ¼å¼ä¸ºï¼š

```plaintext
mysql://<user>:<password>@<host>:<port>/<database>
```

æ‚¨åº”è¯¥ç”¨å®é™…å€¼æ›¿æ¢å ä½ç¬¦ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹åˆ›å»ºçš„å®¹å™¨ï¼ŒURL å°†ä¸ºï¼š

```plaintext
mysql://root:mypassword@localhost:3306/mysql
```

ç°åœ¨æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¯¥ URL è¿æ¥åˆ°æ•°æ®åº“ã€‚
</Steps>


Source: https://drizzle.zhcndoc.com/docs/point-datatype-psql


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)
- [ç‚¹æ•°æ®ç±»å‹](/docs/column-types/pg#point)
- [é€‰æ‹©è¯­å¥ä¸­çš„è¿‡æ»¤](/docs/select#filtering)
- [sql æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

PostgreSQL å…·æœ‰ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ç”¨äºå­˜å‚¨å‡ ä½•æ•°æ®ï¼Œç§°ä¸º `point`ã€‚å®ƒç”¨äºè¡¨ç¤ºäºŒç»´ç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹ã€‚ç‚¹æ•°æ®ç±»å‹ä»¥ä¸€å¯¹ `(x, y)` åæ ‡è¡¨ç¤ºã€‚
ç‚¹æ•°æ®ç±»å‹æœŸå¾…å…ˆæ¥æ”¶ç»åº¦ï¼Œç„¶åæ˜¯çº¬åº¦ã€‚

<Section>
```ts copy {6}
import { sql } from 'drizzle-orm';

const db = drizzle(...);

await db.execute(
  sql`select point(-90.9, 18.7)`,
);
```

```json
[ 
  { 
    point: '(-90.9,18.7)' 
  }
]
```
</Section>

ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Drizzle ä¸­åˆ›å»ºä¸€ä¸ªå…·æœ‰ `point` æ•°æ®ç±»å‹çš„è¡¨ï¼š

```ts {6}
import { pgTable, point, serial, text } from 'drizzle-orm/pg-core';

export const stores = pgTable('stores', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  location: point('location', { mode: 'xy' }).notNull(),
});
```

ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Drizzle ä¸­æ’å…¥ç‚¹æ•°æ®åˆ°è¡¨ä¸­ï¼š

```ts {4, 10, 16}
// mode: 'xy'
await db.insert(stores).values({
  name: 'Test',
  location: { x: -90.9, y: 18.7 },
});

// mode: 'tuple'
await db.insert(stores).values({
  name: 'Test',
  location: [-90.9, 18.7],
});

// sql åŸç”Ÿ
await db.insert(stores).values({
  name: 'Test',
  location: sql`point(-90.9, 18.7)`,
});
```

è¦è®¡ç®—å¯¹è±¡ä¹‹é—´çš„è·ç¦»ï¼Œå¯ä»¥ä½¿ç”¨ `<->` æ“ä½œç¬¦ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Drizzle ä¸­æ ¹æ®åæ ‡æŸ¥è¯¢æœ€è¿‘ä½ç½®ï¼š

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

<Section>
```ts {9, 14, 17}
import { getColumns, sql } from 'drizzle-orm';
import { stores } from './schema';

const point = {
  x: -73.935_242,
  y: 40.730_61,
};

const sqlDistance = sql`location <-> point(${point.x}, ${point.y})`;

await db
  .select({
    ...getColumns(stores),
    distance: sql`round((${sqlDistance})::numeric, 2)`,
  })
  .from(stores)
  .orderBy(sqlDistance)
  .limit(1);
```

```sql
select *, round((location <-> point(-73.935242, 40.73061))::numeric, 2)
from stores order by location <-> point(-73.935242, 40.73061)
limit 1;
```
</Section>

è¦è¿‡æ»¤è¡Œä»¥ä»…åŒ…æ‹¬ `point` ç±»å‹çš„ `location` åœ¨ç”±ä¸¤ä¸ªå¯¹è§’ç‚¹å®šä¹‰çš„æŒ‡å®šçŸ©å½¢è¾¹ç•Œå†…çš„è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `<@` æ“ä½œç¬¦ã€‚è¯¥æ“ä½œç¬¦æ£€æŸ¥ç¬¬ä¸€ä¸ªå¯¹è±¡æ˜¯å¦è¢«åŒ…å«åœ¨ç¬¬äºŒä¸ªå¯¹è±¡å†…æˆ–åœ¨å…¶ä¸Šï¼š

<Section>
```ts {12}
const point = {
  x1: -88,
  x2: -73,
  y1: 40,
  y2: 43,
};

await db
  .select()
  .from(stores)
  .where(
    sql`${stores.location} <@ box(point(${point.x1}, ${point.y1}), point(${point.x2}, ${point.y2}))`
  );
```

```sql
select * from stores where location <@ box(point(-88, 40), point(-73, 43));
```
</Section>





Source: https://drizzle.zhcndoc.com/docs/postgis-geometry-point


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<Prerequisites>
- äº†è§£å¦‚ä½•ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)
- [Postgis æ‰©å±•](/docs/extensions/pg#postgis)
- [ç´¢å¼•](/docs/indexes-constraints#indexes)
- [é€‰æ‹©è¯­å¥ä¸­çš„è¿‡æ»¤](/docs/select#filtering)
- [SQL æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

`PostGIS` é€šè¿‡æ”¯æŒå­˜å‚¨ã€ç´¢å¼•å’ŒæŸ¥è¯¢åœ°ç†ç©ºé—´æ•°æ®æ¥æ‰©å±• PostgreSQL å…³ç³»æ•°æ®åº“çš„èƒ½åŠ›ã€‚

ç›®å‰ï¼ŒDrizzle ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ‰©å±•ï¼Œå› æ­¤æ‚¨éœ€è¦æ‰‹åŠ¨åˆ›å»ºã€‚åˆ›å»ºä¸€ä¸ªç©ºçš„è¿ç§»æ–‡ä»¶å¹¶æ·»åŠ  SQL æŸ¥è¯¢ï¼š

<Section>
```bash
npx drizzle-kit generate --custom
```

```sql
CREATE EXTENSION postgis;
```
</Section>

ä»¥ä¸‹æ˜¯æ‚¨åœ¨ Drizzle ä¸­å¦‚ä½•åˆ›å»ºå…·æœ‰ `geometry` æ•°æ®ç±»å‹å’Œç©ºé—´ç´¢å¼•çš„è¡¨ï¼š

<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {8, 11}
  import { geometry, index, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const stores = pgTable(
    'stores',
    {
      id: serial('id').primaryKey(),
      name: text('name').notNull(),
      location: geometry('location', { type: 'point', mode: 'xy', srid: 4326 }).notNull(),
    },
    (t) => [
      index('spatial_index').using('gist', t.location),
    ]
  );
  ```
  </CodeTab>
  ```sql
  CREATE TABLE IF NOT EXISTS "stores" (
	  "id" serial PRIMARY KEY NOT NULL,
	  "name" text NOT NULL,
	  "location" geometry(point) NOT NULL
  );
  --> statement-breakpoint
  CREATE INDEX IF NOT EXISTS "spatial_index" ON "stores" USING gist ("location");
  ```
</CodeTabs>
 
ä»¥ä¸‹æ˜¯æ‚¨å¦‚ä½•åœ¨ Drizzle ä¸­æ’å…¥ `geometry` æ•°æ®ã€‚PostGIS ä¸­çš„ `ST_MakePoint()` ä½¿ç”¨æŒ‡å®šçš„åæ ‡åˆ›å»ºä¸€ä¸ª `point` ç±»å‹çš„å‡ ä½•å¯¹è±¡ã€‚
`ST_SetSRID()` å°†å‡ ä½•å›¾å½¢ä¸Šçš„ `SRID`ï¼ˆä¸ç‰¹å®šåæ ‡ç³»ç»Ÿã€å®¹å·®å’Œåˆ†è¾¨ç‡å…³è”çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰è®¾ç½®ä¸ºç‰¹å®šçš„æ•´æ•°å€¼ï¼š

```ts {4, 10, 16}
// mode: 'xy'
await db.insert(stores).values({
  name: 'Test',
  location: { x: -90.9, y: 18.7 },
});

// mode: 'tuple'
await db.insert(stores).values({
  name: 'Test',
  location: [-90.9, 18.7],
});

// sql raw
await db.insert(stores).values({
  name: 'Test',
  location: sql`ST_SetSRID(ST_MakePoint(-90.9, 18.7), 4326)`,
});
```

è¦è®¡ç®—å¯¹è±¡ä¹‹é—´çš„è·ç¦»ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `<->` æ“ä½œç¬¦å’Œ `ST_Distance()` å‡½æ•°ï¼Œå¯¹äº `geometry types` è¿”å›ä¸¤ä¸ªå‡ ä½•å½¢çŠ¶ä¹‹é—´çš„æœ€å°å¹³é¢è·ç¦»ã€‚è¿™æ˜¯æ‚¨å¦‚ä½•åœ¨ Drizzle ä¸­é€šè¿‡ PostGIS æŸ¥è¯¢æœ€è¿‘çš„ä½ç½®ï¼š

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

<Section>
```ts copy {9, 14, 17}
import { getColumns, sql } from 'drizzle-orm';
import { stores } from './schema';

const point = {
  x: -73.935_242,
  y: 40.730_61,
};

const sqlPoint = sql`ST_SetSRID(ST_MakePoint(${point.x}, ${point.y}), 4326)`;

await db
  .select({
    ...getColumns(stores),
    distance: sql`ST_Distance(${stores.location}, ${sqlPoint})`,
  })
  .from(stores)
  .orderBy(sql`${stores.location} <-> ${sqlPoint}`)
  .limit(1);
```

```sql
select *, ST_Distance(location, ST_SetSRID(ST_MakePoint(-73.935_242, 40.730_61), 4326))
from stores order by location <-> ST_SetSRID(ST_MakePoint(-73.935_242, 40.730_61), 4326)
limit 1;
```
</Section>

è¦è¿‡æ»¤ä½äºæŒ‡å®šçŸ©å½¢åŒºåŸŸå†…çš„å•†åº—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `ST_MakeEnvelope()` å’Œ `ST_Within()` å‡½æ•°ã€‚`ST_MakeEnvelope()` ä» X å’Œ Y çš„æœ€å°å€¼å’Œæœ€å¤§å€¼åˆ›å»ºä¸€ä¸ªçŸ©å½¢å¤šè¾¹å½¢ã€‚`ST_Within()` å¦‚æœå‡ ä½•å›¾å½¢ A åœ¨å‡ ä½•å›¾å½¢ B å†…éƒ¨åˆ™è¿”å› TRUEã€‚

<Section>
```ts copy {13}
const point = {
  x1: -88,
  x2: -73,
  y1: 40,
  y2: 43,
};

await db
  .select()
  .from(stores)
  .where(
    sql`ST_Within(
      ${stores.location}, ST_MakeEnvelope(${point.x1}, ${point.y1}, ${point.x2}, ${point.y2}, 4326)
    )`,
  );
```

```sql
select * from stores where ST_Within(location, ST_MakeEnvelope(-88, 40, -73, 43, 4326));
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/postgresql-full-text-search


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)
- [é€‰æ‹©è¯­å¥](/docs/select)
- [ç´¢å¼•](/docs/indexes-constraints#indexes)
- [SQL æ“ä½œç¬¦](/docs/sql)
- éœ€è¦ä½¿ç”¨ `drizzle-orm@0.31.0` å’Œ `drizzle-kit@0.22.0` æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚  
</Prerequisites>

æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•åœ¨ PostgreSQL ä¸­ä½¿ç”¨ Drizzle ORM å®ç°å…¨æ–‡æœç´¢ã€‚å…¨æ–‡æœç´¢æ˜¯ä¸€ç§ç”¨äºåœ¨æ–‡æ¡£æˆ–ä¸€ç»„æ–‡æ¡£ä¸­æœç´¢æ–‡æœ¬çš„æŠ€æœ¯ã€‚æ–‡æ¡£æ˜¯å…¨æ–‡æœç´¢ç³»ç»Ÿä¸­çš„æœç´¢å•ä½ã€‚PostgreSQL æä¾›äº†ä¸€ç»„å‡½æ•°æ¥å¤„ç†å…¨æ–‡æœç´¢ï¼Œä¾‹å¦‚ `to_tsvector` å’Œ `to_tsquery`ï¼š

`to_tsvector` å‡½æ•°å°†æ–‡æœ¬æ–‡æ¡£è§£æä¸ºæ ‡è®°ï¼Œå°†æ ‡è®°å‡å°‘ä¸ºè¯å…ƒï¼Œå¹¶è¿”å›ä¸€ä¸ª `tsvector`ï¼Œè¯¥ `tsvector` åˆ—å‡ºäº†è¯å…ƒåŠå…¶åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ï¼š

<Section>
```ts copy {6}
import { sql } from 'drizzle-orm';

const db = drizzle(...);

await db.execute(
  sql`select to_tsvector('english', 'Guide to PostgreSQL full-text search with Drizzle ORM')`,
);
```

```json
[
  {
    to_tsvector: "'drizzl':9 'full':5 'full-text':4
    'guid':1 'orm':10 'postgresql':3 'search':7 'text':6"
  }
]
```
</Section>

`to_tsquery` å‡½æ•°å°†å…³é”®å­—è½¬æ¢ä¸ºè§„èŒƒåŒ–çš„æ ‡è®°ï¼Œå¹¶è¿”å›ä¸€ä¸ªä¸ `tsvector` ä¸­çš„è¯å…ƒåŒ¹é…çš„ `tsquery`ã€‚`@@` æ“ä½œç¬¦ç”¨äºç›´æ¥åŒ¹é…ï¼š

<Section>
```ts copy {2, 3}
await db.execute(
  sql`select to_tsvector('english', 'Guide to PostgreSQL full-text search with Drizzle ORM')
    @@ to_tsquery('english', 'Drizzle') as match`,
);
```

```json
[ { match: true } ]
```
</Section>

ç›®å‰ï¼ŒDrizzle ä¸æ”¯æŒ `tsvector` ç±»å‹ï¼Œå› æ­¤æ‚¨éœ€è¦åŠ¨æ€åœ°è½¬æ¢ `text` åˆ—ä¸­çš„æ•°æ®ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·åœ¨æ‚¨çš„åˆ—ä¸Šåˆ›å»ºä¸€ä¸ª `GIN` ç´¢å¼•ï¼š

<CodeTabs items={["schema.ts", "migration.sql", "db_data"]}>
  <CodeTab>
  ```ts copy {10, 11}
  import { index, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const posts = pgTable(
    'posts',
    {
      id: serial('id').primaryKey(),
      title: text('title').notNull(),
    },
    (table) => [
      index('title_search_index').using('gin', sql`to_tsvector('english', ${table.title})`),
    ]
  );
  ```
  </CodeTab>
  <CodeTab>
  ```sql
  CREATE TABLE IF NOT EXISTS "posts" (
          "id" serial PRIMARY KEY NOT NULL,
          "title" text NOT NULL
  );

  CREATE INDEX IF NOT EXISTS "title_search_index" ON "posts"
    USING gin (to_tsvector('english', "title"));
  ```
  </CodeTab>
  ```json
  [
    { id: 1, title: 'Planning Your First Trip to Europe' },
    { id: 2, title: "Cultural Insights: Exploring Asia's Heritage" },
    { id: 3, title: 'Top 5 Destinations for a Family Trip' },
    { id: 4, title: 'Essential Hiking Gear for Mountain Enthusiasts' },
    { id: 5, title: 'Trip Planning: Choosing Your Next Destination' },
    { id: 6, title: 'Discovering Hidden Culinary Gems in Italy' },
    { id: 7, title: 'The Ultimate Road Trip Guide for Explorers' },
  ];
  ```
</CodeTabs>

è¦åœ¨ PostgreSQL ä¸­ä½¿ç”¨ Drizzle ORM å®ç°å…¨æ–‡æœç´¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `to_tsvector` å’Œ `to_tsquery` å‡½æ•°ä¸ `sql` æ“ä½œç¬¦ï¼š

<Section>
```ts copy {9}
import { sql } from 'drizzle-orm';
import { posts } from './schema';

const title = 'trip';

await db
  .select()
  .from(posts)
  .where(sql`to_tsvector('english', ${posts.title}) @@ to_tsquery('english', ${title})`);
```

```json
[
  { id: 1, title: 'Planning Your First Trip to Europe' },
  { id: 3, title: 'Top 5 Destinations for a Family Trip' },
  { id: 5, title: 'Trip Planning: Choosing Your Next Destination' },
  { id: 7, title: 'The Ultimate Road Trip Guide for Explorers' }
]
```
</Section>

è¦é€šè¿‡ä»»ä½•å…³é”®å­—è¿›è¡ŒåŒ¹é…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `|` æ“ä½œç¬¦ï¼š

<Section>
```ts copy {6}
const title = 'Europe | Asia';

await db
  .select()
  .from(posts)
  .where(sql`to_tsvector('english', ${posts.title}) @@ to_tsquery('english', ${title})`);
```

```json
[
  { id: 1, title: 'Planning Your First Trip to Europe' },
  { id: 2, title: "Cultural Insights: Exploring Asia's Heritage" }
]
```
</Section>

è¦åŒ¹é…å¤šä¸ªå…³é”®å­—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `plainto_tsquery` å‡½æ•°ï¼š

<Section>
```ts copy {7}
// 'discover & Italy'
const title = 'discover Italy';

await db
  .select()
  .from(posts)
  .where(sql`to_tsvector('english', ${posts.title}) @@ plainto_tsquery('english', ${title})`);
```

```sql
select * from posts
  where to_tsvector('english', title) @@ plainto_tsquery('english', 'discover Italy');
```

```json
[ { id: 6, title: 'Discovering Hidden Culinary Gems in Italy' } ]
```
</Section>

è¦åŒ¹é…çŸ­è¯­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `phraseto_tsquery` å‡½æ•°ï¼š

<Section>
```ts copy {8}
// å¦‚æœæŒ‰ "trip family" æŸ¥è¯¢ï¼Œå®ƒå°†ä¸ä¼šè¿”å›ä»»ä½•ç»“æœ
// 'family <-> trip'
const title = 'family trip';

await db
  .select()
  .from(posts)
  .where(sql`to_tsvector('english', ${posts.title}) @@ phraseto_tsquery('english', ${title})`);
```

```sql
select * from posts
  where to_tsvector('english', title) @@ phraseto_tsquery('english', 'family trip');
```

```json
[ { id: 3, title: 'Top 5 Destinations for a Family Trip' } ]
```
</Section>

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `websearch_to_tsquery` å‡½æ•°ï¼Œå®ƒæ˜¯ `to_tsquery` çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œå…·æœ‰ç±»ä¼¼äºç½‘ç»œæœç´¢å¼•æ“ä½¿ç”¨çš„æ›¿ä»£è¯­æ³•ï¼š

<Section>
```ts copy {7}
// 'family | first & trip & europe | asia'
const title = 'family or first trip Europe or Asia';

await db
  .select()
  .from(posts)
  .where(sql`to_tsvector('english', ${posts.title}) @@ websearch_to_tsquery('english', ${title})`);
```

```sql
select * from posts
  where to_tsvector('english', title)
  @@ websearch_to_tsquery('english', 'family or first trip Europe or Asia');
```

```json
[
  { id: 1, title: 'Planning Your First Trip to Europe' },
  { id: 2, title: "Cultural Insights: Exploring Asia's Heritage" },
  { id: 3, title: 'Top 5 Destinations for a Family Trip' }
]
```
</Section>

è¦åœ¨å¤šä¸ªåˆ—ä¸Šå®ç°å…¨æ–‡æœç´¢ï¼Œæ‚¨å¯ä»¥å¯¹å¤šä¸ªåˆ—åˆ›å»ºç´¢å¼•ï¼Œå¹¶ä½¿ç”¨ `to_tsvector` å‡½æ•°è¿æ¥è¿™äº›åˆ—ï¼š

<CodeTabs items={["schema.ts", "migration.sql", "db_data"]}>
  <CodeTab>
  ```ts copy {12-17}
  import { sql } from 'drizzle-orm';
  import { index, pgTable, serial, text } from 'drizzle-orm/pg-core';

  export const posts = pgTable(
    'posts',
    {
      id: serial('id').primaryKey(),
      title: text('title').notNull(),
      description: text('description').notNull(),
    },
    (table) => [
      index('search_index').using(
        'gin',
        sql`(
            setweight(to_tsvector('english', ${table.title}), 'A') ||
            setweight(to_tsvector('english', ${table.description}), 'B')
        )`,
      ),
    ],
  );
  ```
  </CodeTab>
  <CodeTab>
  ```sql
  CREATE TABLE IF NOT EXISTS "posts" (
        "id" serial PRIMARY KEY NOT NULL,
        "title" text NOT NULL,
        "description" text NOT NULL
  );

  CREATE INDEX IF NOT EXISTS "search_index" ON "posts"
    USING gin ((setweight(to_tsvector('english', "title"), 'A') ||
    setweight(to_tsvector('english', "description"), 'B')));
  ```
  </CodeTab>
  ```json
  [
    {
      id: 1,
      title: 'Planning Your First Trip to Europe',
      description:
        'Get essential tips on budgeting, sightseeing, and cultural etiquette for your inaugural European adventure.',
    },
    {
      id: 2,
      title: "Cultural Insights: Exploring Asia's Heritage",
      description:
        'Dive deep into the rich history and traditions of Asia through immersive experiences and local interactions.',
    },
    {
      id: 3,
      title: 'Top 5 Destinations for a Family Trip',
      description:
        'Discover family-friendly destinations that offer fun, education, and relaxation for all ages.',
    },
    {
      id: 4,
      title: 'Essential Hiking Gear for Mountain Enthusiasts',
      description:
        'Equip yourself with the latest and most reliable gear for your next mountain hiking expedition.',
    },
    {
      id: 5,
      title: 'Trip Planning: Choosing Your Next Destination',
      description:
        'Learn how to select destinations that align with your travel goals, whether for leisure, adventure, or cultural exploration.',
    },
    {
      id: 6,
      title: 'Discovering Hidden Culinary Gems in Italy',
      description:
        "Unearth Italy's lesser-known eateries and food markets that offer authentic and traditional flavors.",
    },
    {
      id: 7,
      title: 'The Ultimate Road Trip Guide for Explorers',
      description:
        'Plan your next great road trip with tips on route planning, packing, and discovering off-the-beaten-path attractions.',
    },
  ];
  ```
</CodeTabs>

`setweight` å‡½æ•°ç”¨äºä¸º tsvector çš„æ¡ç›®æ ‡è®°ä¸€ä¸ªç»™å®šçš„æƒé‡ï¼Œå…¶ä¸­æƒé‡æ˜¯å­—æ¯ Aã€Bã€C æˆ– D ä¹‹ä¸€ã€‚è¿™é€šå¸¸ç”¨äºæ ‡è®°æ¥è‡ªæ–‡æ¡£ä¸åŒéƒ¨åˆ†çš„æ¡ç›®ï¼Œä¾‹å¦‚æ ‡é¢˜ä¸æ­£æ–‡ã€‚

è¿™å°±æ˜¯æ‚¨å¦‚ä½•åœ¨å¤šä¸ªåˆ—ä¸Šæ‰§è¡ŒæŸ¥è¯¢ï¼š

<Section>
```ts copy {5-7}
const title = 'plan';

await db.select().from(posts)
  .where(sql`(
      setweight(to_tsvector('english', ${posts.title}), 'A') ||
      setweight(to_tsvector('english', ${posts.description}), 'B'))
      @@ to_tsquery('english', ${title}
    )`
  );
```

```json
[
  {
    id: 1,
    title: 'Planning Your First Trip to Europe',
    description: 'Get essential tips on budgeting, sightseeing, and cultural etiquette for your inaugural European adventure.'
  },
  {
    id: 5,
    title: 'Trip Planning: Choosing Your Next Destination',
    description: 'Learn how to select destinations that align with your travel goals, whether for leisure, adventure, or cultural exploration.'
  },
  {
    id: 7,
    title: 'The Ultimate Road Trip Guide for Explorers',
    description: 'Plan your next great road trip with tips on route planning, packing, and discovering off-the-beaten-path attractions.'
  }
]
```
</Section>

è¦å¯¹æœç´¢ç»“æœè¿›è¡Œæ’åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `ts_rank` æˆ– `ts_rank_cd` å‡½æ•°å’Œ `orderBy` æ–¹æ³•ï¼š

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

<Section>
```ts copy {6,7,12,13,18-20}
import { desc, getColumns, sql } from 'drizzle-orm';

const search = 'culture | Europe | Italy | adventure';

const matchQuery = sql`(
  setweight(to_tsvector('english', ${posts.title}), 'A') ||
  setweight(to_tsvector('english', ${posts.description}), 'B')), to_tsquery('english', ${search})`;

await db
  .select({
    ...getColumns(posts),
    rank: sql`ts_rank(${matchQuery})`,
    rankCd: sql`ts_rank_cd(${matchQuery})`,
  })
  .from(posts)
  .where(
    sql`(
      setweight(to_tsvector('english', ${posts.title}), 'A') ||
      setweight(to_tsvector('english', ${posts.description}), 'B')
      ) @@ to_tsquery('english', ${search})`,
  )
  .orderBy((t) => desc(t.rank));
```

```json
[
  {
    id: 1,
    title: 'Planning Your First Trip to Europe',
    description: 'Get essential tips on budgeting, sightseeing, and cultural etiquette for your inaugural European adventure.',
    rank: 0.2735672,
    rankCd: 1.8
  },
  {
    id: 6,
    title: 'Discovering Hidden Culinary Gems in Italy',
    description: "Unearth Italy's lesser-known eateries and food markets that offer authentic and traditional flavors.",
    rank: 0.16717994,
    rankCd: 1.4
  },
  {
    id: 2,
    title: "Cultural Insights: Exploring Asia's Heritage",
    description: 'Dive deep into the rich history and traditions of Asia through immersive experiences and local interactions.',
    rank: 0.15198177,
    rankCd: 1
  },
  {
    id: 5,
    title: 'Trip Planning: Choosing Your Next Destination',
    description: 'Learn how to select destinations that align with your travel goals, whether for leisure, adventure, or cultural exploration.',
    rank: 0.12158542,
    rankCd: 0.8
  }
]
```
</Section>

`ts_rank` å‡½æ•°ä¾§é‡äºæŸ¥è¯¢æœ¯è¯­åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­çš„é¢‘ç‡ã€‚è€Œ `ts_rank_cd` å‡½æ•°åˆ™ä¾§é‡äºæŸ¥è¯¢æœ¯è¯­åœ¨æ–‡æ¡£ä¸­çš„æ¥è¿‘ç¨‹åº¦ã€‚


Source: https://drizzle.zhcndoc.com/docs/postgresql-local-setup


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Steps from '@mdx/Steps.astro';

<Prerequisites>
- å®‰è£…æœ€æ–°çš„ [Docker Desktop](https://www.docker.com/products/docker-desktop/)ã€‚è¯·æŒ‰ç…§æ‚¨æ“ä½œç³»ç»Ÿçš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚
</Prerequisites>

<Steps>

#### æ‹‰å– PostgreSQL é•œåƒ

ä» Docker Hub æ‹‰å–æœ€æ–°çš„ PostgreSQL é•œåƒã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œ `docker pull postgres` æ¥æ‹‰å–æœ€æ–°çš„ Postgres ç‰ˆæœ¬ï¼š

```bash copy
docker pull postgres
```

æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç‰¹å®šæ ‡ç­¾æ‹‰å–æ‰€éœ€ç‰ˆæœ¬ï¼š

```bash copy
docker pull postgres:15
```

å½“ PostgreSQL é•œåƒä¸‹è½½å®Œæˆåï¼Œæ‚¨å¯ä»¥åœ¨ Docker Desktop çš„ `Images` æ ‡ç­¾ä¸­æŸ¥çœ‹å®ƒï¼Œæˆ–é€šè¿‡è¿è¡Œ `docker images` è¿›è¡Œæ£€æŸ¥ï¼š

<Section>
```bash copy
docker images
```

```plaintext
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
postgres     latest    75282fa229a1   6 weeks ago     453MB
```
</Section>

#### å¯åŠ¨ PostgreSQL å®ä¾‹

è¦å¯åŠ¨ä¸€ä¸ªæ–°çš„ PostgreSQL å®¹å™¨ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
docker run --name drizzle-postgres -e POSTGRES_PASSWORD=mypassword -d -p 5432:5432 postgres
```

1. `--name` é€‰é¡¹ä¸ºå®¹å™¨æŒ‡å®šåç§° `drizzle-postgres`ã€‚
2. `-e POSTGRES_PASSWORD=` é€‰é¡¹è®¾ç½® `POSTGRES_PASSWORD` ç¯å¢ƒå˜é‡ä¸ºæŒ‡å®šå€¼ã€‚
3. `-d` æ ‡å¿—ä½¿å®¹å™¨åœ¨åˆ†ç¦»æ¨¡å¼ä¸‹ï¼ˆåœ¨åå°ï¼‰è¿è¡Œã€‚
4. `-p` é€‰é¡¹å°†å®¹å™¨ä¸­çš„ç«¯å£ `5432` æ˜ å°„åˆ°ä¸»æœºä¸Šçš„ç«¯å£ `5432`ï¼Œå…è®¸é€šè¿‡è¯¥ç«¯å£ä»ä¸»æœºç³»ç»Ÿè®¿é—® PostgreSQLã€‚
5. `postgres` å‚æ•°æŒ‡å®šç”¨äºå®¹å™¨çš„é•œåƒã€‚æ‚¨ä¹Ÿå¯ä»¥æŒ‡å®šå…¶ä»–ç‰ˆæœ¬ï¼Œä¾‹å¦‚ `postgres:15`ã€‚

æ‚¨è¿˜å¯ä»¥æŒ‡å®šå…¶ä»–å‚æ•°ï¼Œä¾‹å¦‚ï¼š

1. `-e POSTGRES_USER=` é€‰é¡¹è®¾ç½® `POSTGRES_USER` ç¯å¢ƒå˜é‡ä¸ºæŒ‡å®šå€¼ã€‚å½“ä¸ºç©ºæ—¶ï¼ŒPostgres ä½¿ç”¨é»˜è®¤ç”¨æˆ·ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ `postgres`ï¼Œæ‚¨å¯ä»¥åœ¨ Docker Desktop ä¸­æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Œæˆ–é€šè¿‡è¿è¡Œ `docker logs <container_name>` è¿›è¡Œæ£€æŸ¥ã€‚
2. `-e POSTGRES_DB=` é€‰é¡¹è®¾ç½® `POSTGRES_DB` ç¯å¢ƒå˜é‡ä¸ºæŒ‡å®šå€¼ã€‚å½“ä¸ºç©ºæ—¶ï¼Œé»˜è®¤ä¸º `POSTGRES_USER` çš„å€¼ã€‚

è¦æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œè¯·æŸ¥çœ‹ Docker Desktop çš„ `Containers` æ ‡ç­¾æˆ–ä½¿ç”¨ `docker ps` å‘½ä»¤ï¼š

```plaintext
CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS                    NAMES
df957c58a6a3   postgres   "docker-entrypoint.sâ€¦"   4 seconds ago   Up 3 seconds   0.0.0.0:5432->5432/tcp   drizzle-postgres
```

#### é…ç½®æ•°æ®åº“ URL

è¦è¿æ¥åˆ° PostgreSQL æ•°æ®åº“ï¼Œæ‚¨éœ€è¦æä¾›æ•°æ®åº“ URLã€‚URL çš„æ ¼å¼ä¸ºï¼š

```plaintext
postgres://<user>:<password>@<host>:<port>/<database>
```

æ‚¨åº”è¯¥ç”¨å®é™…çš„å€¼æ›¿æ¢å ä½ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¯¹äºåˆ›å»ºçš„å®¹å™¨ï¼ŒURL ä¸ºï¼š

```plaintext
postgres://postgres:mypassword@localhost:5432/postgres
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¯¥ URL è¿æ¥åˆ°æ•°æ®åº“ã€‚
</Steps>


Source: https://drizzle.zhcndoc.com/docs/seeding-using-with-option


import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';
import Section from "@mdx/Section.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- äº†è§£å¦‚ä½•å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) æˆ– [SQLite](/docs/get-started-sqlite)
- ç†Ÿæ‚‰ [ä¸€å¯¹å¤šå…³ç³»](/docs/relations#one-to-many)
- ç†Ÿæ‚‰ [Drizzle Seed](/docs/seed-overview)
</Prerequisites>

<Callout title='è­¦å‘Š'>
ä½¿ç”¨ `with` æ„å‘³ç€è¡¨ä¹‹é—´å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»ã€‚

å› æ­¤ï¼Œå¦‚æœä¸€ä¸ª `one` ç”¨æˆ·æ‹¥æœ‰ `many` å¸–å­ï¼Œåˆ™å¯ä»¥å¦‚ä¸‹ä½¿ç”¨ `with`ï¼š
```ts
users: {
    count: 2,
    with: {
        posts: 3,
    },
},
```
</Callout>

## ç¤ºä¾‹ 1
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```ts
import { users, posts } from './schema.ts';

async function main() {
    const db = drizzle(...);
    await seed(db, { users, posts }).refine(() => ({
        users: {
            count: 2,
            with: {
                posts: 3,
            },
        },
    }));
}
main();

```
</CodeTab>

<CodeTab>
```ts
import { serial, pgTable, integer, text } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id').notNull(),
});
```
</CodeTab>
</CodeTabs>

è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬ä¼šå¯¼è‡´é”™è¯¯ã€‚

```
Error: "posts" è¡¨æ²¡æœ‰å¼•ç”¨ "users" è¡¨ï¼Œæˆ–è€…
ä½ æ²¡æœ‰åœ¨ seed å‡½æ•°çš„ schema ä¸­åŒ…å«ä¸€å¯¹å¤šå…³ç³»ã€‚
ä½ ä¸èƒ½åœ¨ users.with å¯¹è±¡ä¸­æŒ‡å®š "posts" ä½œä¸ºå‚æ•°ã€‚
```

ä½ æœ‰å‡ ç§æ–¹å¼è§£å†³æ­¤é”™è¯¯ï¼š
- ä½ å¯ä»¥åœ¨ `posts` è¡¨çš„ `authorId` åˆ—ä¸­æ·»åŠ å¯¹ `users` è¡¨çš„å¼•ç”¨
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
<Section>
```ts
import { users, posts } from './schema.ts';

async function main() {
    const db = drizzle(...);
    await seed(db, { users, posts }).refine(() => ({
        users: {
            count: 2,
            with: {
                posts: 3,
            },
        },
    }));
}
main();

// è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬å°†å¡«å……æ•°æ®åº“å¦‚ä¸‹å€¼
```

```mdx
`users`

| id |   name   |   
| -- | -------- |
|  1 | 'Melanny' | 
|  2 | 'Elvera' |

`posts`

| id |        content        | author_id |   
| -- | --------------------- | --------- |
|  1 | 'tf02gUXb0LZIdEg6SL'  |     2     |
|  2 | 'j15YdT7Sma'          |     2     |
|  3 | 'LwwvWtLLAZzIpk'      |     1     |
|  4 | 'mgyUnBKSrQw'         |     1     |
|  5 | 'CjAJByKIqilHcPjkvEw' |     2     |
|  6 | 'S5g0NzXs'            |     1     |
```
</Section>
</CodeTab>
<CodeTab>
```ts copy{11}
import { serial, pgTable, integer, text } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id').notNull().references(() => users.id),
});
```
</CodeTab>
</CodeTabs>

- ä½ ä¹Ÿå¯ä»¥åœ¨ schema ä¸­æ·»åŠ ä¸€å¯¹å¤šå…³ç³»ï¼Œå¹¶åœ¨ seed å‡½æ•°çš„ schema ä¸­åŒ…å«è¯¥å…³ç³»
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
<Section>
```ts copy{1,5}
import { users, posts, postsRelations } from './schema.ts';

async function main() {
    const db = drizzle(...);
    await seed(db, { users, posts, postsRelations }).refine(() => ({
        users: {
            count: 2,
            with: {
                posts: 3,
            },
        },
    }));
}
main();

// è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬å°†å¡«å……æ•°æ®åº“å¦‚ä¸‹å€¼
```

```mdx
`users`

| id |   name   |   
| -- | -------- |
|  1 | 'Melanny' | 
|  2 | 'Elvera' |

`posts`

| id |        content        | author_id |   
| -- | --------------------- | --------- |
|  1 | 'tf02gUXb0LZIdEg6SL'  |     2     |
|  2 | 'j15YdT7Sma'          |     2     |
|  3 | 'LwwvWtLLAZzIpk'      |     1     |
|  4 | 'mgyUnBKSrQw'         |     1     |
|  5 | 'CjAJByKIqilHcPjkvEw' |     2     |
|  6 | 'S5g0NzXs'            |     1     |
```
</Section>
</CodeTab>

<CodeTab>
```ts copy{2,15-20}
import { serial, pgTable, integer, text } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id').notNull(),
});

export const postsRelations = relations(posts, ({ one }) => ({
	author: one(users, {
		fields: [posts.authorId],
		references: [users.id],
	}),
}));
```
</CodeTab>
</CodeTabs>


## ç¤ºä¾‹ 2
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```ts
import { users, posts } from './schema.ts';

async function main() {
    const db = drizzle(...);
    await seed(db, { users, posts }).refine(() => ({
        posts: {
            count: 2,
            with: {
                users: 3,
            },
        },
    }));
}
main();

```
</CodeTab>

<CodeTab>
```ts
import { serial, pgTable, integer, text } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id').notNull().references(() => users.id),
});
```
</CodeTab>
</CodeTabs>

è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬ä¼šå¯¼è‡´é”™è¯¯ã€‚

```
Error: "posts" è¡¨æ²¡æœ‰å¼•ç”¨ "users" è¡¨ï¼Œæˆ–è€…
ä½ æ²¡æœ‰åœ¨ seed å‡½æ•°çš„ schema ä¸­åŒ…å«ä¸€å¯¹å¤šå…³ç³»ã€‚
ä½ ä¸èƒ½åœ¨ users.with å¯¹è±¡ä¸­æŒ‡å®š "posts" ä½œä¸ºå‚æ•°ã€‚
```

<Callout title='ä¸ºä»€ä¹ˆï¼Ÿ'>
ä½ çš„ schema ä¸­ `posts` è¡¨å¼•ç”¨äº† `users` è¡¨ï¼Œ 
```ts copy{7}
.
.
.
export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id').notNull().references(() => users.id),
});
```
æ¢å¥è¯è¯´ï¼Œä½ æœ‰ä¸€ä¸ªä¸€å¯¹å¤šå…³ç³»ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šç¯‡å¸–å­ã€‚

ä½†æ˜¯ï¼Œåœ¨å¡«å……è„šæœ¬ä¸­ï¼Œä½ è¯•å›¾ä¸ºä¸€ç¯‡å¸–å­ç”Ÿæˆä¸‰ä¸ªï¼ˆå¤šä¸ªï¼‰ç”¨æˆ·ã€‚
```ts
posts: {
    count: 2,
    with: {
        users: 3,
    },
},
```
</Callout>

è§£å†³æ­¤é”™è¯¯ï¼Œä½ å¯ä»¥å°†å¡«å……è„šæœ¬ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼š
<Section>
```ts copy{6-9}
import { users, posts, postsRelations } from './schema.ts';

async function main() {
    const db = drizzle(...);
    await seed(db, { users, posts, postsRelations }).refine(() => ({
        users: {
            count: 2,
            with: {
                posts: 3,
            },
        },
    }));
}
main();

// è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬å°†å¡«å……æ•°æ®åº“å¦‚ä¸‹å€¼
```

```mdx
`users`

| id |   name   |   
| -- | -------- |
|  1 | 'Melanny' | 
|  2 | 'Elvera' |

`posts`

| id |        content        | author_id |   
| -- | --------------------- | --------- |
|  1 | 'tf02gUXb0LZIdEg6SL'  |     2     |
|  2 | 'j15YdT7Sma'          |     2     |
|  3 | 'LwwvWtLLAZzIpk'      |     1     |
|  4 | 'mgyUnBKSrQw'         |     1     |
|  5 | 'CjAJByKIqilHcPjkvEw' |     2     |
|  6 | 'S5g0NzXs'            |     1     |
```
</Section>

## ç¤ºä¾‹ 3

<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```ts copy{6-9}
import { users } from './schema.ts';

async function main() {
    const db = drizzle(...);
    await seed(db, { users }).refine(() => ({
        users: {
            count: 2,
            with: {
                users: 3,
            },
        },
    }));
}
main();

```
</CodeTab>

<CodeTab>
```ts
import { serial, pgTable, integer, text } from "drizzle-orm/pg-core";
import type { AnyPgColumn } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
    reportsTo: integer('reports_to').references((): AnyPgColumn => users.id),
});
```
</CodeTab>
</CodeTabs>

è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬ä¼šå¯¼è‡´é”™è¯¯ã€‚

```
Error: "users" è¡¨å­˜åœ¨è‡ªå¼•ç”¨ã€‚
ä½ ä¸èƒ½åœ¨ users.with å¯¹è±¡ä¸­æŒ‡å®š "users" ä½œä¸ºå‚æ•°ã€‚
```

<Callout title='ä¸ºä»€ä¹ˆï¼Ÿ'>
ä½ çš„ schema ä¸­ `users` è¡¨å¼•ç”¨äº†è‡ªå·±ï¼Œ
```ts copy{7}
.
.
.
export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
    reportsTo: integer('reports_to').references((): AnyPgColumn => users.id),
});
```
æ¢å¥è¯è¯´ï¼Œä½ æœ‰ä¸€ä¸ªä¸€å¯¹ä¸€å…³ç³»ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½å¯¹åº”ä¸€ä¸ªç”¨æˆ·ã€‚

ä½†æ˜¯ï¼Œåœ¨å¡«å……è„šæœ¬ä¸­ï¼Œä½ è¯•å›¾ä¸ºä¸€ä¸ªç”¨æˆ·ç”Ÿæˆä¸‰ä¸ªï¼ˆå¤šä¸ªï¼‰ç”¨æˆ·ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚
```ts
users: {
    count: 2,
    with: {
        users: 3,
    },
},
```
</Callout>

Source: https://drizzle.zhcndoc.com/docs/seeding-with-partially-exposed-tables


import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- äº†è§£å¦‚ä½•ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) æˆ– [SQLite](/docs/get-started-sqlite)
- ç†Ÿæ‚‰ [Drizzle Seed](/docs/seed-overview)
</Prerequisites>

## ç¤ºä¾‹ 1
å‡è®¾æ‚¨å°è¯•ä½¿ç”¨ä»¥ä¸‹æ‰€ç¤ºçš„å¡«å……è„šæœ¬å’Œæ¨¡å¼æ¥å¡«å……æ•°æ®åº“ã€‚
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```ts
import { bloodPressure } from './schema.ts';

async function main() {
  const db = drizzle(...);
  await seed(db, { bloodPressure });
}
main();

```
</CodeTab>

<CodeTab>
```ts copy {10}
import { serial, pgTable, integer, doublePrecision } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
    id: serial("id").primaryKey(),
});

export const bloodPressure = pgTable("bloodPressure", {
	bloodPressureId: serial().primaryKey(),
	pressure: doublePrecision(),
	userId: integer().references(() => users.id).notNull(),
})
```
</CodeTab>
</CodeTabs>
å¦‚æœ `bloodPressure` è¡¨åœ¨ `userId` åˆ—ä¸Šæœ‰éç©ºçº¦æŸï¼Œé‚£ä¹ˆè¿è¡Œå¡«å……è„šæœ¬å°†å¯¼è‡´é”™è¯¯ã€‚

```
é”™è¯¯: åˆ— 'userId' å…·æœ‰éç©ºçº¦æŸï¼Œ
å¹¶ä¸”æ‚¨æ²¡æœ‰ä¸º 'bloodPressure' è¡¨ä¸­çš„ 'userId' åˆ—æŒ‡å®šå¤–é”®è¡¨ã€‚
```

<Callout title='è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ'>
è¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½åœ¨ `userId` åˆ—ä¸­å¡«å…… Null å€¼ï¼Œå› ä¸ºè¯¥åˆ—æœ‰éç©ºçº¦æŸã€‚
æ­¤å¤–ï¼Œæ‚¨æ²¡æœ‰å°† `users` è¡¨æš´éœ²ç»™ `seed` å‡½æ•°çš„æ¨¡å¼ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ç”Ÿæˆ `users.id` æ¥å¡«å…… `userId` åˆ—ã€‚
</Callout>

æ­¤æ—¶ï¼Œæ‚¨æœ‰å‡ ç§é€‰æ‹©æ¥è§£å†³é”™è¯¯ï¼š
- æ‚¨å¯ä»¥åˆ é™¤ `userId` åˆ—ä¸Šçš„éç©ºçº¦æŸï¼›
- æ‚¨å¯ä»¥å°† `users` è¡¨æš´éœ²ç»™ `seed` å‡½æ•°çš„æ¨¡å¼
```ts 
await seed(db, { bloodPressure, users });
```
- æ‚¨å¯ä»¥ [æ”¹è¿›](/docs/guides/seeding-with-partially-exposed-tables#refining-the-userid-column-generator) `userId` åˆ—ç”Ÿæˆå™¨ï¼›

## ç¤ºä¾‹ 2

<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```ts
import { bloodPressure } from './schema.ts';

async function main() {
  const db = drizzle(...);
  await seed(db, { bloodPressure });
}
main();

```
</CodeTab>

<CodeTab>
```ts copy {10}
import { serial, pgTable, integer, doublePrecision } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
    id: serial("id").primaryKey(),
});

export const bloodPressure = pgTable("bloodPressure", {
	bloodPressureId: serial().primaryKey(),
	pressure: doublePrecision(),
	userId: integer().references(() => users.id),
})
```
</CodeTab>
</CodeTabs>

é€šè¿‡è¿è¡Œä¸Šè¿°å¡«å……è„šæœ¬ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªè­¦å‘Š
```
åœ¨ 'bloodPressure' è¡¨ä¸­çš„ 'userId' åˆ—å°†å¡«å…… Null å€¼
å› ä¸ºæ‚¨æ—¢æ²¡æœ‰ä¸º 'userId' åˆ—æŒ‡å®šå¤–é”®è¡¨
ä¹Ÿæ²¡æœ‰ä¸º 'userId' åˆ—æä¾›å‡½æ•°çš„ç»†åŒ–ã€‚
```
<Callout title='è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ'>
è¿™æ„å‘³ç€æ‚¨æ—¢æ²¡æœ‰å°† `users` è¡¨æä¾›ç»™ `seed` å‡½æ•°çš„æ¨¡å¼ï¼Œä¹Ÿæ²¡æœ‰æ”¹è¿› `userId` åˆ—ç”Ÿæˆå™¨ã€‚ 
å› æ­¤ï¼Œ`userId` åˆ—å°†å¡«å…… Null å€¼ã€‚
</Callout>
ç„¶åæ‚¨å°†æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š
- å¦‚æœæ‚¨å¯ä»¥æ¥å—ç”¨ Null å€¼å¡«å…… `userId` åˆ—ï¼Œå¯ä»¥å¿½ç•¥è¯¥è­¦å‘Šï¼›

- å¦åˆ™ï¼Œæ‚¨å¯ä»¥ [æ”¹è¿›](/docs/guides/seeding-with-partially-exposed-tables#refining-the-userid-column-generator) `userId` åˆ—ç”Ÿæˆå™¨ã€‚ 

## æ”¹è¿› `userId` åˆ—ç”Ÿæˆå™¨
è¿™æ ·åšéœ€è¦ `users` è¡¨ä¸­å·²ç»æœ‰ç±»ä¼¼äº 1 å’Œ 2 çš„ IDã€‚
<CodeTabs items={["index.ts"]}>
<CodeTab>
```ts copy {8}
import { bloodPressure } from './schema.ts';

async function main() {
  const db = drizzle(...);
  await seed(db, { bloodPressure }).refine((funcs) => ({
    bloodPressure: {
      columns: {
        userId: funcs.valuesFromArray({ values: [1, 2] })
      }
    }
  }));
}
main();

```
</CodeTab>
</CodeTabs>

Source: https://drizzle.zhcndoc.com/docs/select-parent-rows-with-at-least-one-related-child-row


import Prerequisites from "@mdx/Prerequisites.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from "@mdx/Section.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [é€‰æ‹©è¯­å¥](/docs/select) å’Œ [ä»å­æŸ¥è¯¢é€‰æ‹©](/docs/select#select-from-subquery)
- [å†…éƒ¨è¿æ¥](/docs/joins#inner-join)
- [è¿‡æ»¤è¿ç®—ç¬¦](/docs/operators) å’Œ [existså‡½æ•°](/docs/operators#exists)
</Prerequisites>

æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•é€‰æ‹©çˆ¶è¡Œï¼Œæ¡ä»¶æ˜¯è‡³å°‘æœ‰ä¸€ä¸ªç›¸å…³çš„å­è¡Œã€‚ä¸‹é¢æ˜¯æ¨¡å¼å®šä¹‰å’Œç›¸åº”çš„æ•°æ®åº“æ•°æ®ç¤ºä¾‹ï¼š

```ts copy
import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull(),
});

export const posts = pgTable('posts', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id').notNull().references(() => users.id),
});
```

<CodeTabs items={["users.db", "posts.db"]}>
  <CodeTab>
    ```plaintext
    +----+------------+----------------------+
    | id |    name    |        email         |
    +----+------------+----------------------+
    |  1 | John Doe   | john_doe@email.com   |
    +----+------------+----------------------+
    |  2 | Tom Brown  | tom_brown@email.com  |
    +----+------------+----------------------+
    |  3 | Nick Smith | nick_smith@email.com |
    +----+------------+----------------------+
    ```
  </CodeTab>

  <CodeTab>
    ```plaintext
    +----+--------+-----------------------------+---------+
    | id | title  |          content            | user_id |
    +----+--------+-----------------------------+---------+
    |  1 | Post 1 | This is the text of post 1  |       1 |
    +----+--------+-----------------------------+---------+
    |  2 | Post 2 | This is the text of post 2  |       1 |
    +----+--------+-----------------------------+---------+
    |  3 | Post 3 | This is the text of post 3  |       3 |
    +----+--------+-----------------------------+---------+
    ```
  </CodeTab>
</CodeTabs>

è¦é€‰æ‹©è‡³å°‘æœ‰ä¸€ä¸ªç›¸å…³å­è¡Œçš„çˆ¶è¡Œå¹¶æ£€ç´¢å­æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `.innerJoin()` æ–¹æ³•ï¼š

<Section>
  ```ts copy {12}
  import { eq } from 'drizzle-orm';
  import { users, posts } from './schema';

  const db = drizzle(...);

  await db
    .select({
      user: users,
      post: posts,
    })
    .from(users)
    .innerJoin(posts, eq(users.id, posts.userId));
    .orderBy(users.id);
  ```

  ```sql
  select users.*, posts.* from users
    inner join posts on users.id = posts.user_id
    order by users.id;
  ```

  ```ts
  // ç»“æœæ•°æ®ï¼ŒIDä¸º2çš„ç”¨æˆ·æ²¡æœ‰ï¼Œå› ä¸ºä»–æ²¡æœ‰å¸–å­
  [
    {
      user: { id: 1, name: 'John Doe', email: 'john_doe@email.com' },
      post: {
        id: 1,
        title: 'Post 1',
        content: 'This is the text of post 1',
        userId: 1
      }
    },
    {
      user: { id: 1, name: 'John Doe', email: 'john_doe@email.com' },
      post: {
        id: 2,
        title: 'Post 2',
        content: 'This is the text of post 2',
        userId: 1
      }
    },
    {
      user: { id: 3, name: 'Nick Smith', email: 'nick_smith@email.com' },
      post: {
        id: 3,
        title: 'Post 3',
        content: 'This is the text of post 3',
        userId: 3
      }
    }
  ]
  ```
</Section>

è¦ä»…é€‰æ‹©è‡³å°‘æœ‰ä¸€ä¸ªç›¸å…³å­è¡Œçš„çˆ¶è¡Œï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ `exists()` å‡½æ•°çš„å­æŸ¥è¯¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```ts copy {8}
import { eq, exists, sql } from 'drizzle-orm';

const sq = db
  .select({ id: sql`1` })
  .from(posts)
  .where(eq(posts.userId, users.id));

await db.select().from(users).where(exists(sq));
```

```sql
select * from users where exists (select 1 from posts where posts.user_id = users.id);
```

```ts
// ç»“æœæ•°æ®ï¼ŒIDä¸º2çš„ç”¨æˆ·æ²¡æœ‰ï¼Œå› ä¸ºä»–æ²¡æœ‰å¸–å­
[
  { id: 1, name: 'John Doe', email: 'john_doe@email.com' },
  { id: 3, name: 'Nick Smith', email: 'nick_smith@email.com' }
]
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/timestamp-default-value


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- äº†è§£ [PostgreSQL](/docs/column-types/pg)ã€[MySQL](/docs/column-types/mysql) å’Œ [SQLite](/docs/column-types/sqlite) çš„åˆ—æ•°æ®ç±»å‹
- [sql æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

### PostgreSQL

è¦åœ¨ PostgreSQL ä¸­å°†å½“å‰æ—¶é—´æˆ³è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `defaultNow()` æ–¹æ³•æˆ–å¸¦æœ‰ `now()` å‡½æ•°çš„ `sql` æ“ä½œç¬¦ï¼Œè¯¥å‡½æ•°è¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼ˆå¸¦æœ‰æ—¶åŒºï¼‰ï¼š

<Section>
```ts copy {6,9}
import { sql } from 'drizzle-orm';
import { timestamp, pgTable, serial } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  timestamp1: timestamp('timestamp1').notNull().defaultNow(),
  timestamp2: timestamp('timestamp2', { mode: 'string' })
    .notNull()
    .default(sql`now()`),
});
```

```sql
CREATE TABLE IF NOT EXISTS "users" (
	"id" serial PRIMARY KEY NOT NULL,
	"timestamp1" timestamp DEFAULT now() NOT NULL,
	"timestamp2" timestamp DEFAULT now() NOT NULL
);
```
</Section>

`mode` é€‰é¡¹å®šä¹‰äº†åº”ç”¨ç¨‹åºä¸­å¦‚ä½•å¤„ç†å€¼ã€‚ä½¿ç”¨ `string` æ¨¡å¼çš„å€¼åœ¨åº”ç”¨ç¨‹åºä¸­è¢«è§†ä¸º `string`ï¼Œä½†åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä¸ºæ—¶é—´æˆ³ã€‚

<Section>
```plaintext
// å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®
+----+----------------------------+----------------------------+
| id |         timestamp1         |         timestamp2         |
+----+----------------------------+----------------------------+
| 1  | 2024-04-11 14:14:28.038697 | 2024-04-11 14:14:28.038697 |
+----+----------------------------+----------------------------+
```

```ts
// åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®
[
  {
    id: 1,
    timestamp1: 2024-04-11T14:14:28.038Z, // æ—¥æœŸå¯¹è±¡
    timestamp2: '2024-04-11 14:14:28.038697' // å­—ç¬¦ä¸²
  }
]
```
</Section>

è¦åœ¨ PostgreSQL ä¸­å°† Unix æ—¶é—´æˆ³è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `sql` æ“ä½œç¬¦å’Œ `extract(epoch from now())` å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›è‡ª `1970-01-01 00:00:00 UTC` ä»¥æ¥çš„ç§’æ•°ï¼š

<Section>
```ts copy {8}
import { sql } from 'drizzle-orm';
import { integer, pgTable, serial } from 'drizzle-orm/pg-core'

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  timestamp: integer('timestamp')
    .notNull()
    .default(sql`extract(epoch from now())`),
});
```

```sql
CREATE TABLE IF NOT EXISTS "users" (
	"id" serial PRIMARY KEY NOT NULL,
	"timestamp" integer DEFAULT extract(epoch from now()) NOT NULL
);
```

```plaintext
// å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®
+----+------------+
| id | timestamp  |
+----+------------+
|  1 | 1712846784 |
+----+------------+
```

```ts
// åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®
[ 
  { 
    id: 1, 
    timestamp: 1712846784 // æ•°å­—
  } 
]
```
</Section>


### MySQL

è¦åœ¨ MySQL ä¸­å°†å½“å‰æ—¶é—´æˆ³è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `defaultNow()` æ–¹æ³•æˆ–å¸¦æœ‰ `now()` å‡½æ•°çš„ `sql` æ“ä½œç¬¦ï¼Œè¯¥å‡½æ•°è¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´ `(YYYY-MM-DD HH-MM-SS)`ï¼š

<Section>
```ts copy {6,9,12}
import { sql } from 'drizzle-orm';
import { mysqlTable, serial, timestamp } from 'drizzle-orm/mysql-core';

export const users = mysqlTable('users', {
  id: serial('id').primaryKey(),
  timestamp1: timestamp('timestamp1').notNull().defaultNow(),
  timestamp2: timestamp('timestamp2', { mode: 'string' })
    .notNull()
    .default(sql`now()`),
  timestamp3: timestamp('timestamp3', { fsp: 3 }) // å°æ•°ç§’éƒ¨åˆ†
    .notNull()
    .default(sql`now(3)`),
});
```

```sql
CREATE TABLE `users` (
	`id` serial AUTO_INCREMENT NOT NULL,
	`timestamp1` timestamp NOT NULL DEFAULT now(),
	`timestamp2` timestamp NOT NULL DEFAULT now(),
	`timestamp3` timestamp(3) NOT NULL DEFAULT now(3),
	CONSTRAINT `users_id` PRIMARY KEY(`id`)
);
```
</Section>

`fsp` é€‰é¡¹å®šä¹‰åœ¨æ—¶é—´æˆ³ä¸­åŒ…å«çš„å°æ•°ç§’æ•°ã€‚é»˜è®¤å€¼ä¸º `0`ã€‚  
`mode` é€‰é¡¹å®šä¹‰äº†åº”ç”¨ç¨‹åºä¸­å¦‚ä½•å¤„ç†å€¼ã€‚ä½¿ç”¨ `string` æ¨¡å¼çš„å€¼åœ¨åº”ç”¨ç¨‹åºä¸­è¢«è§†ä¸º `string`ï¼Œä½†åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä¸ºæ—¶é—´æˆ³ã€‚

<Section>
```plaintext
// å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®
+----+---------------------+---------------------+-------------------------+
| id | timestamp1          | timestamp2          | timestamp3              |
+----+---------------------+---------------------+-------------------------+
|  1 | 2024-04-11 15:24:53 | 2024-04-11 15:24:53 | 2024-04-11 15:24:53.236 |
+----+---------------------+---------------------+-------------------------+
```

```ts
// åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®
[
  {
    id: 1,
    timestamp1: 2024-04-11T15:24:53.000Z, // æ—¥æœŸå¯¹è±¡
    timestamp2: '2024-04-11 15:24:53', // å­—ç¬¦ä¸²
    timestamp3: 2024-04-11T15:24:53.236Z // æ—¥æœŸå¯¹è±¡
  }
]
```
</Section>

è¦åœ¨ MySQL ä¸­å°† Unix æ—¶é—´æˆ³è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `sql` æ“ä½œç¬¦å’Œ `unix_timestamp()` å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›è‡ª `1970-01-01 00:00:00 UTC` ä»¥æ¥çš„ç§’æ•°ï¼š

<Section>
```ts copy {8}
import { sql } from 'drizzle-orm';
import { mysqlTable, serial, int } from 'drizzle-orm/mysql-core';

export const users = mysqlTable('users', {
  id: serial('id').primaryKey(),
  timestamp: int('timestamp')
    .notNull()
    .default(sql`(unix_timestamp())`),
});
```

```sql
CREATE TABLE `users` (
	`id` serial AUTO_INCREMENT NOT NULL,
	`timestamp` int NOT NULL DEFAULT (unix_timestamp()),
	CONSTRAINT `users_id` PRIMARY KEY(`id`)
);
```

```plaintext
// å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®
+----+------------+
| id | timestamp  |
+----+------------+
|  1 | 1712847986 |
+----+------------+
```

```ts
// åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®
[ 
  { 
    id: 1, 
    timestamp: 1712847986 // æ•°å­—
  } 
]
```
</Section>

### SQLite

è¦åœ¨ SQLite ä¸­å°†å½“å‰æ—¶é—´æˆ³è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ `current_timestamp` å¸¸é‡çš„ `sql` æ“ä½œç¬¦ï¼Œè¯¥å¸¸é‡è¿”å›å½“å‰ UTC æ—¥æœŸå’Œæ—¶é—´çš„æ–‡æœ¬è¡¨ç¤º `(YYYY-MM-DD HH:MM:SS)`ï¼š

<Section>
```ts copy {8}
import { sql } from 'drizzle-orm';
import { integer, sqliteTable, text } from 'drizzle-orm/sqlite-core';

export const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  timestamp: text('timestamp')
    .notNull()
    .default(sql`(current_timestamp)`),
});
```

```sql
CREATE TABLE `users` (
	`id` integer PRIMARY KEY NOT NULL,
	`timestamp` text DEFAULT (current_timestamp) NOT NULL
);
```

```plaintext
// å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®
+----+---------------------+
| id | timestamp           |
+----+---------------------+
|  1 | 2024-04-11 15:40:43 |
+----+---------------------+
```

```ts
// åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®
[
  {
    id: 1,
    timestamp: '2024-04-11 15:40:43' // å­—ç¬¦ä¸²
  }
]
```
</Section>

è¦åœ¨ SQLite ä¸­å°† Unix æ—¶é—´æˆ³è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `sql` æ“ä½œç¬¦å’Œ `unixepoch()` å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›è‡ª `1970-01-01 00:00:00 UTC` ä»¥æ¥çš„ç§’æ•°ï¼š

<Section>
```ts copy {8,11,14}
import { sql } from 'drizzle-orm';
import { integer, sqliteTable } from 'drizzle-orm/sqlite-core';

export const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  timestamp1: integer('timestamp1', { mode: 'timestamp' })
    .notNull()
    .default(sql`(unixepoch())`),
  timestamp2: integer('timestamp2', { mode: 'timestamp_ms' })
    .notNull()
    .default(sql`(unixepoch() * 1000)`),
  timestamp3: integer('timestamp3', { mode: 'number' })
    .notNull()
    .default(sql`(unixepoch())`),
});
```

```sql
CREATE TABLE `users` (
	`id` integer PRIMARY KEY NOT NULL,
	`timestamp1` integer DEFAULT (unixepoch()) NOT NULL,
	`timestamp2` integer DEFAULT (unixepoch() * 1000) NOT NULL,
	`timestamp3` integer DEFAULT (unixepoch()) NOT NULL
);
```
</Section>

`mode` é€‰é¡¹å®šä¹‰äº†åº”ç”¨ç¨‹åºä¸­å¦‚ä½•å¤„ç†å€¼ã€‚åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œä½¿ç”¨ `timestamp` å’Œ `timestamp_ms` æ¨¡å¼çš„å€¼è¢«è§†ä¸º `Date` å¯¹è±¡ï¼Œä½†åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä¸ºæ•´æ•°ã€‚  
å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œ`timestamp` å¤„ç†ç§’ï¼Œè€Œ `timestamp_ms` å¤„ç†æ¯«ç§’ã€‚

<Section>
```plaintext
// å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®
+------------+------------+---------------+------------+
| id         | timestamp1 | timestamp2    | timestamp3 |
+------------+------------+---------------+------------+
| 1          | 1712835640 | 1712835640000 | 1712835640 |
+------------+------------+---------------+------------+
```

```ts
// åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®
[
  {
    id: 1,
    timestamp1: 2024-04-11T11:40:40.000Z, // æ—¥æœŸå¯¹è±¡
    timestamp2: 2024-04-11T11:40:40.000Z, // æ—¥æœŸå¯¹è±¡
    timestamp3: 1712835640 // æ•°å­—
  }
]
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/toggling-a-boolean-field

import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [æ›´æ–°è¯­å¥](/docs/update)
- [è¿‡æ»¤å™¨](/docs/operators) å’Œ [éæ“ä½œç¬¦](/docs/operators#not)
- [MySQL](/docs/column-types/mysql#boolean) å’Œ [SQLite](/docs/column-types/sqlite#boolean) ä¸­çš„å¸ƒå°”æ•°æ®ç±»å‹
</Prerequisites>

è¦åˆ‡æ¢åˆ—å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `update().set()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```tsx copy {8}
import { eq, not } from 'drizzle-orm';

const db = drizzle(...);

await db
  .update(table)
  .set({
    isActive: not(table.isActive),
  })
  .where(eq(table.id, 1));
```

```sql
update "table" set "is_active" = not "is_active" where "id" = 1;
```
</Section>

è¯·æ³¨æ„ï¼ŒMySQL å’Œ SQLite ä¸­æ²¡æœ‰å¸ƒå°”ç±»å‹ã€‚
MySQL ä½¿ç”¨ tinyint(1)ã€‚
SQLite ä½¿ç”¨æ•´æ•° 0ï¼ˆfalseï¼‰å’Œ 1ï¼ˆtrueï¼‰ã€‚ 


Source: https://drizzle.zhcndoc.com/docs/unique-case-insensitive-email


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql)ã€[MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [ç´¢å¼•](/docs/indexes-constraints#indexes)
- [æ’å…¥è¯­å¥](/docs/insert) å’Œ [æŸ¥è¯¢æ–¹æ³•](/docs/select)
- [SQL æ“ä½œç¬¦](/docs/sql)
- ä½ åº”è¯¥æœ‰ `drizzle-orm@0.31.0` å’Œ `drizzle-kit@0.22.0` æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
</Prerequisites>

### PostgreSQL

è¦åœ¨ PostgreSQL ä¸­ä½¿ç”¨ Drizzle å®ç°å”¯ä¸€ä¸”ä¸åŒºåˆ†å¤§å°å†™çš„ `email` å¤„ç†ï¼Œä½ å¯ä»¥åœ¨å°å†™çš„ `email` åˆ—ä¸Šåˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ `email` åœ¨ä¸è€ƒè™‘å¤§å°å†™çš„æƒ…å†µä¸‹æ˜¯å”¯ä¸€çš„ã€‚

Drizzle æä¾›äº†ç®€å•çµæ´»çš„ APIï¼Œè®©ä½ å¯ä»¥è½»æ¾ä½¿ç”¨ SQL ç±»ä¼¼çš„è¯­æ³•åˆ›å»ºè¿™æ ·çš„ç´¢å¼•ï¼š
<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {12,13}
  import { SQL, sql } from 'drizzle-orm';
  import { AnyPgColumn, pgTable, serial, text, uniqueIndex } from 'drizzle-orm/pg-core';

  export const users = pgTable(
    'users',
    {
      id: serial('id').primaryKey(),
      name: text('name').notNull(),
      email: text('email').notNull(),
    },
    (table) => [
         // uniqueIndex('emailUniqueIndex').on(sql`lower(${table.email})`),
      uniqueIndex('emailUniqueIndex').on(lower(table.email)),
    ],
  );

  // è‡ªå®šä¹‰å°å†™å‡½æ•°
  export function lower(email: AnyPgColumn): SQL {
    return sql`lower(${email})`;
  }
  ```
  </CodeTab>
  ```sql
  CREATE TABLE IF NOT EXISTS "users" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"email" text NOT NULL
  );
  --> statement-breakpoint
  CREATE UNIQUE INDEX IF NOT EXISTS "emailUniqueIndex" ON "users" USING btree (lower("email"));
  ```
</CodeTabs>

è¿™å°±æ˜¯ä½ å¦‚ä½•ä½¿ç”¨ `lower` å‡½æ•°æŒ‰ `email` é€‰æ‹©ç”¨æˆ·ï¼š

<Section>
```ts copy {10}
import { eq } from 'drizzle-orm';
import { lower, users } from './schema';

const db = drizzle(...);

const findUserByEmail = async (email: string) => {
  return await db
    .select()
    .from(users)
    .where(eq(lower(users.email), email.toLowerCase()));
};
```

```sql
select * from "users" where lower(email) = 'john@email.com';
```
</Section>

### MySQL

åœ¨ MySQL ä¸­ï¼Œå­—ç¬¦ä¸²æ¯”è¾ƒçš„é»˜è®¤æ’åºè§„åˆ™æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ï¼Œè¿™æ„å‘³ç€åœ¨è¿›è¡Œåƒæœç´¢æˆ–æ¯”è¾ƒå­—ç¬¦ä¸²çš„ SQL æŸ¥è¯¢æ—¶ï¼Œå­—ç¬¦çš„å¤§å°å†™ä¸ä¼šå½±å“ç»“æœã€‚ç„¶è€Œï¼Œç”±äºæ’åºè§„åˆ™è®¾ç½®å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒå¹¶ä¸”å¯èƒ½é…ç½®ä¸ºå¤§å°å†™æ•æ„Ÿï¼Œå› æ­¤æˆ‘ä»¬å°†æ˜ç¡®ç¡®ä¿ `email` åœ¨ä¸è€ƒè™‘å¤§å°å†™çš„æƒ…å†µä¸‹æ˜¯å”¯ä¸€çš„ï¼Œæ–¹æ³•æ˜¯å¯¹å°å†™çš„ `email` åˆ—åˆ›å»ºå”¯ä¸€è·¯å¾„ã€‚

Drizzle æä¾›äº†ç®€å•çµæ´»çš„ APIï¼Œè®©ä½ å¯ä»¥è½»æ¾ä½¿ç”¨ SQL ç±»ä¼¼çš„è¯­æ³•åˆ›å»ºè¿™æ ·çš„ç´¢å¼•ï¼š
<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {12,13}
  import { SQL, sql } from 'drizzle-orm';
  import { AnyMySqlColumn, mysqlTable, serial, uniqueIndex, varchar } from 'drizzle-orm/mysql-core';

  export const users = mysqlTable(
    'users',
    {
      id: serial('id').primaryKey(),
      name: varchar('name', { length: 255 }).notNull(),
      email: varchar('email', { length: 255 }).notNull(),
    },
    (table) => [
         // uniqueIndex('emailUniqueIndex').on(sql`(lower(${table.email}))`),
      uniqueIndex('emailUniqueIndex').on(lower(table.email)),
    ]
  );

  // è‡ªå®šä¹‰å°å†™å‡½æ•°
  export function lower(email: AnyMySqlColumn): SQL {
    return sql`(lower(${email}))`;
  }
  ```
  </CodeTab>
  ```sql
  CREATE TABLE `users` (
	  `id` serial AUTO_INCREMENT NOT NULL,
	  `name` varchar(255) NOT NULL,
	  `email` varchar(255) NOT NULL,
	  CONSTRAINT `users_id` PRIMARY KEY(`id`),
	  CONSTRAINT `emailUniqueIndex` UNIQUE((lower(`email`)))
  );
  ```
</CodeTabs>

<Callout type="warning">
å‡½æ•°ç´¢å¼•åœ¨ MySQL 8.0.13 ç‰ˆæœ¬å¼€å§‹å¾—åˆ°æ”¯æŒã€‚å¯¹äºæ­£ç¡®çš„è¯­æ³•ï¼Œè¡¨è¾¾å¼åº”è¢«æ‹¬å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼Œ`(lower(column))`ã€‚
</Callout>

è¿™å°±æ˜¯ä½ å¦‚ä½•ä½¿ç”¨ `lower` å‡½æ•°æŒ‰ `email` é€‰æ‹©ç”¨æˆ·ï¼š

<Section>
```ts copy {10}
import { eq } from 'drizzle-orm';
import { lower, users } from './schema';

const db = drizzle(...);

const findUserByEmail = async (email: string) => {
  return await db
    .select()
    .from(users)
    .where(eq(lower(users.email), email.toLowerCase()));
};
```

```sql
select * from `users` where lower(email) = 'john@email.com';
```
</Section>

### SQLite

è¦åœ¨ SQLite ä¸­ä½¿ç”¨ Drizzle å®ç°å”¯ä¸€ä¸”ä¸åŒºåˆ†å¤§å°å†™çš„ `email` å¤„ç†ï¼Œä½ å¯ä»¥åœ¨å°å†™çš„ `email` åˆ—ä¸Šåˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ `email` åœ¨ä¸è€ƒè™‘å¤§å°å†™çš„æƒ…å†µä¸‹æ˜¯å”¯ä¸€çš„ã€‚

Drizzle æä¾›äº†ç®€å•çµæ´»çš„ APIï¼Œè®©ä½ å¯ä»¥è½»æ¾åˆ›å»ºè¿™æ ·çš„ç´¢å¼•ï¼Œä½¿ç”¨ SQL ç±»ä¼¼çš„è¯­æ³•ï¼š

<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {12,13}
  import { SQL, sql } from 'drizzle-orm';
  import { AnySQLiteColumn, integer, sqliteTable, text, uniqueIndex } from 'drizzle-orm/sqlite-core';

  export const users = sqliteTable(
    'users',
    {
      id: integer('id').primaryKey(),
      name: text('name').notNull(),
      email: text('email').notNull(),
    },
    (table) => [
      // uniqueIndex('emailUniqueIndex').on(sql`lower(${table.email})`),
      uniqueIndex('emailUniqueIndex').on(lower(table.email)),
    ]
  );

  // è‡ªå®šä¹‰å°å†™å‡½æ•°
  export function lower(email: AnySQLiteColumn): SQL {
    return sql`lower(${email})`;
  }
  ```
  </CodeTab>
  ```sql
  CREATE TABLE `users` (
	  `id` integer PRIMARY KEY NOT NULL,
	  `name` text NOT NULL,
	  `email` text NOT NULL
  );
  --> statement-breakpoint
  CREATE UNIQUE INDEX `emailUniqueIndex` ON `users` (lower(`email`));
  ```
</CodeTabs>

è¿™å°±æ˜¯ä½ å¦‚ä½•ä½¿ç”¨ `lower` å‡½æ•°æŒ‰ `email` é€‰æ‹©ç”¨æˆ·ï¼š

<Section>
```ts copy {10}
import { eq } from 'drizzle-orm';
import { lower, users } from './schema';

const db = drizzle(...);

const findUserByEmail = async (email: string) => {
  return await db
    .select()
    .from(users)
    .where(eq(lower(users.email), email.toLowerCase()));
};
```

```sql
select * from "users" where lower(email) = 'john@email.com';
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/update-many-with-different-value


import Section from "@mdx/Section.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [æ›´æ–°è¯­å¥](/docs/update)
- [è¿‡æ»¤å™¨](/docs/operators) å’Œ [sql æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

è¦åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­å®ç°å¯¹å¤šä¸ªè¡Œè¿›è¡Œä¸åŒå€¼çš„æ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨ `sql` æ“ä½œç¬¦ç»“åˆ `case` è¯­å¥å’Œ `.update().set()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

<Section>
```ts {26, 29, 32, 36, 38, 40}
import { SQL, inArray, sql } from 'drizzle-orm';
import { users } from './schema';

const db = drizzle(...);

const inputs = [
  {
    id: 1,
    city: 'New York',
  },
  {
    id: 2,
    city: 'Los Angeles',
  },
  {
    id: 3,
    city: 'Chicago',
  },
];

// ç¡®ä¿ inputs æ•°ç»„ä¸ä¸ºç©º
if (inputs.length === 0) {
  return;
}

const sqlChunks: SQL[] = [];
const ids: number[] = [];

sqlChunks.push(sql`(case`);

for (const input of inputs) {
  sqlChunks.push(sql`when ${users.id} = ${input.id} then ${input.city}`);
  ids.push(input.id);
}

sqlChunks.push(sql`end)`);

const finalSql: SQL = sql.join(sqlChunks, sql.raw(' '));

await db.update(users).set({ city: finalSql }).where(inArray(users.id, ids));
```

```sql
update users set "city" = 
  (case when id = 1 then 'New York' when id = 2 then 'Los Angeles' when id = 3 then 'Chicago' end)
where id in (1, 2, 3)
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/upsert


import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

<IsSupportedChipGroup chips={{PostgreSQL: true, MySQL: true, SQLite: true}}/>

<Prerequisites>
- å¼€å§‹ä½¿ç”¨ [PostgreSQL](/docs/get-started-postgresql), [MySQL](/docs/get-started-mysql) å’Œ [SQLite](/docs/get-started-sqlite)
- [æ’å…¥è¯­å¥](/docs/insert), [onConflictDoUpdate æ–¹æ³•](/docs/insert#on-conflict-do-update) å’Œ [onDuplicateKeyUpdate æ–¹æ³•](/docs/insert#on-duplicate-key-update)
- [å¤åˆä¸»é”®](/docs/indexes-constraints#composite-primary-key)
- [sql æ“ä½œç¬¦](/docs/sql)
</Prerequisites>

### PostgreSQL å’Œ SQLite

è¦åœ¨ PostgreSQL å’Œ SQLite ä¸­å®ç°ä¸Šæ’å…¥æŸ¥è¯¢ï¼ˆè·³åˆ° [MySQL](/docs/guides/upsert#mysql)ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `.onConflictDoUpdate()` æ–¹æ³•ï¼š

<Section>
```ts copy {8,9,10,11}
import { users } from './schema';

const db = drizzle(...);

await db
  .insert(users)
  .values({ id: 1, name: 'John' })
  .onConflictDoUpdate({
    target: users.id,
    set: { name: 'Super John' },
  });
```

```sql
insert into users ("id", "name") values (1, 'John')
  on conflict ("id") do update set name = 'Super John';
```
</Section>

è¦åœ¨ PostgreSQL å’Œ SQLite ä¸­ä¸€æ¬¡æŸ¥è¯¢ä¸Šæ’å…¥å¤šè¡Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `sql æ“ä½œç¬¦` å’Œ `excluded` å…³é”®è¯ã€‚`excluded` æ˜¯ä¸€ä¸ªç‰¹æ®Šå¼•ç”¨ï¼ŒæŒ‡çš„æ˜¯å› å†²çªè€Œæœªæ’å…¥çš„æè®®è¡Œã€‚

æ‚¨å¯ä»¥è¿™æ ·åšï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {21,24}
    import { sql } from 'drizzle-orm';
    import { users } from './schema';

    const values = [
      {
        id: 1,
        lastLogin: new Date(),
      },
      {
        id: 2,
        lastLogin: new Date(Date.now() + 1000 * 60 * 60),
      },
      {
        id: 3,
        lastLogin: new Date(Date.now() + 1000 * 60 * 120),
      },
    ];

    await db
      .insert(users)
      .values(values)
      .onConflictDoUpdate({
        target: users.id,
        set: { lastLogin: sql.raw(`excluded.${users.lastLogin.name}`) },
      });
    ```

    ```sql
    insert into users ("id", "last_login") 
      values 
        (1, '2024-03-15T22:29:06.679Z'),
        (2, '2024-03-15T23:29:06.679Z'),
        (3, '2024-03-16T00:29:06.679Z')
      on conflict ("id") do update set last_login = excluded.last_login;
    ```
  </CodeTab>
  ```ts copy
  import { pgTable, serial, timestamp } from 'drizzle-orm/pg-core';

  export const users = pgTable('users', {
    id: serial('id').primaryKey(),
    lastLogin: timestamp('last_login', { mode: 'date' }).notNull(),
  });
  ```
</CodeTabs>

Drizzle æä¾›äº†ç®€å•è€Œçµæ´»çš„ APIï¼Œå¯ä»¥è®©æ‚¨è½»æ¾åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚è¿™æ˜¯å¦‚ä½•é’ˆå¯¹ PostgreSQL å’Œ SQLite ä¸­ç”±äºå†²çªè€Œæ›´æ–°ç‰¹å®šåˆ—çš„è‡ªå®šä¹‰å‡½æ•°ï¼š

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {43,46}
    import { SQL, getColumns, sql } from 'drizzle-orm';
    import { PgTable } from 'drizzle-orm/pg-core';
    import { SQLiteTable } from 'drizzle-orm/sqlite-core';
    import { users } from './schema';

    const buildConflictUpdateColumns = <
      T extends PgTable | SQLiteTable,
      Q extends keyof T['_']['columns']
    >(
      table: T,
      columns: Q[],
    ) => {
      const cls = getColumns(table);

      return columns.reduce((acc, column) => {
        const colName = cls[column].name;
        acc[column] = sql.raw(`excluded.${colName}`);

        return acc;
      }, {} as Record<Q, SQL>);
    };

    const values = [
      {
        id: 1,
        lastLogin: new Date(),
        active: true,
      },
      {
        id: 2,
        lastLogin: new Date(Date.now() + 1000 * 60 * 60),
        active: true,
      },
      {
        id: 3,
        lastLogin: new Date(Date.now() + 1000 * 60 * 120),
        active: true,
      },
    ];

    await db
      .insert(users)
      .values(values)
      .onConflictDoUpdate({
        target: users.id,
        set: buildConflictUpdateColumns(users, ['lastLogin', 'active']),
      });
    ```

    ```sql
    insert into users ("id", "last_login", "active")
    values
      (1, '2024-03-16T15:44:41.141Z', true),
      (2, '2024-03-16T16:44:41.141Z', true),
      (3, '2024-03-16T17:44:41.141Z', true)
    on conflict ("id") do update set last_login = excluded.last_login, active = excluded.active;
    ```
  </CodeTab>
  ```ts copy
  import { boolean, pgTable, serial, timestamp } from 'drizzle-orm/pg-core';

  export const users = pgTable('users', {
    id: serial('id').primaryKey(),
    lastLogin: timestamp('last_login', { mode: 'date' }).notNull(),
    active: boolean('active').notNull().default(false),
  });
  ```
</CodeTabs>

è¿™æ˜¯å¦‚ä½•åœ¨ PostgreSQL å’Œ SQLite ä¸­ä½¿ç”¨å¤šä¸ªç›®æ ‡å®ç°ä¸Šæ’å…¥æŸ¥è¯¢ï¼š

<Section>
```ts copy {8}
import { sql } from 'drizzle-orm';
import { inventory } from './schema';

await db
  .insert(inventory)
  .values({ warehouseId: 1, productId: 1, quantity: 100 })
  .onConflictDoUpdate({
    target: [inventory.warehouseId, inventory.productId], // å¤åˆä¸»é”®
    set: { quantity: sql`${inventory.quantity} + 100` }, // å°†ç°æœ‰æ•°é‡å¢åŠ  100
  });
```

```sql
insert into inventory ("warehouse_id", "product_id", "quantity") values (1, 1, 100)
  on conflict ("warehouse_id","product_id") do update set quantity = quantity + 100;
```
</Section>

å¦‚æœæ‚¨æƒ³åœ¨ `update` è¯­å¥ä¸­å®ç°å¸¦æœ‰ `where` æ¡ä»¶çš„ä¸Šæ’å…¥æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ `setWhere` å±æ€§åœ¨ `onConflictDoUpdate` æ–¹æ³•ä¸­ï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
  ```ts copy {25,26,27,28}
  import { or, sql } from 'drizzle-orm';
  import { products } from './schema';

  const data = {
    id: 1,
    title: 'Phone',
    price: '999.99',
    stock: 10,
    lastUpdated: new Date(),
  };

  const excludedPrice = sql.raw(`excluded.${products.price.name}`);
  const excludedStock = sql.raw(`excluded.${products.stock.name}`);

  await db
    .insert(products)
    .values(data)
    .onConflictDoUpdate({
      target: products.id,
      set: {
        price: excludedPrice,
        stock: excludedStock,
        lastUpdated: sql.raw(`excluded.${products.lastUpdated.name}`)
      },
      setWhere: or(
        sql`${products.stock} != ${excludedStock}`,
        sql`${products.price} != ${excludedPrice}`
      ),
    });
  ```

  ```sql
  insert into products ("id", "title", "stock", "price", "last_updated")
    values (1, 'Phone', 10, '999.99', '2024-04-29T21:56:55.563Z')
    on conflict ("id") do update
    set stock = excluded.stock, price = excluded.price, last_updated = excluded.last_updated
    where (stock != excluded.stock or price != excluded.price);
  ```
  </CodeTab>

  ```ts copy
  import { integer, numeric, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

  export const products = pgTable('products', {
    id: serial('id').primaryKey(),
    title: text('title').notNull(),
    stock: integer('stock').notNull(),
    price: numeric('price', { precision: 10, scale: 2 }).notNull(),
    lastUpdated: timestamp('last_updated').notNull().defaultNow(),
  });
  ```
</CodeTabs>


å¦‚æœæ‚¨æƒ³æ›´æ–°æ‰€æœ‰åˆ—ï¼Œé™¤äº†ç‰¹å®šçš„ä¸€åˆ—ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä¿ç•™å…ˆå‰çš„å€¼ï¼š

<Section>
```ts copy {16}
import { sql } from 'drizzle-orm';
import { users } from './schema';

const data = {
  id: 1,
  name: 'John',
  email: 'john@email.com',
  age: 29,
};

await db
  .insert(users)
  .values(data)
  .onConflictDoUpdate({
    target: users.id,
    set: { ...data, email: sql`${users.email}` }, // ä¿æŒ email ä¸å˜
});
```

```sql
insert into users ("id", "name", "email", "age") values (1, 'John', 'john@email.com', 29)
  on conflict ("id") do update set id = 1, name = 'John', email = email, age = 29;
```
</Section>

### MySQL

è¦åœ¨ MySQL ä¸­å®ç°ä¸Šæ’å…¥æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ `.onDuplicateKeyUpdate()` æ–¹æ³•ã€‚MySQL ä¼šæ ¹æ®ä¸»é”®å’Œå”¯ä¸€ç´¢å¼•è‡ªåŠ¨ç¡®å®šå†²çªç›®æ ‡ï¼Œå¦‚æœæœ‰ä»»ä½•å”¯ä¸€ç´¢å¼•å†²çªï¼Œå°†ä¼šæ›´æ–°è¯¥è¡Œã€‚

æ‚¨å¯ä»¥è¿™æ ·åšï¼š

<Section>
```ts copy {4}
await db
  .insert(users)
  .values({ id: 1, name: 'John' })
  .onDuplicateKeyUpdate({ set: { name: 'Super John' } });
```

```sql
insert into users (`id`, `first_name`) values (1, 'John')
  on duplicate key update first_name = 'Super John';
```
</Section>

è¦åœ¨ MySQL ä¸­ä¸€æ¬¡æŸ¥è¯¢ä¸Šæ’å…¥å¤šè¡Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `sql æ“ä½œç¬¦` å’Œ `values()` å‡½æ•°ã€‚`values()` å‡½æ•°æŒ‡çš„æ˜¯å¦‚æœæ²¡æœ‰å‘ç”Ÿé‡å¤é”®å†²çªï¼Œåˆ™å°†æ’å…¥çš„åˆ—çš„å€¼ã€‚  

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {21,24}
    import { sql } from 'drizzle-orm';
    import { users } from './schema';

    const values = [
      {
        id: 1,
        lastLogin: new Date(),
      },
      {
        id: 2,
        lastLogin: new Date(Date.now() + 1000 * 60 * 60),
      },
      {
        id: 3,
        lastLogin: new Date(Date.now() + 1000 * 60 * 120),
      },
    ];

    await db
      .insert(users)
      .values(values)
      .onDuplicateKeyUpdate({
        set: {
          lastLogin: sql`values(${users.lastLogin})`,
        },
      });
    ```

    ```sql
    insert into users (`id`, `last_login`)
      values
        (1, '2024-03-15 23:08:27.025'),
        (2, '2024-03-15 00:08:27.025'),
        (3, '2024-03-15 01:08:27.025')
      on duplicate key update last_login = values(last_login);
    ```
  </CodeTab>
  ```ts copy
  import { mysqlTable, serial, timestamp } from 'drizzle-orm/mysql-core';

  export const users = mysqlTable('users', {
    id: serial('id').primaryKey(),
    lastLogin: timestamp('last_login', { mode: 'date' }).notNull(),
  });
  ```
</CodeTabs>

Drizzle æä¾›äº†ç®€å•è€Œçµæ´»çš„ APIï¼Œå¯ä»¥è®©æ‚¨è½»æ¾åˆ›å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆã€‚è¿™æ˜¯å¦‚ä½•é’ˆå¯¹ MySQL ä¸­ç”±äºå†²çªè€Œæ›´æ–°ç‰¹å®šåˆ—çš„è‡ªå®šä¹‰å‡½æ•°ï¼š

<CodeTabs items={["index.ts", "schema.ts"]}>
  <CodeTab>
    ```ts copy {36,38}
    import { SQL, getColumns, sql } from 'drizzle-orm';
    import { MySqlTable } from 'drizzle-orm/mysql-core';
    import { users } from './schema';

    const buildConflictUpdateColumns = <T extends MySqlTable, Q extends keyof T['_']['columns']>(
      table: T,
      columns: Q[],
    ) => {
      const cls = getColumns(table);
      return columns.reduce((acc, column) => {
        acc[column] = sql`values(${cls[column]})`;
        return acc;
      }, {} as Record<Q, SQL>);
    };

    const values = [
      {
        id: 1,
        lastLogin: new Date(),
        active: true,
      },
      {
        id: 2,
        lastLogin: new Date(Date.now() + 1000 * 60 * 60),
        active: true,
      },
      {
        id: 3,
        lastLogin: new Date(Date.now() + 1000 * 60 * 120),
        active: true,
      },
    ];

    await db
      .insert(users)
      .values(values)
      .onDuplicateKeyUpdate({
        set: buildConflictUpdateColumns(users, ['lastLogin', 'active']),
      });
    ```

    ```sql
    insert into users (`id`, `last_login`, `active`)
      values
        (1, '2024-03-16 15:23:28.013', true),
        (2, '2024-03-16 16:23:28.013', true),
        (3, '2024-03-16 17:23:28.013', true)
      on duplicate key update last_login = values(last_login), active = values(active);
    ```
  </CodeTab>
  ```ts copy
  import { boolean, mysqlTable, serial, timestamp } from 'drizzle-orm/mysql-core';

  export const users = mysqlTable('users', {
    id: serial('id').primaryKey(),
    lastLogin: timestamp('last_login', { mode: 'date' }).notNull(),
    active: boolean('active').notNull().default(false),
  });
  ```
</CodeTabs>

å¦‚æœæ‚¨æƒ³æ›´æ–°æ‰€æœ‰åˆ—ï¼Œé™¤äº†ç‰¹å®šçš„ä¸€åˆ—ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä¿ç•™å…ˆå‰çš„å€¼ï¼š

<Section>
```ts copy {15}
import { sql } from 'drizzle-orm';
import { users } from './schema';

const data = {
  id: 1,
  name: 'John',
  email: 'john@email.com',
  age: 29,
};

await db
  .insert(users)
  .values(data)
  .onDuplicateKeyUpdate({
    set: { ...data, email: sql`${users.email}` }, // ä¿æŒ email ä¸å˜
});
```

```sql
insert into users (`id`, `name`, `email`, `age`) values (1, 'John', 'john@email.com', 29)
  on duplicate key update id = 1, name = 'John', email = email, age = 29;
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/vector-similarity-search


import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from "@mdx/IsSupportedChipGroup.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Npm from "@mdx/Npm.astro";

<Prerequisites>
- ä» [PostgreSQL](/docs/get-started-postgresql) å¼€å§‹å…¥é—¨ã€‚
- [é€‰æ‹©è¯­å¥](/docs/select)
- [ç´¢å¼•](/docs/indexes-constraints#indexes)
- [sql æ“ä½œç¬¦](/docs/sql)
- [pgvector æ‰©å±•](/docs/extensions/pg#pg_vector)
- [Drizzle kit](/docs/kit-overview)
- æ‚¨åº”è¯¥å®‰è£… `openai` [åŒ…](https://www.npmjs.com/package/openai) æ¥ç”ŸæˆåµŒå…¥ã€‚ 
<Npm>
  openai
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `drizzle-orm@0.31.0` å’Œ `drizzle-kit@0.22.0` æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚  
</Prerequisites>

è¦åœ¨ PostgreSQL ä¸­ä½¿ç”¨ Drizzle ORM å®ç°å‘é‡ç›¸ä¼¼æ€§æœç´¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `pgvector` æ‰©å±•ã€‚è¿™ä¸ªæ‰©å±•æä¾›äº†ä¸€ç³»åˆ—å‡½æ•°æ¥å¤„ç†å‘é‡å¹¶è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ã€‚

ç›®å‰ï¼ŒDrizzle å¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ‰©å±•ï¼Œå› æ­¤æ‚¨éœ€è¦æ‰‹åŠ¨åˆ›å»ºã€‚åˆ›å»ºä¸€ä¸ªç©ºçš„è¿ç§»æ–‡ä»¶å¹¶æ·»åŠ  SQL æŸ¥è¯¢ï¼š

<Section>
```bash
npx drizzle-kit generate --custom
```

```sql
CREATE EXTENSION vector;
```
</Section>

ä¸ºäº†è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«å‘é‡åˆ—çš„è¡¨ï¼Œå¹¶åœ¨è¯¥åˆ—ä¸Šåˆ›å»ºä¸€ä¸ª `HNSW` æˆ– `IVFFlat` ç´¢å¼•ä»¥æé«˜æ€§èƒ½ï¼š

<CodeTabs items={["schema.ts", "migration.sql"]}>
  <CodeTab>
  ```ts copy {10, 13}
  import { index, pgTable, serial, text, vector } from 'drizzle-orm/pg-core';

  export const guides = pgTable(
    'guides',
    {
      id: serial('id').primaryKey(),
      title: text('title').notNull(),
      description: text('description').notNull(),
      url: text('url').notNull(),
      embedding: vector('embedding', { dimensions: 1536 }),
    },
    (table) => [
      index('embeddingIndex').using('hnsw', table.embedding.op('vector_cosine_ops')),
    ]
  );
  ```
  </CodeTab>
  ```sql
  CREATE TABLE IF NOT EXISTS "guides" (
    "id" serial PRIMARY KEY NOT NULL,
    "title" text NOT NULL,
    "description" text NOT NULL,
    "url" text NOT NULL,
    "embedding" vector(1536)
  );
  --> statement-breakpoint
  CREATE INDEX IF NOT EXISTS "embeddingIndex" ON "guides" USING hnsw (embedding vector_cosine_ops);
  ```
</CodeTabs>

`embedding` åˆ—ç”¨äºå­˜å‚¨æŒ‡å—æè¿°çš„å‘é‡åµŒå…¥ã€‚å‘é‡åµŒå…¥æ˜¯ä¸€ç§å¯¹æŸäº›æ•°æ®çš„è¡¨ç¤ºã€‚å®ƒå°†ä¸åŒç±»å‹çš„æ•°æ®è½¬æ¢ä¸ºè¯­è¨€æ¨¡å‹å¯ä»¥å¤„ç†çš„é€šç”¨æ ¼å¼ï¼ˆå‘é‡ï¼‰ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ‰§è¡Œæ•°å­¦è¿ç®—ï¼Œä¾‹å¦‚æµ‹é‡ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è·ç¦»ï¼Œä»¥ç¡®å®šä¸¤ä¸ªæ•°æ®é¡¹æ˜¯å¤šä¹ˆç›¸ä¼¼æˆ–ä¸åŒã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `OpenAI` æ¨¡å‹ç”Ÿæˆæè¿°çš„ [åµŒå…¥](https://platform.openai.com/docs/guides/embeddings)ï¼š
```ts copy
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env['OPENAI_API_KEY'],
});

export const generateEmbedding = async (value: string): Promise<number[]> => {
  const input = value.replaceAll('\n', ' ');

  const { data } = await openai.embeddings.create({
    model: 'text-embedding-ada-002',
    input,
  });

  return data[0].embedding;
};
```

è¦é€šè¿‡åµŒå…¥æœç´¢ç›¸ä¼¼çš„æŒ‡å—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `gt` å’Œ `sql` æ“ä½œç¬¦ä¸ `cosineDistance` å‡½æ•°æ¥è®¡ç®— `embedding` åˆ—ä¸ç”Ÿæˆçš„åµŒå…¥ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼š

<Section>
```ts copy {10,15,16}
import { cosineDistance, desc, gt, sql } from 'drizzle-orm';
import { generateEmbedding } from './embedding';
import { guides } from './schema';

const db = drizzle(...);

const findSimilarGuides = async (description: string) => {
  const embedding = await generateEmbedding(description);

  const similarity = sql<number>`1 - (${cosineDistance(guides.embedding, embedding)})`;

  const similarGuides = await db
    .select({ name: guides.title, url: guides.url, similarity })
    .from(guides)
    .where(gt(similarity, 0.5))
    .orderBy((t) => desc(t.similarity))
    .limit(4);

  return similarGuides;
};
```

```ts
const description = 'ä½¿ç”¨ Drizzle ORM çš„å„ç§å¹³å°æŒ‡å—';

const similarGuides = await findSimilarGuides(description);
```

```json
[
  {
    name: 'Drizzle with Turso',
    url: '/docs/tutorials/drizzle-with-turso',
    similarity: 0.8642314333984994
  },
  {
    name: 'Drizzle with Supabase Database',
    url: '/docs/tutorials/drizzle-with-supabase',
    similarity: 0.8593631126014918
  },
  {
    name: 'Drizzle with Neon Postgres',
    url: '/docs/tutorials/drizzle-with-neon',
    similarity: 0.8541051184461372
  },
  {
    name: 'Drizzle with Vercel Edge Functions',
    url: '/docs/tutorials/drizzle-with-vercel-edge-functions',
    similarity: 0.8481551084241092
  }
]
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/indexes-constraints

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';

# ç´¢å¼•ä¸çº¦æŸ

## çº¦æŸ

SQL çº¦æŸæ˜¯å¯¹è¡¨åˆ—æ–½åŠ çš„è§„åˆ™ã€‚å®ƒä»¬ç”¨äºé˜²æ­¢æ— æ•ˆæ•°æ®è¢«è¾“å…¥åˆ°æ•°æ®åº“ä¸­ã€‚

è¿™ç¡®ä¿äº†æ•°æ®åº“ä¸­æ•°æ®çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚

### é»˜è®¤å€¼

`DEFAULT` å­å¥æŒ‡å®šåœ¨æ‰§è¡Œ `INSERT` æ—¶ï¼Œå¦‚æœç”¨æˆ·æœªæä¾›å€¼ï¼Œåˆ™ä½¿ç”¨çš„åˆ—çš„é»˜è®¤å€¼ã€‚
å¦‚æœåˆ—å®šä¹‰ä¸­æ²¡æœ‰é™„åŠ æ˜¾å¼çš„ `DEFAULT` å­å¥ï¼Œ
åˆ™è¯¥åˆ—çš„é»˜è®¤å€¼ä¸º `NULL`ã€‚

æ˜¾å¼çš„ `DEFAULT` å­å¥å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ä¸º `NULL`ã€
å­—ç¬¦ä¸²å¸¸é‡ã€BLOB å¸¸é‡ã€å¸¦ç¬¦å·æ•°å­—æˆ–ä»»ä½•ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„å¸¸é‡è¡¨è¾¾å¼ã€‚

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
    ```typescript
    import { sql } from "drizzle-orm";
    import { integer, uuid, pgTable } from "drizzle-orm/pg-core";

    const table = pgTable('table', {
      integer1: integer('integer1').default(42),
      integer2: integer('integer2').default(sql`'42'::integer`),
      uuid1: uuid('uuid1').defaultRandom(),
      uuid2: uuid('uuid2').default(sql`gen_random_uuid()`),
    });
    ```

    ```sql
    CREATE TABLE "table" (
      "integer1" integer DEFAULT 42,
      "integer2" integer DEFAULT '42'::integer,
      "uuid1" uuid DEFAULT gen_random_uuid(),
      "uuid2" uuid DEFAULT gen_random_uuid()
    );
    ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
    ```typescript
    import { sql } from "drizzle-orm";
    import { int, time, mysqlTable } from "drizzle-orm/mysql-core";
    
    const table = mysqlTable("table", {
      int: int("int").default(42),
      time: time("time").default(sql`cast("14:06:10" AS TIME)`),
    });
    ```
    ```sql
    CREATE TABLE `table` (
      `int` int DEFAULT 42,
      `time` time DEFAULT cast("14:06:10" AS TIME)
    );
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```typescript
    import { sql } from "drizzle-orm";
    import { integer, sqliteTable } from "drizzle-orm/sqlite-core";

    const table = sqliteTable('table', {
      int1: integer('int1').default(42),
      int2: integer('int2').default(sql`(abs(42))`)
    });

    ```
    ```sql
    CREATE TABLE `table` (
      `int1` integer DEFAULT 42
      `int2` integer DEFAULT (abs(42))
    );
    ```
    </Section>

  </Tab>
  <Tab>
    <Section>
    ```typescript
    import { sql } from "drizzle-orm";
    import { int, time, singlestoreTable } from "drizzle-orm/singlestore-core";
    
    const table = singlestoreTable("table", {
      int: int("int").default(42),
      time: time("time").default(sql`cast("14:06:10" AS TIME)`),
    });
    ```
    ```sql
    CREATE TABLE `table` (
      `int` int DEFAULT 42,
      `time` time DEFAULT cast("14:06:10" AS TIME)
    );
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```typescript
    import { sql } from "drizzle-orm";
    import { int, time, mssqlTable } from "drizzle-orm/mssql-core";
    
    const table = mssqlTable("table", {
      int: int().default(42),
      description: text().default(`This is your dashboard!`),
    });
    ```
    ```sql
    CREATE TABLE [table] (
      [int] int DEFAULT 42,
      [description] text DEFAULT 'This is your dashboard!'
    );
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```typescript
    import { sql } from "drizzle-orm";
    import { int4, uuid, cockroachTable } from "drizzle-orm/cockroach-core";

    const table = cockroachTable('table', {
      integer1: int4().default(42),
      integer2: int4().default(sql`'42'::int4`),
      uuid1: uuid().defaultRandom(),
      uuid2: uuid().default(sql`gen_random_uuid()`),
    });
    ```

    ```sql
    CREATE TABLE "table" (
      "integer1" int4 DEFAULT 42,
      "integer2" int4 DEFAULT '42'::integer,
      "uuid1" uuid DEFAULT gen_random_uuid(),
      "uuid2" uuid DEFAULT gen_random_uuid()
    );
    ```
    </Section>

  </Tab> 
</Tabs>

### éç©º

é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ—å¯ä»¥åŒ…å« **NULL** å€¼ã€‚`NOT NULL` çº¦æŸå¼ºåˆ¶åˆ— **ä¸** æ¥å— **NULL** å€¼ã€‚

è¿™å¼ºåˆ¶å­—æ®µå§‹ç»ˆåŒ…å«ä¸€ä¸ªå€¼ï¼Œè¿™æ„å‘³ç€æ‚¨ä¸èƒ½æ’å…¥æ–°è®°å½•ï¼Œ
æˆ–åœ¨ä¸å‘è¯¥å­—æ®µæ·»åŠ å€¼çš„æƒ…å†µä¸‹æ›´æ–°è®°å½•ã€‚

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```typescript copy
      import { integer, pgTable } from "drizzle-orm/pg-core";

      const table = pgTable('table', {
        integer: integer('integer').notNull(),
      });
      ```

      ```sql
      CREATE TABLE "table" (
        "integer" integer NOT NULL
      );
      ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
      ```typescript
      import { int, mysqlTable } from "drizzle-orm/mysql-core";

      const table = mysqlTable('table', {
        int: int('int').notNull(),
      });
      ```

      ```sql
      CREATE TABLE `table` (
        `int` int NOT NULL
      );
      ```
    </Section>

  </Tab>
  <Tab>
   <Section>
      ```typescript copy
      const table = sqliteTable('table', { 
        numInt: integer('numInt').notNull() 
      });
      ```

      ```sql
      CREATE TABLE table (
        `numInt` integer NOT NULL
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript
      import { int, singlestoreTable } from "drizzle-orm/singlestore-core";

      const table = singlestoreTable('table', {
        int: int('int').notNull(),
      });
      ```

      ```sql
      CREATE TABLE `table` (
        `int` int NOT NULL
      );
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```typescript
      import { int, mssqlTable } from "drizzle-orm/mssql-core";

      const table = mssqlTable('table', {
        int: int().notNull(),
      });
      ```

      ```sql
      CREATE TABLE [table] (
        [int] int NOT NULL
      );
      ```
    </Section>
  </Tab>
    <Tab>
    <Section>
      ```typescript copy
      import { int4, cockroachTable } from "drizzle-orm/cockroach-core";

      const table = cockroachTable('table', {
        integer: int4().notNull(),
      });
      ```

      ```sql
      CREATE TABLE "table" (
        "integer" int4 NOT NULL
      );
      ```
    </Section>
  </Tab> 
</Tabs>

### å”¯ä¸€

`UNIQUE` çº¦æŸç¡®ä¿åˆ—ä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ä¸åŒçš„ã€‚

`UNIQUE` å’Œ `PRIMARY KEY` çº¦æŸéƒ½ä¸ºåˆ—æˆ–åˆ—é›†æä¾›äº†å”¯ä¸€æ€§çš„ä¿è¯ã€‚

`PRIMARY KEY` çº¦æŸè‡ªåŠ¨å…·æœ‰ `UNIQUE` çº¦æŸã€‚

<Callout type="info" emoji="â„¹ï¸">
  æ¯ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ª `UNIQUE` çº¦æŸï¼Œä½†æ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ª `PRIMARY KEY` çº¦æŸã€‚
</Callout>

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```typescript copy
      import { integer, text, unique, pgTable } from "drizzle-orm/pg-core";

      export const user = pgTable('user', {
        id: integer('id').unique(),
      });

      export const table = pgTable('table', {
        id: integer('id').unique('custom_name'),
      });

      export const composite = pgTable('composite_example', {
        id: integer('id'),
        name: text('name'),
      }, (t) => [
        unique().on(t.id, t.name),
        unique('custom_name').on(t.id, t.name)
      ]);

      // åœ¨ Postgres 15.0+ ä¸­ï¼Œæ”¯æŒ NULLS NOT DISTINCT
      // æ­¤ç¤ºä¾‹æ¼”ç¤ºäº†ä¸¤ç§å¯ç”¨ç”¨æ³•
      export const userNulls = pgTable('user_nulls_example', {
        id: integer('id').unique("custom_name", { nulls: 'not distinct' }),
      }, (t) => [
        unique().on(t.id).nullsNotDistinct()
      ]);
      ```

      ```sql
      CREATE TABLE "composite_example" (
	      "id" integer,
        "name" text,
        CONSTRAINT "composite_example_id_name_unique" UNIQUE("id","name"),
        CONSTRAINT "custom_name" UNIQUE("id","name")
      );

      CREATE TABLE "table" (
      	"id" integer,
      	CONSTRAINT "custom_name" UNIQUE("id")
      );

      CREATE TABLE "user" (
      	"id" integer,
      	CONSTRAINT "user_id_unique" UNIQUE("id")
      );

      CREATE TABLE "user_nulls_example" (
        "id" integer,
        CONSTRAINT "custom_name" UNIQUE NULLS NOT DISTINCT("id"),
        CONSTRAINT "user_nulls_example_id_unique" UNIQUE NULLS NOT DISTINCT("id")
      );
      ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
      ```typescript
      import { int, varchar, unique, mysqlTable } from "drizzle-orm/mysql-core";

      export const user = mysqlTable('user', {
        id: int('id').unique(),
      });

      export const table = mysqlTable('table', {
        id: int('id').unique('custom_name'),
      });

      export const composite = mysqlTable('composite_example', {
        id: int('id'),
        name: varchar('name', { length: 256 }),
      }, (t) => [
        unique().on(t.id, t.name),
        unique('custom_name').on(t.id, t.name)
      ]);
      ```

      ```sql
      CREATE TABLE `user` (
      	`id` int,
      	CONSTRAINT `user_id_unique` UNIQUE(`id`)
      );

      CREATE TABLE `table` (
      	`id` int,
      	CONSTRAINT `custom_name` UNIQUE(`id`)
      );

      CREATE TABLE `composite_example` (
        `id` int,
        `name` varchar(256),
        CONSTRAINT `composite_example_id_name_unique` UNIQUE(`id`,`name`),
        CONSTRAINT `custom_name` UNIQUE(`id`,`name`)
      );
      ```
    </Section>

  </Tab>
  <Tab>
   <Section>
      ```typescript copy
      import { int, text, unique, sqliteTable } from "drizzle-orm/sqlite-core";

      export const user = sqliteTable('user', {
        id: int('id').unique(),
      });

      export const table = sqliteTable('table', {
        id: int('id').unique('custom_name'),
      });

      export const composite = sqliteTable('composite_example', {
        id: int('id'),
        name: text('name'),
      }, (t) => [
        unique().on(t.id, t.name),
        unique('custom_name').on(t.id, t.name)
      ]);
      ```

      ```sql
      CREATE TABLE `user` (
	      `id` integer
      );

      CREATE TABLE `table` (
      	`id` integer
      );

      CREATE TABLE `composite_example` (
      	`id` integer,
      	`name` text
      );

      CREATE UNIQUE INDEX `composite_example_id_name_unique` ON `composite_example` (`id`,`name`);
      CREATE UNIQUE INDEX `custom_name` ON `composite_example` (`id`,`name`);
      CREATE UNIQUE INDEX `custom_name` ON `table` (`id`);
      CREATE UNIQUE INDEX `user_id_unique` ON `user` (`id`);
      ```
    </Section>

  </Tab>
    <Tab>
    <Section>
      ```typescript
      import { int, varchar, unique, singlestoreTable } from "drizzle-orm/singlestore-core";

      export const user = singlestoreTable('user', {
        id: int('id').unique(),
      });

      export const table = singlestoreTable('table', {
        id: int('id').unique('custom_name'),
      });

      export const composite = singlestoreTable('composite_example', {
        id: int('id'),
        name: varchar('name', { length: 256 }),
      }, (t) => [
        unique().on(t.id, t.name),
        unique('custom_name').on(t.id, t.name)
      ]);
      ```

      ```sql
      CREATE TABLE `user` (
      	`id` int,
      	CONSTRAINT `user_id_unique` UNIQUE(`id`)
      );

      CREATE TABLE `table` (
      	`id` int,
      	CONSTRAINT `custom_name` UNIQUE(`id`)
      );

      CREATE TABLE `composite_example` (
        `id` int,
        `name` varchar(256),
        CONSTRAINT `composite_example_id_name_unique` UNIQUE(`id`,`name`),
        CONSTRAINT `custom_name` UNIQUE(`id`,`name`)
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Callout type='warning'>
    åœ¨ MSSQL ä¸­ï¼Œæ— æ³•å¯¹ `text`ã€`ntext`ã€`varchar(max)`ã€`nvarchar(max)` åˆ›å»ºå”¯ä¸€çº¦æŸ
    </Callout>
    <Section>
      ```typescript
      import { int, varchar, unique, mssqlTable } from "drizzle-orm/mssql-core";

      export const user = mssqlTable('user', {
        id: int().unique(),
      });

      export const table = mssqlTable('table', {
        id: int().unique('custom_name'),
      });

      export const composite = mssqlTable('composite_example', {
        id: int(),
        name: varchar({ length: 256 }),
      }, (t) => [
        unique().on(t.id, t.name),
        unique('custom_name').on(t.id, t.name)
      ]);
      ```

      ```sql
      CREATE TABLE [user] (
      	[id] int,
      	CONSTRAINT [user_id_key] UNIQUE([id])
      );

      CREATE TABLE [table] (
      	[id] int,
      	CONSTRAINT [custom_name] UNIQUE([id])
      );

      CREATE TABLE [composite_example] (
        [id] int,
        [name] varchar(256),
        CONSTRAINT [composite_example_id_name_key] UNIQUE([id],[name]),
        CONSTRAINT [custom_name] UNIQUE([id],[name])
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript copy
      import { int4, text, unique, cockroachTable } from "drizzle-orm/cockroach-core";

      export const user = cockroachTable('user', {
        id: int4().unique(),
      });

      export const table = cockroachTable('table', {
        id: int4().unique('custom_name'),
      });

      export const composite = cockroachTable('composite_example', {
        id: int4(),
        name: text(),
      }, (t) => [
        unique().on(t.id, t.name),
        unique('custom_name').on(t.id, t.name)
      ]);
      ```
      ```sql
      CREATE TABLE "user" (
      	"id" integer,
      	CONSTRAINT "user_id_unique" UNIQUE("id")
      );

      CREATE TABLE "table" (
      	"id" integer,
      	CONSTRAINT "custom_name" UNIQUE("id")
      );

      CREATE TABLE "composite_example" (
	      "id" integer,
        "name" text,
        CONSTRAINT "composite_example_id_name_unique" UNIQUE("id","name"),
        CONSTRAINT "custom_name" UNIQUE("id","name")
      );
      ```
    </Section>
  </Tab> 
</Tabs>

### æ£€æŸ¥

`CHECK` çº¦æŸç”¨äºé™åˆ¶å¯ä»¥æ”¾ç½®åœ¨åˆ—ä¸­çš„å€¼èŒƒå›´ã€‚

å¦‚æœæ‚¨åœ¨åˆ—ä¸Šå®šä¹‰ `CHECK` çº¦æŸï¼Œå®ƒå°†ä»…å…è®¸è¯¥åˆ—çš„æŸäº›å€¼ã€‚

å¦‚æœæ‚¨åœ¨è¡¨ä¸Šå®šä¹‰ `CHECK` çº¦æŸï¼Œå®ƒå¯ä»¥æ ¹æ®è¡Œä¸­å…¶ä»–åˆ—çš„å€¼é™åˆ¶æŸäº›åˆ—çš„å€¼ã€‚

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```typescript copy
      import { sql } from "drizzle-orm";
      import { check, integer, pgTable, text, uuid } from "drizzle-orm/pg-core";

      export const users = pgTable(
        "users",
        {
          id: uuid().defaultRandom().primaryKey(),
          username: text().notNull(),
          age: integer(),
        },
        (table) => [
          check("age_check1", sql`${table.age} > 21`),
        ]
      );
      ```
      ```sql
      CREATE TABLE "users" (
	      "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	      "username" text NOT NULL,
	      "age" integer,
	      CONSTRAINT "age_check1" CHECK ("users"."age" > 21)
      );
      ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
      ```typescript copy
      import { sql } from "drizzle-orm";
      import { check, int, mysqlTable, text } from "drizzle-orm/mysql-core";

      export const users = mysqlTable(
        "users",
        {
          id: int().primaryKey(),
          username: text().notNull(),
          age: int(),
        },
        (table) => [
          check("age_check1", sql`${table.age} > 21`)
        ]
      );
      ```
      ```sql
      CREATE TABLE `users` (
	      `id` int NOT NULL,
	      `username` text NOT NULL,
	      `age` int,
	      CONSTRAINT `users_id` PRIMARY KEY(`id`),
	      CONSTRAINT `age_check1` CHECK(`users`.`age` > 21)
      );
      ```
    </Section>
  </Tab>
  <Tab>
   <Section>
      ```typescript copy
      import { sql } from "drizzle-orm";
      import { check, int, sqliteTable, text } from "drizzle-orm/sqlite-core";

      export const users = sqliteTable(
        "users",
        {
          id: int().primaryKey(),
          username: text().notNull(),
          age: int(),
        },
        (table) => [
          check("age_check1", sql`${table.age} > 21`)
        ]
      );
      ```
      ```sql
      CREATE TABLE `users` (
	      `id` integer PRIMARY KEY NOT NULL,
	      `username` text NOT NULL,
	      `age` integer,
	      CONSTRAINT "age_check1" CHECK("users"."age" > 21)
      );
      ```
    </Section>

  </Tab>
  <Tab>
    å½“å‰ä¸æ”¯æŒ SingleStore
  </Tab>
<Tab>
    <Section>
      ```typescript copy
      import { sql } from "drizzle-orm";
      import { check, int, mssqlTable, text } from "drizzle-orm/mssql-core";

      export const users = mssqlTable(
        "users",
        {
          id: int().primaryKey(),
          username: text().notNull(),
          age: integer(),
        },
        (table) => [
          check("age_check1", sql`${table.age} > 21`),
        ]
      );
      ```
      ```sql
      CREATE TABLE [users] (
	      [id] int PRIMARY KEY,
	      [username] text NOT NULL,
	      [age] integer,
	      CONSTRAINT [age_check1] CHECK ([users].[age] > 21)
      );
      ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
      ```typescript copy
      import { sql } from "drizzle-orm";
      import { check, int4, cockroachTable, text, uuid } from "drizzle-orm/cockroach-core";

      export const users = cockroachTable(
        "users",
        {
          id: uuid().defaultRandom().primaryKey(),
          username: text().notNull(),
          age: int4(),
        },
        (table) => [
          check("age_check1", sql`${table.age} > 21`),
        ]
      );
      ```
      ```sql
      CREATE TABLE "users" (
	      "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	      "username" text NOT NULL,
	      "age" int4,
	      CONSTRAINT "age_check1" CHECK ("users"."age" > 21)
      );
      ```
    </Section>

  </Tab> 
</Tabs>

### ä¸»é”®

`PRIMARY KEY` çº¦æŸå”¯ä¸€æ ‡è¯†è¡¨ä¸­çš„æ¯æ¡è®°å½•ã€‚
ä¸»é”®å¿…é¡»åŒ…å« `UNIQUE` å€¼ï¼Œå¹¶ä¸”ä¸èƒ½åŒ…å« `NULL` å€¼ã€‚

ä¸€ä¸ªè¡¨åªèƒ½æœ‰ **ä¸€ä¸ª** ä¸»é”®ï¼›åœ¨è¯¥è¡¨ä¸­ï¼Œè¿™ä¸ªä¸»é”®å¯ä»¥ç”±å•ä¸ªæˆ–å¤šä¸ªåˆ—ï¼ˆå­—æ®µï¼‰ç»„æˆã€‚

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```typescript copy
      import { serial, text, pgTable } from "drizzle-orm/pg-core";

      const user = pgTable('user', {
        id: serial('id').primaryKey(),
      });

      const table = pgTable('table', {
        id: text('cuid').primaryKey(),
      });
      ```

      ```sql
      CREATE TABLE "user" (
        "id" serial PRIMARY KEY
      );

      CREATE TABLE "table" (
        "cuid" text PRIMARY KEY
      );
      ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
      ```typescript
      import { int, text, mysqlTable } from "drizzle-orm/mysql-core";

      export const user = mysqlTable("user", {
        id: int("id").autoincrement().primaryKey(),
      })

      export const table = mysqlTable("table", {
        cuid: text("cuid").primaryKey(),
      })
      ```

      ```sql
      CREATE TABLE `user` (
        `id` int AUTO_INCREMENT PRIMARY KEY NOT NULL
      );

      CREATE TABLE `table` (
        `cuid` text PRIMARY KEY NOT NULL
      );
      ```
    </Section>

  </Tab>
  <Tab>
   <Section>
      ```typescript copy
      import { integer, sqliteTable } from "drizzle-orm/sqlite-core";

      export const user = sqliteTable("user", {
        id: integer("id").primaryKey(),
      })

      export const pet = sqliteTable("pet", {
        id: integer("id").primaryKey(),
      })
      ```

      ```sql
      CREATE TABLE `user` (
        `id` integer PRIMARY KEY AUTOINCREMENT NOT NULL
      );

      CREATE TABLE `pet` (
        `id` integer PRIMARY KEY AUTOINCREMENT
      )
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript
      import { int, text, singlestoreTable } from "drizzle-orm/singlestore-core";

      export const user = singlestoreTable("user", {
        id: int("id").autoincrement().primaryKey(),
      })

      export const table = singlestoreTable("table", {
        cuid: text("cuid").primaryKey(),
      })
      ```

      ```sql
      CREATE TABLE `user` (
        `id` int AUTO_INCREMENT PRIMARY KEY NOT NULL
      );

      CREATE TABLE `table` (
        `cuid` text PRIMARY KEY NOT NULL
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript
      import { int, text, mssqlTable } from "drizzle-orm/mssql-core";

      export const user = mssqlTable("user", {
        id: int().primaryKey(),
      })
      ```

      ```sql
      CREATE TABLE [user] (
        [id] int,
        CONSTRAINT [user_pkey] PRIMARY KEY [id]
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript copy
      import { int4, text, cockroachTable } from "drizzle-orm/cockroach-core";

      const user = cockroachTable('user', {
        id: int4().primaryKey(),
      });

      const table = cockroachTable('table', {
        id: text().primaryKey(),
      });
      ```

      ```sql
      CREATE TABLE "user" (
        "id" int4 PRIMARY KEY
      );

      CREATE TABLE "table" (
        "cuid" text PRIMARY KEY
      );
      ```
    </Section>

  </Tab> 
</Tabs>

### å¤åˆä¸»é”®

å°±åƒ `PRIMARY KEY`ï¼Œå¤åˆä¸»é”®é€šè¿‡å¤šä¸ªå­—æ®µå”¯ä¸€æ ‡è¯†è¡¨ä¸­çš„æ¯æ¡è®°å½•ã€‚

Drizzle ORM æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„ `primaryKey` æ“ä½œç¬¦æ¥å®ç°è¿™ä¸€ç‚¹ï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```typescript copy {18, 19}
      import { serial, text, integer, primaryKey, pgTable } from "drizzle-orm/pg-core";

      export const user = pgTable("user", {
        id: serial("id").primaryKey(),
        name: text("name"),
      });

      export const book = pgTable("book", {
        id: serial("id").primaryKey(),
        name: text("name"),
      });

      export const booksToAuthors = pgTable("books_to_authors", {
        authorId: integer("author_id"),
        bookId: integer("book_id"),
      }, (table) => [
        primaryKey({ columns: [table.bookId, table.authorId] }),
        // æˆ–è€…å¸¦è‡ªå®šä¹‰åç§°çš„ä¸»é”®
        primaryKey({ name: 'custom_name', columns: [table.bookId, table.authorId] }),
      ]);
      ```

      ```sql {6, 9}
      ...

      CREATE TABLE "books_to_authors" (
        "author_id" integer,
        "book_id" integer,
        PRIMARY KEY("book_id","author_id")
      );

      ALTER TABLE "books_to_authors" ADD CONSTRAINT "custom_name" PRIMARY KEY("book_id","author_id");
      ```
    </Section>

  </Tab> 
  <Tab>
    <Section>
      ```typescript {18, 19}
      import { int, text, primaryKey, mysqlTable } from "drizzle-orm/mysql-core";

      export const user = mysqlTable("user", {
        id: int("id").autoincrement().primaryKey(),
        name: text("name"),
      });

      export const book = mysqlTable("book", {
        id: int("id").autoincrement().primaryKey(),
        name: text("name"),
      });

      export const booksToAuthors = mysqlTable("books_to_authors", {
        authorId: int("author_id"),
        bookId: int("book_id"),
      }, (table) => [
        primaryKey({ columns: [table.bookId, table.authorId] }),
        // æˆ–è€…å¸¦è‡ªå®šä¹‰åç§°çš„ä¸»é”®
        primaryKey({ name: 'custom_name', columns: [table.bookId, table.authorId] })
      ]);
      ```

      ```sql {6}
      ...

      CREATE TABLE `books_to_authors` (
        `author_id` int,
        `book_id` int,
        PRIMARY KEY(`book_id`,`author_id`)
      );
      ```
    </Section>

  </Tab>
  <Tab>
   <Section>
      ```typescript copy {18, 19}
      import { integer, text, primaryKey, sqliteTable} from "drizzle-orm/sqlite-core";

      export const user = sqliteTable("user", {
        id: integer("id").primaryKey({ autoIncrement: true }),
        name: text("name"),
      });

      export const book = sqliteTable("book", {
        id: integer("id").primaryKey({ autoIncrement: true }),
        name: text("name"),
      });

      export const bookToAuthor = sqliteTable("book_to_author", {
        authorId: integer("author_id"),
        bookId: integer("book_id"),
      }, (table) => [
        primaryKey({ columns: [table.bookId, table.authorId] }),
        // æˆ–è€…å¸¦è‡ªå®šä¹‰åç§°çš„ä¸»é”®
        primaryKey({ name: 'custom_name', columns: [table.bookId, table.authorId] })
      ]);
      ```
      ```sql {6}
      ...

      CREATE TABLE `book_to_author` (
        `author_id` integer,
        `book_id` integer,
        PRIMARY KEY(`book_id`, `author_id`)
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript {18, 19}
      import { int, text, primaryKey, mysqlTable } from "drizzle-orm/singlestore-core";

      export const user = singlestoreTable("user", {
        id: int("id").autoincrement().primaryKey(),
        name: text("name"),
      });

      export const book = singlestoreTable("book", {
        id: int("id").autoincrement().primaryKey(),
        name: text("name"),
      });

      export const booksToAuthors = singlestoreTable("books_to_authors", {
        authorId: int("author_id"),
        bookId: int("book_id"),
      }, (table) => [
        primaryKey({ columns: [table.bookId, table.authorId] }),
        // æˆ–è€…å¸¦è‡ªå®šä¹‰åç§°çš„ä¸»é”®
        primaryKey({ name: 'custom_name', columns: [table.bookId, table.authorId] }),
      ]);
      ```

      ```sql {6}
      ...

      CREATE TABLE `books_to_authors` (
        `author_id` int,
        `book_id` int,
        PRIMARY KEY(`book_id`,`author_id`)
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript {18, 19}
      import { int, text, primaryKey, mssqlTable } from "drizzle-orm/mssql-core";

      export const user = mssqlTable("user", {
        id: int().primaryKey(),
        name: text(),
      });

      export const book = mssqlTable("book", {
        id: int().primaryKey(),
        name: text(),
      });

      export const booksToAuthors = mssqlTable("books_to_authors", {
        authorId: int("author_id"),
        bookId: int("book_id"),
      }, (table) => [
        primaryKey({ columns: [table.bookId, table.authorId] }),
        // æˆ–è€…å¸¦è‡ªå®šä¹‰åç§°çš„ä¸»é”®
        primaryKey({ name: 'custom_name', columns: [table.bookId, table.authorId] }),
      ]);
      ```

      ```sql {6}
      ...

      CREATE TABLE [books_to_authors] (
        [author_id] int,
        [book_id] int,
        CONSTRAINT [custom_name] PRIMARY KEY([book_id], [author_id])
      );
      ```
    </Section>

  </Tab>
  <Tab>
    <Section>
      ```typescript copy {18, 19}
      import { int4, text, primaryKey, cockroachTable } from "drizzle-orm/cockroach-core";

      export const user = cockroachTable("user", {
        id: int4().primaryKey(),
        name: text(),
      });

      export const book = cockroachTable("book", {
        id: int4("id").primaryKey(),
        name: text("name"),
      });

      export const booksToAuthors = cockroachTable("books_to_authors", {
        authorId: int4("author_id"),
        bookId: int4("book_id"),
      }, (table) => [
        primaryKey({ columns: [table.bookId, table.authorId] }),
        // æˆ–è€…å¸¦è‡ªå®šä¹‰åç§°çš„ä¸»é”®
        primaryKey({ name: 'custom_name', columns: [table.bookId, table.authorId] }),
      ]);
      ```

      ```sql {6, 9}
      ...

      CREATE TABLE "books_to_authors" (
        "author_id" int4,
        "book_id" int4,
        PRIMARY KEY("book_id","author_id")
      );

      ALTER TABLE "books_to_authors" ADD CONSTRAINT "custom_name" PRIMARY KEY("book_id","author_id");
      ```
    </Section>
  </Tab> 
</Tabs>

### å¤–é”®

`FOREIGN KEY` çº¦æŸç”¨äºé˜²æ­¢ç ´åè¡¨ä¹‹é—´é“¾æ¥çš„æ“ä½œã€‚
`FOREIGN KEY` æ˜¯ä¸€ä¸ªå­—æ®µï¼ˆæˆ–å­—æ®µé›†åˆï¼‰ï¼Œåœ¨ä¸€ä¸ªè¡¨ä¸­å¼•ç”¨å¦ä¸€ä¸ªè¡¨çš„ `PRIMARY KEY`ã€‚
åŒ…å«å¤–é”®çš„è¡¨ç§°ä¸ºå­è¡¨ï¼ŒåŒ…å«ä¸»é”®çš„è¡¨ç§°ä¸ºå¼•ç”¨è¡¨æˆ–çˆ¶è¡¨ã€‚

Drizzle ORM æä¾›äº†å‡ ç§å£°æ˜å¤–é”®çš„æ–¹æ³•ã€‚
æ‚¨å¯ä»¥åœ¨åˆ—å£°æ˜è¯­å¥ä¸­å£°æ˜å®ƒä»¬ï¼š

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    ```typescript copy {11}
    import { serial, text, integer, pgTable } from "drizzle-orm/pg-core";

    export const user = pgTable("user", {
      id: serial("id"),
      name: text("name"),
    });

    export const book = pgTable("book", {
      id: serial("id"),
      name: text("name"),
      authorId: integer("author_id").references(() => user.id)
    });
    ```

  </Tab>
  <Tab>
    ```typescript {11}
    import { int, text, mysqlTable } from "drizzle-orm/mysql-core";

    export const user = mysqlTable("user", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
    });

    export const book = mysqlTable("book", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
      authorId: int("author_id").references(() => user.id)
    });
    ```

  </Tab>
  <Tab>
    ```typescript {11}
    import { integer, text, sqliteTable } from "drizzle-orm/sqlite-core";

    export const user = sqliteTable("user", {
      id: integer("id").primaryKey({ autoIncrement: true }),
      name: text("name"),
    });

    export const book = sqliteTable("book", {
      id: integer("id").primaryKey({ autoIncrement: true }),
      name: text("name"),
      authorId: integer("author_id").references(() => user.id)
    });
    ```

  </Tab>
  <Tab>
    å½“å‰åœ¨ SingleStore ä¸­ä¸æ”¯æŒ
  </Tab>
  <Tab>
    ```typescript {11}
    import { int, text, mssqlTable } from "drizzle-orm/mssql-core";

    export const user = mssqlTable("user", {
      id: int().primaryKey(),
      name: text(),
    });

    export const book = mssqlTable("book", {
      id: int().primaryKey(),
      name: text(),
      authorId: int("author_id").references(() => user.id)
    });
    ```

  </Tab>
    <Tab>
    ```typescript copy {11}
    import { int4, text, cockroachTable } from "drizzle-orm/cockroach-core";

    export const user = cockroachTable("user", {
      id: int4().primaryKey(),
      name: text(),
    });

    export const book = cockroachTable("book", {
      id: int4().primaryKey(),
      name: text(),
      authorId: int4("author_id").references(() => user.id)
    });
    ```
  </Tab>
</Tabs>

å¦‚æœæ‚¨æƒ³è¿›è¡Œè‡ªå¼•ç”¨ï¼Œç”±äº TypeScript çš„é™åˆ¶ï¼Œæ‚¨å¿…é¡»æ˜¾å¼è®¾ç½®å¼•ç”¨å›è°ƒçš„è¿”å›ç±»å‹æˆ–ä½¿ç”¨ç‹¬ç«‹çš„ `foreignKey` æ“ä½œç¬¦ã€‚

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    ```typescript copy {6,16-19}
    import { serial, text, integer, foreignKey, pgTable, AnyPgColumn } from "drizzle-orm/pg-core";

    export const user = pgTable("user", {
      id: serial("id"),
      name: text("name"),
      parentId: integer("parent_id").references((): AnyPgColumn => user.id)
    });

    // æˆ–è€…
    export const user = pgTable("user", {
      id: serial("id"),
      name: text("name"),
      parentId: integer("parent_id"),
    }, (table) => [
      foreignKey({
        columns: [table.parentId],
        foreignColumns: [table.id],
        name: "custom_fk"
      })
    ]);
    ```

  </Tab>
  <Tab>
    ```typescript {6,16-19}
    import { int, text, foreignKey, AnyMySqlColumn, mysqlTable } from "drizzle-orm/mysql-core";

    export const user = mysqlTable("user", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
      parentId: int("parent_id").references((): AnyMySqlColumn => user.id),
    });

    // æˆ–è€…
    export const user = mysqlTable("user", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
      parentId: int("parent_id")
    }, (table) => [
      foreignKey({
        columns: [table.parentId],
        foreignColumns: [table.id],
        name: "custom_fk"
      })
    ]);
    ```

  </Tab>
  <Tab>
    ```typescript {6,16-19}
    import { integer, text, foreignKey, sqliteTable, AnySQLiteColumn } from "drizzle-orm/sqlite-core";

    export const user = sqliteTable("user", {
      id: integer("id").primaryKey({ autoIncrement: true }),
      name: text("name"),
      parentId: integer("parent_id").references((): AnySQLiteColumn => user.id)
    });

    //æˆ–è€…
    export const user = sqliteTable("user", {
      id: integer("id").primaryKey({ autoIncrement: true }),
      name: text("name"),
      parentId: integer("parent_id"),
    }, (table) => [
      foreignKey({
        columns: [table.parentId],
        foreignColumns: [table.id],
        name: "custom_fk"
      })
    ]);
    ```

  </Tab>
  <Tab>
    å½“å‰åœ¨ SingleStore ä¸­ä¸æ”¯æŒ
  </Tab>
    <Tab>
    ```typescript {6,16-19}
    import { int, text, foreignKey, mssqlTable, AnyMsSQLColumn } from "drizzle-orm/mssql-core";

    export const user = mssqlTable("user", {
      id: int().primaryKey(),
      name: text(),
      parentId: int("parent_id").references((): AnyMsSQLColumn => user.id)
    });

    //æˆ–è€…
    export const user = mssqlTable("user", {
      id: int().primaryKey(),
      name: text(),
      parentId: int("parent_id"),
    }, (table) => [
      foreignKey({
        columns: [table.parentId],
        foreignColumns: [table.id],
        name: "custom_fk"
      })
    ]);
    ```
  </Tab>
  <Tab>
    ```typescript copy {6,16-19}
    import { int4, text, foreignKey, cockroachTable, AnyCockroachColumn } from "drizzle-orm/cockroach-core";

    export const user = cockroachTable("user", {
      id: int4().primaryKey(),
      name: text(),
      parentId: int4("parent_id").references((): AnyCockroachColumn => user.id)
    });

    // æˆ–è€…
    export const user = cockroachTable("user", {
      id: int4().primaryKey(),
      name: text(),
      parentId: int4("parent_id"),
    }, (table) => [
      foreignKey({
        columns: [table.parentId],
        foreignColumns: [table.id],
        name: "custom_fk"
      })
    ]);
    ```

  </Tab>
</Tabs>
è¦å£°æ˜å¤šåˆ—å¤–é”®ï¼Œå¯ä»¥ä½¿ç”¨ä¸“ç”¨çš„ `foreignKey` æ“ä½œç¬¦ï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    ```typescript copy {4-5,14-15,18-21}
    import { serial, text, foreignKey, pgTable, AnyPgColumn } from "drizzle-orm/pg-core";

    export const user = pgTable("user", {
      firstName: text("firstName"),
      lastName: text("lastName"),
    }, (table) => [
      primaryKey({ columns: [table.firstName, table.lastName]})
    ]);

    export const profile = pgTable("profile", {
      id: serial("id").primaryKey(),
      userFirstName: text("user_first_name"),
      userLastName: text("user_last_name"),
    }, (table) => [
      foreignKey({
        columns: [table.userFirstName, table.userLastName],
        foreignColumns: [user.firstName, user.lastName],
        name: "custom_fk"
      })
    ])
    ```

  </Tab>
  <Tab>
    ```typescript copy {4-5,14-15,18-21}
    import { int, text, primaryKey, foreignKey, mysqlTable, AnyMySqlColumn } from "drizzle-orm/mysql-core";

    export const user = mysqlTable("user", {
      firstName: text("firstName"),
      lastName: text("lastName"),
    }, (table) => [
      primaryKey({ columns: [table.firstName, table.lastName]})
    ]);

    export const profile = mysqlTable("profile", {
      id: int("id").autoincrement().primaryKey(),
      userFirstName: text("user_first_name"),
      userLastName: text("user_last_name"),
    }, (table) => [
      foreignKey({
        columns: [table.userFirstName, table.userLastName],
        foreignColumns: [user.firstName, user.lastName],
        name: "custom_name"
      })
    ]);
    ```

  </Tab>
  <Tab>
    ```typescript {4-5,14-15,18-21}
    import { integer, text, primaryKey, foreignKey, sqliteTable, AnySQLiteColumn } from "drizzle-orm/sqlite-core";

    export const user = sqliteTable("user", {
      firstName: text("firstName"),
      lastName: text("lastName"),
    }, (table) => [
      primaryKey({ columns: [table.firstName, table.lastName]})
    ]);

    export const profile = sqliteTable("profile", {
      id: integer("id").primaryKey({ autoIncrement: true }),
      userFirstName: text("user_first_name"),
      userLastName: text("user_last_name"),
    }, (table) => [
      foreignKey({
        columns: [table.userFirstName, table.userLastName],
        foreignColumns: [user.firstName, user.lastName],
        name: "custom_name"
      })
    ]);
    ```

  </Tab>
  <Tab>
    å½“å‰åœ¨ SingleStore ä¸­ä¸æ”¯æŒ
  </Tab>
  <Tab>
    ```typescript copy {4-5,14-15,18-21}
    import { int, text, primaryKey, foreignKey, mssqlTable, AnyMsSqlColumn } from "drizzle-orm/mssql-core";

    export const user = mssqlTable("user", {
      firstName: text(),
      lastName: text(),
    }, (table) => [
      primaryKey({ columns: [table.firstName, table.lastName]})
    ]);

    export const profile = mssqlTable("profile", {
      id: int().primaryKey(),
      userFirstName: text("user_first_name"),
      userLastName: text("user_last_name"),
    }, (table) => [
      foreignKey({
        columns: [table.userFirstName, table.userLastName],
        foreignColumns: [user.firstName, user.lastName],
        name: "custom_name"
      })
    ]);
    ```

  </Tab>
    <Tab>
    ```typescript copy {4-5,14-15,18-21}
    import { int4, text, foreignKey, cockroachTable, AnyCockroachColumn } from "drizzle-orm/cockroach-core";

    export const user = cockroachTable("user", {
      firstName: text(),
      lastName: text(),
    }, (table) => [
      primaryKey({ columns: [table.firstName, table.lastName]})
    ]);

    export const profile = cockroachTable("profile", {
      id: int4().primaryKey(),
      userFirstName: text("user_first_name"),
      userLastName: text("user_last_name"),
    }, (table) => [
      foreignKey({
        columns: [table.userFirstName, table.userLastName],
        foreignColumns: [user.firstName, user.lastName],
        name: "custom_fk"
      })
    ])
    ```
  </Tab>
</Tabs>

## ç´¢å¼•

Drizzle ORM æä¾›äº† `index` å’Œ `unique index` å£°æ˜çš„ APIï¼š

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
    ```typescript copy {9-10}
    import { serial, text, index, uniqueIndex, pgTable } from "drizzle-orm/pg-core";

    export const user = pgTable("user", {
      id: serial("id").primaryKey(),
      name: text("name"),
      email: text("email"),
    }, (table) => [
      index("name_idx").on(table.name),
      uniqueIndex("email_idx").on(table.email)
    ]);
    ```
    ```sql {5-6}
    CREATE TABLE "user" (
      ...
    );

    CREATE INDEX "name_idx" ON "user" ("name");
    CREATE UNIQUE INDEX "email_idx" ON "user" ("email");
    ```
    </Section>
    <Callout type="warning" emoji="âš ï¸">
      å¯¹äº `drizzle-kit@0.22.0` å’Œ `drizzle-orm@0.31.0` ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ`drizzle-kit` ä»…æ”¯æŒç´¢å¼• `name` å’Œ `on()` å‚æ•°ã€‚

      åœ¨ `drizzle-kit@0.22.0` å’Œ `drizzle-orm@0.31.0` ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œ`drizzle-kit` æ”¯æŒæ‰€æœ‰å­—æ®µï¼
    </Callout>


    ä» 0.31.0 å¼€å§‹ï¼ŒDrizzle ORM çš„æ–°ç´¢å¼• API æä¾›äº†ç”¨äºç´¢å¼•åˆ›å»ºçš„æ‰€æœ‰å‚æ•°çš„é›†åˆï¼š

```ts
// ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä½¿ç”¨ `.on()`
index('name')
  .on(table.column1.asc(), table.column2.nullsFirst(), ...) æˆ– .onOnly(table.column1.desc().nullsLast(), table.column2, ...)
  .concurrently()
  .where(sql``)
  .with({ fillfactor: '70' })

// ç¬¬äºŒä¸ªä¾‹å­ï¼Œä½¿ç”¨ `.using()`
index('name')
  .using('btree', table.column1.asc(), sql`lower(${table.column2})`, table.column1.op('text_ops'))
  .where(sql``) // sql è¡¨è¾¾å¼
  .with({ fillfactor: '70' })
```

  </Tab>
  <Tab>
    <Section>
    ```typescript copy {9-10}
    import { int, text, index, uniqueIndex, mysqlTable } from "drizzle-orm/mysql-core";

    export const user = mysqlTable("user", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
      email: text("email"),
    }, (table) => [
      index("name_idx").on(table.name),
      uniqueIndex("email_idx").on(table.email),
    ]);
    ```
    ```sql {5-6}
    CREATE TABLE `user` (
      ...
    );

    CREATE INDEX `name_idx` ON `user` (`name`);
    CREATE UNIQUE INDEX `email_idx` ON `user` (`email`);
    ```
    </Section>
    <Callout type="warning" emoji="âš ï¸">
      æˆªè‡³ç›®å‰ï¼Œ`drizzle-kit` ä»…æ”¯æŒç´¢å¼• `name` å’Œ `on()` å‚æ•°ã€‚
    </Callout>

     Drizzle ORM æä¾›äº†ç”¨äºç´¢å¼•åˆ›å»ºçš„æ‰€æœ‰å‚æ•°é›†åˆï¼š

    ```typescript
    // ç´¢å¼•å£°æ˜å‚è€ƒ
    index("name")
      .on(table.name)
      .algorythm("default") // "default" | "copy" | "inplace"
      .using("btree") // "btree" | "hash"
      .lock("default") // "none" | "default" | "exclusive" | "shared"
    ```
  </Tab>
  <Tab>
    <Section>
    ```typescript {9-10}
    import { integer, text, index, uniqueIndex, sqliteTable } from "drizzle-orm/sqlite-core";

    export const user = sqliteTable("user", {
      id: integer("id").primaryKey({ autoIncrement: true }),
      name: text("name"),
      email: text("email"),
    }, (table) => [
      index("name_idx").on(table.name),
      uniqueIndex("email_idx").on(table.email),
    ]);
    ```
    ```sql {5-6}
    CREATE TABLE `user` (
      ...
    );

    CREATE INDEX `name_idx` ON `user` (`name`);
    CREATE UNIQUE INDEX `email_idx` ON `user` (`email`);
    ```
    </Section>

     Drizzle ORM æä¾›äº†ç”¨äºç´¢å¼•åˆ›å»ºçš„æ‰€æœ‰å‚æ•°é›†åˆï¼š
     
    ```typescript
    // ç´¢å¼•å£°æ˜å‚è€ƒ
    index("name")
      .on(table.name)
      .where(sql`...`)
    ```
  </Tab>
  <Tab>
    <Section>
    ```typescript copy {9-10}
    import { int, text, index, uniqueIndex, singlestoreTable } from "drizzle-orm/singlestore-core";

    export const user = singlestoreTable("user", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
      email: text("email"),
    }, (table) => [
      index("name_idx").on(table.name),
      uniqueIndex("email_idx").on(table.email),
    ]);
    ```
    ```sql {5-6}
    CREATE TABLE `user` (
      ...
    );

    CREATE INDEX `name_idx` ON `user` (`name`);
    CREATE UNIQUE INDEX `email_idx` ON `user` (`email`);
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```typescript copy {8-9}
    import { int, text, index, uniqueIndex, mssqlTable } from "drizzle-orm/mssql-core";

    export const user = mysqlTable("user", {
      id: int().primaryKey(),
      name: text(),
      email: text(),
    }, (table) => [
      index("name_idx").on(table.name),
      uniqueIndex("email_idx").on(table.email),
    ]);
    ```
    ```sql {5-6}
    CREATE TABLE [user] (
      ...
    );

    CREATE INDEX [name_idx] ON [user] ([name]);
    CREATE UNIQUE INDEX [email_idx] ON [user] ([email]);
    ```
    </Section>

    <Callout type='warning'>
    åœ¨ MSSQL ä¸­ï¼Œæ— æ³•å¯¹ `text`ã€`ntext`ã€`varchar(max)`ã€`nvarchar(max)` åˆ›å»ºå”¯ä¸€ç´¢å¼•
    </Callout>

    Drizzle ORM æä¾›ç´¢å¼•åˆ›å»ºçš„å‚æ•°é›†åˆï¼š

    ```typescript
    // ç´¢å¼•å£°æ˜å‚è€ƒ
    index("name")
      .on(table.name)
      .where(sql``)
    ```
  </Tab>
    <Tab>
    <Section>
    ```typescript copy {9-10}
    import { int4, text, index, uniqueIndex, cockroachTable } from "drizzle-orm/cockroach-core";

    export const user = cockroachTable("user", {
      id: int4().primaryKey(),
      name: text(),
      email: text(),
    }, (table) => [
      index("name_idx").on(table.name),
      uniqueIndex("email_idx").on(table.email)
    ]);
    ```
    ```sql {5-6}
    CREATE TABLE "user" (
      ...
    );

    CREATE INDEX "name_idx" ON "user" ("name");
    CREATE UNIQUE INDEX "email_idx" ON "user" ("email");
    ```
    </Section>
    ```ts
    // ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä½¿ç”¨ `.on()`
    index('name')
      .on(table.column1.asc(), table.column2) æˆ– .onOnly(table.column1.desc(), table.column2, ...)
      .where(sql``)

    // ç¬¬äºŒä¸ªä¾‹å­ï¼Œä½¿ç”¨ `.using()`
    index('name')
      .using('btree', table.column1.asc(), sql`lower(${table.column2})`)
      .where(sql``) // sql è¡¨è¾¾å¼
    ```
  </Tab>
</Tabs>

Source: https://drizzle.zhcndoc.com/docs/insert

import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';

# SQL æ’å…¥
Drizzle ORM ä¸ºæ‚¨æä¾›æœ€æ¥è¿‘ SQL çš„æ–¹å¼å°†è¡Œæ’å…¥æ•°æ®åº“è¡¨ä¸­ã€‚

æ’å…¥æ•°æ®ä½¿ç”¨ Drizzle æå…¶ç®€å•ä¸”ç±»ä¼¼ SQLã€‚æ‚¨è‡ªå·±çœ‹ï¼š

<Section>
```typescript copy 
await db.insert(users).values({ name: 'Andrew' });
```
```sql
insert into "users" ("name") values ("Andrew");
```
</Section>

å¦‚æœæ‚¨éœ€è¦æŸä¸ªç‰¹å®šè¡¨çš„æ’å…¥ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ `typeof usersTable.$inferInsert` è¯­æ³•ã€‚
```typescript copy 
type NewUser = typeof users.$inferInsert;

const insertUser = async (user: NewUser) => {
  return db.insert(users).values(user);
}

const newUser: NewUser = { name: "Alef" };
await insertUser(newUser);
```

## returning
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': true }} />
æ‚¨å¯ä»¥åœ¨ PostgreSQL å’Œ SQLite ä¸­æ’å…¥ä¸€è¡Œå¹¶è·å¾—è¿”å›ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```typescript copy
await db.insert(users).values({ name: "Dan" }).returning();

// éƒ¨åˆ†è¿”å›
await db.insert(users).values({ name: "Partial Dan" }).returning({ insertedId: users.id });
```

## $returningId
<IsSupportedChipGroup chips={{ 'PostgreSQL': false, 'SQLite': false, 'MySQL': true, 'SingleStore': true, 'MSSQL': false, 'CockroachDB': false }} />

MySQL æœ¬èº«å¹¶ä¸åŸç”Ÿæ”¯æŒ `INSERT` åä½¿ç”¨ `RETURNING`ã€‚å¯¹äº `è‡ªå¢`ï¼ˆæˆ– `åºåˆ—`ï¼‰ç±»å‹çš„ `ä¸»é”®`ï¼Œåªæœ‰ä¸€ç§æ–¹å¼å¯ä»¥åšåˆ°ï¼Œæ‚¨å¯ä»¥è®¿é—® `insertId` å’Œ `affectedRows` å­—æ®µã€‚æˆ‘ä»¬ä¸ºæ‚¨å‡†å¤‡äº†ä¸€ç§è‡ªåŠ¨å¤„ç†æ­¤ç±»æƒ…å†µçš„æ–¹æ³•ï¼Œä½¿ç”¨ Drizzle è‡ªåŠ¨æ¥æ”¶æ‰€æœ‰æ’å…¥çš„ ID ä½œä¸ºç‹¬ç«‹å¯¹è±¡ã€‚

```ts
import { boolean, int, text, mysqlTable } from 'drizzle-orm/mysql-core';

const usersTable = mysqlTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
  verified: boolean('verified').notNull().default(false),
});


const result = await db.insert(usersTable).values([{ name: 'John' }, { name: 'John1' }]).$returningId();
//    ^? { id: number }[]
```

ä½¿ç”¨ Drizzleï¼Œæ‚¨è¿˜å¯ä»¥æŒ‡å®šä¸€ä¸ªä½¿ç”¨ `$default` å‡½æ•°çš„ `ä¸»é”®`ï¼Œè¯¥å‡½æ•°å°†åœ¨è¿è¡Œæ—¶ç”Ÿæˆè‡ªå®šä¹‰ä¸»é”®ã€‚æˆ‘ä»¬ä¹Ÿå°†åœ¨ `$returningId()` è°ƒç”¨ä¸­è¿”å›è¿™äº›ç”Ÿæˆçš„é”®ã€‚

```ts
import { varchar, text, mysqlTable } from 'drizzle-orm/mysql-core';
import { createId } from '@paralleldrive/cuid2';

const usersTableDefFn = mysqlTable('users_default_fn', {
  customId: varchar('id', { length: 256 }).primaryKey().$defaultFn(createId),
  name: text('name').notNull(),
});


const result = await db.insert(usersTableDefFn).values([{ name: 'John' }, { name: 'John1' }]).$returningId();
//  ^? { customId: string }[]
```

> å¦‚æœæ²¡æœ‰ä¸»é”® -> è¿™ç§æŸ¥è¯¢çš„ç±»å‹å°†æ˜¯ `{}[]`

## output
<IsSupportedChipGroup chips={{ 'MSSQL': true }} />
æ‚¨å¯ä»¥åœ¨ PostgreSQL å’Œ SQLite ä¸­æ’å…¥ä¸€è¡Œå¹¶è·å¾—è¿”å›ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```typescript copy
await db.insert(users).values({ name: "Dan" }).output();

// éƒ¨åˆ†è¿”å›
await db.insert(users).values({ name: "Partial Dan" }).output({ insertedId: users.id });
```

## æ’å…¥å¤šè¡Œ
```typescript copy
await db.insert(users).values([{ name: 'Andrew' }, { name: 'Dan' }]);
```

## æ’å…¥æˆ–æ›´æ–°åŠå†²çªå¤„ç†
Drizzle ORM æä¾›äº†ç®€å•çš„æ¥å£æ¥å¤„ç†æ’å…¥æˆ–æ›´æ–°ä»¥åŠå†²çªã€‚

### å†²çªæ—¶ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': false, 'SingleStore': false, 'CockroachDB': true }} />

`onConflictDoNothing` ä¼šåœ¨å‘ç”Ÿå†²çªæ—¶å–æ¶ˆæ’å…¥ï¼š

```typescript copy
await db.insert(users)
  .values({ id: 1, name: 'John' })
  .onConflictDoNothing();

// æ˜¾å¼æŒ‡å®šå†²çªç›®æ ‡
await db.insert(users)
  .values({ id: 1, name: 'John' })
  .onConflictDoNothing({ target: users.id });
```

### å†²çªæ—¶è¿›è¡Œæ›´æ–°

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': false }} />

`onConflictDoUpdate` ä¼šåœ¨å‘ç”Ÿå†²çªæ—¶æ›´æ–°è¯¥è¡Œï¼š
```typescript
await db.insert(users)
  .values({ id: 1, name: 'Dan' })
  .onConflictDoUpdate({ target: users.id, set: { name: 'John' } });
```

#### `where` å­å¥

`å†²çªæ—¶æ›´æ–°` å¯ä»¥åœ¨ä¸¤ä¸ªä¸åŒä½ç½®ä½¿ç”¨ `where` å­å¥ â€”â€”  
ä½œä¸ºå†²çªç›®æ ‡çš„ä¸€éƒ¨åˆ†ï¼ˆå³ç”¨äºéƒ¨åˆ†ç´¢å¼•ï¼‰æˆ–ä½œä¸º `æ›´æ–°` å­å¥çš„ä¸€éƒ¨åˆ†ï¼š

```sql
insert into employees (employee_id, name)
values (123, 'John Doe')
on conflict (employee_id) where name <> 'John Doe'
do update set name = excluded.name

insert into employees (employee_id, name)
values (123, 'John Doe')
on conflict (employee_id) do update set name = excluded.name
where name <> 'John Doe';
```

è¦åœ¨ Drizzle ä¸­æŒ‡å®šè¿™äº›æ¡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `setWhere` å’Œ `targetWhere` å­å¥ï¼š

```typescript
await db.insert(employees)
  .values({ employeeId: 123, name: 'John Doe' })
  .onConflictDoUpdate({
    target: employees.employeeId,
    targetWhere: sql`name <> 'John Doe'`,
    set: { name: sql`excluded.name` }
  });

await db.insert(employees)
  .values({ employeeId: 123, name: 'John Doe' })
  .onConflictDoUpdate({
    target: employees.employeeId,
    set: { name: 'John Doe' },
    setWhere: sql`name <> 'John Doe'`
  });
```

<hr />

ä½¿ç”¨å¤åˆç´¢å¼•æˆ–å¤åˆä¸»é”®è¿›è¡Œæ’å…¥æˆ–æ›´æ–°åŠå†²çªå¤„ç†ï¼š

```typescript
await db.insert(users)
  .values({ firstName: 'John', lastName: 'Doe' })
  .onConflictDoUpdate({
    target: [users.firstName, users.lastName],
    set: { firstName: 'John1' }
  });
```

### ä¸»é”®é‡å¤æ—¶æ›´æ–°
<IsSupportedChipGroup chips={{ 'PostgreSQL': false, 'SQLite': false, 'MySQL': true, 'SingleStore': true, 'CockroachDB': false }} />

MySQL æ”¯æŒ [`ON DUPLICATE KEY UPDATE`](https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html) ä»£æ›¿ `ON CONFLICT` å­å¥ã€‚MySQL ä¼šæ ¹æ®ä¸»é”®å’Œå”¯ä¸€ç´¢å¼•è‡ªåŠ¨ç¡®å®šå†²çªç›®æ ‡ï¼Œå¦‚æœ *ä»»ä½•* å”¯ä¸€ç´¢å¼•å†²çªï¼Œå°†æ›´æ–°è¯¥è¡Œã€‚

Drizzle é€šè¿‡ `onDuplicateKeyUpdate` æ–¹æ³•æ”¯æŒè¿™ä¸€ç‚¹ï¼š

```typescript
// æ³¨æ„ï¼ŒMySQL è‡ªåŠ¨æ ¹æ®ä¸»é”®å’Œå”¯ä¸€ç´¢å¼•ç¡®å®šç›®æ ‡
await db.insert(users)
  .values({ id: 1, name: 'John' })
  .onDuplicateKeyUpdate({ set: { name: 'John' } });
```

è™½ç„¶ MySQL ä¸ç›´æ¥æ”¯æŒå†²çªæ—¶ä»€ä¹ˆéƒ½ä¸åšï¼Œæ‚¨å¯ä»¥é€šè¿‡å°†ä»»æ„åˆ—çš„å€¼è®¾ç½®ä¸ºè‡ªèº«æ¥æ‰§è¡Œæ— æ“ä½œï¼Œä»è€Œè¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼š

```typescript
import { sql } from 'drizzle-orm';

await db.insert(users)
  .values({ id: 1, name: 'John' })
  .onDuplicateKeyUpdate({ set: { id: sql`id` } });
```

## `with insert` å­å¥

<Callout>
  æŸ¥çœ‹å¦‚ä½•ä½¿ç”¨ WITH è¯­å¥ä¸ [select](/docs/select#with-clause)ã€[update](/docs/update#with-update-clause)ã€[delete](/docs/delete#with-delete-clause)
</Callout>

ä½¿ç”¨ `with` å­å¥å¯ä»¥å¸®åŠ©æ‚¨é€šè¿‡å°†å¤æ‚æŸ¥è¯¢æ‹†åˆ†ä¸ºç§°ä¸ºå…¬å…±è¡¨è¡¨è¾¾å¼ (CTEs) çš„è¾ƒå°å­æŸ¥è¯¢æ¥ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼š
<Section>
```typescript copy
const userCount = db.$with('user_count').as(
	db.select({ value: sql`count(*)`.as('value') }).from(users)
);

const result = await db.with(userCount)
	.insert(users)
	.values([
		{ username: 'user1', admin: sql`((select * from ${userCount}) = 0)` }
	])
	.returning({
		admin: users.admin
	});
```
```sql
with "user_count" as (select count(*) as "value" from "users") 
insert into "users" ("username", "admin") 
values ($1, ((select * from "user_count") = 0)) 
returning "admin"
```
</Section>


## Insert into ... select

æ­£å¦‚ SQLite æ–‡æ¡£æ‰€è¿°ï¼š

<Callout>
INSERT è¯­å¥çš„ç¬¬äºŒç§å½¢å¼åŒ…å«ä¸€ä¸ª SELECT è¯­å¥ä»£æ›¿ VALUES å­å¥ã€‚  
é€šè¿‡æ‰§è¡Œ SELECT è¯­å¥è¿”å›çš„æ¯ä¸€è¡Œæ•°æ®éƒ½ä¼šæ’å…¥è¡¨ä¸­ä¸€ä¸ªæ–°æ¡ç›®ã€‚  
å¦‚æœæŒ‡å®šäº†åˆ—åˆ—è¡¨ï¼ŒSELECT ç»“æœä¸­çš„åˆ—æ•°å¿…é¡»ä¸åˆ—åˆ—è¡¨ä¸­çš„é¡¹ç›®æ•°ç›¸åŒã€‚  
å¦åˆ™ï¼Œå¦‚æœæœªæŒ‡å®šåˆ—åˆ—è¡¨ï¼ŒSELECT ç»“æœä¸­çš„åˆ—æ•°å¿…é¡»ä¸è¡¨ä¸­çš„åˆ—æ•°ç›¸åŒã€‚  
ä»»ä½• SELECT è¯­å¥ï¼ŒåŒ…æ‹¬è”åˆ SELECT åŠåŒ…å« ORDER BY å’Œ/æˆ– LIMIT å­å¥çš„ SELECTï¼Œéƒ½å¯ç”¨äºæ­¤å½¢å¼çš„ INSERT è¯­å¥ä¸­ã€‚
</Callout>
<Callout type='warning'>
ä¸ºé¿å…è§£ææ­§ä¹‰ï¼Œå¦‚æœå­˜åœ¨ upsert å­å¥ï¼ŒSELECT è¯­å¥åº”å§‹ç»ˆåŒ…å« WHERE å­å¥ï¼Œå³ä½¿è¯¥å­å¥åªå«â€œWHERE trueâ€ã€‚  
å¦åˆ™ï¼Œè§£æå™¨æ— æ³•ç¡®å®šâ€œONâ€æ˜¯ SELECT ä¸­è¿æ¥æ¡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜æ˜¯ upsert å­å¥çš„å¼€å§‹ã€‚
</Callout>

æ­£å¦‚ PostgreSQL æ–‡æ¡£æ‰€è¿°ï¼š
<Callout>
ä¸€ä¸ªæŸ¥è¯¢ï¼ˆSELECT è¯­å¥ï¼‰æä¾›è¦æ’å…¥çš„è¡Œ
</Callout>

æ­£å¦‚ MySQL æ–‡æ¡£æ‰€è¿°ï¼š

<Callout>
é€šè¿‡ INSERT ... SELECTï¼Œæ‚¨å¯ä»¥å¿«é€Ÿåœ°ä» SELECT è¯­å¥çš„ç»“æœå‘è¡¨ä¸­æ’å…¥å¤šè¡Œï¼Œè¯¥ SELECT è¯­å¥å¯ä»¥ä»ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨ä¸­é€‰æ‹©æ•°æ®
</Callout>

Drizzle æ”¯æŒæ‰€æœ‰æ•°æ®åº“æ–¹è¨€å½“å‰çš„è¯­æ³•ï¼Œä¸”å®ƒä»¬å…±äº«ç›¸åŒçš„è¯­æ³•ã€‚  
è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›å¸¸è§çš„åœºæ™¯å’Œ API ç”¨æ³•ã€‚  
åœ¨ insert è¯­å¥ä¸­ä½¿ç”¨ select æœ‰å¤šç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„æ–¹å¼ï¼š

- æ‚¨å¯ä»¥åœ¨ select å‡½æ•°ä¸­ä¼ å…¥æŸ¥è¯¢æ„å»ºå™¨ã€‚
- æ‚¨å¯ä»¥åœ¨å›è°ƒä¸­ä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨ã€‚
- æ‚¨å¯ä»¥ä¼ å…¥ä¸€ä¸ªå¸¦æœ‰ä»»æ„è‡ªå®šä¹‰ select æŸ¥è¯¢çš„ SQL æ¨¡æ¿æ ‡ç­¾ã€‚

<Tabs items={["Query Builder", "Callback", "SQL template tag"]}>
<Tab>
<Section>
```ts
const insertedEmployees = await db
  .insert(employees)
  .select(
    db.select({ name: users.name }).from(users).where(eq(users.role, 'employee'))
  )
  .returning({
    id: employees.id,
    name: employees.name
  });
```
```ts
const qb = new QueryBuilder();
await db.insert(employees).select(
    qb.select({ name: users.name }).from(users).where(eq(users.role, 'employee'))
);
```
</Section>
</Tab>
<Tab>
<Section>
```ts
await db.insert(employees).select(
    () => db.select({ name: users.name }).from(users).where(eq(users.role, 'employee'))
);
```
```ts
await db.insert(employees).select(
    (qb) => qb.select({ name: users.name }).from(users).where(eq(users.role, 'employee'))
);
```
</Section>
</Tab>
<Tab>
<Section>
```ts
await db.insert(employees).select(
    sql`select "users"."name" as "name" from "users" where "users"."role" = 'employee'`
);
```
```ts
await db.insert(employees).select(
    () => sql`select "users"."name" as "name" from "users" where "users"."role" = 'employee'`
);
```
</Section>
</Tab>
</Tabs>


Source: https://drizzle.zhcndoc.com/docs/joins

import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from '@mdx/Section.astro';

# è”æ¥ [SQL]
SQLä¸­çš„è”æ¥å­å¥ç”¨äºåŸºäºä¸¤ä¸ªæˆ–å¤šä¸ªè¡¨ä¹‹é—´çš„ç›¸å…³åˆ—ç»„åˆå®ƒä»¬ã€‚
Drizzle ORM çš„è”æ¥è¯­æ³•åœ¨ SQL è¯­æ³•å’Œç±»å‹å®‰å…¨ä¹‹é—´è¾¾æˆäº†å¹³è¡¡ã€‚

## è”æ¥ç±»å‹
Drizzle ORM æä¾›äº† `INNER JOIN [LATERAL]`ã€`FULL JOIN`ã€`LEFT JOIN [LATERAL]`ã€`RIGHT JOIN`ã€`CROSS JOIN [LATERAL]` çš„ APIã€‚
è®©æˆ‘ä»¬å¿«é€Ÿçœ‹ä¸€ä¸‹åŸºäºä¸‹é¢è¡¨æ¨¡å¼çš„ç¤ºä¾‹ï¼š
```typescript copy
export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
});

export const pets = pgTable('pets', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  ownerId: integer('owner_id').notNull().references(() => users.id),
})
```

### å·¦è”æ¥
<Section>
```typescript copy
const result = await db.select().from(users).leftJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select ... from "users" left join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    };
    pets: {
        id: number;
        name: string;
        ownerId: number;
    } | null;
}[];
```
</Section>

### å·¦è”æ¥ Lateral
<Section>
```typescript copy
const subquery = db.select().from(pets).where(gte(users.age, 16)).as('userPets')
const result = await db.select().from(users).leftJoinLateral(subquery, sql`true`)
```
```sql
select ... from "users" left join lateral (select ... from "pets" where "users"."age" >= 16) "userPets" on true
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    };
    userPets: {
        id: number;
        name: string;
        ownerId: number;
    } | null;
}[];
```
</Section>

### å³è”æ¥
<Section>
```typescript copy
const result = await db.select().from(users).rightJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select ... from "users" right join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    } | null;
    pets: {
        id: number;
        name: string;
        ownerId: number;
    };
}[];
```
</Section>

### å†…è”æ¥
<Section>
```typescript copy
const result = await db.select().from(users).innerJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select ... from "users" inner join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    };
    pets: {
        id: number;
        name: string;
        ownerId: number;
    };
}[];
```
</Section>

### å†…è”æ¥ Lateral
<Section>
```typescript copy
const subquery = db.select().from(pets).where(gte(users.age, 16)).as('userPets')
const result = await db.select().from(users).innerJoinLateral(subquery, sql`true`)
```
```sql
select ... from "users" inner join lateral (select ... from "pets" where "users"."age" >= 16) "userPets" on true
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    };
    userPets: {
        id: number;
        name: string;
        ownerId: number;
    };
}[];
```
</Section>

### å…¨è”æ¥
<Section>
```typescript copy
const result = await db.select().from(users).fullJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select ... from "users" full join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    } | null;
    pets: {
        id: number;
        name: string;
        ownerId: number;
    } | null;
}[];
```
</Section>

### äº¤å‰è”æ¥
<Section>
```typescript copy
const result = await db.select().from(users).crossJoin(pets)
```
```sql
select ... from "users" cross join "pets"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    };
    pets: {
        id: number;
        name: string;
        ownerId: number;
    };
}[];
```
</Section>

### äº¤å‰è”æ¥ Lateral
<Section>
```typescript copy
const subquery = db.select().from(pets).where(gte(users.age, 16)).as('userPets')
const result = await db.select().from(users).crossJoinLateral(subquery)
```
```sql
select ... from "users" cross join lateral (select ... from "pets" where "users"."age" >= 16) "userPets"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
    };
    userPets: {
        id: number;
        name: string;
        ownerId: number;
    };
}[];
```
</Section>

## éƒ¨åˆ†é€‰æ‹©
å¦‚æœæ‚¨éœ€è¦é€‰æ‹©ç‰¹å®šå­—æ®µçš„å­é›†æˆ–å¸Œæœ›æœ‰ä¸€ä¸ªå¹³å¦çš„å“åº”ç±»å‹ï¼ŒDrizzle ORM
æ”¯æŒå¸¦æœ‰éƒ¨åˆ†é€‰æ‹©çš„è”æ¥ï¼Œå¹¶ä¼šæ ¹æ® `.select({ ... })` ç»“æ„è‡ªåŠ¨æ¨æ–­è¿”å›ç±»å‹ã€‚
<Section>
```typescript copy
await db.select({
  userId: users.id,
  petId: pets.id,
}).from(user).leftJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select "users"."id", "pets"."id" from "users" left join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
  userId: number;
  petId: number | null;
}[];
```
</Section>
æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ° `petId` ç°åœ¨å¯ä»¥ä¸º nullï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å·¦è”æ¥ï¼Œå¹¶ä¸”å¯èƒ½æœ‰æ²¡æœ‰å® ç‰©çš„ç”¨æˆ·ã€‚

åœ¨ä½¿ç”¨ `sql` æ“ä½œç¬¦è¿›è¡Œéƒ¨åˆ†é€‰æ‹©å­—æ®µå’Œèšåˆæ—¶ï¼Œè®°å¾—è¦ä½¿ç”¨ `sql<type | null>` ä»¥ä¾¿æ­£ç¡®æ¨æ–­ç»“æœç±»å‹ï¼Œè¿™å–å†³äºä½ è‡ªå·±ï¼
<Section>
```typescript copy
const result = await db.select({
  userId: users.id,
  petId: pets.id,
  petName1: sql`upper(${pets.name})`,
  petName2: sql<string | null>`upper(${pets.name})`,
  //Ë„æˆ‘ä»¬åº”è¯¥åœ¨ç±»å‹ä¸­æ˜ç¡®å‘Šè¯‰' å­—ç¬¦ä¸² | null'ï¼Œå› ä¸ºæˆ‘ä»¬å·¦è”æ¥äº†è¯¥å­—æ®µ
}).from(user).leftJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select "users"."id", "pets"."id", upper("pets"."name")... from "users" left join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
  userId: number;
  petId: number | null;
  petName1: unknown;
  petName2: string | null;
}[];
```
</Section>
ä¸ºäº†é¿å…åœ¨è”æ¥å¸¦æœ‰å¤§é‡åˆ—çš„è¡¨æ—¶å‡ºç°å¤šä¸ªå¯ä¸º null çš„å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æˆ‘ä»¬çš„ **åµŒå¥—é€‰æ‹©å¯¹è±¡è¯­æ³•**ï¼Œ
æˆ‘ä»¬çš„æ™ºèƒ½ç±»å‹æ¨æ–­å°†ä½¿æ•´ä¸ªå¯¹è±¡å˜ä¸ºå¯ä¸º nullï¼Œè€Œä¸æ˜¯ä½¿æ‰€æœ‰è¡¨å­—æ®µå¯ä¸º nullï¼
<Section>
```typescript copy
await db.select({
  userId: users.id,
  userName: users.name,
  pet: {
    id: pets.id,
    name: pets.name,
    upperName: sql<string>`upper(${pets.name})`
  }
}).from(user).fullJoin(pets, eq(users.id, pets.ownerId))
```
```sql
select ... from "users" full join "pets" on "users"."id" = "pets"."owner_id"
```
```typescript
// result type
const result: {
    userId: number | null;
    userName: string | null;
    pet: {
        id: number;
        name: string;
        upperName: string;
    } | null;
}[];
```
</Section>

## åˆ«åä¸è‡ªè¿æ¥
Drizzle ORM æ”¯æŒè¡¨åˆ«åï¼Œå½“æ‚¨éœ€è¦è¿›è¡Œè‡ªè¿æ¥æ—¶éå¸¸æ–¹ä¾¿ã€‚

å‡è®¾æ‚¨éœ€è¦è·å–ç”¨æˆ·åŠå…¶çˆ¶æ¯ï¼š
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```typescript copy
import { user } from "./schema";

const parent = alias(user, "parent");
const result = db
  .select()
  .from(user)
  .leftJoin(parent, eq(parent.id, user.parentId));
```
```sql
select ... from "user" left join "user" "parent" on "parent"."id" = "user"."parent_id"
```
```typescript
// result type
const result: {
    user: {
        id: number;
        name: string;
        parentId: number;
    };
    parent: {
        id: number;
        name: string;
        parentId: number;
    } | null;
}[];
```
</CodeTab>

```typescript
export const user = pgTable("user", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  parentId: integer("parent_id").notNull().references((): AnyPgColumn => user.id)
});
```

</CodeTabs>

## èšåˆç»“æœ
Drizzle ORM ä»é©±åŠ¨ç¨‹åºæä¾›åç§°æ˜ å°„çš„ç»“æœï¼Œè€Œä¸æ”¹å˜ç»“æ„ã€‚

æ‚¨å¯ä»¥è‡ªç”±åœ°æŒ‰æ‚¨æƒ³è¦çš„æ–¹å¼å¤„ç†ç»“æœï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜ å°„å¤šå¯¹ä¸€å…³ç³»æ•°æ®çš„ç¤ºä¾‹ï¼š
```typescript
type User = typeof users.$inferSelect;
type Pet = typeof pets.$inferSelect;

const rows = db.select({
    user: users,
    pet: pets,
  }).from(users).leftJoin(pets, eq(users.id, pets.ownerId)).all();

const result = rows.reduce<Record<number, { user: User; pets: Pet[] }>>(
  (acc, row) => {
    const user = row.user;
    const pet = row.pet;

    if (!acc[user.id]) {
      acc[user.id] = { user, pets: [] };
    }

    if (pet) {
      acc[user.id].pets.push(pet);
    }

    return acc;
  },
  {}
);

// result type
const result: Record<number, {
    user: User;
    pets: Pet[];
}>;
```

## å¤šå¯¹ä¸€ç¤ºä¾‹
```typescript
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
import { drizzle } from 'drizzle-orm/better-sqlite3';

const cities = sqliteTable('cities', {
  id: integer('id').primaryKey(),
  name: text('name'),
});

const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  name: text('name'),
  cityId: integer('city_id').references(() => cities.id)
});

const db = drizzle();

const result = db.select().from(cities).leftJoin(users, eq(cities.id, users.cityId)).all();
```
## å¤šå¯¹å¤šç¤ºä¾‹
```typescript
const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  name: text('name'),
});

const chatGroups = sqliteTable('chat_groups', {
  id: integer('id').primaryKey(),
  name: text('name'),
});

const usersToChatGroups = sqliteTable('usersToChatGroups', {
  userId: integer('user_id').notNull().references(() => users.id),
  groupId: integer('group_id').notNull().references(() => chatGroups.id),
});


// æŸ¥è¯¢ ID ä¸º 1 çš„ç”¨æˆ·ç»„åŠæ‰€æœ‰å‚ä¸è€…ï¼ˆç”¨æˆ·ï¼‰
db.select()
  .from(usersToChatGroups)
  .leftJoin(users, eq(usersToChatGroups.userId, users.id))
  .leftJoin(chatGroups, eq(usersToChatGroups.groupId, chatGroups.id))
  .where(eq(chatGroups.id, 1))
  .all();

Source: https://drizzle.zhcndoc.com/docs/kit-custom-migrations

import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Section from '@mdx/Section.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Steps from '@mdx/Steps.astro';
import Prerequisites from "@mdx/Prerequisites.astro"

# ä½¿ç”¨ Drizzle Kit çš„è¿ç§»
<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [é˜…è¯»è¿™é‡Œ](/docs/get-started)
- Drizzle schema åŸºç¡€çŸ¥è¯† - [é˜…è¯»è¿™é‡Œ](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [é˜…è¯»è¿™é‡Œ](/docs/migrations)
- Drizzle Kit [æ¦‚è¿°](/docs/kit-overview) å’Œ [é…ç½®æ–‡ä»¶](/docs/drizzle-config-file)
- `drizzle-kit generate` å‘½ä»¤ - [é˜…è¯»è¿™é‡Œ](/docs/drizzle-kit-generate)
- `drizzle-kit migrate` å‘½ä»¤ - [é˜…è¯»è¿™é‡Œ](/docs/drizzle-kit-migrate)
</Prerequisites>

Drizzle å…è®¸ä½ ç”Ÿæˆç©ºçš„è¿ç§»æ–‡ä»¶ï¼Œä»¥ç¼–å†™è‡ªå®šä¹‰çš„ SQL è¿ç§»ï¼Œ
ç”¨äºç›®å‰ä¸æ”¯æŒçš„ DDL ä¿®æ”¹æˆ–æ•°æ®é¢„å¡«å……ï¼Œä½ å¯ä»¥ä½¿ç”¨ [`drizzle-kit migrate`](/docs/drizzle-kit-migrate) å‘½ä»¤æ¥è¿è¡Œè¿™äº›è¿ç§»ã€‚

```shell
drizzle-kit generate --custom --name=seed-users
```
<Section>
```plaintext {5}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”‚ â”œ ğŸ“‚ 20242409125510_init_sql
 â”‚ â”” ğŸ“‚ 20242409135510_delicate_seed-users
 â”œ ğŸ“‚ src
 â”” â€¦
```
```sql
-- ./drizzle/0001_seed-users.sql

INSERT INTO "users" ("name") VALUES('Dan');
INSERT INTO "users" ("name") VALUES('Andrew');
INSERT INTO "users" ("name") VALUES('Dandrew');
```
</Section>

### è¿è¡Œ JavaScript å’Œ TypeScript è¿ç§»
æˆ‘ä»¬å°†åœ¨å³å°†å‘å¸ƒçš„ç‰ˆæœ¬ä¸­æ·»åŠ è¿è¡Œè‡ªå®šä¹‰ JavaScript å’Œ TypeScript è¿ç§»/å¡«å……è„šæœ¬çš„èƒ½åŠ›ï¼Œä½ å¯ä»¥å…³æ³¨ [GitHub è®¨è®º](https://github.com/drizzle-team/drizzle-orm/discussions/2832)ã€‚

Source: https://drizzle.zhcndoc.com/docs/kit-migrations-for-teams

# Drizzle å›¢é˜Ÿçš„è¿ç§»

æ­¤éƒ¨åˆ†å°†åœ¨æˆ‘ä»¬å‘å¸ƒä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„è¿ç§»æ–‡ä»¶å¤¹ç»“æ„åæ›´æ–°ã€‚
æ‚¨å¯ä»¥é˜…è¯»æ‰©å±•çš„ [github è®¨è®º](https://github.com/drizzle-team/drizzle-orm/discussions/2832) å¹¶è®¢é˜…æ›´æ–°ï¼


Source: https://drizzle.zhcndoc.com/docs/kit-overview

import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Section from '@mdx/Section.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Steps from '@mdx/Steps.astro';
import Prerequisites from "@mdx/Prerequisites.astro"

# ä½¿ç”¨ Drizzle Kit è¿›è¡Œè¿ç§»
<Prerequisites>
- å¼€å§‹ä½¿ç”¨ Drizzle å’Œ `drizzle-kit` - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/get-started)
- Drizzle æ¶æ„åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/sql-schema-declaration)
- æ•°æ®åº“è¿æ¥åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/connect-overview)
- Drizzle è¿ç§»åŸºç¡€ - [ç‚¹å‡»è¿™é‡Œé˜…è¯»](/docs/migrations)
</Prerequisites>


**Drizzle Kit** æ˜¯ä¸€ä¸ªç”¨äºç®¡ç† SQL æ•°æ®åº“è¿ç§»çš„ CLI å·¥å…·ã€‚
<Npm>
  -D drizzle-kit
</Npm>
<Callout type="warning">
ç¡®ä¿é¦–å…ˆé˜…è¯» Drizzle çš„ [å…¥é—¨æŒ‡å—](/docs/get-started) å’Œ [è¿ç§»åŸºç¡€](/docs/migrations)ï¼Œå¹¶é€‰æ‹©æœ€é€‚åˆæ‚¨ä¸šåŠ¡éœ€æ±‚çš„ SQL è¿ç§»æµç¨‹ã€‚
</Callout>

æ ¹æ®æ‚¨çš„æ¶æ„ï¼ŒDrizzle Kit è®©æ‚¨ç”Ÿæˆå’Œè¿è¡Œ SQL è¿ç§»æ–‡ä»¶ï¼Œ
ç›´æ¥å°†æ¶æ„æ¨é€åˆ°æ•°æ®åº“ï¼Œä»æ•°æ®åº“ä¸­æå–æ¶æ„ï¼Œå¯åŠ¨ Drizzle Studioï¼Œå¹¶å…·æœ‰ä¸€äº›å®ç”¨å‘½ä»¤ã€‚
<Npx>
drizzle-kit generate
drizzle-kit migrate
drizzle-kit push
drizzle-kit pull
drizzle-kit check
drizzle-kit up
drizzle-kit studio
</Npx>


|                                                      |                                                                                                                                                                    |
| :--------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [`drizzle-kit generate`](/docs/drizzle-kit-generate) | è®©æ‚¨æ ¹æ® Drizzle æ¶æ„ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶ï¼Œæ— è®ºæ˜¯å£°æ˜æ—¶è¿˜æ˜¯åç»­æ›´æ”¹æ—¶ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-generate)ã€‚       |
| [`drizzle-kit migrate`](/docs/drizzle-kit-migrate)   | è®©æ‚¨å°†ç”Ÿæˆçš„ SQL è¿ç§»æ–‡ä»¶åº”ç”¨åˆ°æ‚¨çš„æ•°æ®åº“ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-migrate)ã€‚                                                              |
| [`drizzle-kit pull`](/docs/drizzle-kit-pull)         | è®©æ‚¨æå–ï¼ˆå†…çœï¼‰æ•°æ®åº“æ¶æ„ï¼Œå°†å…¶è½¬æ¢ä¸º Drizzle æ¶æ„å¹¶ä¿å­˜åœ¨æ‚¨çš„ä»£ç åº“ä¸­ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-pull)ã€‚                           |
| [`drizzle-kit push`](/docs/drizzle-kit-push)         | è®©æ‚¨åœ¨å£°æ˜æˆ–åç»­æ¶æ„æ›´æ”¹æ—¶å°† Drizzle æ¶æ„æ¨é€åˆ°æ•°æ®åº“ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-push)ã€‚                          |
| [`drizzle-kit studio`](/docs/drizzle-kit-studio)     | å°†è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“å¹¶ä¸º Drizzle Studio å¯åŠ¨ä»£ç†æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ–¹ä¾¿åœ°æµè§ˆæ•°æ®åº“ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-studio)ã€‚ |
| [`drizzle-kit check`](/docs/drizzle-kit-check)       | å°†éå†æ‰€æœ‰ç”Ÿæˆçš„è¿ç§»å¹¶æ£€æŸ¥ç”Ÿæˆçš„è¿ç§»æ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶ï¼ˆå†²çªï¼‰ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-check)ã€‚               |
| [`drizzle-kit up`](/docs/drizzle-kit-up)             | ç”¨äºå‡çº§ä¹‹å‰ç”Ÿæˆçš„è¿ç§»å¿«ç…§ï¼Œ[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹](/docs/drizzle-kit-up)                                                                     |
<br/>

Drizzle Kit é€šè¿‡ [drizzle.config.ts](/docs/drizzle-config-file) é…ç½®æ–‡ä»¶æˆ– CLI å‚æ•°è¿›è¡Œé…ç½®ã€‚<br/>
è‡³å°‘éœ€è¦æä¾› SQL `dialect` å’Œ `schema` è·¯å¾„ï¼Œä»¥ä¾¿ Drizzle Kit çŸ¥é“å¦‚ä½•ç”Ÿæˆè¿ç§»ã€‚
```
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts  <--- Drizzle é…ç½®æ–‡ä»¶
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

<CodeTabs items={["ç®€å•é…ç½®", "æ‰©å±•é…ç½®"]}>
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
});
```
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  out: "./drizzle",
  dialect: "postgresql",
  schema: "./src/schema.ts",

  driver: "pglite",
  dbCredentials: {
    url: "./database/",
  },

  extensionsFilters: ["postgis"],
  schemaFilter: "public",
  tablesFilter: "*",

  introspect: {
    casing: "camel",
  },

  migrations: {
    prefix: "timestamp",
    table: "__drizzle_migrations__",
    schema: "public",
  },

  breakpoints: true,
  strict: true,
  verbose: true,
});
```
</CodeTabs>

æ‚¨å¯ä»¥é€šè¿‡ CLI å‚æ•°æä¾› Drizzle Kit é…ç½®è·¯å¾„ï¼Œè¿™åœ¨æ‚¨æœ‰å¤šä¸ªæ•°æ®åº“é˜¶æ®µæˆ–å¤šä¸ªæ•°æ®åº“ï¼Œæˆ–åŒä¸€é¡¹ç›®ä¸­æœ‰ä¸åŒæ•°æ®åº“æ—¶éå¸¸æœ‰ç”¨ï¼š

<Npx>
  drizzle-kit push --config=drizzle-dev.drizzle.config
  drizzle-kit push --config=drizzle-prod.drizzle.config
</Npx>
```plaintext {5-6}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle-dev.config.ts
 â”œ ğŸ“œ drizzle-prod.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```


Source: https://drizzle.zhcndoc.com/docs/kit-seed-data

import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Section from '@mdx/Section.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Steps from '@mdx/Steps.astro';
import Prerequisites from "@mdx/Prerequisites.astro"

# Drizzle Kit æ•°æ®é¢„ç½®

æ­¤éƒ¨åˆ†å°†åœ¨æˆ‘ä»¬å‘å¸ƒ `drizzle-seed` åŒ…åç«‹å³æ›´æ–°ã€‚

Source: https://drizzle.zhcndoc.com/docs/kit-web-mobile

import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Section from '@mdx/Section.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Npm from '@mdx/Npm.astro';
import Npx from '@mdx/Npx.astro';
import Steps from '@mdx/Steps.astro';
import Prerequisites from "@mdx/Prerequisites.astro"

# Drizzle åœ¨ç½‘é¡µå’Œç§»åŠ¨ç¯å¢ƒä¸­çš„è¿ç§»

æœ¬èŠ‚å†…å®¹å°†åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­æ›´æ–°ã€‚

æœ‰å…³ **Expo SQLite**ã€**OP SQLite** å’Œ **React Native** çš„è¿ç§»ï¼Œè¯·å‚è€ƒæˆ‘ä»¬çš„[å¿«é€Ÿå¼€å§‹](/docs/get-started/expo-new)æŒ‡å—ã€‚

Source: https://drizzle.zhcndoc.com/docs/migrations

export const a = 10;

import Callout from '@mdx/Callout.astro';
import Steps from '@mdx/Steps.astro';
import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Section from '@mdx/Section.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Npm from '@mdx/Npm.astro';
import Tag from '@mdx/Tag.astro'


# Drizzle è¿ç§»åŸºç¡€çŸ¥è¯†

SQL æ•°æ®åº“è¦æ±‚ä½ æå‰æŒ‡å®šä½ å°†è¦å­˜å‚¨çš„å®ä½“çš„ **ä¸¥æ ¼æ¨¡å¼**ï¼Œ 
å¦‚æœï¼ˆå½“ï¼‰ä½ éœ€è¦æ”¹å˜è¿™äº›å®ä½“çš„å½¢çŠ¶ - ä½ éœ€è¦é€šè¿‡ **æ¨¡å¼è¿ç§»** æ¥å®ç°ã€‚

æœ‰å¤šç§ç”Ÿäº§çº§ç®¡ç†æ•°æ®åº“è¿ç§»çš„æ–¹å¼ã€‚ 
Drizzle æ—¨åœ¨å®Œç¾é€‚åº”æ‰€æœ‰è¿™äº›æ–¹å¼ï¼Œæ— è®ºä½ æ˜¯é€‰æ‹© **æ•°æ®åº“ä¼˜å…ˆ** è¿˜æ˜¯ **ä»£ç åº“ä¼˜å…ˆ**ã€‚

**æ•°æ®åº“ä¼˜å…ˆ** æ˜¯æŒ‡ä½ çš„æ•°æ®åº“æ¨¡å¼æ˜¯äº‹å®æ¥æºã€‚ä½ è¦ä¹ˆç›´æ¥åœ¨æ•°æ®åº“ä¸Šç®¡ç†æ•°æ®åº“æ¨¡å¼ï¼Œ 
è¦ä¹ˆé€šè¿‡æ•°æ®åº“è¿ç§»å·¥å…·ï¼Œç„¶åå°†æ•°æ®åº“æ¨¡å¼æ‹‰å…¥ä»£ç åº“çš„åº”ç”¨å®ä½“ä¸­ã€‚

**ä»£ç åº“ä¼˜å…ˆ** æ˜¯æŒ‡ä»£ç åº“ä¸­çš„æ•°æ®åº“æ¨¡å¼æ˜¯äº‹å®æ¥æºï¼Œä¸”å—ç‰ˆæœ¬æ§åˆ¶ã€‚ä½ åœ¨ JavaScript/TypeScript ä¸­å£°æ˜å’Œç®¡ç†æ•°æ®åº“æ¨¡å¼ï¼Œ
ç„¶åä½¿ç”¨ Drizzle å°†è¯¥æ¨¡å¼åº”ç”¨äºæ•°æ®åº“ï¼Œç›´æ¥æˆ–é€šè¿‡å¤–éƒ¨è¿ç§»å·¥å…·ã€‚

#### Drizzle å¦‚ä½•æä¾›å¸®åŠ©ï¼Ÿ
æˆ‘ä»¬æ„å»ºäº† [**drizzle-kit**](/docs/kit-overview) - ç”¨äºç®¡ç†è¿ç§»çš„ CLI åº”ç”¨ç¨‹åºã€‚ 
```shell
drizzle-kit migrate
drizzle-kit generate
drizzle-kit push
drizzle-kit pull
```
å®ƒæ—¨åœ¨æ ¹æ®ä½ å½“å‰çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®©ä½ é€‰æ‹©å¦‚ä½•å¤„ç†è¿ç§»ã€‚

å®ƒé€‚ç”¨äºæ•°æ®åº“ä¼˜å…ˆå’Œä»£ç åº“ä¼˜å…ˆä¸¤ç§æ–¹æ³•ï¼Œå…è®¸ä½  **æ¨é€ä½ çš„æ¨¡å¼** æˆ– **ç”Ÿæˆ SQL è¿ç§»** æ–‡ä»¶ï¼Œæˆ– **ä»æ•°æ®åº“æ‹‰å–æ¨¡å¼**ã€‚
æ— è®ºä½ æ˜¯å•ç‹¬å·¥ä½œè¿˜æ˜¯åœ¨å›¢é˜Ÿä¸­ï¼Œå®ƒéƒ½éå¸¸å®Œç¾ã€‚
<br/>

<hr/>
<rem/>

**ç°åœ¨è®©æˆ‘ä»¬ä¸ºä½ çš„é¡¹ç›®é€‰æ‹©æœ€ä½³é€‰é¡¹ï¼š**
<rem/>

<Tag style="font-size: 12px">**é€‰é¡¹ 1**</Tag>
> æˆ‘è‡ªå·±ç®¡ç†æ•°æ®åº“æ¨¡å¼ï¼Œä½¿ç”¨å¤–éƒ¨è¿ç§»å·¥å…·æˆ–ç›´æ¥åœ¨æ•°æ®åº“ä¸Šè¿è¡Œ SQL è¿ç§»ã€‚
> ä» Drizzle ä¸­ï¼Œæˆ‘åªéœ€è¦ä»æˆ‘çš„æ•°æ®åº“ä¸­è·å–å½“å‰æ¨¡å¼çŠ¶æ€å¹¶å°†å…¶ä¿å­˜ä¸º TypeScript æ¨¡å¼æ–‡ä»¶ã€‚

<Callout collapsed="Expand details">
è¿™æ˜¯ä¸€ç§ **æ•°æ®åº“ä¼˜å…ˆ** çš„æ–¹æ³•ã€‚ä½ å°†æ•°æ®åº“æ¨¡å¼ä½œä¸º **äº‹å®æ¥æº**ï¼Œ 
Drizzle å…è®¸ä½ ä½¿ç”¨ [`drizzle-kit pull`](/docs/drizzle-kit-pull) å‘½ä»¤å°†æ•°æ®åº“æ¨¡å¼æ‹‰å–åˆ° TypeScript ä¸­ã€‚

<Section>
```
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
                                  â”‚                        â”‚ <---  CREATE TABLE "users" (
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                        â”‚        "id" SERIAL PRIMARY KEY,
â”‚ ~ drizzle-kit pull       â”‚      â”‚                        â”‚        "name" TEXT,
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚        DATABASE        â”‚        "email" TEXT UNIQUE
  â”‚                               â”‚                        â”‚       );
  â”” Pull datatabase schema -----> â”‚                        â”‚
  â”Œ Generate Drizzle       <----- â”‚                        â”‚
  â”‚ schema TypeScript file        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  v
```
```typescript
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(),
});
```
</Section>
</Callout>

<rem/>
<rem/>
<rem/>

<Tag style="font-size: 12px">**é€‰é¡¹ 2**</Tag>
> æˆ‘å¸Œæœ›åœ¨æˆ‘çš„ TypeScript ä»£ç åº“ä¸­æ‹¥æœ‰æ•°æ®åº“æ¨¡å¼ï¼Œ
> æˆ‘ä¸æƒ³å¤„ç† SQL è¿ç§»æ–‡ä»¶ã€‚
> æˆ‘å¸Œæœ› Drizzle å°†æˆ‘çš„æ¨¡å¼â€œæ¨é€â€åˆ°æ•°æ®åº“ã€‚

<Callout collapsed="Expand details">
è¿™æ˜¯ä¸€ç§ **ä»£ç åº“ä¼˜å…ˆ** çš„æ–¹æ³•ã€‚ä½ å°† TypeScript Drizzle æ¨¡å¼ä½œä¸º **äº‹å®æ¥æº**ï¼Œ 
Drizzle å…è®¸ä½ ä½¿ç”¨ [`drizzle-kit push`](/docs/drizzle-kit-push) å‘½ä»¤å°†æ¨¡å¼æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ã€‚

è¿™æ˜¯å¿«é€ŸåŸå‹è®¾è®¡çš„æœ€ä½³æ–¹æ³•ï¼Œ
æˆ‘ä»¬çœ‹åˆ°å‡ åä¸ªå›¢é˜Ÿå’Œç‹¬ç«‹å¼€å‘è€…æˆåŠŸåœ°å°†å…¶ä½œä¸ºç”Ÿäº§åº”ç”¨ç¨‹åºçš„ä¸»è¦è¿ç§»æµç¨‹ã€‚

<Section>
```typescript {6} filename="src/schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(), // <--- æ·»åŠ çš„åˆ—
};
```
```
ä¸º `users` è¡¨æ·»åŠ åˆ—                                                                          
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ + email: text().unique() â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           
  v                                           
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ ~ drizzle-kit push       â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”” Pull current datatabase schema ---------> â”‚                          â”‚
                                              â”‚                          â”‚
  â”Œ Generate alternations based on diff <---- â”‚         DATABASE         â”‚
  â”‚                                           â”‚                          â”‚
  â”” Apply migrations to the database -------> â”‚                          â”‚
                                       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   ALTER TABLE `users` ADD COLUMN `email` TEXT UNIQUE; 
```
</Section>
</Callout>

<rem/>
<rem/>
<rem/>

<Tag style="font-size: 12px">**é€‰é¡¹ 3**</Tag>
> æˆ‘å¸Œæœ›åœ¨æˆ‘çš„ TypeScript ä»£ç åº“ä¸­æ‹¥æœ‰æ•°æ®åº“æ¨¡å¼ï¼Œ
> æˆ‘å¸Œæœ› Drizzle ä¸ºæˆ‘ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶å¹¶å°†å…¶åº”ç”¨åˆ°æˆ‘çš„æ•°æ®åº“ã€‚

<Callout collapsed="Expand details">
è¿™æ˜¯ä¸€ç§ **ä»£ç åº“ä¼˜å…ˆ** çš„æ–¹æ³•ã€‚ä½ å°† TypeScript Drizzle æ¨¡å¼ä½œä¸ºäº‹å®æ¥æºï¼Œ 
Drizzle å…è®¸ä½ åŸºäºæ¨¡å¼æ›´æ”¹ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶ï¼Œä½¿ç”¨ [`drizzle-kit generate`](/docs/drizzle-kit-generateï¼‰ï¼Œ
ç„¶åä½¿ç”¨ [`drizzle-kit migrate`](/docs/drizzle-kit-migrate) å‘½ä»¤å°†å…¶åº”ç”¨åˆ°æ•°æ®åº“ã€‚ 
<Section>
```typescript filename="src/schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(),
});
```
```                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit generate â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           
  â”” 1. è¯»å–å…ˆå‰çš„è¿ç§»æ–‡ä»¶å¤¹
    2. æ‰¾åˆ°å½“å‰å’Œå…ˆå‰æ¨¡å¼ä¹‹é—´çš„å·®å¼‚
    3. å¦‚æœ‰å¿…è¦ï¼Œæç¤ºå¼€å‘è€…è¿›è¡Œé‡å‘½å
  â”Œ 4. ç”Ÿæˆ SQL è¿ç§»å¹¶æŒä¹…ä¿å­˜åˆ°æ–‡ä»¶
  â”‚    â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
  â”‚      ğŸ“‚ drizzle       
  â”‚      â”” ğŸ“‚ 20242409125510_premium_mister_fear
  â”‚        â”œ ğŸ“œ snapshot.json
  â”‚        â”” ğŸ“œ migration.sql
  v
```
```sql
-- drizzle/20242409125510_premium_mister_fear/migration.sql

CREATE TABLE "users" (
 "id" SERIAL PRIMARY KEY,
 "name" TEXT,
 "email" TEXT UNIQUE
);
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit migrate â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         
  â”” 1. è¯»å–è¿ç§».sql æ–‡ä»¶                                                        â”‚                          â”‚
    2. ä»æ•°æ®åº“ä¸­è·å–è¿ç§»å†å² -------------> â”‚                          â”‚
  â”Œ 3. é€‰æ‹©ä»¥å‰æœªåº”ç”¨çš„è¿ç§» <-------------- â”‚         DATABASE         â”‚
  â”” 4. å°†æ–°è¿ç§»åº”ç”¨äºæ•°æ®åº“ -------------> â”‚                          â”‚
                                                            â”‚                          â”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[âœ“] å®Œæˆï¼                                                 
```
</Section>
</Callout>

<rem/>
<rem/>
<rem/>

<Tag style="font-size: 12px">**é€‰é¡¹ 4**</Tag>
> æˆ‘å¸Œæœ›åœ¨æˆ‘çš„ TypeScript ä»£ç åº“ä¸­æ‹¥æœ‰æ•°æ®åº“æ¨¡å¼ï¼Œ
> æˆ‘å¸Œæœ› Drizzle ä¸ºæˆ‘ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶ï¼Œå¹¶å¸Œæœ› Drizzle åœ¨è¿è¡Œæ—¶åº”ç”¨å®ƒä»¬ã€‚

<Callout collapsed="Expand details">
è¿™æ˜¯ä¸€ç§ **ä»£ç åº“ä¼˜å…ˆ** çš„æ–¹æ³•ã€‚ä½ å°† TypeScript Drizzle æ¨¡å¼ä½œä¸ºäº‹å®æ¥æºï¼Œ 
Drizzle å…è®¸ä½ æ ¹æ®æ¨¡å¼æ›´æ”¹ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶ï¼Œä½¿ç”¨ [`drizzle-kit generate`](/docs/drizzle-kit-generateï¼‰ï¼Œ
ç„¶åä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶å°†å…¶åº”ç”¨åˆ°æ•°æ®åº“ã€‚

è¿™ç§æ–¹æ³•å¹¿æ³›ç”¨äº **å•ä½“** åº”ç”¨ç¨‹åºï¼Œ
åœ¨é›¶åœæœºéƒ¨ç½²æœŸé—´åº”ç”¨æ•°æ®åº“è¿ç§»ï¼Œå¹¶åœ¨å‘ç”Ÿæ•…éšœæ—¶å›æ»š DDL æ›´æ”¹ã€‚
è¿™ä¹Ÿåº”ç”¨äº **æ— æœåŠ¡å™¨** éƒ¨ç½²ï¼Œåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä»¥ **è‡ªå®šä¹‰èµ„æº** è¿è¡Œè¿ç§»ã€‚

<Section>
```typescript filename="src/schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(),
});
```
```                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit generate â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           
  â”” 1. è¯»å–å…ˆå‰çš„è¿ç§»æ–‡ä»¶å¤¹
    2. æ‰¾åˆ°å½“å‰å’Œå…ˆå‰æ¨¡å¼ä¹‹é—´çš„å·®å¼‚
    3. å¦‚æœ‰å¿…è¦ï¼Œæç¤ºå¼€å‘è€…è¿›è¡Œé‡å‘½å
  â”Œ 4. ç”Ÿæˆ SQL è¿ç§»å¹¶æŒä¹…ä¿å­˜åˆ°æ–‡ä»¶
  â”‚    â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
  â”‚      ğŸ“‚ drizzle       
  â”‚      â”” ğŸ“‚ 20242409125510_premium_mister_fear
  â”‚        â”œ ğŸ“œ snapshot.json
  â”‚        â”” ğŸ“œ migration.sql
  v
```
```sql
-- drizzle/20242409125510_premium_mister_fear/migration.sql

CREATE TABLE "users" (
 "id" SERIAL PRIMARY KEY,
 "name" TEXT,
 "email" TEXT UNIQUE
);
```
```ts
// index.ts
import { drizzle } from "drizzle-orm/node-postgres"
import { migrate } from 'drizzle-orm/node-postgres/migrator';

const db = drizzle(process.env.DATABASE_URL);

await migrate(db);
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ npx tsx src/index.ts  â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                                      
  â”œ 1. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         
  â”” 2. è¯»å–è¿ç§».sql æ–‡ä»¶                                                        â”‚                          â”‚
    3. ä»æ•°æ®åº“ä¸­è·å–è¿ç§»å†å² -------------> â”‚                          â”‚
  â”Œ 4. é€‰æ‹©ä»¥å‰æœªåº”ç”¨çš„è¿ç§» <-------------- â”‚         DATABASE         â”‚
  â”” 5. å°†æ–°è¿ç§»åº”ç”¨äºæ•°æ®åº“ -------------> â”‚                          â”‚
                                                            â”‚                          â”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[âœ“] å®Œæˆï¼                                                 
```
</Section>
</Callout>

<rem/>
<rem/>
<rem/>

<Tag style="font-size: 12px">**é€‰é¡¹ 5**</Tag>
> æˆ‘å¸Œæœ›åœ¨æˆ‘çš„ TypeScript ä»£ç åº“ä¸­æ‹¥æœ‰æ•°æ®åº“æ¨¡å¼ï¼Œ
> æˆ‘å¸Œæœ› Drizzle ä¸ºæˆ‘ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶ï¼Œ
> ä½†æˆ‘ä¼šè‡ªå·±å°†å…¶åº”ç”¨åˆ°æˆ‘çš„æ•°æ®åº“æˆ–ä½¿ç”¨å¤–éƒ¨è¿ç§»å·¥å…·ã€‚

<Callout collapsed="Expand details">
è¿™æ˜¯ä¸€ç§ **ä»£ç åº“ä¼˜å…ˆ** çš„æ–¹æ³•ã€‚ä½ å°† TypeScript Drizzle æ¨¡å¼ä½œä¸ºäº‹å®æ¥æºï¼Œ 
Drizzle å…è®¸ä½ åŸºäºæ¨¡å¼æ›´æ”¹ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶ï¼Œä½¿ç”¨ [`drizzle-kit generate`](/docs/drizzle-kit-generate)ï¼Œ
ç„¶åä½ å¯ä»¥ç›´æ¥æˆ–é€šè¿‡å¤–éƒ¨è¿ç§»å·¥å…·å°†å…¶åº”ç”¨äºæ•°æ®åº“ã€‚

<Section>
```typescript filename="src/schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(),
});
```
```                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit generate â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           
  â”” 1. è¯»å–å…ˆå‰çš„è¿ç§»æ–‡ä»¶å¤¹
    2. æ‰¾åˆ°å½“å‰å’Œå…ˆå‰æ¨¡å¼ä¹‹é—´çš„å·®å¼‚
    3. å¦‚æœ‰å¿…è¦ï¼Œæç¤ºå¼€å‘è€…è¿›è¡Œé‡å‘½å
  â”Œ 4. ç”Ÿæˆ SQL è¿ç§»å¹¶æŒä¹…ä¿å­˜åˆ°æ–‡ä»¶
  â”‚    â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
  â”‚      ğŸ“‚ drizzle       
  â”‚      â”” ğŸ“‚ 20242409125510_premium_mister_fear
  â”‚        â”œ ğŸ“œ snapshot.json
  â”‚        â”” ğŸ“œ migration.sql
  v
```
```sql
-- drizzle/20242409125510_premium_mister_fear/migration.sql

CREATE TABLE "users" (
 "id" SERIAL PRIMARY KEY,
 "name" TEXT,
 "email" TEXT UNIQUE
);
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ (._.) ç°åœ¨ä½ è¿è¡Œä½ çš„è¿ç§» â”‚           
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  
  â”‚
  ç›´æ¥åˆ°æ•°æ®åº“
  â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€>â”‚                    â”‚  
  â”‚                                    â”‚    â”‚      Database      â”‚           
 or via external tools                 â”‚    â”‚                    â”‚   
  â”‚                                    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚      
  â””â”€â”€â”‚ Bytebase           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
     â”‚ Liquibase          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 
     â”‚ Atlas              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 
     â”‚ etcâ€¦               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[âœ“] å®Œæˆï¼                                                 
```
</Section>
</Callout>

<rem/>
<rem/>
<rem/>

<Tag style="font-size: 12px">**Option 6**</Tag>
> æˆ‘æƒ³åœ¨æˆ‘çš„ TypeScript ä»£ç åº“ä¸­æ‹¥æœ‰æ•°æ®åº“æ¶æ„ï¼Œ
> æˆ‘å¸Œæœ› Drizzle å°†æˆ‘çš„ Drizzle æ¶æ„çš„ SQL è¡¨ç¤ºè¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œ
> ç„¶åæˆ‘å°†é€šè¿‡ [Atlas](https://atlasgo.io/guides/orms/drizzle)åº”ç”¨è¿™äº›æ¶æ„åˆ°æˆ‘çš„æ•°æ®åº“ä¸­ã€‚

<Callout collapsed="Expand details">
è¿™æ˜¯ä¸€ç§**ä»¥ä»£ç åº“ä¸ºå…ˆ**çš„æ–¹æ³•ã€‚ä½ æ‹¥æœ‰ TypeScript Drizzle æ¨¡å¼ä½œä¸ºçœŸå®æ¥æºï¼Œå¹¶ä¸”
Drizzle å…è®¸ä½ æ ¹æ®æ¨¡å¼å˜åŒ–å¯¼å‡º SQL è¯­å¥ï¼Œä½¿ç”¨ [`drizzle-kit export`](/docs/drizzle-kit-generate)ï¼Œç„¶å
ä½ å¯ä»¥é€šè¿‡ [Atlas](https://atlasgo.io/guides/orms/drizzle) æˆ–å…¶ä»–å¤–éƒ¨ SQL è¿ç§»å·¥å…·å°†å®ƒä»¬åº”ç”¨åˆ°æ•°æ®åº“ã€‚

<Section>
```typescript filename="src/schema.ts"
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.serial().primaryKey(),
  name: p.text(),
  email: p.text().unique(),
});
```
```                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ $ drizzle-kit export   â”‚                  
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  
  â”‚                                           
  â”” 1. read your drizzle schema
    2. generated SQL representation of your schema
  â”Œ 3. outputs to console
  â”‚    
  â”‚        
  v
```
```sql
CREATE TABLE "users" (
 "id" SERIAL PRIMARY KEY,
 "name" TEXT,
 "email" TEXT UNIQUE
);
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  
â”‚ (._.) now you run your migrations â”‚           
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  
  â”‚
 via Atlas
  â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚              â”‚
  â””â”€â”€â”‚ Atlas              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Database    â”‚      
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚              â”‚       
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[âœ“] done!                                                 
```
</Section>
</Callout>

<rem/>
<rem/>


Source: https://drizzle.zhcndoc.com/docs/operators

import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Section from '@mdx/Section.astro';

# è¿‡æ»¤å™¨å’Œæ¡ä»¶è¿ç®—ç¬¦
æˆ‘ä»¬åŸç”Ÿæ”¯æŒæ‰€æœ‰ç‰¹å®šäºæ–¹è¨€çš„è¿‡æ»¤å™¨å’Œæ¡ä»¶è¿ç®—ç¬¦ã€‚

æ‚¨å¯ä»¥ä» `drizzle-orm` å¯¼å…¥æ‰€æœ‰è¿‡æ»¤å™¨å’Œæ¡ä»¶ï¼š
```typescript copy
import { eq, ne, gt, gte, ... } from "drizzle-orm";
```

### eq
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ç­‰äº `n`
<Section>
```typescript copy
import { eq } from "drizzle-orm";

db.select().from(table).where(eq(table.column, 5));
```

```sql copy
SELECT * FROM table WHERE table.column = 5
```
</Section>


<Section>
```typescript
import { eq } from "drizzle-orm";

db.select().from(table).where(eq(table.column1, table.column2));
```

```sql
SELECT * FROM table WHERE table.column1 = table.column2
```
</Section>


### ne
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ä¸ç­‰äº `n`  
<Section>
```typescript
import { ne } from "drizzle-orm";

db.select().from(table).where(ne(table.column, 5));
```

```sql
SELECT * FROM table WHERE table.column <> 5
```
</Section>


<Section>
```typescript
import { ne } from "drizzle-orm";

db.select().from(table).where(ne(table.column1, table.column2));
```

```sql
SELECT * FROM table WHERE table.column1 <> table.column2
```
</Section>

## ---

### gt
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} /> 
  
å€¼å¤§äº `n`
<Section>
```typescript
import { gt } from "drizzle-orm";

db.select().from(table).where(gt(table.column, 5));
```

```sql
SELECT * FROM table WHERE table.column > 5
```
</Section>


<Section>
```typescript
import { gt } from "drizzle-orm";

db.select().from(table).where(gt(table.column1, table.column2));
```

```sql
SELECT * FROM table WHERE table.column1 > table.column2
```
</Section>

### gte
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼å¤§äºæˆ–ç­‰äº `n`
<Section>
```typescript
import { gte } from "drizzle-orm";

db.select().from(table).where(gte(table.column, 5));
```

```sql
SELECT * FROM table WHERE table.column >= 5
```
</Section>


<Section>
```typescript
import { gte } from "drizzle-orm";

db.select().from(table).where(gte(table.column1, table.column2));
```

```sql
SELECT * FROM table WHERE table.column1 >= table.column2
```
</Section>

### lt
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼å°äº `n`
<Section>
```typescript
import { lt } from "drizzle-orm";

db.select().from(table).where(lt(table.column, 5));
```

```sql
SELECT * FROM table WHERE table.column < 5
```
</Section>


<Section>
```typescript
import { lt } from "drizzle-orm";

db.select().from(table).where(lt(table.column1, table.column2));
```

```sql
SELECT * FROM table WHERE table.column1 < table.column2
```
</Section>

### lte
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼å°äºæˆ–ç­‰äº `n`ã€‚

<Section>
```typescript
import { lte } from "drizzle-orm";

db.select().from(table).where(lte(table.column, 5));
```

```sql
SELECT * FROM table WHERE table.column <= 5
```
</Section>

<Section>
```typescript
import { lte } from "drizzle-orm";

db.select().from(table).where(lte(table.column1, table.column2));
```

```sql
SELECT * FROM table WHERE table.column1 <= table.column2
```
</Section>

## ---

### exists
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼å­˜åœ¨
<Section>
```typescript
import { exists } from "drizzle-orm";

const query = db.select().from(table2)
db.select().from(table).where(exists(query));
```

```sql
SELECT * FROM table WHERE EXISTS (SELECT * from table2)
```
</Section>

### notExists

<Section>
```typescript
import { notExists } from "drizzle-orm";

const query = db.select().from(table2)
db.select().from(table).where(notExists(query));
```

```sql
SELECT * FROM table WHERE NOT EXISTS (SELECT * from table2)
```
</Section>

### isNull
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ä¸º `null`
<Section>
```typescript
import { isNull } from "drizzle-orm";

db.select().from(table).where(isNull(table.column));
```

```sql
SELECT * FROM table WHERE table.column IS NULL
```
</Section>


### isNotNull
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ä¸ä¸º `null`
<Section>
```typescript
import { isNotNull } from "drizzle-orm";

db.select().from(table).where(isNotNull(table.column));
```

```sql
SELECT * FROM table WHERE table.column IS NOT NULL
```
</Section>

## ---

### inArray
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼åœ¨å€¼çš„æ•°ç»„ä¸­
<Section>
```typescript
import { inArray } from "drizzle-orm";

db.select().from(table).where(inArray(table.column, [1, 2, 3, 4]));
```

```sql
SELECT * FROM table WHERE table.column in (1, 2, 3, 4)
```
</Section>

<Section>
```typescript
import { inArray } from "drizzle-orm";

const query = db.select({ data: table2.column }).from(table2);
db.select().from(table).where(inArray(table.column, query));
```

```sql
SELECT * FROM table WHERE table.column IN (SELECT table2.column FROM table2)
```
</Section>

### notInArray
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ä¸åœ¨å€¼çš„æ•°ç»„ä¸­
<Section>
```typescript
import { notInArray } from "drizzle-orm";

db.select().from(table).where(notInArray(table.column, [1, 2, 3, 4]));
```

```sql
SELECT * FROM table WHERE table.column NOT in (1, 2, 3, 4)
```
</Section>

<Section>
```typescript
import { notInArray } from "drizzle-orm";

const query = db.select({ data: table2.column }).from(table2);
db.select().from(table).where(notInArray(table.column, query));
```

```sql
SELECT * FROM table WHERE table.column NOT IN (SELECT table2.column FROM table2)
```
</Section>

## ---

### between
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼åœ¨ä¸¤ä¸ªå€¼ä¹‹é—´
<Section>
```typescript
import { between } from "drizzle-orm";

db.select().from(table).where(between(table.column, 2, 7));
```

```sql
SELECT * FROM table WHERE table.column BETWEEN 2 AND 7
```
</Section>

### notBetween
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ä¸åœ¨ä¸¤ä¸ªå€¼ä¹‹é—´
<Section>
```typescript
import { notBetween } from "drizzle-orm";

db.select().from(table).where(notBetween(table.column, 2, 7));
```

```sql
SELECT * FROM table WHERE table.column NOT BETWEEN 2 AND 7
```
</Section>

## ---

### like
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ç±»ä¼¼äºå…¶ä»–å€¼ï¼ŒåŒºåˆ†å¤§å°å†™
<Section>
```typescript
import { like } from "drizzle-orm";

db.select().from(table).where(like(table.column, "%llo wor%"));
```

```sql
SELECT * FROM table WHERE table.column LIKE '%llo wor%'
```
</Section>

### ilike
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': false, 'SingleStore': false }} />
  
å€¼ä¸æŸä¸ªå…¶ä»–å€¼ç›¸ä¼¼ï¼Œä¸åŒºåˆ†å¤§å°å†™
<Section>
```typescript
import { ilike } from "drizzle-orm";

db.select().from(table).where(ilike(table.column, "%llo wor%"));
```

```sql
SELECT * FROM table WHERE table.column ILIKE '%llo wor%'
```
</Section>

### notIlike
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
å€¼ä¸æŸä¸ªå…¶ä»–å€¼ä¸ç›¸ä¼¼ï¼Œä¸åŒºåˆ†å¤§å°å†™
<Section>
```typescript
import { notIlike } from "drizzle-orm";

db.select().from(table).where(notIlike(table.column, "%llo wor%"));
```

```sql
SELECT * FROM table WHERE table.column NOT ILIKE '%llo wor%'
```
</Section>

## ---

### not
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
æ‰€æœ‰æ¡ä»¶å¿…é¡»è¿”å› `false`ã€‚

<Section>
```typescript
import { eq, not } from "drizzle-orm";

db.select().from(table).where(not(eq(table.column, 5)));
```

```sql
SELECT * FROM table WHERE NOT (table.column = 5)
```
</Section>

### and
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
æ‰€æœ‰æ¡ä»¶å¿…é¡»è¿”å› `true`ã€‚

<Section>
```typescript
import { gt, lt, and } from "drizzle-orm";

db.select().from(table).where(and(gt(table.column, 5), lt(table.column, 7)));
```

```sql
SELECT * FROM table WHERE (table.column > 5 AND table.column < 7)
```
</Section>

### or
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': true, 'SingleStore': true }} />
  
ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ä»¶å¿…é¡»è¿”å› `true`ã€‚

<Section>
```typescript
import { gt, lt, or } from "drizzle-orm";

db.select().from(table).where(or(gt(table.column, 5), lt(table.column, 7)));
```

```sql
SELECT * FROM table WHERE (table.column > 5 OR table.column < 7)
```
</Section>

## ---

### arrayContains
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': false, 'SingleStore': false }} />
  
æµ‹è¯•æŸä¸ªåˆ—æˆ–è¡¨è¾¾å¼æ˜¯å¦åŒ…å«ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„åˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ 

<Section>
```typescript
import { arrayContains } from "drizzle-orm";

const contains = await db.select({ id: posts.id }).from(posts)
  .where(arrayContains(posts.tags, ['Typescript', 'ORM']));

const withSubQuery = await db.select({ id: posts.id }).from(posts)
  .where(arrayContains(
    posts.tags,
    db.select({ tags: posts.tags }).from(posts).where(eq(posts.id, 1)),
  ));
```

```sql
select "id" from "posts" where "posts"."tags" @> {Typescript,ORM};
select "id" from "posts" where "posts"."tags" @> (select "tags" from "posts" where "posts"."id" = 1);
```
</Section>

### arrayContained
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': false, 'SingleStore': false }} />
  
æµ‹è¯•ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„åˆ—è¡¨æ˜¯å¦åŒ…å«æŸä¸ªåˆ—æˆ–è¡¨è¾¾å¼ä¸­çš„æ‰€æœ‰å…ƒç´ 

<Section>
```typescript
import { arrayContained } from "drizzle-orm";

const contained = await db.select({ id: posts.id }).from(posts)
  .where(arrayContained(posts.tags, ['Typescript', 'ORM']));
```

```sql
select "id" from "posts" where "posts"."tags" <@ {Typescript,ORM};
```
</Section>

### arrayOverlaps
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': false, 'SingleStore': false }} />
  
æµ‹è¯•æŸä¸ªåˆ—æˆ–è¡¨è¾¾å¼æ˜¯å¦åŒ…å«ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„åˆ—è¡¨ä¸­çš„ä»»ä½•å…ƒç´ ã€‚

<Section>
```typescript
import { arrayOverlaps } from "drizzle-orm";

const overlaps = await db.select({ id: posts.id }).from(posts)
  .where(arrayOverlaps(posts.tags, ['Typescript', 'ORM']));
```

```sql
select "id" from "posts" where "posts"."tags" && {Typescript,ORM}
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/overview

import Callout from '@mdx/Callout.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import YoutubeCards from '@mdx/YoutubeCards.astro';
import GetStartedLinks from '@mdx/GetStartedLinks/index.astro'

# Drizzle ORM

Drizzle ORM æ˜¯ä¸€ä¸ªæ— å¤´çš„ TypeScript ORMã€‚ğŸ²
> Drizzle æ˜¯ä¸€ä¸ªä¼šåœ¨ä½ éœ€è¦çš„æ—¶å€™é™ªä¼´ä½ ï¼Œè€Œåœ¨ä½ éœ€è¦ç©ºé—´æ—¶ä¸æ‰“æ‰°ä½ çš„å¥½æœ‹å‹ã€‚

å®ƒçœ‹èµ·æ¥å’Œæ„Ÿè§‰éƒ½å¾ˆç®€å•ï¼Œå¹¶ä¸”åœ¨ä½ é¡¹ç›®çš„ _1000_ å¤©ä¹‹é™…è¡¨ç°å‡ºè‰²ï¼Œ\
è®©ä½ æŒ‰ç…§è‡ªå·±çš„æ–¹å¼åšäº‹ï¼Œå½“ä½ éœ€è¦å®ƒæ—¶ï¼Œå®ƒå°±åœ¨ä½ èº«è¾¹ã€‚

**å®ƒæ˜¯å”¯ä¸€åŒæ—¶æ‹¥æœ‰ [å…³ç³»](/docs/rqb) å’Œ [SQL-like](/docs/select) æŸ¥è¯¢ API çš„ ORMï¼Œ** 
åœ¨è®¿é—®ä½ çš„å…³ç³»æ•°æ®æ—¶ä¸ºä½ æä¾›äº†ä¸¤å…¨å…¶ç¾çš„é€‰æ‹©ã€‚ 
Drizzle è½»å·§ã€æ€§èƒ½å“è¶Šã€å®‰å…¨ç±»å‹ã€æ— ä¹³ç³–ã€æ— éº¸è´¨ã€æ¸…é†’ã€çµæ´»ï¼Œå¹¶ä¸”æ˜¯ **å¤©ç”Ÿæ”¯æŒæ— æœåŠ¡å™¨çš„è®¾è®¡**ã€‚
Drizzle ä¸ä»…ä»…æ˜¯ä¸€ä¸ªåº“ï¼Œå®ƒæ˜¯ä¸€ç§ä½“éªŒã€‚ğŸ¤©

[![Drizzle bestofjs](@/assets/images/bestofjs.jpg)](https://bestofjs.org/projects/drizzle-orm)

## æ— å¤´ ORMï¼Ÿ
é¦–å…ˆï¼ŒDrizzle æ˜¯ä¸€ä¸ªåº“å’Œä¸€ç»„å¯é€‰çš„è¡¥å……å·¥å…·ã€‚

**ORM** ä»£è¡¨ _å¯¹è±¡å…³ç³»æ˜ å°„_ï¼Œå¼€å‘è€…é€šå¸¸å°†ç±»ä¼¼ Django æˆ– Spring çš„å·¥å…·ç§°ä¸º ORMã€‚ 
æˆ‘ä»¬ç›¸ä¿¡è¿™æ˜¯ä¸€ç§æºäºé—ç•™å‘½åçš„è¯¯è§£ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º **æ•°æ®æ¡†æ¶**ã€‚

<Callout type="error" emoji="ï¸ğŸ’”">
  ä½¿ç”¨æ•°æ®æ¡†æ¶ï¼Œä½ å¿…é¡»å›´ç»•å®ƒä»¬æ„å»ºé¡¹ç›®ï¼Œè€Œä¸æ˜¯ä¸å®ƒä»¬ä¸€èµ·æ„å»ºã€‚
</Callout>

**Drizzle** è®©ä½ ä»¥è‡ªå·±æƒ³è¦çš„æ–¹å¼æ„å»ºé¡¹ç›®ï¼Œè€Œä¸å¹²æ‰°ä½ çš„é¡¹ç›®æˆ–ç»“æ„ã€‚

ä½¿ç”¨ Drizzleï¼Œä½ å¯ä»¥åœ¨ TypeScript ä¸­å®šä¹‰å’Œç®¡ç†æ•°æ®åº“æ¶æ„ï¼Œ
æŒ‰ SQL-like æˆ–å…³ç³»çš„æ–¹å¼è®¿é—®ä½ çš„æ•°æ®ï¼Œ
å¹¶åˆ©ç”¨å¯é€‰å·¥å…·å°†ä½ çš„å¼€å‘è€…ä½“éªŒæå‡åˆ°ä¸€ä¸ªæ–°çš„é«˜åº¦ã€‚ğŸ¤¯

## ä¸ºä»€ä¹ˆ SQL-likeï¼Ÿ
**å¦‚æœä½ æ‡‚ SQLï¼Œä½ å°±æ‡‚ Drizzleã€‚**

å…¶ä»– ORM å’Œæ•°æ®æ¡†æ¶å¾€å¾€ä½¿ä½ è¿œç¦» SQLï¼Œ
è¿™å¯¼è‡´äº†åŒé‡å­¦ä¹ æ›²çº¿ï¼šéœ€è¦åŒæ—¶äº†è§£ SQL å’Œæ¡†æ¶çš„ APIã€‚

Drizzle åˆ™æ°æ°ç›¸åã€‚ 
æˆ‘ä»¬æ‹¥æŠ± SQLï¼Œæ„å»º Drizzle ä½¿å…¶åœ¨æ ¸å¿ƒä¸Šç±»ä¼¼ SQLï¼Œè¿™æ ·ä½ å°±å‡ ä¹æ²¡æœ‰å­¦ä¹ æ›²çº¿ï¼Œ
å¹¶ä¸”å¯ä»¥å®Œå…¨å‘æŒ¥ SQL çš„åŠ›é‡ã€‚

æˆ‘ä»¬å¸¦æ¥äº†æ‰€æœ‰ç†Ÿæ‚‰çš„ **[SQL æ¶æ„](/docs/sql-schema-declaration)**ã€**[æŸ¥è¯¢](/docs/select)**ã€ 
**[è‡ªåŠ¨è¿ç§»](/docs/migrations)** å’Œ **[å¦å¤–ä¸€é¡¹](/docs/rqb)**ã€‚âœ¨

<CodeTabs items={["index.ts", "schema.ts", "migration.sql"]}>
```typescript copy
// è®¿é—®ä½ çš„æ•°æ®
await db
	.select()
	.from(countries)
	.leftJoin(cities, eq(cities.countryId, countries.id))
	.where(eq(countries.id, 10))
```
```typescript copy
// ç®¡ç†ä½ çš„æ¶æ„
export const countries = pgTable('countries', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 256 }),
});

export const cities = pgTable('cities', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 256 }),
  countryId: integer('country_id').references(() => countries.id),
});
```
```sql
-- ç”Ÿæˆè¿ç§»
CREATE TABLE IF NOT EXISTS "countries" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" varchar(256)
);

CREATE TABLE IF NOT EXISTS "cities" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" varchar(256),
	"country_id" integer
);

ALTER TABLE "cities" ADD CONSTRAINT "cities_country_id_countries_id_fk" FOREIGN KEY ("country_id") REFERENCES "countries"("id") ON DELETE no action ON UPDATE no action;
```
</CodeTabs>

## ä¸ºä»€ä¹ˆä¸ SQL-likeï¼Ÿ
æˆ‘ä»¬å§‹ç»ˆåœ¨è¿½æ±‚ä¸€ä¸ªå®Œç¾å¹³è¡¡çš„è§£å†³æ–¹æ¡ˆï¼Œè™½ç„¶ SQL-like 100% æ»¡è¶³éœ€æ±‚ï¼Œ 
ä½†åœ¨æŸäº›å¸¸è§åœºæ™¯ä¸­ï¼Œæ‚¨å¯ä»¥æ›´å¥½åœ°æŸ¥è¯¢æ•°æ®ã€‚

æˆ‘ä»¬ä¸ºä½ æ„å»ºäº† **[æŸ¥è¯¢ API](/docs/rqb)**ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ä»¥æœ€ä¾¿æ·å’Œé«˜æ•ˆçš„æ–¹å¼ä»æ•°æ®åº“ä¸­è·å–å…³ç³»åµŒå¥—æ•°æ®ï¼Œ
è€Œæ— éœ€è€ƒè™‘è¿æ¥å’Œæ•°æ®æ˜ å°„ã€‚

**Drizzle å§‹ç»ˆè¾“å‡ºå‡†ç¡®çš„ 1 æ¡ SQL æŸ¥è¯¢ã€‚** å¯ä»¥æ”¾å¿ƒåœ°å°†å…¶ä¸æ— æœåŠ¡å™¨æ•°æ®åº“ä¸€èµ·ä½¿ç”¨ï¼Œä¸ç”¨æ‹…å¿ƒæ€§èƒ½æˆ–å¾€è¿”æˆæœ¬ï¼

```ts
const result = await db.query.users.findMany({
	with: {
		posts: true
	},
});
```

## æ— æœåŠ¡å™¨ï¼Ÿ
<Callout type="info" emoji="ğŸ¥³">
  æœ€æ£’çš„ä¸€ç‚¹å°±æ˜¯æ²¡æœ‰ã€‚**Drizzle å…·æœ‰ 0 ä¸ªä¾èµ–ï¼**
</Callout>


![Drizzle è½»ä¾¿ä¸”å‡†å¤‡å¥½æ— æœåŠ¡å™¨](@/assets/images/drizzle31kb.jpg)

Drizzle ORM æ˜¯ç‰¹å®šäºæ–¹è¨€çš„ï¼Œè½»å·§ã€é«˜æ•ˆï¼Œå¹¶ä¸” **å¤©ç”Ÿæ”¯æŒæ— æœåŠ¡å™¨**ã€‚

æˆ‘ä»¬èŠ±äº†å¤§é‡æ—¶é—´ç¡®ä¿ä½ æ‹¥æœ‰ä¸€æµçš„ SQL æ–¹è¨€æ”¯æŒï¼ŒåŒ…æ‹¬ Postgresã€MySQL å’Œå…¶ä»–ã€‚

Drizzle é€šè¿‡è¡Œä¸šæ ‡å‡†çš„æ•°æ®åº“é©±åŠ¨ç¨‹åºåŸç”Ÿè¿è¡Œã€‚æˆ‘ä»¬æ”¯æŒæ‰€æœ‰ä¸»è¦çš„ **[PostgreSQL](/docs/get-started-postgresql)**ã€**[MySQL](/docs/get-started-mysql)**ã€**[SQLite](/docs/get-started-sqlite)** æˆ– **[SingleStore](/docs/get-started-singlestore)**  é©±åŠ¨ç¨‹åºï¼Œå¹¶ä¸”æˆ‘ä»¬æ­£åœ¨ **[éå¸¸å¿«é€Ÿåœ°](https://twitter.com/DrizzleORM/status/1653082492742647811?s=20)** æ·»åŠ æ–°çš„é©±åŠ¨ç¨‹åºã€‚


## æ¬¢è¿åŠ å…¥ï¼
è¶Šæ¥è¶Šå¤šçš„å…¬å¸åœ¨ç”Ÿäº§ä¸­é‡‡ç”¨ Drizzleï¼Œä½“éªŒåˆ°å¼€å‘è€…ä½“éªŒå’Œæ€§èƒ½çš„å·¨å¤§å¥½å¤„ã€‚

**æˆ‘ä»¬å§‹ç»ˆåœ¨è¿™é‡Œæä¾›å¸®åŠ©ï¼Œå› æ­¤è¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚æˆ‘ä»¬å¾ˆä¹æ„åœ¨ä½ çš„ Drizzle ä¹‹æ—…ä¸­ååŠ©ä½ ï¼**

æˆ‘ä»¬æœ‰ä¸€ä¸ªæ°å‡ºçš„ **[Discord ç¤¾åŒº](https://driz.link/discord)**ï¼Œæ¬¢è¿æ‰€æœ‰å¼€å‘è€…åŠ å…¥æˆ‘ä»¬çš„ **[Twitter](https://twitter.com/drizzleorm)**ã€‚

ç°åœ¨å»ç”¨ Drizzle å’Œä½ çš„ **[PostgreSQL](/docs/get-started-postgresql)**ã€**[MySQL](/docs/get-started-mysql)** æˆ– **[SQLite](/docs/get-started-sqlite)** æ•°æ®åº“æ„å»ºä¸€äº›ä»¤äººæƒŠå¹çš„ä¸œè¥¿å§ã€‚ğŸš€

### è§†é¢‘å±•ç¤º

{/* tRPC + NextJS åº”ç”¨è·¯ç”± = ç®€å•ç±»å‹å®‰å…¨ API
Jack Herrington 19:17
https://www.youtube.com/watch?v=qCLV0Iaq9zU */}
{/* https://www.youtube.com/watch?v=qDunJ0wVIec */}
{/* https://www.youtube.com/watch?v=NZpPMlSAez0 */}

 {/* https://www.youtube.com/watch?v=-A0kMiJqQRY */}

<YoutubeCards cards={[
	{
		id: "vyU5mJGCJMw",
		title: "åˆå­¦è€…çš„å®Œæ•´ Drizzle è¯¾ç¨‹",
		description: "Code Genix",
		time: "1:37:39",
	},
	{
		id: "7-NZ0MlPpJA",
		title: "60åˆ†é’Ÿå­¦ä¼š Drizzle",
		description: "Web Dev Simplified",
		time: "56:09"
	},
	{
		id: "i_mAHOhpBSA",
		title: "100ç§’äº†è§£ Drizzle ORM",
		description: "Fireship",
		time: "2:55"
	},
	{
		id: "hIYNOiZXQ7Y",
		title: "13åˆ†é’Ÿå†…å­¦ä¼š Drizzle ORMï¼ˆé€Ÿæˆè¯¾ç¨‹ï¼‰",
		description: "Neon",
		time: "14:00"
	},
	{
		id: "4ZhtoOFKFP8",
		title: "åœ¨ Next.js 14 ä¸­ä½¿ç”¨ Turso å’Œ Drizzle è®¾ç½®æ•°æ®åº“æœ€ç®€å•çš„æ–¹æ³•",
		description: "Sam Meech-Ward",
		time: '38:08'
	}, 
	{
		id: "NfVELsEZFsA",
		title: "Next.js é¡¹ç›®ä¸ Vercelã€Neonã€Drizzleã€TailwindCSSã€FlowBite ç­‰ï¼",
		description: "CodingEntrepreneurs",
		time: '5:46:28'
	}, 
	{
		id: "_SLxGYzv6jo",
		title: "æˆ‘æœ‰äº†ä¸€ä¸ªæ–°çš„æœ€çˆ±æ•°æ®åº“å·¥å…·",
		description: "Theo - t3.gg",
		time: '5:46'
	}, 
	{
		id: "Qo-RXkSwOtc",
		title: "Drizzle ORM çš„åˆæ­¥å°è±¡ - è¿ç§»ã€å…³ç³»ã€æŸ¥è¯¢ï¼",
		description: "Marius Espejo",
		time: '33:52'
	},
	{
		id: "yXNEqyvA0OY",
		title: "æˆ‘æƒ³å­¦ä¹  Drizzle ORMï¼Œå› æ­¤æˆ‘å¼€å§‹äº†å¦ä¸€ä¸ª next14 é¡¹ç›®",
		description: "Web Dev Cody",
		time: "9:00"
	},
	{
		id: "h7vVhR-dFYo",
		title: "é€‰æ‹© ORM å˜å¾—è¶Šæ¥è¶Šéš¾...",
		description: "Ben Davis",
		time: "5:18"
	},
	{
		id: "8met6WTk0mQ",
		title: "è¿™ä¸ªæ–°æ•°æ®åº“å·¥å…·çœŸæ˜¯æ¸¸æˆè§„åˆ™æ”¹å˜è€…",
		description: "Josh tried coding",
		time: "8:49"
	},
	{
		id: "woWW1T9DXEY",
		title: "æˆ‘æœ€å–œæ¬¢çš„æ•°æ®åº“å·¥å…·å˜å¾—æ›´å¥½",
		description: "Josh tried coding",
		time: "4:23"
	},
	{
		id: "A3l6YYkXzzg",
		title: "æ‹¥æœ‰å®æ—¶å…‰æ ‡çš„ SaaS Notion å…‹éš†ï¼ŒNextjs 13ã€Stripeã€Drizzle ORMã€Tailwindã€Supabaseã€Sockets",
		description: "Web Prodigies",
		time: "11:41:46"
	},
	{
		id: "EQfaw5bDE1s",
		title: "SvelteKit + Drizzle ä»£ç è§£æ",
		description: "Ben Davis",
		time: "12:18"
	},
	{
		id: "b6VhN_HHDiQ",
		title: "æ„å»ºä¸€ä¸ªå¤šç§Ÿæˆ·ã€åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿ",
		description: "TomDoesTech",
		time: "2:01:29"
	},
	{
		id: "3tl9XCiQErA",
		title: "Prisma çš„æ€æ‰‹ç»ˆäºæ¥äº†",
		description: "SST",
		time: "5:42"
	},
	{
		id: "VQFjyEa8vGE",
		title: "å­¦ä¹  Drizzle ORM å¹¶åœ¨ä¸€ä¸ª next14 é¡¹ç›®ä¸Šå·¥ä½œ",
		description: "Web Dev Cody",
		time: "1:07:41"
	},
	{
		id: "5G0upg4sxgE",
		title: "è¿™ä¸ªæŠ€å·§è®©æˆ‘çš„æœ€çˆ±æ•°æ®åº“å·¥å…·å˜å¾—æ›´å¥½",
		description: "Josh tried coding",
		time: "6:01"
	},
	{
		id: "-JnEuvPmt-Q",
		title: "åœ¨ Next.js 14 ä¸­è½»æ¾è®¤è¯ï¼šä½¿ç”¨ Auth.js å’Œ Drizzle ORM å®ç°å®‰å…¨ç™»å½•",
		description: "Sam Meech-Ward",
		time: "26:29"
	},
]} />


Source: https://drizzle.zhcndoc.com/docs/perf-queries

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';

# æŸ¥è¯¢æ€§èƒ½
è°ˆåˆ° **Drizzle** â€” æˆ‘ä»¬æ˜¯ä¸€ä¸ªè–„è–„çš„ TypeScript å±‚ï¼Œä½äº SQL ä¹‹ä¸Šï¼Œå‡ ä¹æ²¡æœ‰å¼€é”€ï¼Œ
ä¸ºäº†ä½¿å…¶çœŸæ­£è¾¾åˆ° 0ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨æˆ‘ä»¬çš„é¢„ç¼–è¯‘è¯­å¥ APIã€‚

**å½“æ‚¨åœ¨æ•°æ®åº“ä¸Šè¿è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¼šå‘ç”Ÿå‡ ä»¶äº‹ï¼š**
- æŸ¥è¯¢æ„å»ºå™¨çš„æ‰€æœ‰é…ç½®éƒ½è¢«è¿æ¥åˆ° SQL å­—ç¬¦ä¸²
- è¯¥å­—ç¬¦ä¸²å’Œå‚æ•°è¢«å‘é€åˆ°æ•°æ®åº“é©±åŠ¨ç¨‹åº
- é©±åŠ¨ç¨‹åºå°† SQL æŸ¥è¯¢ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ SQL æ‰§è¡Œæ ¼å¼å¹¶å‘é€åˆ°æ•°æ®åº“

é€šè¿‡é¢„ç¼–è¯‘è¯­å¥ï¼Œæ‚¨åªéœ€åœ¨ Drizzle ORM ç«¯è¿›è¡Œä¸€æ¬¡ SQL è¿æ¥ï¼Œ
ç„¶åæ•°æ®åº“é©±åŠ¨ç¨‹åºå°±èƒ½å¤Ÿé‡ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶ SQLï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½è§£ææŸ¥è¯¢ã€‚
è¿™åœ¨å¤„ç†å¤§å‹ SQL æŸ¥è¯¢æ—¶å…·æœ‰æå¤§çš„æ€§èƒ½ä¼˜åŠ¿ã€‚

ä¸åŒçš„æ•°æ®åº“é©±åŠ¨ç¨‹åºä»¥ä¸åŒçš„æ–¹å¼æ”¯æŒé¢„ç¼–è¯‘è¯­å¥ï¼Œæœ‰æ—¶
Drizzle ORM å¯ä»¥æ¯” [**æ›´å¥½çš„ sqlite3 é©±åŠ¨ç¨‹åºæ›´å¿«ã€‚**](https://twitter.com/_alexblokh/status/1593593415907909634)

## é¢„ç¼–è¯‘è¯­å¥
<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore"]}>
  <Tab>
    ```typescript copy {3}
    const db = drizzle(...);

    const prepared = db.select().from(customers).prepare("statement_name");
    
    const res1 = await prepared.execute();
    const res2 = await prepared.execute();
    const res3 = await prepared.execute();
    ```
  </Tab> 
  <Tab>
    ```typescript copy {3}
    const db = drizzle(...);

    const prepared = db.select().from(customers).prepare();
    
    const res1 = await prepared.execute();
    const res2 = await prepared.execute();
    const res3 = await prepared.execute();
    ```
  </Tab> 
  <Tab>
    ```typescript copy {3}
    const db = drizzle(...);

    const prepared = db.select().from(customers).prepare();
    
    const res1 = prepared.all();
    const res2 = prepared.all();
    const res3 = prepared.all();
    ```
  </Tab> 
  <Tab>
    ```typescript copy {3}
    const db = drizzle(...);

    const prepared = db.select().from(customers).prepare();
    
    const res1 = await prepared.execute();
    const res2 = await prepared.execute();
    const res3 = await prepared.execute();
    ```
  </Tab> 
</Tabs>

## å ä½ç¬¦
æ¯å½“æ‚¨éœ€è¦åµŒå…¥åŠ¨æ€è¿è¡Œæ—¶å€¼æ—¶ - æ‚¨å¯ä»¥ä½¿ç”¨ `sql.placeholder(...)` API
<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore"]}>
  <Tab>
    ```ts {6,9-10,15,18}
    import { sql } from "drizzle-orm";

    const p1 = db
      .select()
      .from(customers)
      .where(eq(customers.id, sql.placeholder('id')))
      .prepare("p1")

    await p1.execute({ id: 10 }) // SELECT * FROM customers WHERE id = 10
    await p1.execute({ id: 12 }) // SELECT * FROM customers WHERE id = 12

    const p2 = db
      .select()
      .from(customers)
      .where(sql`lower(${customers.name}) like ${sql.placeholder('name')}`)
      .prepare("p2");

    await p2.execute({ name: '%an%' }) // SELECT * FROM customers WHERE name ilike '%an%'
    ```
  </Tab>
  <Tab>
    ```ts copy {6,9-10,15,18}
    import { sql } from "drizzle-orm";

    const p1 = db
      .select()
      .from(customers)
      .where(eq(customers.id, sql.placeholder('id')))
      .prepare()

    await p1.execute({ id: 10 }) // SELECT * FROM customers WHERE id = 10
    await p1.execute({ id: 12 }) // SELECT * FROM customers WHERE id = 12

    const p2 = db
      .select()
      .from(customers)
      .where(sql`lower(${customers.name}) like ${sql.placeholder('name')}`)
      .prepare();

    await p2.execute({ name: '%an%' }) // SELECT * FROM customers WHERE name ilike '%an%'
    ```
  </Tab>
  <Tab>
    ```ts copy {6,9-10,15,18}
    import { sql } from "drizzle-orm";

    const p1 = db
      .select()
      .from(customers)
      .where(eq(customers.id, sql.placeholder('id')))
      .prepare()

    p1.get({ id: 10 }) // SELECT * FROM customers WHERE id = 10
    p1.get({ id: 12 }) // SELECT * FROM customers WHERE id = 12

    const p2 = db
      .select()
      .from(customers)
      .where(sql`lower(${customers.name}) like ${sql.placeholder('name')}`)
      .prepare();

    p2.all({ name: '%an%' }) // SELECT * FROM customers WHERE name ilike '%an%'
    ```
  </Tab> 
  <Tab>
    ```ts copy {6,9-10,15,18}
    import { sql } from "drizzle-orm";

    const p1 = db
      .select()
      .from(customers)
      .where(eq(customers.id, sql.placeholder('id')))
      .prepare()

    await p1.execute({ id: 10 }) // SELECT * FROM customers WHERE id = 10
    await p1.execute({ id: 12 }) // SELECT * FROM customers WHERE id = 12

    const p2 = db
      .select()
      .from(customers)
      .where(sql`lower(${customers.name}) like ${sql.placeholder('name')}`)
      .prepare();

    await p2.execute({ name: '%an%' }) // SELECT * FROM customers WHERE name ilike '%an%'
    ```
  </Tab>
</Tabs>


Source: https://drizzle.zhcndoc.com/docs/perf-serverless

# Drizzle æ— æœåŠ¡å™¨æ€§èƒ½

ä½¿ç”¨ `æ— æœåŠ¡å™¨å‡½æ•°`ï¼ˆå¦‚ AWS Lambda æˆ– Vercel Server Functionsï¼Œå®ƒä»¬åŸºäº AWS Lambdaï¼‰å¯ä»¥è·å¾—å·¨å¤§çš„å¥½å¤„ï¼Œ
å› ä¸ºå®ƒä»¬å¯ä»¥è¿è¡Œæœ€é•¿è¾¾ 15 åˆ†é’Ÿï¼Œå¹¶ä¸”å¯ä»¥é‡ç”¨æ•°æ®åº“è¿æ¥å’Œé¢„ç¼–è¯‘è¯­å¥ã€‚

å¦ä¸€æ–¹é¢ï¼Œ`è¾¹ç¼˜å‡½æ•°` åœ¨è¢«è°ƒç”¨åå¾€å¾€ä¼šç«‹å³æ¸…ç†ï¼Œå› æ­¤å‡ ä¹æ²¡æœ‰æ€§èƒ½ä¼˜åŠ¿ã€‚

è¦é‡ç”¨æ‚¨çš„æ•°æ®åº“è¿æ¥å’Œé¢„ç¼–è¯‘è¯­å¥ï¼Œæ‚¨åªéœ€åœ¨å¤„ç†ç¨‹åºä½œç”¨åŸŸä¹‹å¤–å£°æ˜å®ƒä»¬ï¼š
```ts
const databaseConnection = ...;
const db = drizzle({ client: databaseConnection });
const prepared = db.select().from(...).prepare();

// AWS å¤„ç†ç¨‹åº
export const handler = async (event: APIGatewayProxyEvent) => {
  return prepared.execute();
}
```


Source: https://drizzle.zhcndoc.com/docs/prisma

import Npm from '@mdx/Npm.astro';
import Tabs from '@mdx/Tabs.astro';
import Tab from '@mdx/Tab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Steps from '@mdx/Steps.astro';

# Drizzle æ‰©å±•ç”¨äº Prisma

å¦‚æœæ‚¨æœ‰ä¸€ä¸ªç°æœ‰çš„ Prisma é¡¹ç›®å¹¶æƒ³å°è¯• Drizzle æˆ–é€æ­¥é‡‡ç”¨å®ƒï¼Œ
æ‚¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ä¼˜è´¨æ‰©å±•ï¼Œè¯¥æ‰©å±•ä¼šå°† Drizzle API æ·»åŠ åˆ°æ‚¨çš„ Prisma å®¢æˆ·ç«¯ä¸­ã€‚
å®ƒå°†å…è®¸æ‚¨åœ¨ä½¿ç”¨ç°æœ‰æ•°æ®åº“è¿æ¥çš„åŒæ—¶ï¼Œç»“åˆä½¿ç”¨ Drizzle å’Œ Prisma æŸ¥è¯¢ã€‚

## å¦‚ä½•ä½¿ç”¨

<Steps>
#### å®‰è£…ä¾èµ–

æ‚¨éœ€è¦å®‰è£… Drizzle æœ¬èº«å’Œä¸€ä¸ªç”Ÿæˆå™¨åŒ…ï¼Œè¯¥åŒ…å°†ä» Prisma æ¨¡å¼ç”Ÿæˆ Drizzle æ¨¡å¼ã€‚
<Npm>
drizzle-orm@latest
-D drizzle-prisma-generator
</Npm>

#### æ›´æ–°æ‚¨çš„ Prisma æ¨¡å¼

å°† Drizzle ç”Ÿæˆå™¨æ·»åŠ åˆ°æ‚¨çš„ Prisma æ¨¡å¼ä¸­ã€‚`output` æ˜¯ç”Ÿæˆçš„ Drizzle æ¨¡å¼ TS æ–‡ä»¶å°†æ”¾ç½®çš„è·¯å¾„ã€‚
```prisma copy filename="schema.prisma" {5-8}
generator client {
  provider = "prisma-client-js"
}

generator drizzle {
  provider = "drizzle-prisma-generator"
  output   = "./drizzle" // ç”Ÿæˆçš„ Drizzle è¡¨çš„æ”¾ç½®ä½ç½®
}

// å…¶ä½™ Prisma æ¨¡å¼

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}

...
```

#### ç”Ÿæˆ Drizzle æ¨¡å¼

```bash
prisma generate
```

#### å°† Drizzle æ‰©å±•æ·»åŠ åˆ°æ‚¨çš„ Prisma å®¢æˆ·ç«¯

<CodeTabs items={["PostgreSQL", "MySQL", "SQLite"]}>
<CodeTab>
```ts copy
import { PrismaClient } from '@prisma/client';
import { drizzle } from 'drizzle-orm/prisma/pg';

const prisma = new PrismaClient().$extends(drizzle());
```
</CodeTab>
<CodeTab>
```ts copy
import { PrismaClient } from '@prisma/client';
import { drizzle } from 'drizzle-orm/prisma/mysql';

const prisma = new PrismaClient().$extends(drizzle());
```
</CodeTab>
<CodeTab>
```ts copy
import { PrismaClient } from '@prisma/client';
import { drizzle } from 'drizzle-orm/prisma/sqlite';

const prisma = new PrismaClient().$extends(drizzle());
```
</CodeTab>
</CodeTabs>

#### é€šè¿‡ `prisma.$drizzle` è¿è¡Œ Drizzle æŸ¥è¯¢ âœ¨

ä¸ºäº†ä½¿ç”¨ Drizzle æŸ¥è¯¢ç”Ÿæˆå™¨ï¼Œæ‚¨éœ€è¦å¯¹ Drizzle è¡¨çš„å¼•ç”¨ã€‚
æ‚¨å¯ä»¥ä»æ‚¨åœ¨ç”Ÿæˆå™¨é…ç½®ä¸­æŒ‡å®šçš„è¾“å‡ºè·¯å¾„å¯¼å…¥å®ƒä»¬ã€‚

```ts copy
import { User } from './drizzle';

await prisma.$drizzle.insert().into(User).values({ email: 'sorenbs@drizzle.team', name: 'SÃ¸ren' });
const users = await prisma.$drizzle.select().from(User);
```

</Steps>

## é™åˆ¶

- ç”±äº [Prisma é©±åŠ¨ç¨‹åºçš„é™åˆ¶](https://github.com/prisma/prisma/issues/17576)ï¼Œä¸æ”¯æŒ [å…³ç³»æŸ¥è¯¢](/docs/rqb)ã€‚å› æ­¤ï¼ŒPrisma æ— æ³•ä»¥æ•°ç»„æ ¼å¼è¿”å›æŸ¥è¯¢ç»“æœï¼Œè€Œè¿™å¯¹äºå…³ç³»æŸ¥è¯¢çš„å·¥ä½œæ˜¯å¿…éœ€çš„ã€‚
- åœ¨ SQLite ä¸­ï¼Œ`.values()`ï¼ˆä¾‹å¦‚ `await db.select().from(table).values()`ï¼‰ä¸å—æ”¯æŒï¼ŒåŸå› ä¸ä¸Šè¿°ç›¸åŒã€‚
- [é¢„å¤„ç†è¯­å¥](/docs/perf-queries#prepared-statement) çš„æ”¯æŒæœ‰é™ - `.prepare()` ä»…ä¼šåœ¨ Drizzle ç«¯æ„å»º SQL æŸ¥è¯¢ï¼Œå› ä¸ºæ²¡æœ‰ç”¨äºé¢„å¤„ç†æŸ¥è¯¢çš„ Prisma APIã€‚


Source: https://drizzle.zhcndoc.com/docs/query-utils

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import $count from '@mdx/$count.mdx';

# Drizzle æŸ¥è¯¢å·¥å…·

### $count
<$count/>

Source: https://drizzle.zhcndoc.com/docs/quick

import Npm from "@mdx/Npm.astro";

# å¿«é€Ÿå¼€å§‹
è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªå¿«é€Ÿå¯åŠ¨çš„åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨ `PostgreSQL` + `postgresjs` å¹¶è¿è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè¿ç§»ã€‚

æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å®‰è£… `drizzle-orm` å’Œ `drizzle-kit`ï¼š

<Npm>
drizzle-orm postgres
-D drizzle-kit
</Npm>

ç°åœ¨è®©æˆ‘ä»¬å£°æ˜æˆ‘ä»¬çš„ `schema.ts`ï¼š

```plaintext {4}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ...
 â”œ ğŸ“‚ src
 â”‚ â”” ğŸ“œ schema.ts
 â”” ğŸ“œ package.json
```
```ts copy filename="schema.ts"
import { serial, text, timestamp, pgTable } from "drizzle-orm/pg-core";

export const user = pgTable("user", {
  id: serial("id"),
  name: text("name"),
  email: text("email"),
  password: text("password"),
  role: text("role").$type<"admin" | "customer">(),
  createdAt: timestamp("created_at"),
  updatedAt: timestamp("updated_at"),
});
```

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ  drizzle é…ç½®æ–‡ä»¶ï¼š
```plaintext {4}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ...
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/schema.ts",
  out: "./drizzle",
});
```

å°† `generate` å’Œ `migrate` å‘½ä»¤æ·»åŠ åˆ° `package.json`ï¼Œå¹¶è¿è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè¿ç§»ç”Ÿæˆï¼š

```json filename="package.json" {5,6}
{
  "name": "ç¬¬ä¸€æ¬¡?",
  "version": "0.0.1",
  "scripts": {
    "generate": "drizzle-kit generate",
    "migrate": "drizzle-kit migrate"
  }, 
}
```
```shell filename="terminal"
$ npm run generate
...

[âœ“] Your SQL migration file âœ drizzle/20242409125510_pale_mister_fear/migration.sql ğŸš€
```

å®Œæˆï¼æˆ‘ä»¬ç°åœ¨æœ‰äº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª SQL è¿ç§»æ–‡ä»¶ ğŸ¥³
```plaintext {4}
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ drizzle
 â”‚ â”œ ğŸ“‚ 20242409125510_pale_mister_fear
 â”œ ğŸ“‚ src
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```
ç°åœ¨è®©æˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªè¿ç§»è¿è¡Œåˆ°æ•°æ®åº“ä¸­ï¼š

```shell filename="terminal"
$ npm run migrate
```

å°±æ˜¯è¿™æ ·ï¼Œå„ä½ï¼  

**æˆ‘ä¸ªäººçš„ç¥è´º ğŸ‰**

Source: https://drizzle.zhcndoc.com/docs/read-replicas

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';

# é˜…è¯»å‰¯æœ¬

å½“æ‚¨çš„é¡¹ç›®æ¶‰åŠä¸€ç»„è¯»å–å‰¯æœ¬å®ä¾‹ï¼Œå¹¶ä¸”æ‚¨éœ€è¦ä¸€ç§ä¾¿æ·çš„æ–¹æ³•æ¥ç®¡ç†æ¥è‡ªè¯»å–å‰¯æœ¬çš„ 
SELECT æŸ¥è¯¢ï¼Œä»¥åŠåœ¨ä¸»å®ä¾‹ä¸Šæ‰§è¡Œåˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°æ“ä½œæ—¶ï¼Œæ‚¨å¯ä»¥åœ¨ Drizzle ä¸­åˆ©ç”¨ 
`withReplicas()` å‡½æ•°ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
<Tab>
```ts copy
import { sql } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/node-postgres';
import { boolean, jsonb, pgTable, serial, text, timestamp, withReplicas } from 'drizzle-orm/pg-core';

const usersTable = pgTable('users', {
	id: serial('id' as string).primaryKey(),
	name: text('name').notNull(),
	verified: boolean('verified').notNull().default(false),
	jsonb: jsonb('jsonb').$type<string[]>(),
	createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});

const primaryDb = drizzle("postgres://user:password@host:port/primary_db");
const read1 = drizzle("postgres://user:password@host:port/read_replica_1");
const read2 = drizzle("postgres://user:password@host:port/read_replica_2");

const db = withReplicas(primaryDb, [read1, read2]);
```
</Tab>
<Tab>
```ts copy
import { drizzle } from "drizzle-orm/mysql2";
import mysql from "mysql2/promise";
import { boolean, mysqlTable, serial, text, withReplicas } from 'drizzle-orm/mysql-core';

const usersTable = mysqlTable('users', {
	id: serial('id' as string).primaryKey(),
	name: text('name').notNull(),
	verified: boolean('verified').notNull().default(false),
});

const primaryClient = await mysql.createConnection({
  host: "host",
  user: "user",
  database: "primary_db",
})
const primaryDb = drizzle({ client: primaryClient });

const read1Client = await mysql.createConnection({
  host: "host",
  user: "user",
  database: "read_1",
})
const read1 = drizzle({ client: read1Client });

const read2Client = await mysql.createConnection({
  host: "host",
  user: "user",
  database: "read_2",
})
const read2 = drizzle({ client: read2Client });

const db = withReplicas(primaryDb, [read1, read2]);
```
</Tab>
<Tab>
```ts copy
import { sql } from 'drizzle-orm';
import { sqliteTable, int, text, withReplicas } from 'drizzle-orm/sqlite-core';
import { createClient } from '@libsql/client';
import { drizzle } from 'drizzle-orm/libsql';

const usersTable = sqliteTable('users', {
	id: int('id' as string).primaryKey(),
	name: text('name').notNull(),
});

const primaryDb = drizzle({ client: createClient({ url: 'DATABASE_URL', authToken: 'DATABASE_AUTH_TOKEN' }) });
const read1 = drizzle({ client: createClient({ url: 'DATABASE_URL', authToken: 'DATABASE_AUTH_TOKEN' }) });
const read2 = drizzle({ client: createClient({ url: 'DATABASE_URL', authToken: 'DATABASE_AUTH_TOKEN' }) });

const db = withReplicas(primaryDb, [read1, read2]);
```
</Tab>
<Tab>
```ts copy
import { drizzle } from "drizzle-orm/singlestore";
import mysql from "mysql2/promise";
import { boolean, singlestoreTable, serial, text, withReplicas } from 'drizzle-orm/singlestore-core';

const usersTable = singlestoreTable('users', {
	id: serial('id' as string).primaryKey(),
	name: text('name').notNull(),
	verified: boolean('verified').notNull().default(false),
});

const primaryClient = await mysql.createConnection({
  host: "host",
  user: "user",
  database: "primary_db",
})
const primaryDb = drizzle({ client: primaryClient });

const read1Client = await mysql.createConnection({
  host: "host",
  user: "user",
  database: "read_1",
})
const read1 = drizzle({ client: read1Client });

const read2Client = await mysql.createConnection({
  host: "host",
  user: "user",
  database: "read_2",
})
const read2 = drizzle({ client: read2Client });

const db = withReplicas(primaryDb, [read1, read2]);
```
</Tab>
<Tab>
```ts copy
import { sql } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/mssql-postgres';
import { boolean, mssqlTable, int, text, timestamp, withReplicas } from 'drizzle-orm/mssql-core';

const usersTable = mssqlTable('users', {
	id: int().primaryKey(),
	name: text().notNull(),
	verified: boolean().notNull().default(false),
	createdAt: timestamp('created_at').notNull(),
});

const primaryDb = drizzle("postgres://user:password@host:port/primary_db");
const read1 = drizzle("postgres://user:password@host:port/read_replica_1");
const read2 = drizzle("postgres://user:password@host:port/read_replica_2");

const db = withReplicas(primaryDb, [read1, read2]);
```
</Tab>
<Tab>
```ts copy
import { sql } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/cockroach';
import { boolean, jsonb, cockroachTable, int4, text, timestamp, withReplicas } from 'drizzle-orm/cockroach-core';

const usersTable = cockroachTable('users', {
	id: int4().primaryKey(),
	name: text().notNull(),
	verified: boolean().notNull().default(false),
	jsonb: jsonb().$type<string[]>(),
	createdAt: timestamp({ withTimezone: true }).notNull().defaultNow(),
});

const primaryDb = drizzle("postgres://user:password@host:port/primary_db");
const read1 = drizzle("postgres://user:password@host:port/read_replica_1");
const read2 = drizzle("postgres://user:password@host:port/read_replica_2");

const db = withReplicas(primaryDb, [read1, read2]);
```
</Tab>
</Tabs>

æ‚¨ç°åœ¨å¯ä»¥åƒä¹‹å‰ä¸€æ ·ä½¿ç”¨ `db` å®ä¾‹ã€‚
Drizzle å°†è‡ªåŠ¨å¤„ç†è¯»å–å‰¯æœ¬å’Œä¸»å®ä¾‹ä¹‹é—´çš„é€‰æ‹©ã€‚

```ts
// ä» read1 è¿æ¥æˆ– read2 è¿æ¥è¯»å–
await db.select().from(usersTable)

// ä½¿ç”¨ä¸»æ•°æ®åº“è¿›è¡Œåˆ é™¤æ“ä½œ
await db.delete(usersTable).where(eq(usersTable.id, 1))
```

æ‚¨å¯ä»¥ä½¿ç”¨ `$primary` é”®å¼ºåˆ¶å³ä½¿åœ¨è¯»å–æ“ä½œä¸­ä¹Ÿä½¿ç”¨ä¸»å®ä¾‹ã€‚

```ts
// ä»ä¸»å®ä¾‹è¯»å–
await db.$primary.select().from(usersTable);
```

ä½¿ç”¨ Drizzleï¼Œæ‚¨è¿˜å¯ä»¥æŒ‡å®šé€‰æ‹©è¯»å–å‰¯æœ¬çš„è‡ªå®šä¹‰é€»è¾‘ã€‚
æ‚¨å¯ä»¥åšå‡ºåŠ æƒå†³å®šæˆ–ä»»ä½•å…¶ä»–è‡ªå®šä¹‰é€‰æ‹©æ–¹æ³•ä»¥éšæœºé€‰æ‹©è¯»å–å‰¯æœ¬ã€‚
ä»¥ä¸‹æ˜¯é€‰æ‹©è¯»å–å‰¯æœ¬çš„è‡ªå®šä¹‰é€»è¾‘å®ç°ç¤ºä¾‹ï¼Œ
ç¬¬ä¸€ä¸ªå‰¯æœ¬è¢«é€‰æ‹©çš„æ¦‚ç‡ä¸º 70%ï¼Œ
ç¬¬äºŒä¸ªå‰¯æœ¬è¢«é€‰æ‹©çš„æ¦‚ç‡ä¸º 30%ã€‚

è¯·è®°ä½ï¼Œæ‚¨å¯ä»¥å®æ–½ä»»ä½•ç±»å‹çš„éšæœºé€‰æ‹©æ–¹æ³•æ¥é€‰æ‹©è¯»å–å‰¯æœ¬ã€‚

```ts
const db = withReplicas(primaryDb, [read1, read2], (replicas) => {
    const weight = [0.7, 0.3];
    let cumulativeProbability = 0;
    const rand = Math.random();

    for (const [i, replica] of replicas.entries()) {
      cumulativeProbability += weight[i]!;
      if (rand < cumulativeProbability) return replica;
    }
    return replicas[0]!
});

await db.select().from(usersTable)
```

Source: https://drizzle.zhcndoc.com/docs/relations-schema-declaration

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import SimpleLinkCards from '@mdx/SimpleLinkCards.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from '@mdx/Section.astro';
import Flex from "@mdx/Flex.astro"
import LinksList from "@mdx/LinksList.astro"

# Drizzle å…³ç³»åŸºç¡€çŸ¥è¯†

åœ¨æ•°æ®åº“é¢†åŸŸï¼Œå°¤å…¶æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå…³ç³»çš„æ¦‚å¿µæ˜¯ç»å¯¹åŸºç¡€çš„ã€‚  
æŠŠâ€œå…³ç³»â€æƒ³è±¡æˆä¸åŒæ•°æ®ä¹‹é—´çš„è¿æ¥å’Œè”ç³»ã€‚å°±åƒç°å®ç”Ÿæ´»ä¸­ï¼Œäººä»¬å½¼æ­¤ä¹‹é—´æœ‰å…³ç³»ï¼Œ  
ç‰©ä½“ä¸ç±»åˆ«ç›¸å…³è”ä¸€æ ·ï¼Œæ•°æ®åº“ä½¿ç”¨å…³ç³»æ¥å»ºæ¨¡ä¸åŒç±»å‹çš„ä¿¡æ¯å¦‚ä½•è¿æ¥å¹¶ååŒå·¥ä½œã€‚

### è§„èŒƒåŒ–
è§„èŒƒåŒ–æ˜¯ç»„ç»‡æ•°æ®åº“ä¸­æ•°æ®çš„è¿‡ç¨‹ï¼Œæ—¨åœ¨å‡å°‘å†—ä½™ï¼ˆé‡å¤ï¼‰å¹¶æå‡æ•°æ®å®Œæ•´æ€§ï¼ˆå‡†ç¡®æ€§å’Œä¸€è‡´æ€§ï¼‰ã€‚  
å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ•´ç†æ‚ä¹±çš„æ–‡ä»¶æŸœã€‚ä¸æ˜¯æ‰€æœ‰çš„æ–‡ä»¶éƒ½å †æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œ  
è€Œæ˜¯æœ‰æ¡ç†åœ°åˆ†ç±»æ•´ç†æˆé€»è¾‘æ¸…æ™°çš„æ–‡ä»¶å¤¹å’Œç±»åˆ«ï¼Œä½¿å¾—æŸ¥æ‰¾å’Œç®¡ç†æ›´åŠ ç®€å•ã€‚

<Callout collapsed="ä¸ºä»€ä¹ˆè§„èŒƒåŒ–å¾ˆé‡è¦ï¼Ÿ">
- **å‡å°‘æ•°æ®å†—ä½™**ï¼šæƒ³è±¡ä¸€ä¸‹æ¯æ¬¡å®¢æˆ·ä¸‹è®¢å•æ—¶éƒ½å­˜å‚¨å®¢æˆ·åœ°å€ã€‚å¦‚æœåœ°å€å˜äº†ï¼Œä½ ä¸å¾—ä¸åœ¨å¤šä¸ªåœ°æ–¹æ›´æ–°å®ƒï¼è§„èŒƒåŒ–å¸®åŠ©ä½ åªåœ¨ä¸€ä¸ªåœ°æ–¹å­˜å‚¨ä¿¡æ¯ï¼Œç„¶åä»å…¶ä»–åœ°æ–¹å¼•ç”¨ï¼Œæœ€å¤§é™åº¦å‡å°‘é‡å¤ã€‚
- **æå‡æ•°æ®å®Œæ•´æ€§**ï¼šè¾ƒå°‘å†—ä½™æ„å‘³ç€ä¸€è‡´æ€§é”™è¯¯çš„å¯èƒ½æ€§æ›´å°ã€‚å¦‚æœä½ æ›´æ–°äº†åœ°å€ï¼Œæ‰€æœ‰éœ€è¦çš„åœ°æ–¹éƒ½ä¼šåŒæ­¥æ›´æ–°ã€‚
- **é˜²æ­¢å¼‚å¸¸**ï¼šè§„èŒƒåŒ–æœ‰åŠ©äºé¿å…å¦‚ä¸‹é—®é¢˜ï¼š
  1. **æ’å…¥å¼‚å¸¸**ï¼šå½“ä½ ç¼ºå°‘ç›¸å…³ä¿¡æ¯æ—¶ï¼Œéš¾ä»¥æ·»åŠ æ–°æ•°æ®ã€‚
  2. **æ›´æ–°å¼‚å¸¸**ï¼šå¿…é¡»åœ¨å¤šè¡Œä¸­é‡å¤æ›´æ–°ç›¸åŒä¿¡æ¯ã€‚
  3. **åˆ é™¤å¼‚å¸¸**ï¼šåˆ é™¤çœ‹ä¼¼æ— å…³çš„å†…å®¹æ—¶æ„å¤–ä¸¢å¤±æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚
- **æ›´æ˜“ç†è§£å’Œç»´æŠ¤**ï¼šè§„èŒƒåŒ–åçš„æ•°æ®åº“ç»“æ„é€šå¸¸æ›´ç¬¦åˆé€»è¾‘ï¼Œæ›´æ˜“äºç†è§£ã€æŸ¥è¯¢å’Œä¿®æ”¹ã€‚
</Callout>

è§„èŒƒåŒ–é€šå¸¸ç”¨â€œèŒƒå¼â€ï¼ˆ1NFï¼Œ2NFï¼Œ3NFç­‰ï¼‰è¿›è¡Œæè¿°ã€‚è™½ç„¶ç»†èŠ‚ä¼šæ¯”è¾ƒæŠ€æœ¯åŒ–ï¼Œä½†æ ¸å¿ƒç†å¿µå¾ˆç›´æ¥ï¼š

#### ç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰ï¼š`åŸå­å€¼`

**ç›®æ ‡**ï¼šæ¯ä¸ªåˆ—åº”ä¿å­˜å•ä¸€ã€ä¸å¯åˆ†å‰²çš„å€¼ã€‚å•å…ƒæ ¼å†…ä¸åº”æœ‰é‡å¤çš„æ•°æ®ç»„ã€‚

**ç¤ºä¾‹**ï¼šä¸ä½¿ç”¨ä¸€ä¸ªå­˜å‚¨ `123 Main St, City, USA` çš„ `address` åˆ—ï¼Œ  
è€Œæ˜¯æ‹†åˆ†æˆå¤šä¸ªåˆ—ï¼š`street_address`ã€`city`ã€`state`ã€`zip_code`ã€‚

```sql
-- éè§„èŒƒåŒ–ï¼ˆè¿å 1NFï¼‰
CREATE TABLE Customers_Unnormalized (
    customer_id INT PRIMARY KEY,
    name VARCHAR(255),
    address VARCHAR(255) -- é—®é¢˜ï¼šä¸€ä¸ªåˆ—ä¸­å­˜å‚¨å¤šä¸ªä¿¡æ¯
);

-- è§„èŒƒåŒ–åˆ° 1NF
CREATE TABLE Customers_1NF (
    customer_id INT PRIMARY KEY,
    name VARCHAR(255),
    street_address VARCHAR(255),
    city VARCHAR(255),
    state VARCHAR(255),
    zip_code VARCHAR(10)
);
```

#### ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰ï¼š`æ¶ˆé™¤å¯¹éƒ¨åˆ†ä¸»é”®çš„å†—ä½™æ•°æ®ä¾èµ–`

**ç›®æ ‡**ï¼šå½“è¡¨æœ‰å¤åˆä¸»é”®ï¼ˆç”±ä¸¤ä¸ªæˆ–å¤šä¸ªåˆ—ç»„æˆï¼‰æ—¶ï¼Œ2NF ç¡®ä¿æ‰€æœ‰éé”®å±æ€§å®Œå…¨ä¾èµ–æ•´ä¸ªå¤åˆä¸»é”®ï¼Œè€Œä¸æ˜¯å…¶ä¸­éƒ¨åˆ†ã€‚

å‡è®¾æœ‰ä¸€ä¸ªåä¸º `order_items` çš„è¡¨ï¼Œè¯¥è¡¨ç›‘æ§è®¢å•ä¸­çš„å•†å“ï¼Œå¤åˆä¸»é”®ä¸º (`order_id`, `product_id`)ï¼Œ  
å› ä¸ºåŒä¸€ä¸ªè®¢å•å¯èƒ½å«æœ‰å¤šä¸ªç›¸åŒå•†å“ï¼ˆè™½ç„¶åœ¨è¿™é‡Œä¸ºç®€åŒ–èµ·è§ï¼Œæ¯ä¸ªå•†å“åœ¨è®¢å•ä¸­åªå‡ºç°ä¸€æ¬¡ï¼Œä½†å¤åˆé”®é€»è¾‘ä»ç„¶é€‚ç”¨ï¼‰ã€‚

<Callout collapsed="å±•å¼€æŸ¥çœ‹å¯è§†åŒ–ç¤ºä¾‹">
```sql
CREATE TABLE OrderItems_Unnormalized (
    order_id INT,
    product_id VARCHAR(10),
    product_name VARCHAR(100),
    product_price DECIMAL(10, 2),
    quantity INT,
    order_date DATE,
    PRIMARY KEY (order_id, product_id) -- å¤åˆä¸»é”®
);

INSERT INTO OrderItems_Unnormalized (order_id, product_id, product_name, product_price, quantity, order_date) VALUES
(101, 'A123', 'Laptop', 1200.00, 1, '2023-10-27'),
(101, 'B456', 'Mouse', 25.00, 2, '2023-10-27'),
(102, 'A123', 'Laptop', 1200.00, 1, '2023-10-28'),
(103, 'C789', 'Keyboard', 75.00, 1, '2023-10-29');
```
```
+------------------------------------------------------------------------------------+
| OrderItems_Unnormalized                                                            |
+------------------------------------------------------------------------------------+
| PK (order_id, product_id) | product_name | product_price | quantity | order_date   |
+------------------------------------------------------------------------------------+
| 101, A123               | Laptop       | 1200.00       | 1        | 2023-10-27     |
| 101, B456               | Mouse        | 25.00         | 2        | 2023-10-27     |
| 102, A123               | Laptop       | 1200.00       | 1        | 2023-10-28     |
| 103, C789               | Keyboard     | 75.00         | 1        | 2023-10-29     |
+------------------------------------------------------------------------------------+
```
</Callout>

**é—®é¢˜**ï¼šæ³¨æ„åˆ°ï¼Œ`product_name` å’Œ `product_price` æ¯æ¬¡åŒä¸€ `product_id` åœ¨ä¸åŒè®¢å•å‡ºç°æ—¶éƒ½ä¼šè¢«é‡å¤ã€‚  
è¿™äº›å±æ€§åªä¾èµ–äº `product_id`ï¼ˆå¤åˆä¸»é”®çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå¤åˆä¸»é”®ã€‚è¿™æ˜¯éƒ¨åˆ†ä¾èµ–ã€‚

ä¸ºäº†è¾¾åˆ° 2NFï¼Œéœ€è¦æŠŠè¿™äº›éƒ¨åˆ†ä¾èµ–çš„å±æ€§ï¼ˆ`product_name`ï¼Œ`product_price`ï¼‰ç§»åˆ°ä¸€ä¸ªæ–°è¡¨ä¸­ï¼Œ  
å®ƒä»¬å®Œå…¨ä¾èµ–äºè¯¥æ–°è¡¨çš„ä¸»é”®ã€‚

<Callout collapsed="è§„èŒƒåŒ–åˆ° 2NFï¼šå¯è§†åŒ–è¯´æ˜">
```
+-------------------+     1:M     +---------------------------+
| Products          | <---------- | OrderItems_2NF            |
+-------------------+             +---------------------------+
| PK product_id     |             | PK (order_id, product_id) |
| product_name      |             | quantity                  |
| product_price     |             | order_date                |
+-------------------+             | FK product_id             |
                                  +---------------------------+
```
```sql
CREATE TABLE Products (
    product_id VARCHAR(10) PRIMARY KEY,
    product_name VARCHAR(100),
    product_price DECIMAL(10, 2)
);

CREATE TABLE OrderItems_2NF (
    order_id INT,
    product_id VARCHAR(10),
    quantity INT,
    order_date DATE,
    PRIMARY KEY (order_id, product_id), -- ä¿æŒå¤åˆä¸»é”®
    FOREIGN KEY (product_id) REFERENCES Products(product_id) -- å¤–é”®å…³è” Products
);

-- æ’å…¥ Products æ•°æ®
INSERT INTO Products (product_id, product_name, product_price) VALUES
('A123', 'Laptop', 1200.00),
('B456', 'Mouse', 25.00),
('C789', 'Keyboard', 75.00);

-- æ’å…¥ OrderItems_2NF æ•°æ®ï¼ˆå¼•ç”¨ Productsï¼‰
INSERT INTO OrderItems_2NF (order_id, product_id, quantity, order_date) VALUES
(101, 'A123', 1, '2023-10-27'),
(101, 'B456', 2, '2023-10-27'),
(102, 'A123', 1, '2023-10-28'),
(103, 'C789', 1, '2023-10-29');
```
</Callout>

#### ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼š`æ¶ˆé™¤å¯¹éé”®å±æ€§çš„å†—ä½™æ•°æ®ä¾èµ–`

**ç›®æ ‡**ï¼šåˆ é™¤å¯¹å…¶ä»–éé”®å±æ€§çš„ä¾èµ–ã€‚è¿™æ˜¯æ¶ˆé™¤ä¼ é€’ä¾èµ–ã€‚

**é—®é¢˜**ï¼šå‡è®¾æœ‰ä¸€ä¸ª `suppliers` è¡¨ï¼Œæˆ‘ä»¬å­˜å‚¨ä¾›åº”å•†ä¿¡æ¯ï¼ŒåŒ…å« `zip_code`ã€`city` å’Œ `state`ã€‚`supplier_id` æ˜¯ä¸»é”®ã€‚

<Callout collapsed="">
```sql
CREATE TABLE suppliers (
    supplier_id VARCHAR(10) PRIMARY KEY,
    supplier_name VARCHAR(255),
    zip_code VARCHAR(10),
    city VARCHAR(100),
    state VARCHAR(50)
);

INSERT INTO suppliers (supplier_id, supplier_name, zip_code, city, state) VALUES
('S1', 'Acme Corp', '12345', 'Anytown', 'NY'),
('S2', 'Beta Inc', '67890', 'Otherville', 'CA'),
('S3', 'Gamma Ltd', '12345', 'Anytown', 'NY');
```
```
+---------------------------------------------------------------+
| suppliers                                                     |
+---------------------------------------------------------------+
| PK supplier_id | supplier_name | zip_code | city      | state |
+---------------------------------------------------------------+
| S1             | Acme Corp     | 12345    | Anytown    | NY   |
| S2             | Beta Inc      | 67890    | Otherville | CA   |
| S3             | Gamma Ltd     | 12345    | Anytown    | NY   |
+---------------------------------------------------------------+
```
</Callout>

**è§£å†³æ–¹æ¡ˆ**ï¼šä¸ºè¾¾åˆ° 3NFï¼Œæˆ‘ä»¬æŠŠä¾èµ–äºéé”®å±æ€§ï¼ˆ`city`ï¼Œ`state` ä¾èµ–äº `zip_code`ï¼‰çš„å­—æ®µç§»åˆ°ç‹¬ç«‹è¡¨ï¼Œ  
è¯¥è¡¨ä»¥éé”®å±æ€§æœ¬èº«ï¼ˆ`zip_code`ï¼‰ä½œä¸ºä¸»é”®ã€‚

<Callout collapsed="è§„èŒƒåŒ–åˆ° 3NFï¼šå¯è§†åŒ–è¯´æ˜">
```
+-------------------+     1:M     +--------------------+
| zip_codes         | <---------- | suppliers          |
+-------------------+             +--------------------+
| PK zip_code       |             | PK supplier_id     |
| city              |             | supplier_name      |
| state             |             | FK zip_code        |
+-------------------+             +--------------------+
```
```sql
CREATE TABLE zip_codes (
    zip_code VARCHAR(10) PRIMARY KEY,
    city VARCHAR(100),
    state VARCHAR(50)
);

CREATE TABLE suppliers (
    supplier_id VARCHAR(10) PRIMARY KEY,
    supplier_name VARCHAR(255),
    zip_code VARCHAR(10), -- å¤–é”®å…³è” zip_codes
    FOREIGN KEY (zip_code) REFERENCES zip_codes(zip_code)
);

-- æ’å…¥ zip_codes æ•°æ®
INSERT INTO zip_codes (zip_code, city, state) VALUES
('12345', 'Anytown', 'NY'),
('67890', 'Otherville', 'CA');

-- æ’å…¥ suppliers æ•°æ®ï¼ˆå¼•ç”¨ zip_codesï¼‰
INSERT INTO suppliers (supplier_id, supplier_name, zip_code) VALUES
('S1', 'Acme Corp', '12345'),
('S2', 'Beta Inc', '67890'),
('S3', 'Gamma Ltd', '12345');
```
</Callout>

<Callout title="å€¼å¾—äº†è§£">
è¿˜æœ‰å…¶ä»–èŒƒå¼ï¼Œå¦‚ `4NF`ã€`5NF`ã€`6NF`ã€`EKNF`ã€`ETNF` å’Œ `DKNF`ã€‚è¿™é‡Œæš‚ä¸å±•å¼€ä»‹ç»ï¼Œ  
æˆ‘ä»¬å°†åœ¨æ•™ç¨‹å’ŒæŒ‡å—éƒ¨åˆ†ä¸ºå®ƒä»¬ä¸“é—¨åˆ¶ä½œç³»åˆ—æ•™ç¨‹ã€‚
</Callout>

### æ•°æ®åº“å…³ç³»  
#### ä¸€å¯¹ä¸€å…³ç³»

ä¸€å¯¹ä¸€å…³ç³»ä¸­ï¼Œ`è¡¨ A` ä¸­çš„æ¯æ¡è®°å½•æœ€å¤šå’Œ `è¡¨ B` ä¸­ä¸€æ¡è®°å½•ç›¸å…³è”ï¼Œä¸”åè¿‡æ¥ä¹Ÿç›¸åŒï¼Œ  
æ˜¯éå¸¸ç›´æ¥ã€ä¸€å¯¹ä¸€çš„é…å¯¹å…³ç³»ã€‚

<Callout collapsed="ä½¿ç”¨åœºæ™¯ä¸ç¤ºä¾‹">
1. **ç”¨æˆ·æ¡£æ¡ˆå’Œç”¨æˆ·è´¦æˆ·ç»†èŠ‚**ï¼šæ¯”å¦‚ä¸€ä¸ªç½‘ç«™ã€‚æ¯ä¸ªç”¨æˆ·è´¦æˆ·ï¼ˆUsers è¡¨ï¼‰å¯èƒ½å¯¹åº”å”¯ä¸€ä¸€ä¸ªç”¨æˆ·æ¡£æ¡ˆï¼ˆUserProfiles è¡¨ï¼‰ï¼Œå­˜å‚¨è¯¦ç»†ä¿¡æ¯ã€‚  
2. **å‘˜å·¥å’Œåœè½¦ä½**ï¼šEmployees è¡¨å’Œ ParkingSpaces è¡¨ã€‚æ¯ä¸ªå‘˜å·¥æœ€å¤šåˆ†é…ä¸€ä¸ªåœè½¦ä½ï¼Œä¸”æ¯ä¸ªåœè½¦ä½æœ€å¤šåˆ†é…ç»™ä¸€åå‘˜å·¥ã€‚  
3. **æ‹†åˆ†è¡¨è¿›è¡Œç»„ç»‡**ï¼šæœ‰æ—¶ä½ å¯èƒ½å°†ä¸€ä¸ªå¾ˆå®½çš„è¡¨æ‹†æˆä¸¤ä¸ªè¡¨ä»¥ä¾¿ç®¡ç†æˆ–å®‰å…¨ï¼Œä¿æŒå®ƒä»¬ä¹‹é—´ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚

```
è¡¨ Aï¼ˆä¸€ç«¯ï¼‰           è¡¨ Bï¼ˆä¸€ç«¯ï¼‰
+---------+           +---------+
| PK (A)  | <-------> | FK (A)  | ï¼ˆå¤–é”®å¼•ç”¨è¡¨ Aï¼‰
| ...     |           | ...     |
+---------+           +---------+
```
</Callout>

#### ä¸€å¯¹å¤šå…³ç³»

ä¸€å¯¹å¤šå…³ç³»ä¸­ï¼Œ`è¡¨ A` çš„ä¸€æ¡è®°å½•å¯ä»¥å…³è” `è¡¨ B` çš„å¤šæ¡è®°å½•ï¼Œ  
ä½† `è¡¨ B` çš„ä¸€æ¡è®°å½•æœ€å¤šå…³è” `è¡¨ A` çš„ä¸€æ¡è®°å½•ã€‚ç±»ä¼¼â€œçˆ¶å­â€å…³ç³»ã€‚

<Callout collapsed="ä½¿ç”¨åœºæ™¯ä¸ç¤ºä¾‹">
1. **å®¢æˆ·å’Œè®¢å•**ï¼šä¸€ä¸ªå®¢æˆ·å¯ä»¥ä¸‹å¤šä¸ªè®¢å•ï¼Œä½†æ¯ä¸ªè®¢å•åªå±äºä¸€ä¸ªå®¢æˆ·ã€‚  
2. **ä½œè€…å’Œä¹¦ç±**ï¼šä¸€ä¸ªä½œè€…å¯ä»¥å†™å¤šæœ¬ä¹¦ï¼Œä½†ï¼ˆç®€åŒ–èµ·è§ï¼‰æ¯æœ¬ä¹¦åªæœ‰ä¸€ä¸ªä¸»ä½œè€…ã€‚  
3. **éƒ¨é—¨å’Œå‘˜å·¥**ï¼šä¸€ä¸ªéƒ¨é—¨æœ‰å¤šä¸ªå‘˜å·¥ï¼Œä½†æ¯ä¸ªå‘˜å·¥åªå±äºä¸€ä¸ªéƒ¨é—¨ã€‚

```
è¡¨ Aï¼ˆä¸€ç«¯ï¼‰           è¡¨ Bï¼ˆå¤šç«¯ï¼‰
+---------+           +---------+
| PK (A)  | --------> | FK (A)  | ï¼ˆå¤–é”®å¼•ç”¨è¡¨ Aï¼‰
| ...     |           | ...     |
+---------+           +---------+
     ï¼ˆä¸€ï¼‰               ï¼ˆå¤šï¼‰
```
</Callout>

#### å¤šå¯¹å¤šå…³ç³»

å¤šå¯¹å¤šå…³ç³»ä¸­ï¼Œ`è¡¨ A` çš„ä¸€æ¡è®°å½•å¯å…³è” `è¡¨ B` å¤šæ¡è®°å½•ï¼ŒåŒæ—¶ `è¡¨ B` çš„ä¸€æ¡è®°å½•ä¹Ÿå¯å…³è” `è¡¨ A` å¤šæ¡è®°å½•ï¼Œ  
æ˜¯ä¸€ä¸ªæ›´å¤æ‚ã€åŒå‘çš„å…³ç³»ã€‚

<Callout collapsed="ä½¿ç”¨åœºæ™¯ä¸ç¤ºä¾‹">
1. **å­¦ç”Ÿå’Œè¯¾ç¨‹**ï¼šä¸€ä¸ªå­¦ç”Ÿå¯ä»¥é€‰ä¿®å¤šé—¨è¯¾ç¨‹ï¼Œä¸€é—¨è¯¾ç¨‹ä¹Ÿå¯åŒ…å«å¤šåå­¦ç”Ÿã€‚  
2. **äº§å“å’Œç±»åˆ«**ï¼šä¸€ä»¶äº§å“å¯ä»¥å±äºå¤šä¸ªç±»åˆ«ï¼ˆå¦‚ T æ¤æ—¢å±äºâ€œæœè£…â€ï¼Œä¹Ÿå±äºâ€œå¤å­£ç©¿ç€â€ç±»åˆ«ï¼‰ï¼Œä¸€ä¸ªç±»åˆ«ä¹ŸåŒ…å«å¤šä¸ªäº§å“ã€‚  
3. **ä½œè€…å’Œä¹¦ç±**ï¼šä¸€æœ¬ä¹¦å¯ä»¥ç”±å¤šä¸ªä½œè€…åˆè‘—ï¼Œä¸€ä¸ªä½œè€…ä¹Ÿå†™å¤šæœ¬ä¹¦ã€‚

```
è¡¨ Aï¼ˆå¤šç«¯ï¼‰         å…³è”è¡¨ï¼ˆä¸­é—´è¡¨ï¼‰     è¡¨ Bï¼ˆå¤šç«¯ï¼‰
+---------+        +-------------+     +---------+
| PK (A)  | -----> | FK (A)      | <----| FK (B)  |
| ...     |        | FK (B)      |     | ...     |
+---------+        +-------------+     +---------+
     ï¼ˆå¤šï¼‰          ï¼ˆæ¡¥æ¥å…³è”ï¼‰          ï¼ˆå¤šï¼‰
```
</Callout>

å¤šå¯¹å¤šå…³ç³»å¹¶ä¸ä¼šç›´æ¥é€šè¿‡ä¸¤ä¸ªä¸»è¡¨é—´çš„å¤–é”®å®ç°ï¼Œ  
è€Œæ˜¯éœ€è¦ä¸€ä¸ª**å…³è”è¡¨**ï¼ˆä¹Ÿç§°ä¸ºå…³è”è¡¨ï¼Œæ¡¥æ¥è¡¨ï¼‰æ¥å……å½“ä¸­ä»‹ï¼Œå°†ä¸¤è¾¹çš„è®°å½•å…³è”èµ·æ¥ã€‚

```sql
-- å­¦ç”Ÿè¡¨ï¼ˆå¤šç«¯ï¼‰
CREATE TABLE students (
    id INT PRIMARY KEY,
    name VARCHAR(255)
);

-- è¯¾ç¨‹è¡¨ï¼ˆå¤šç«¯ï¼‰
CREATE TABLE courses (
    id INT PRIMARY KEY,
    name VARCHAR(255),
    credits INT
);

-- å…³è”è¡¨ï¼šenrollmentsï¼ˆè¿æ¥å­¦ç”Ÿå’Œè¯¾ç¨‹ï¼Œå®ç°å¤šå¯¹å¤šå…³ç³»ï¼‰
CREATE TABLE enrollments (
    id INT PRIMARY KEY AUTO_INCREMENT, -- å¯é€‰ï¼Œä½†å¯¹å…³è”è¡¨æ˜¯è‰¯å¥½å®è·µ
    student_id INT,
    course_id INT,
    enrollment_date DATE,
    -- å¤åˆå¤–é”®ï¼ˆé€šå¸¸ä¹Ÿæ˜¯å¤åˆä¸»é”®æˆ–å”¯ä¸€çº¦æŸçš„ä¸€éƒ¨åˆ†ï¼‰
    FOREIGN KEY (student_id) REFERENCES students(id),
    FOREIGN KEY (course_id) REFERENCES courses(id),
    UNIQUE KEY (student_id, course_id) -- é˜²æ­¢åŒä¸€ä¸ªå­¦ç”Ÿé‡å¤æŠ¥ååŒä¸€è¯¾ç¨‹
);
```

### ä¸ºä»€ä¹ˆä½¿ç”¨å¤–é”®ï¼Ÿ

ä½ å¯èƒ½ä¼šè®¤ä¸ºå¤–é”®çº¦æŸåªæ˜¯ç”¨æ¥éªŒè¯æ•°æ®â€”â€”ç¡®ä¿å¤–é”®åˆ—ä¸­çš„å€¼å­˜åœ¨äºå¦ä¸€å¼ è¡¨çš„ä¸»é”®åˆ—ä¸­ã€‚  
ä½ è¯´çš„æ²¡é”™ï¼Œè¿™ç¡®å®æ˜¯å¤–é”®çš„å€¼æ£€æŸ¥æœºåˆ¶ã€‚

ä½†æ˜¯ï¼Œå¿…é¡»ç†è§£è¿™ç§éªŒè¯ä¸æ˜¯ç»ˆç‚¹ï¼Œè€Œæ˜¯å®ç°æ›´å¤§ç›®æ ‡çš„æ‰‹æ®µã€‚  
å¤–é”®çº¦æŸæ ¹æœ¬ä¸Šæ˜¯ç”¨æ¥ï¼š

<Callout collapsed="1. æ˜ç¡®å®šä¹‰å¹¶å¼ºåˆ¶æ‰§è¡Œå…³ç³»">

æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ Customer å’Œ Orders çš„ä¸€å¯¹å¤šå…³ç³»ã€‚  
å¤–é”®æ˜¯ SQL è¯­è¨€å‘Šè¯‰æ•°æ®åº“çš„æ–¹å¼ï¼š  

> äº²ï¼Œæ•°æ®åº“ï¼Œæˆ‘æƒ³åœ¨è¿™é‡Œå¼ºåˆ¶æ‰§è¡Œä¸€å¯¹å¤šå…³ç³»ã€‚Orders è¡¨ä¸­çš„ customer_id åˆ—æ¯ä¸ªå€¼éƒ½å¿…é¡»å¯¹åº” Customers è¡¨ä¸­çš„æœ‰æ•ˆ customer_idã€‚

è¿™ä¸æ˜¯å»ºè®®ï¼Œè€Œæ˜¯æ•°æ®åº“ä¸»åŠ¨æ‰§è¡Œçš„çº¦æŸã€‚  
æ•°æ®åº“å› ä¸ºå¤–é”®è€Œæ‹¥æœ‰äº†å…³ç³»æ„è¯†ã€‚
</Callout>

<Callout collapsed="2. ç»´æŠ¤å‚ç…§å®Œæ•´æ€§">
- è¿™æ˜¯å…³ç³»å‹æ•°æ®ä¸­â€œæ•°æ®å®Œæ•´æ€§â€çš„æ ¸å¿ƒã€‚å‚ç…§å®Œæ•´æ€§ç¡®ä¿è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»éšæ—¶é—´ä¿æŒä¸€è‡´æœ‰æ•ˆã€‚  
- å¤–é”®é˜²æ­¢äº§ç”Ÿå­¤å„¿è®°å½•ã€‚å­¤å„¿è®°å½•æ˜¯ä»€ä¹ˆï¼Ÿæ¯”å¦‚è®¢å•è¡¨ä¸­å­˜åœ¨è®¢å•ï¼Œä½†ä¸å­˜åœ¨å¯¹åº”å®¢æˆ·è¡¨ä¸­çš„å®¢æˆ·ï¼Œåˆ™ä¸ºå­¤å„¿ã€‚å¤–é”®é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼ˆæˆ–è€…é€šè¿‡ CASCADEã€SET NULL ç­‰æ“ä½œæ§åˆ¶åˆ é™¤è¡Œä¸ºï¼‰ã€‚  
- ä¸ºä»€ä¹ˆé˜²æ­¢å­¤å„¿é‡è¦ï¼Ÿå­¤å„¿è®°å½•ç ´åæ•°æ®çš„é€»è¾‘ç»“æ„ã€‚ä¸¢å¤±å®¢æˆ·çš„è®¢å•å¤±å»å…³é”®ä¸Šä¸‹æ–‡ï¼ŒæŸ¥è¯¢å˜å¾—ä¸å¯é ï¼ŒæŠ¥å‘Šæ•°æ®é”™è¯¯ï¼Œåº”ç”¨é€»è¾‘å¯èƒ½å‡ºé”™ã€‚

**ç¤ºä¾‹**ï¼š  
```
å¦‚æœæ²¡æœ‰å¤–é”®çº¦æŸï¼Œå¯èƒ½ä¼šè¯¯åˆ  Customers è¡¨ä¸­çš„å®¢æˆ·ï¼Œè€Œä»–ä»¬çš„è®¢å•ä»åœ¨ Orders è¡¨ä¸­å­˜åœ¨ã€‚  
è¿™æ ·å°±æœ‰è®¢å•æŒ‡å‘ä¸å­˜åœ¨çš„å®¢æˆ·ï¼Œé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼å¤–é”®çº¦æŸå¯ä»¥é˜²æ­¢è¿™ç§æƒ…å†µã€‚
```
</Callout>

<Callout collapsed="3. ä¾¿äºæ•°æ®åº“è®¾è®¡å’Œç†è§£">
- å¤–é”®ä¸ä»…æ˜¯æŠ€æœ¯å±‚é¢çº¦æŸï¼ŒåŒæ—¶æ˜¯æ•°æ®åº“è®¾è®¡æ–‡æ¡£çš„é‡è¦ç»„æˆã€‚  
- å½“ä½ çœ‹åˆ°æ•°æ®åº“æ¶æ„ä¸­çš„å¤–é”®ï¼Œå®ƒç«‹å³å‘Šè¯‰ä½ ï¼š  
`è¡¨ X ä¸è¡¨ Y é€šè¿‡æ­¤æ–¹å¼ç›¸å…³è”`ï¼Œæ˜¯æ¸…æ™°çš„è§†è§‰å’Œç»“æ„æ ‡è¯†ã€‚  
- è¿™è®©æ•°æ®åº“æ›´å®¹æ˜“ç†è§£ã€ç»´æŠ¤å’Œæ¼”è¿›ã€‚æ–°å¼€å‘è€…å¯ä»¥å¿«é€Ÿäº†è§£æ•°æ®åº“å„éƒ¨åˆ†é—´çš„å…³è”ã€‚
</Callout>

æ€»ä¹‹ï¼Œå¤–é”®çº¦æŸä¸ä»…ä»…æ˜¯æ£€æŸ¥å€¼ï¼Œå®ƒä»¬æ˜¯ä¸ºäº†ï¼š

1. å®šä¹‰æ•°æ®å…³ç³»çš„è§„åˆ™  
2. åœ¨æ•°æ®åº“å±‚é¢ä¸»åŠ¨æ‰§è¡Œè¿™äº›è§„åˆ™  
3. ä¿è¯è¿™äº›å…³ç³»å†…æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§  
4. è®©æ•°æ®åº“æ›´å¥å£®ã€å¯é ä¸”æ˜“äºç†è§£

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤–é”®ï¼Ÿ

è™½ç„¶å¤–é”®éå¸¸æœ‰ç”¨ï¼Œä½†æŸäº›æƒ…å†µä¸‹å¯èƒ½éœ€è¦æ…ç”¨æˆ–è€ƒè™‘ä¸ç”¨ã€‚  
é€šå¸¸æ˜¯è¾¹ç¼˜æ¡ˆä¾‹ï¼Œä¸”éœ€è¦æƒè¡¡åˆ©å¼Šã€‚

<Callout collapsed="1. åœ¨è¶…é«˜å†™å…¥è´Ÿè½½ç¯å¢ƒä¸­çš„æ€§èƒ½å¼€é”€">
- **åœºæ™¯**ï¼šæé«˜é¢‘äº¤æ˜“å¹³å°ã€å®æ—¶æ—¥å¿—ã€æµ·é‡ç‰©è”ç½‘æ•°æ®æ‘„å–ç³»ç»Ÿã€‚  
- **è§£é‡Š**ï¼šæ¯æ¬¡æ’å…¥æˆ–æ›´æ–°å¸¦å¤–é”®çš„è¡¨æ—¶ï¼Œæ•°æ®åº“éƒ½è¦æ£€æŸ¥å‚ç…§å®Œæ•´æ€§ã€‚åœ¨æç«¯å†™å…¥æƒ…å†µä¸‹ï¼Œè¿™ç§æ£€æŸ¥å¯èƒ½å¸¦æ¥å°½ç®¡å¾®å°ä½†ç´¯ç§¯æ˜¾è‘—çš„æ€§èƒ½å½±å“ã€‚
</Callout>

<Callout collapsed="2. åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿä¸è·¨èŠ‚ç‚¹å¤–é”®">
- **åœºæ™¯**ï¼šæ•°æ®åˆ†å¸ƒäºå¤šèŠ‚ç‚¹/é›†ç¾¤ï¼ˆå¦‚åˆ†ç‰‡æ•°æ®åº“ã€äº‘ç¯å¢ƒã€å¾®æœåŠ¡æ¶æ„ï¼‰ã€‚  
- **è§£é‡Š**ï¼šè·¨èŠ‚ç‚¹çš„å¤–é”®æ£€æŸ¥ä¼šæå¤§å¢åŠ å¤æ‚æ€§å’Œæ€§èƒ½å¼€é”€ã€‚ä¿æŒå‚ç…§å®Œæ•´æ€§éœ€èŠ‚ç‚¹é—´åä½œï¼Œå¯¼è‡´å»¶è¿Ÿå¢åŠ ã€‚åˆ†å¸ƒå¼äº‹åŠ¡ç»´æŠ¤ä¸€è‡´æ€§æ›´å¤æ‚ä¸”æ€§èƒ½æ¬ ä½³ã€‚åœ¨è¿™ç±»æ¶æ„ä¸­ï¼Œå¯èƒ½é€‰æ‹©åº”ç”¨å±‚æ•°æ®å®Œæ•´æ€§æ£€æŸ¥æˆ–æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹æ›¿ä»£ã€‚
</Callout>

<Callout collapsed="3. ä¼ ç»Ÿç³»ç»Ÿå’Œéå…³ç³»æ•°æ®é›†æˆ">
- **åœºæ™¯**ï¼šé›†æˆè€æ—§ç³»ç»Ÿæˆ–éå…³ç³»æ•°æ®å­˜å‚¨ï¼ˆNoSQLã€å¹³é¢æ–‡ä»¶ã€å¤–éƒ¨ APIï¼‰ã€‚  
- **è§£é‡Š**ï¼šä¼ ç»Ÿç³»ç»Ÿæˆ–éå…³ç³»æ•°æ®å¯èƒ½æ— æ³•ä¸¥æ ¼éµå®ˆå‚ç…§å®Œæ•´æ€§ã€‚å¼ºåˆ¶å¤–é”®çº¦æŸå¯èƒ½å¼•èµ·å¯¼å…¥é—®é¢˜æˆ–æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦å¤æ‚çš„æ•°æ®è½¬æ¢æˆ–åº”ç”¨å±‚å®Œæ•´æ€§é€»è¾‘ç®¡ç†ã€‚æ­¤æ—¶éœ€è°¨æ…è¯„ä¼°æºæ•°æ®è´¨é‡ï¼Œä¸€èˆ¬ä¾èµ–åº”ç”¨æˆ– ETL æµç¨‹ä¿éšœå®Œæ•´æ€§ï¼Œè€Œä¸å¼ºåˆ¶æ•°æ®åº“å±‚å¤–é”®çº¦æŸã€‚
</Callout>

ä½ ä¹Ÿå¯ä»¥æŸ¥çœ‹ PlanetScale å›¢é˜Ÿçš„ç²¾å½©è§£é‡Šï¼Œè§ä»–ä»¬çš„[æ–‡ç« ](https://planetscale.com/docs/learn/operating-without-foreign-key-constraints#why-does-planetscale-not-recommend-constraints)

### å¤šæ€å…³ç³»

å¤šæ€å…³ç³»æ˜¯æ›´é«˜çº§çš„æ¦‚å¿µï¼Œå…è®¸å•ä¸ªå…³ç³»æŒ‡å‘ä¸åŒç±»å‹çš„å®ä½“æˆ–è¡¨ã€‚å®ƒä½¿å…³ç³»æ›´åŠ çµæ´»ï¼Œå¯é€‚åº”å¤šç§å…±äº«æŸäº›å…±æ€§çš„ä¸åŒæ•°æ®ã€‚

æƒ³è±¡ä½ æœ‰ä¸€ä¸ª `activities` æ—¥å¿—ã€‚æ´»åŠ¨å¯èƒ½æ˜¯ `comment`ï¼Œ`like` æˆ– `share`ã€‚  
è¿™äº›æ´»åŠ¨ç±»å‹æœ‰ä¸åŒçš„è¯¦æƒ…ã€‚ä¸å…¶ä¸ºæ¯ç±»æ´»åŠ¨åŠå…¶å…³è”é¡¹åˆ†åˆ«å»ºè¡¨å’Œè®¾è®¡å…³ç³»ï¼Œ  
ä½ å¯èƒ½é‡‡ç”¨å¤šæ€å…³ç³»æ–¹å¼ã€‚

<Callout collapsed="å¸¸è§åœºæ™¯ä¸ç¤ºä¾‹">
- **è¯„è®º/è¯„ä»·**ï¼šä¸€æ¡â€œè¯„è®ºâ€å¯èƒ½å…³è”ä¸åŒç±»å‹å†…å®¹ï¼šæ–‡ç« ã€äº§å“ã€è§†é¢‘ç­‰ã€‚  
  ä¸ç”¨ä¸ºæ¯ç§å†…å®¹ç±»å‹åœ¨ Comments è¡¨ä¸­å»ºç«‹åˆ†åˆ«çš„ article_idã€product_idã€video_id åˆ—ï¼Œ  
  å¯ä»¥é‡‡ç”¨å¤šæ€å…³ç³»ã€‚
```
+---------------------+
| **Comments**        |
+---------------------+
| PK comment_id       |
| commentable_type    | ------>  [å¤šæ€å…³ç³»]
| commentable_id      | -------->
| user_id             |
| comment_text        |
| ...                 |
+---------------------+
          ^
          |
+---------------------+    +---------------------+    +---------------------+
| **Articles**        |    | **Products**        |    | **Videos**          |
+---------------------+    +---------------------+    +---------------------+
| PK article_id       |    | PK product_id       |    | PK video_id         |
| ...                 |    | ...                 |    | ...                 |
+---------------------+    +---------------------+    +---------------------+
```
- **é€šçŸ¥**ï¼šé€šçŸ¥å¯ä»¥å…³è”ç”¨æˆ·ã€è®¢å•ã€ç³»ç»Ÿäº‹ä»¶ç­‰ã€‚
```
+----------------------+
| **Notifications**    |
+----------------------+
| PK notification_id  |
| notifiable_type     | ------>  [å¤šæ€å…³ç³»]
| notifiable_id       | -------->
| user_id             |
| message             |
| ...                  |
+----------------------+
           ^
           |
+---------------------+    +---------------------+    +-----------------------+
| **Users**           |    | **Orders**          |    | **System Events**     |
+---------------------+    +---------------------+    +-----------------------+
| PK user_id          |    | PK order_id         |    | PK event_id           |
| ...                 |    | ...                 |    | ...                   |
+---------------------+    +---------------------+    +-----------------------+
```
</Callout>

å¤šæ€å…³ç³»è¾ƒå¤æ‚ï¼Œé€šå¸¸åœ¨åº”ç”¨å±‚å®ç°æˆ–å€ŸåŠ©æ›´é«˜çº§æ•°æ®åº“åŠŸèƒ½ï¼ˆå–å†³å…·ä½“æ•°æ®åº“ç³»ç»Ÿï¼‰ã€‚  
æ ‡å‡† SQL æ²¡æœ‰å†…å»ºç›´æ¥æ”¯æŒå¤šæ€å¤–é”®çº¦æŸçš„æœºåˆ¶ï¼Œæ— æ³•åƒæ™®é€šå¤–é”®é‚£æ ·å¼ºåˆ¶æ‰§è¡Œã€‚

Source: https://drizzle.zhcndoc.com/docs/relations-v1-v2

import Callout from '@mdx/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import Section from '@mdx/Section.astro';
import Npx from "@mdx/Npx.astro";
import Npm from "@mdx/Npm.astro";
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';

# è¿ç§»åˆ°å…³ç³»æŸ¥è¯¢ç‰ˆæœ¬ 2

<Callout type='error'>
æœ¬æ–‡æ¡£ä»‹ç»çš„æ˜¯ drizzle ç‰ˆæœ¬ `1.0.0-beta.1` åŠä»¥ä¸Šæ”¯æŒçš„æ¦‚å¿µã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

<Prerequisites>
- **Drizzle Relations v1** - [ç‚¹å‡»æŸ¥çœ‹](/docs/relations)
- **å…³ç³»æŸ¥è¯¢ v1** - [ç‚¹å‡»æŸ¥çœ‹](/docs/rqb)
- **drizzle-kit pull** - [ç‚¹å‡»æŸ¥çœ‹](/docs/drizzle-kit-pull)
- **å…³ç³»åŸºç¡€çŸ¥è¯†** - [ç‚¹å‡»æŸ¥çœ‹](/docs/relations-schema-declaration)
</Prerequisites>

<Callout>
ä»¥ä¸‹æ˜¯ç›®å½•ã€‚ç‚¹å‡»æ¡ç›®å¯è·³è½¬åˆ°å¯¹åº”ç« èŠ‚ï¼š

- [ç›¸æ¯” v1 æœ‰å“ªäº›ä¸åŒ](#what-was-changed-and-is-working-differently-from-v1)  
- [v2 æ–°åŠŸèƒ½](2#what-is-new)  
- [å¦‚ä½•å°†å…³ç³»å®šä¹‰ä» v1 è¿ç§»åˆ° v2](#how-to-migrate-relations-schema-definition-from-v1-to-v2)  
- [å¦‚ä½•å°†æŸ¥è¯¢ä» v1 è¿ç§»åˆ° v2](#how-to-migrate-queries-from-v1-to-v2)  
- [éƒ¨åˆ†å‡çº§ï¼Œæˆ–å‡çº§åå¦‚ä½•ç»§ç»­ä½¿ç”¨ v1ï¼Ÿ](#partial-upgrade-or-how-to-stay-on-rqb-v1-even-after-an-upgrade)  
- [å†…éƒ¨å˜åŒ–ï¼ˆå¯¼å…¥ã€å†…éƒ¨ç±»å‹ç­‰ï¼‰](#internal-changes)
</Callout>

### API å˜åŒ–
#### ç›¸æ¯” v1 æœ‰å“ªäº›ä¸åŒ

{/* ##### Drizzle Relations schema definition */}

æœ€ä¸»è¦çš„æ›´æ–°ä¹‹ä¸€æ˜¯ **å…³ç³»æ¨¡å¼å®šä¹‰ï¼ˆRelations Schema å®šä¹‰ï¼‰**

ç¬¬ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œä½ ä¸å†éœ€è¦ä¸ºæ¯ä¸ªè¡¨åˆ†åˆ«åœ¨ä¸åŒå¯¹è±¡ä¸­æŒ‡å®š `relations`ï¼Œç„¶åå†è¿åŒ schema ä¸€èµ·ä¼ ç»™ `drizzle()`ã€‚åœ¨å…³ç³»æŸ¥è¯¢ v2 ä¸­ï¼Œä½ åªæœ‰ä¸€ä¸ªä¸“é—¨çš„ä½ç½®æ¥ä¸ºæ‰€æœ‰éœ€è¦çš„è¡¨æŒ‡å®šå…¨éƒ¨å…³ç³»ã€‚

å›è°ƒå‡½æ•°ä¸­çš„å‚æ•° `r` æä¾›äº†ç»¼åˆçš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ â€”â€” åŒ…å«ä½  schema ä¸­çš„æ‰€æœ‰è¡¨ï¼Œä»¥åŠ `one`ã€`many`ã€`through` è¿™ç±»å‡½æ•° â€”â€” æœ¬è´¨ä¸Šä¸ºä½ æŒ‡å®šå…³ç³»æä¾›äº†ä¸€åˆ‡æ‰€éœ€ã€‚

```ts
// relations.ts
import * as schema from "./schema"
import { defineRelations } from "drizzle-orm"

export const relations = defineRelations(schema, (r) => ({
    ...
}));
```
```ts
// index.ts
import { relations } from "./relations"
import { drizzle } from "drizzle-orm/..."

const db = drizzle(process.env.DATABASE_URL, { relations })
```

##### æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

<Callout collapsed="Schema Definition">
```ts copy {21-28}
import * as p from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text(),
	invitedBy: p.integer('invited_by'),
});

export const posts = p.pgTable('posts', {
	id: p.integer().primaryKey(),
	content: p.text(),
	authorId: p.integer('author_id'),
});
```
</Callout>

**æ‰€æœ‰å…³ç³»é›†ä¸­åˆ°ä¸€ä¸ªåœ°æ–¹**

<Callout title="âŒ v1">
```ts
import { relations } from "drizzle-orm/_relations";
import { users, posts } from './schema';

export const usersRelation = relations(users, ({ one, many }) => ({
  invitee: one(users, {
    fields: [users.invitedBy],
    references: [users.id],
  }),
  posts: many(posts),
}));

export const postsRelation = relations(posts, ({ one, many }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}));
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  },
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  },
}));
```
</Callout>

ä½ ä»ç„¶å¯ä»¥å°†å…¶æ‹†åˆ†æˆä¸åŒçš„ `parts`ï¼Œä¸” parts çš„å¤§å°ç”±ä½ å†³å®š

```ts
import { defineRelations, defineRelationsPart } from 'drizzle-orm';
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  }
}));

export const part = defineRelationsPart(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  }
}));
```

ç„¶åä½ å¯ä»¥è¿™æ ·ä¼ ç»™æ•°æ®åº“å®ä¾‹

```ts
const db = drizzle(process.env.DB_URL, { relations: { ...relations, ...part } })
```

**å®šä¹‰ `many` æ—¶å¯ä»¥ä¸ä¾èµ– `one`**

v1 ä¸­ï¼Œå¦‚æœä½ åªæƒ³å®šä¹‰å…³ç³»çš„ `many` ç«¯ï¼Œå¿…é¡»åœ¨å¦ä¸€ç«¯å®šä¹‰å¯¹åº”çš„ `one`ï¼Œè¿™ä½¿å¼€å‘ä½“éªŒè¾ƒå·®ã€‚

v2 ä¸­ï¼Œä½ å¯ä»¥ç®€å•åœ°åªç”¨ `many`ï¼Œæ— éœ€é¢å¤–æ“ä½œã€‚

<Callout title="âŒ v1">
```ts
import { relations } from "drizzle-orm/_relations";
import { users, posts } from './schema';

export const usersRelation = relations(users, ({ one, many }) => ({
  posts: many(posts),
}));

export const postsRelation = relations(posts, ({ one, many }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
  }),
}));
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    posts: r.many.posts({
      from: r.users.id,
      to: r.posts.authorId,
    }),
  },
}));
```
</Callout>

**æ–°å¢ `optional` é€‰é¡¹**

ç±»å‹å±‚é¢ä¸Šçš„ `optional: false` ä¼šè®© `posts` å¯¹è±¡ä¸­çš„ `author` å±æ€§å˜æˆå¿…éœ€ã€‚åº”åœ¨ç¡®å®šå¯¹åº”å®ä½“ä¸€å®šå­˜åœ¨æ—¶ä½¿ç”¨ã€‚

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
```ts {9}
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    posts: r.many.posts({
      from: r.users.id,
      to: r.posts.authorId,
      optional: false,
    }),
  },
}));
```
</Callout>

**`drizzle()` ä¸å†éœ€è¦æŒ‡å®šæ¨¡å¼ï¼ˆmodeï¼‰**

æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ç§å¯¹æ‰€æœ‰ MySQL æ–¹è¨€é€šç”¨çš„ç­–ç•¥ï¼Œå› æ­¤æ— éœ€å†æŒ‡å®šæ¨¡å¼ã€‚

<Callout title="âŒ v1">
```ts
import * as schema from './schema'

const db = drizzle(process.env.DATABASE_URL, { mode: "planetscale", schema });
// æˆ–è€…
const db = drizzle(process.env.DATABASE_URL, { mode: "default", schema });
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { relations } from './relations'

const db = drizzle(process.env.DATABASE_URL, { relations });
```
</Callout>

**`from` å’Œ `to` çš„å‡çº§**

å°† `fields` é‡å‘½åä¸º `from`ï¼Œ`references` é‡å‘½åä¸º `to`ï¼Œä¸¤è€…éƒ½æ”¯æŒå•å€¼æˆ–æ•°ç»„ã€‚

<Callout title="âŒ v1">
```ts
...
author: one(users, {
  fields: [posts.authorId],
  references: [users.id],
}),
...
```
</Callout>

<Callout title='âœ… v2'>
```ts
... 
author: r.one.users({
  from: r.posts.authorId,
  to: r.users.id,
}),
...
```
```ts
... 
author: r.one.users({
  from: [r.posts.authorId],
  to: [r.users.id],
}),
...
```
</Callout>

**`relationName` æ”¹ä¸º `alias`**

<Callout title="âŒ v1">
```ts
import { relations } from "drizzle-orm/_relations";
import { users, posts } from './schema';

export const postsRelation = relations(posts, ({ one }) => ({
  author: one(users, {
    fields: [posts.authorId],
    references: [users.id],
	  relationName: "author_post",
  }),
}));
```
</Callout>

<Callout title='âœ… v2'>
```ts
import { defineRelations } from "drizzle-orm";
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
      alias: "author_post",
    }),
  },
}));
```
</Callout>

**è‡ªå®šä¹‰ç±»å‹çš„æ–°å‡½æ•°**

æ–°å¢ä¸€äº›å‡½æ•°ç”¨äºæ§åˆ¶å…³ç³»æŸ¥è¯¢ v2 ä¸­çš„æ•°æ®æ˜ å°„ï¼š

<Callout collapsed='fromJson'>
å¯é€‰çš„æ˜ å°„å‡½æ•°ï¼Œç”¨äºå°†æ•°æ®åº“ä¸­è½¬ä¸º JSON è¿”å›çš„æ•°æ®è½¬æ¢ä¸ºæœŸæœ›æ ¼å¼ã€‚

ä¾‹å¦‚å½“é€šè¿‡ [RQB](https://orm.drizzle.team/docs/rqb-v2) æˆ– [JSON å‡½æ•°](https://orm.drizzle.team/docs/json-functions) æŸ¥è¯¢ bigint åˆ—æ—¶ï¼Œè¿”å›çš„å­—æ®µä¼šæ˜¯å­—ç¬¦ä¸²å½¢å¼ï¼Œè€Œéæ™®é€šæŸ¥è¯¢ä¸­çš„ bigint ç±»å‹ã€‚

æ­¤å‡½æ•°ç”¨æ¥å¤„ç†è¯¥å­—æ®µçš„æ˜ å°„ï¼š

```ts
fromJson(value: string): bigint {
	return BigInt(value);
},
```

ä¼šä½¿è¿”å›æ•°æ®ä»ï¼š

```ts
{
	customField: "5044565289845416380";
}
```

å˜ä¸ºï¼š

```ts
{
	customField: 5044565289845416380n;
}
```
</Callout> 
<Callout collapsed='forJsonSelect'>
å¯é€‰çš„é€‰æ‹©ä¿®æ”¹å‡½æ•°ï¼Œç”¨äºæ›´æ”¹ [JSON å‡½æ•°](https://orm.drizzle.team/docs/json-functions) å†…åˆ—çš„é€‰å–æ–¹å¼ã€‚

é’ˆå¯¹è¿™ç±»åœºæ™¯çš„é¢å¤–æ˜ å°„å¯ç”¨ fromJson å‡½æ•°å¤„ç†ã€‚

ç”± [å…³ç³»æŸ¥è¯¢](https://orm.drizzle.team/docs/rqb-v2) ä½¿ç”¨ã€‚

ä¸¾ä¾‹è€Œè¨€ï¼Œä½¿ç”¨ bigint ç±»å‹æ—¶éœ€è¦å¼ºåˆ¶å­—æ®µè½¬æ¢ä¸ºæ–‡æœ¬ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§ï¼š

```ts
forJsonSelect(identifier: SQL, sql: SQLGenerator, arrayDimensions?: number): SQL {
	return sql`${identifier}::text`
},
```

ä½¿æŸ¥è¯¢ä»ï¼š

```sql
SELECT
	row_to_json("t".*)
	FROM
	(
		SELECT
		"table"."custom_bigint" AS "bigint"
		FROM
		"table"
	) AS "t"
```

å˜ä¸ºï¼š

```sql
SELECT
	row_to_json("t".*)
	FROM
	(
		SELECT
		"table"."custom_bigint"::text AS "bigint"
		FROM
		"table"
	) AS "t"
```

æŸ¥è¯¢å¯¹è±¡è¿”å›å€¼ä»ï¼š

```ts
{
	bigint: 5044565289845416000; // ç”±äºç›´æ¥è½¬ JSONï¼Œæ•°æ®éƒ¨åˆ†ä¸¢å¤±
}
```

å˜ä¸ºï¼š

```ts
{
	bigint: "5044565289845416380"; // è½¬ä¸º text å†è½¬ JSONï¼Œæ•°æ®å¾—ä»¥ä¿ç•™
}
```
</Callout>

<Callout title='âœ… v2'>
```ts
const customBytes = customType<{
 	data: Buffer;
 	driverData: Buffer;
 	jsonData: string;
 }>({
 	dataType: () => 'bytea',
 	fromJson: (value) => {
 		return Buffer.from(value.slice(2, value.length), 'hex');
 	},
 	forJsonSelect: (identifier, sql, arrayDimensions) =>
 		sql`${identifier}::text${sql.raw('[]'.repeat(arrayDimensions ?? 0))}`,
 });
```

</Callout>

##### æœ‰å“ªäº›æ–°å¢ï¼Ÿ

**å¤šå¯¹å¤šå…³ç³»çš„ `through`**

ä¹‹å‰ï¼Œä½ éœ€è¦æ˜¾å¼é€šè¿‡è”ç»“è¡¨æŸ¥è¯¢ï¼Œç„¶ååœ¨æ¯æ¬¡å“åº”ä¸­æ˜ å°„å®ƒã€‚

ç°åœ¨ä¸éœ€è¦å†è¿™æ ·åšäº†ï¼

<Callout collapsed='Schema'>
```ts
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.integer().primaryKey(),
  name: p.text(),
  verified: p.boolean().notNull(),
});

export const groups = p.pgTable("groups", {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const usersToGroups = p.pgTable(
  "users_to_groups",
  {
    userId: p
      .integer("user_id")
      .notNull()
      .references(() => users.id),
    groupId: p
      .integer("group_id")
      .notNull()
      .references(() => groups.id),
  },
  (t) => [p.primaryKey({ columns: [t.userId, t.groupId] })]
);
```
</Callout>

<Callout title="âŒ v1">
```ts
export const usersRelations = relations(users, ({ many }) => ({
  usersToGroups: many(usersToGroups),
}));

export const groupsRelations = relations(groups, ({ many }) => ({
  usersToGroups: many(usersToGroups),
}));

export const usersToGroupsRelations = relations(usersToGroups, ({ one }) => ({
  group: one(groups, {
    fields: [usersToGroups.groupId],
    references: [groups.id],
  }),
  user: one(users, {
    fields: [usersToGroups.userId],
    references: [users.id],
  }),
}));
```
```ts
// æŸ¥è¯¢ç¤ºä¾‹
const response = await db.query.users.findMany({
  with: {
    usersToGroups: {
      columns: {},
      with: {
        group: true,
      },
    },
  },
});
```
</Callout>

<Callout title='âœ… v2'>
```ts
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';

export const relations = defineRelations(schema, (r) => ({
  users: {
    groups: r.many.groups({
      from: r.users.id.through(r.usersToGroups.userId),
      to: r.groups.id.through(r.usersToGroups.groupId),
    }),
  },
  groups: {
    participants: r.many.users(),
  },
}));
```
```ts
// æŸ¥è¯¢ç¤ºä¾‹
const response = await db.query.users.findMany({
  with: {
    groups: true,
  },
});
```
</Callout>

**é¢„å®šä¹‰è¿‡æ»¤å™¨**

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
```ts {10-12}
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';

export const relations = defineRelations(schema,
  (r) => ({
    groups: {
      verifiedUsers: r.many.users({
        from: r.groups.id.through(r.usersToGroups.groupId),
        to: r.users.id.through(r.usersToGroups.userId),
        where: {
          verified: true,
        },
      }),
    },
  })
);
```
```ts {4}
// æŸ¥è¯¢ç¤ºä¾‹ï¼šè·å–æ‰€æœ‰åŒ…å«å·²éªŒè¯ç”¨æˆ·çš„ç»„
const response = await db.query.groups.findMany({
  with: {
    verifiedUsers: true,
  },
});
```
</Callout>

##### `where` ç°åœ¨æ˜¯å¯¹è±¡

<Callout title="âŒ v1">
```ts
const response = db._query.users.findMany({
  where: (users, { eq }) => eq(users.id, 1),
});
```
</Callout>

<Callout title="âœ… v2">
```ts
const response = db.query.users.findMany({
  where: {
    id: 1,
  },
});
```

å®Œæ•´ API å‚è€ƒè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [é€‰æ‹©è¿‡æ»¤å™¨æ–‡æ¡£](/docs/rqb-v2#select-filters)
</Callout>

<Callout collapsed='ä½¿ç”¨ RAW çš„å¤æ‚è¿‡æ»¤ç¤ºä¾‹'>
```ts
// schema.ts
import { integer, jsonb, pgTable, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: integer("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  age: integer("age"),
  createdAt: timestamp("created_at").defaultNow(),
  lastLogin: timestamp("last_login"),
  subscriptionEnd: timestamp("subscription_end"),
  lastActivity: timestamp("last_activity"),
  preferences: jsonb("preferences"),      // å­˜å‚¨ç”¨æˆ·è®¾ç½®/åå¥½çš„ JSON åˆ—
  interests: text("interests").array(),  // å­˜å‚¨ç”¨æˆ·å…´è¶£çš„æ•°ç»„åˆ—
});
```
```ts
const response = db.query.users.findMany({
  where: {
    AND: [
      {
        OR: [
          { RAW: (table) => sql`LOWER(${table.name}) LIKE 'john%'` },
          { name: { ilike: "jane%" } },
        ],
      },
      {
        OR: [
          { RAW: (table) => sql`${table.preferences}->>'theme' = 'dark'` },
          { RAW: (table) => sql`${table.preferences}->>'theme' IS NULL` },
        ],
      },
      { RAW: (table) => sql`${table.age} BETWEEN 25 AND 35` },
    ],
  },
});
```
</Callout>

##### `orderBy` ç°åœ¨æ˜¯å¯¹è±¡

<Callout title="âŒ v1">
```ts
const response = db._query.users.findMany({
  orderBy: (users, { asc }) => [asc(users.id)],
});
```
</Callout>

<Callout title="âœ… v2">
```ts
const response = db.query.users.findMany({
  orderBy: { id: "asc" },
});
```
</Callout>

##### é€šè¿‡å…³ç³»è¿‡æ»¤

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
ç¤ºä¾‹ï¼šè·å– ID å¤§äº 10ï¼Œä¸”è‡³å°‘æ‹¥æœ‰ä¸€ä¸ªå†…å®¹ä»¥ â€œMâ€ å¼€å¤´å¸–å­ï¼ˆpostï¼‰çš„ç”¨æˆ·

```ts
const usersWithPosts = await db.query.usersTable.findMany({
  where: {
    id: {
      gt: 10
    },
    posts: {
      content: {
        like: 'M%'
      }
    }
  },
});
```
</Callout>

##### å…³è”å¯¹è±¡ä¸­ä½¿ç”¨ `offset`

<Callout title="âŒ v1">
v1 ä¸æ”¯æŒæ­¤åŠŸèƒ½
</Callout>

<Callout title='âœ… v2'>
```ts
await db.query.posts.findMany({
	limit: 5,
	offset: 2, // æ­£ç¡® âœ…
	with: {
		comments: {
			offset: 3, // æ­£ç¡® âœ…
			limit: 3,
		},
	},
});
```
</Callout>

#### å¦‚ä½•å°†å…³ç³»å®šä¹‰ä» v1 è¿ç§»åˆ° v2

##### **æ–¹æ¡ˆ 1**ï¼šä½¿ç”¨ `drizzle-kit pull`

æ–°ç‰ˆæœ¬çš„ `drizzle-kit pull` æ”¯æŒä»¥æ–°è¯­æ³•æ‹‰å– `relations.ts` æ–‡ä»¶ï¼š

##### ç¬¬ 1 æ­¥

<Npx>
drizzle-kit pull
</Npx>

#### ç¬¬ 2 æ­¥ 

å°† `drizzle/relations.ts` ä¸­ç”Ÿæˆçš„ relations ä»£ç è¿ç§»åˆ°ä½ ç”¨äºå®šä¹‰å…³ç³»çš„æ–‡ä»¶ä¸­ 
```plaintext {4-5}
 â”œ ğŸ“‚ drizzle
 â”‚ â”œ ğŸ“‚ meta
 â”‚ â”œ ğŸ“œ migration.sql
 â”‚ â”œ ğŸ“œ relations.ts â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ â”” ğŸ“œ schema.ts            |
 â”œ ğŸ“‚ src                    â”‚ 
 â”‚ â”œ ğŸ“‚ db                   â”‚
 â”‚ â”‚ â”œ ğŸ“œ relations.ts <â”€â”€â”€â”€â”€â”˜
 â”‚ â”‚ â”” ğŸ“œ schema.ts 
 â”‚ â”” ğŸ“œ index.ts         
 â”” â€¦
```

<Callout>
`drizzle/relations.ts` ä¼šå¯¼å…¥æ‰€æœ‰è¡¨çš„ schemaï¼Œå½¢å¼å¦‚ä¸‹ï¼š
```ts
import * as schema from './schema'
```

ä½ å¯èƒ½éœ€è¦å°†æ­¤å¯¼å…¥æ”¹ä¸ºä½ æ‰€æœ‰ schema è¡¨æ‰€åœ¨çš„æ–‡ä»¶ã€‚

å¦‚æœ schema æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
```ts
import * as schema1 from './schema1'
import * as schema2 from './schema2'
...
```
</Callout>

#### ç¬¬ 3 æ­¥

ä¿®æ”¹ drizzle æ•°æ®åº“å®ä¾‹åˆ›å»ºï¼Œæä¾› `relations` å¯¹è±¡è€Œé `schema`

<Callout title='è¿ç§»å‰'>
```ts
import * as schema from './schema'
import { drizzle } from 'drizzle-orm/...'

const db = drizzle('<url>', { schema })
```
</Callout>

<Callout title='è¿ç§»å'>
```ts
// åº”è¯¥ä»ç¬¬ 2 æ­¥ä¿®æ”¹çš„æ–‡ä»¶å¯¼å…¥
import { relations } from './relations'
import { drizzle } from 'drizzle-orm/...'

const db = drizzle('<url>', { relations })
```
</Callout>

<Callout>
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ MySQL æ–¹è¨€ï¼Œå¯ä»¥åœ¨ v2 ä¸­å»æ‰ `drizzle()` ä¸­çš„ `mode`ï¼Œå› ä¸ºå·²ä¸å†éœ€è¦ã€‚
</Callout>


##### æ‰‹åŠ¨è¿ç§»

å¦‚æœä½ æƒ³æ‰‹åŠ¨è¿ç§»ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„ [Drizzle Relations ç« èŠ‚](/docs/relations-v2) è·å–å®Œæ•´ API å‚è€ƒï¼Œä»¥åŠä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»çš„ç¤ºä¾‹ã€‚

#### å¦‚ä½•å°†æŸ¥è¯¢ä» v1 è¿ç§»åˆ° v2

##### è¿ç§» `where` è¯­å¥

ä½ å¯ä»¥æŸ¥çœ‹æˆ‘ä»¬çš„ [é€‰æ‹©è¿‡æ»¤å™¨æ–‡æ¡£](/docs/rqb-v2#select-filters) æŸ¥çœ‹ç¤ºä¾‹å’Œå®Œæ•´ API å‚è€ƒã€‚

æ–°è¯­æ³•æ”¯æŒ `AND`ã€`OR`ã€`NOT`ã€`RAW`ï¼Œä»¥åŠ Relations v1 ä¹‹å‰æ‰€æœ‰å¯ç”¨çš„è¿‡æ»¤æ“ä½œç¬¦ã€‚

**ç¤ºä¾‹**
<CodeTabs items={["ç®€å•ç­‰äº", "ä½¿ç”¨ AND", "ä½¿ç”¨ OR", "ä½¿ç”¨ NOT", "ä½¿ç”¨ RAW çš„å¤æ‚ç¤ºä¾‹"]}>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    age: 15,
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name"
from "users" 
where ("users"."age" = $1)
```
</CodeTab>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    age: 15,
    name: 'John'
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name"
from "users" 
where ("users"."age" = $1 and "users"."name" = $2)
```
</CodeTab>
<CodeTab>
```ts
const response = await db.query.users.findMany({
  where: {
    OR: [
      {
        id: {
          gt: 10,
        },
      },
	  {
		name: {
          like: "John%",
        },
	  }
    ],
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name" 
from "users" 
where ("users"."id" > $1 or "users"."name" like $2)
```
</CodeTab>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    NOT: {
      id: {
        gt: 10,
      },
    },
    name: {
      like: "John%",
    },
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name" 
from "users" 
where (not "users"."id" > $1 and "users"."name" like $2)
```
</CodeTab>
<CodeTab>
```ts
// schema.ts
import { integer, jsonb, pgTable, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: integer("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  age: integer("age"),
  createdAt: timestamp("created_at").defaultNow(),
  lastLogin: timestamp("last_login"),
  subscriptionEnd: timestamp("subscription_end"),
  lastActivity: timestamp("last_activity"),
  preferences: jsonb("preferences"),      // ç”¨æˆ·è®¾ç½®/åå¥½çš„ JSON åˆ—
  interests: text("interests").array(),  // ç”¨æˆ·å…´è¶£çš„æ•°ç»„åˆ—
});
```
```ts
const response = db.query.users.findMany({
  where: {
    AND: [
      {
        OR: [
          { RAW: (table) => sql`LOWER(${table.name}) LIKE 'john%'` },
          { name: { ilike: "jane%" } },
        ],
      },
      {
        OR: [
          { RAW: (table) => sql`${table.preferences}->>'theme' = 'dark'` },
          { RAW: (table) => sql`${table.preferences}->>'theme' IS NULL` },
        ],
      },
      { RAW: (table) => sql`${table.age} BETWEEN 25 AND 35` },
    ],
  },
});
```
```sql
```
</CodeTab>
</CodeTabs>

##### è¿ç§» `orderBy` è¯­å¥

`orderBy` ç°åœ¨ç®€åŒ–ä¸ºå•ä¸ªå¯¹è±¡ï¼ŒæŒ‡å®šåˆ—å’Œæ’åºæ–¹å‘ï¼ˆ`asc` æˆ– `desc`ï¼‰

<Callout title="âŒ v1">
```ts
const response = db._query.users.findMany({
  orderBy: (users, { asc }) => [asc(users.id)],
});
```
</Callout>

<Callout title="âœ… v2">
```ts
const response = db.query.users.findMany({
  orderBy: { id: "asc" },
});
```
</Callout>

##### è¿ç§»å¤šå¯¹å¤šæŸ¥è¯¢

å…³ç³»æŸ¥è¯¢ v1 å¤„ç†å¤šå¯¹å¤šæŸ¥è¯¢éå¸¸ç¹çã€‚ä½ éœ€è¦æ˜¾å¼ä½¿ç”¨è”ç»“è¡¨æŸ¥è¯¢ï¼Œå¹¶æ‰‹åŠ¨æ˜ å°„ï¼š

```ts
const response = await db.query.users.findMany({
  with: {
    usersToGroups: {
      columns: {},
      with: {
        group: true,
      },
    },
  },
});
```

å‡çº§åˆ°å…³ç³»æŸ¥è¯¢ v2 åï¼Œå¤šå¯¹å¤šå…³ç³»å˜æˆè¿™æ ·ï¼š

```ts
import * as schema from './schema';
import { defineRelations } from 'drizzle-orm';

export const relations = defineRelations(schema, (r) => ({
  users: {
    groups: r.many.groups({
      from: r.users.id.through(r.usersToGroups.userId),
      to: r.groups.id.through(r.usersToGroups.groupId),
    }),
  },
  groups: {
    participants: r.many.users(),
  },
}));
```

æŸ¥è¯¢è¯­å¥æ›´æ–°ä¸ºï¼š

```ts
// æŸ¥è¯¢ç¤ºä¾‹
const response = await db.query.users.findMany({
  with: {
    groups: true,
  },
});
```

#### éƒ¨åˆ†å‡çº§ï¼Œæˆ–è€…å‡çº§åå¦‚ä½•ç»§ç»­ä½¿ç”¨ RQB v1ï¼Ÿ

æˆ‘ä»¬çš„å‡çº§æ–¹æ¡ˆä¿è¯æ—§çš„æŸ¥è¯¢å’Œå…³ç³»å®šä¹‰ä¾ç„¶å¯ç”¨ã€‚è¿™æ ·ä½ å°±å¯ä»¥åœ¨é¡¹ç›®ä¸­é€æ¡è¿ç§»æŸ¥è¯¢ï¼Œæ— éœ€ä¸€æ¬¡æ€§å¤§é‡æ„ã€‚

##### ç¬¬ 1 æ­¥ï¼šä¿®æ”¹ relations å¯¼å…¥

v1 ä¸­ï¼Œä½ éœ€è¦ä» `drizzle-orm` å¯¼å…¥ `relations`

<Callout type='error' title='v1'>
```ts
import { relations } from 'drizzle-orm';
```
</Callout>

v2 ä¸­ï¼Œæˆ‘ä»¬å°†å…¶ç§»åˆ° `drizzle-orm/_relations`ï¼Œè®©ä½ æœ‰æ—¶é—´åšè¿ç§»

<Callout title='v2'>
```ts
import { relations } from "drizzle-orm/_relations";
```
</Callout>

##### ç¬¬ 2 æ­¥ï¼šå°†æŸ¥è¯¢æ”¹ä¸ºä½¿ç”¨ `._query`

v1 ä¸­ï¼Œä½ é€šè¿‡ `db.query.` è®¿é—®å…³ç³»æŸ¥è¯¢ API

<Callout type='error' title='v1'>
```ts
await db.query.users.findMany();
```
</Callout>

åœ¨ v2 ä¸­ï¼Œæˆ‘ä»¬ç”¨ `db._query` è¿è¡Œ v1 ä»£ç ï¼Œ`db.query` ç”¨äºæ–°è¯­æ³•ã€‚å³ï¼š

<Callout title='v2'>
```ts
// ä½¿ç”¨ RQB v1
await db._query.users.findMany();

// ä½¿ç”¨ RQB v2
await db.query.users.findMany();
```
</Callout>

##### ç¬¬ 3 æ­¥

å®šä¹‰æ–°çš„ relationsï¼Œæˆ–è€…æ ¹æ®[æœ¬æŒ‡å—](#how-to-migrate-relations-schema-definition-from-v1-to-v2)æ‹‰å–ï¼Œç„¶åæ–°æŸ¥è¯¢ä½¿ç”¨æ–°å…³ç³»å®šä¹‰ï¼Œæ—§æŸ¥è¯¢é€æ¡è¿ç§»ã€‚

### å†…éƒ¨å˜åŒ–

1. æ¯ä¸ª `drizzle` æ•°æ®åº“ã€ä¼šè¯ã€è¿ç§»å™¨å’Œäº‹åŠ¡å®ä¾‹éƒ½æ–°å¢äº† RQB v2 æŸ¥è¯¢çš„ä¸¤ä¸ªæ³›å‹å‚æ•°ã€‚

<Callout collapsed='ç¤ºä¾‹'>
**è¿ç§»å™¨**
<Callout type='error' title='ä¹‹å‰'>
```ts
export async function migrate<
  TSchema extends Record<string, unknown>
>(
  db: NodePgDatabase<TSchema>,
  config: MigrationConfig,
) {
  ...
}
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,5}
export async function migrate<
 TSchema extends Record<string, unknown>,
 TRelations extends AnyRelations
>(
  db: NodePgDatabase<TSchema, TRelations>,
  config: MigrationConfig,
) {
  ...
}
```
</Callout>
**ä¼šè¯**
<Callout type='error' title='ä¹‹å‰'>
```ts
export class NodePgSession<
  TFullSchema extends Record<string, unknown>,
  TSchema extends V1.TablesRelationalConfig,
> extends PgSession<NodePgQueryResultHKT, TFullSchema, TSchema>
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,4,6}
export class NodePgSession<
  TFullSchema extends Record<string, unknown>,
  TRelations extends AnyRelations,
  TTablesConfig extends TablesRelationalConfig,
  TSchema extends V1.TablesRelationalConfig,
> extends PgSession<NodePgQueryResultHKT, TFullSchema, TRelations, TTablesConfig, TSchema>
```
</Callout>
**äº‹åŠ¡**
<Callout type='error' title='ä¹‹å‰'>
```ts
export class NodePgTransaction<
  TFullSchema extends Record<string, unknown>,
  TSchema extends V1.TablesRelationalConfig,
> extends PgTransaction<NodePgQueryResultHKT, TFullSchema, TSchema>
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,4,6}
export class NodePgTransaction<
  TFullSchema extends Record<string, unknown>,
  TRelations extends AnyRelations,
  TTablesConfig extends TablesRelationalConfig,
  TSchema extends V1.TablesRelationalConfig,
> extends PgTransaction<NodePgQueryResultHKT, TFullSchema, TRelations, TTablesConfig, TSchema>
```
</Callout>
**é©±åŠ¨**
<Callout type='error' title='ä¹‹å‰'>
```ts
export class NodePgDatabase<
  TSchema extends Record<string, unknown> = Record<string, never>,
> extends PgDatabase<NodePgQueryResultHKT, TSchema>
```
</Callout>
<Callout title='ç°åœ¨'>
```ts {3,4}
export class NodePgDatabase<
  TSchema extends Record<string, unknown> = Record<string, never>,
  TRelations extends AnyRelations = EmptyRelations,
> extends PgDatabase<NodePgQueryResultHKT, TSchema, TRelations>
```
</Callout>
</Callout>

2. æ›´æ–°äº† `DrizzleConfig` æ³›å‹ï¼Œæ–°å¢äº† `TRelations` å‚æ•°å’Œ `relations: TRelations` å­—æ®µ

<Callout collapsed='ç¤ºä¾‹'>
<Callout type='error' title='ä¹‹å‰'>
```ts
export interface DrizzleConfig<
  TSchema extends Record<string, unknown> = Record<string, never>
> {
  logger?: boolean | Logger;
  schema?: TSchema;
  casing?: Casing;
}
```
</Callout>

<Callout title='ç°åœ¨'>
```ts {8}
export interface DrizzleConfig<
  TSchema extends Record<string, unknown> = Record<string, never>,
  TRelations extends AnyRelations = EmptyRelations,
> {
  logger?: boolean | Logger;
  schema?: TSchema;
  casing?: Casing;
  relations?: TRelations;
}
```
</Callout>
</Callout>

3. ä»¥ä¸‹å®ä½“ä» `drizzle-orm` å’Œ `drizzle-orm/relations` ç§»åŠ¨åˆ° `drizzle-orm/_relations`ã€‚åŸæœ‰å¯¼å…¥ç°åœ¨åŒ…å«äº†å…³ç³»æŸ¥è¯¢ v2 ä½¿ç”¨çš„æ–°ç±»å‹ï¼Œå¦‚æœä½ è¿˜æƒ³ç”¨æ—§ç±»å‹ï¼Œè¯·æ›´æ–°å¯¼å…¥ï¼š

<Callout collapsed='å…¨éƒ¨è¿ç§»çš„å®ä½“åˆ—è¡¨'>
- `Relation`
- `Relations`
- `One`
- `Many`
- `TableRelationsKeysOnly`
- `ExtractTableRelationsFromSchema`
- `ExtractObjectValues`
- `ExtractRelationsFromTableExtraConfigSchema`
- `getOperators`
- `Operators`
- `getOrderByOperators`
- `OrderByOperators`
- `FindTableByDBName`
- `DBQueryConfig`
- `TableRelationalConfig`
- `TablesRelationalConfig`
- `RelationalSchemaConfig`
- `ExtractTablesWithRelations`
- `ReturnTypeOrValue`
- `BuildRelationResult`
- `NonUndefinedKeysOnly`
- `BuildQueryResult`
- `RelationConfig`
- `extractTablesRelationalConfig`
- `relations`
- `createOne`
- `createMany`
- `NormalizedRelation`
- `normalizeRelation`
- `createTableRelationsHelpers`
- `TableRelationsHelpers`
- `BuildRelationalQueryResult`
- `mapRelationalRow`
</Callout>

4. åŒæ ·è§„åˆ™ï¼Œ`${dialect}-core/query-builders/query` æ–‡ä»¶ç§»åŠ¨åˆ°äº† `${dialect}-core/query-builders/_query` ï¼ŒåŸä½ç½®æ›¿æ¢ä¸º RQB v2 å¯¹åº”çš„å®ç°ã€‚

<Callout collapsed='ç¤ºä¾‹'>
<Callout type='error' title='ä¹‹å‰'>
```ts
import { RelationalQueryBuilder, PgRelationalQuery } from './query-builders/query.ts';
```
</Callout>

<Callout title='ç°åœ¨'>
```ts
import { _RelationalQueryBuilder, _PgRelationalQuery } from './query-builders/_query.ts';
```
</Callout>
</Callout>

Source: https://drizzle.zhcndoc.com/docs/relations-v2

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Npm from '@mdx/Npm.astro';

# Drizzle å…³ç³»

<Callout type='error'>
æ­¤é¡µé¢è§£é‡Šçš„æ˜¯ Drizzle ç‰ˆæœ¬ `1.0.0-beta.1` åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒçš„æ¦‚å¿µã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

<Prerequisites>  
  - **å…³ç³»åŸºç¡€** - ç†Ÿæ‚‰å¤–é”®çº¦æŸã€è½¯å…³è”ã€æ•°æ®åº“èŒƒå¼ç­‰æ¦‚å¿µ - [æŸ¥çœ‹è¿™é‡Œ](/docs/rqb-fundamentals)
  - **å£°æ˜æ¨¡å¼** - ç†Ÿæ‚‰å¦‚ä½•å®šä¹‰ Drizzle æ¨¡å¼ - [æŸ¥çœ‹è¿™é‡Œ](/docs/sql-schema-declaration)
  - **æ•°æ®åº“è¿æ¥** - ç†Ÿæ‚‰å¦‚ä½•ä½¿ç”¨ Drizzle è¿æ¥æ•°æ®åº“ - [æŸ¥çœ‹è¿™é‡Œ](/docs/get-started-postgresql)
</Prerequisites>

Drizzle å…³ç³»çš„å”¯ä¸€ç›®çš„æ˜¯è®©ä½ ä»¥æœ€ç®€å•ä¸”ç®€æ´çš„æ–¹å¼æŸ¥è¯¢å…³ç³»å‹æ•°æ®ï¼š

<CodeTabs items={["å…³ç³»æŸ¥è¯¢", "å…³è”é€‰æ‹©"]}>
<Section>
```ts
import { drizzle } from 'drizzle-orm/â€¦';
import { defineRelations } from 'drizzle-orm';
import * as p from 'drizzle-orm/pg-core';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text().notNull()
});

export const posts = p.pgTable('posts', {
	id: p.integer().primaryKey(),
	content: p.text().notNull(),
	ownerId: p.integer('owner_id'),
});

const relations = defineRelations({ users, posts }, (r) => ({
	posts: {
		author: r.one.users({
			from: r.posts.ownerId,
			to: r.users.id,
		}),
	}
}))

const db = drizzle(client, { relations });

const result = db.query.posts.findMany({
  with: {
    author: true,
  },
});
```
```ts
[{
  id: 10,
  content: "æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­ï¼",
  author: {
    id: 1,
    name: "Alex"
  }
}]
```
</Section>
<Section>
```ts
import { drizzle } from 'drizzle-orm/â€¦';
import { eq } from 'drizzle-orm';
import { posts, users } from './schema';

const db = drizzle(client);

const res = await db.select()
                    .from(posts)
                    .leftJoin(users, eq(posts.ownerId, users.id))
                    .orderBy(posts.id)
const mappedResult =  
```
</Section>
</CodeTabs>

### `one()`
ä»¥ä¸‹æ˜¯ drizzle å…³ç³»ä¸­ `.one()` æ”¯æŒçš„æ‰€æœ‰å­—æ®µåˆ—è¡¨

```ts {3-11}
const relations = defineRelations({ users, posts }, (r) => ({
	posts: {
		author: r.one.users({
			from: r.posts.ownerId,
			to: r.users.id,
			optional: false,
      alias: 'custom_name',
			where: {
				verified: true,
			}
		}),
	}
}))
```

- `author` æ˜¯è‡ªå®šä¹‰é”®ï¼Œå½“ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ—¶ï¼Œä¼šä½œä¸º `posts` å¯¹è±¡ä¸­çš„é”®å‡ºç°ã€‚
- `r.one.users` è¡¨ç¤º `author` æ˜¯æ¥è‡ª `users` è¡¨çš„å•ä¸ªå¯¹è±¡ï¼Œè€Œéå¯¹è±¡æ•°ç»„ã€‚
- `from: r.posts.ownerId` æŒ‡å®šäº†å»ºç«‹è½¯å…³è”çš„èµ·å§‹è¡¨ã€‚
æ­¤å¤„ï¼Œå…³è”ä» `posts` è¡¨çš„ `ownerId` åˆ—å¼€å§‹ã€‚
- `to: r.users.id` æŒ‡å®šäº†å»ºç«‹è½¯å…³è”çš„ç›®æ ‡è¡¨ã€‚
æ­¤å¤„ï¼Œå…³è”æŒ‡å‘ `users` è¡¨çš„ `id` åˆ—ã€‚
- `optional: false` åœ¨ç±»å‹å±‚é¢ä¸Šè¡¨ç¤º `posts` å¯¹è±¡ä¸­çš„ `author` é”®ä¸ºå¿…éœ€ã€‚
å½“ä½ ç¡®å®šè¯¥å®ä½“å¿…å®šå­˜åœ¨æ—¶åº”ä½¿ç”¨è¯¥é€‰é¡¹ã€‚
- `alias` ç”¨äºç»™ä¸¤ä¸ªè¡¨ä¹‹é—´çš„å…³ç³»æ·»åŠ ç‰¹å®šåˆ«åã€‚å¦‚æœä¸¤ä¸ªè¡¨ä¹‹é—´æœ‰å¤šä¸ªç›¸åŒçš„å…³ç³»ï¼Œåº”ä½¿ç”¨ `alias` è¿›è¡ŒåŒºåˆ†ã€‚
- `where` æ¡ä»¶å¯ç”¨äºå¤šæ€å…³ç³»ã€‚å®ƒåŸºäº `where` è¯­å¥ç­›é€‰å…³ç³»ã€‚ä¾‹å¦‚ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œåªä¼šè·å– `verified` çŠ¶æ€ä¸º true çš„ä½œè€…ã€‚æ›´å¤šå…³äºå¤šæ€å…³ç³»ï¼Œè§ [è¿™é‡Œ](/docs/relations-schema-declaration#polymorphic-relations)ã€‚

### `many()`

ä»¥ä¸‹æ˜¯ drizzle å…³ç³»ä¸­ `.many()` æ”¯æŒçš„æ‰€æœ‰å­—æ®µåˆ—è¡¨

```ts {3-11}
const relations = defineRelations({ users, posts }, (r) => ({
	users: {
		feed: r.many.posts({
			from: r.users.id,
			to: r.posts.ownerId,
			optional: false,
      alias: 'custom_name',
			where: {
				approved: true,
			}
		}),
	}
}))
```

- `feed` æ˜¯è‡ªå®šä¹‰é”®ï¼Œå½“ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ—¶ä¼šå‡ºç°åœ¨ `users` å¯¹è±¡ä¸­ã€‚
- `r.many.posts` è¡¨ç¤º `feed` æ˜¯æ¥è‡ª `posts` è¡¨çš„å¯¹è±¡æ•°ç»„ï¼Œè€Œéå•ä¸ªå¯¹è±¡ã€‚
- `from: r.users.id` æŒ‡å®šå»ºç«‹è½¯å…³è”çš„èµ·å§‹è¡¨ã€‚
æ­¤å¤„ï¼Œå…³è”ä» `users` è¡¨çš„ `id` åˆ—å¼€å§‹ã€‚
- `to: r.posts.ownerId` æŒ‡å®šå»ºç«‹è½¯å…³è”çš„ç›®æ ‡è¡¨ã€‚
æ­¤å¤„ï¼Œå…³è”æŒ‡å‘ `posts` è¡¨çš„ `ownerId` åˆ—ã€‚
- `optional: false` åœ¨ç±»å‹å±‚é¢è¡¨ç¤º `posts` å¯¹è±¡ä¸­çš„ `feed` é”®ä¸ºå¿…éœ€ã€‚
å½“ä½ ç¡®å®šè¯¥å®ä½“å¿…å®šå­˜åœ¨æ—¶åº”ä½¿ç”¨ã€‚
- `alias` ç”¨äºä¸ºä¸¤ä¸ªè¡¨ä¹‹é—´çš„å…³ç³»æ·»åŠ ç‰¹å®šåˆ«åã€‚å¦‚æœä¸¤ä¸ªè¡¨ä¹‹é—´æœ‰å¤šä¸ªç›¸åŒçš„å…³ç³»ï¼Œåº”ä½¿ç”¨ `alias` è¿›è¡ŒåŒºåˆ†ã€‚
- `where` æ¡ä»¶å¯ç”¨äºå¤šæ€å…³ç³»ï¼ŒåŸºäº `where` è¯­å¥ç­›é€‰ã€‚ä¾‹å¦‚ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œåªè·å– `approved` çŠ¶æ€ä¸º true çš„å¸–å­ã€‚æ›´å¤šå…³äºå¤šæ€å…³ç³»ï¼Œè§ [è¿™é‡Œ](/docs/relations-schema-declaration#polymorphic-relations)ã€‚

## ---

### ä¸€å¯¹ä¸€

Drizzle ORM æä¾›äº†é€šè¿‡ `defineRelations` æ–¹æ³•å®šä¹‰è¡¨ä¹‹é—´ `ä¸€å¯¹ä¸€` å…³ç³»çš„æ¥å£ã€‚

ç¤ºä¾‹ï¼šç”¨æˆ·ä¸ç”¨æˆ·é—´çš„ä¸€å¯¹ä¸€å…³ç³»ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥é‚€è¯·å¦ä¸€ä¸ªç”¨æˆ·ï¼ˆè‡ªå¼•ç”¨ç¤ºä¾‹ï¼‰ï¼š

```typescript copy {10-17}
import { pgTable, serial, text, boolean } from 'drizzle-orm/pg-core';
import { defineRelations } from 'drizzle-orm';

export const users = pgTable('users', {
	id: integer().primaryKey(),
	name: text(),
	invitedBy: integer('invited_by'),
});

export const relations = defineRelations({ users }, (r) => ({
	users: {
		invitee: r.one.users({
			from: r.users.invitedBy,
			to: r.users.id,
		})
	}
}));
```

å¦ä¸€ä¸ªä¾‹å­ï¼šç”¨æˆ·çš„ä¸ªäººèµ„æ–™ä¿¡æ¯å­˜å‚¨åœ¨ç‹¬ç«‹è¡¨ä¸­ã€‚ç”±äºå¤–é”®å­˜å‚¨åœ¨ `profile_info` è¡¨ï¼Œç”¨æˆ·çš„å…³ç³»æ²¡æœ‰å­—æ®µæˆ–å¼•ç”¨ï¼Œè¿™æ„å‘³ç€ Typescript æ¨æ–­ `user.profileInfo` æ˜¯å¯ç©ºçš„ï¼š

```typescript copy {15-22}
import { pgTable, serial, text, integer, jsonb } from 'drizzle-orm/pg-core';
import { defineRelations } from 'drizzle-orm';

export const users = pgTable('users', {
	id: integer().primaryKey(),
	name: text(),
});

export const profileInfo = pgTable('profile_info', {
	id: serial().primaryKey(),
	userId: integer('user_id').references(() => users.id),
	metadata: jsonb(),
});

export const relations = defineRelations({ users, profileInfo }, (r) => ({
	users: {
		profileInfo: r.one.profileInfo({
			from: r.users.id,
			to: r.profileInfo.userId,
		})
	}
}));

const user = await db.query.posts.findFirst({ with: { profileInfo: true } });
//____^? ç±»å‹ { id: number, profileInfo: { ... } | null  }
```

### ä¸€å¯¹å¤š

Drizzle ORM æä¾›äº†é€šè¿‡ `defineRelations` æ–¹æ³•å®šä¹‰è¡¨ä¹‹é—´ `ä¸€å¯¹å¤š` å…³ç³»çš„æ¥å£ã€‚

ç¤ºä¾‹ï¼šç”¨æˆ·ä¸å…¶æ‰€æœ‰å¸–å­çš„ `ä¸€å¯¹å¤š` å…³ç³»ï¼š

```typescript copy {15-25}
import { pgTable, serial, text, integer } from 'drizzle-orm/pg-core';
import { defineRelations } from 'drizzle-orm';

export const users = pgTable('users', {
	id: integer('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: integer('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id'),
});

export const relations = defineRelations({ users, posts }, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  },
  users: {
    posts: r.many.posts(),
  },
}));
```

ç°åœ¨ç»™å¸–å­æ·»åŠ è¯„è®ºï¼š
```typescript copy {9-14,22,27-32}
...

export const posts = pgTable('posts', {
	id: integer('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id'),
});

export const comments = pgTable("comments", {
  id: integer().primaryKey(),
  text: text(),
  authorId: integer("author_id"),
  postId: integer("post_id"),
});

export const relations = defineRelations({ users, posts, comments }, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
    comments: r.many.comments(),
  },
  users: {
    posts: r.many.posts(),
  },
  comments: {
    post: r.one.posts({
      from: r.comments.postId,
      to: r.posts.id,
    }),
  },
}));
```


### å¤šå¯¹å¤š

Drizzle ORM æä¾›äº†é€šè¿‡æ‰€è°“çš„â€œè¿æ¥è¡¨â€æˆ–â€œä¸­é—´è¡¨â€å®šä¹‰è¡¨ä¹‹é—´ `å¤šå¯¹å¤š` å…³ç³»çš„æ¥å£ï¼Œ
è¿™ç±»è¡¨éœ€è¦æ˜¾å¼å®šä¹‰ï¼Œå¹¶å­˜å‚¨ç›¸å…³è¡¨ä¹‹é—´çš„å…³è”ã€‚

ç¤ºä¾‹ï¼šç”¨æˆ·ä¸ç¾¤ç»„çš„å¤šå¯¹å¤šå…³ç³»ï¼Œä½¿ç”¨ `through` ç›´æ¥è·³è¿‡è¿æ¥è¡¨é€‰æ‹©ï¼Œä¸ºæ¯ä¸ªç”¨æˆ·é€‰æ‹©å¤šä¸ªç¾¤ç»„ã€‚

```typescript copy {27-39}
import { defineRelations } from 'drizzle-orm';
import { integer, pgTable, primaryKey, text } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: integer().primaryKey(),
  name: text(),
});

export const groups = pgTable('groups', {
  id: integer().primaryKey(),
  name: text(),
});

export const usersToGroups = pgTable(
  'users_to_groups',
  {
    userId: integer('user_id')
      .notNull()
      .references(() => users.id),
    groupId: integer('group_id')
      .notNull()
      .references(() => groups.id),
  },
  (t) => [primaryKey({ columns: [t.userId, t.groupId] })],
);

export const relations = defineRelations({ users, groups, usersToGroups },
  (r) => ({
    users: {
      groups: r.many.groups({
        from: r.users.id.through(r.usersToGroups.userId),
        to: r.groups.id.through(r.usersToGroups.groupId),
      }),
    },
    groups: {
      participants: r.many.users(),
    },
  })
);
```

**æŸ¥è¯¢ç¤ºä¾‹ï¼š**
```ts
const res = await db.query.users.findMany({
  with: { 
    groups: true 
  },
});

// å“åº”ç±»å‹
type Response = {
  id: number;
  name: string | null;
  groups: {
    id: number;
    name: string | null;
  }[];
}[];
```

<Callout type='error' title='å…³ç³»æŸ¥è¯¢ v1'>
ä¹‹å‰ï¼Œä½ éœ€è¦é€šè¿‡è¿æ¥è¡¨è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åå¯¹æ¯ä¸ªå“åº”è¿›è¡Œæ˜ å°„ã€‚

âŒ ç°åœ¨ä½ ä¸éœ€è¦è¿™æ ·åšäº†ï¼
```ts
const response = await db._query.users.findMany({
	with: {
		usersToGroups: {
			columns: {},
			with: {
				groups: true,
			},
		},
	},
});

// å“åº”ç±»å‹
type Response = {
  id: number;
  name: string | null;
  usersToGroups: {
    groups: {
       id: number;
       name: string | null;
    }
  }[];
}[];
```
</Callout>

### é¢„å®šä¹‰è¿‡æ»¤å™¨

åœ¨ Drizzle å…³ç³»å®šä¹‰ä¸­ï¼Œé¢„å®šä¹‰çš„ `where` è¯­å¥æ˜¯ä¸€ç§å¤šæ€å…³ç³»çš„å®ç°å½¢å¼ï¼Œè™½ç„¶ä¸æ˜¯å®Œå…¨ç›¸åŒã€‚
æœ¬è´¨ä¸Šï¼Œé¢„å®šä¹‰è¿‡æ»¤å™¨å…è®¸ä½ ä¸ä»…ä»…é€šè¿‡æŒ‡å®šåˆ—è¿›è¡Œè¿æ¥ï¼Œè¿˜å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„ `where` è¯­å¥æ¥è¿æ¥è¡¨ã€‚æ¥çœ‹å‡ ä¸ªç¤ºä¾‹ï¼š

æˆ‘ä»¬å¯ä»¥å®šä¹‰ `groups` ä¸ `users` ä¹‹é—´çš„å…³ç³»ï¼Œåœ¨æŸ¥è¯¢ç¾¤ç»„ç”¨æˆ·æ—¶ï¼Œåªè·å– `verified` å­—æ®µä¸º true çš„ç”¨æˆ·ã€‚

<CodeTabs items={["å…³ç³»", "æ¨¡å¼"]}>
<Section>
```ts
import { defineRelations } from "drizzle-orm";
import * as p from "drizzle-orm/pg-core";
import * as schema from './schema';

export const relations = defineRelations(schema,(r) => ({
    groups: {
      verifiedUsers: r.many.users({
        from: r.groups.id.through(r.usersToGroups.groupId),
        to: r.users.id.through(r.usersToGroups.userId),
        where: {
          verified: true,
        },
      }),
    },
  })
);

...

await db.query.groups.findMany({
    with: {
      verifiedUsers: true,
    },
});
```
</Section>
<Section>
```ts
import { defineRelations } from "drizzle-orm";
import * as p from "drizzle-orm/pg-core";

export const users = p.pgTable("users", {
  id: p.integer().primaryKey(),
  name: p.text().notNull(),
  verified: p.boolean().notNull(),
});

export const groups = p.pgTable("groups", {
  id: p.integer().primaryKey(),
  title: p.text().notNull(),
});

export const usersToGroups = p.pgTable(
  "users_to_groups",
  {
    userId: p
      .integer("user_id")
      .notNull()
      .references(() => users.id, { onDelete: "cascade" }),
    groupId: p
      .integer("group_id")
      .notNull()
      .references(() => groups.id, { onDelete: "cascade" }),
  },
  (t) => [p.primaryKey({ columns: [t.groupId, t.userId] })]
);
```
</Section>
</CodeTabs>

<Callout type='warning'>
ä½ åªèƒ½å¯¹ç›®æ ‡è¡¨ï¼ˆtoï¼‰æŒ‡å®šè¿‡æ»¤å™¨ã€‚å› æ­¤åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ`where` å­å¥åªåº”åŒ…å«æ¥è‡ª `users` è¡¨çš„åˆ—ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯å»ºç«‹ **åˆ° users** çš„å…³ç³»ã€‚

```ts {7}
export const relations = defineRelations(schema,(r) => ({
    groups: {
      verifiedUsers: r.many.users({
        from: r.groups.id.through(r.usersToGroups.groupId),
        to: r.users.id.through(r.usersToGroups.userId),
        where: {
          verified: true,
        },
      }),
    },
  })
);
```
</Callout>

## ---

### å…³ç³»æ‹†åˆ†éƒ¨åˆ†

å¦‚æœä½ éœ€è¦å°†å…³ç³»é…ç½®æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œå¯ä»¥ä½¿ç”¨ `defineRelationsPart` è¾…åŠ©æ–¹æ³•

```ts
import { defineRelations, defineRelationsPart } from 'drizzle-orm';
import * as schema from "./schema";

export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  }
}));

export const part = defineRelationsPart(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  }
}));
```

ç„¶åä½ å¯ä»¥ä¼ ç»™æ•°æ®åº“å®ä¾‹ä½¿ç”¨

```ts
const db = drizzle(process.env.DB_URL, { relations: { ...relations, ...part } })
```

<Callout type='warning'>
ä¸ºç¡®ä¿ `defineRelationsParts` æ­£å¸¸å·¥ä½œï¼Œéœ€éµå®ˆä»¥ä¸‹å‡ ä¸ªè§„åˆ™ï¼š

**è§„åˆ™1**ï¼šå¦‚æœä½ ç”¨ parts å½¢å¼ä¼ é€’å…³ç³»ï¼Œè°ƒç”¨ drizzle æ•°æ®åº“å‡½æ•°æ—¶å¿…é¡»ä¿è¯é¡ºåºæ­£ç¡®ï¼ˆä¸»å…³ç³»åº”è¯¥ä¼˜å…ˆï¼‰

```ts
// âœ…
const db = drizzle(process.env.DB_URL, { relations: { ...relations, ...part } })

// âŒ
const db = drizzle(process.env.DB_URL, { relations: { ...part, ...relations } })
```

<Callout collapsed="ä¸ºä»€ä¹ˆå¾ˆé‡è¦ï¼Ÿ">
å³ä½¿æ²¡æœ‰ç±»å‹æˆ–è¿è¡Œæ—¶é”™è¯¯ï¼Œè¿™ä¹Ÿæ˜¯å¯¹è±¡æ‰©å±•ç¬¦ `...` çš„æ­£å¸¸å·¥ä½œè§„åˆ™ã€‚ä¸»å…³ç³»é€’å½’æ¨æ–­æ‰€æœ‰è¡¨åï¼Œç¡®ä¿èƒ½åœ¨è‡ªåŠ¨è¡¥å…¨ä¸­å¯ç”¨ã€‚ç¤ºä¾‹ï¼š

```ts
export const relations = defineRelations(schema, (r) => ({
  users: {
    invitee: r.one.users({
      from: r.users.invitedBy,
      to: r.users.id,
    }),
    posts: r.many.posts(),
  }
}));

export const part = defineRelationsPart(schema, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  }
}));
```

è¿™é‡Œ `relations` å’Œ `part` å¯åˆ†åˆ«è¡¨ç¤ºä¸ºä¸‹é¢å¯¹è±¡ï¼š

```json
// relations
{
  "users": {"invitee": {...}, "posts": {...}},
  // æ·»åŠ åœ¨è¿™é‡Œï¼Œç¡®ä¿æ‰€æœ‰ schema è¡¨å­˜åœ¨äºè‡ªåŠ¨è¡¥å…¨ä¸­
  "posts": {}
}

// part
{
  "posts": {"author": {...}}
}
```

åˆå¹¶ `{ ...relations, ...part }` ç»“æœæ˜¯ï¼š

```json
{
  "users": {"invitee": {...}, "posts": {...}},
  "posts": {"author": {...}}
}
```

è€Œåˆå¹¶ `{ ...part, ...relations }` ç»“æœä¼šæ˜¯ï¼š

```json
{
  "users": {"invitee": {...}, "posts": {...}},
  // ä½ å¯ä»¥çœ‹åˆ°æœ€ç»ˆå¯¹è±¡ä¸­ posts å…³ç³»ä¿¡æ¯ä¼šä¸¢å¤±
  "posts": {}
}
```

</Callout>

**è§„åˆ™2**ï¼šä½ åº”è¯¥è‡³å°‘æœ‰ä¸€ä¸ªå…³ç³»ï¼Œä»¥ä¾¿ drizzle èƒ½æ¨æ–­æ‰€æœ‰è¡¨åç”¨äºè‡ªåŠ¨è¡¥å…¨ã€‚å¦‚æœåªæƒ³ä½¿ç”¨ partsï¼Œåˆ™å…¶ä¸­ä¸€ä¸ª parts åº”è¯¥æ˜¯ç©ºçš„ï¼Œæ¯”å¦‚ï¼š

```ts
export const mainPart = defineRelationsPart(schema);
```

è¿™æ ·å°±èƒ½æ­£ç¡®æ¨æ–­æ‰€æœ‰è¡¨å¹¶æ‹¥æœ‰å®Œæ•´çš„ Schema ä¿¡æ¯ã€‚
</Callout>

## ---

### æ€§èƒ½

åœ¨ä½¿ç”¨ Drizzle ORM å¤„ç†å…³ç³»æ—¶ï¼Œå°¤å…¶å¯¹äºæ•°æ®é‡å¤§æˆ–æŸ¥è¯¢å¤æ‚çš„åº”ç”¨ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½è‡³å…³é‡è¦ã€‚  
ç´¢å¼•åœ¨åŠ é€Ÿæ•°æ®æ£€ç´¢æ–¹é¢æ‰®æ¼”ç€å…³é”®è§’è‰²ï¼Œç‰¹åˆ«æ˜¯åœ¨æŸ¥è¯¢ç›¸å…³æ•°æ®æ—¶ã€‚  
æœ¬èŠ‚æ¦‚è¿°äº†ä¸ºæ¯ç§ Drizzle ORM å®šä¹‰çš„å…³ç³»ç±»å‹æ¨èçš„ç´¢å¼•ç­–ç•¥ã€‚

##### ä¸€å¯¹ä¸€å…³ç³»

å¯¹äºä¸€å¯¹ä¸€å…³ç³»ï¼Œä¾‹å¦‚ã€Œç”¨æˆ·é‚€è¯·ç”¨æˆ·ã€æˆ–ã€Œç”¨æˆ·æ‹¥æœ‰ä¸ªäººèµ„æ–™ä¿¡æ¯ã€ç¤ºä¾‹ï¼Œå…³é”®åœ¨äºé«˜æ•ˆå…³è”è¿æ¥ã€‚

<Callout>
åœ¨ä¸€å¯¹ä¸€å…³ç³»ä¸­ï¼Œå»ºè®®åœ¨è¢«å¼•ç”¨çš„å¤–é”®åˆ—ï¼ˆå…³ç³»ä¸­â€œç›®æ ‡â€è¡¨æ‰€åœ¨è¡¨ï¼‰åˆ›å»ºç´¢å¼•ã€‚
</Callout>

<Callout collapsed='ä¸ºä½•é‡è¦'>
å½“ä½ æŸ¥è¯¢æœ‰ç›¸å…³ä¸€å¯¹ä¸€ä¿¡æ¯çš„æ•°æ®æ—¶ï¼ŒDrizzle æ‰§è¡Œ JOIN æ“ä½œã€‚  
åœ¨å¤–é”®åˆ—ä¸Šåˆ›å»ºç´¢å¼•è®©æ•°æ®åº“èƒ½å¿«é€Ÿå®šä½ç›®æ ‡è¡¨ä¸­ç›¸å…³è¡Œï¼Œå¤§å¹…æå‡è¿æ¥æ€§èƒ½ã€‚
</Callout>

**ç¤ºä¾‹ï¼š**
```typescript
import * as p from 'drizzle-orm/pg-core';
import { defineRelations } from 'drizzle-orm';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text(),
});

export const profileInfo = p.pgTable('profile_info', {
	id: p.integer().primaryKey(),
	userId: p.integer('user_id').references(() => users.id),
	metadata: p.jsonb(),
});

export const relations = defineRelations({ users, profileInfo }, (r) => ({
	users: {
		profileInfo: r.one.profileInfo({
			from: r.users.id,
			to: r.profileInfo.userId,
		})
	}
}));
```

ä¸ºäº†ä¼˜åŒ–åŒæ—¶è·å–ç”¨æˆ·åŠå…¶ä¸ªäººèµ„æ–™ä¿¡æ¯çš„æŸ¥è¯¢ï¼Œä½ åº”è¯¥ä¸º `profile_info` è¡¨çš„ `userId` åˆ—åˆ›å»ºç´¢å¼•ã€‚

```typescript {13-15,21}
import * as p from 'drizzle-orm/pg-core';
import { defineRelations } from 'drizzle-orm';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text(),
});

export const profileInfo = pgTable('profile_info', {
	id: p.integer().primaryKey(),
	userId: p.integer('user_id').references(() => users.id),
	metadata: p.jsonb(),
}, (table) => [
  p.index('profile_info_user_id_idx').on(table.userId)
]);

export const relations = defineRelations({ users, profileInfo }, (r) => ({
	users: {
		profileInfo: r.one.profileInfo({
			from: r.users.id,
			to: r.profileInfo.userId,
		})
	}
}));
```
```sql
CREATE INDEX idx_profile_info_user_id ON profile_info (user_id);
```

#### ä¸€å¯¹å¤šå…³ç³»

ä¸€å¯¹å¤šå…³ç³»åŒæ ·ä¾èµ–ç´¢å¼•ä¼˜åŒ–è¿æ¥æŸ¥è¯¢ã€‚ä¾‹å¦‚ç”¨æˆ·ä¸å¸–å­å¤šå¯¹ä¸€å…³ç³»ã€‚

<Callout>
å¯¹äºä¸€å¯¹å¤šå…³ç³»ï¼Œåº”åœ¨â€œå¤šâ€æ–¹çš„å¤–é”®åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆæ­¤è¡¨åŒ…å«å¤–é”®æŒ‡å‘â€œä¸€â€æ–¹è¡¨ï¼‰ã€‚
</Callout>

<Callout collapsed='ä¸ºä½•é‡è¦'>
å½“ä½ æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·åŠå…¶å¸–å­ï¼Œæˆ–å¸–å­åŠå…¶ä½œè€…æ—¶ä¼šæ‰§è¡Œè¿æ¥æ“ä½œã€‚  
ä¸º `posts` è¡¨çš„å¤–é”®åˆ—ï¼ˆä¾‹å¦‚ `authorId`ï¼‰å»ºç«‹ç´¢å¼•èƒ½è®©æ•°æ®åº“æ›´é«˜æ•ˆåœ°è·å–å¯¹åº”çš„å¸–å­æˆ–ä½œè€…ã€‚
</Callout>

**ç¤ºä¾‹ï¼š**
```typescript
import * as p from "drizzle-orm/pg-core";
import { defineRelations } from 'drizzle-orm';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text(),
});

export const posts = p.pgTable('posts', {
	id: p.integer().primaryKey(),
	content: p.text(),
	authorId: p.integer('author_id'),
});

export const relations = defineRelations({ users, posts }, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  },
  users: {
    posts: r.many.posts(),
  },
}));
```

ä¸ºäº†ä¼˜åŒ–ç”¨æˆ·å’Œå¸–å­æŸ¥è¯¢ï¼Œåº”è¯¥ä¸º `posts` è¡¨çš„ `authorId` åˆ—åˆ›å»ºç´¢å¼•ã€‚

```typescript {13-15}
import * as p from "drizzle-orm/pg-core";
import { defineRelations } from 'drizzle-orm';

export const users = p.pgTable('users', {
	id: p.integer().primaryKey(),
	name: p.text(),
});

export const posts = p.pgTable('posts', {
	id: p.integer().primaryKey(),
	content: p.text(),
	authorId: p.integer('author_id'),
}, (t) => [
  index('posts_author_id_idx').on(table.authorId)
]);

export const relations = defineRelations({ users, posts }, (r) => ({
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
    }),
  },
  users: {
    posts: r.many.posts(),
  },
}));
```
```sql
CREATE INDEX idx_posts_author_id ON posts (author_id);
```

#### å¤šå¯¹å¤šå…³ç³»

å¤šå¯¹å¤šå…³ç³»é€šè¿‡è¿æ¥è¡¨å®ç°ï¼Œå¯¹è¿æ¥è¡¨ç´¢å¼•ç­–ç•¥è¦æ±‚æ›´å¤æ‚ã€‚ä»¥ç”¨æˆ·ä¸ç¾¤ç»„ç¤ºä¾‹ä¸­ `usersToGroups` è¡¨ä¸ºä¾‹ã€‚

<Callout>
é’ˆå¯¹å¤šå¯¹å¤šå…³ç³»ï¼Œå»ºè®®ä¸ºè¿æ¥è¡¨åˆ›å»ºä»¥ä¸‹ç´¢å¼•ï¼š
1. å•ç‹¬ä¸ºæ¯ä¸ªå¤–é”®åˆ—åˆ†åˆ«åˆ›å»ºç´¢å¼•ï¼šä¼˜åŒ–åŸºäºå…¶ä¸­ä¸€ä¾§å…³ç³»çš„ç­›é€‰æˆ–è¿æ¥ï¼ˆä¾‹å¦‚ï¼ŒæŸ¥è¯¢æŸç”¨æˆ·çš„æ‰€æœ‰ç¾¤ç»„æˆ–æŸç¾¤ç»„çš„æ‰€æœ‰ç”¨æˆ·ï¼‰ã€‚
2. è”åˆç´¢å¼•ï¼ˆç»„åˆç´¢å¼•ï¼‰è¦†ç›–ä¸¤ä¸ªå¤–é”®åˆ—ï¼šå¯¹å¿«é€Ÿå®šä½è¿æ¥å…³ç³»å°¤ä¸ºé‡è¦ï¼Œæå‡å¤šå¯¹å¤šå…³ç³»æŸ¥è¯¢æ•ˆç‡ã€‚
</Callout>

<Callout collapsed='ä¸ºä½•é‡è¦'>
åœ¨æŸ¥è¯¢å¤šå¯¹å¤šå…³ç³»ï¼Œå°¤å…¶æ˜¯ Drizzle ORM ä½¿ç”¨ `through` å®ç°æ—¶ï¼Œæ•°æ®åº“éœ€é«˜æ•ˆå®šä½è¿æ¥è¡¨æ•°æ®ã€‚

- å¯¹å•ä¸ªå¤–é”®åˆ—ï¼ˆå¦‚ `userId`ã€`groupId`ï¼‰åˆ›å»ºç´¢å¼•æœ‰åŠ©äºä»ä¸€ä¾§æŸ¥æ‰¾å¦ä¸€ä¾§çš„å…³è”ã€‚
- å¯¹ `(userId, groupId)` åˆ›å»ºè”åˆç´¢å¼•å¯åŠ é€ŸæŸ¥è¯¢è¿æ¥å…³ç³»ï¼Œæå‡å¤šå¯¹å¤šå…³è”å®ä½“çš„æŸ¥è¯¢æ€§èƒ½ã€‚
</Callout>

**ç¤ºä¾‹ï¼š**

ç”¨æˆ·ä¸ç¾¤ç»„çš„å¤šå¯¹å¤šå…³è”é€šè¿‡ `usersToGroups` è¿æ¥è¡¨å®ç°ã€‚

```typescript
import { defineRelations } from 'drizzle-orm';
import * as p from 'drizzle-orm/pg-core';

export const users = p.pgTable('users', {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const groups = p.pgTable('groups', {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const usersToGroups = p.pgTable(
  'users_to_groups',
  {
    userId: p.integer('user_id')
      .notNull()
      .references(() => users.id),
    groupId: p.integer('group_id')
      .notNull()
      .references(() => groups.id),
  },
  (t) => [p.primaryKey({ columns: [t.userId, t.groupId] })],
);

export const relations = defineRelations({ users, groups, usersToGroups },
  (r) => ({
    users: {
      groups: r.many.groups({
        from: r.users.id.through(r.usersToGroups.userId),
        to: r.groups.id.through(r.usersToGroups.groupId),
      }),
    },
    groups: {
      participants: r.many.users(),
    },
  })
);
```

ä¼˜åŒ–æŸ¥è¯¢åº”ä¸º `usersToGroups` è¡¨åˆ›å»ºä»¥ä¸‹ç´¢å¼•ï¼š

```typescript {26-28}
import { defineRelations } from 'drizzle-orm';
import * as p from 'drizzle-orm/pg-core';

export const users = p.pgTable('users', {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const groups = p.pgTable('groups', {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const usersToGroups = p.pgTable(
  'users_to_groups',
  {
    userId: p.integer('user_id')
      .notNull()
      .references(() => users.id),
    groupId: p.integer('group_id')
      .notNull()
      .references(() => groups.id),
  },
  (t) => [
    p.primaryKey({ columns: [t.userId, t.groupId] }),
    p.index('users_to_groups_user_id_idx').on(table.userId),
    p.index('users_to_groups_group_id_idx').on(table.groupId),
    p.index('users_to_groups_composite_idx').on(table.userId, table.groupId),
  ],
);

export const relations = defineRelations({ users, groups, usersToGroups },
  (r) => ({
    users: {
      groups: r.many.groups({
        from: r.users.id.through(r.usersToGroups.userId),
        to: r.groups.id.through(r.usersToGroups.groupId),
      }),
    },
    groups: {
      participants: r.many.users(),
    },
  })
);
```
```sql
CREATE INDEX idx_users_to_groups_user_id ON users_to_groups (user_id);
CREATE INDEX idx_users_to_groups_group_id ON users_to_groups (group_id);
CREATE INDEX idx_users_to_groups_composite ON users_to_groups (userId, groupId);
```

åº”ç”¨è¿™äº›ç´¢å¼•ç­–ç•¥åï¼Œéšç€æ•°æ®é‡å¢é•¿å’ŒæŸ¥è¯¢å¤æ‚æ€§æå‡ï¼Œä½ çš„ Drizzle ORM åº”ç”¨åœ¨å¤„ç†å…³ç³»æ•°æ®æ—¶æ€§èƒ½ä¼šæ˜¾è‘—æå‡ã€‚è¯·æ ¹æ®ä½ çš„å…·ä½“æŸ¥è¯¢æ¨¡å¼å’Œéœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„ç´¢å¼•ã€‚

## ---

### å¤–é”®

ä½ å¯èƒ½æ³¨æ„åˆ°ï¼Œ`relations` çœ‹èµ·æ¥ç±»ä¼¼äºå¤–é”® â€” å®ƒä»¬ç”šè‡³æœ‰ä¸€ä¸ª `references` å±æ€§ã€‚é‚£ä¹ˆå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

è™½ç„¶å¤–é”®å’Œ `relations` éƒ½è¡¨ç¤ºè¡¨ä¹‹é—´çš„å…³ç³»ï¼Œä½†å®ƒä»¬å·¥ä½œåœ¨ä¸åŒå±‚çº§ã€‚

å¤–é”®æ˜¯æ•°æ®åº“çº§åˆ«çš„çº¦æŸï¼Œæ¯æ¬¡ `insert`/`update`/`delete` æ“ä½œæ—¶éƒ½ä¼šæ ¡éªŒï¼Œå¦‚æœè¿åçº¦æŸä¼šæŠ›å‡ºé”™è¯¯ã€‚
è€Œ `relations` æ˜¯é«˜å±‚æŠ½è±¡ï¼Œä»…ç”¨äºåº”ç”¨å±‚å®šä¹‰è¡¨ä¹‹é—´çš„å…³ç³»ã€‚
å®ƒä»¬ä¸ä¼šå½±å“æ•°æ®åº“æ¶æ„ï¼Œä¹Ÿä¸ä¼šéšå¼åˆ›å»ºå¤–é”®ã€‚

è¿™æ„å‘³ç€ `relations` å’Œå¤–é”®å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œä½†å½¼æ­¤ç‹¬ç«‹ã€‚
ä½ å¯ä»¥ä¸å®šä¹‰å¤–é”®æ¥å®šä¹‰ `relations` ï¼ˆåä¹‹äº¦ç„¶ï¼‰ï¼Œè¿™å…è®¸ `relations` ç”¨äºä¸æ”¯æŒå¤–é”®çš„æ•°æ®åº“ã€‚

ä¸‹é¢ä¸¤æ®µç¤ºä¾‹åœ¨ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ—¶æ•ˆæœå®Œå…¨ç›¸åŒã€‚

<CodeTabs items={["schema1.ts", "schema2.ts"]}>
<CodeTab>
```ts {15}
export const users = p.pgTable("users", {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const profileInfo = p.pgTable("profile_info", {
  id: p.integer().primaryKey(),
  userId: p.integer("user_id"),
  metadata: p.jsonb(),
});

export const relations = defineRelations({ users, profileInfo }, (r) => ({
  users: {
    profileInfo: r.one.profileInfo({
      from: r.users.id,
      to: r.profileInfo.userId,
    }),
  },
}));
```
</CodeTab>
<CodeTab>
```ts {15}
export const users = p.pgTable("users", {
  id: p.integer().primaryKey(),
  name: p.text(),
});

export const profileInfo = p.pgTable("profile_info", {
  id: p.integer().primaryKey(),
  userId: p.integer("user_id").references(() => users.id),
  metadata: p.jsonb(),
});

export const relations = defineRelations({ users, profileInfo }, (r) => ({
  users: {
    profileInfo: r.one.profileInfo({
      from: r.users.id,
      to: r.profileInfo.userId,
    }),
  },
}));
```
</CodeTab>
</CodeTabs>

### å…³ç³»æ­§ä¹‰æ¶ˆé™¤

Drizzle è¿˜æä¾›äº† `alias` é€‰é¡¹ï¼Œç”¨äºåœ¨åŒä¸¤å¼ è¡¨ä¹‹é—´å®šä¹‰å¤šä¸ªå…³ç³»æ—¶è¿›è¡ŒåŒºåˆ†ã€‚ä¾‹å¦‚ä½ å®šä¹‰ä¸€ä¸ª `posts` è¡¨ï¼Œå…¶ä¸­æœ‰ `author` å’Œ `reviewer` ä¸¤ä¸ªå…³ç³»ï¼š

```ts {19,22,29,34}
import { pgTable, integer, text } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
 
export const users = pgTable('users', {
	id: integer('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: integer('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id'),
	reviewerId: integer('reviewer_id'),
});
 
export const relations = defineRelations({ users, posts }, (r) => ({
  users: {
    posts: r.many.posts({
      alias: "author",
    }),
    reviewedPosts: r.many.posts({
      alias: "reviewer",
    }),
  },
  posts: {
    author: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
      alias: "author",
    }),
    reviewer: r.one.users({
      from: r.posts.authorId,
      to: r.users.id,
      alias: "reviewer",
    }),
  },
}));
```

### æ•…éšœæ’æŸ¥

Source: https://drizzle.zhcndoc.com/docs/relations

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';

import CodeTab from '@mdx/CodeTab.astro';
import CodeTabs from '@mdx/CodeTabs.astro';

# Drizzle è½¯å…³ç³»
Drizzle å…³ç³»çš„å”¯ä¸€ç›®çš„æ˜¯è®©æ‚¨ä»¥æœ€ç®€å•å’Œç®€æ´çš„æ–¹å¼æŸ¥è¯¢æ‚¨çš„å…³ç³»æ•°æ®ï¼š

<CodeTabs items={["å…³ç³»æŸ¥è¯¢", "å¸¦è¿æ¥çš„é€‰æ‹©"]}>
<Section>
```ts
import * as schema from './schema';
import { drizzle } from 'drizzle-orm/â€¦';

const db = drizzle(client, { schema });

const result = db.query.users.findMany({
  with: {
    posts: true,
  },
});
```
```ts
[{
  id: 10,
  name: "Dan",
  posts: [
    {
      id: 1,
      content: "SQL å¾ˆæ£’",
      authorId: 10,
    },
    {
      id: 2,
      content: "ä½†è¯·æ£€æŸ¥å…³ç³»æŸ¥è¯¢",
      authorId: 10,
    }
  ]
}]
```
</Section>
<Section>
```ts
import { drizzle } from 'drizzle-orm/â€¦';
import { eq } from 'drizzle-orm';
import { posts, users } from './schema';

const db = drizzle(client);

const res = await db.select()
                    .from(users)
                    .leftJoin(posts, eq(posts.authorId, users.id))
                    .orderBy(users.id)
const mappedResult =  
```
</Section>
</CodeTabs>


### ä¸€å¯¹ä¸€
Drizzle ORM ä¸ºæ‚¨æä¾› APIï¼Œé€šè¿‡ `relations` æ“ä½œç¬¦å®šä¹‰è¡¨ä¹‹é—´çš„ `ä¸€å¯¹ä¸€` å…³ç³»ã€‚

ä¸€ä¸ªç”¨æˆ·å¯ä»¥é‚€è¯·å¦ä¸€ä¸ªç”¨æˆ·çš„ `ä¸€å¯¹ä¸€` å…³ç³»ç¤ºä¾‹ï¼ˆæ­¤ç¤ºä¾‹ä½¿ç”¨è‡ªå¼•ç”¨ï¼‰ï¼š

```typescript copy {10-15}
import { pgTable, serial, text, integer, boolean } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
	invitedBy: integer('invited_by'),
});

export const usersRelations = relations(users, ({ one }) => ({
	invitee: one(users, {
		fields: [users.invitedBy],
		references: [users.id],
	}),
}));
```

å¦ä¸€ä¸ªç¤ºä¾‹æ˜¯ç”¨æˆ·åœ¨å•ç‹¬çš„è¡¨ä¸­å­˜å‚¨çš„ä¸ªäººä¿¡æ¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå› ä¸ºå¤–é”®å­˜å‚¨åœ¨â€œprofile_infoâ€è¡¨ä¸­ï¼Œç”¨æˆ·å…³ç³»æ—¢æ²¡æœ‰å­—æ®µä¹Ÿæ²¡æœ‰å¼•ç”¨ã€‚è¿™å‘Šè¯‰ TypeScript `user.profileInfo` æ˜¯å¯é€‰çš„ï¼š

```typescript copy {9-17}
import { pgTable, serial, text, integer, jsonb } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const usersRelations = relations(users, ({ one }) => ({
	profileInfo: one(profileInfo),
}));

export const profileInfo = pgTable('profile_info', {
	id: serial('id').primaryKey(),
	userId: integer('user_id').references(() => users.id),
	metadata: jsonb('metadata'),
});

export const profileInfoRelations = relations(profileInfo, ({ one }) => ({
	user: one(users, { fields: [profileInfo.userId], references: [users.id] }),
}));

const user = await queryUserWithProfileInfo();
//____^? type { id: number, profileInfo: { ... } | null  }
```

### ä¸€å¯¹å¤š
Drizzle ORM ä¸ºæ‚¨æä¾› APIï¼Œé€šè¿‡ `relations` æ“ä½œç¬¦å®šä¹‰è¡¨ä¹‹é—´çš„ `ä¸€å¯¹å¤š` å…³ç³»ã€‚

ç”¨æˆ·ä¸ä»–ä»¬æ’°å†™çš„æ–‡ç« ä¹‹é—´çš„ `ä¸€å¯¹å¤š` å…³ç³»ç¤ºä¾‹ï¼š

```typescript copy {9-11, 19-24}
import { pgTable, serial, text, integer } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const usersRelations = relations(users, ({ many }) => ({
	posts: many(posts),
}));

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id'),
});

export const postsRelations = relations(posts, ({ one }) => ({
	author: one(users, {
		fields: [posts.authorId],
		references: [users.id],
	}),
}));
```

ç°åœ¨è®©æˆ‘ä»¬ä¸ºæ–‡ç« æ·»åŠ è¯„è®ºï¼š
```typescript copy {14,17-22,24-29}
...

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id'),
});

export const postsRelations = relations(posts, ({ one, many }) => ({
	author: one(users, {
		fields: [posts.authorId],
		references: [users.id],
	}),
	comments: many(comments)
}));

export const comments = pgTable('comments', {
	id: serial('id').primaryKey(),
	text: text('text'),
	authorId: integer('author_id'),
	postId: integer('post_id'),
});

export const commentsRelations = relations(comments, ({ one }) => ({
	post: one(posts, {
		fields: [comments.postId],
		references: [posts.id],
	}),
}));
```


### å¤šå¯¹å¤š
Drizzle ORM ä¸ºæ‚¨æä¾› APIï¼Œé€šè¿‡æ‰€è°“çš„ `junction` æˆ– `join` è¡¨å®šä¹‰è¡¨ä¹‹é—´çš„ `å¤šå¯¹å¤š` å…³ç³»ï¼Œ
å®ƒä»¬å¿…é¡»æ˜¾å¼å®šä¹‰å¹¶å­˜å‚¨ç›¸å…³è¡¨ä¹‹é—´çš„å…³è”ã€‚

ç”¨æˆ·ä¸ç»„ä¹‹é—´çš„ `å¤šå¯¹å¤š` å…³ç³»ç¤ºä¾‹ï¼š
```typescript copy {9-11, 18-20, 37-46}
import { relations } from 'drizzle-orm';
import { integer, pgTable, primaryKey, serial, text } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name'),
});

export const usersRelations = relations(users, ({ many }) => ({
  usersToGroups: many(usersToGroups),
}));

export const groups = pgTable('groups', {
  id: serial('id').primaryKey(),
  name: text('name'),
});

export const groupsRelations = relations(groups, ({ many }) => ({
  usersToGroups: many(usersToGroups),
}));

export const usersToGroups = pgTable(
  'users_to_groups',
  {
    userId: integer('user_id')
      .notNull()
      .references(() => users.id),
    groupId: integer('group_id')
      .notNull()
      .references(() => groups.id),
  },
  (t) => [
		primaryKey({ columns: [t.userId, t.groupId] })
	],
);

export const usersToGroupsRelations = relations(usersToGroups, ({ one }) => ({
  group: one(groups, {
    fields: [usersToGroups.groupId],
    references: [groups.id],
  }),
  user: one(users, {
    fields: [usersToGroups.userId],
    references: [users.id],
  }),
}));
```

### å¤–é”®

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œ`relations` çœ‹èµ·æ¥ä¸å¤–é”®ç›¸ä¼¼â€”â€”å®ƒä»¬ç”šè‡³æœ‰ä¸€ä¸ª `references` å±æ€§ã€‚é‚£ä¹ˆåŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

è™½ç„¶å¤–é”®ä¹ŸæœåŠ¡äºç›¸ä¼¼çš„ç›®çš„ï¼Œå®šä¹‰è¡¨ä¹‹é—´çš„å…³ç³»ï¼Œä½†å®ƒä»¬ä¸ `relations` åœ¨ä¸åŒçº§åˆ«ä¸Šå·¥ä½œã€‚

å¤–é”®æ˜¯ä¸€ä¸ªæ•°æ®åº“çº§åˆ«çš„çº¦æŸï¼Œå®ƒä»¬åœ¨æ¯ä¸ª `insert`/`update`/`delete` æ“ä½œæ—¶éƒ½ä¼šè¢«æ£€æŸ¥ï¼Œå¦‚æœè¿åçº¦æŸåˆ™ä¼šæŠ›å‡ºé”™è¯¯ã€‚
å¦ä¸€æ–¹é¢ï¼Œ`relations` æ˜¯ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œä»…ç”¨äºåœ¨åº”ç”¨ç¨‹åºçº§åˆ«å®šä¹‰è¡¨ä¹‹é—´çš„å…³ç³»ã€‚
å®ƒä»¬ä¸ä¼šä»¥ä»»ä½•æ–¹å¼å½±å“æ•°æ®åº“æ¨¡å¼ï¼Œå¹¶ä¸”ä¸ä¼šéšå¼åˆ›å»ºå¤–é”®ã€‚

è¿™æ„å‘³ç€ `relations` å’Œå¤–é”®å¯ä»¥ä¸€èµ·ä½¿ç”¨ï¼Œä½†å®ƒä»¬å½¼æ­¤ä¹‹é—´å¹¶ä¸ä¾èµ–ã€‚
æ‚¨å¯ä»¥å®šä¹‰ `relations` è€Œä¸ä½¿ç”¨å¤–é”®ï¼ˆåä¹‹äº¦ç„¶ï¼‰ï¼Œè¿™ä½¿å¾—å®ƒä»¬ä¸ä¸æ”¯æŒå¤–é”®çš„æ•°æ®åº“ä¸€èµ·ä½¿ç”¨æˆä¸ºå¯èƒ½ã€‚

ä»¥ä¸‹ä¸¤ä¸ªç¤ºä¾‹åœ¨ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢æ•°æ®çš„æ–¹å¼å®Œå…¨ç›¸åŒã€‚
<CodeTabs items={["schema1.ts", "schema2.ts"]}>
<CodeTab>
```ts {15}
export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const usersRelations = relations(users, ({ one, many }) => ({
	profileInfo: one(users, {
		fields: [profileInfo.userId],
		references: [users.id],
	}),
}));

export const profileInfo = pgTable('profile_info', {
	id: serial('id').primaryKey(),
	userId: integer("user_id"),
	metadata: jsonb("metadata"),
});
```
</CodeTab>
<CodeTab>
```ts {15}
export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const usersRelations = relations(users, ({ one, many }) => ({
	profileInfo: one(users, {
		fields: [profileInfo.userId],
		references: [users.id],
	}),
}));

export const profileInfo = pgTable('profile_info', {
	id: serial('id').primaryKey(),
	userId: integer("user_id").references(() => users.id),
	metadata: jsonb("metadata"),
});
```
</CodeTab>
</CodeTabs>

### å¤–é”®æ“ä½œ

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [PostgreSQL å¤–é”®æ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK)ã€‚

æ‚¨å¯ä»¥æŒ‡å®šåœ¨çˆ¶è¡¨ä¸­å¼•ç”¨çš„æ•°æ®è¢«ä¿®æ”¹æ—¶åº”å‘ç”Ÿçš„æ“ä½œã€‚è¿™äº›æ“ä½œç§°ä¸ºâ€œå¤–é”®æ“ä½œâ€ã€‚PostgreSQL æä¾›äº†å‡ ç§é€‰é¡¹ç”¨äºè¿™äº›æ“ä½œã€‚

åˆ é™¤/æ›´æ–°æ“ä½œ

- `CASCADE`ï¼šåˆ é™¤çˆ¶è¡¨ä¸­çš„è¡Œæ—¶ï¼Œå­è¡¨ä¸­çš„æ‰€æœ‰ç›¸åº”è¡Œä¹Ÿå°†è¢«åˆ é™¤ã€‚è¿™ç¡®ä¿äº†å­è¡¨ä¸­ä¸å­˜åœ¨å­¤ç«‹è¡Œã€‚

- `NO ACTION`ï¼šè¿™æ˜¯é»˜è®¤æ“ä½œã€‚å¦‚æœå­è¡¨ä¸­æœ‰ç›¸å…³è¡Œï¼Œå®ƒä¼šé˜»æ­¢åˆ é™¤çˆ¶è¡¨ä¸­çš„è¡Œã€‚çˆ¶è¡¨ä¸­çš„ DELETE æ“ä½œå°†å¤±è´¥ã€‚

- `RESTRICT`ï¼šä¸ NO ACTION ç±»ä¼¼ï¼Œå¦‚æœå­è¡¨ä¸­æœ‰ä¾èµ–è¡Œï¼Œå®ƒä¼šé˜»æ­¢åˆ é™¤çˆ¶è¡Œã€‚å®ƒåŸºæœ¬ä¸Šä¸ NO ACTION ç›¸åŒï¼Œå¹¶ç”±äºå…¼å®¹æ€§åŸå› è¢«åŒ…å«åœ¨å†…ã€‚

- `SET DEFAULT`ï¼šå¦‚æœçˆ¶è¡¨ä¸­çš„è¡Œè¢«åˆ é™¤ï¼Œå­è¡¨ä¸­çš„å¤–é”®åˆ—å°†è¢«è®¾ç½®ä¸ºå…¶é»˜è®¤å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚å¦‚æœæ²¡æœ‰é»˜è®¤å€¼ï¼ŒDELETE æ“ä½œå°†å¤±è´¥ã€‚

- `SET NULL`ï¼šå½“çˆ¶è¡¨ä¸­çš„è¡Œè¢«åˆ é™¤æ—¶ï¼Œå­è¡¨ä¸­çš„å¤–é”®åˆ—å°†è¢«è®¾ç½®ä¸º NULLã€‚æ­¤æ“ä½œå‡è®¾å­è¡¨ä¸­çš„å¤–é”®åˆ—å…è®¸ NULL å€¼ã€‚

> ä¸ ON DELETE ç±»ä¼¼ï¼Œå½“å¼•ç”¨çš„åˆ—è¢«æ›´æ”¹ï¼ˆæ›´æ–°ï¼‰æ—¶ï¼Œè¿˜å­˜åœ¨ ON UPDATEã€‚å¯èƒ½çš„æ“ä½œæ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯ SET NULL å’Œ SET DEFAULT ä¸èƒ½æŒ‡å®šåˆ—åˆ—è¡¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCASCADE æ„å‘³ç€å¼•ç”¨åˆ—çš„æ›´æ–°å€¼åº”å¤åˆ¶åˆ°å¼•ç”¨è¡Œã€‚
åœ¨ drizzle ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `references()` çš„ç¬¬äºŒä¸ªå‚æ•°æ·»åŠ å¤–é”®æ“ä½œã€‚

æ“ä½œç±»å‹

```typescript
export type UpdateDeleteAction = 'cascade' | 'restrict' | 'no action' | 'set null' | 'set default';

// references æ¥å£çš„ç¬¬äºŒä¸ªå‚æ•°
actions?: {
		onUpdate?: UpdateDeleteAction;
		onDelete?: UpdateDeleteAction;
	} | undefined
```

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå°† `onDelete: 'cascade'` æ·»åŠ åˆ° `posts` æ¨¡å¼ä¸­çš„ä½œè€…å­—æ®µæ„å‘³ç€åˆ é™¤ `user` ä¹Ÿå°†åˆ é™¤æ‰€æœ‰ç›¸å…³çš„ Post è®°å½•ã€‚


```typescript {11}
import { pgTable, serial, text, integer } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	name: text('name'),
	author: integer('author').references(() => users.id, {onDelete: 'cascade'}).notNull(),
});
```

å¯¹äºä½¿ç”¨ `foreignKey` æ“ä½œç¬¦æŒ‡å®šçš„çº¦æŸï¼Œå¤–é”®æ“ä½œçš„å®šä¹‰è¯­æ³•ä¸ºï¼š

```typescript {18-19}
import { foreignKey, pgTable, serial, text, integer } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});

export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	name: text('name'),
	author: integer('author').notNull(),
}, (table) => [
	foreignKey({
		name: "author_fk",
		columns: [table.author],
		foreignColumns: [users.id],
	})
		.onDelete('cascade')
		.onUpdate('cascade')
]);
```

### æ¶ˆæ­§ä¹‰å…³ç³»

Drizzle è¿˜æä¾› `relationName` 
é€‰é¡¹ä½œä¸ºåœ¨æ‚¨å®šä¹‰ç›¸åŒä¸¤å¼ è¡¨ä¹‹é—´çš„å¤šä¸ªå…³ç³»æ—¶æ¶ˆæ­§ä¹‰çš„æ–¹å¼ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å®šä¹‰ä¸€å¼ åŒ…å« `author` å’Œ `reviewer` 
å…³ç³»çš„ `posts` è¡¨ã€‚

```ts {9-12, 21-32}
import { pgTable, serial, text, integer } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
 
export const users = pgTable('users', {
	id: serial('id').primaryKey(),
	name: text('name'),
});
 
export const usersRelations = relations(users, ({ many }) => ({
	author: many(posts, { relationName: 'author' }),
	reviewer: many(posts, { relationName: 'reviewer' }),
}));
 
export const posts = pgTable('posts', {
	id: serial('id').primaryKey(),
	content: text('content'),
	authorId: integer('author_id'),
	reviewerId: integer('reviewer_id'),
});
 
export const postsRelations = relations(posts, ({ one }) => ({
	author: one(users, {
		fields: [posts.authorId],
		references: [users.id],
		relationName: 'author',
	}),
	reviewer: one(users, {
		fields: [posts.reviewerId],
		references: [users.id],
		relationName: 'reviewer',
	}),
}));
```


Source: https://drizzle.zhcndoc.com/docs/rls

import Callout from '@mdx/Callout.astro';

# è¡Œçº§å®‰å…¨æ€§ (RLS)

ä½¿ç”¨ Drizzleï¼Œæ‚¨å¯ä»¥ä¸ºä»»ä½• Postgres è¡¨å¯ç”¨è¡Œçº§å®‰å…¨æ€§ (RLS)ï¼Œåˆ›å»ºå…·æœ‰å„ç§é€‰é¡¹çš„ç­–ç•¥ï¼Œå¹¶å®šä¹‰å’Œç®¡ç†è¿™äº›ç­–ç•¥æ‰€åº”ç”¨çš„è§’è‰²ã€‚

Drizzle æ”¯æŒ Postgres ç­–ç•¥å’Œè§’è‰²çš„åŸå§‹è¡¨ç¤ºï¼Œæ‚¨å¯ä»¥ä»¥ä»»ä½•æ–¹å¼ä½¿ç”¨å®ƒä»¬ã€‚ è¿™ä¸æµè¡Œçš„ Postgres æ•°æ®åº“æä¾›è€…å¦‚ `Neon` å’Œ `Supabase` ä¸€èµ·å·¥ä½œã€‚

åœ¨ Drizzle ä¸­ï¼Œæˆ‘ä»¬ä¸ºä¸¤ä¸ªæ•°æ®åº“æä¾›è€…æä¾›äº†ç‰¹å®šçš„é¢„å®šä¹‰ RLS è§’è‰²å’Œå‡½æ•°ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„é€»è¾‘ã€‚

## å¯ç”¨ RLS

<Callout type='warning' collapsed="How it works in 0.x versions">
å¦‚æœæ‚¨åªæƒ³åœ¨è¡¨ä¸Šå¯ç”¨ RLS è€Œä¸æ·»åŠ ç­–ç•¥ï¼Œå¯ä»¥ä½¿ç”¨ `.enableRLS()`

æ­£å¦‚ PostgreSQL æ–‡æ¡£ä¸­æ‰€æåˆ°çš„ï¼š

> å¦‚æœè¡¨ä¸­ä¸å­˜åœ¨ç­–ç•¥ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰è¡Œå¯ä»¥è¢«æŸ¥çœ‹æˆ–ä¿®æ”¹ã€‚
é€‚ç”¨äºæ•´ä¸ªè¡¨çš„æ“ä½œï¼Œå¦‚ TRUNCATE å’Œ REFERENCESï¼Œä¸å—è¡Œå®‰å…¨æ€§çš„é™åˆ¶ã€‚

```ts
import { integer, pgTable } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
	id: integer(),
}).enableRLS();
```
</Callout>

ä» `v1.0.0-beta.1` å¼€å§‹ï¼Œ`.enableRLS()` å·²è¢«å¼ƒç”¨ï¼Œ
å¦‚æœæ‚¨åªæƒ³åœ¨è¡¨ä¸Šå¯ç”¨ RLS è€Œä¸æ·»åŠ ç­–ç•¥ï¼Œå¯ä»¥ä½¿ç”¨ `pgTable.withRLS(...)`

æ­£å¦‚ PostgreSQL æ–‡æ¡£ä¸­æåˆ°çš„ï¼š

> å¦‚æœè¡¨ä¸­ä¸å­˜åœ¨ç­–ç•¥ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ‹’ç»ç­–ç•¥ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰è¡Œå¯ä»¥è¢«æŸ¥çœ‹æˆ–ä¿®æ”¹ã€‚
é€‚ç”¨äºæ•´ä¸ªè¡¨çš„æ“ä½œï¼Œå¦‚ TRUNCATE å’Œ REFERENCESï¼Œä¸å—è¡Œå®‰å…¨æ€§çš„é™åˆ¶ã€‚

```ts
import { integer, pgTable } from 'drizzle-orm/pg-core';

export const users = pgTable.withRLS('users', {
	id: integer(),
});
```

<Callout title='é‡è¦'>
å¦‚æœæ‚¨å‘è¡¨æ·»åŠ ç­–ç•¥ï¼ŒRLS å°†è‡ªåŠ¨å¯ç”¨ã€‚å› æ­¤ï¼Œåœ¨å‘è¡¨æ·»åŠ ç­–ç•¥æ—¶æ— éœ€æ˜¾å¼å¯ç”¨ RLSã€‚
</Callout>

## è§’è‰²

ç›®å‰ï¼ŒDrizzle æ”¯æŒé€šè¿‡å‡ ç§ä¸åŒçš„é€‰é¡¹å®šä¹‰è§’è‰²ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å°†æ¥ç‰ˆæœ¬å°†æ·»åŠ å¯¹æ›´å¤šé€‰é¡¹çš„æ”¯æŒã€‚

```ts
import { pgRole } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin', { createRole: true, createDb: true, inherit: true });
```

å¦‚æœæ•°æ®åº“ä¸­å·²ç»å­˜åœ¨è§’è‰²ï¼Œå¹¶ä¸”æ‚¨ä¸æƒ³è®© drizzle-kit â€œçœ‹åˆ°â€å®ƒæˆ–åŒ…å«å®ƒåœ¨è¿ç§»ä¸­ï¼Œå¯ä»¥å°†è§’è‰²æ ‡è®°ä¸ºç°æœ‰ã€‚

```ts
import { pgRole } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin').existing();
```

## ç­–ç•¥

è¦å……åˆ†åˆ©ç”¨ RLSï¼Œæ‚¨å¯ä»¥åœ¨ Drizzle è¡¨ä¸­å®šä¹‰ç­–ç•¥ã€‚

<Callout title='ä¿¡æ¯'>
åœ¨ PostgreSQL ä¸­ï¼Œç­–ç•¥åº”è¯¥ä¸ç°æœ‰è¡¨å…³è”ã€‚ç”±äºç­–ç•¥æ€»æ˜¯ä¸ç‰¹å®šè¡¨ç›¸å…³è”ï¼Œæˆ‘ä»¬å†³å®šå°†ç­–ç•¥å®šä¹‰ä½œä¸º `pgTable` çš„å‚æ•°è¿›è¡Œå®šä¹‰ã€‚
</Callout>

**pgPolicy çš„ç¤ºä¾‹ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨å±æ€§**
```ts
import { sql } from 'drizzle-orm';
import { integer, pgPolicy, pgRole, pgTable } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin');

export const users = pgTable('users', {
	id: integer(),
}, (t) => [
	pgPolicy('policy', {
		as: 'permissive',
		to: admin,
		for: 'delete',
		using: sql``,
		withCheck: sql``,
	}),
]);
```

**ç­–ç•¥é€‰é¡¹**
|                          |                                                                                                                                           |
| :----------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- |
| `as`                     | å¯èƒ½çš„å€¼ä¸º `permissive` æˆ– `restrictive`                                                                                                 |
| `to`                     | æŒ‡å®šç­–ç•¥é€‚ç”¨çš„è§’è‰²ã€‚å¯èƒ½çš„å€¼åŒ…æ‹¬ `public`ã€`current_role`ã€`current_user`ã€`session_user`ï¼Œæˆ–ä»»ä½•å…¶ä»–è§’è‰²åä½œä¸ºå­—ç¬¦ä¸²ã€‚æ‚¨ä¹Ÿå¯ä»¥å¼•ç”¨ä¸€ä¸ª `pgRole` å¯¹è±¡ã€‚ |
| `for`                    | å®šä¹‰æ­¤ç­–ç•¥å°†åº”ç”¨çš„å‘½ä»¤ã€‚å¯èƒ½çš„å€¼ä¸º `all`ã€`select`ã€`insert`ã€`update`ã€`delete`ã€‚                                                       |
| `using`                  | å°†åº”ç”¨äºç­–ç•¥åˆ›å»ºè¯­å¥çš„ `USING` éƒ¨åˆ†çš„ SQL è¯­å¥ã€‚                                                                                             |
| `withCheck`              | å°†åº”ç”¨äºç­–ç•¥åˆ›å»ºè¯­å¥çš„ `WITH CHECK` éƒ¨åˆ†çš„ SQL è¯­å¥ã€‚                                                                                        |


**å°†ç­–ç•¥é“¾æ¥åˆ°ç°æœ‰è¡¨**

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦å°†ç­–ç•¥é“¾æ¥åˆ°æ•°æ®åº“ä¸­çš„ç°æœ‰è¡¨ã€‚ 
æœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯ä¸ `Neon` æˆ– `Supabase` ç­‰æ•°æ®åº“æä¾›è€…ä¸€èµ·ä½¿ç”¨ï¼Œæ‚¨éœ€è¦å‘å…¶ç°æœ‰è¡¨ä¸­æ·»åŠ ç­–ç•¥ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `.link()` APIã€‚

```ts
import { sql } from "drizzle-orm";
import { pgPolicy } from "drizzle-orm/pg-core";
import { authenticatedRole, realtimeMessages } from "drizzle-orm/supabase";

export const policy = pgPolicy("authenticated role insert policy", {
  for: "insert",
  to: authenticatedRole,
  using: sql``,
}).link(realtimeMessages);
```

{/* <Callout title='é‡è¦'>
<Callout> */}

## è¿ç§»

å¦‚æœæ‚¨ä½¿ç”¨ drizzle-kit æ¥ç®¡ç†æ‚¨çš„æ¶æ„å’Œè§’è‰²ï¼Œå¯èƒ½ä¼šå‡ºç°æ‚¨æƒ³å¼•ç”¨æœªåœ¨ Drizzle æ¶æ„ä¸­å®šä¹‰çš„è§’è‰²çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ› drizzle-kit è·³è¿‡ç®¡ç†è¿™äº›è§’è‰²ï¼Œè€Œä¸å¿…åœ¨æ‚¨çš„ drizzle æ¶æ„ä¸­å®šä¹‰æ¯ä¸ªè§’è‰²ï¼Œå¹¶æ ‡è®°ä¸º `.existing()`ã€‚

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨ `drizzle.config.ts` ä¸­ä½¿ç”¨ `entities.roles`ã€‚æœ‰å…³å®Œæ•´çš„å‚è€ƒï¼Œè¯·å‚é˜… [`drizzle.config.ts`](docs/drizzle-config-file) æ–‡æ¡£ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`drizzle-kit` ä¸ä¼šä¸ºæ‚¨ç®¡ç†è§’è‰²ï¼Œå› æ­¤æ‚¨éœ€è¦åœ¨ `drizzle.config.ts` ä¸­å¯ç”¨æ­¤åŠŸèƒ½ã€‚

```ts {12-14}
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: 'postgresql',
  schema: "./drizzle/schema.ts",
  dbCredentials: {
    url: process.env.DATABASE_URL!
  },
  verbose: true,
  strict: true,
  entities: {
    roles: true
  }
});
```

å¦‚æœæ‚¨éœ€è¦å…¶ä»–é…ç½®é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€äº›æ›´å¤šçš„ç¤ºä¾‹ã€‚

**æ‚¨æœ‰ä¸€ä¸ª `admin` è§’è‰²ï¼Œå¹¶å¸Œæœ›å°†å…¶æ’é™¤åœ¨å¯ç®¡ç†è§’è‰²åˆ—è¡¨ä¹‹å¤–**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      exclude: ['admin']
    }
  }
});
```

**æ‚¨æœ‰ä¸€ä¸ª `admin` è§’è‰²ï¼Œå¹¶å¸Œæœ›å°†å…¶åŒ…æ‹¬åœ¨å¯ç®¡ç†è§’è‰²åˆ—è¡¨ä¸­**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      include: ['admin']
    }
  }
});
```

**å¦‚æœæ‚¨ä½¿ç”¨ `Neon`ï¼Œå¹¶å¸Œæœ›æ’é™¤ Neon å®šä¹‰çš„è§’è‰²ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æä¾›è€…é€‰é¡¹**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      provider: 'neon'
    }
  }
});
```

**å¦‚æœæ‚¨ä½¿ç”¨ `Supabase`ï¼Œå¹¶å¸Œæœ›æ’é™¤ Supabase å®šä¹‰çš„è§’è‰²ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æä¾›è€…é€‰é¡¹**

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      provider: 'supabase'
    }
  }
});
```

<Callout title='é‡è¦'>
æ‚¨å¯èƒ½ä¼šé‡åˆ° Drizzle ä¸æ•°æ®åº“æä¾›è€…æŒ‡å®šçš„æ–°è§’è‰²ç›¸æ¯”ç•¥æ˜¾è¿‡æ—¶çš„æƒ…å†µã€‚ 
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `provider` é€‰é¡¹å’Œ `exclude` æ’é™¤å…¶ä»–è§’è‰²ï¼š

```ts
// drizzle.config.ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  ...
  entities: {
    roles: {
      provider: 'supabase',
      exclude: ['new_supabase_role']
    }
  }
});
```
</Callout>

## RLS åœ¨è§†å›¾ä¸Š

ä½¿ç”¨ Drizzleï¼Œæ‚¨è¿˜å¯ä»¥åœ¨è§†å›¾ä¸ŠæŒ‡å®š RLS ç­–ç•¥ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦åœ¨è§†å›¾çš„ WITH é€‰é¡¹ä¸­ä½¿ç”¨ `security_invoker`ã€‚è¿™æ˜¯ä¸€ä¸ªå°ç¤ºä¾‹ï¼š

<Callout type='warning'>
`getColumns` ä» `drizzle-orm@1.0.0-beta.2` å¼€å§‹å¯ç”¨ï¼ˆè¯¦ç»†è¯·å‚é˜… [è¿™é‡Œ](/docs/upgrade-v1)ï¼‰

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ 1.x ä¹‹å‰çš„ç‰ˆæœ¬ï¼ˆå¦‚ `0.45.1`ï¼‰ï¼Œè¯·ä½¿ç”¨ `getTableColumns`
</Callout>


```ts {5}
...

export const roomsUsersProfiles = pgView("rooms_users_profiles")
  .with({
    securityInvoker: true,
  })
  .as((qb) =>
    qb
      .select({
        ...getColumns(roomsUsers),
        email: profiles.email,
      })
      .from(roomsUsers)
      .innerJoin(profiles, eq(roomsUsers.userId, profiles.id))
  );
```

## ä¸ Neon ä¸€èµ·ä½¿ç”¨

Neon å›¢é˜Ÿå¸®åŠ©æˆ‘ä»¬å®ç°äº†ä»–ä»¬å¯¹æˆ‘ä»¬åŸå§‹ç­–ç•¥ API çš„åŒ…è£…å™¨çš„æ„¿æ™¯ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç‰¹å®šçš„ 
`/neon` å¯¼å…¥ï¼Œå…¶ä¸­åŒ…å« `crudPolicy` å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«é¢„å®šä¹‰å‡½æ•°å’Œ Neon çš„é»˜è®¤è§’è‰²ã€‚

è¿™æ˜¯å¦‚ä½•ä½¿ç”¨ `crudPolicy` å‡½æ•°çš„ç¤ºä¾‹ï¼š

```ts
import { crudPolicy } from 'drizzle-orm/neon';
import { integer, pgRole, pgTable } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin');

export const users = pgTable('users', {
	id: integer(),
}, (t) => [
	crudPolicy({ role: admin, read: true, modify: false }),
]);
```

æ­¤ç­–ç•¥ç­‰æ•ˆäºï¼š

```ts
import { sql } from 'drizzle-orm';
import { integer, pgPolicy, pgRole, pgTable } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin');

export const users = pgTable('users', {
	id: integer(),
}, (t) => [
	pgPolicy(`crud-${admin.name}-policy-insert`, {
		for: 'insert',
		to: admin,
		withCheck: sql`false`,
	}),
	pgPolicy(`crud-${admin.name}-policy-update`, {
		for: 'update',
		to: admin,
		using: sql`false`,
		withCheck: sql`false`,
	}),
	pgPolicy(`crud-${admin.name}-policy-delete`, {
		for: 'delete',
		to: admin,
		using: sql`false`,
	}),
	pgPolicy(`crud-${admin.name}-policy-select`, {
		for: 'select',
		to: admin,
		using: sql`true`,
	}),
]);
```

`Neon` å…¬å¼€äº†é¢„å®šä¹‰çš„ `authenticated` å’Œ `anonymous` è§’è‰²åŠç›¸å…³å‡½æ•°ã€‚å¦‚æœæ‚¨ä½¿ç”¨ `Neon` è¿›è¡Œ RLSï¼Œå¯ä»¥åœ¨æ‚¨çš„ RLS æŸ¥è¯¢ä¸­ä½¿ç”¨è¿™äº›æ ‡è®°ä¸ºç°æœ‰çš„è§’è‰²ä»¥åŠç›¸å…³å‡½æ•°ã€‚

```ts
// drizzle-orm/neon
export const authenticatedRole = pgRole('authenticated').existing();
export const anonymousRole = pgRole('anonymous').existing();

export const authUid = (userIdColumn: AnyPgColumn) => sql`(select auth.user_id() = ${userIdColumn})`;

export const neonIdentitySchema = pgSchema('neon_identity');

export const usersSync = neonIdentitySchema.table('users_sync', {
  rawJson: jsonb('raw_json').notNull(),
  id: text().primaryKey().notNull(),
  name: text(),
  email: text(),
  createdAt: timestamp('created_at', { withTimezone: true, mode: 'string' }),
  deletedAt: timestamp('deleted_at', { withTimezone: true, mode: 'string' }),
});
```

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨ `Neon` é¢„å®šä¹‰çš„è§’è‰²å’Œå‡½æ•°ï¼š


```ts
import { sql } from 'drizzle-orm';
import { authenticatedRole } from 'drizzle-orm/neon';
import { integer, pgPolicy, pgRole, pgTable } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin');

export const users = pgTable('users', {
	id: integer(),
}, (t) => [
	pgPolicy(`policy-insert`, {
		for: 'insert',
		to: authenticatedRole,
		withCheck: sql`false`,
	}),
]);
```

## ä¸ Supabase ä¸€èµ·ä½¿ç”¨

æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª `/supabase` å¯¼å…¥ï¼Œå¸¦æœ‰ä¸€ç»„æ ‡è®°ä¸ºç°æœ‰çš„é¢„å®šä¹‰è§’è‰²ï¼Œæ‚¨å¯ä»¥åœ¨æ¶æ„ä¸­ä½¿ç”¨å®ƒã€‚ 
è¿™ä¸ªå¯¼å…¥å°†åœ¨æœªæ¥çš„å‘å¸ƒä¸­æ‰©å±•ï¼Œæä¾›æ›´å¤šåŠŸèƒ½å’Œå¸®åŠ©å™¨ï¼Œä½¿ RLS å’Œ `Supabase` çš„ä½¿ç”¨æ›´åŠ ç®€å•ã€‚

```ts
// drizzle-orm/supabase
export const anonRole = pgRole('anon').existing();
export const authenticatedRole = pgRole('authenticated').existing();
export const serviceRole = pgRole('service_role').existing();
export const postgresRole = pgRole('postgres_role').existing();
export const supabaseAuthAdminRole = pgRole('supabase_auth_admin').existing();
```

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨ `Supabase` é¢„å®šä¹‰çš„è§’è‰²ï¼š

```ts
import { sql } from 'drizzle-orm';
import { serviceRole } from 'drizzle-orm/supabase';
import { integer, pgPolicy, pgRole, pgTable } from 'drizzle-orm/pg-core';

export const admin = pgRole('admin');

export const users = pgTable('users', {
	id: integer(),
}, (t) => [
	pgPolicy(`policy-insert`, {
		for: 'insert',
		to: serviceRole,
		withCheck: sql`false`,
	}),
]);
```

`/supabase` å¯¼å…¥è¿˜åŒ…æ‹¬æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„é¢„å®šä¹‰è¡¨å’Œå‡½æ•°ã€‚

```ts
// drizzle-orm/supabase

const auth = pgSchema('auth');
export const authUsers = auth.table('users', {
	id: uuid().primaryKey().notNull(),
});

const realtime = pgSchema('realtime');
export const realtimeMessages = realtime.table(
	'messages',
	{
		id: bigserial({ mode: 'bigint' }).primaryKey(),
		topic: text().notNull(),
		extension: text({
			enum: ['presence', 'broadcast', 'postgres_changes'],
		}).notNull(),
	},
);

export const authUid = sql`(select auth.uid())`;
export const realtimeTopic = sql`realtime.topic()`;
```

è¿™ä½¿æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨å®ƒï¼Œè€Œ Drizzle Kit å°†å…¶è§†ä¸ºç°æœ‰æ•°æ®åº“ï¼Œ
ä»…å°†å…¶ä½œä¸ºè¿æ¥åˆ°å…¶ä»–å®ä½“çš„ä¿¡æ¯ä½¿ç”¨ã€‚

```ts
import { foreignKey, pgPolicy, pgTable, text, uuid } from "drizzle-orm/pg-core";
import { sql } from "drizzle-orm/sql";
import { authenticatedRole, authUsers } from "drizzle-orm/supabase";

export const profiles = pgTable(
  "profiles",
  {
    id: uuid().primaryKey().notNull(),
    email: text().notNull(),
  },
  (table) => [
    foreignKey({
      columns: [table.id],
	  // ä» Supabase çš„ auth è¡¨çš„å¼•ç”¨
      foreignColumns: [authUsers.id],
      name: "profiles_id_fk",
    }).onDelete("cascade"),
    pgPolicy("authenticated can view all profiles", {
      for: "select",
	  // ä½¿ç”¨æ¥è‡ª Supabase çš„é¢„å®šä¹‰è§’è‰²
      to: authenticatedRole,
      using: sql`true`,
    }),
  ]
);
```

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸ªå‘å­˜åœ¨äº `Supabase` çš„è¡¨æ·»åŠ ç­–ç•¥çš„ç¤ºä¾‹ã€‚

```ts
import { sql } from "drizzle-orm";
import { pgPolicy } from "drizzle-orm/pg-core";
import { authenticatedRole, realtimeMessages } from "drizzle-orm/supabase";

export const policy = pgPolicy("authenticated role insert policy", {
  for: "insert",
  to: authenticatedRole,
  using: sql``,
}).link(realtimeMessages);
```

æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•å°† Drizzle RLS ä¸ Supabase ä¸€èµ·ä½¿ç”¨ä»¥åŠå¦‚ä½•è¿›è¡Œå®é™…æŸ¥è¯¢ã€‚ 
å®ƒè¿˜åŒ…å«ä¸€ä¸ªå¾ˆå¥½çš„åŒ…è£…å™¨ `createDrizzle`ï¼Œå¯ä»¥å¤„ç†ä¸ Supabase çš„æ‰€æœ‰äº‹åŠ¡å·¥ä½œã€‚ 
åœ¨å³å°†å‘å¸ƒçš„ç‰ˆæœ¬ä¸­ï¼Œå®ƒå°†è¢«è½¬ç§»åˆ° drizzle-orm/supabaseï¼Œå…è®¸æ‚¨æœ¬åœ°ä½¿ç”¨å®ƒã€‚

è¯·æ£€æŸ¥ [Drizzle SupaSecureSlack repo](https://github.com/rphlmr/drizzle-supabase-rls)

è¿™æ˜¯æ¥è‡ªè¯¥åº“çš„ä¸€ä¸ªå®ç°ç¤ºä¾‹ï¼š
```ts
type SupabaseToken = {
  iss?: string;
  sub?: string;
  aud?: string[] | string;
  exp?: number;
  nbf?: number;
  iat?: number;
  jti?: string;
  role?: string;
};

export function createDrizzle(token: SupabaseToken, { admin, client }: { admin: PgDatabase<any>; client: PgDatabase<any> }) {
  return {
    admin,
    rls: (async (transaction, ...rest) => {
      return await client.transaction(async (tx) => {
        // Supabase æš´éœ²äº† auth.uid() å’Œ auth.jwt()
        // https://supabase.com/docs/guides/database/postgres/row-level-security#helper-functions
        try {
          await tx.execute(sql`
          -- auth.jwt()
          select set_config('request.jwt.claims', '${sql.raw(
            JSON.stringify(token)
          )}', TRUE);
          -- auth.uid()
          select set_config('request.jwt.claim.sub', '${sql.raw(
            token.sub ?? ""
          )}', TRUE);												
          -- è®¾ç½®æœ¬åœ°è§’è‰²
          set local role ${sql.raw(token.role ?? "anon")};
          `);
          return await transaction(tx);
        } finally {
          await tx.execute(sql`
            -- é‡ç½®
            select set_config('request.jwt.claims', NULL, TRUE);
            select set_config('request.jwt.claim.sub', NULL, TRUE);
            reset role;
            `);
        }
      }, ...rest);
    }) as typeof client.transaction,
  };
}
```

å¹¶ä¸”å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```ts
// https://github.com/orgs/supabase/discussions/23224
// åº”è¯¥æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ç­¾åçš„è®¿é—®ä»¤ç‰Œï¼Œè€Œä¸æ˜¯ç›´æ¥ä»å­˜å‚¨ä¸­è¯»å–çš„æ•°æ®
export async function createDrizzleSupabaseClient() {
  const {
    data: { session },
  } = await createClient().auth.getSession();
  return createDrizzle(decode(session?.access_token ?? ""), { admin, client });
}

async function getRooms() {
  const db = await createDrizzleSupabaseClient();
  return db.rls((tx) => tx.select().from(rooms));
}
```

Source: https://drizzle.zhcndoc.com/docs/rqb-v2

import Tab from '@mdx/Tab.astro';
import Npm from '@mdx/Npm.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from '@mdx/Section.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';

# Drizzle æŸ¥è¯¢

<Callout type='error'>
æ­¤é¡µé¢è®²è§£çš„æ˜¯ drizzle ç‰ˆæœ¬ `1.0.0-beta.1` åŠæ›´é«˜ç‰ˆæœ¬ä¸­å¯ç”¨çš„æ¦‚å¿µã€‚
</Callout>

<Npm>
drizzle-orm@beta
drizzle-kit@beta -D
</Npm>

<br/>

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': true, 'SingleStore': true }} />

Drizzle ORM è®¾è®¡ä¸ºåœ¨ SQL ä¹‹ä¸Šæä¾›ä¸€ä¸ªè–„çš„ç±»å‹å±‚ã€‚
æˆ‘ä»¬åšä¿¡è‡ªå·±è®¾è®¡äº†ä» TypeScript æ“ä½œ SQL æ•°æ®åº“çš„æœ€ä½³æ–¹å¼ï¼Œç°åœ¨æ˜¯è®©å®ƒå˜å¾—æ›´å¥½çš„æ—¶å€™äº†ã€‚  

å…³ç³»æŸ¥è¯¢æ—¨åœ¨ä¸ºä½ ä» SQL æ•°æ®åº“æŸ¥è¯¢åµŒå¥—çš„å…³ç³»æ•°æ®æä¾›å‡ºè‰²çš„å¼€å‘è€…ä½“éªŒï¼Œé¿å…å¤šæ¬¡è¿æ¥å’Œå¤æ‚çš„æ•°æ®æ˜ å°„ã€‚  

å®ƒæ˜¯ç°æœ‰æ¨¡å¼å®šä¹‰å’ŒæŸ¥è¯¢æ„å»ºå™¨çš„ä¸€ä¸ªæ‰©å±•ã€‚
ä½ å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä½¿ç”¨å®ƒã€‚
æˆ‘ä»¬ç¡®ä¿ä½ åŒæ—¶æ‹¥æœ‰æœ€ä½³çš„å¼€å‘è€…ä½“éªŒå’Œæ€§èƒ½ã€‚  

<CodeTabs items={["index.ts", "schema.ts"]}>
	<CodeTab>
	```typescript copy /schema/3
	import { relations } from './schema';
	import { drizzle } from 'drizzle-orm/...';

	const db = drizzle({ relations });

	const result = await db.query.users.findMany({
		with: {
			posts: true			
		},
	});
	```

	```ts
	[{
		id: 10,
		name: "Dan",
		posts: [
			{
				id: 1,
				content: "SQL å¾ˆæ£’",
				authorId: 10,
			},
			{
				id: 2,
				content: "ä½†çœ‹çœ‹å…³ç³»æŸ¥è¯¢",
				authorId: 10,
			}
		]
	}]
	```
	</CodeTab>

	```typescript {15-25} copy
    import { defineRelations } from "drizzle-orm";
    import * as p from "drizzle-orm/pg-core";
    
    export const posts = p.pgTable("posts", {
      id: p.integer().primaryKey(),
      content: p.text().notNull(),
      authorId: p.integer("author_id").notNull(),
    });
    
    export const users = p.pgTable("users", {
      id: p.integer().primaryKey(),
      name: p.text().notNull(),
    });
    
    export const relations = defineRelations({ users, posts }, (r) => ({
      posts: {
        author: r.one.users({
          from: r.posts.authorId,
          to: r.users.id,
        }),
      },
      users: {
        posts: r.many.users(),
      },
    }));
	```
</CodeTabs>

å…³ç³»æŸ¥è¯¢æ˜¯ Drizzle åŸå§‹ **[æŸ¥è¯¢ç”Ÿæˆå™¨](/docs/select)** çš„ä¸€ä¸ªæ‰©å±•ã€‚
ä½ éœ€è¦åœ¨åˆå§‹åŒ– `drizzle()` æ—¶æä¾›å…¨éƒ¨çš„ `tables` å’Œ `relations`ï¼Œç„¶åä½¿ç”¨ `db.query` API å³å¯ã€‚
<Callout type="info" emoji="â„¹ï¸">
	`drizzle` çš„å¯¼å…¥è·¯å¾„å–å†³äºä½ ä½¿ç”¨çš„ **[æ•°æ®åº“é©±åŠ¨](/docs/connect-overview)**ã€‚
</Callout>
<CodeTabs items={["index.ts", "schema.ts", "relations.ts"]}>
<CodeTab>
```ts
import { relations } from './relations';
import { drizzle } from 'drizzle-orm/...';

const db = drizzle({ relations });

await db.query.users.findMany(...);
```
</CodeTab>
```typescript copy
import { type AnyPgColumn, boolean, integer, pgTable, primaryKey, text, timestamp } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
	id: integer().primaryKey(),
	name: text().notNull(),
	invitedBy: integer('invited_by').references((): AnyPgColumn => users.id),
});

export const groups = pgTable('groups', {
	id: integer().primaryKey(),
	name: text().notNull(),
	description: text(),
});

export const usersToGroups = pgTable('users_to_groups', {
	id: integer().primaryKey(),
	userId: integer('user_id').notNull().references(() => users.id),
	groupId: integer('group_id').notNull().references(() => groups.id),
}, (t) => [
	primaryKey(t.userId, t.groupId)
]);

export const posts = pgTable('posts', {
	id: integer().primaryKey(),
	content: text().notNull(),
	authorId: integer('author_id').references(() => users.id),
	createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});

export const comments = pgTable('comments', {
	id: integer().primaryKey(),
	content: text().notNull(),
	creator: integer().references(() => users.id),
	postId: integer('post_id').references(() => posts.id),
	createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});

export const commentLikes = pgTable('comment_likes', {
	id: integer().primaryKey(),
	creator: integer().references(() => users.id),
	commentId: integer('comment_id').references(() => comments.id),
	createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});
```
```typescript copy
import { defineRelations } from 'drizzle-orm';
import * as schema from './schema';

export const relations = defineRelations(schema, (r) => ({
    users: {
      invitee: r.one.users({
        from: r.users.invitedBy,
        to: r.users.id,
      }),
      groups: r.many.groups({
        from: r.users.id.through(r.usersToGroups.userId),
        to: r.groups.id.through(r.usersToGroups.groupId),
      }),
      posts: r.many.posts(),
    },
    groups: {
      users: r.many.users(),
    },
    posts: {
      author: r.one.users({
        from: r.posts.authorId,
        to: r.users.id,
      }),
      comments: r.many.comments(),
    },
    comments: {
      post: r.one.posts({
        from: r.comments.postId,
        to: r.posts.id,
      }),
      author: r.one.users({
        from: r.comments.creator,
        to: r.users.id,
      }),
      likes: r.many.commentLikes(),
    },
    commentLikes: {
      comment: r.one.comments({
        from: r.commentLikes.commentId,
        to: r.comments.id,
      }),
      author: r.one.users({
        from: r.commentLikes.creator,
        to: r.users.id,
      }),
    },
  })
);
```
</CodeTabs>

Drizzle æä¾› `.findMany()` å’Œ `.findFirst()` APIã€‚
### æŸ¥è¯¢å¤šæ¡
<Section>
```typescript copy
const users = await db.query.users.findMany();
```
```ts
// ç»“æœç±»å‹
const result: {
	id: number;
	name: string;
	verified: boolean;
	invitedBy: number | null;
}[];
```
</Section>

### æŸ¥è¯¢é¦–æ¡
<Callout>
  `.findFirst()` ä¼šåœ¨æŸ¥è¯¢ä¸­æ·»åŠ  `limit 1` é™åˆ¶ã€‚
</Callout>
<Section>
```typescript copy
const user = await db.query.users.findFirst();
```
```ts
// ç»“æœç±»å‹
const result: {
	id: number;
	name: string;
	verified: boolean;
	invitedBy: number | null;
};
```
</Section>

### åŒ…å«å…³è”å…³ç³»

`with` æ“ä½œç¬¦å…è®¸ä½ ç»„åˆå¤šä¸ªå…³è”è¡¨çš„æ•°æ®ï¼Œå¹¶æ­£ç¡®èšåˆç»“æœã€‚

**è·å–æ‰€æœ‰å¸¦è¯„è®ºçš„å¸–å­ï¼š**
```typescript copy
const posts = await db.query.posts.findMany({
	with: {
		comments: true,
	},
});
```

**è·å–é¦–æ¡å¸¦è¯„è®ºçš„å¸–å­ï¼š**
```typescript copy
const post = await db.query.posts.findFirst({
	with: {
		comments: true,
	},
});
```

ä½ å¯ä»¥æ ¹æ®éœ€è¦é“¾å¼åµŒå¥— `with` è¯­å¥ã€‚  
å¯¹ä»»ä½•åµŒå¥—çš„ `with` æŸ¥è¯¢ï¼ŒDrizzle ä¼šä½¿ç”¨ [æ ¸å¿ƒç±»å‹API](/docs/goodies#type-api) æ¨æ–­ç±»å‹ã€‚

**è·å–æ‰€æœ‰ç”¨æˆ·åŠå…¶å¸–å­ï¼Œæ¯ä¸ªå¸–å­åŒ…å«è¯„è®ºåˆ—è¡¨ï¼š**
```typescript copy
const users = await db.query.users.findMany({
	with: {
		posts: {
			with: {
				comments: true,
			},
		},
	},
});
```

### éƒ¨åˆ†å­—æ®µé€‰æ‹©
`columns` å‚æ•°å…è®¸ä½ åŒ…å«æˆ–æ’é™¤ä½ æƒ³ä»æ•°æ®åº“è·å–çš„åˆ—ã€‚

<Callout type="info" emoji="â„¹ï¸">
  Drizzle åœ¨æŸ¥è¯¢å±‚é¢æ‰§è¡Œéƒ¨åˆ†é€‰æ‹©ï¼Œä¸ä¼šé¢å¤–ä¼ è¾“å¤šä½™æ•°æ®ã€‚

  æ³¨æ„ **Drizzle è¾“å‡ºçš„æ˜¯å•æ¡ SQL è¯­å¥ã€‚**
</Callout>

**è·å–æ‰€æœ‰å¸–å­ï¼Œåªå– `id` å’Œ `content` ï¼Œå¹¶åŒ…å« `comments`ï¼š**
```typescript copy
const posts = await db.query.posts.findMany({
	columns: {
		id: true,
		content: true,
	},
	with: {
		comments: true,
	}
});
```

**è·å–æ‰€æœ‰å¸–å­ï¼Œä¸åŒ…å« `content`ï¼š**
```typescript copy
const posts = await db.query.posts.findMany({
	columns: {
		content: false,
	},
});
```

<Callout type="info" emoji="â„¹ï¸">
å½“åŒæ—¶æœ‰ `true` å’Œ `false` çš„é€‰æ‹©æ—¶ï¼Œæ‰€æœ‰çš„ `false` é€‰é¡¹éƒ½ä¼šè¢«å¿½ç•¥ã€‚
</Callout>

å¦‚æœä½ åŒ…å«äº† `name` å­—æ®µï¼Œä½†æ’é™¤äº† `id` å­—æ®µï¼Œ`id` çš„æ’é™¤å°±æ˜¯å¤šä½™çš„ï¼Œ
é™¤äº† `name` å¤–çš„å…¶ä»–å­—æ®µéƒ½ä¼šè¢«æ’é™¤ã€‚  

**åœ¨åŒä¸€ä¸ªæŸ¥è¯¢ä¸­åŒæ—¶æ’é™¤å’ŒåŒ…å«å­—æ®µï¼š**
<Section>
```typescript copy
const users = await db.query.users.findMany({
	columns: {
		name: true,
		id: false // è¢«å¿½ç•¥
	},
});
```
```ts
// ç»“æœç±»å‹
const users: {
	name: string;
};
```
</Section>

**ä»…åŒ…å«åµŒå¥—å…³è”ä¸­çš„åˆ—ï¼š**
<Section>
```typescript copy
const res = await db.query.users.findMany({
	columns: {},
	with: {
		posts: true
	}
});
```
```ts
// ç»“æœç±»å‹
const res: {
	posts: {
		id: number,
		text: string
	}
}[];
```
</Section>

### åµŒå¥—éƒ¨åˆ†å­—æ®µé€‰æ‹©
å°±åƒ **[éƒ¨åˆ†é€‰æ‹©](#partial-select)**ï¼Œä½ ä¹Ÿå¯ä»¥åŒ…å«æˆ–æ’é™¤åµŒå¥—å…³è”çš„åˆ—ï¼š
```typescript copy
const posts = await db.query.posts.findMany({
	columns: {
		id: true,
		content: true,
	},
	with: {
		comments: {
			columns: {
				authorId: false
			}
		}
	}
});
```

### é€‰æ‹©è¿‡æ»¤
å’Œæˆ‘ä»¬çš„ç±» SQL æŸ¥è¯¢æ„å»ºå™¨ä¸€æ ·ï¼Œ
å…³ç³»æŸ¥è¯¢ API å…è®¸ä½ ä½¿ç”¨æˆ‘ä»¬ **[æ“ä½œç¬¦](/docs/operators)** åˆ—è¡¨å®šä¹‰è¿‡æ»¤å’Œæ¡ä»¶ã€‚

ä½ å¯ä»¥ä» `drizzle-orm` ä¸­å¯¼å…¥å®ƒä»¬ï¼Œæˆ–è€…ä½¿ç”¨å›è°ƒè¯­æ³•ï¼š
<Section>
```typescript copy
const users = await db.query.users.findMany({
	where: {
		id: 1
	}
});
```
```sql
select * from users where id = 1
```
</Section>

æŸ¥æ‰¾ id=1 çš„å¸–å­ï¼Œå¹¶è·å–åˆ›å»ºæ—¥æœŸæ—©äºç‰¹å®šæ—¶é—´çš„è¯„è®ºï¼š
```typescript copy
await db.query.posts.findMany({
  where: {
    id: 1,
  },
  with: {
    comments: {
      where: {
        createdAt: { lt: new Date() },
      },
    },
  },
});
```

**æ‰€æœ‰è¿‡æ»¤æ“ä½œç¬¦åˆ—è¡¨**
```ts
where: {
    OR: [],
    AND: [],
    NOT: {},
    RAW: (table) => sql`${table.id} = 1`,

    // é€šè¿‡å…³è”è¿‡æ»¤
    [relation]: {},

    // é€šè¿‡å­—æ®µè¿‡æ»¤
    [column]: {
      OR: [],
      AND: [],
      NOT: {},
      eq: 1,
      ne: 1,
      gt: 1,
      gte: 1,
      lt: 1,
      lte: 1,
      in: [1],
      notIn: [1],
      like: "",
      ilike: "",
      notLike: "",
      notIlike: "",
      isNull: true,
      isNotNull: true,
      arrayOverlaps: [1, 2],
      arrayContained: [1, 2],
      arrayContains: [1, 2]
    },
},
```

**ç¤ºä¾‹**
<CodeTabs items={["ç®€å•ç­‰äº", "ä½¿ç”¨ AND", "ä½¿ç”¨ OR", "ä½¿ç”¨ NOT", "ä½¿ç”¨ RAW çš„å¤æ‚ç¤ºä¾‹"]}>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    age: 15,
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name"
from "users" 
where ("users"."age" = 15)
```
</CodeTab>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    age: 15,
    name: 'John'
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name"
from "users" 
where ("users"."age" = 15 and "users"."name" = 'John')
```
</CodeTab>
<CodeTab>
```ts
const response = await db.query.users.findMany({
  where: {
    OR: [
      {
        id: {
          gt: 10,
        },
      },
	  {
		name: {
          like: "John%",
        },
	  }
    ],
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name" 
from "users" 
where ("users"."id" > 10 or "users"."name" like 'John%')
```
</CodeTab>
<CodeTab>
```ts
const response = db.query.users.findMany({
  where: {
    NOT: {
      id: {
        gt: 10,
      },
    },
    name: {
      like: "John%",
    },
  },
});
```
```sql {3}
select "users"."id" as "id", "users"."name" as "name" 
from "users" 
where (not "users"."id" > 10 and "users"."name" like 'John%')
```
</CodeTab>
<CodeTab>
```ts
// schema.ts
import { integer, jsonb, pgTable, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: integer("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull(),
  age: integer("age"),
  createdAt: timestamp("created_at").defaultNow(),
  lastLogin: timestamp("last_login"),
  subscriptionEnd: timestamp("subscription_end"),
  lastActivity: timestamp("last_activity"),
  preferences: jsonb("preferences"),      // ç”¨æˆ·è®¾ç½®/åå¥½çš„ JSON åˆ—
  interests: text("interests").array(),  // ç”¨æˆ·å…´è¶£çš„æ•°ç»„åˆ—
});
```
```ts
const response = db.query.users.findMany({
  where: {
    AND: [
      {
        OR: [
          { RAW: (table) => sql`LOWER(${table.name}) LIKE 'john%'` },
          { name: { ilike: "jane%" } },
        ],
      },
      {
        OR: [
          { RAW: (table) => sql`${table.preferences}->>'theme' = 'dark'` },
          { RAW: (table) => sql`${table.preferences}->>'theme' IS NULL` },
        ],
      },
      { RAW: (table) => sql`${table.age} BETWEEN 25 AND 35` },
    ],
  },
});
```
```sql
select "d0"."id" as "id", "d0"."name" as "name", 
"d0"."email" as "email", "d0"."age" as "age", 
"d0"."created_at" as "createdAt", "d0"."last_login" as "lastLogin", 
"d0"."subscription_end" as "subscriptionEnd", "d0"."last_activity" as "lastActivity", 
"d0"."preferences" as "preferences", "d0"."interests" as "interests" 
from "users" as "d0" 
where ((LOWER("d0"."name") LIKE 'john%' or "d0"."name" ilike 'jane%') 
and ("d0"."preferences"->>'theme' = 'dark' or "d0"."preferences"->>'theme' IS NULL) 
and "d0"."age" BETWEEN 25 AND 35)
```
</CodeTab>
</CodeTabs>

### å…³ç³»è¿‡æ»¤å™¨

ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢ï¼Œä½ ä¸ä»…å¯ä»¥æŒ‰æŸ¥è¯¢çš„è¡¨è¿‡æ»¤ï¼Œè¿˜å¯ä»¥æŒ‰æŸ¥è¯¢ä¸­åŒ…å«çš„ä»»ä½•è¡¨è¿‡æ»¤ã€‚

**ç¤ºä¾‹ï¼š** è·å– ID å¤§äº 10 å¹¶ä¸”è‡³å°‘æœ‰ä¸€æ¡å†…å®¹ä»¥ "M" å¼€å¤´çš„å¸–å­çš„ `users`ï¼š
```ts
const usersWithPosts = await db.query.usersTable.findMany({
  where: {
    id: {
      gt: 10
    },
    posts: {
      content: {
        like: 'M%'
      }
    }
  },
});
```

**ç¤ºä¾‹ï¼š** åªè·å–è‡³å°‘æœ‰ä¸€æ¡å¸–å­çš„ç”¨æˆ·åŠå¸–å­ï¼š
```ts
const response = db.query.users.findMany({
  with: {
    posts: true,
  },
  where: {
    posts: true,
  },
});
```

### é™åˆ¶ä¸åç§»
Drizzle ORM ä¸ºæŸ¥è¯¢åŠåµŒå¥—å®ä½“æä¾›äº† `limit` å’Œ `offset` APIã€‚

**æŸ¥è¯¢ 5 ä¸ªå¸–å­ï¼š**
```typescript copy
await db.query.posts.findMany({
	limit: 5,
});
```

**æŸ¥è¯¢å¸–å­ï¼Œæ¯ä¸ªå¸–å­æœ€å¤šå– 3 æ¡è¯„è®ºï¼š**
```typescript copy
await db.query.posts.findMany({
	with: {
		comments: {
			limit: 3,
		},
	},
});
```

<Callout type="warning" emoji="âš ï¸">
  `offset` ç°åœ¨ä¹Ÿå¯ä»¥ç”¨äºå…³è”è¡¨ä¸­ï¼
</Callout>
```typescript 
await db.query.posts.findMany({
	limit: 5,
	offset: 2, // æ­£ç¡® âœ…
	with: {
		comments: {
			offset: 3, // æ­£ç¡® âœ…
			limit: 3,
		},
	},
});
```

æŸ¥è¯¢å¸¦è¯„è®ºçš„å¸–å­ï¼Œä»ç¬¬ 5 æ¡åˆ°ç¬¬ 10 æ¡ï¼š
```typescript copy
await db.query.posts.findMany({
	with: {
		comments: true,
	},
  limit: 5,
  offset: 5,
});
```

### æ’åº
Drizzle æä¾›å…³ç³»æŸ¥è¯¢æ„å»ºå™¨çš„æ’åº APIã€‚

ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ **[æ ¸å¿ƒ API](/docs/select#order-by)** æ’åºï¼Œä¹Ÿå¯ä»¥ç”¨å›è°ƒçš„ `order by` æ“ä½œç¬¦ï¼Œæ— éœ€å¯¼å…¥ã€‚

<Callout title='é‡è¦æç¤º'>
å½“ä½ åœ¨åŒä¸€å¼ è¡¨ä¸­ä½¿ç”¨å¤šä¸ª `orderBy` è¯­å¥æ—¶ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§ä½ æ·»åŠ çš„é¡ºåºä¾æ¬¡å‡ºç°åœ¨æŸ¥è¯¢ä¸­ã€‚
</Callout>

<Section>
```typescript copy
await db.query.posts.findMany({
  orderBy: {
    id: "asc",
  },
});
```
</Section>

**åŒæ—¶ä½¿ç”¨å‡åºå’Œé™åºæ’åºï¼š**
```typescript copy
  await db.query.posts.findMany({
    orderBy: { id: "asc" },
    with: {
      comments: {
        orderBy: { id: "desc" },
      },
    },
  });
```

ä½ è¿˜å¯ä»¥åœ¨æ’åºè¯­å¥ä¸­ä½¿ç”¨è‡ªå®šä¹‰ `sql`ï¼š

```typescript copy
await db.query.posts.findMany({
  orderBy: (t) => sql`${t.id} asc`,
  with: {
    comments: {
      orderBy: (t, { desc }) => desc(t.id),
    },
  },
});
```

### åŒ…å«è‡ªå®šä¹‰å­—æ®µ
å…³ç³»æŸ¥è¯¢ API å…è®¸ä½ æ·»åŠ è‡ªå®šä¹‰é™„åŠ å­—æ®µã€‚
å½“ä½ éœ€è¦æ£€ç´¢æ•°æ®å¹¶å¯¹å…¶åº”ç”¨é¢å¤–å‡½æ•°æ—¶éå¸¸æœ‰ç”¨ã€‚
<Callout type="warning" emoji="âš ï¸">
	ç›®å‰ `extras` ä¸­ä¸æ”¯æŒèšåˆï¼Œè¯·ä½¿ç”¨ **[æ ¸å¿ƒæŸ¥è¯¢](/docs/select)** å®ç°èšåˆã€‚
</Callout>

<Section>
```typescript copy {5}
import { sql } from 'drizzle-orm';

await db.query.users.findMany({
	extras: {
		loweredName: sql`lower(${users.name})`,
	},
})
```
```typescript copy {3}
await db.query.users.findMany({
	extras: {
		loweredName: (users, { sql }) => sql`lower(${users.name})`,
	},
})
```
</Section>

`lowerName` ä½œä¸ºé”®ä¼šè¢«åŒ…å«åœ¨æ‰€æœ‰è¿”å›å¯¹è±¡çš„å­—æ®µä¸­ã€‚

<Callout type="warning" emoji="âš ï¸">
  å¦‚æœä½ å¯¹ `extras` ä¸­çš„å­—æ®µæŒ‡å®šäº† `.as("<åˆ«å>")` ï¼ŒDrizzle ä¼šå¿½ç•¥è¯¥æ“ä½œã€‚
</Callout>

ç”¨å…³ç³»æŸ¥è¯¢æ„å»ºå™¨è·å–æ‰€æœ‰ç”¨æˆ·åŠå…¶ç¾¤ç»„ï¼Œå¹¶åŒ…å« `fullName` å­—æ®µï¼ˆç”± firstName å’Œ lastName æ‹¼æ¥ï¼‰ï¼š

<Section>
```typescript copy
const res = await db.query.users.findMany({
	extras: {
		fullName: (users, { sql }) => sql<string>`concat(${users.name}, " ", ${users.name})`,
	},
	with: {
		usersToGroups: {
			with: {
				group: true,
			},
		},
	},
});
```
```ts
// ç»“æœç±»å‹
const res: {
	id: number;
	name: string;
	verified: boolean;
	invitedBy: number | null;
	fullName: string;
	usersToGroups: {
			group: {
					id: number;
					name: string;
					description: string | null;
			};
	}[];
}[];

```
</Section>


è·å–æ‰€æœ‰å¸¦è¯„è®ºçš„å¸–å­ï¼Œå¹¶æ·»åŠ é¢å¤–å­—æ®µæ¥è®¡ç®—å¸–å­å†…å®¹é•¿åº¦å’Œæ¯æ¡è¯„è®ºå†…å®¹é•¿åº¦ï¼š

<Section>
```typescript copy
const res = await db.query.posts.findMany({
	extras: {
		contentLength: (table, { sql }) => sql<number>`length(${table.content})`,
	},
	with: {
		comments: {
			extras: {
				commentSize: (table, { sql }) => sql<number>`length(${table.content})`,
			},
		},
	},
});
```
```ts
// ç»“æœç±»å‹
const res: {
	id: number;
	createdAt: Date;
	content: string;
	authorId: number | null;
	contentLength: number;
	comments: {
			id: number;
			createdAt: Date;
			content: string;
			creator: number | null;
			postId: number | null;
			commentSize: number;
	}[];
};
```
</Section>

### åŒ…å«å­æŸ¥è¯¢

ä½ ä¹Ÿå¯ä»¥åœ¨å…³ç³»æŸ¥è¯¢ä¸­ä½¿ç”¨å­æŸ¥è¯¢ï¼Œä»¥åˆ©ç”¨è‡ªå®šä¹‰ SQL è¯­æ³•çš„å¼ºå¤§åŠŸèƒ½ã€‚

**è·å–ç”¨æˆ·åŠå…¶å¸–å­ï¼ŒåŒæ—¶è·å–æ¯ä½ç”¨æˆ·å¸–å­æ€»æ•°**
```ts
import { posts } from './schema';
import { eq } from 'drizzle-orm';

await db.query.users.findMany({
  with: {
    posts: true
  },
  extras: {
    totalPostsCount: (table) => db.$count(posts, eq(posts.authorId, table.id)),
  }
});
```
```sql
select "d0"."id" as "id", "d0"."name" as "name", "posts"."r" as "posts", 
((select count(*) from "posts" where "posts"."author_id" = "d0"."id")) as "totalPostsCount" 
from "users" as "d0" 
left join lateral(
  select coalesce(json_agg(row_to_json("t".*)), '[]') as "r" 
  from (select "d1"."id" as "id", "d1"."content" as "content", "d1"."author_id" as "authorId" from "posts" as "d1" where "d0"."id" = "d1"."author_id") as "t"
) as "posts" on true
```

### é¢„å¤„ç†è¯­å¥
é¢„å¤„ç†è¯­å¥æ—¨åœ¨å¤§å¹…æå‡æŸ¥è¯¢æ€§èƒ½ â€” [è¯¦æƒ…è§æ­¤å¤„](/docs/perf-queries)

æœ¬èŠ‚ä»‹ç»å¦‚ä½•ä½¿ç”¨ Drizzle å…³ç³»æŸ¥è¯¢æ„å»ºå™¨å®šä¹‰å ä½ç¬¦å¹¶æ‰§è¡Œé¢„å¤„ç†è¯­å¥ã€‚

##### **`where` ä¸­çš„å ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    where: { id: { eq: sql.placeholder("id") } },
    with: {
      posts: {
        where: { id: 1 },
      },
    },
}).prepare("query_name");

const usersWithPosts = await prepared.execute({ id: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    where: { id: { eq: sql.placeholder("id") } },
    with: {
      posts: {
        where: { id: 1 },
      },
    },
}).prepare();

const usersWithPosts = await prepared.execute({ id: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    where: { id: { eq: sql.placeholder("id") } },
    with: {
      posts: {
        where: { id: 1 },
      },
    },
}).prepare();

const usersWithPosts = await prepared.execute({ id: 1 });
```
</Section>
</Tab>
</Tabs>


##### **`limit` ä¸­çš„å ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    with: {
      posts: {
        limit: sql.placeholder("limit"),
      },
    },
  }).prepare("query_name");

const usersWithPosts = await prepared.execute({ limit: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    with: {
      posts: {
        limit: sql.placeholder("limit"),
      },
    },
  }).prepare();

const usersWithPosts = await prepared.execute({ limit: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    with: {
      posts: {
        limit: sql.placeholder("limit"),
      },
    },
  }).prepare();

const usersWithPosts = await prepared.execute({ limit: 1 });
```
</Section>
</Tab>
</Tabs>


##### **`offset` ä¸­çš„å ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
	offset: sql.placeholder('offset'),
	with: {
		posts: true,
	},
}).prepare('query_name');

const usersWithPosts = await prepared.execute({ offset: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
	offset: sql.placeholder('offset'),
	with: {
		posts: true,
	},
}).prepare();

const usersWithPosts = await prepared.execute({ offset: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
	offset: sql.placeholder('offset'),
	with: {
		posts: true,
	},
}).prepare();

const usersWithPosts = await prepared.execute({ offset: 1 });
```
</Section>
</Tab>
</Tabs>

##### **å¤šä¸ªå ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    limit: sql.placeholder("uLimit"),
    offset: sql.placeholder("uOffset"),
    where: {
      OR: [{ id: { eq: sql.placeholder("id") } }, { id: 3 }],
    },
    with: {
      posts: {
        where: { id: { eq: sql.placeholder("pid") } },
        limit: sql.placeholder("pLimit"),
      },
    },
}).prepare("query_name");

const usersWithPosts = await prepared.execute({ pLimit: 1, uLimit: 3, uOffset: 1, id: 2, pid: 6 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    limit: sql.placeholder("uLimit"),
    offset: sql.placeholder("uOffset"),
    where: {
      OR: [{ id: { eq: sql.placeholder("id") } }, { id: 3 }],
    },
    with: {
      posts: {
        where: { id: { eq: sql.placeholder("pid") } },
        limit: sql.placeholder("pLimit"),
      },
    },
}).prepare();

const usersWithPosts = await prepared.execute({ pLimit: 1, uLimit: 3, uOffset: 1, id: 2, pid: 6 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db.query.users.findMany({
    limit: sql.placeholder("uLimit"),
    offset: sql.placeholder("uOffset"),
    where: {
      OR: [{ id: { eq: sql.placeholder("id") } }, { id: 3 }],
    },
    with: {
      posts: {
        where: { id: { eq: sql.placeholder("pid") } },
        limit: sql.placeholder("pLimit"),
      },
    },
}).prepare();

const usersWithPosts = await prepared.execute({ pLimit: 1, uLimit: 3, uOffset: 1, id: 2, pid: 6 });
```
</Section>
</Tab>
</Tabs>

Source: https://drizzle.zhcndoc.com/docs/rqb

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from '@mdx/Section.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';

# Drizzle æŸ¥è¯¢

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': true, 'SingleStore': true }} />

Drizzle ORM æ—¨åœ¨æˆä¸º SQL ä¹‹ä¸Šçš„ä¸€ä¸ªè–„å‹ç±»å‹å±‚ã€‚  
æˆ‘ä»¬çœŸå¿ƒç›¸ä¿¡æˆ‘ä»¬è®¾è®¡äº†ä» TypeScript æ“ä½œ SQL æ•°æ®åº“çš„æœ€ä½³æ–¹æ³•ï¼Œç°åœ¨æ˜¯æ—¶å€™ä½¿å…¶æ›´å‡ºè‰²äº†ã€‚  
  
å…³ç³»æŸ¥è¯¢æ—¨åœ¨ä¸ºæ‚¨æä¾›å‡ºè‰²çš„å¼€å‘è€…ä½“éªŒï¼Œ
ä»¥ä¾¿ä» SQL æ•°æ®åº“ä¸­æŸ¥è¯¢åµŒå¥—çš„å…³ç³»æ•°æ®ï¼Œé¿å…å¤šä¸ªè¿æ¥å’Œå¤æ‚çš„æ•°æ®æ˜ å°„ã€‚  

å®ƒæ˜¯ç°æœ‰æ¨¡å¼å®šä¹‰å’ŒæŸ¥è¯¢æ„å»ºå™¨çš„æ‰©å±•ã€‚  
æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©ä½¿ç”¨å®ƒã€‚  
æˆ‘ä»¬ç¡®ä¿ä¸ºæ‚¨æä¾›æœ€ä¼˜ç§€çš„å¼€å‘è€…ä½“éªŒå’Œæ€§èƒ½ã€‚  

<CodeTabs items={["index.ts", "schema.ts"]}>
	<CodeTab>
	```typescript copy /schema/3
	import * as schema from './schema';
	import { drizzle } from 'drizzle-orm/...';

	const db = drizzle({ schema });

	const result = await db._query.users.findMany({
		with: {
			posts: true			
		},
	});
	```

	```ts
	[{
		id: 10,
		name: "Dan",
		posts: [
			{
				id: 1,
				content: "SQL æ˜¯å¾ˆæ£’çš„",
				authorId: 10,
			},
			{
				id: 2,
				content: "ä½†è¯·æ£€æŸ¥å…³ç³»æŸ¥è¯¢",
				authorId: 10,
			}
		]
	}]
	```
	</CodeTab>

	```typescript copy
	import { integer, serial, text, pgTable } from 'drizzle-orm/pg-core';
	import { relations } from 'drizzle-orm';

	export const users = pgTable('users', {
		id: serial('id').primaryKey(),
		name: text('name').notNull(),
	});

	export const usersRelations = relations(users, ({ many }) => ({
		posts: many(posts),
	}));

	export const posts = pgTable('posts', {
		id: serial('id').primaryKey(),
		content: text('content').notNull(),
		authorId: integer('author_id').notNull(),
	});

	export const postsRelations = relations(posts, ({ one }) => ({
		author: one(users, { fields: [posts.authorId], references: [users.id] }),
	}));
	```
</CodeTabs>

âš ï¸ å¦‚æœæ‚¨åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å£°æ˜ SQL æ¨¡å¼ï¼Œæ‚¨å¯ä»¥è¿™æ ·åšï¼š
<CodeTabs items={["index.ts", "schema1.ts", "schema2.ts"]}>
	```typescript copy /schema/3
	import * as schema1 from './schema1';
	import * as schema2 from './schema2';
	import { drizzle } from 'drizzle-orm/...';

	const db = drizzle({ schema: { ...schema1, ...schema2 } });

	const result = await db._query.users.findMany({
		with: {
			posts: true			
		},
	});
	```
	
	```ts
	// ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸­çš„æ¨¡å¼å£°æ˜
	```
	```ts
	// ç¬¬äºŒä¸ªæ–‡ä»¶ä¸­çš„æ¨¡å¼å£°æ˜
	```
</CodeTabs>


## æ¨¡å¼
Drizzle å…³ç³»æŸ¥è¯¢æ€»æ˜¯ç”Ÿæˆä¸€ä¸ª SQL è¯­å¥åœ¨æ•°æ®åº“ä¸Šè¿è¡Œï¼Œå¹¶ä¸”æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ã€‚  
ä¸ºäº†å¯¹æ¯ç§æ•°æ®åº“æä¾›æœ€ä½³æ”¯æŒï¼Œæˆ‘ä»¬å¼•å…¥äº† **`modes`**ã€‚  

Drizzle å…³ç³»æŸ¥è¯¢åœ¨åº•å±‚ä½¿ç”¨å­æŸ¥è¯¢çš„ä¾§å‘è¿æ¥ï¼Œç›®å‰ PlanetScale ä¸æ”¯æŒå®ƒä»¬ã€‚

å½“ä½¿ç”¨ **mysql2** é©±åŠ¨ç¨‹åºä¸å¸¸è§„ **MySQL** æ•°æ®åº“æ—¶ â€” ä½ åº”è¯¥æŒ‡å®š `mode: "default"`ï¼Œ
å½“ä½¿ç”¨ **mysql2** é©±åŠ¨ç¨‹åºä¸ **PlanetScale** æ—¶ â€” ä½ éœ€è¦æŒ‡å®š `mode: "planetscale"`ã€‚

```ts copy
import * as schema from './schema';
import { drizzle } from "drizzle-orm/mysql2";
import mysql from "mysql2/promise";

const connection = await mysql.createConnection({
  uri: process.env.PLANETSCALE_DATABASE_URL,
});

const db = drizzle({ client: connection, schema, mode: 'planetscale' });
```

## æŸ¥è¯¢
å…³ç³»æŸ¥è¯¢æ˜¯ Drizzle åŸå§‹ **[æŸ¥è¯¢æ„å»ºå™¨](/docs/select)** çš„ä¸€ä¸ªæ‰©å±•ã€‚  
æ‚¨éœ€è¦åœ¨ `drizzle()` åˆå§‹åŒ–æ—¶æä¾›æ¥è‡ªæ‚¨çš„æ¨¡å¼æ–‡ä»¶/æ–‡ä»¶çš„æ‰€æœ‰ `tables` å’Œ `relations` ï¼Œ
ç„¶ååªéœ€ä½¿ç”¨ `db._query` APIã€‚  
<Callout type="info" emoji="â„¹ï¸">  
	`drizzle` çš„å¯¼å…¥è·¯å¾„å–å†³äºæ‚¨ä½¿ç”¨çš„ **[æ•°æ®åº“é©±åŠ¨ç¨‹åº](/docs/connect-overview)**ã€‚  
</Callout>  
<CodeTabs items={["index.ts", "schema.ts"]}>
<CodeTab>
```ts
import * as schema from './schema';
import { drizzle } from 'drizzle-orm/...';

const db = drizzle({ schema });

await db._query.users.findMany(...);
```
```ts
// å¦‚æœæ‚¨åœ¨å¤šä¸ªæ–‡ä»¶ä¸­æœ‰æ¨¡å¼
import * as schema1 from './schema1';
import * as schema2 from './schema2';
import { drizzle } from 'drizzle-orm/...';

const db = drizzle({ schema: { ...schema1, ...schema2 } });

await db._query.users.findMany(...);
```
</CodeTab>
```typescript copy
	import { type AnyPgColumn, boolean, integer, pgTable, primaryKey, serial, text, timestamp } from 'drizzle-orm/pg-core';

	import { relations } from 'drizzle-orm';

	export const users = pgTable('users', {
		id: serial('id').primaryKey(),
		name: text('name').notNull(),
		verified: boolean('verified').notNull(),
		invitedBy: integer('invited_by').references((): AnyPgColumn => users.id),
	});

	export const usersRelations = relations(users, ({ one, many }) => ({
		invitee: one(users, { fields: [users.invitedBy], references: [users.id] }),
		usersToGroups: many(usersToGroups),
		posts: many(posts),
	}));

	export const groups = pgTable('groups', {
		id: serial('id').primaryKey(),
		name: text('name').notNull(),
		description: text('description'),
	});

	export const groupsRelations = relations(groups, ({ many }) => ({
		usersToGroups: many(usersToGroups),
	}));

	export const usersToGroups = pgTable('users_to_groups', {
		id: serial('id').primaryKey(),
		userId: integer('user_id').notNull().references(() => users.id),
		groupId: integer('group_id').notNull().references(() => groups.id),
	}, (t) => [
		primaryKey({ columns: [t.userId, t.groupId] })
	]);

	export const usersToGroupsRelations = relations(usersToGroups, ({ one }) => ({
		group: one(groups, { fields: [usersToGroups.groupId], references: [groups.id] }),
		user: one(users, { fields: [usersToGroups.userId], references: [users.id] }),
	}));

	export const posts = pgTable('posts', {
		id: serial('id').primaryKey(),
		content: text('content').notNull(),
		authorId: integer('author_id').references(() => users.id),
		createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
	});

	export const postsRelations = relations(posts, ({ one, many }) => ({
		author: one(users, { fields: [posts.authorId], references: [users.id] }),
		comments: many(comments),
	}));

	export const comments = pgTable('comments', {
		id: serial('id').primaryKey(),
		content: text('content').notNull(),
		creator: integer('creator').references(() => users.id),
		postId: integer('post_id').references(() => posts.id),
		createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
	});

	export const commentsRelations = relations(comments, ({ one, many }) => ({
		post: one(posts, { fields: [comments.postId], references: [posts.id] }),
		author: one(users, { fields: [comments.creator], references: [users.id] }),
		likes: many(commentLikes),
	}));

	export const commentLikes = pgTable('comment_likes', {
		id: serial('id').primaryKey(),
		creator: integer('creator').references(() => users.id),
		commentId: integer('comment_id').references(() => comments.id),
		createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
	});

	export const commentLikesRelations = relations(commentLikes, ({ one }) => ({
		comment: one(comments, { fields: [commentLikes.commentId], references: [comments.id] }),
		author: one(users, { fields: [commentLikes.creator], references: [users.id] }),
	}));
```
</CodeTabs>

Drizzle æä¾› `.findMany()` å’Œ `.findFirst()` APIã€‚  
### æŸ¥æ‰¾å¤šä¸ª
<Section>
```typescript copy
const users = await db._query.users.findMany();
```
```ts
// ç»“æœç±»å‹
const result: {
	id: number;
	name: string;
	verified: boolean;
	invitedBy: number | null;
}[];
```
</Section>

### æŸ¥æ‰¾ç¬¬ä¸€ä¸ª
<Callout>
  `.findFirst()` ä¼šåœ¨æŸ¥è¯¢ä¸­æ·»åŠ  `limit 1`ã€‚
</Callout>
<Section>
```typescript copy
const user = await db._query.users.findFirst();
```
```ts
// ç»“æœç±»å‹
const result: {
	id: number;
	name: string;
	verified: boolean;
	invitedBy: number | null;
};
```
</Section>

### åŒ…æ‹¬å…³ç³»

`With` æ“ä½œç¬¦å…è®¸æ‚¨ä»å¤šä¸ªç›¸å…³è¡¨ä¸­ç»„åˆæ•°æ®å¹¶æ­£ç¡®èšåˆç»“æœã€‚

**è·å–æ‰€æœ‰å¸¦è¯„è®ºçš„å¸–å­ï¼š**
```typescript copy
const posts = await db._query.posts.findMany({
	with: {
		comments: true,
	},
});
```

**è·å–ç¬¬ä¸€ä¸ªå¸¦è¯„è®ºçš„å¸–å­ï¼š**
```typescript copy
const post = await db._query.posts.findFirst({
	with: {
		comments: true,
	},
});
```

æ‚¨å¯ä»¥æ ¹æ®éœ€è¦é“¾å¼è°ƒç”¨åµŒå¥—çš„ with è¯­å¥ã€‚  
å¯¹äºä»»ä½•åµŒå¥—çš„ `with` æŸ¥è¯¢ï¼ŒDrizzle å°†ä½¿ç”¨ [Core Type API](/docs/goodies#type-api) æ¨æ–­ç±»å‹ã€‚
  
**è·å–æ‰€æœ‰ç”¨æˆ·åŠå…¶å¸–å­ã€‚æ¯ä¸ªå¸–å­åº”åŒ…å«è¯„è®ºåˆ—è¡¨ï¼š**
```typescript copy
const users = await db._query.users.findMany({
	with: {
		posts: {
			with: {
				comments: true,
			},
		},
	},
});
```

### éƒ¨åˆ†å­—æ®µé€‰æ‹©
`columns` å‚æ•°å…è®¸æ‚¨åŒ…å«æˆ–çœç•¥è¦ä»æ•°æ®åº“ä¸­è·å–çš„åˆ—ã€‚

<Callout type="info" emoji="â„¹ï¸">
  Drizzle åœ¨æŸ¥è¯¢çº§åˆ«æ‰§è¡Œéƒ¨åˆ†é€‰æ‹©ï¼Œæ²¡æœ‰é¢å¤–æ•°æ®è¢«ä»æ•°æ®åº“ä¸­ä¼ è¾“ã€‚

  è¯·è®°ä½ **Drizzle è¾“å‡ºçš„æ˜¯å•ä¸ª SQL è¯­å¥**ã€‚
</Callout>

**ä»…è·å–å¸¦æœ‰ `id`ã€`content` çš„æ‰€æœ‰å¸–å­ï¼Œå¹¶åŒ…æ‹¬ `comments`ï¼š**
```typescript copy
const posts = await db._query.posts.findMany({
	columns: {
		id: true,
		content: true,
	},
	with: {
		comments: true,
	}
});
```

**è·å–æ²¡æœ‰ `content` çš„æ‰€æœ‰å¸–å­ï¼š**
```typescript copy
const posts = await db._query.posts.findMany({
	columns: {
		content: false,
	},
});
```

<Callout type="info" emoji="â„¹ï¸">
å½“åŒæ—¶å­˜åœ¨ `true` å’Œ `false` çš„é€‰æ‹©é€‰é¡¹æ—¶ï¼Œæ‰€æœ‰ `false` çš„é€‰é¡¹å°†è¢«å¿½ç•¥ã€‚
</Callout>

å¦‚æœæ‚¨åŒ…å« `name` å­—æ®µå¹¶æ’é™¤ `id` å­—æ®µï¼Œåˆ™ `id` çš„æ’é™¤å°†æ˜¯å¤šä½™çš„ï¼Œ
å› ä¸ºé™¤äº† `name` çš„æ‰€æœ‰å­—æ®µéƒ½å°†è¢«æ’é™¤ã€‚  
  
**åœ¨åŒä¸€æŸ¥è¯¢ä¸­æ’é™¤å’ŒåŒ…å«å­—æ®µï¼š**
<Section>
```typescript copy
const users = await db._query.users.findMany({
	columns: {
		name: true,
		id: false //è¢«å¿½ç•¥
	},
});
```
```ts
// ç»“æœç±»å‹
const users: {
	name: string;
};
```
</Section>

**ä»…åŒ…å«æ¥è‡ªåµŒå¥—å…³ç³»çš„åˆ—ï¼š**
<Section>
```typescript copy
const res = await db._query.users.findMany({
	columns: {},
	with: {
		posts: true
	}
});
```
```ts
// ç»“æœç±»å‹
const res: {
	posts: {
		id: number,
		text: string
	}
}[];
```
</Section>

### åµŒå¥—éƒ¨åˆ†å­—æ®µé€‰æ‹©
å°±åƒ **[`éƒ¨åˆ†é€‰æ‹©`](#partial-select)** ä¸€æ ·ï¼Œæ‚¨å¯ä»¥åŒ…å«æˆ–æ’é™¤åµŒå¥—å…³ç³»çš„åˆ—ï¼š
```typescript copy
const posts = await db._query.posts.findMany({
	columns: {
		id: true,
		content: true,
	},
	with: {
		comments: {
			columns: {
				authorId: false
			}
		}
	}
});
```

### é€‰æ‹©è¿‡æ»¤å™¨
å°±åƒåœ¨æˆ‘ä»¬çš„ SQL é£æ ¼æŸ¥è¯¢æ„å»ºå™¨ä¸­ä¸€æ ·ï¼Œå…³ç³»æŸ¥è¯¢ API å…è®¸æ‚¨å®šä¹‰è¿‡æ»¤å™¨å’Œæ¡ä»¶ï¼Œ
ä½¿ç”¨æˆ‘ä»¬ **[`è¿ç®—ç¬¦`](/docs/operators)** çš„åˆ—è¡¨ã€‚

æ‚¨å¯ä»¥ä» `drizzle-orm` å¯¼å…¥å®ƒä»¬ï¼Œæˆ–ä½¿ç”¨å›è°ƒè¯­æ³•ç›´æ¥ä½¿ç”¨ï¼š
<Section>
```typescript copy
import { eq } from 'drizzle-orm';

const users = await db._query.users.findMany({
	where: eq(users.id, 1)
})
```
```ts copy
const users = await db._query.users.findMany({
	where: (users, { eq }) => eq(users.id, 1),
})
```
</Section>

å¯»æ‰¾ `id=1` å¹¶ä¸”åœ¨ç‰¹å®šæ—¥æœŸä¹‹å‰åˆ›å»ºçš„è¯„è®ºçš„å¸–å­ï¼š
```typescript copy
await db._query.posts.findMany({
	where: (posts, { eq }) => (eq(posts.id, 1)),
	with: {
		comments: {
			where: (comments, { lt }) => lt(comments.createdAt, new Date()),
		},
	},
});
```

### é™åˆ¶ä¸åç§»
Drizzle ORM ä¸ºæŸ¥è¯¢å’ŒåµŒå¥—å®ä½“æä¾› `limit` å’Œ `offset` APIã€‚
  
**å¯»æ‰¾ 5 ä¸ªå¸–å­ï¼š**
```typescript copy
await db._query.posts.findMany({
	limit: 5,
});
```

**æŸ¥æ‰¾å¸–å­å¹¶æœ€å¤šè·å– 3 æ¡è¯„è®ºï¼š**
```typescript copy
await db._query.posts.findMany({
	with: {
		comments: {
			limit: 3,
		},
	},
});
```

<Callout type="warning" emoji="âš ï¸">
  `offset` ä»…é€‚ç”¨äºé¡¶å±‚æŸ¥è¯¢ã€‚
</Callout>
```typescript 
await db._query.posts.findMany({
	limit: 5,
	offset: 2, // æ­£ç¡® âœ…
	with: {
		comments: {
			offset: 3, // ä¸æ­£ç¡® âŒ
			limit: 3,
		},
	},
});
```

æŸ¥æ‰¾å¸–å­å¹¶è·å–ç¬¬ 5 åˆ°ç¬¬ 10 ä¸ªå¸–å­çš„è¯„è®ºï¼š
```typescript copy
await db._query.posts.findMany({
	limit: 5,
    offset: 5,
	with: {
		comments: true,
	},
});
```

### æ’åº
Drizzle ä¸ºå…³ç³»æŸ¥è¯¢æ„å»ºå™¨æä¾›äº†æ’åº APIã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ’åº **[æ ¸å¿ƒ API](/docs/select#order-by)**
æˆ–åœ¨æ²¡æœ‰å¯¼å…¥çš„æƒ…å†µä¸‹ä½¿ç”¨å›è°ƒä¸­çš„ `order by` è¿ç®—ç¬¦ã€‚  

<Section>
```typescript copy
import { desc, asc } from 'drizzle-orm';

await db._query.posts.findMany({
	orderBy: [asc(posts.id)],
});
```
```typescript copy
await db._query.posts.findMany({
	orderBy: (posts, { asc }) => [asc(posts.id)],
});
```
</Section>

**æŒ‰ `asc` + `desc` æ’åºï¼š**
```typescript copy
await db._query.posts.findMany({
	orderBy: (posts, { asc }) => [asc(posts.id)],
	with: {
		comments: {
			orderBy: (comments, { desc }) => [desc(comments.id)],
		},
	},
});
```

### åŒ…æ‹¬è‡ªå®šä¹‰å­—æ®µ
å…³ç³»æŸ¥è¯¢ API å…è®¸æ‚¨æ·»åŠ è‡ªå®šä¹‰é™„åŠ å­—æ®µã€‚  
è¿™åœ¨æ‚¨éœ€è¦æ£€ç´¢æ•°æ®å¹¶å¯¹å…¶åº”ç”¨é™„åŠ å‡½æ•°æ—¶éå¸¸æœ‰ç”¨ã€‚  
<Callout type="warning" emoji="âš ï¸">
	ç›®å‰åœ¨ `extras` ä¸­ä¸æ”¯æŒèšåˆï¼Œè¯·ä½¿ç”¨ **[`æ ¸å¿ƒæŸ¥è¯¢`](/docs/select)** æ¥å¤„ç†ã€‚
</Callout>

<Section>
```typescript copy {5}
import { sql } from 'drizzle-orm';

await db._query.users.findMany({
	extras: {
		loweredName: sql`lower(${users.name})`.as('lowered_name'),
	},
})
```
```typescript copy {3}
await db._query.users.findMany({
	extras: {
		loweredName: (users, { sql }) => sql`lower(${users.name})`.as('lowered_name'),
	},
})
```
</Section>

`lowerName` ä½œä¸ºé”®å°†åŒ…æ‹¬åœ¨è¿”å›å¯¹è±¡çš„æ‰€æœ‰å­—æ®µä¸­ã€‚

<Callout type="warning" emoji="âš ï¸">
  æ‚¨å¿…é¡»æ˜¾å¼æŒ‡å®š `.as("<name_for_column>")`
</Callout>

è¦æ£€ç´¢æ‰€æœ‰ç”¨æˆ·åŠå…¶ç»„ï¼Œä½†åŒ…æ‹¬ fullName å­—æ®µï¼ˆå®ƒæ˜¯ firstName å’Œ lastName çš„è¿æ¥ï¼‰ï¼Œ
æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ä¸ Drizzle å…³ç³»æŸ¥è¯¢æ„å»ºå™¨ã€‚

<Section>
```typescript copy
const res = await db._query.users.findMany({
	extras: {
		fullName: sql<string>`concat(${users.name}, " ", ${users.name})`.as('full_name'),
	},
	with: {
		usersToGroups: {
			with: {
				group: true,
			},
		},
	},
});
```
```ts
// ç»“æœç±»å‹
const res: {
	id: number;
	name: string;
	verified: boolean;
	invitedBy: number | null;
	fullName: string;
	usersToGroups: {
			group: {
					id: number;
					name: string;
					description: string | null;
			};
	}[];
}[];

```
</Section>


è¦æ£€ç´¢æ‰€æœ‰å¸¦è¯„è®ºçš„å¸–å­å¹¶æ·»åŠ ä¸€ä¸ªé¢å¤–å­—æ®µä»¥è®¡ç®—å¸–å­å†…å®¹å’Œæ¯æ¡è¯„è®ºå†…å®¹çš„å¤§å°ï¼š
<Section>
```typescript copy
const res = await db._query.posts.findMany({
	extras: (table, { sql }) => ({
		contentLength: (sql<number>`length(${table.content})`).as('content_length'),
	}),
	with: {
		comments: {
			extras: {
				commentSize: sql<number>`length(${comments.content})`.as('comment_size'),
			},
		},
	},
});
```
```ts
// ç»“æœç±»å‹
const res: {
	id: number;
	createdAt: Date;
	content: string;
	authorId: number | null;
	contentLength: number;
	comments: {
			id: number;
			createdAt: Date;
			content: string;
			creator: number | null;
			postId: number | null;
			commentSize: number;
	}[];
};
```
</Section>

### é¢„ç¼–è¯‘è¯­å¥
é¢„ç¼–è¯‘è¯­å¥æ—¨åœ¨å¤§å¹…æé«˜æŸ¥è¯¢æ€§èƒ½ â€” [è¯·æŸ¥çœ‹æ­¤å¤„.](/docs/perf-queries)

åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å¯ä»¥å­¦ä¹ å¦‚ä½•å®šä¹‰å ä½ç¬¦ä»¥åŠå¦‚ä½•ä½¿ç”¨
Drizzle å…³ç³»æŸ¥è¯¢æ„å»ºå™¨æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥ã€‚

##### **`where` ä¸­çš„å ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	where: ((users, { eq }) => eq(users.id, placeholder('id'))),
	with: {
		posts: {
			where: ((users, { eq }) => eq(users.id, placeholder('pid'))),
		},
	},
}).prepare('query_name');

const usersWithPosts = await prepared.execute({ id: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	where: ((users, { eq }) => eq(users.id, placeholder('id'))),
	with: {
		posts: {
			where: ((users, { eq }) => eq(users.id, placeholder('pid'))),
		},
	},
}).prepare();

const usersWithPosts = await prepared.execute({ id: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	where: ((users, { eq }) => eq(users.id, placeholder('id'))),
	with: {
		posts: {
			where: ((users, { eq }) => eq(users.id, placeholder('pid'))),
		},
	},
}).prepare();

const usersWithPosts = await prepared.execute({ id: 1 });
```
</Section>
</Tab>
</Tabs>


##### **`limit` ä¸­çš„å ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	with: {
		posts: {
			limit: placeholder('limit'),
		},
	},
}).prepare('query_name');

const usersWithPosts = await prepared.execute({ limit: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	with: {
		posts: {
			limit: placeholder('limit'),
		},
	},
}).prepare();

const usersWithPosts = await prepared.execute({ limit: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	with: {
		posts: {
			limit: placeholder('limit'),
		},
	},
}).prepare();

const usersWithPosts = await prepared.execute({ limit: 1 });
```
</Section>
</Tab>
</Tabs>


##### **`offset` ä¸­çš„å ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	offset: placeholder('offset'),
	with: {
		posts: true,
	},
}).prepare('query_name');

const usersWithPosts = await prepared.execute({ offset: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	offset: placeholder('offset'),
	with: {
		posts: true,
	},
}).prepare();

const usersWithPosts = await prepared.execute({ offset: 1 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	offset: placeholder('offset'),
	with: {
		posts: true,
	},
}).prepare();

const usersWithPosts = await prepared.execute({ offset: 1 });
```
</Section>
</Tab>
</Tabs>

##### **å¤šä¸ªå ä½ç¬¦**
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	limit: placeholder('uLimit'),
	offset: placeholder('uOffset'),
	where: ((users, { eq, or }) => or(eq(users.id, placeholder('id')), eq(users.id, 3))),
	with: {
		posts: {
			where: ((users, { eq }) => eq(users.id, placeholder('pid'))),
			limit: placeholder('pLimit'),
		},
	},
}).prepare('query_name');

const usersWithPosts = await prepared.execute({ pLimit: 1, uLimit: 3, uOffset: 1, id: 2, pid: 6 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	limit: placeholder('uLimit'),
	offset: placeholder('uOffset'),
	where: ((users, { eq, or }) => or(eq(users.id, placeholder('id')), eq(users.id, 3))),
	with: {
		posts: {
			where: ((users, { eq }) => eq(users.id, placeholder('pid'))),
			limit: placeholder('pLimit'),
		},
	},
}).prepare();

const usersWithPosts = await prepared.execute({ pLimit: 1, uLimit: 3, uOffset: 1, id: 2, pid: 6 });
```
</Section>
</Tab>
<Tab>
<Section>
```ts copy
const prepared = db._query.users.findMany({
	limit: placeholder('uLimit'),
	offset: placeholder('uOffset'),
	where: ((users, { eq, or }) => or(eq(users.id, placeholder('id')), eq(users.id, 3))),
	with: {
		posts: {
			where: ((users, { eq }) => eq(users.id, placeholder('pid'))),
			limit: placeholder('pLimit'),
		},
	},
}).prepare();

const usersWithPosts = await prepared.execute({ pLimit: 1, uLimit: 3, uOffset: 1, id: 2, pid: 6 });
```
</Section>
</Tab>
</Tabs>


Source: https://drizzle.zhcndoc.com/docs/schemas

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Section from '@mdx/Section.astro';
import Callout from '@mdx/Callout.astro';

# è¡¨ç»“æ„

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': true, 'SQLite': false, 'SingleStore': true, 'MSSQL': true, 'CockroachDB': true }} />

å¦‚æœåœ¨æ¶æ„ä¸­å£°æ˜äº†ä¸€ä¸ªå®ä½“ï¼ŒæŸ¥è¯¢æ„å»ºå™¨ä¼šåœ¨æŸ¥è¯¢ä¸­æ·»åŠ æ¶æ„åç§°ï¼š<br/>
`select * from "schema"."users"`

<Tabs items={['PostgreSQL', 'MySQL', "SQLite", "SingleStore", 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
    ```ts copy {3,5,7}
    import { serial, text, pgSchema } from "drizzle-orm/pg-core";

    export const mySchema = pgSchema("my_schema");

    export const colors = mySchema.enum('colors', ['red', 'green', 'blue']);

    export const mySchemaUsers = mySchema.table('users', {
      id: serial('id').primaryKey(),
      name: text('name'),
      color: colors('color').default('red'),
    });

    
    ```
    ```sql
    CREATE SCHEMA "my_schema";

    CREATE TYPE "my_schema"."colors" AS ENUM ('red', 'green', 'blue');

    CREATE TABLE "my_schema"."users" (
      "id" serial PRIMARY KEY,
      "name" text,
      "color" "my_schema"."colors" DEFAULT 'red'
    );
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```ts {3,5}
    import { int, text, mysqlSchema } from "drizzle-orm/mysql-core";

    export const mySchema = mysqlSchema("my_schema")

    export const mySchemaUsers = mySchema.table("users", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
    });
    ```
    ```sql
    CREATE SCHEMA "my_schema";

    CREATE TABLE "my_schema"."users" (
      "id" serial PRIMARY KEY,
      "name" text
    );
    ```
    </Section>
  </Tab>
  <Tab>
  SQLite ä¸æ”¯æŒæ¶æ„ ğŸ˜•
  </Tab>
  <Tab>
    <Section>
    ```ts {3,5}
    import { int, text, singlestoreSchema } from "drizzle-orm/singlestore-core";

    export const mySchema = singlestoreSchema("my_schema")

    export const mySchemaUsers = mySchema.table("users", {
      id: int("id").primaryKey().autoincrement(),
      name: text("name"),
    });
    ```
    ```sql
    CREATE SCHEMA "my_schema";

    CREATE TABLE "my_schema"."users" (
      "id" serial PRIMARY KEY,
      "name" text
    );
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```ts {3,5}
    import { int, text, mssqlSchema } from "drizzle-orm/mssql-core";

    export const mySchema = mssqlSchema("my_schema")

    export const mySchemaUsers = mySchema.table("users", {
      id: int().primaryKey(),
      name: text(),
    });
    ```
    ```sql
    CREATE SCHEMA [my_schema];

    CREATE TABLE [my_schema].[users] (
      [id] int PRIMARY KEY,
      [name] text
    );
    ```
    </Section>
  </Tab>
  <Tab>
    <Section>
    ```ts copy {3,5,7}
    import { int4, text, cockroachSchema } from "drizzle-orm/cockroach-core";

    export const mySchema = cockroachSchema("my_schema");

    export const colors = mySchema.enum('colors', ['red', 'green', 'blue']);

    export const mySchemaUsers = mySchema.table('users', {
      id: int4().primaryKey(),
      name: text(),
      color: colors().default('red'),
    });

    
    ```
    ```sql
    CREATE SCHEMA "my_schema";

    CREATE TYPE "my_schema"."colors" AS ENUM ('red', 'green', 'blue');

    CREATE TABLE "my_schema"."users" (
      "id" serial PRIMARY KEY,
      "name" text,
      "color" "my_schema"."colors" DEFAULT 'red'
    );
    ```
    </Section>
  </Tab>
</Tabs>

{/* TODO: ??? ç¤ºä¾‹ > **è­¦å‘Š**
> å¦‚æœä½ åœ¨ä¸åŒçš„æ¶æ„ä¸­æœ‰åŒåè¡¨ï¼Œåˆ™ drizzle ä¼šåœ¨ç»“æœç±»å‹ä¸­å“åº” `never[]` é”™è¯¯ï¼Œå¹¶ä»æ•°æ®åº“è¿”å›é”™è¯¯
>
> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ [åˆ«åè¯­æ³•](./joins#join-aliases-and-self-joins) */}

Source: https://drizzle.zhcndoc.com/docs/seed-functions

import Callout from '@mdx/Callout.astro';
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";

# ç”Ÿæˆå™¨

<Callout title='warning'>
ç›®å‰ï¼Œåœ¨æ”¯æŒçš„ç”Ÿæˆå™¨ä¸­åŒæ—¶æŒ‡å®š `arraySize` å’Œ `isUnique` å°†å¯¼è‡´ç”Ÿæˆå”¯ä¸€å€¼ï¼ˆè€Œä¸æ˜¯å”¯ä¸€æ•°ç»„ï¼‰ï¼Œç„¶åè¿™äº›å€¼å°†è¢«æ‰“åŒ…æˆæ•°ç»„ã€‚
</Callout>

## ---

### `default`

<rem025 />
æ¯æ¬¡è°ƒç”¨ç”Ÿæˆå™¨æ—¶ä¼šç”Ÿæˆç›¸åŒçš„ç»™å®šå€¼ã€‚

|  | å‚æ•°          | é»˜è®¤å€¼     | ç±»å‹
|:-| :--------      | :--------   | :--------
|  |`defaultValue`  |--           |`any`
|  |`arraySize`     |--           |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  posts: {
    columns: {
      content: funcs.default({
        // è¦ç”Ÿæˆçš„å€¼
        defaultValue: "å¸–å­å†…å®¹",

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `valuesFromArray`

<rem025 />
ä»ç»™å®šæ•°ç»„ç”Ÿæˆå€¼

|  | å‚æ•°      | é»˜è®¤å€¼                   | ç±»å‹
|:-| :--------  | :--------                 | :--------
|  |`values`    |--                         |`any[]` \| `{ weight: number; values: any[] }[]`
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  posts: {
    columns: {
      title: funcs.valuesFromArray({
        // è¦ç”Ÿæˆçš„å€¼æ•°ç»„ï¼ˆå¯ä»¥æ˜¯åŠ æƒå€¼æ•°ç»„ï¼‰
        values: ["æ ‡é¢˜1", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4", "æ ‡é¢˜5"],

        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§
        isUnique: true,
        
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `intPrimaryKey`

<rem025 />
ç”Ÿæˆä» 1 å¼€å§‹çš„é¡ºåºæ•´æ•°ã€‚

|  | å‚æ•°      | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |--          |--          |--

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  posts: {
    columns: {
      id: funcs.intPrimaryKey(),
    },
  },
}));

```

### `number`

<rem025 />
åœ¨ç»™å®šèŒƒå›´å†…ç”Ÿæˆå¸¦å°æ•°çš„æ•°å­—

|  | å‚æ•°       | é»˜è®¤å€¼                                                                                               | ç±»å‹
|:-| :--------  | :--------                                                                                             | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                                     |`boolean`
|  |`precision` |`100`                                                                                                  |`number`
|  |`maxValue`  |``` `precision * 1000` å¦‚æœ isUnique ä¸º false ``` ``` `precision * count` å¦‚æœ isUnique ä¸º true ```  |`number`
|  |`minValue`  |`-maxValue`                                                                                            |`number`
|  |`arraySize` |--                                                                                                     |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  products: {
    columns: {
      unitPrice: funcs.number({
        // èŒƒå›´çš„ä¸‹è¾¹ç•Œã€‚
        minValue: 10,

        // èŒƒå›´çš„ä¸Šè¾¹ç•Œã€‚
        maxValue: 120,
        
        // ç”Ÿæˆæ•°å­—çš„ç²¾åº¦ï¼š
        // ç²¾åº¦ä¸º 10 æ„å‘³ç€å€¼ç²¾ç¡®åˆ°ååˆ†ä¹‹ä¸€ (1.2, 34.6);
        // ç²¾åº¦ä¸º 100 æ„å‘³ç€å€¼ç²¾ç¡®åˆ°ç™¾åˆ†ä¹‹ä¸€ (1.23, 34.67)ã€‚
        precision: 100,

        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§ã€‚
        isUnique: false,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `int`

<rem025 />
åœ¨ç»™å®šèŒƒå›´å†…ç”Ÿæˆæ•´æ•°

|  | å‚æ•°       | é»˜è®¤å€¼                                                                            | ç±»å‹
|:-| :--------  | :--------                                                                          | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                  |`boolean`
|  |`maxValue`  |``` `1000` å¦‚æœ isUnique ä¸º false ``` ``` `count * 10` å¦‚æœ isUnique ä¸º true ```  |`number \| bigint`
|  |`minValue`  |`-maxValue`                                                                       |`number \| bigint`
|  |`arraySize` |--                                                                                |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  products: {
    columns: {
      unitsInStock: funcs.int({
        // èŒƒå›´çš„ä¸‹è¾¹ç•Œã€‚
        minValue: 0,

        // èŒƒå›´çš„ä¸Šè¾¹ç•Œã€‚
        maxValue: 100,

        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§ã€‚
        isUnique: false,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `boolean`

<rem025 />
ç”Ÿæˆå¸ƒå°”å€¼ï¼ˆçœŸæˆ–å‡ï¼‰

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      isAvailable: funcs.boolean({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `date`

<rem025 />
åœ¨ç»™å®šèŒƒå›´å†…ç”Ÿæˆæ—¥æœŸ

|  | å‚æ•°       | é»˜è®¤å€¼                 | ç±»å‹
|:-| :--------  | :--------------         | :--------
|  |`minDate`   |`new Date('2020-05-08')` | `string \| Date`
|  |`maxDate`   |`new Date('2028-05-08')` | `string \| Date`
|  |`arraySize` |--                       |`number`

<Callout type='warning'>
å¦‚æœåªæä¾›äº†ä¸€ä¸ªå‚æ•°ï¼ˆ`minDate` æˆ– `maxDate`ï¼‰ï¼Œåˆ™æœªæŒ‡å®šçš„å‚æ•°å°†é€šè¿‡åœ¨æŒ‡å®šå‚æ•°ä¸ŠåŠ å‡ 8 å¹´æ¥è®¡ç®—
</Callout>

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      birthDate: funcs.date({
        // èŒƒå›´çš„ä¸‹è¾¹ç•Œã€‚
        minDate: "1990-01-01",

        // èŒƒå›´çš„ä¸Šè¾¹ç•Œã€‚
        maxDate: "2010-12-31",

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `time`

<rem025 />
ç”Ÿæˆ 24 å°æ—¶åˆ¶çš„æ—¶é—´

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      birthTime: funcs.time({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `timestamp`

<rem025 />
ç”Ÿæˆæ—¶é—´æˆ³

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  orders: {
    columns: {
      shippedDate: funcs.timestamp({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `datetime`

<rem025 />
ç”Ÿæˆæ—¥æœŸæ—¶é—´å¯¹è±¡

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`
<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  orders: {
    columns: {
      shippedDate: funcs.datetime({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `year`

<rem025 />
ç”Ÿæˆ `YYYY` æ ¼å¼çš„å¹´ä»½

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      birthYear: funcs.year({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `json`

<rem025 />
ç”Ÿæˆå…·æœ‰å›ºå®šç»“æ„çš„ JSON å¯¹è±¡

```ts
{ email, name, isGraduated, hasJob, salary, startedWorking, visitedCountries}

// æˆ–è€…

{ email, name, isGraduated, hasJob, visitedCountries }
```

> JSON ç»“æ„å°†éšæœºé€‰æ‹©

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      metadata: funcs.json({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `interval`

<rem025 />
ç”Ÿæˆæ—¶é—´é—´éš”ã€‚

ç”Ÿæˆå€¼çš„ç¤ºä¾‹ï¼š `1 year 12 days 5 minutes`

|  | å‚æ•°       | é»˜è®¤å€¼            | ç±»å‹
|:-| :--------  | :--------          | :--------
|  |`isUnique`  | åˆ—å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                  |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      timeSpentOnWebsite: funcs.interval({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `string`

<rem025 />
ç”Ÿæˆéšæœºå­—ç¬¦ä¸²

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      hashedPassword: funcs.string({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: false,
        
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `uuid`

<rem025 />
ç”Ÿæˆ v4 UUID å­—ç¬¦ä¸²

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";
await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  products: {
    columns: {
      id: funcs.uuid({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));
```

### `firstName`

<rem025 />
ç”Ÿæˆä¸€ä¸ªäººçš„åå­—

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      firstName: funcs.firstName({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `lastName`

<rem025 />
ç”Ÿæˆä¸€ä¸ªäººçš„å§“æ°

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      lastName: funcs.lastName({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: false,
        
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `fullName`

<rem025 />
ç”Ÿæˆä¸€ä¸ªäººçš„å…¨å

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      fullName: funcs.fullName({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `email`

<rem025 />
ç”Ÿæˆå”¯ä¸€çš„ç”µå­é‚®ä»¶åœ°å€

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      email: funcs.email({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `phoneNumber`

<rem025 />
ç”Ÿæˆå”¯ä¸€çš„ç”µè¯å·ç 

|  | å‚æ•°                    | é»˜è®¤å€¼                                         | ç±»å‹
|:-| :--------                | :--------                                       | :--------
|  |`template`                |--                                               |`string`
|  |`prefixes`                |[ç”¨äºå‰ç¼€çš„æ•°æ®é›†](https://github.com/OleksiiKH0240/drizzle-orm/blob/main/drizzle-seed/src/datasets/phonesInfo.ts)   |`string[]`
|  |`generatedDigitsNumbers`  | `7` - `å¦‚æœå®šä¹‰äº†å‰ç¼€`                       |`number \| number[]`
|  |`arraySize`               |--                                               |`number`

<rem025 />
```ts 
import { seed } from "drizzle-seed";

//ä½¿ç”¨æ¨¡æ¿å±æ€§ç”Ÿæˆç”µè¯å·ç 
await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      phoneNumber: funcs.phoneNumber({ 
        // `template` - ç”µè¯å·ç æ¨¡æ¿ï¼Œå…¶ä¸­æ‰€æœ‰ '#' ç¬¦å·å°†è¢«ç”Ÿæˆçš„æ•°å­—æ›¿æ¢ã€‚
        template: "+(380) ###-####",

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```
```ts 
import { seed } from "drizzle-seed";

//ä½¿ç”¨å‰ç¼€å’Œç”Ÿæˆçš„æ•°å­—æ•°é‡å±æ€§ç”Ÿæˆç”µè¯å·ç 
await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      phoneNumber: funcs.phoneNumber({
        // `prefixes` - ä½ å¸Œæœ›ä½œä¸ºç”µè¯å·ç å‰ç¼€çš„ä»»ä½•å­—ç¬¦ä¸²çš„æ•°ç»„ã€‚ï¼ˆä¸ `template` å±æ€§ä¸å…¼å®¹ï¼‰
        prefixes: ["+380 99", "+380 67"],

        // `generatedDigitsNumbers` - å°†æ·»åŠ åˆ°å‰ç¼€åçš„æ•°å­—æ•°é‡ã€‚ï¼ˆä¸ `template` å±æ€§ä¸å…¼å®¹ï¼‰
        generatedDigitsNumbers: 7,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```
```ts 
import { seed } from "drizzle-seed";

//ä½¿ç”¨å‰ç¼€å’Œç”Ÿæˆçš„æ•°å­—æ•°é‡å±æ€§ç”Ÿæˆç”µè¯å·ç ï¼Œä½†ä¸ºå‰ç¼€ä½¿ç”¨ä¸åŒçš„ç”Ÿæˆæ•°å­—æ•°é‡
await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      phoneNumber: funcs.phoneNumber({
        // `prefixes` - ä½ å¸Œæœ›ä½œä¸ºç”µè¯å·ç å‰ç¼€çš„ä»»ä½•å­—ç¬¦ä¸²çš„æ•°ç»„ã€‚ï¼ˆä¸ `template` å±æ€§ä¸å…¼å®¹ï¼‰
        prefixes: ["+380 99", "+380 67", "+1"],

        // `generatedDigitsNumbers` - å°†æ·»åŠ åˆ°å‰ç¼€åçš„æ•°å­—æ•°é‡ã€‚ï¼ˆä¸ `template` å±æ€§ä¸å…¼å®¹ï¼‰
        generatedDigitsNumbers: [7, 7, 10],

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```
### `country`

<rem025 />
ç”Ÿæˆå›½å®¶åç§°

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      country: funcs.country({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: false,
        
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `city`

<rem025 />
ç”ŸæˆåŸå¸‚åç§°

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      city: funcs.city({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: false,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `streetAddress`

<rem025 />
ç”Ÿæˆè¡—é“åœ°å€

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      streetAddress: funcs.streetAddress({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: false,
        
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3 
      }),
    },
  },
}));

```

### `jobTitle`

<rem025 />
ç”ŸæˆèŒä½åç§°

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      jobTitle: funcs.jobTitle({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `postcode`

<rem025 />
ç”Ÿæˆé‚®æ”¿ç¼–ç 

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      postcode: funcs.postcode({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `state`

<rem025 />
ç”Ÿæˆç¾å›½å·å

|  | å‚æ•°       | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------  | :--------  | :--------
|  |`arraySize` |--          |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      state: funcs.state({
        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `companyName`

<rem025 />
ç”Ÿæˆéšæœºå…¬å¸çš„åç§°

|  | å‚æ•°       | é»˜è®¤å€¼                     | ç±»å‹
|:-| :--------  | :--------                   | :--------
|  |`isUnique`  |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§           |`boolean`
|  |`arraySize` |--                         |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  users: {
    columns: {
      company: funcs.companyName({ 
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```
### `loremIpsum`

<rem025 />
ç”Ÿæˆ `lorem ipsum` æ–‡æœ¬å¥å­ã€‚

|  | å‚æ•°            | é»˜è®¤å€¼    | ç±»å‹
|:-| :--------        | :--------  | :--------
|  |`sentencesCount`  | 1          |`number`
|  |`arraySize`       |--          |`number`

<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  posts: {
    columns: {
      content: funcs.loremIpsum({
        // `sentencesCount` - ä½ å¸Œæœ›ç”Ÿæˆä½œä¸ºä¸€ä¸ªç”Ÿæˆå€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰çš„å¥å­æ•°é‡ã€‚
        sentencesCount: 2,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `point`

<rem025 />
ç”Ÿæˆåœ¨ x å’Œ y åæ ‡çš„æŒ‡å®šèŒƒå›´å†…çš„äºŒç»´ç‚¹ã€‚

|  | å‚æ•°       | é»˜è®¤å€¼                                                                                 | ç±»å‹
|:-| :--------   | :--------                                                                               | :--------
|  |`isUnique`   |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                       |`boolean`
|  |`maxXValue`  |``` `10 * 1000` å¦‚æœ isUnique ä¸º false ``` ``` `10 * count` å¦‚æœ isUnique ä¸º true ```  |`number`
|  |`minXValue`  |`-maxXValue`                                                                             |`number`
|  |`maxYValue`  |``` `10 * 1000` å¦‚æœ isUnique ä¸º false ``` ``` `10 * count` å¦‚æœ isUnique ä¸º true ```  |`number`
|  |`minYValue`  |`-maxYValue`                                                                             |`number`
|  |`arraySize`  |--                                                                                       |`number`


<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  triangles: {
    columns: {
      pointCoords: funcs.point({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // `minXValue` - x åæ ‡çš„ä¸‹è¾¹ç•Œã€‚
        minXValue: -5,

        // `maxXValue` - x åæ ‡çš„ä¸Šè¾¹ç•Œã€‚
        maxXValue: 20,

        // `minYValue` - y åæ ‡çš„ä¸‹è¾¹ç•Œã€‚
        minYValue: 0,

        // `maxYValue` - y åæ ‡çš„ä¸Šè¾¹ç•Œã€‚
        maxYValue: 30,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `line`

<rem025 />
ç”Ÿæˆåœ¨æŒ‡å®šèŒƒå›´å†…çš„äºŒç»´çº¿çš„ aã€b å’Œ c å‚æ•°ã€‚

```
çº¿æ–¹ç¨‹ï¼š a*x + b*y + c = 0
```

|  | å‚æ•°       | é»˜è®¤å€¼                                                                                 | ç±»å‹
|:-| :--------   | :--------                                                                               | :--------
|  |`isUnique`   |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                       |`boolean`
|  |`maxAValue`  |``` `10 * 1000` å¦‚æœ isUnique ä¸º false ``` ``` `10 * count` å¦‚æœ isUnique ä¸º true ```  |`number`
|  |`minAValue`  |`-maxAValue`                                                                             |`number`
|  |`maxBValue`  |``` `10 * 1000` å¦‚æœ isUnique ä¸º false ``` ``` `10 * count` å¦‚æœ isUnique ä¸º true ```  |`number`
|  |`minBValue`  |`-maxBValue`                                                                             |`number`
|  |`maxCValue`  |``` `10 * 1000` å¦‚æœ isUnique ä¸º false ``` ``` `10 * count` å¦‚æœ isUnique ä¸º true ```  |`number`
|  |`minCValue`  |`-maxCValue`                                                                             |`number`
|  |`arraySize`  |--                                                                                       |`number`
<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  lines: {
    columns: {
      lineParams: funcs.point({
        // `isUnique` - å±æ€§æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å°†å”¯ä¸€
        isUnique: true,

        // `minAValue` - a å‚æ•°çš„ä¸‹è¾¹ç•Œã€‚
        minAValue: -5,

        // `maxAValue` - a å‚æ•°çš„ä¸Šè¾¹ç•Œã€‚
        maxAValue: 20,

        // `minBValue` - b å‚æ•°çš„ä¸‹è¾¹ç•Œã€‚
        minBValue: 0,

        // `maxBValue` - b å‚æ•°çš„ä¸Šè¾¹ç•Œã€‚
        maxBValue: 30,

        // `minCValue` - c å‚æ•°çš„ä¸‹è¾¹ç•Œã€‚
        minCValue: 0,

        // `maxCValue` - c å‚æ•°çš„ä¸Šè¾¹ç•Œã€‚
        maxCValue: 10,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ã€‚ 
        // ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ã€‚ï¼‰
        arraySize: 3
      }),
    },
  },
}));

```

### `bitString`

<rem025 />
ç”ŸæˆåŸºäºæŒ‡å®šå‚æ•°çš„ä½å­—ç¬¦ä¸²ã€‚

|  | å‚æ•°       | é»˜è®¤å€¼                                                                                 | ç±»å‹
|:-| :--------   | :--------                                                                               | :--------
|  |`isUnique`   |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                       |`boolean`
|  |`dimensions` |æ•°æ®åº“åˆ—ä½é•¿åº¦                                                                         |`number`
|  |`arraySize`  |--                                                                                     |`number`
<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  bitStringTable: {
    columns: {
      bit: funcs.bitString({
        // æœŸæœ›çš„æ¯ä¸ªä½å­—ç¬¦ä¸²é•¿åº¦ï¼ˆä¾‹å¦‚ï¼Œ`dimensions = 3` ç”Ÿæˆç±»ä¼¼ `'010'` çš„å€¼ï¼‰ã€‚
        dimensions: 12,

        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§ï¼›
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ï¼‰ï¼›
        arraySize: 3,
      }),
    },
  },
}));

```

### `inet`

<rem025 />
åŸºäºæŒ‡å®šå‚æ•°ç”Ÿæˆ IP åœ°å€ã€‚

|  | å‚æ•°       | é»˜è®¤å€¼                                                                                 | ç±»å‹
|:-| :--------   | :--------                                                                               | :--------
|  |`isUnique`   |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                       |`boolean`
|  |`arraySize`  |--                                                                                     |`number`
|  |`ipAddress`  |`'ipv4'`                                                                              |`'ipv4' \| 'ipv6'`
|  |`includeCidr`|`true`                                                                                |`boolean`
<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  inetTable: {
    columns: {
      inet: funcs.inet({
        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§ï¼›
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ï¼‰ï¼›
        arraySize: 3,

        // è¦ç”Ÿæˆçš„ IP åœ°å€ç±»å‹ â€” "ipv4" æˆ– "ipv6"ï¼›
        ipAddress: "ipv4",

        // å†³å®šç”Ÿæˆçš„ IP æ˜¯å¦åŒ…å« CIDR åç¼€ã€‚
        includeCidr: true,
      }),
    },
  },
}));
```

### `geometry`

<rem025 />
åŸºäºç»™å®šå‚æ•°ç”Ÿæˆå‡ ä½•å¯¹è±¡ã€‚

<Callout title='warning'>
<Tabs items={['arraySize', 'srid']}>
<Tab>
ç›®å‰ï¼Œå¦‚æœä½ å°† arraySize è®¾ç½®ä¸ºå¤§äº 1 çš„å€¼ï¼Œæˆ–è€…å°è¯•é€šè¿‡ drizzle-orm å‘ PostgreSQL æˆ– CockroachDB ä¸­çš„ `geometry(point, 0)[]` åˆ—æ’å…¥å¤šä¸ª `geometry point` å…ƒç´ ï¼Œä¼šé‡åˆ°é”™è¯¯ã€‚

æ­¤é—®é¢˜å·²ç»åˆ—å…¥å¾…åŠäº‹é¡¹ã€‚

<Callout title="âŒ">
```ts {13}
import { seed } from "drizzle-seed";
import { geometry, pgTable } from 'drizzle-orm/pg-core';

const geometryTable = pgTable('geometry_table', {
	geometryArray: geometry('geometry_array', { type: 'point', srid: 0 }).array(3),
});

await seed(db, { geometryTable }, { count: 1000 }).refine((funcs) => ({
  geometryTable: {
    columns: {
      geometryArray: funcs.geometry({
        // ç›®å‰ä¸æ”¯æŒå¤§äº 1 çš„ arraySize
        arraySize: 3,
      }),
    },
  },
}));
```
</Callout>

<Callout title='âœ…'>
```ts {13}
import { seed } from "drizzle-seed";
import { geometry, pgTable } from 'drizzle-orm/pg-core';

const geometryTable = pgTable('geometry_table', {
	geometryArray: geometry('geometry_array', { type: 'point', srid: 0 }).array(1),
});

await seed(db, { geometryTable }, { count: 1000 }).refine((funcs) => ({
  geometryTable: {
    columns: {
      geometryArray: funcs.geometry({
        // è¿™æ ·è®¾ç½®å°†æŒ‰é¢„æœŸå·¥ä½œ
        arraySize: 1,
      }),
    },
  },
}));
```
</Callout>
</Tab>

<Tab>
ç›®å‰ï¼Œå¦‚æœä½ åœ¨ drizzle-orm è¡¨å£°æ˜ä¸­å°† `geometry(point)` åˆ—çš„ SRID è®¾ç½®ä¸ºé™¤ 0 ä»¥å¤–çš„å…¶å®ƒå€¼ï¼ˆä¾‹å¦‚ 4326ï¼‰ï¼Œ
åœ¨å¡«å……æ•°æ®æ—¶ä¼šé‡åˆ°é”™è¯¯ã€‚

æ­¤é—®é¢˜å·²ç»åˆ—å…¥å¾…åŠäº‹é¡¹ã€‚

<Callout title="âŒ">
```ts {5}
import { seed } from "drizzle-seed";
import { geometry, pgTable } from 'drizzle-orm/pg-core';

const geometryTable = pgTable('geometry_table', {
	geometryColumn: geometry('geometry_column', { type: 'point', srid: 4326 }),
});

await seed(db, { geometryTable }, { count: 1000 }).refine((funcs) => ({
  geometryTable: {
    columns: {
      geometryColumn: funcs.geometry({
        srid: 4326,
      }),
    },
  },
}));
```
</Callout>

<Callout title='âœ…'>
```ts {5}
import { seed } from "drizzle-seed";
import { geometry, pgTable } from 'drizzle-orm/pg-core';

const geometryTable = pgTable('geometry_table', {
	geometryColumn: geometry('geometry_column', { type: 'point', srid: 0 }),
});

await seed(db, { geometryTable }, { count: 1000 }).refine((funcs) => ({
  geometryTable: {
    columns: {
      geometryColumn: funcs.geometry({
        srid: 4326,
      }),
    },
  },
}));
```
</Callout>
</Tab>
</Tabs>
</Callout>

|  | å‚æ•°          | é»˜è®¤å€¼                                                                                 | ç±»å‹
|:-| :--------      | :--------                                                                               | :--------
|  |`isUnique`      |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                                                       |`boolean`
|  |`arraySize`     |--                                                                                     |`number`
|  |`type`          |`'point'`                                                                             |`'point'`
|  |`srid`          |`4326`                                                                                |`4326 \| 3857`
|  |`decimalPlaces` |`6`                                                                                     |`1 \| 2 \| 3 \| 4 \| 5 \| 6 \| 7`
<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  geometryTable: {
    columns: {
      geometryPointTuple: funcs.geometry({
        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§ï¼›
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ï¼‰ï¼›
        arraySize: 1,

        // è¦ç”Ÿæˆçš„å‡ ä½•ç±»å‹ï¼›å½“å‰ä»…æ”¯æŒ `'point'`ï¼›
        type: "point",

        // ç©ºé—´å‚è€ƒç³»ç»Ÿæ ‡è¯†ç¬¦ï¼šå†³å®šç”Ÿæˆçš„ç‚¹ç±»å‹ â€” `4326` æˆ– `3857`ï¼›
        srid: 4326,

        // å½“ `srid` æ˜¯ `4326` æ—¶ï¼Œç‚¹çš„å°æ•°ä½æ•°ï¼ˆä¾‹å¦‚ï¼Œ`decimalPlaces = 3` ä¼šç”Ÿæˆç±»ä¼¼ `'point(30.723 46.482)'` çš„å€¼ï¼‰ã€‚
        decimalPlaces: 5,
      }),
    },
  },
}));

```

### `vector`

<rem025 />
åŸºäºæä¾›çš„å‚æ•°ç”Ÿæˆå‘é‡ã€‚

|  | å‚æ•°          | é»˜è®¤å€¼                                                      | ç±»å‹
|:-| :--------      | :--------                                                  | :--------
|  |`isUnique`      |æ•°æ®åº“åˆ—çš„å”¯ä¸€æ€§                                            |`boolean`
|  |`arraySize`     |--                                                          |`number`
|  |`decimalPlaces` |`2`                                                         |`number`
|  |`dimensions`    |æ•°æ®åº“åˆ—çš„ç»´æ•°                                              |`number`
|  |`minValue`      |`-1000`                                                     |`number`
|  |`maxValue`      |`1000`                                                      |`number`
<rem025 />

```ts 
import { seed } from "drizzle-seed";

await seed(db, schema, { count: 1000 }).refine((funcs) => ({
  vectorTable: {
    columns: {
      vector: funcs.vector({
        // æ§åˆ¶ç”Ÿæˆå€¼æ˜¯å¦å”¯ä¸€çš„å±æ€§ï¼›
        isUnique: true,

        // æ¯ä¸ªä¸€ç»´æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ï¼ˆå¦‚æŒ‡å®šï¼Œå°†ç”Ÿæˆæ•°ç»„ï¼‰ï¼›
        arraySize: 3,

        // æ¯ä¸ªå‘é‡å…ƒç´ çš„å°æ•°ä½æ•°ï¼ˆä¾‹å¦‚ï¼Œ`decimalPlaces = 3` ç”Ÿæˆå¦‚ `1.123` çš„å€¼ï¼‰ï¼›
        decimalPlaces: 5,

        // æ¯ä¸ªç”Ÿæˆå‘é‡çš„å…ƒç´ æ•°é‡ï¼ˆä¾‹å¦‚ï¼Œ`dimensions = 3` ç”Ÿæˆå¦‚ `[1,2,3]` çš„å€¼ï¼‰ï¼›
        dimensions: 12,

        // æ¯ä¸ªå‘é‡å…ƒç´ å…è®¸çš„æœ€å°å€¼ï¼›
        minValue: -100,

        // æ¯ä¸ªå‘é‡å…ƒç´ å…è®¸çš„æœ€å¤§å€¼ã€‚
        maxValue: 100,
      }),
    },
  },
}));

```

Source: https://drizzle.zhcndoc.com/docs/seed-limitations

// type limitations for third param

Source: https://drizzle.zhcndoc.com/docs/seed-overview

import Npm from "@mdx/Npm.astro";
import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from '@mdx/Callout.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from "@mdx/Section.astro";
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';

# Drizzle Seed

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': true, 'SingleStore': true, 'CockroachDB': true, 'MS SQL': true }} />

<Callout type='warning'>
  `drizzle-seed` åªèƒ½ä¸ `drizzle-orm@0.36.4` æˆ–æ›´é«˜ç‰ˆæœ¬ä¸€èµ·ä½¿ç”¨ã€‚ä½äºæ­¤ç‰ˆæœ¬çš„ç‰ˆæœ¬åœ¨è¿è¡Œæ—¶å¯èƒ½èƒ½å·¥ä½œï¼Œä½†å¯èƒ½å­˜åœ¨ç±»å‹é—®é¢˜å’Œæ ‡è¯†åˆ—é—®é¢˜ï¼Œå› ä¸ºæ­¤è¡¥ä¸æ˜¯ä» `drizzle-orm@0.36.4` å¼€å§‹å¼•å…¥çš„
</Callout>

`drizzle-seed` æ˜¯ä¸€ä¸ª TypeScript åº“ï¼Œå¸®åŠ©ä½ ç”Ÿæˆç¡®å®šæ€§çš„ã€ä½†åˆé€¼çœŸçš„å‡æ•°æ®æ¥å¡«å……ä½ çš„æ•°æ®åº“ã€‚é€šè¿‡åˆ©ç”¨ä¸€ä¸ªå¯è®¾ç½®ç§å­çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆpRNGï¼‰ï¼Œå®ƒä¿è¯ä½ ç”Ÿæˆçš„æ•°æ®åœ¨ä¸åŒè¿è¡Œé—´ä¿æŒä¸€è‡´ä¸”å¯å¤ç°ã€‚è¿™å¯¹äºæµ‹è¯•ã€å¼€å‘å’Œè°ƒè¯•å°¤ä¸ºæœ‰ç”¨ã€‚

#### ä»€ä¹ˆæ˜¯ç¡®å®šæ€§æ•°æ®ç”Ÿæˆï¼Ÿ

ç¡®å®šæ€§æ•°æ®ç”Ÿæˆæ„å‘³ç€ç›¸åŒçš„è¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚åœ¨ `drizzle-seed` çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå½“ä½ ç”¨ç›¸åŒçš„ç§å­æ•°å­—åˆå§‹åŒ–åº“æ—¶ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šç”ŸæˆåŒæ ·çš„å‡æ•°æ®åºåˆ—ã€‚è¿™å…è®¸æ•°æ®é›†æ˜¯å¯é¢„æµ‹å’Œå¯é‡å¤çš„ã€‚

#### ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆpRNGï¼‰

ä¼ªéšæœºæ•°ç”Ÿæˆå™¨æ˜¯ä¸€ç§ç®—æ³•ï¼Œç”¨ä»¥ç”Ÿæˆè¿‘ä¼¼éšæœºæ•°æ€§è´¨çš„æ•°å­—åºåˆ—ã€‚ä½†ç”±äºå®ƒåŸºäºä¸€ä¸ªåˆå§‹å€¼ç§°ä¸ºç§å­ï¼Œä½ å¯ä»¥æ§åˆ¶å®ƒçš„éšæœºæ€§ã€‚ä½¿ç”¨ç›¸åŒçš„ç§å­ï¼ŒpRNG ä¼šç”Ÿæˆç›¸åŒçš„æ•°å­—åºåˆ—ï¼Œä½¿ä½ çš„æ•°æ®ç”Ÿæˆè¿‡ç¨‹å¯å¤ç°ã€‚

#### ä½¿ç”¨ pRNG çš„å¥½å¤„ï¼š

- ä¸€è‡´æ€§ï¼šä¿è¯æµ‹è¯•æ¯æ¬¡éƒ½ä½¿ç”¨ç›¸åŒçš„æ•°æ®ã€‚
- è°ƒè¯•ï¼šé€šè¿‡æä¾›ä¸€è‡´çš„æ•°æ®é›†ï¼Œä½¿å¾—å¤ç°å’Œä¿®å¤é”™è¯¯æ›´å®¹æ˜“ã€‚
- åä½œï¼šå›¢é˜Ÿæˆå‘˜å¯å…±äº«ç§å­ç¼–å·ï¼Œä»¥ä¾¿ä½¿ç”¨ç›¸åŒçš„æ•°æ®é›†ã€‚

ä½¿ç”¨ drizzle-seedï¼Œä½ å¯ä»¥å…¼å¾—ç”Ÿæˆé€¼çœŸå‡æ•°æ®çš„èƒ½åŠ›å’Œéšæ—¶å¤ç°è¿™äº›æ•°æ®çš„æ§åˆ¶æƒã€‚

## å®‰è£…

<Npm>drizzle-seed</Npm>

## åŸºæœ¬ç”¨æ³•

è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»º 10 ä¸ªå…·æœ‰éšæœºåç§°å’Œ ID çš„ç”¨æˆ·

```ts {12}
import { pgTable, integer, text } from "drizzle-orm/pg-core";
import { drizzle } from "drizzle-orm/node-postgres";
import { seed } from "drizzle-seed";

const users = pgTable("users", {
  id: integer().primaryKey(),
  name: text().notNull(),
});

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);
  await seed(db, { users });
}

main();
```

## é…ç½®é€‰é¡¹

**`count`**

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`seed` å‡½æ•°ä¼šåˆ›å»º 10 ä¸ªå®ä½“ã€‚å¦‚æœæµ‹è¯•éœ€è¦æ›´å¤šæ•°æ®ï¼Œå¯ä»¥åœ¨ seed çš„é€‰é¡¹å¯¹è±¡ä¸­æŒ‡å®š

```ts
await seed(db, schema, { count: 1000 });
```

**`seed`**

å¦‚æœä½ æƒ³é’ˆå¯¹åç»­è¿è¡Œç”Ÿæˆä¸åŒçš„æ•°æ®é›†ï¼Œå¯ä»¥åœ¨ `seed` é€‰é¡¹ä¸­å®šä¹‰ä¸€ä¸ªä¸åŒçš„æ•°å­—ã€‚ä¸åŒçš„æ•°å­—å°†ç”Ÿæˆå”¯ä¸€çš„æ•°æ®é›†

```ts
await seed(db, schema, { seed: 12345 });
```

## é‡ç½®æ•°æ®åº“

ä½¿ç”¨ `drizzle-seed` å¯ä»¥è½»æ¾é‡ç½®æ•°æ®åº“å¹¶ç”¨æ–°å€¼å¡«å……ï¼Œä¾‹å¦‚åœ¨æµ‹è¯•å¥—ä»¶ä¸­

```ts
// æŒ‡å‘ä½ æƒ³é‡ç½®çš„ schema æ–‡ä»¶çš„è·¯å¾„
import * as schema from "./schema.ts";
import { reset } from "drizzle-seed";

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);
  await reset(db, schema);
}

main();
```

ä¸åŒæ•°æ®åº“æ–¹è¨€æœ‰ä¸åŒçš„é‡ç½®ç­–ç•¥

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'CockroachDB', 'MS SQL']}>
<Tab>
é’ˆå¯¹ PostgreSQLï¼Œ`drizzle-seed` åŒ…ä¼šç”Ÿæˆå¸¦æœ‰ `CASCADE` é€‰é¡¹çš„ `TRUNCATE` è¯­å¥ï¼Œ
ç¡®ä¿è¿è¡Œ reset å‡½æ•°åæ‰€æœ‰è¡¨éƒ½ä¸ºç©º

```sql
TRUNCATE tableName1, tableName2, ... CASCADE;
```

</Tab>
<Tab>
é’ˆå¯¹ MySQLï¼Œ`drizzle-seed` åŒ…ä¼šå…ˆç¦ç”¨ `FOREIGN_KEY_CHECKS` ä»¥é˜²æ­¢åç»­æ­¥éª¤å¤±è´¥ï¼Œç„¶åç”Ÿæˆ `TRUNCATE` è¯­å¥æ¥æ¸…ç©ºæ‰€æœ‰è¡¨çš„å†…å®¹

```sql
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE tableName1;
TRUNCATE tableName2;
...
SET FOREIGN_KEY_CHECKS = 1;
```

</Tab>
<Tab>
é’ˆå¯¹ SQLiteï¼Œ`drizzle-seed` åŒ…ä¼šå…ˆç¦ç”¨ `foreign_keys` pragma ä»¥é˜²æ­¢åç»­æ­¥éª¤å¤±è´¥ï¼Œç„¶åç”Ÿæˆ `DELETE FROM` è¯­å¥æ¸…ç©ºæ‰€æœ‰è¡¨çš„å†…å®¹

```sql
PRAGMA foreign_keys = OFF;
DELETE FROM tableName1;
DELETE FROM tableName2;
...
PRAGMA foreign_keys = ON;
```

</Tab>
<Tab>
For SingleStore, the `drizzle-seed` package will first disable `FOREIGN_KEY_CHECKS` to ensure the next step won't fail, and then 
generate `TRUNCATE` statements to empty the content of all tables

```sql
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE tableName1;
TRUNCATE tableName2;
...
SET FOREIGN_KEY_CHECKS = 1;
```

</Tab>
<Tab>
For CockroachDB, the `drizzle-seed` package will generate `TRUNCATE` statements with the `CASCADE` option to 
ensure that all tables are empty after running the reset function

```sql
TRUNCATE tableName1, tableName2, ... CASCADE;
```

</Tab>
<Tab>
For MS SQL, the `drizzle-seed` package first gathers information about all foreign key constraints that reference 
or are contained in the tables specified as the second argument(your schema) to the `reset` function.

It then iterates over those tables, drops all foreign key constraints related to each table, and truncates each table.

Finally, the package recreates the original foreign key constraints for each table.

```sql
-- gather information about all fk constraints

-- drops all fk constraints related to each table
ALTER TABLE [<schemaName>].[<tableName>] DROP CONSTRAINT [<fkName>];

-- truncates each table
TRUNCATE TABLE [<schemaName>].[<tableName>];

-- recreates the original fk constraints
ALTER TABLE [<schemaName>].[<tableName>] 
ADD CONSTRAINT [<fkName>] 
FOREIGN KEY([<columnName>])
REFERENCES [<refSchemaName>].[<refTableName>] ([<refColumnName>])
ON DELETE <onDeleteAction>
ON UPDATE <onUpdateAction>;
```

</Tab>
</Tabs>

## ç²¾ç»†åŒ–å®šåˆ¶

å¦‚æœä½ éœ€è¦æ›´æ”¹ `drizzle-seed` é»˜è®¤ä½¿ç”¨çš„ç§å­ç”Ÿæˆå‡½æ•°çš„è¡Œä¸ºï¼Œå¯ä»¥æŒ‡å®šä½ è‡ªå·±çš„å®ç°ï¼Œç”šè‡³è‡ªå·±å®šä¹‰å€¼åˆ—è¡¨ç”¨äºç§å­è¿‡ç¨‹ã€‚

`.refine` æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä¼šæ¥æ”¶æ‰€æœ‰ `drizzle-seed` ä¸­å¯ç”¨ç”Ÿæˆå™¨å‡½æ•°çš„åˆ—è¡¨ã€‚å®ƒéœ€è¦è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œé”®æ˜¯ä½ æƒ³è¦ç²¾ç»†åŒ–å®šåˆ¶çš„è¡¨åï¼Œå€¼å®šä¹‰è¿™äº›è¡¨çš„è¡Œä¸ºã€‚
æ¯ä¸ªè¡¨å¯ä»¥æŒ‡å®šå¤šä¸ªå±æ€§æ¥ç®€åŒ–æ•°æ®åº“çš„ç§å­è¿‡ç¨‹ï¼š

<rem025 />

- `columns`ï¼šé€šè¿‡æŒ‡å®šæ‰€éœ€çš„ç”Ÿæˆå™¨å‡½æ•°ï¼Œç²¾ç»†åŒ–è°ƒæ•´æ¯åˆ—çš„é»˜è®¤è¡Œä¸ºã€‚
- `count`ï¼šæŒ‡å®šæ’å…¥æ•°æ®åº“çš„è¡Œæ•°ã€‚é»˜è®¤æ˜¯ 10ã€‚å¦‚æœä½ åœ¨ `seed()` å‡½æ•°é€‰é¡¹é‡Œå®šä¹‰äº†å…¨å±€çš„ countï¼Œè¿™é‡ŒæŒ‡å®šçš„ count ä¼šè¦†ç›–è¯¥è¡¨çš„å…¨å±€ countã€‚
- `with`ï¼šå¦‚æœä½ æƒ³ç”Ÿæˆå…³è”å®ä½“ï¼Œå®šä¹‰ä¸ºæ¯ä¸ªçˆ¶è¡¨åˆ›å»ºå¤šå°‘ä¸ªè¢«å¼•ç”¨å®ä½“ã€‚

<Callout title='info'>
ä½ è¿˜å¯ä»¥ä¸ºè¦åˆ›å»ºçš„è¢«å¼•ç”¨å€¼æ•°é‡æŒ‡å®šåŠ æƒéšæœºåˆ†å¸ƒã€‚å…³äºè¯¥ API çš„ç»†èŠ‚å¯ä»¥å‚è€ƒ [åŠ æƒéšæœºï¼ˆWeighted Randomï¼‰æ–‡æ¡£](#weighted-random) éƒ¨åˆ†ã€‚
</Callout>

**API**
```ts
await seed(db, schema).refine((f) => ({
  users: {
    columns: {},
    count: 10,
    with: {
        posts: 10
    }
  },
}));
```

ä¸‹é¢æ˜¯ä¸€äº›å¸¦è§£é‡Šçš„ç¤ºä¾‹ï¼š

```ts filename='schema.ts'
import { pgTable, integer, text } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: integer().primaryKey(),
  name: text().notNull(),
});

export const posts = pgTable("posts", {
  id: integer().primaryKey(),
  description: text(),
  userId: integer().references(() => users.id),
});
```

**ç¤ºä¾‹1**ï¼šåªå¯¹ `users` è¡¨è¿›è¡Œç§å­ï¼Œç”Ÿæˆ 20 ä¸ªå®ä½“ï¼Œå¹¶å¯¹ `name` åˆ—åº”ç”¨ç²¾ç»†åŒ–çš„ç§å­é€»è¾‘
```ts filename='index.ts'
import { drizzle } from "drizzle-orm/node-postgres";
import { seed } from "drizzle-seed";
import * as schema from './schema.ts'

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, { users: schema.users }).refine((f) => ({
    users: {
        columns: {
            name: f.fullName(),
        },
        count: 20
    }
  }));
}

main();
```

**ç¤ºä¾‹2**ï¼šå¯¹ `users` è¡¨æ’å…¥ 20 ä¸ªå®ä½“ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆ 10 ä¸ª `posts`ï¼Œé€šè¿‡ç»™ `posts` è¡¨ç§å­å¹¶å»ºç«‹å…¶åˆ° `users` è¡¨çš„å¼•ç”¨å®ç°å…³è”
```ts filename='index.ts'
import { drizzle } from "drizzle-orm/node-postgres";
import { seed } from "drizzle-seed";
import * as schema from './schema.ts'

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, schema).refine((f) => ({
    users: {
        count: 20,
        with: {
            posts: 10
        }
    }
  }));
}

main();
```

**ç¤ºä¾‹3**ï¼šå¯¹ `users` è¡¨ç§å­ 5 ä¸ªå®ä½“ï¼Œä¸”å‘æ•°æ®åº“æ’å…¥ 100 ä¸ª `posts`ï¼Œä½†ä¸ä¸ `users` å®ä½“å…³è”ã€‚é’ˆå¯¹ `users` çš„ `id` ç²¾ç»†åŒ–ä¸ºç»™å‡º `10000` åˆ° `20000` ä¹‹é—´ä¸”å”¯ä¸€çš„æ•´æ•°ï¼Œå¯¹ `posts` çš„ `description` ç²¾ç»†åŒ–ä¸ºä»è‡ªå®šä¹‰æ•°ç»„é‡Œè·å–å€¼
```ts filename='index.ts'
import { drizzle } from "drizzle-orm/node-postgres";
import { seed } from "drizzle-seed";
import * as schema from './schema.ts'

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, schema).refine((f) => ({
    users: {
        count: 5,
        columns: {
            id: f.int({
              minValue: 10000,
              maxValue: 20000,
              isUnique: true,
            }),
        }
    },
    posts: {
        count: 100,
        columns: {
            description: f.valuesFromArray({
            values: [
                "å¤ªé˜³è½å±±ï¼Œå±±åæŸ“ä¸Šæ©™ç´«è‰²çš„å¤©ç©º", 
                "æˆ‘çœŸä¸æ•¢ç›¸ä¿¡è¿™è‡ªåˆ¶æŠ«è¨åšå¾—è¿™ä¹ˆå¥½ï¼", 
                "æœ‰æ—¶å€™ï¼Œä½ åªéœ€è¦ä¸€æœ¬å¥½ä¹¦å’Œä¸€ä¸ªå®‰é™çš„è§’è½ã€‚", 
                "è°è®¤ä¸ºé›¨å¤©æ˜¯åˆ·è€ç”µå½±çš„ç»ä½³æ—¥å­ï¼Ÿ", 
                "ä»Šå¤©è¯•äº†æ¡æ–°å¾’æ­¥è·¯çº¿ï¼Œå‘ç°äº†æœ€æ£’çš„ç€‘å¸ƒï¼",
                // ...
            ],
          })
        }
    }
  }));
}

main();
```

<Callout type='warning'>
æ­¤æ–‡æ¡£ä¸­å°†å®šä¹‰æ›´å¤šå¯èƒ½æ€§ï¼Œç›®å‰ä½ å¯ä»¥å…ˆæµè§ˆè¿™äº›éƒ¨åˆ†ã€‚æŸ¥çœ‹ [ç”Ÿæˆå™¨ï¼ˆGeneratorsï¼‰](/docs/seed-functions) éƒ¨åˆ†ï¼Œç†Ÿæ‚‰æ‰€æœ‰å¯ç”¨çš„ç”Ÿæˆå™¨å‡½æ•°ã€‚

ä¸€ä¸ªç‰¹åˆ«æ£’çš„åŠŸèƒ½æ˜¯å¯ä»¥ä½¿ç”¨åŠ æƒéšæœºï¼Œæ— è®ºæ˜¯é’ˆå¯¹åˆ—ç”Ÿæˆçš„å€¼ï¼Œè¿˜æ˜¯ `drizzle-seed` ç”Ÿæˆç›¸å…³å®ä½“æ•°é‡æ—¶ã€‚

è¯·å‚è€ƒ [åŠ æƒéšæœºï¼ˆWeighted Randomï¼‰æ–‡æ¡£](#weighted-random) è·å–æ›´å¤šä¿¡æ¯ã€‚
</Callout>


## åŠ æƒéšæœºï¼ˆWeighted Randomï¼‰

æœ‰æ—¶ä½ å¯èƒ½éœ€è¦ä½¿ç”¨å¤šä¸ªæ•°æ®é›†ä»¥ä¸åŒä¼˜å…ˆçº§åœ¨ç§å­é˜¶æ®µæ’å…¥æ•°æ®åº“ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œdrizzle-seed æä¾›äº†ä¸€ä¸ªç§°ä½œåŠ æƒéšæœºçš„ APIã€‚

Drizzle Seed åŒ…åœ¨ä»¥ä¸‹åœºæ™¯æ”¯æŒåŠ æƒéšæœºï¼š

- æ¯ä¸ªè¡¨çš„åˆ—ç»†åŒ–ä¸­
- `with` å±æ€§ä¸­ï¼Œç”¨äºç¡®å®šè¦åˆ›å»ºçš„ç›¸å…³å®ä½“æ•°é‡

ä¸‹é¢ç»™å‡ºä¸¤ä¸ªç¤ºä¾‹ï¼š

```ts filename="schema.ts"
import { pgTable, integer, text, varchar, doublePrecision } from "drizzle-orm/pg-core";

export const orders = pgTable(
  "orders",
  {
    id: integer().primaryKey(),
    name: text().notNull(),
    quantityPerUnit: varchar().notNull(),
    unitPrice: doublePrecision().notNull(),
    unitsInStock: integer().notNull(),
    unitsOnOrder: integer().notNull(),
    reorderLevel: integer().notNull(),
    discontinued: integer().notNull(),
  }
);

export const details = pgTable(
  "details",
  {
    unitPrice: doublePrecision().notNull(),
    quantity: integer().notNull(),
    discount: doublePrecision().notNull(),

    orderId: integer()
      .notNull()
      .references(() => orders.id, { onDelete: "cascade" }),
  }
);
```

**ç¤ºä¾‹1**ï¼šç²¾ç»†åŒ– `unitPrice` çš„ç”Ÿæˆé€»è¾‘ï¼Œç”Ÿæˆ 5000 æ¡éšæœºä»·æ ¼æ•°æ®ï¼Œå…¶ä¸­ 30% æ˜¯ 10-100 ä¹‹é—´çš„ä»·æ ¼ï¼Œ70% æ˜¯ 100-300 ä¹‹é—´çš„ä»·æ ¼

```ts filename="index.ts"
import { drizzle } from "drizzle-orm/node-postgres";
import { seed } from "drizzle-seed";
import * as schema from './schema.ts'

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, schema).refine((f) => ({
    orders: {
       count: 5000,
       columns: {
           unitPrice: f.weightedRandom(
               [
                   {
                       weight: 0.3,
                       value: funcs.int({ minValue: 10, maxValue: 100 })
                   },
                   {
                       weight: 0.7,
                       value: funcs.number({ minValue: 100, maxValue: 300, precision: 100 })
                   }
               ]
           ),
       }
    }
  }));
}

main();
```

**ç¤ºä¾‹2**ï¼šä¸ºæ¯ä¸ªè®¢å•ç”Ÿæˆ 1 åˆ° 3 æ¡è¯¦æƒ…çš„æ¦‚ç‡ä¸º 60%ï¼Œç”Ÿæˆ 5 åˆ° 7 æ¡è¯¦æƒ…æ¦‚ç‡ä¸º 30%ï¼Œç”Ÿæˆ 8 åˆ° 10 æ¡è¯¦æƒ…æ¦‚ç‡ä¸º 10%

```ts filename="index.ts"
import { drizzle } from "drizzle-orm/node-postgres";
import { seed } from "drizzle-seed";
import * as schema from './schema.ts'

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, schema).refine((f) => ({
    orders: {
       with: {
           details:
               [
                   { weight: 0.6, count: [1, 2, 3] },
                   { weight: 0.3, count: [5, 6, 7] },
                   { weight: 0.1, count: [8, 9, 10] },
               ]
       }
    }
  }));
}

main();
```

## å¤æ‚ç¤ºä¾‹

<CodeTabs items={["main.ts", "schema.ts"]}>
<Section>
```ts
import { seed } from "drizzle-seed";
import * as schema from "./schema.ts";

const main = async () => {
    const titlesOfCourtesy = ["Ms.", "Mrs.", "Dr."];
    const unitsOnOrders = [0, 10, 20, 30, 50, 60, 70, 80, 100];
    const reorderLevels = [0, 5, 10, 15, 20, 25, 30];
    const quantityPerUnit = [
        "100 - 100 g pieces",
        "100 - 250 g bags",
        "10 - 200 g glasses",
        "10 - 4 oz boxes",
        "10 - 500 g pkgs.",
        "10 - 500 g pkgs."
    ];
    const discounts = [0.05, 0.15, 0.2, 0.25];

    await seed(db, schema).refine((funcs) => ({
        customers: {
            count: 10000,
            columns: {
                companyName: funcs.companyName(),
                contactName: funcs.fullName(),
                contactTitle: funcs.jobTitle(),
                address: funcs.streetAddress(),
                city: funcs.city(),
                postalCode: funcs.postcode(),
                region: funcs.state(),
                country: funcs.country(),
                phone: funcs.phoneNumber({ template: "(###) ###-####" }),
                fax: funcs.phoneNumber({ template: "(###) ###-####" })
            }
        },
        employees: {
            count: 200,
            columns: {
                firstName: funcs.firstName(),
                lastName: funcs.lastName(),
                title: funcs.jobTitle(),
                titleOfCourtesy: funcs.valuesFromArray({ values: titlesOfCourtesy }),
                birthDate: funcs.date({ minDate: "2010-12-31", maxDate: "2010-12-31" }),
                hireDate: funcs.date({ minDate: "2010-12-31", maxDate: "2024-08-26" }),
                address: funcs.streetAddress(),
                city: funcs.city(),
                postalCode: funcs.postcode(),
                country: funcs.country(),
                homePhone: funcs.phoneNumber({ template: "(###) ###-####" }),
                extension: funcs.int({ minValue: 428, maxValue: 5467 }),
                notes: funcs.loremIpsum()
            }
        },
        orders: {
            count: 50000,
            columns: {
                shipVia: funcs.int({ minValue: 1, maxValue: 3 }),
                freight: funcs.number({ minValue: 0, maxValue: 1000, precision: 100 }),
                shipName: funcs.streetAddress(),
                shipCity: funcs.city(),
                shipRegion: funcs.state(),
                shipPostalCode: funcs.postcode(),
                shipCountry: funcs.country()
            },
            with: {
                details:
                    [
                        { weight: 0.6, count: [1, 2, 3, 4] },
                        { weight: 0.2, count: [5, 6, 7, 8, 9, 10] },
                        { weight: 0.15, count: [11, 12, 13, 14, 15, 16, 17] },
                        { weight: 0.05, count: [18, 19, 20, 21, 22, 23, 24, 25] },
                    ]
            }
        },
        suppliers: {
            count: 1000,
            columns: {
                companyName: funcs.companyName(),
                contactName: funcs.fullName(),
                contactTitle: funcs.jobTitle(),
                address: funcs.streetAddress(),
                city: funcs.city(),
                postalCode: funcs.postcode(),
                region: funcs.state(),
                country: funcs.country(),
                phone: funcs.phoneNumber({ template: "(###) ###-####" })
            }
        },
        products: {
            count: 5000,
            columns: {
                name: funcs.companyName(),
                quantityPerUnit: funcs.valuesFromArray({ values: quantityPerUnit }),
                unitPrice: funcs.weightedRandom(
                    [
                        {
                            weight: 0.5,
                            value: funcs.int({ minValue: 3, maxValue: 300 })
                        },
                        {
                            weight: 0.5,
                            value: funcs.number({ minValue: 3, maxValue: 300, precision: 100 })
                        }
                    ]
                ),
                unitsInStock: funcs.int({ minValue: 0, maxValue: 125 }),
                unitsOnOrder: funcs.valuesFromArray({ values: unitsOnOrders }),
                reorderLevel: funcs.valuesFromArray({ values: reorderLevels }),
                discontinued: funcs.int({ minValue: 0, maxValue: 1 })
            }
        },
        details: {
            columns: {
                unitPrice: funcs.number({ minValue: 10, maxValue: 130 }),
                quantity: funcs.int({ minValue: 1, maxValue: 130 }),
                discount: funcs.weightedRandom(
                    [
                        { weight: 0.5, value: funcs.valuesFromArray({ values: discounts }) },
                        { weight: 0.5, value: funcs.default({ defaultValue: 0 }) }
                    ]
                )
            }
        }
    }));
}

main();

```
</Section>
<Section>
```ts
import type { AnyPgColumn } from "drizzle-orm/pg-core";
import { integer, numeric, pgTable, text, timestamp, varchar } from "drizzle-orm/pg-core";

export const customers = pgTable('customer', {
	id: varchar({ length: 256 }).primaryKey(),
	companyName: text().notNull(),
	contactName: text().notNull(),
	contactTitle: text().notNull(),
	address: text().notNull(),
	city: text().notNull(),
	postalCode: text(),
	region: text(),
	country: text().notNull(),
	phone: text().notNull(),
	fax: text(),
});

export const employees = pgTable(
	'employee',
	{
		id: integer().primaryKey(),
		lastName: text().notNull(),
		firstName: text(),
		title: text().notNull(),
		titleOfCourtesy: text().notNull(),
		birthDate: timestamp().notNull(),
		hireDate: timestamp().notNull(),
		address: text().notNull(),
		city: text().notNull(),
		postalCode: text().notNull(),
		country: text().notNull(),
		homePhone: text().notNull(),
		extension: integer().notNull(),
		notes: text().notNull(),
		reportsTo: integer().references((): AnyPgColumn => employees.id),
		photoPath: text(),
	},
);

export const orders = pgTable('order', {
	id: integer().primaryKey(),
	orderDate: timestamp().notNull(),
	requiredDate: timestamp().notNull(),
	shippedDate: timestamp(),
	shipVia: integer().notNull(),
	freight: numeric().notNull(),
	shipName: text().notNull(),
	shipCity: text().notNull(),
	shipRegion: text(),
	shipPostalCode: text(),
	shipCountry: text().notNull(),

	customerId: text().notNull().references(() => customers.id, { onDelete: 'cascade' }),

	employeeId: integer().notNull().references(() => employees.id, { onDelete: 'cascade' }),
});

export const suppliers = pgTable('supplier', {
	id: integer().primaryKey(),
	companyName: text().notNull(),
	contactName: text().notNull(),
	contactTitle: text().notNull(),
	address: text().notNull(),
	city: text().notNull(),
	region: text(),
	postalCode: text().notNull(),
	country: text().notNull(),
	phone: text().notNull(),
});

export const products = pgTable('product', {
	id: integer().primaryKey(),
	name: text().notNull(),
	quantityPerUnit: text().notNull(),
	unitPrice: numeric().notNull(),
	unitsInStock: integer().notNull(),
	unitsOnOrder: integer().notNull(),
	reorderLevel: integer().notNull(),
	discontinued: integer().notNull(),

	supplierId: integer().notNull().references(() => suppliers.id, { onDelete: 'cascade' }),
});

export const details = pgTable('order_detail', {
	unitPrice: numeric().notNull(),
	quantity: integer().notNull(),
	discount: numeric().notNull(),

	orderId: integer().notNull().references(() => orders.id, { onDelete: 'cascade' }),

	productId: integer().notNull().references(() => products.id, { onDelete: 'cascade' }),
});

```
</Section>
</CodeTabs>

## é™åˆ¶

#### `with` çš„ç±»å‹é™åˆ¶

ç”±äº TypeScript çš„æŸäº›é™åˆ¶ä»¥åŠ Drizzle å½“å‰çš„ APIï¼Œæ— æ³•æ­£ç¡®æ¨æ–­è¡¨ä¹‹é—´çš„å¼•ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨è¡¨ä¹‹é—´å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ã€‚

è¿™æ„å‘³ç€ `with` é€‰é¡¹ä¼šæ˜¾ç¤º schema ä¸­çš„æ‰€æœ‰è¡¨ï¼Œä½ éœ€è¦æ‰‹åŠ¨é€‰æ‹©å…·æœ‰ä¸€å¯¹å¤šå…³ç³»çš„è¡¨ã€‚

<Callout title='warning'>
`with` é€‰é¡¹ä»…é’ˆå¯¹ä¸€å¯¹å¤šå…³ç³»æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä¸€ä¸ª `user` å…¶å¯¹åº”å¤šä¸ª `posts`ï¼Œå¯ä»¥ç”¨ `users with posts`ï¼Œä½†ä¸èƒ½ç”¨ `posts with users`
</Callout>

#### Drizzle è¡¨ç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹é™åˆ¶ï¼š

ç›®å‰ï¼Œæˆ‘ä»¬æ²¡æœ‰é’ˆå¯¹ Drizzle è¡¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹æ”¯æŒã€‚è™½ç„¶è¿è¡Œæ—¶èƒ½å·¥ä½œï¼Œä½†ç±»å‹å±‚é¢ä¸èƒ½æ­£ç¡®è¯†åˆ«ã€‚


Source: https://drizzle.zhcndoc.com/docs/seed-versioning

import Tab from "@mdx/Tab.astro";
import Tabs from "@mdx/Tabs.astro";
import Callout from "@mdx/Callout.astro";
import TableWrapper from "@mdx/TableWrapper.astro";

# ç‰ˆæœ¬æ§åˆ¶

`drizzle-seed` ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶æ¥ç®¡ç†é™æ€å’ŒåŠ¨æ€æ•°æ®çš„è¾“å‡ºã€‚ä¸ºç¡®ä¿çœŸæ­£çš„ç¡®å®šæ€§ï¼Œè¯·ç¡®ä¿åœ¨ä½¿ç”¨ç›¸åŒçš„ `seed` ç¼–å·æ—¶å€¼ä¿æŒä¸å˜ã€‚å¦‚æœå¯¹é™æ€æ•°æ®æºæˆ–åŠ¨æ€æ•°æ®ç”Ÿæˆé€»è¾‘è¿›è¡Œæ›´æ”¹ï¼Œç‰ˆæœ¬å°†ä¼šæ›´æ–°ï¼Œè¿™æ ·æ‚¨å¯ä»¥é€‰æ‹©åšæŒä½¿ç”¨ä»¥å‰çš„ç‰ˆæœ¬æˆ–ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚

æ‚¨å¯ä»¥å‡çº§åˆ°æœ€æ–°çš„ `drizzle-seed` ç‰ˆæœ¬ä»¥è·å¾—æ–°åŠŸèƒ½ï¼Œä¾‹å¦‚é¢å¤–çš„ç”Ÿæˆå™¨ï¼ŒåŒæ—¶åœ¨éœ€è¦æ—¶ä¿æŒç¡®å®šæ€§è¾“å‡ºçš„æ—§ç‰ˆæœ¬ã€‚è¿™åœ¨æ‚¨éœ€è¦ä¾èµ–ç°æœ‰ç¡®å®šæ€§æ•°æ®åŒæ—¶è®¿é—®æ–°åŠŸèƒ½æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚

```ts
await seed(db, schema, { version: '2' });
```

## å†å²
<TableWrapper>
|          API ç‰ˆæœ¬  |   npm ç‰ˆæœ¬    |     æ›´æ”¹çš„ç”Ÿæˆå™¨                             |
|  :-------------- | :-------------- | :-------------                         |
|       `v1`            | `0.1.1`          |                                         |
|       `v2 (LTS) `       | `0.2.1`          |`string()`, `interval({ isUnique: true })` |
</TableWrapper>

<Callout collapsed="åº•å±‚å·¥ä½œåŸç†ï¼Ÿ">
> è¿™ä¸æ˜¯å®é™…çš„ API æ›´æ”¹ï¼›è¿™åªæ˜¯æˆ‘ä»¬å¦‚ä½•è¿›è¡Œ `drizzle-seed` ç‰ˆæœ¬æ§åˆ¶çš„ä¸€ä¸ªç¤ºä¾‹ã€‚

ä¾‹å¦‚ï¼Œ`lastName` ç”Ÿæˆå™¨å‘ç”Ÿäº†å˜åŒ–ï¼Œæ–°çš„ç‰ˆæœ¬ `V2` çš„æ­¤ç”Ÿæˆå™¨å¯ç”¨ã€‚

åæ¥ï¼Œ`firstName` ç”Ÿæˆå™¨å‘ç”Ÿäº†æ”¹å˜ï¼Œç”Ÿæˆäº†æ­¤ç”Ÿæˆå™¨çš„ `V3` ç‰ˆæœ¬ã€‚

|                  |       `V1`       |      `V2`       |   `V3(æœ€æ–°)`   |
| :--------------: | :--------------: | :-------------: | :--------------: |
| **LastNameGen**  | `LastNameGenV1`  | `LastNameGenV2` |                  |
| **FirstNameGen** | `FirstNameGenV1` |                 | `FirstNameGenV3` |


##### ä½¿ç”¨ç‰ˆæœ¬ 3 çš„ `firstName` ç”Ÿæˆå™¨å’Œç‰ˆæœ¬ 2 çš„ `lastName` ç”Ÿæˆå™¨
```ts
await seed(db, schema);
```

å¦‚æœæ‚¨å°šæœªå‡†å¤‡å¥½ç«‹å³ä½¿ç”¨æœ€æ–°çš„ç”Ÿæˆå™¨ç‰ˆæœ¬ï¼Œå¯ä»¥æŒ‡å®šæœ€å¤§ä½¿ç”¨ç‰ˆæœ¬

##### ä½¿ç”¨ç‰ˆæœ¬ 1 çš„ `firstName` ç”Ÿæˆå™¨å’Œç‰ˆæœ¬ 2 çš„ `lastName` ç”Ÿæˆå™¨
```ts
await seed(db, schema, { version: '2' });
```

##### ä½¿ç”¨ç‰ˆæœ¬ 1 çš„ `firstName` ç”Ÿæˆå™¨å’Œç‰ˆæœ¬ 1 çš„ `lastName` ç”Ÿæˆå™¨ã€‚
```ts
await seed(db, schema, { version: '1' });
```

</Callout>

## ç‰ˆæœ¬ 2
#### å”¯ä¸€çš„ `interval` ç”Ÿæˆå™¨å·²æ›´æ”¹

<Callout title='å‡çº§åŸå› '>
è¾ƒæ—§ç‰ˆæœ¬çš„ç”Ÿæˆå™¨å¯èƒ½ç”Ÿæˆç±»ä¼¼ `1 minute 60 seconds` å’Œ `2 minutes 0 seconds` çš„é—´éš”ï¼Œå°†å®ƒä»¬è§†ä¸ºä¸åŒçš„é—´éš”ã€‚
ç„¶è€Œï¼Œå½“å°† `1 minute 60 seconds` é—´éš”æ’å…¥åˆ° PostgreSQL æ•°æ®åº“æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è½¬æ¢ä¸º `2 minutes 0 seconds`ã€‚å› æ­¤ï¼Œåœ¨ä¹‹åå°è¯•å°† `2 minutes 0 seconds` é—´éš”æ’å…¥å”¯ä¸€åˆ—å°†ä¼šå¯¼è‡´é”™è¯¯ã€‚
</Callout>

å¦‚æœæ‚¨çš„è¡¨åŒ…å«ç±»å‹ä¸º `interval` çš„å”¯ä¸€åˆ—ï¼Œåˆ™ä¼šå—åˆ°å½±å“ï¼š
<Tabs items={['PostgreSQL']}>
<Tab>
```ts
import { drizzle } from "drizzle-orm/node-postgres";
import { pgTable, interval } from "drizzle-orm/pg-core";
import { seed } from "drizzle-seed";

const intervals = pgTable("intervals", {
    interval: interval().unique()
});

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, { intervals });
}

main();
```
</Tab>
</Tabs>

å¦‚æœæ‚¨åœ¨ç§å­è„šæœ¬ä¸­ä½¿ç”¨å”¯ä¸€çš„ `interval` ç”Ÿæˆå™¨ï¼Œå¦‚ä¸‹é¢çš„è„šæœ¬æ‰€ç¤ºï¼Œä¹Ÿä¼šå—åˆ°å½±å“ï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
```ts
import { drizzle } from "drizzle-orm/node-postgres";
import { pgTable, interval, char, varchar, text } from "drizzle-orm/pg-core";
import { seed } from "drizzle-seed";

const intervals = pgTable("intervals", {
    interval: interval().unique(),
    interval1: interval(),
    interval2: char({ length: 256 }).unique(),
    interval3: char({ length: 256 }),
    interval4: varchar().unique(),
    interval5: varchar(),
    interval6: text().unique(),
    interval7: text(),
});

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, { intervals }).refine((f) => ({
    intervals: {
        columns: {
            interval: f.interval({ isUnique: true }),
            interval1: f.interval({ isUnique: true }),
            interval2: f.interval({ isUnique: true }),
            interval3: f.interval({ isUnique: true }),
            interval4: f.interval({ isUnique: true }),
            interval5: f.interval({ isUnique: true }),
            interval6: f.interval({ isUnique: true }),
            interval7: f.interval({ isUnique: true }),
        }
    }
  }));
}

main();
```
</Tab>
<Tab>
```ts
import { binary, char, mysqlTable, text, varbinary, varchar } from 'drizzle-orm/mysql-core';
import { drizzle } from 'drizzle-orm/mysql2';
import { seed } from "drizzle-seed";

const intervals = mysqlTable('intervals', {
	interval1: char({ length: 255 }).unique(),
	interval2: char({ length: 255 }),
	interval3: varchar({ length: 255 }).unique(),
	interval4: varchar({ length: 255 }),
	interval5: binary({ length: 255 }).unique(),
	interval6: binary({ length: 255 }),
	interval7: varbinary({ length: 255 }).unique(),
	interval8: varbinary({ length: 255 }),
	interval9: text(),
});

async function main() {
	const db = drizzle(process.env.DATABASE_URL!);

	await seed(db, { intervals }, { version: '2' }).refine((f) => ({
		intervals: {
			columns: {
				interval: f.interval({ isUnique: true }),
				interval1: f.interval({ isUnique: true }),
				interval2: f.interval({ isUnique: true }),
				interval3: f.interval({ isUnique: true }),
				interval4: f.interval({ isUnique: true }),
				interval5: f.interval({ isUnique: true }),
				interval6: f.interval({ isUnique: true }),
				interval7: f.interval({ isUnique: true }),
				interval8: f.interval({ isUnique: true }),
				interval9: f.interval({ isUnique: true }),
			},
		},
	}));
}

main();

```
</Tab>
<Tab>
```ts
import { blob, sqliteTable, text } from 'drizzle-orm/sqlite-core';
import { drizzle } from 'drizzle-orm/better-sqlite3';
import { seed } from 'drizzle-seed';

const intervals = sqliteTable('intervals', {
	interval1: text().unique(),
	interval2: text(),
	interval3: blob().unique(),
	interval4: blob(),
});

async function main() {
	const db = drizzle(process.env.DATABASE_URL!);

	await seed(db, { intervals }).refine((f) => ({
		intervals: {
			columns: {
				interval1: f.interval({ isUnique: true }),
				interval2: f.interval({ isUnique: true }),
				interval3: f.interval({ isUnique: true }),
				interval4: f.interval({ isUnique: true }),
			},
		},
	}));
}

main();

```
</Tab>
</Tabs>

#### `string` ç”Ÿæˆå™¨å·²æ›´æ”¹ï¼šåŒ…æ‹¬éå”¯ä¸€å’Œå”¯ä¸€çš„

<Callout title='å‡çº§åŸå› '>
èƒ½å¤Ÿæ ¹æ®æ–‡æœ¬åˆ—çš„é•¿åº¦ç”Ÿæˆå”¯ä¸€å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼Œ`varchar(20)`ï¼‰
</Callout>

å¦‚æœæ‚¨çš„è¡¨åŒ…å«å…·æœ‰æœ€å¤§é•¿åº¦å‚æ•°çš„æ–‡æœ¬ç±»å‹åˆ—æˆ–å”¯ä¸€æ–‡æœ¬ç±»å‹åˆ—ï¼Œåˆ™ä¼šå—åˆ°å½±å“ï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
```ts
import { drizzle } from "drizzle-orm/node-postgres";
import { pgTable, char, varchar, text } from "drizzle-orm/pg-core";
import { seed } from "drizzle-seed";

const strings = pgTable("strings", {
    string2: char({ length: 256 }).unique(),
    string3: char({ length: 256 }),
    string4: varchar().unique(),
    string5: varchar({ length: 256 }).unique(),
    string6: varchar({ length: 256 }),
    string7: text().unique(),
});

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, { strings });
}

main();
```
</Tab>
<Tab>
```ts
import { binary, char, mysqlTable, varbinary, varchar } from 'drizzle-orm/mysql-core';
import { drizzle } from 'drizzle-orm/mysql2';
import { seed } from "drizzle-seed";

const strings = mysqlTable('strings', {
	string1: char({ length: 255 }).unique(),
	string2: char({ length: 255 }),
	string3: varchar({ length: 255 }).unique(),
	string4: varchar({ length: 255 }),
	string5: binary({ length: 255 }).unique(),
	string6: binary({ length: 255 }),
	string7: varbinary({ length: 255 }).unique(),
	string8: varbinary({ length: 255 }),
});

async function main() {
	const db = drizzle(process.env.DATABASE_URL!);

	await seed(db, { strings });
}

main();

```
</Tab>
<Tab>
```ts
import { drizzle } from 'drizzle-orm/better-sqlite3';
import { blob, sqliteTable, text } from 'drizzle-orm/sqlite-core';
import { seed } from "drizzle-seed";

const strings = sqliteTable('strings', {
	string1: text().unique(),
	string2: text({ length: 256 }),
	string3: text({ length: 256 }).unique(),
	string4: blob().unique(),
});

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, { strings });
}

main();
```
</Tab>
</Tabs>

å¦‚æœæ‚¨åœ¨ç§å­è„šæœ¬ä¸­ä½¿ç”¨ `string` ç”Ÿæˆå™¨ï¼Œå¦‚ä¸‹é¢çš„è„šæœ¬æ‰€ç¤ºï¼Œä¹Ÿä¼šå—åˆ°å½±å“ï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
```ts
import { drizzle } from "drizzle-orm/node-postgres";
import { pgTable, char, varchar, text } from "drizzle-orm/pg-core";
import { seed } from "drizzle-seed";

const strings = pgTable("strings", {
    string1: char({ length: 256 }).unique(),
    string2: char({ length: 256 }),
    string3: char({ length: 256 }),
    string4: varchar(),
    string5: varchar().unique(),
    string6: varchar({ length: 256 }).unique(),
    string7: varchar({ length: 256 }),
    string8: varchar({ length: 256 }),
    string9: text().unique(),
    string10: text(),
});

async function main() {
  const db = drizzle(process.env.DATABASE_URL!);

  await seed(db, { strings }).refine((f) => ({
    strings: {
        columns: {
            string1: f.string({ isUnique: true }),
            string2: f.string(),
            string3: f.string({ isUnique: true }),
            string4: f.string({ isUnique: true }),
            string5: f.string({ isUnique: true }),
            string6: f.string({ isUnique: true }),
            string7: f.string(),
            string8: f.string({ isUnique: true }),
            string9: f.string({ isUnique: true }),
            string10: f.string({ isUnique: true }),
        }
    }
  }));
}

main();
```
</Tab>
<Tab>
```ts
import { binary, char, mysqlTable, text, varbinary, varchar } from 'drizzle-orm/mysql-core';
import { drizzle } from 'drizzle-orm/mysql2';
import { seed } from "drizzle-seed";

const strings = mysqlTable('strings', {
	string1: char({ length: 255 }).unique(),
	string2: char({ length: 255 }),
	string3: char({ length: 255 }),
	string4: varchar({ length: 255 }).unique(),
	string5: varchar({ length: 255 }),
	string6: varchar({ length: 255 }),
	string7: binary({ length: 255 }).unique(),
	string8: binary({ length: 255 }),
	string9: binary({ length: 255 }),
	string10: varbinary({ length: 255 }).unique(),
	string11: varbinary({ length: 255 }),
	string12: varbinary({ length: 255 }),
	string13: text(),
});

async function main() {
	const db = drizzle(process.env.DATABASE_URL!);

	await seed(db, { strings }).refine((f) => ({
		strings: {
			columns: {
				string1: f.string({ isUnique: true }),
				string2: f.string({ isUnique: true }),
				string3: f.string(),
				string4: f.string({ isUnique: true }),
				string5: f.string({ isUnique: true }),
				string6: f.string(),
				string7: f.string({ isUnique: true }),
				string8: f.string({ isUnique: true }),
				string9: f.string(),
				string10: f.string({ isUnique: true }),
				string11: f.string({ isUnique: true }),
				string12: f.string(),
				string13: f.string({ isUnique: true }),
			},
		},
	}));
}

main();
```
</Tab>
<Tab>
```ts
import { blob, sqliteTable, text } from 'drizzle-orm/sqlite-core';
import { drizzle } from 'drizzle-orm/better-sqlite3';
import { seed } from "drizzle-seed";

const strings = sqliteTable("strings", {
    string1: text().unique(),
	string2: text(),
	string3: text({ length: 256 }).unique(),
	string4: text({ length: 256 }),
	string5: text({ length: 256 }),
	string6: blob().unique(),
	string7: blob(),
});

async function main() {
	const db = drizzle(process.env.DATABASE_URL!);

	await seed(db, { strings }).refine((f) => ({
		strings: {
			columns: {
				string1: f.string({ isUnique: true }),
				string2: f.string({ isUnique: true }),
				string3: f.string({ isUnique: true }),
				string4: f.string({ isUnique: true }),
				string5: f.string(),
				string6: f.string({ isUnique: true }),
				string7: f.string({ isUnique: true }),
			},
		},
	}));
}

main();
```
</Tab>
</Tabs>

Source: https://drizzle.zhcndoc.com/docs/select

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import $count from '@mdx/$count.mdx';

# SQL é€‰æ‹©
Drizzle ä¸ºæ‚¨æä¾›äº†ä»æ•°æ®åº“ä¸­è·å–æ•°æ®çš„æœ€ SQL é£æ ¼çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¿æŒç±»å‹å®‰å…¨å’Œå¯ç»„åˆæ€§ã€‚
å®ƒåŸç”Ÿæ”¯æŒå‡ ä¹æ¯ç§æ–¹è¨€çš„æ‰€æœ‰æŸ¥è¯¢ç‰¹æ€§å’Œèƒ½åŠ›ï¼Œ
è€Œå…¶å°šä¸æ”¯æŒçš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å¼ºå¤§çš„ [`sql`](/docs/sql) æ“ä½œç¬¦ç”±ç”¨æˆ·æ·»åŠ ã€‚

å‡è®¾æ‚¨æœ‰ä¸€ä¸ªå¦‚ä¸‹é¢å®šä¹‰çš„ `users` è¡¨ï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'SingleStore', 'MSSQL', 'CockroachDB']}>
<Tab>
```typescript
import { pgTable, serial, text } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age'),
});
```
</Tab>
<Tab>
```typescript
import { mysqlTable, serial, text, int } from 'drizzle-orm/mysql-core';

export const users = mysqlTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: int('age'),
});
```
</Tab>
<Tab>
```typescript
import { sqliteTable, integer, text } from 'drizzle-orm/sqlite-core';

export const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age'),
});
```
</Tab>
<Tab>
```typescript
import { singlestoreTable, serial, text, int } from 'drizzle-orm/singlestore-core';

export const users = singlestoreTable('users', {
  id: int('id').primaryKey(),
  name: text('name').notNull(),
  age: int('age'),
});
```
</Tab>
<Tab>
```typescript
import { mssqlTable, int, text } from 'drizzle-orm/mssql-core';

export const users = pgTable('users', {
  id: int().primaryKey(),
  name: text().notNull(),
  age: int(),
});
```
</Tab>
<Tab>
```typescript
import { cockroachTable, int4, text } from 'drizzle-orm/cockroach-core';

export const users = pgTable('users', {
  id: int4().primaryKey(),
  name: text().notNull(),
  age: int4(),
});
```
</Tab>
</Tabs>

### åŸºæœ¬é€‰æ‹©
ä»ä¸€ä¸ªè¡¨ä¸­é€‰æ‹©æ‰€æœ‰è¡Œï¼ŒåŒ…æ‹¬æ‰€æœ‰åˆ—ï¼š

<Section>
```typescript
const result = await db.select().from(users);
/*
  {
    id: number;
    name: string;
    age: number | null;
  }[]
*/
```
```sql
select "id", "name", "age" from "users";
```
</Section>

æ³¨æ„ç»“æœç±»å‹æ˜¯æ ¹æ®è¡¨çš„å®šä¹‰è‡ªåŠ¨æ¨æ–­çš„ï¼ŒåŒ…æ‹¬åˆ—çš„å¯ç©ºæ€§ã€‚

<Callout type="info">
Drizzle å§‹ç»ˆåœ¨ `select` å­å¥ä¸­æ˜ç¡®åˆ—å‡ºåˆ—ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `select *`ã€‚<br />
è¿™æ˜¯å†…éƒ¨è¦æ±‚çš„ï¼Œä»¥ä¿è¯æŸ¥è¯¢ç»“æœä¸­çš„å­—æ®µé¡ºåºï¼Œä¹Ÿæ˜¯é€šå¸¸è®¤ä¸ºçš„è‰¯å¥½å®è·µã€‚
</Callout>

### éƒ¨åˆ†é€‰æ‹©
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½åªæƒ³é€‰æ‹©è¡¨ä¸­çš„ä¸€éƒ¨åˆ†åˆ—ã€‚
æ‚¨å¯ä»¥é€šè¿‡å‘ `.select()` æ–¹æ³•æä¾›é€‰æ‹©å¯¹è±¡æ¥å®ç°ï¼š
<Section>
```typescript copy
const result = await db.select({
  field1: users.id,
  field2: users.name,
}).from(users);

const { field1, field2 } = result[0];
```
```sql
select "id", "name" from "users";
```
</Section>

ä¸ SQL ä¸€æ ·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»æ„è¡¨è¾¾å¼ä½œä¸ºé€‰æ‹©å­—æ®µï¼Œè€Œä¸ä»…ä»…æ˜¯è¡¨åˆ—ï¼š

<Section>
```typescript
const result = await db.select({
  id: users.id,
  lowerName: sql<string>`lower(${users.name})`,
}).from(users);
```
```sql
select "id", lower("name") from "users";
```
</Section>

<Callout type="warning">
é€šè¿‡æŒ‡å®š `sql<string>`ï¼Œæ‚¨å‘Šè¯‰ Drizzle è¯¥å­—æ®µçš„ **é¢„æœŸ** ç±»å‹ä¸º `string`ã€‚<br />
å¦‚æœæ‚¨é”™è¯¯åœ°æŒ‡å®šï¼ˆä¾‹å¦‚ï¼Œå¯¹å°†ä½œä¸ºå­—ç¬¦ä¸²è¿”å›çš„å­—æ®µä½¿ç”¨ `sql<number>`ï¼‰ï¼Œè¿è¡Œæ—¶å€¼å°†ä¸é¢„æœŸç±»å‹ä¸åŒ¹é…ã€‚
Drizzle ä¸èƒ½æ ¹æ®æä¾›çš„ç±»å‹æ³›å‹æ‰§è¡Œä»»ä½•ç±»å‹è½¬æ¢ï¼Œå› ä¸ºè¯¥ä¿¡æ¯åœ¨è¿è¡Œæ—¶ä¸å¯ç”¨ã€‚

å¦‚æœæ‚¨éœ€è¦å¯¹è¿”å›å€¼åº”ç”¨è¿è¡Œæ—¶è½¬æ¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [`.mapWith()`](/docs/sql#sqlmapwith) æ–¹æ³•ã€‚
</Callout>

<Callout title='ä¿¡æ¯'>
ä» `v1.0.0-beta.1` å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `.as()` ä¸ºåˆ—å‘½åï¼š

```ts
const result = await db.select({
  id: users.id,
  lowerName: users.name.as("lower"),
}).from(users);
```
</Callout>

### æ¡ä»¶é€‰æ‹©
æ‚¨å¯ä»¥åŸºäºæŸä¸ªæ¡ä»¶æ‹¥æœ‰åŠ¨æ€é€‰æ‹©å¯¹è±¡ï¼š

```typescript
async function selectUsers(withName: boolean) {
  return db
    .select({
      id: users.id,
      ...(withName ? { name: users.name } : {}),
    })
    .from(users);
}

const users = await selectUsers(true);
```

### ä¸é‡å¤é€‰æ‹©

æ‚¨å¯ä»¥ä½¿ç”¨ `.selectDistinct()` ä»£æ›¿ `.select()` ä»¥ä»…ä»æ•°æ®é›†ä¸­æ£€ç´¢å”¯ä¸€è¡Œï¼š
<Section>
```ts
await db.selectDistinct().from(users).orderBy(users.id, users.name);

await db.selectDistinct({ id: users.id }).from(users).orderBy(users.id);
```
```sql
select distinct "id", "name" from "users" order by "id", "name";

select distinct "id" from "users" order by "id";
```
</Section>

åœ¨ PostgreSQL ä¸­ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `distinct on` å­å¥æŒ‡å®šå”¯ä¸€è¡Œçš„ç¡®å®šæ–¹å¼ï¼š
<Callout type='warning'>
`distinct on` å­å¥ä»…åœ¨ PostgreSQL ä¸­å—æ”¯æŒã€‚
</Callout>
<Section>
```ts
await db.selectDistinctOn([users.id]).from(users).orderBy(users.id);
await db.selectDistinctOn([users.name], { name: users.name }).from(users).orderBy(users.name);
```
```sql
select distinct on ("id") "id", "name" from "users" order by "id";
select distinct on ("name") "name" from "users" order by "name";
```
</Section>



### é«˜çº§é€‰æ‹©
å€ŸåŠ© TypeScriptï¼ŒDrizzle API è®©æ‚¨ä»¥å„ç§çµæ´»çš„æ–¹å¼æ„å»ºé€‰æ‹©æŸ¥è¯¢ã€‚

é«˜çº§éƒ¨åˆ†é€‰æ‹©çš„é¢„è§ˆï¼Œæ›´å¤šè¯¦ç»†çš„é«˜çº§ç”¨æ³•ç¤ºä¾‹è¯·å‚é˜…æˆ‘ä»¬[ä¸“é—¨çš„æŒ‡å—](/docs/guides/include-or-exclude-columns)ã€‚

<Callout type='warning'>
`getColumns` ä» `drizzle-orm@1.0.0-beta.2` å¼€å§‹å¯ç”¨ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è§ [è¿™é‡Œ](/docs/upgrade-v1)ï¼‰

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ—©äº 1.0 ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ `0.45.1`ï¼‰ï¼Œè¯·ä½¿ç”¨ `getTableColumns`
</Callout>

<br/>

<CodeTabs items={["ç¤ºä¾‹ 1", "ç¤ºä¾‹ 2", "ç¤ºä¾‹ 3", "ç¤ºä¾‹ 4"]}>
```ts
import { getColumns, sql } from 'drizzle-orm';

await db.select({
    ...getColumns(posts),
    titleLength: sql<number>`length(${posts.title})`,
  }).from(posts);
```
```ts
import { getColumns } from 'drizzle-orm';

const { content, ...rest } = getColumns(posts); // æ’é™¤ "content" åˆ—
await db.select({ ...rest }).from(posts); // é€‰æ‹©æ‰€æœ‰å…¶ä»–åˆ—
```
```ts
await db.query.posts.findMany({
  columns: {
    title: true,
  },
});
```
```ts
await db.query.posts.findMany({
  columns: {
    content: false,
  },
});
```
</CodeTabs>

## ---

### è¿‡æ»¤å™¨

æ‚¨å¯ä»¥ä½¿ç”¨ [è¿‡æ»¤æ“ä½œç¬¦](/docs/operators) åœ¨ `.where()` æ–¹æ³•ä¸­è¿‡æ»¤æŸ¥è¯¢ç»“æœï¼š

<Section>
```typescript copy
import { eq, lt, gte, ne } from 'drizzle-orm';

await db.select().from(users).where(eq(users.id, 42));
await db.select().from(users).where(lt(users.id, 42));
await db.select().from(users).where(gte(users.id, 42));
await db.select().from(users).where(ne(users.id, 42));
...
```
```sql
select "id", "name", "age" from "users" where "id" = 42;
select "id", "name", "age" from "users" where "id" < 42;
select "id", "name", "age" from "users" where "id" >= 42;
select "id", "name", "age" from "users" where "id" <> 42;
```
</Section>

æ‰€æœ‰è¿‡æ»¤æ“ä½œç¬¦éƒ½ä½¿ç”¨ [`sql`](/docs/sql) å‡½æ•°å®ç°ã€‚
æ‚¨å¯ä»¥è‡ªè¡Œä½¿ç”¨å®ƒç¼–å†™ä»»æ„ SQL è¿‡æ»¤å™¨ï¼Œæˆ–æ„å»ºè‡ªå·±çš„æ“ä½œç¬¦ã€‚
æœ‰å…³çµæ„Ÿï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ Drizzle æä¾›çš„æ“ä½œç¬¦æ˜¯å¦‚ä½•[å®ç°](https://github.com/drizzle-team/drizzle-orm/blob/main/drizzle-orm/src/sql/expressions/conditions.ts)çš„ã€‚
<Section>
```typescript copy
import { sql } from 'drizzle-orm';

function equals42(col: Column) {
  return sql`${col} = 42`;
}

await db.select().from(users).where(sql`${users.id} < 42`);
await db.select().from(users).where(sql`${users.id} = 42`);
await db.select().from(users).where(equals42(users.id));
await db.select().from(users).where(sql`${users.id} >= 42`);
await db.select().from(users).where(sql`${users.id} <> 42`);
await db.select().from(users).where(sql`lower(${users.name}) = 'aaron'`);
```
```sql
select "id", "name", "age" from "users" where 'id' < 42;
select "id", "name", "age" from "users" where 'id' = 42;
select "id", "name", "age" from "users" where 'id' = 42;
select "id", "name", "age" from "users" where 'id' >= 42;
select "id", "name", "age" from "users" where 'id' <> 42;
select "id", "name", "age" from "users" where lower("name") = 'aaron';
```
</Section>

<Callout type='info'>
æ‰€æœ‰æä¾›ç»™è¿‡æ»¤æ“ä½œç¬¦å’Œ `sql` å‡½æ•°çš„å€¼éƒ½ä¼šè‡ªåŠ¨å‚æ•°åŒ–ã€‚
ä¾‹å¦‚ï¼Œè¿™ä¸ªæŸ¥è¯¢ï¼š
```ts
await db.select().from(users).where(eq(users.id, 42));
```
å°†è¢«ç¿»è¯‘ä¸ºï¼š
```sql
select "id", "name", "age" from "users" where "id" = $1; -- params: [42]
```
</Callout>

ä½¿ç”¨ `not` æ“ä½œç¬¦åè½¬æ¡ä»¶ï¼š
<Section>
```typescript copy
import { eq, not, sql } from 'drizzle-orm';

await db.select().from(users).where(not(eq(users.id, 42)));
await db.select().from(users).where(sql`not ${users.id} = 42`);
```
```sql
select "id", "name", "age" from "users" where not ("id" = 42);
select "id", "name", "age" from "users" where not ("id" = 42);
```
</Section>

<Callout type="info">
æ‚¨å¯ä»¥å®‰å…¨åœ°æ›´æ”¹æ¨¡å¼ï¼Œé‡å‘½åè¡¨å’Œåˆ—
å¹¶ä¸”ç”±äºæ¨¡æ¿æ’å€¼ï¼Œå®ƒå°†åœ¨æ‚¨çš„æŸ¥è¯¢ä¸­è‡ªåŠ¨åæ˜ å‡ºæ¥ï¼Œ
è€Œä¸æ˜¯åœ¨ç¼–å†™åŸå§‹ SQL æ—¶ç¡¬ç¼–ç åˆ—æˆ–è¡¨åã€‚
</Callout>

### ç»„åˆè¿‡æ»¤å™¨
æ‚¨å¯ä»¥é€»è¾‘ä¸Šç»“åˆè¿‡æ»¤æ“ä½œç¬¦ä¸ `and()` å’Œ `or()` æ“ä½œç¬¦ï¼š
<Section>
```typescript copy
import { eq, and, sql } from 'drizzle-orm';

await db.select().from(users).where(
  and(
    eq(users.id, 42),
    eq(users.name, 'Dan')
  )
);
await db.select().from(users).where(sql`${users.id} = 42 and ${users.name} = 'Dan'`);
```
```sql
select "id", "name", "age" from "users" where "id" = 42 and "name" = 'Dan';
select "id", "name", "age" from "users" where "id" = 42 and "name" = 'Dan';
```
</Section>

<Section>
```typescript copy
import { eq, or, sql } from 'drizzle-orm';

await db.select().from(users).where(
  or(
    eq(users.id, 42), 
    eq(users.name, 'Dan')
  )
);
await db.select().from(users).where(sql`${users.id} = 42 or ${users.name} = 'Dan'`);
```
```sql
select "id", "name", "age" from "users" where "id" = 42 or "name" = 'Dan';
select "id", "name", "age" from "users" where "id" = 42 or "name" = 'Dan';
```
</Section>

### é«˜çº§è¿‡æ»¤å™¨
ç»“åˆ TypeScriptï¼ŒDrizzle API ä¸ºæ‚¨æä¾›å¼ºå¤§è€Œçµæ´»çš„æ–¹å¼æ¥ç»„åˆæŸ¥è¯¢ä¸­çš„è¿‡æ»¤å™¨ã€‚

æ¡ä»¶è¿‡æ»¤çš„é¢„è§ˆï¼Œæ›´å¤šè¯¦ç»†çš„é«˜çº§ç”¨æ³•ç¤ºä¾‹è¯·å‚é˜…æˆ‘ä»¬[ä¸“é—¨çš„æŒ‡å—](/docs/guides/conditional-filters-in-query)ã€‚
<CodeTabs items={["ç¤ºä¾‹ 1", "ç¤ºä¾‹ 2"]}>
```ts
const searchPosts = async (term?: string) => {
  await db
    .select()
    .from(posts)
    .where(term ? ilike(posts.title, term) : undefined);
};
await searchPosts();
await searchPosts('AI');
```
```ts
const searchPosts = async (filters: SQL[]) => {
  await db
    .select()
    .from(posts)
    .where(and(...filters));
};
const filters: SQL[] = [];
filters.push(ilike(posts.title, 'AI'));
filters.push(inArray(posts.category, ['Tech', 'Art', 'Science']));
filters.push(gt(posts.views, 200));
await searchPosts(filters);
```
</CodeTabs>

## ---

### é™åˆ¶ä¸åç§»
<IsSupportedChipGroup chips={{ 'MSSQL': false }} />

ä½¿ç”¨ `.limit()` å’Œ `.offset()` å‘æŸ¥è¯¢æ·»åŠ  `limit` å’Œ `offset` å­å¥ - ä¾‹å¦‚ï¼Œå®ç°åˆ†é¡µï¼š
<Section>
```typescript
await db.select().from(users).limit(10);
await db.select().from(users).limit(10).offset(10);
```
```sql
select "id", "name", "age" from "users" limit 10;
select "id", "name", "age" from "users" limit 10 offset 10;
```
</Section>

### Fetch & offset

<IsSupportedChipGroup chips={{ 'MSSQL': true }} />

<Callout>
åœ¨ MSSQL ä¸­ï¼Œ`FETCH` å’Œ `OFFSET` æ˜¯ `ORDER BY` å­å¥çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å®ƒä»¬åªèƒ½åœ¨ `.orderBy()` å‡½æ•°ä¹‹åä½¿ç”¨
</Callout>

<Section>
```typescript
await db.select().from(users).orderBy(asc(users.id)).offset(5);
await db.select().from(users).orderBy(asc(users.id)).offset(5).fetch(10);
```
```sql
select [id], [name], [age] from [users] offset 5 rows;
select [id], [name], [age] from [users] offset 5 rows fetch next 10 rows;
```
</Section>

### Top

<IsSupportedChipGroup chips={{ 'MSSQL': true }} />

é™åˆ¶æŸ¥è¯¢ç»“æœé›†ä¸­è¿”å›çš„è¡Œæ•°ä¸ºæŒ‡å®šæ•°é‡

<Section>
```typescript
await db.select().from(users).top(10);
```
```sql
select top (10) [id], [name], [age] from [users];
```
</Section>

### æ’åº
ä½¿ç”¨ `.orderBy()` å‘æŸ¥è¯¢æ·»åŠ  `order by` å­å¥ï¼ŒæŒ‰æŒ‡å®šå­—æ®µå¯¹ç»“æœè¿›è¡Œæ’åºï¼š
<Section>
```typescript
import { asc, desc } from 'drizzle-orm';

await db.select().from(users).orderBy(users.name);
await db.select().from(users).orderBy(desc(users.name));

// æŒ‰å¤šä¸ªå­—æ®µæ’åº
await db.select().from(users).orderBy(users.name, users.name2);
await db.select().from(users).orderBy(asc(users.name), desc(users.name2));
```
```sql
select "id", "name", "age" from "users" order by "name";
select "id", "name", "age" from "users" order by "name" desc;

select "id", "name", "age" from "users" order by "name", "name2";
select "id", "name", "age" from "users" order by "name" asc, "name2" desc;
```
</Section>

### é«˜çº§åˆ†é¡µ
ç”± TypeScript é©±åŠ¨ï¼ŒDrizzle APIs å…è®¸æ‚¨å®ç°æ‰€æœ‰å¯èƒ½çš„ SQL åˆ†é¡µå’Œæ’åºæ–¹æ³•ã€‚

é«˜çº§åˆ†é¡µçš„é¢„è§ˆï¼Œæ›´å¤šè¯¦ç»†çš„é«˜çº§ä½¿ç”¨ç¤ºä¾‹ - 
è¯·å‚è§æˆ‘ä»¬ä¸“é—¨çš„ [é™åˆ¶åç§»åˆ†é¡µ](/docs/guides/limit-offset-pagination) å’Œ
[æ¸¸æ ‡åˆ†é¡µ](/docs/guides/cursor-based-pagination) æŒ‡å—ã€‚

<CodeTabs items={["ç¤ºä¾‹ 1", "ç¤ºä¾‹ 2", "ç¤ºä¾‹ 3", "ç¤ºä¾‹ 4"]}>
```ts
await db
  .select()
  .from(users)
  .orderBy(asc(users.id)) // order by æ˜¯å¿…é¡»çš„
  .limit(4) // è¿”å›çš„è¡Œæ•°
  .offset(4); // è·³è¿‡çš„è¡Œæ•°
```
```ts
const getUsers = async (page = 1, pageSize = 3) => {
  await db.query.users.findMany({
    orderBy: (users, { asc }) => asc(users.id),
    limit: pageSize,
    offset: (page - 1) * pageSize,
  });
};
await getUsers();
```
```ts
const getUsers = async (page = 1, pageSize = 10) => {
   const sq = db
    .select({ id: users.id })
    .from(users)
    .orderBy(users.id)
    .limit(pageSize)
    .offset((page - 1) * pageSize)
    .as('subquery');
   await db.select().from(users).innerJoin(sq, eq(users.id, sq.id)).orderBy(users.id);
};
```
```ts
const nextUserPage = async (cursor?: number, pageSize = 3) => {
  await db
    .select()
    .from(users)
    .where(cursor ? gt(users.id, cursor) : undefined) // å¦‚æœæä¾›äº†æ¸¸æ ‡ï¼Œåˆ™è·å–è¯¥æ¸¸æ ‡ä¹‹åçš„è¡Œ
    .limit(pageSize) // è¿”å›çš„è¡Œæ•°
    .orderBy(asc(users.id)); // æ’åº
};
// ä¼ é€’å‰ä¸€é¡µæœ€åä¸€è¡Œçš„æ¸¸æ ‡ (id)
await nextUserPage(3);
```
</CodeTabs>

## ---

### WITH å­å¥

<Callout>
  æŸ¥çœ‹å¦‚ä½•ä¸ [æ’å…¥](/docs/insert#with-insert-clause), [æ›´æ–°](/docs/update#with-update-clause), [åˆ é™¤](/docs/delete#with-delete-clause) ä¸€èµ·ä½¿ç”¨ WITH è¯­å¥
</Callout>

ä½¿ç”¨ `with` å­å¥å¯ä»¥é€šè¿‡å°†å¤æ‚æŸ¥è¯¢æ‹†åˆ†æˆè¾ƒå°çš„å­æŸ¥è¯¢ï¼ˆç§°ä¸ºå…¬å…±è¡¨è¡¨è¾¾å¼ï¼ˆCTEsï¼‰ï¼‰æ¥ç®€åŒ–æŸ¥è¯¢ï¼š
<Section>
```typescript copy
const sq = db.$with('sq').as(db.select().from(users).where(eq(users.id, 42)));

const result = await db.with(sq).select().from(sq);
```
```sql
with sq as (select "id", "name", "age" from "users" where "id" = 42)
select "id", "name", "age" from sq;
```
</Section>

æ‚¨è¿˜å¯ä»¥åœ¨ `with` ä¸­æä¾› `insert`ã€`update` å’Œ `delete` è¯­å¥ã€‚

<Section>
```typescript copy
const sq = db.$with('sq').as(
    db.insert(users).values({ name: 'John' }).returning(),
);

const result = await db.with(sq).select().from(sq);
```
```sql
with "sq" as (insert into "users" ("id", "name") values (default, 'John') returning "id", "name") 
select "id", "name" from "sq"
```
</Section>

<Section>
```typescript copy
const sq = db.$with('sq').as(
    db.update(users).set({ age: 25 }).where(eq(users.name, 'John')).returning(),
);
const result = await db.with(sq).select().from(sq);
```
```sql
with "sq" as (update "users" set "age" = 25 where "users"."name" = 'John' returning "id", "name", "age") 
select "id", "name", "age" from "sq"
```
</Section>

<Section>
```typescript copy
const sq = db.$with('sq').as(
  db.delete(users).where(eq(users.name, 'John')).returning(),
);

const result = await db.with(sq).select().from(sq);
```
```sql
with "sq" as (delete from "users" where "users"."name" = $1 returning "id", "name", "age") 
select "id", "name", "age" from "sq"
```
</Section>

è‹¥è¦é€‰æ‹© CTE ä¸­çš„ä»»æ„ SQL å€¼ä½œä¸ºå­—æ®µå¹¶åœ¨å…¶ä»– CTE æˆ–ä¸»æŸ¥è¯¢ä¸­å¼•ç”¨å®ƒä»¬ï¼Œ
æ‚¨éœ€è¦ä¸ºå®ƒä»¬æ·»åŠ åˆ«åï¼š
```typescript copy

const sq = db.$with('sq').as(db.select({ 
  name: sql<string>`upper(${users.name})`.as('name'),
})
.from(users));

const result = await db.with(sq).select({ name: sq.name }).from(sq);
```
å¦‚æœæ‚¨ä¸æä¾›åˆ«åï¼Œå­—æ®µç±»å‹å°†å˜ä¸º `DrizzleTypeError`ï¼Œæ‚¨å°†æ— æ³•åœ¨å…¶ä»–æŸ¥è¯¢ä¸­å¼•ç”¨å®ƒã€‚
å¦‚æœå¿½ç•¥ç±»å‹é”™è¯¯å¹¶ä»ç„¶å°è¯•ä½¿ç”¨è¯¥å­—æ®µï¼Œ
æ‚¨å°†å¾—åˆ°è¿è¡Œæ—¶é”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰æ–¹æ³•å¯ä»¥åœ¨æ²¡æœ‰åˆ«åçš„æƒ…å†µä¸‹å¼•ç”¨è¯¥å­—æ®µã€‚

### ä»å­æŸ¥è¯¢ä¸­é€‰æ‹©
å°±åƒåœ¨ SQL ä¸­ä¸€æ ·ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨å­æŸ¥è¯¢ API å°†æŸ¥è¯¢åµŒå¥—åˆ°å…¶ä»–æŸ¥è¯¢ä¸­ï¼š
<Section>
```typescript copy
const sq = db.select().from(users).where(eq(users.id, 42)).as('sq');
const result = await db.select().from(sq);
```
```sql
select "id", "name", "age" from (select "id", "name", "age" from "users" where "id" = 42) "sq";
```
</Section>

å­æŸ¥è¯¢å¯ä»¥åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨è¡¨çš„ä½ç½®ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨è”æ¥ä¸­ï¼š
<Section>
```typescript copy
const sq = db.select().from(users).where(eq(users.id, 42)).as('sq');
const result = await db.select().from(users).leftJoin(sq, eq(users.id, sq.id));
```
```sql
select "users"."id", "users"."name", "users"."age", "sq"."id", "sq"."name", "sq"."age" from "users"
  left join (select "id", "name", "age" from "users" where "id" = 42) "sq"
    on "users"."id" = "sq"."id";
```
</Section>

## ---

### èšåˆ
ä½¿ç”¨ Drizzleï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `sum`ã€`count`ã€`avg` ç­‰å‡½æ•°è¿›è¡Œèšåˆï¼Œ
é€šè¿‡ `.groupBy()` å’Œ `.having()` åˆ†åˆ«è¿›è¡Œåˆ†ç»„å’Œè¿‡æ»¤ï¼Œå°±åƒåœ¨åŸå§‹ SQL ä¸­ä¸€æ ·ï¼š

<Section>
```typescript
import { gt } from 'drizzle-orm';

await db.select({
  age: users.age,
  count: sql<number>`cast(count(${users.id}) as int)`,
})
  .from(users)
  .groupBy(users.age);

await db.select({
  age: users.age,
  count: sql<number>`cast(count(${users.id}) as int)`,
})
  .from(users)
  .groupBy(users.age)
  .having(({ count }) => gt(count, 1));
```
```sql
select "age", cast(count("id") as int)
  from "users"
  group by "age";

select "age", cast(count("id") as int)
  from "users"
  group by "age"
  having cast(count("id") as int) > 1;
```
</Section>

<Callout type="info">
`cast(... as int)` æ˜¯å¿…è¦çš„ï¼Œå› ä¸º `count()` åœ¨ PostgreSQL ä¸­è¿”å› `bigint`ï¼Œåœ¨ MySQL ä¸­è¿”å› `decimal`ï¼Œè¿™äº›è¢«è§†ä¸ºå­—ç¬¦ä¸²å€¼è€Œä¸æ˜¯æ•°å­—ã€‚
æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [`.mapWith(Number)`](/docs/sql#sqlmapwith) åœ¨è¿è¡Œæ—¶å°†å€¼è½¬æ¢ä¸ºæ•°å­—ã€‚

å¦‚æœæ‚¨éœ€è¦è®¡æ•°èšåˆ - å»ºè®®ä½¿ç”¨æˆ‘ä»¬çš„ [`$count`](/docs/select#count) API
</Callout>

### èšåˆåŠ©æ‰‹

Drizzle å…·æœ‰ä¸€ç³»åˆ—å°è£…çš„ `sql` å‡½æ•°ï¼Œå› æ­¤æ‚¨æ— éœ€ä¸ºåº”ç”¨ä¸­çš„å¸¸è§æƒ…å†µç¼–å†™
`sql` æ¨¡æ¿ã€‚

<Callout type="info">
 è¯·è®°ä½ï¼Œèšåˆå‡½æ•°é€šå¸¸ä¸ SELECT è¯­å¥çš„ GROUP BY å­å¥ä¸€èµ·ä½¿ç”¨ã€‚
 å› æ­¤ï¼Œå¦‚æœæ‚¨åœ¨ä¸€ä¸ªæŸ¥è¯¢ä¸­é€‰æ‹©ä½¿ç”¨èšåˆå‡½æ•°å’Œå…¶ä»–åˆ—ï¼Œ 
 è¯·ç¡®ä¿ä½¿ç”¨ `.groupBy` å­å¥ã€‚
</Callout>


**count**

è¿”å› `expression` ä¸­çš„å€¼çš„æ•°é‡ã€‚
<Section>
```ts
import { count } from 'drizzle-orm'

await db.select({ value: count() }).from(users);
await db.select({ value: count(users.id) }).from(users);
```
```sql
select count("*") from "users";
select count("id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`count('*'))`.mapWith(Number) 
}).from(users);

await db.select({ 
  value: sql`count(${users.id})`.mapWith(Number) 
}).from(users);
```
</Section>

**countDistinct**

è¿”å› `expression` ä¸­éé‡å¤å€¼çš„æ•°é‡ã€‚
<Section>
```ts
import { countDistinct } from 'drizzle-orm'

await db.select({ value: countDistinct(users.id) }).from(users);
```
```sql
select count(distinct "id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`count(${users.id})`.mapWith(Number) 
}).from(users);
```
</Section>

**avg**

è¿”å› `expression` ä¸­æ‰€æœ‰éç©ºå€¼çš„å¹³å‡å€¼ï¼ˆç®—æœ¯å¹³å‡æ•°ï¼‰ã€‚
<Section>
```ts
import { avg } from 'drizzle-orm'

await db.select({ value: avg(users.id) }).from(users);
```
```sql
select avg("id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`avg(${users.id})`.mapWith(String) 
}).from(users);
```
</Section>

**avgDistinct**

è¿”å› `expression` ä¸­æ‰€æœ‰éç©ºå€¼çš„å¹³å‡å€¼ï¼ˆç®—æœ¯å¹³å‡æ•°ï¼‰ã€‚
<Section>
```ts
import { avgDistinct } from 'drizzle-orm'

await db.select({ value: avgDistinct(users.id) }).from(users);
```
```sql
select avg(distinct "id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`avg(distinct ${users.id})`.mapWith(String) 
}).from(users);
```
</Section>

**sum**

è¿”å› `expression` ä¸­æ‰€æœ‰éç©ºå€¼çš„å’Œã€‚
<Section>
```ts
import { sum } from 'drizzle-orm'

await db.select({ value: sum(users.id) }).from(users);
```
```sql
select sum("id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`sum(${users.id})`.mapWith(String) 
}).from(users);
```
</Section>

**sumDistinct**

è¿”å› `expression` ä¸­æ‰€æœ‰éç©ºå’Œéé‡å¤å€¼çš„å’Œã€‚
<Section>
```ts
import { sumDistinct } from 'drizzle-orm'

await db.select({ value: sumDistinct(users.id) }).from(users);
```
```sql
select sum(distinct "id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`sum(distinct ${users.id})`.mapWith(String) 
}).from(users);
```
</Section>

**max**

è¿”å› `expression` ä¸­çš„æœ€å¤§å€¼ã€‚
<Section>
```ts
import { max } from 'drizzle-orm'

await db.select({ value: max(users.id) }).from(users);
```
```sql
select max("id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`max(${expression})`.mapWith(users.id) 
}).from(users);
```
</Section>

**min**

è¿”å› `expression` ä¸­çš„æœ€å°å€¼ã€‚
<Section>
```ts
import { min } from 'drizzle-orm'

await db.select({ value: min(users.id) }).from(users);
```
```sql
select min("id") from "users";
```
```ts
// ç›¸å½“äºå†™
await db.select({ 
  value: sql`min(${users.id})`.mapWith(users.id) 
}).from(users);
```
</Section>

æ›´é«˜çº§çš„ç¤ºä¾‹ï¼š

```typescript copy
const orders = sqliteTable('order', {
  id: integer('id').primaryKey(),
  orderDate: integer('order_date', { mode: 'timestamp' }).notNull(),
  requiredDate: integer('required_date', { mode: 'timestamp' }).notNull(),
  shippedDate: integer('shipped_date', { mode: 'timestamp' }),
  shipVia: integer('ship_via').notNull(),
  freight: numeric('freight').notNull(),
  shipName: text('ship_name').notNull(),
  shipCity: text('ship_city').notNull(),
  shipRegion: text('ship_region'),
  shipPostalCode: text('ship_postal_code'),
  shipCountry: text('ship_country').notNull(),
  customerId: text('customer_id').notNull(),
  employeeId: integer('employee_id').notNull(),
});

const details = sqliteTable('order_detail', {
  unitPrice: numeric('unit_price').notNull(),
  quantity: integer('quantity').notNull(),
  discount: numeric('discount').notNull(),
  orderId: integer('order_id').notNull(),
  productId: integer('product_id').notNull(),
});


db
  .select({
    id: orders.id,
    shippedDate: orders.shippedDate,
    shipName: orders.shipName,
    shipCity: orders.shipCity,
    shipCountry: orders.shipCountry,
    productsCount: sql<number>`cast(count(${details.productId}) as int)`,
    quantitySum: sql<number>`sum(${details.quantity})`,
    totalPrice: sql<number>`sum(${details.quantity} * ${details.unitPrice})`,
  })
  .from(orders)
  .leftJoin(details, eq(orders.id, details.orderId))
  .groupBy(orders.id)
  .orderBy(asc(orders.id))
  .all();
```

### $count
<$count />

## ---

### è¿­ä»£å™¨

<IsSupportedChipGroup chips={{ 'MySQL': true, 'PostgreSQL[WIP]': false, 'SQLite[WIP]': false, 'SingleStore[WIP]': false, 'MSSQL': true, 'CockroachDB[WIP]': false }} />

å¦‚æœæ‚¨éœ€è¦ä»æŸ¥è¯¢ä¸­è¿”å›å¤§é‡è¡Œè€Œä¸å¸Œæœ›å°†å®ƒä»¬å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `.iterator()` å°†æŸ¥è¯¢è½¬æ¢ä¸ºå¼‚æ­¥è¿­ä»£å™¨ï¼š

```ts copy
const iterator = await db.select().from(users).iterator();

for await (const row of iterator) {
  console.log(row);
}
```

å®ƒä¹Ÿé€‚ç”¨äºå‡†å¤‡å¥½çš„è¯­å¥ï¼š

```ts copy
const query = await db.select().from(users).prepare();
const iterator = await query.iterator();

for await (const row of iterator) {
  console.log(row);
}
```

## ---

### ä½¿ç”¨ç´¢å¼•

`USE INDEX` æç¤ºå‘Šè¯‰ä¼˜åŒ–å™¨åœ¨å¤„ç†æŸ¥è¯¢æ—¶è€ƒè™‘å“ªäº›ç´¢å¼•ã€‚ä¼˜åŒ–å™¨ä¸ä¼šå¼ºåˆ¶ä½¿ç”¨è¿™äº›ç´¢å¼•ï¼Œä½†å¦‚æœå®ƒä»¬åˆé€‚ï¼Œä¼šä¼˜å…ˆä½¿ç”¨å®ƒä»¬ã€‚

<IsSupportedChipGroup chips={{ 'MySQL': true, 'PostgreSQL': false, 'SQLite': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': false }} />

```ts copy
export const users = mysqlTable('users', {
	id: int('id').primaryKey(),
	name: varchar('name', { length: 100 }).notNull(),
}, () => [usersTableNameIndex]);

const usersTableNameIndex = index('users_name_index').on(users.name);

await db.select()
  .from(users, { useIndex: usersTableNameIndex })
  .where(eq(users.name, 'David'));
```

æ‚¨è¿˜å¯ä»¥åœ¨ä»»ä½•æ‚¨æƒ³è¦çš„è¿æ¥ä¸Šä½¿ç”¨æ­¤é€‰é¡¹

```ts
await db.select()
  .from(users)
  .leftJoin(posts, eq(posts.userId, users.id), { useIndex: usersTableNameIndex })
  .where(eq(users.name, 'David'));
```

### å¿½ç•¥ç´¢å¼•

`IGNORE INDEX` æç¤ºå‘Šè¯‰ä¼˜åŒ–å™¨é¿å…ä½¿ç”¨ç‰¹å®šçš„ç´¢å¼•æ¥å¤„ç†æŸ¥è¯¢ã€‚MySQL å°†è€ƒè™‘æ‰€æœ‰å…¶ä»–ç´¢å¼•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œæˆ–åœ¨å¿…è¦æ—¶æ‰§è¡Œå…¨è¡¨æ‰«æã€‚

<IsSupportedChipGroup chips={{ 'MySQL': true, 'PostgreSQL': false, 'SQLite': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': false }} />

```ts copy
export const users = mysqlTable('users', {
	id: int('id').primaryKey(),
	name: varchar('name', { length: 100 }).notNull(),
}, () => [usersTableNameIndex]);

const usersTableNameIndex = index('users_name_index').on(users.name);

await db.select()
  .from(users, { ignoreIndex: usersTableNameIndex })
  .where(eq(users.name, 'David'));
```

æ‚¨è¿˜å¯ä»¥åœ¨ä»»ä½•æ‚¨æƒ³è¦çš„è¿æ¥ä¸Šä½¿ç”¨æ­¤é€‰é¡¹

```ts
await db.select()
  .from(users)
  .leftJoin(posts, eq(posts.userId, users.id), { useIndex: usersTableNameIndex })
  .where(eq(users.name, 'David'));
```

### å¼ºåˆ¶ç´¢å¼•

`FORCE INDEX`æç¤ºå¼ºåˆ¶ä¼˜åŒ–å™¨ä½¿ç”¨æŒ‡å®šçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŒ‡å®šçš„ç´¢å¼•æ— æ³•ä½¿ç”¨ï¼ŒMySQLä¸ä¼šå›é€€åˆ°å…¶ä»–ç´¢å¼•ï¼›å®ƒå¯èƒ½ä¼šæ”¹ä¸ºè¿›è¡Œå…¨è¡¨æ‰«æã€‚

<IsSupportedChipGroup chips={{ 'MySQL': true, 'PostgreSQL': false, 'SQLite': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': false }} />

```ts copy
export const users = mysqlTable('users', {
	id: int('id').primaryKey(),
	name: varchar('name', { length: 100 }).notNull(),
}, () => [usersTableNameIndex]);

const usersTableNameIndex = index('users_name_index').on(users.name);

await db.select()
  .from(users, { forceIndex: usersTableNameIndex })
  .where(eq(users.name, 'David'));
```

æ‚¨è¿˜å¯ä»¥åœ¨ä»»ä½•æ‚¨æƒ³è¦çš„è¿æ¥ä¸Šä½¿ç”¨æ­¤é€‰é¡¹

```ts
await db.select()
  .from(users)
  .leftJoin(posts, eq(posts.userId, users.id), { useIndex: usersTableNameIndex })
  .where(eq(users.name, 'David'));
```

Source: https://drizzle.zhcndoc.com/docs/sequences

import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Callout from '@mdx/Callout.astro';
import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';

# åºåˆ—

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': false, 'MySQL': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': true }} />

PostgreSQL å’Œ CockroachDB ä¸­çš„åºåˆ—æ˜¯ç‰¹æ®Šçš„å•è¡Œè¡¨ï¼Œåˆ›å»ºç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé€šå¸¸ç”¨äºè‡ªåŠ¨é€’å¢ä¸»é”®å€¼ã€‚å®ƒä»¬æä¾›äº†ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼Œåœ¨å¤šä¸ªä¼šè¯ä¸­ç”Ÿæˆå”¯ä¸€çš„è¿ç»­å€¼ã€‚

<Tabs items={['PostgreSQL', 'CockroachDB']}>
<Tab>
```ts
import { pgSchema, pgSequence } from "drizzle-orm/pg-core";

// æœªæŒ‡å®šå‚æ•°
export const customSequence = pgSequence("name");

// å¸¦å‚æ•°çš„åºåˆ—
export const customSequence = pgSequence("name", {
      startWith: 100,
      maxValue: 10000,
      minValue: 100,
      cycle: true,
      cache: 10,
      increment: 2
});

// è‡ªå®šä¹‰æ¶æ„ä¸­çš„åºåˆ—
export const customSchema = pgSchema('custom_schema');
export const customSequence = customSchema.sequence("name");
```
</Tab>
<Tab>
```ts
import { cockroachSchema, cockroachSequence } from "drizzle-orm/cockroach-core";

// æœªæŒ‡å®šå‚æ•°
export const customSequence = cockroachSequence("name");

// å¸¦å‚æ•°çš„åºåˆ—
export const customSequence = cockroachSequence("name", {
      startWith: 100,
      maxValue: 10000,
      minValue: 100,
      cycle: true,
      cache: 10,
      increment: 2
});

// è‡ªå®šä¹‰æ¶æ„ä¸­çš„åºåˆ—
export const customSchema = cockroachSchema('custom_schema');
export const customSequence = customSchema.sequence("name");
```
</Tab>
</Tabs>

Source: https://drizzle.zhcndoc.com/docs/set-operations

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Callout from '@mdx/Callout.astro';

# é›†åˆæ“ä½œ

SQL é›†åˆæ“ä½œå°†å¤šä¸ªæŸ¥è¯¢å—çš„ç»“æœç»“åˆæˆå•ä¸ªç»“æœã€‚
SQL æ ‡å‡†å®šä¹‰äº†ä»¥ä¸‹ä¸‰ç§é›†åˆæ“ä½œï¼š`UNION`ã€`INTERSECT`ã€`EXCEPT`ã€`UNION ALL`ã€`INTERSECT ALL`ã€`EXCEPT ALL`ã€‚

### å¹¶é›†ï¼ˆUnionï¼‰
å°†ä¸¤ä¸ªæŸ¥è¯¢å—çš„æ‰€æœ‰ç»“æœç»„åˆæˆå•ä¸ªç»“æœï¼Œçœç•¥ä»»ä½•é‡å¤é¡¹ã€‚

è·å– customers å’Œ users è¡¨ä¸­çš„æ‰€æœ‰åç§°ï¼Œä¸å¸¦é‡å¤ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { union } from 'drizzle-orm/pg-core'
    import { users, customers } from './schema'

    const allNamesForUserQuery = db.select({ name: users.name }).from(users);

    const result = await union(
		allNamesForUserQuery,
		db.select({ name: customers.name }).from(customers)
	).limit(10);
    ```
    ```sql
    (select "name" from "sellers")
    union
    (select "name" from "customers")
    limit $1
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { users, customers } from './schema'

    const result = await db
      .select({ name: users.name })
      .from(users)
      .union(db.select({ name: customers.name }).from(customers))
      .limit(10);
    ```
    ```sql
    (select "name" from "sellers")
    union
    (select "name" from "customers")
    limit $1
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { integer, pgTable, text, varchar } from "drizzle-orm/pg-core";

    const users = pgTable('sellers', {
        id: integer('id').primaryKey(),
        name: varchar('name', { length: 256 }).notNull(),
        address: text('address'),
    });
    
    const customers = pgTable('customers', {
        id: integer('id').primaryKey(),
        name: varchar('name', { length: 256 }).notNull(),
        city: text('city'),
        email: varchar('email', { length: 256 }).notNull()
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { union } from 'drizzle-orm/mysql-core'
    import { users, customers } from './schema'

    const allNamesForUserQuery = db.select({ name: users.name }).from(users);

    const result = await union(
		allNamesForUserQuery,
		db.select({ name: customers.name }).from(customers)
	).limit(10);
    ```
    ```sql
    (select `name` from `sellers`)
    union
    (select `name` from `customers`)
    limit ?
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { users, customers } from './schema'

    const result = await db
      .select({ name: users.name })
      .from(users)
      .union(db.select({ name: customers.name }).from(customers))
      .limit(10);
    ```
    ```sql
    (select `name` from `sellers`)
    union
    (select `name` from `customers`)
    limit ?
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mysqlTable, text, varchar } from "drizzle-orm/mysql-core";

    const users = mysqlTable('sellers', {
        id: int('id').primaryKey(),
        name: varchar('name', { length: 256 }).notNull(),
        address: text('address'),
    });
    
    const customers = mysqlTable('customers', {
        id: int('id').primaryKey(),
        name: varchar('name', { length: 256 }).notNull(),
        city: text('city'),
        email: varchar('email', { length: 256 }).notNull()
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { union } from 'drizzle-orm/sqlite-core'
    import { users, customers } from './schema'

    const allNamesForUserQuery = db.select({ name: users.name }).from(users);

    const result = await union(
		allNamesForUserQuery,
		db.select({ name: customers.name }).from(customers)
	).limit(10);
    ```
    ```sql
    (select "name" from "sellers")
    union 
    (select "name" from "customers")
    limit ?
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { users, customers } from './schema'

    const result = await db
      .select({ name: users.name })
      .from(users)
      .union(db.select({ name: customers.name }).from(customers))
      .limit(10);
    ```
    ```sql
    select "name" from "sellers" union select "name" from "customers" limit ?
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

    const users = sqliteTable('sellers', {
        id: int('id').primaryKey(),
        name: text('name').notNull(),
        address: text('address'),
    });
    
    const customers = sqliteTable('customers', {
        id: int('id').primaryKey(),
        name: text('name').notNull(),
        city: text('city'),
        email: text('email').notNull()
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { union } from 'drizzle-orm/singlestore-core'
    import { users, customers } from './schema'

    const allNamesForUserQuery = db.select({ name: users.name }).from(users);

    const result = await union(
		allNamesForUserQuery,
		db.select({ name: customers.name }).from(customers)
	).limit(10);
    ```
    ```sql
    (select `name` from `sellers`)
    union
    (select `name` from `customers`)
    limit ?
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { users, customers } from './schema'

    const result = await db
      .select({ name: users.name })
      .from(users)
      .union(db.select({ name: customers.name }).from(customers))
      .limit(10);
    ```
    ```sql
    (select `name` from `sellers`)
    union
    (select `name` from `customers`)
    limit ?
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mysqlTable, text, varchar } from "drizzle-orm/singlestore-core";

    const users = mysqlTable('sellers', {
        id: int('id').primaryKey(),
        name: varchar('name', { length: 256 }).notNull(),
        address: text('address'),
    });
    
    const customers = mysqlTable('customers', {
        id: int('id').primaryKey(),
        name: varchar('name', { length: 256 }).notNull(),
        city: text('city'),
        email: varchar('email', { length: 256 }).notNull()
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { union } from 'drizzle-orm/mssql-core'
    import { users, customers } from './schema'

    const allNamesForUserQuery = db.select({ name: users.name }).from(users);

    const result = await union(
		allNamesForUserQuery,
		db.select({ name: customers.name }).from(customers)
	).limit(10);
    ```
    ```sql
    (select [name] from [sellers])
    union
    (select [name] from [customers])
    limit @limit
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { users, customers } from './schema'

    const result = await db
      .select({ name: users.name })
      .from(users)
      .union(db.select({ name: customers.name }).from(customers))
      .limit(10);
    ```
    ```sql
    (select [name] from [sellers])
    union
    (select [name] from [customers])
    limit @limit
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mssqlTable, ntext, nvarchar } from "drizzle-orm/mssql-core";

    const users = mssqlTable('sellers', {
        id: int().primaryKey(),
        name: nvarchar({ length: 256 }).notNull(),
        address: ntext(),
    });
    
    const customers = mssqlTable('customers', {
        id: int().primaryKey(),
        name: nvarchar({ length: 256 }).notNull(),
        city: ntext(),
        email: nvarchar({ length: 256 }).notNull()
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { union } from 'drizzle-orm/cockroach-core'
    import { users, customers } from './schema'

    const allNamesForUserQuery = db.select({ name: users.name }).from(users);

    const result = await union(
		allNamesForUserQuery,
		db.select({ name: customers.name }).from(customers)
	).limit(10);
    ```
    ```sql
    (select "name" from "sellers")
    union
    (select "name" from "customers")
    limit $1
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { users, customers } from './schema'

    const result = await db
      .select({ name: users.name })
      .from(users)
      .union(db.select({ name: customers.name }).from(customers))
      .limit(10);
    ```
    ```sql
    (select "name" from "sellers")
    union
    (select "name" from "customers")
    limit $1
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { int4, cockroachTable, text, varchar } from "drizzle-orm/cockroach-core";

    const users = cockroachTable('sellers', {
        id: int4().primaryKey(),
        name: varchar({ length: 256 }).notNull(),
        address: text(),
    });
    
    const customers = cockroachTable('customers', {
        id: int4().primaryKey(),
        name: varchar({ length: 256 }).notNull(),
        city: text(),
        email: varchar({ length: 256 }).notNull()
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
</Tabs>

### å¹¶é›†æ‰€æœ‰ï¼ˆUnion Allï¼‰
å°†ä¸¤ä¸ªæŸ¥è¯¢å—çš„æ‰€æœ‰ç»“æœç»„åˆæˆå•ä¸ªç»“æœï¼ŒåŒ…æ‹¬é‡å¤é¡¹ã€‚

è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œä½ æœ‰ä¸¤ä¸ªè¡¨ï¼Œä¸€ä¸ªè¡¨ç¤ºåœ¨çº¿é”€å”®ï¼Œ
å¦ä¸€ä¸ªè¡¨ç¤ºé—¨åº—é”€å”®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ æƒ³æŠŠä¸¤ä¸ªè¡¨çš„æ•°æ®ç»“åˆæˆä¸€ä¸ªç»“æœé›†ã€‚
ç”±äºå¯èƒ½ä¼šæœ‰é‡å¤çš„äº¤æ˜“ï¼Œ
ä½ å¸Œæœ›ä¿ç•™æ‰€æœ‰è®°å½•ï¼Œè€Œä¸æ¶ˆé™¤é‡å¤é¡¹ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { unionAll } from 'drizzle-orm/pg-core'
    import { onlineSales, inStoreSales } from './schema'

    const onlineTransactions = db.select({ transaction: onlineSales.transactionId }).from(onlineSales);
    const inStoreTransactions = db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales);

    const result = await unionAll(onlineTransactions, inStoreTransactions);
    ```
    ```sql
    select "transaction_id" from "online_sales"
    union all
    select "transaction_id" from "in_store_sales"
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { onlineSales, inStoreSales } from './schema'

    const result = await db
      .select({ transaction: onlineSales.transactionId })
      .from(onlineSales)
      .unionAll(
        db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)
      );
    ```
    ```sql
    select "transaction_id" from "online_sales"
    union all
    select "transaction_id" from "in_store_sales"
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { integer, pgTable, text, timestamp, varchar } from "drizzle-orm/pg-core";

    const onlineSales = pgTable('online_sales', {
        transactionId: integer('transaction_id').primaryKey(),
        productId: integer('product_id').unique(),
        quantitySold: integer('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    
    const inStoreSales = pgTable('in_store_sales', {
        transactionId: integer('transaction_id').primaryKey(),
        productId: integer('product_id').unique(),
        quantitySold: integer('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
<Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { unionAll } from 'drizzle-orm/mysql-core'
    import { onlineSales, inStoreSales } from './schema'

    const onlineTransactions = db.select({ transaction: onlineSales.transactionId }).from(onlineSales);
    const inStoreTransactions = db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales);

    const result = await unionAll(onlineTransactions, inStoreTransactions);
    ```
    ```sql
    select `transaction_id` from `online_sales`
    union all
    select `transaction_id` from `in_store_sales`
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { onlineSales, inStoreSales } from './schema'

    const result = await db
      .select({ transaction: onlineSales.transactionId })
      .from(onlineSales)
      .unionAll(
        db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)
      );
    ```
    ```sql
    (select `transaction_id` from `online_sales`)
    union all 
    (select `transaction_id` from `in_store_sales`)
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mysqlTable, text, timestamp, varchar } from "drizzle-orm/mysql-core";

    const onlineSales = mysqlTable('online_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    
    const inStoreSales = mysqlTable('in_store_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { unionAll } from 'drizzle-orm/sqlite-core'
    import { onlineSales, inStoreSales } from './schema'

    const onlineTransactions = db.select({ transaction: onlineSales.transactionId }).from(onlineSales);
    const inStoreTransactions = db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales);

    const result = await unionAll(onlineTransactions, inStoreTransactions);
    ```
    ```sql
    select "transaction_id" from "online_sales" 
    union all 
    select "transaction_id" from "in_store_sales"
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { onlineSales, inStoreSales } from './schema'

    const result = await db
      .select({ transaction: onlineSales.transactionId })
      .from(onlineSales)
      .unionAll(
        db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)
      );
    ```
    ```sql
    select "transaction_id" from "online_sales" 
    union all 
    select "transaction_id" from "in_store_sales"
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { int, sqliteTable } from "drizzle-orm/sqlite-core";

    const onlineSales = sqliteTable('online_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: int('sale_date', { mode: 'timestamp' }),
    });
    
    const inStoreSales = sqliteTable('in_store_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: int('sale_date', { mode: 'timestamp' }),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <Callout type='warning'>
  UNION ALL with ORDER BY behavior inconsistent with MySQL: SingleStore parses UNION ALL followed by ORDER BY commands differently from MySQL. In SingleStore, the following query is valid. In MySQL, it is invalid.
  </Callout>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { unionAll } from 'drizzle-orm/singlestore-core'
    import { onlineSales, inStoreSales } from './schema'

    const onlineTransactions = db.select({ transaction: onlineSales.transactionId }).from(onlineSales);
    const inStoreTransactions = db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales);

    const result = await unionAll(onlineTransactions, inStoreTransactions);
    ```
    ```sql
    select `transaction_id` from `online_sales`
    union all
    select `transaction_id` from `in_store_sales`
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { onlineSales, inStoreSales } from './schema'

    const result = await db
      .select({ transaction: onlineSales.transactionId })
      .from(onlineSales)
      .unionAll(
        db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)
      );
    ```
    ```sql
    (select `transaction_id` from `online_sales`)
    union all 
    (select `transaction_id` from `in_store_sales`)
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mysqlTable, text, timestamp, varchar } from "drizzle-orm/singlestore-core";

    const onlineSales = mysqlTable('online_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    
    const inStoreSales = mysqlTable('in_store_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { unionAll } from 'drizzle-orm/mssql-core'
    import { onlineSales, inStoreSales } from './schema'

    const onlineTransactions = db.select({ transaction: onlineSales.transactionId }).from(onlineSales);
    const inStoreTransactions = db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales);

    const result = await unionAll(onlineTransactions, inStoreTransactions);
    ```
    ```sql
    (select [transaction_id] from [online_sales])
    union all
    (select [transaction_id] from [in_store_sales])
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { onlineSales, inStoreSales } from './schema'

    const result = await db
      .select({ transaction: onlineSales.transactionId })
      .from(onlineSales)
      .unionAll(
        db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)
      );
    ```
    ```sql
    (select [transaction_id] from [online_sales])
    union all
    (select [transaction_id] from [in_store_sales])
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mssqlTable, timestamp } from "drizzle-orm/mssql-core";

    const onlineSales = mysqlTable('online_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    
    const inStoreSales = mysqlTable('in_store_sales', {
        transactionId: int('transaction_id').primaryKey(),
        productId: int('product_id').unique(),
        quantitySold: int('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { unionAll } from 'drizzle-orm/cockroach-core'
    import { onlineSales, inStoreSales } from './schema'

    const onlineTransactions = db.select({ transaction: onlineSales.transactionId }).from(onlineSales);
    const inStoreTransactions = db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales);

    const result = await unionAll(onlineTransactions, inStoreTransactions);
    ```
    ```sql
    select "transaction_id" from "online_sales"
    union all
    select "transaction_id" from "in_store_sales"
    ```
    </CodeTab>
    <CodeTab>
    ```ts copy
    import { onlineSales, inStoreSales } from './schema'

    const result = await db
      .select({ transaction: onlineSales.transactionId })
      .from(onlineSales)
      .unionAll(
        db.select({ transaction: inStoreSales.transactionId }).from(inStoreSales)
      );
    ```
    ```sql
    select "transaction_id" from "online_sales"
    union all
    select "transaction_id" from "in_store_sales"
    ```
	</CodeTab>
    <CodeTab>
	```typescript copy
    import { int4, cockroachTable, text, timestamp, varchar } from "drizzle-orm/cockroach-core";

    const onlineSales = cockroachTable('online_sales', {
        transactionId: int4('transaction_id').primaryKey(),
        productId: int4('product_id').unique(),
        quantitySold: int4('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    
    const inStoreSales = cockroachTable('in_store_sales', {
        transactionId: int4('transaction_id').primaryKey(),
        productId: int4('product_id').unique(),
        quantitySold: int4('quantity_sold'),
        saleDate: timestamp('sale_date', { mode: 'date' }),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
</Tabs>

### äº¤é›†ï¼ˆIntersectï¼‰
ä»…ç»“åˆä¸¤ä¸ªæŸ¥è¯¢å—çš„ç»“æœä¸­å…±é€šçš„è¡Œï¼Œçœç•¥ä»»ä½•é‡å¤é¡¹ã€‚

å‡è®¾ä½ æœ‰ä¸¤ä¸ªè¡¨å­˜å‚¨æœ‰å…³å­¦ç”Ÿè¯¾ç¨‹æ³¨å†Œçš„ä¿¡æ¯ã€‚
ä½ æƒ³æ‰¾åˆ°ä¸¤ä¸ªä¸åŒç³»é—´å…±åŒçš„è¯¾ç¨‹ï¼Œ
ä½†ä½ å¸Œæœ›è¯¾ç¨‹åæ˜¯å”¯ä¸€çš„ï¼Œ
å¹¶ä¸”ä¸æƒ³è®¡ç®—åŒä¸€ä¸ªå­¦ç”Ÿåœ¨åŒä¸€è¯¾ç¨‹ä¸‹çš„å¤šä¸ªæ³¨å†Œã€‚

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œä½ å¸Œæœ›æ‰¾åˆ°ä¸¤ä¸ªç³»é—´çš„å…±åŒè¯¾ç¨‹ï¼Œ
ä½†ä¸å¸Œæœ›åŒä¸€è¯¾ç¨‹å³ä½¿è¢«åŒä¸€ç³»çš„å¤šä¸ªå­¦ç”Ÿæ³¨å†Œä¹Ÿè®¡æ•°å¤šæ¬¡ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersect } from 'drizzle-orm/pg-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.courseName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.courseName }).from(depB);

    const result = await intersect(departmentACourses, departmentBCourses);
    ```
    ```sql
    select "course_name" from "department_a_courses"
    intersect
    select "course_name" from "department_b_courses"
    ```
	</CodeTab>
    <CodeTab>
    ```typescript copy
    import { depA, depB } from './schema'

    const result = await db
      .select({ courseName: depA.courseName })
      .from(depA)
      .intersect(db.select({ courseName: depB.courseName }).from(depB));
    ```
    ```sql
    select "course_name" from "department_a_courses"
    intersect
    select "course_name" from "department_b_courses"
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { integer, pgTable, varchar } from "drizzle-orm/pg-core";

    const depA = pgTable('department_a_courses', {
        studentId: integer('student_id'),
        courseName: varchar('course_name').notNull(),
    });
    
    const depB = pgTable('department_b_courses', {
        studentId: integer('student_id'),
        courseName: varchar('course_name').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
    <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersect } from 'drizzle-orm/mysql-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.courseName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.courseName }).from(depB);

    const result = await intersect(departmentACourses, departmentBCourses);
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    intersect
    select `projects_name` from `department_b_projects`
    ```
	</CodeTab>
    <CodeTab>
    ```typescript copy
    import { depA, depB } from './schema'

    const result = await db
      .select({ courseName: depA.courseName })
      .from(depA)
      .intersect(db.select({ courseName: depB.courseName }).from(depB));
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    intersect
    select `projects_name` from `department_b_projects`
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mysqlTable, varchar } from "drizzle-orm/mysql-core";

    const depA = mysqlTable('department_a_courses', {
        studentId: int('student_id'),
        courseName: varchar('course_name', { length: 256 }).notNull(),
    });
    
    const depB = mysqlTable('department_b_courses', {
        studentId: int('student_id'),
        courseName: varchar('course_name', { length: 256 }).notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
      <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersect } from 'drizzle-orm/sqlite-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.courseName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.courseName }).from(depB);

    const result = await intersect(departmentACourses, departmentBCourses);
    ```
    ```sql
    select "course_name" from "department_a_courses"
    intersect
    select "course_name" from "department_b_courses"
    ```
	</CodeTab>
    <CodeTab>
    ```typescript copy
    import { depA, depB } from './schema'

    const result = await db
      .select({ courseName: depA.courseName })
      .from(depA)
      .intersect(db.select({ courseName: depB.courseName }).from(depB));
    ```
    ```sql
    select "course_name" from "department_a_courses" 
    intersect 
    select "course_name" from "department_b_courses"
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

    const depA = sqliteTable('department_a_courses', {
        studentId: int('student_id'),
        courseName: text('course_name').notNull(),
    });
    
    const depB = sqliteTable('department_b_courses', {
        studentId: int('student_id'),
        courseName: text('course_name').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
    <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersect } from 'drizzle-orm/singlestore-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.courseName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.courseName }).from(depB);

    const result = await intersect(departmentACourses, departmentBCourses);
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    intersect
    select `projects_name` from `department_b_projects`
    ```
	</CodeTab>
    <CodeTab>
    ```typescript copy
    import { depA, depB } from './schema'

    const result = await db
      .select({ courseName: depA.courseName })
      .from(depA)
      .intersect(db.select({ courseName: depB.courseName }).from(depB));
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    intersect
    select `projects_name` from `department_b_projects`
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, singlestoreTable, varchar } from "drizzle-orm/singlestore-core";

    const depA = singlestoreTable('department_a_courses', {
        studentId: int('student_id'),
        courseName: varchar('course_name', { length: 256 }).notNull(),
    });
    
    const depB = singlestoreTable('department_b_courses', {
        studentId: int('student_id'),
        courseName: varchar('course_name', { length: 256 }).notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersect } from 'drizzle-orm/mssql-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.courseName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.courseName }).from(depB);

    const result = await intersect(departmentACourses, departmentBCourses);
    ```
    ```sql
    (select `projects_name` from `department_a_projects`)
    intersect
    (select `projects_name` from `department_b_projects`)
    ```
	</CodeTab>
    <CodeTab>
    ```typescript copy
    import { depA, depB } from './schema'

    const result = await db
      .select({ courseName: depA.courseName })
      .from(depA)
      .intersect(db.select({ courseName: depB.courseName }).from(depB));
    ```
    ```sql
    (select `projects_name` from `department_a_projects`)
    intersect
    (select `projects_name` from `department_b_projects`)
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, mssqlTable, varchar } from "drizzle-orm/mssqlTable-core";

    const depA = mssqlTable('department_a_courses', {
        studentId: int('student_id'),
        courseName: varchar('course_name', { length: 256 }).notNull(),
    });
    
    const depB = mssqlTable('department_b_courses', {
        studentId: int('student_id'),
        courseName: varchar('course_name', { length: 256 }).notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersect } from 'drizzle-orm/cockroach-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.courseName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.courseName }).from(depB);

    const result = await intersect(departmentACourses, departmentBCourses);
    ```
    ```sql
    select "course_name" from "department_a_courses"
    intersect
    select "course_name" from "department_b_courses"
    ```
	</CodeTab>
    <CodeTab>
    ```typescript copy
    import { depA, depB } from './schema'

    const result = await db
      .select({ courseName: depA.courseName })
      .from(depA)
      .intersect(db.select({ courseName: depB.courseName }).from(depB));
    ```
    ```sql
    select "course_name" from "department_a_courses"
    intersect
    select "course_name" from "department_b_courses"
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int4, cockroachTable, varchar } from "drizzle-orm/cockroach-core";

    const depA = cockroachTable('department_a_courses', {
        studentId: int4('student_id'),
        courseName: varchar('course_name').notNull(),
    });
    
    const depB = cockroachTable('department_b_courses', {
        studentId: int4('student_id'),
        courseName: varchar('course_name').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
</Tabs>

### äº¤é›†æ‰€æœ‰ï¼ˆIntersect Allï¼‰
ä»…ç»“åˆä¸¤ä¸ªæŸ¥è¯¢å—çš„ç»“æœä¸­å…±é€šçš„è¡Œï¼ŒåŒ…æ‹¬é‡å¤é¡¹ã€‚

è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œä½ æœ‰ä¸¤ä¸ªè¡¨åŒ…å«æœ‰å…³å®¢æˆ·è®¢å•çš„æ•°æ®ï¼Œ
ä½ æƒ³è¯†åˆ«æ™®é€šå®¢æˆ·å’Œ VIP å®¢æˆ·éƒ½è®¢å•çš„äº§å“ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ æƒ³æ›´å¥½åœ°è·Ÿè¸ªæ¯ç§äº§å“çš„æ•°é‡ï¼Œ
å³ä½¿ä¸åŒå®¢æˆ·å¤šæ¬¡ä¸‹å•ã€‚

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œä½ å¸Œæœ›æ‰¾åˆ°æ™®é€šå®¢æˆ·å’Œ VIP å®¢æˆ·éƒ½ä¸‹å•çš„äº§å“ï¼Œ
ä½†ä½ å¸Œæœ›ä¿ç•™æ•°é‡ä¿¡æ¯ï¼Œ
å³ä½¿åŒä¸€äº§å“è¢«ä¸åŒçš„å®¢æˆ·å¤šæ¬¡ä¸‹å•ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLlite", "SingleStore", "MSSQL" ,"CockroachDB"]}>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersectAll } from 'drizzle-orm/pg-core'
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const regularOrders = db.select({ 
        productId: regularCustomerOrders.productId,
        quantityOrdered: regularCustomerOrders.quantityOrdered }
    ).from(regularCustomerOrders);

    const vipOrders = db.select({ 
        productId: vipCustomerOrders.productId,
        quantityOrdered: vipCustomerOrders.quantityOrdered }
    ).from(vipCustomerOrders);

    const result = await intersectAll(regularOrders, vipOrders);
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    intersect all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
	</CodeTab>
    ```ts copy
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const result = await db
        .select({
          productId: regularCustomerOrders.productId,
          quantityOrdered: regularCustomerOrders.quantityOrdered,
        })
        .from(regularCustomerOrders)
        .intersectAll(
          db
            .select({
              productId: vipCustomerOrders.productId,
              quantityOrdered: vipCustomerOrders.quantityOrdered,
            })
            .from(vipCustomerOrders)
        );
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    intersect all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
    <CodeTab>
	```typescript copy
    import { integer, pgTable } from "drizzle-orm/pg-core";

    const regularCustomerOrders = pgTable('regular_customer_orders', {
        customerId: integer('customer_id').primaryKey(),
        productId: integer('product_id').notNull(),
        quantityOrdered: integer('quantity_ordered').notNull(),
    });
    
    const vipCustomerOrders = pgTable('vip_customer_orders', {
        customerId: integer('customer_id').primaryKey(),
        productId: integer('product_id').notNull(),
        quantityOrdered: integer('quantity_ordered').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersectAll } from 'drizzle-orm/mysql-core'
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const regularOrders = db.select({ 
        productId: regularCustomerOrders.productId,
        quantityOrdered: regularCustomerOrders.quantityOrdered }
    ).from(regularCustomerOrders);

    const vipOrders = db.select({ 
        productId: vipCustomerOrders.productId,
        quantityOrdered: vipCustomerOrders.quantityOrdered }
    ).from(vipCustomerOrders);

    const result = await intersectAll(regularOrders, vipOrders);
    ```
    ```sql
    select `product_id`, `quantity_ordered` from `regular_customer_orders`
    intersect all
    select `product_id`, `quantity_ordered` from `vip_customer_orders`
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { regularCustomerOrders, vipCustomerOrders } from './schema'
 
    const result = await db
        .select({
          productId: regularCustomerOrders.productId,
          quantityOrdered: regularCustomerOrders.quantityOrdered,
        })
        .from(regularCustomerOrders)
        .intersectAll(
          db
            .select({
              productId: vipCustomerOrders.productId,
              quantityOrdered: vipCustomerOrders.quantityOrdered,
            })
            .from(vipCustomerOrders)
        );
    ```
    ```sql
    select `product_id`, `quantity_ordered` from `regular_customer_orders`
    intersect all
    select `product_id`, `quantity_ordered` from `vip_customer_orders`
    ```
    </CodeTab>
	<CodeTab>
	```typescript copy
    import { int, mysqlTable } from "drizzle-orm/mysql-core";

    const regularCustomerOrders = mysqlTable('regular_customer_orders', {
        customerId: int('customer_id').primaryKey(),
        productId: int('product_id').notNull(),
        quantityOrdered: int('quantity_ordered').notNull(),
    });
    
    const vipCustomerOrders = mysqlTable('vip_customer_orders', {
        customerId: int('customer_id').primaryKey(),
        productId: int('product_id').notNull(),
        quantityOrdered: int('quantity_ordered').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab>
  <Tab>
  Not supported by SQLite
  </Tab> 
  <Tab>
  Not supported by SingleStore
  </Tab> 
  <Tab>
  Not supported by MSSQL
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { intersectAll } from 'drizzle-orm/cockroach-core'
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const regularOrders = db.select({ 
        productId: regularCustomerOrders.productId,
        quantityOrdered: regularCustomerOrders.quantityOrdered }
    ).from(regularCustomerOrders);

    const vipOrders = db.select({ 
        productId: vipCustomerOrders.productId,
        quantityOrdered: vipCustomerOrders.quantityOrdered }
    ).from(vipCustomerOrders);

    const result = await intersectAll(regularOrders, vipOrders);
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    intersect all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
	</CodeTab>
    ```ts copy
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const result = await db
        .select({
          productId: regularCustomerOrders.productId,
          quantityOrdered: regularCustomerOrders.quantityOrdered,
        })
        .from(regularCustomerOrders)
        .intersectAll(
          db
            .select({
              productId: vipCustomerOrders.productId,
              quantityOrdered: vipCustomerOrders.quantityOrdered,
            })
            .from(vipCustomerOrders)
        );
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    intersect all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
    <CodeTab>
	```typescript copy
    import { int4, cockroachTable } from "drizzle-orm/cockroach-core";

    const regularCustomerOrders = cockroachTable('regular_customer_orders', {
        customerId: int4('customer_id').primaryKey(),
        productId: int4('product_id').notNull(),
        quantityOrdered: int4('quantity_ordered').notNull(),
    });
    
    const vipCustomerOrders = cockroachTable('vip_customer_orders', {
        customerId: int4('customer_id').primaryKey(),
        productId: int4('product_id').notNull(),
        quantityOrdered: int4('quantity_ordered').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
</Tabs>

### å·®é›†ï¼ˆExceptï¼‰
å¯¹äºä¸¤ä¸ªæŸ¥è¯¢å— A å’Œ Bï¼Œè¿”å›ä¸åœ¨ B ä¸­çš„ A çš„æ‰€æœ‰ç»“æœï¼Œçœç•¥ä»»ä½•é‡å¤é¡¹ã€‚

å‡è®¾ä½ æœ‰ä¸¤ä¸ªè¡¨å­˜å‚¨æœ‰å…³å‘˜å·¥é¡¹ç›®åˆ†é…çš„ä¿¡æ¯ã€‚
ä½ æƒ³æ‰¾åˆ°å”¯ä¸€å±äºä¸€ä¸ªéƒ¨é—¨å¹¶ä¸”ä¸ä¸å¦ä¸€ä¸ªéƒ¨é—¨å…±äº«çš„é¡¹ç›®ï¼Œ
æ’é™¤é‡å¤é¡¹ã€‚

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œä½ æƒ³è¯†åˆ«å”¯ä¸€å±äºä¸€ä¸ªéƒ¨é—¨è€Œä¸ä¸å¦ä¸€ä¸ªéƒ¨é—¨å…±äº«çš„é¡¹ç›®ã€‚
ä½ ä¸å¸Œæœ›åŒä¸€é¡¹ç›®è®¡æ•°å¤šæ¬¡ï¼Œ
å³ä½¿åŒä¸€éƒ¨é—¨çš„å¤šä¸ªå‘˜å·¥éƒ½è¢«åˆ†é…ç»™è¯¥é¡¹ç›®ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { except } from 'drizzle-orm/pg-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.projectsName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.projectsName }).from(depB);

    const result = await except(departmentACourses, departmentBCourses);
    ```
    ```sql
    select "projects_name" from "department_a_projects"
    except
    select "projects_name" from "department_b_projects"
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { depA, depB } from './schema'

    const result = await db
        .select({ courseName: depA.projectsName })
        .from(depA)
        .except(db.select({ courseName: depB.projectsName }).from(depB));
    ```
    ```sql
    select "projects_name" from "department_a_projects"
    except
    select "projects_name" from "department_b_projects"
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { integer, pgTable, varchar } from "drizzle-orm/pg-core";

    const depA = pgTable('department_a_projects', {
        employeeId: integer('employee_id'),
        projectsName: varchar('projects_name').notNull(),
    });
    
    const depB = pgTable('department_b_projects', {
        employeeId: integer('employee_id'),
        projectsName: varchar('projects_name').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { except } from 'drizzle-orm/mysql-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.projectsName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.projectsName }).from(depB);

    const result = await except(departmentACourses, departmentBCourses);
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    except
    select `projects_name` from `department_b_projects`
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { depA, depB } from './schema'

    const result = await db
        .select({ courseName: depA.projectsName })
        .from(depA)
        .except(db.select({ courseName: depB.projectsName }).from(depB));
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    except
    select `projects_name` from `department_b_projects`
    ```
    </CodeTab>
    <CodeTab>
	```typescript 
    import { int, mysqlTable, varchar } from "drizzle-orm/mysql-core";

    const depA = mysqlTable('department_a_projects', {
        employeeId: int('employee_id'),
        projectsName: varchar('projects_name', { length: 256 }).notNull(),
    });
    
    const depB = mysqlTable('department_b_projects', {
        employeeId: int('employee_id'),
        projectsName: varchar('projects_name', { length: 256 }).notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { except } from 'drizzle-orm/sqlite-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.projectsName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.projectsName }).from(depB);

    const result = await except(departmentACourses, departmentBCourses);
    ```
    ```sql
    select "projects_name" from "department_a_projects" 
    except 
    select "projects_name" from "department_b_projects"
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { depA, depB } from './schema'

    const result = await db
        .select({ courseName: depA.projectsName })
        .from(depA)
        .except(db.select({ courseName: depB.projectsName }).from(depB));
    ```
    ```sql
    select "projects_name" from "department_a_projects" 
    except 
    select "projects_name" from "department_b_projects"
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int, sqliteTable, text } from "drizzle-orm/sqlite-core";

    const depA = sqliteTable('department_a_projects', {
        employeeId: int('employee_id'),
        projectsName: text('projects_name').notNull(),
    });
    
    const depB = sqliteTable('department_b_projects', {
        employeeId: int('employee_id'),
        projectsName: text('projects_name').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { except } from 'drizzle-orm/singlestore-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.projectsName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.projectsName }).from(depB);

    const result = await except(departmentACourses, departmentBCourses);
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    except
    select `projects_name` from `department_b_projects`
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { depA, depB } from './schema'

    const result = await db
        .select({ courseName: depA.projectsName })
        .from(depA)
        .except(db.select({ courseName: depB.projectsName }).from(depB));
    ```
    ```sql
    select `projects_name` from `department_a_projects`
    except
    select `projects_name` from `department_b_projects`
    ```
    </CodeTab>
    <CodeTab>
	```typescript 
    import { int, singlestoreTable, varchar } from "drizzle-orm/singlestore-core";

    const depA = singlestoreTable('department_a_projects', {
        employeeId: int('employee_id'),
        projectsName: varchar('projects_name', { length: 256 }).notNull(),
    });
    
    const depB = singlestoreTable('department_b_projects', {
        employeeId: int('employee_id'),
        projectsName: varchar('projects_name', { length: 256 }).notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { except } from 'drizzle-orm/mssql-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.projectsName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.projectsName }).from(depB);

    const result = await except(departmentACourses, departmentBCourses);
    ```
    ```sql
    (select `projects_name` from `department_a_projects`)
    except
    (select `projects_name` from `department_b_projects`)
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { depA, depB } from './schema'

    const result = await db
        .select({ courseName: depA.projectsName })
        .from(depA)
        .except(db.select({ courseName: depB.projectsName }).from(depB));
    ```
    ```sql
    (select `projects_name` from `department_a_projects`)
    except
    (select `projects_name` from `department_b_projects`)
    ```
    </CodeTab>
    <CodeTab>
	```typescript 
    import { int, mssqlTable, nvarchar } from "drizzle-orm/mssql-core";

    const depA = mssqlTable('department_a_projects', {
        employeeId: int('employee_id'),
        projectsName: nvarchar('projects_name', { length: 256 }).notNull(),
    });
    
    const depB = mssqlTable('department_b_projects', {
        employeeId: int('employee_id'),
        projectsName: nvarchar('projects_name', { length: 256 }).notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { except } from 'drizzle-orm/cockroach-core'
    import { depA, depB } from './schema'

    const departmentACourses = db.select({ courseName: depA.projectsName }).from(depA);
    const departmentBCourses = db.select({ courseName: depB.projectsName }).from(depB);

    const result = await except(departmentACourses, departmentBCourses);
    ```
    ```sql
    select "projects_name" from "department_a_projects"
    except
    select "projects_name" from "department_b_projects"
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { depA, depB } from './schema'

    const result = await db
        .select({ courseName: depA.projectsName })
        .from(depA)
        .except(db.select({ courseName: depB.projectsName }).from(depB));
    ```
    ```sql
    select "projects_name" from "department_a_projects"
    except
    select "projects_name" from "department_b_projects"
    ```
    </CodeTab>
    <CodeTab>
	```typescript copy
    import { int4, cockroachTable, varchar } from "drizzle-orm/cockroach-core";

    const depA = cockroachTable('department_a_projects', {
        employeeId: int4('employee_id'),
        projectsName: varchar('projects_name').notNull(),
    });
    
    const depB = cockroachTable('department_b_projects', {
        employeeId: int4('employee_id'),
        projectsName: varchar('projects_name').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
</Tabs>

### å·®é›†æ‰€æœ‰ï¼ˆExcept Allï¼‰
å¯¹äºä¸¤ä¸ªæŸ¥è¯¢å— A å’Œ Bï¼Œè¿”å›ä¸åœ¨ B ä¸­çš„ A çš„æ‰€æœ‰ç»“æœï¼ŒåŒ…æ‹¬é‡å¤é¡¹ã€‚

è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œä½ æœ‰ä¸¤ä¸ªè¡¨åŒ…å«æœ‰å…³å®¢æˆ·è®¢å•çš„æ•°æ®ï¼Œ
ä½ æƒ³è¯†åˆ«ä»…æ™®é€šå®¢æˆ·ï¼ˆæ²¡æœ‰ VIP å®¢æˆ·ï¼‰ä¸‹å•çš„äº§å“ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¸Œæœ›ä¿ç•™æ¯ç§äº§å“çš„æ•°é‡ä¿¡æ¯ï¼Œå³ä½¿ä¸åŒçš„æ™®é€šå®¢æˆ·å¤šæ¬¡ä¸‹å•ã€‚

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œä½ å¸Œæœ›æ‰¾åˆ°ä»…ç”±æ™®é€šå®¢æˆ·ä¸‹å•çš„äº§å“ï¼Œå¹¶ä¸”ä¸ç”± VIP å®¢æˆ·ä¸‹å•ã€‚
ä½ å¸Œæœ›ä¿ç•™æ•°é‡ä¿¡æ¯ï¼Œå³ä½¿åŒä¸€äº§å“è¢«ä¸åŒçš„æ™®é€šå®¢æˆ·å¤šæ¬¡ä¸‹å•ã€‚

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { exceptAll } from 'drizzle-orm/pg-core'
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const regularOrders = db.select({ 
        productId: regularCustomerOrders.productId,
        quantityOrdered: regularCustomerOrders.quantityOrdered }
    ).from(regularCustomerOrders);

    const vipOrders = db.select({ 
        productId: vipCustomerOrders.productId,
        quantityOrdered: vipCustomerOrders.quantityOrdered }
    ).from(vipCustomerOrders);

    const result = await exceptAll(regularOrders, vipOrders);
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    except all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { regularCustomerOrders, vipCustomerOrders } from './schema'
 
    const result = await db
        .select({
          productId: regularCustomerOrders.productId,
          quantityOrdered: regularCustomerOrders.quantityOrdered,
        })
        .from(regularCustomerOrders)
        .exceptAll(
          db
            .select({
              productId: vipCustomerOrders.productId,
              quantityOrdered: vipCustomerOrders.quantityOrdered,
            })
            .from(vipCustomerOrders)
        );
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    except all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
    </CodeTab>
	<CodeTab>
	```typescript copy
    import { integer, pgTable } from "drizzle-orm/pg-core";

    const regularCustomerOrders = pgTable('regular_customer_orders', {
        customerId: integer('customer_id').primaryKey(),
        productId: integer('product_id').notNull(),
        quantityOrdered: integer('quantity_ordered').notNull(),
    });
    
    const vipCustomerOrders = pgTable('vip_customer_orders', {
        customerId: integer('customer_id').primaryKey(),
        productId: integer('product_id').notNull(),
        quantityOrdered: integer('quantity_ordered').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { exceptAll } from 'drizzle-orm/mysql-core'
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const regularOrders = db.select({ 
        productId: regularCustomerOrders.productId,
        quantityOrdered: regularCustomerOrders.quantityOrdered }
    ).from(regularCustomerOrders);

    const vipOrders = db.select({ 
        productId: vipCustomerOrders.productId,
        quantityOrdered: vipCustomerOrders.quantityOrdered }
    ).from(vipCustomerOrders);

    const result = await exceptAll(regularOrders, vipOrders);
    ```
    ```sql
    select `product_id`, `quantity_ordered` from `regular_customer_orders`
    except all
    select `product_id`, `quantity_ordered` from `vip_customer_orders`
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { regularCustomerOrders, vipCustomerOrders } from './schema'
 
    const result = await db
        .select({
          productId: regularCustomerOrders.productId,
          quantityOrdered: regularCustomerOrders.quantityOrdered,
        })
        .from(regularCustomerOrders)
        .exceptAll(
          db
            .select({
              productId: vipCustomerOrders.productId,
              quantityOrdered: vipCustomerOrders.quantityOrdered,
            })
            .from(vipCustomerOrders)
        );
    ```
    ```sql
    select `product_id`, `quantity_ordered` from `regular_customer_orders`
    except all
    select `product_id`, `quantity_ordered` from `vip_customer_orders`
    ```
    </CodeTab>
	<CodeTab>
	```typescript copy
    const regularCustomerOrders = mysqlTable('regular_customer_orders', {
        customerId: int('customer_id').primaryKey(),
        productId: int('product_id').notNull(),
        quantityOrdered: int('quantity_ordered').notNull(),
    });
    
    const vipCustomerOrders = mysqlTable('vip_customer_orders', {
        customerId: int('customer_id').primaryKey(),
        productId: int('product_id').notNull(),
        quantityOrdered: int('quantity_ordered').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
  <Tab>
  Not supported by SQLite
  </Tab>
  <Tab>
  Not supported by SingleStore
  </Tab>
  <Tab>
  Not supported by MSSQL
  </Tab>
  <Tab>
  <CodeTabs items={["import-pattern", "builder-pattern", "schema.ts"]}>
	<CodeTab>
	```typescript copy
    import { exceptAll } from 'drizzle-orm/cockroach-core'
    import { regularCustomerOrders, vipCustomerOrders } from './schema'

    const regularOrders = db.select({ 
        productId: regularCustomerOrders.productId,
        quantityOrdered: regularCustomerOrders.quantityOrdered }
    ).from(regularCustomerOrders);

    const vipOrders = db.select({ 
        productId: vipCustomerOrders.productId,
        quantityOrdered: vipCustomerOrders.quantityOrdered }
    ).from(vipCustomerOrders);

    const result = await exceptAll(regularOrders, vipOrders);
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    except all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
	</CodeTab>
    <CodeTab>
    ```ts copy
    import { regularCustomerOrders, vipCustomerOrders } from './schema'
 
    const result = await db
        .select({
          productId: regularCustomerOrders.productId,
          quantityOrdered: regularCustomerOrders.quantityOrdered,
        })
        .from(regularCustomerOrders)
        .exceptAll(
          db
            .select({
              productId: vipCustomerOrders.productId,
              quantityOrdered: vipCustomerOrders.quantityOrdered,
            })
            .from(vipCustomerOrders)
        );
    ```
    ```sql
    select "product_id", "quantity_ordered" from "regular_customer_orders"
    except all
    select "product_id", "quantity_ordered" from "vip_customer_orders"
    ```
    </CodeTab>
	<CodeTab>
	```typescript copy
    import { int4, cockroachTable } from "drizzle-orm/cockroach-core";

    const regularCustomerOrders = cockroachTable('regular_customer_orders', {
        customerId: int4('customer_id').primaryKey(),
        productId: int4('product_id').notNull(),
        quantityOrdered: int4('quantity_ordered').notNull(),
    });
    
    const vipCustomerOrders = cockroachTable('vip_customer_orders', {
        customerId: int4('customer_id').primaryKey(),
        productId: int4('product_id').notNull(),
        quantityOrdered: int4('quantity_ordered').notNull(),
    });
    ```
    </CodeTab>
  </CodeTabs>
  </Tab> 
</Tabs>


Source: https://drizzle.zhcndoc.com/docs/sql-schema-declaration

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import Callout from '@mdx/Callout.astro';
import SimpleLinkCards from '@mdx/SimpleLinkCards.astro';
import CodeTabs from "@mdx/CodeTabs.astro";
import Section from '@mdx/Section.astro';
import Flex from "@mdx/Flex.astro"
import LinksList from "@mdx/LinksList.astro"

# Drizzle æ¨¡å¼

Drizzle å…è®¸æ‚¨ä½¿ç”¨ TypeScript å®šä¹‰æ¨¡å¼ï¼Œæ”¯æŒåº•å±‚æ•°æ®åº“çš„å„ç§æ¨¡å‹å’Œå±æ€§ã€‚  
å½“æ‚¨å®šä¹‰æ¨¡å¼æ—¶ï¼Œå®ƒå°†ä½œä¸ºæœªæ¥æŸ¥è¯¢ï¼ˆä½¿ç”¨ Drizzle-ORMï¼‰å’Œè¿ç§»ï¼ˆä½¿ç”¨ Drizzle-Kitï¼‰  
ä¿®æ”¹çš„çœŸå®æ€§æºã€‚

<Callout> 
å¦‚æœæ‚¨ä½¿ç”¨ Drizzle-Kit è¿›è¡Œè¿ç§»è¿‡ç¨‹ï¼Œè¯·ç¡®ä¿ä»æ‚¨æ¨¡å¼æ–‡ä»¶ä¸­å¯¼å‡ºæ‰€æœ‰å®šä¹‰çš„æ¨¡å‹ï¼Œä»¥ä¾¿ Drizzle-Kit å¯ä»¥å¯¼å…¥å®ƒä»¬å¹¶åœ¨è¿ç§»å·®å¼‚è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
</Callout>

<CodeTabs items={["ä½¿ç”¨å¯¼å…¥", "ä½¿ç”¨å›è°ƒ", "ä½¿ç”¨ import *"]}>
```ts
import { integer, pgTable, varchar } from "drizzle-orm/pg-core";

export const usersTable = pgTable("users", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  name: varchar().notNull(),
  age: integer().notNull(),
  email: varchar().notNull().unique(),
});
```
```ts
import { pgTable } from "drizzle-orm/pg-core";

export const usersTable = pgTable("users", (t) => ({
  id: t.integer().primaryKey().generatedAlwaysAsIdentity(),
  name: t.varchar().notNull(),
  age: t.integer().notNull(),
  email: t.varchar().notNull().unique(),
}));
```
```ts
import * as p from "drizzle-orm/pg-core";

export const usersTable = p.pgTable("users", {
  id: p.integer().primaryKey().generatedAlwaysAsIdentity(),
  name: p.varchar().notNull(),
  age: p.integer().notNull(),
  email: p.varchar().notNull().unique(),
});
```
</CodeTabs>

## ç»„ç»‡æ‚¨çš„æ¨¡å¼æ–‡ä»¶  
æ‚¨å¯ä»¥å°† SQL æ¨¡å¼ç›´æ¥åœ¨ TypeScript ä¸­å£°æ˜ï¼Œæˆ–è€…å°†æ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ª `schema.ts` æ–‡ä»¶ä¸­ï¼Œ  
æˆ–è€…æ‚¨å¯ä»¥åˆ†æ•£å®ƒä»¬â€”â€”éšæ‚¨æ‰€æ„¿ï¼Œå®Œå…¨æ²¡æœ‰é™åˆ¶ï¼

#### å•æ–‡ä»¶ä¸­çš„æ¨¡å¼  
ä½¿ç”¨ Drizzle å£°æ˜æ¨¡å¼çš„æœ€å¸¸è§æ–¹æ³•æ˜¯å°†æ‰€æœ‰è¡¨æ”¾åœ¨ä¸€ä¸ª `schema.ts` æ–‡ä»¶ä¸­ã€‚

> æ³¨æ„ï¼šæ‚¨å¯ä»¥å°†æ¨¡å¼æ–‡ä»¶å‘½åä¸ºæ‚¨å–œæ¬¢çš„ä»»ä½•åç§°ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æ˜¯ `models.ts` æˆ–å…¶ä»–åç§°ã€‚

å¦‚æœæ‚¨æ²¡æœ‰å®šä¹‰å¤ªå¤šè¡¨æ¨¡å‹ï¼Œæˆ–è€…æ‚¨è®¤ä¸ºå°†å®ƒä»¬æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æ²¡æœ‰é—®é¢˜ï¼Œè¿™ç§æ–¹æ³•æ•ˆæœå¾ˆå¥½ã€‚

ç¤ºä¾‹ï¼š  
```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”” ğŸ“‚ src
    â”” ğŸ“‚ db
       â”” ğŸ“œ schema.ts
```

åœ¨ `drizzle.config.ts` æ–‡ä»¶ä¸­ï¼Œæ‚¨éœ€è¦æŒ‡å®šæ¨¡å¼æ–‡ä»¶çš„è·¯å¾„ã€‚  
é€šè¿‡æ­¤é…ç½®ï¼ŒDrizzle å°†ä» `schema.ts` æ–‡ä»¶è¯»å–å¹¶åœ¨è¿ç§»ç”Ÿæˆè¿‡ç¨‹ä¸­ä½¿ç”¨æ­¤ä¿¡æ¯ã€‚  
æœ‰å…³ `drizzle.config.ts` æ–‡ä»¶å’Œä½¿ç”¨ Drizzle è¿›è¡Œè¿ç§»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š[é“¾æ¥](/docs/drizzle-config-file)  
```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: 'postgresql', // 'mysql' | 'sqlite' | 'turso'
  schema: './src/db/schema.ts'
})
```

#### å¤šæ–‡ä»¶ä¸­çš„æ¨¡å¼

æ‚¨å¯ä»¥å°† Drizzle æ¨¡å‹ï¼ˆä¾‹å¦‚è¡¨ã€æšä¸¾ã€åºåˆ—ç­‰ï¼‰æ”¾ç½®åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ä»»ä½•æ‚¨æƒ³è¦çš„æ–‡ä»¶ä¸­ã€‚  
æ‚¨éœ€è¦ç¡®ä¿ä»è¿™äº›æ–‡ä»¶ä¸­å¯¼å‡ºæ‰€æœ‰æ¨¡å‹ï¼Œ  
ä»¥ä¾¿ Drizzle kit å¯ä»¥å¯¼å…¥å¹¶åœ¨è¿ç§»ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯å°†æ¯ä¸ªè¡¨åˆ†å¼€åˆ°è‡ªå·±çš„æ–‡ä»¶ä¸­ã€‚  
```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”” ğŸ“‚ src
    â”” ğŸ“‚ db
       â”” ğŸ“‚ schema
          â”œ ğŸ“œ users.ts
          â”œ ğŸ“œ countries.ts
          â”œ ğŸ“œ cities.ts
          â”œ ğŸ“œ products.ts
          â”œ ğŸ“œ clients.ts
          â”” ğŸ“œ etc.ts
```

åœ¨ `drizzle.config.ts` æ–‡ä»¶ä¸­ï¼Œæ‚¨éœ€è¦æŒ‡å®šæ¨¡å¼æ–‡ä»¶å¤¹çš„è·¯å¾„ã€‚  
é€šè¿‡æ­¤é…ç½®ï¼ŒDrizzle å°†ä» `schema` æ–‡ä»¶å¤¹è¯»å–å¹¶é€’å½’æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶ä»ä¸­è·å–æ‰€æœ‰ drizzle è¡¨ã€‚  
æœ‰å…³ `drizzle.config.ts` æ–‡ä»¶å’Œä½¿ç”¨ Drizzle è¿›è¡Œè¿ç§»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š[é“¾æ¥](/docs/drizzle-config-file)

```ts
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  dialect: 'postgresql', // 'mysql' | 'sqlite' | 'turso'
  schema: './src/db/schema'
})
```

æ‚¨è¿˜å¯ä»¥ä»¥ä»»ä½•æ‚¨å–œæ¬¢çš„æ–¹å¼å¯¹å®ƒä»¬è¿›è¡Œåˆ†ç»„ï¼Œä¾‹å¦‚ä¸ºç”¨æˆ·ç›¸å…³è¡¨ã€æ¶ˆæ¯ç›¸å…³è¡¨ã€äº§å“ç›¸å…³è¡¨ç­‰åˆ›å»ºç»„ã€‚  
```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”” ğŸ“‚ src
    â”” ğŸ“‚ db
       â”” ğŸ“‚ schema
          â”œ ğŸ“œ users.ts
          â”œ ğŸ“œ messaging.ts
          â”” ğŸ“œ products.ts
```

## å¡‘é€ æ‚¨çš„æ•°æ®æ¨¡å¼

Drizzle æ¨¡å¼ç”±æ‚¨æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“ä¸­çš„å‡ ç§æ¨¡å‹ç±»å‹æ„æˆã€‚ä½¿ç”¨ Drizzleï¼Œæ‚¨å¯ä»¥æŒ‡å®šï¼š  
- å«æœ‰åˆ—ã€çº¦æŸç­‰çš„è¡¨ã€‚  
- æ¨¡å¼ï¼ˆä»…é€‚ç”¨äº PostgreSQLï¼‰  
- æšä¸¾  
- åºåˆ—ï¼ˆä»…é€‚ç”¨äº PostgreSQLï¼‰  
- è§†å›¾  
- ææ–™åŒ–è§†å›¾  
- ç­‰ç­‰ã€‚

è®©æˆ‘ä»¬é€ä¸ªæ£€æŸ¥æ¨¡å¼å¦‚ä½•ä½¿ç”¨ Drizzle å®šä¹‰ã€‚

#### **è¡¨å’Œåˆ—å£°æ˜**

åœ¨ Drizzle ä¸­ï¼Œè¡¨åº”è‡³å°‘å®šä¹‰ 1 åˆ—ï¼Œæ­£å¦‚åœ¨æ•°æ®åº“ä¸­åº”åšçš„é‚£æ ·ã€‚æœ‰ä¸€ä»¶é‡è¦çš„äº‹éœ€è¦çŸ¥é“ï¼Œ  
Drizzle ä¸­æ²¡æœ‰é€šç”¨çš„è¡¨å¯¹è±¡ã€‚æ‚¨éœ€è¦é€‰æ‹©ä½¿ç”¨çš„æ–¹è¨€ï¼šPostgreSQLã€MySQL æˆ– SQLiteã€‚

![](@/assets/images/table-structure.svg)

<CodeTabs items={["PostgreSQL è¡¨", "MySQL è¡¨", "SQLite è¡¨"]}>
```ts copy
import { pgTable, integer } from "drizzle-orm/pg-core"

export const users = pgTable('users', {
  id: integer()
});
```
```ts copy
import { mysqlTable, int } from "drizzle-orm/mysql-core"

export const users = mysqlTable('users', {
  id: int()
});
```
```ts copy
import { sqliteTable, integer } from "drizzle-orm/sqlite-core"

export const users = sqliteTable('users', {
  id: integer()
});
```
</CodeTabs>

é»˜è®¤æƒ…å†µä¸‹ï¼ŒDrizzle å°†åœ¨æ•°æ®åº“æŸ¥è¯¢ä¸­ä½¿ç”¨ TypeScript é”®åä½œä¸ºåˆ—åã€‚  
å› æ­¤ï¼Œæ¥è‡ªç¤ºä¾‹çš„æ¨¡å¼å’ŒæŸ¥è¯¢å°†ç”Ÿæˆå¦‚ä¸‹ SQL æŸ¥è¯¢ã€‚

<Callout>
æ­¤ç¤ºä¾‹ä½¿ç”¨ä¸€ä¸ª db å¯¹è±¡ï¼Œä½†å…¶åˆå§‹åŒ–æœªåœ¨æœ¬éƒ¨åˆ†æ–‡æ¡£ä¸­è¦†ç›–ã€‚è¦äº†è§£å¦‚ä½•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·å‚é˜… [è¿æ¥æ–‡æ¡£](/docs/get-started-postgresql)
</Callout>

\
**TypeScript é”® = æ•°æ®åº“é”®**  
<Section>
```ts
// schema.ts
import { integer, pgTable, varchar } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
  id: integer(),
  first_name: varchar()
})
```
```ts
// query.ts
await db.select().from(users);
```
```sql
SELECT "id", "first_name" from users;
```
</Section>

å¦‚æœæ‚¨æƒ³åœ¨ TypeScript ä»£ç ä¸­å’Œæ•°æ®åº“ä¸­ä½¿ç”¨ä¸åŒçš„åç§°ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åˆ—åˆ«åã€‚

<Section>
```ts
// schema.ts
import { integer, pgTable, varchar } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
  id: integer(),
  firstName: varchar('first_name')
})
```
```ts
// query.ts
await db.select().from(users);
```
```sql
SELECT "id", "first_name" from users;
```
</Section>

### é©¼å³°å’Œè›‡å½¢å‘½å

æ•°æ®åº“æ¨¡å‹åç§°é€šå¸¸ä½¿ç”¨ `snake_case` çº¦å®šï¼Œè€Œåœ¨ TypeScript ä¸­ï¼Œå¸¸ç”¨ `camelCase` è¿›è¡Œå‘½åã€‚  
è¿™å¯èƒ½ä¼šå¯¼è‡´æ¨¡å¼ä¸­æœ‰å¾ˆå¤šåˆ«åå®šä¹‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ  
Drizzle æä¾›äº†ä¸€ç§æ–¹æ³•æ¥è‡ªåŠ¨å°† TypeScript ä¸­çš„ `camelCase` æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„ `snake_case`ï¼Œé€šè¿‡åœ¨ Drizzle æ•°æ®åº“åˆå§‹åŒ–æ—¶åŒ…å«ä¸€ä¸ªå¯é€‰å‚æ•°ã€‚

å¯¹äºè¿™ç§æ˜ å°„ï¼Œæ‚¨å¯ä»¥åœ¨ Drizzle DB å£°æ˜ä¸­ä½¿ç”¨ `casing` é€‰é¡¹ã€‚  
æ­¤å‚æ•°å°†å¸®åŠ©æ‚¨æŒ‡å®šæ•°æ®åº“æ¨¡å‹å‘½åçº¦å®šï¼Œå¹¶å°†å°è¯•ç›¸åº”åœ°æ˜ å°„æ‰€æœ‰ JavaScript é”®ã€‚

<Section>
```ts
// schema.ts
import { drizzle } from "drizzle-orm/node-postgres";
import { integer, pgTable, varchar } from "drizzle-orm/pg-core";

export const users = pgTable('users', {
  id: integer(),
  firstName: varchar()
})
```
```ts
// db.ts
const db = drizzle({ connection: process.env.DATABASE_URL, casing: 'snake_case' })
```
```ts
// query.ts
await db.select().from(users);
```
```sql
SELECT "id", "first_name" from users;
```
</Section>

### é«˜çº§

ä½¿ç”¨ Drizzle ORM æ‚¨å¯ä»¥ä½¿ç”¨ä¸€äº›æŠ€å·§ã€‚åªè¦ Drizzle å®Œå…¨åœ¨ TypeScript æ–‡ä»¶ä¸­ï¼Œ  
æ‚¨å°±å¯ä»¥åƒåœ¨ç®€å•çš„ TypeScript é¡¹ç›®ä¸­ä¸€æ ·è¿›è¡Œä»»ä½•ç¼–ç ã€‚

ä¸€ä¸ªå¸¸è§çš„ç‰¹æ€§æ˜¯å°†åˆ—åˆ†ç¦»åˆ°ä¸åŒçš„ä½ç½®ï¼Œç„¶åé‡å¤ä½¿ç”¨å®ƒä»¬ã€‚  
ä¾‹å¦‚ï¼Œè€ƒè™‘å­—æ®µ `updated_at`ã€`created_at` å’Œ `deleted_at`ã€‚  
è®¸å¤šè¡¨/æ¨¡å‹å¯èƒ½éœ€è¦è¿™ä¸‰ä¸ªå­—æ®µæ¥è·Ÿè¸ªå’Œåˆ†æç³»ç»Ÿä¸­å®ä½“çš„åˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­å®šä¹‰è¿™äº›åˆ—ï¼Œç„¶ååœ¨æ‰€æœ‰è¡¨å¯¹è±¡ä¸­å¯¼å…¥å¹¶å±•å¼€å®ƒä»¬ã€‚

<Section>
```ts
// columns.helpers.ts
const timestamps = {
  updated_at: timestamp(),
  created_at: timestamp().defaultNow().notNull(),
  deleted_at: timestamp(),
}
```
```ts
// users.sql.ts
export const users = pgTable('users', {
  id: integer(),
  ...timestamps
})
```
```ts
// posts.sql.ts
export const posts = pgTable('posts', {
  id: integer(),
  ...timestamps
})
```
</Section>

#### **æ¨¡å¼**

<Tabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
<Tab>
\
åœ¨ PostgreSQL ä¸­ï¼Œæœ‰ä¸€ä¸ªå®ä½“ç§°ä¸º `schema`ï¼ˆæˆ‘ä»¬è®¤ä¸ºåº”è¯¥ç§°ä¸º `folders`ï¼‰ã€‚è¿™åœ¨ PostgreSQL ä¸­åˆ›å»ºäº†ä¸€ä¸ªç»“æ„ï¼š

![](@/assets/images/postgresql-db-structure.png)

æ‚¨å¯ä»¥ä½¿ç”¨ `pgSchema` ç®¡ç† PostgreSQL æ¨¡å¼ï¼Œå¹¶å°†ä»»ä½•å…¶ä»–æ¨¡å‹æ”¾å…¥å…¶ä¸­ã€‚

ä½¿ç”¨ Drizzle å®šä¹‰æ‚¨æƒ³è¦ç®¡ç†çš„æ¨¡å¼  
```ts
import { pgSchema } from "drizzle-orm/pg-core"

export const customSchema = pgSchema('custom');
```

ç„¶åå°†è¡¨æ”¾å…¥æ¨¡å¼å¯¹è±¡ä¸­  
```ts {5-7}
import { integer, pgSchema } from "drizzle-orm/pg-core";

export const customSchema = pgSchema('custom');

export const users = customSchema.table('users', {
  id: integer()
})
```
</Tab>
<Tab>
\
åœ¨ MySQL ä¸­ï¼Œæœ‰ä¸€ä¸ªå®ä½“ç§°ä¸º `Schema`ï¼Œä½†åœ¨ MySQL æœ¯è¯­ä¸­ï¼Œç›¸å½“äº `Database`ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-orm` å®šä¹‰å®ƒä»¬å¹¶åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ï¼Œä½†å®ƒä»¬ä¸ä¼šè¢« `drizzle-kit` æ£€æµ‹åˆ°æˆ–åŒ…å«åœ¨è¿ç§»æµä¸­ã€‚

![](@/assets/images/mysql-db-structure.png)

ä½¿ç”¨ Drizzle å®šä¹‰æ‚¨æƒ³è¦ç®¡ç†çš„æ¨¡å¼  
```ts
import { mysqlSchema } from "drizzle-orm/mysql-core"

export const customSchema = mysqlSchema('custom');
```

ç„¶åå°†è¡¨æ”¾å…¥æ¨¡å¼å¯¹è±¡ä¸­  
```ts {5-7}
import { int, mysqlSchema } from "drizzle-orm/mysql-core";

export const customSchema = mysqlSchema('custom');

export const users = customSchema.table('users', {
  id: int()
})
```
</Tab>
<Tab>
\
åœ¨ SQLite ä¸­ï¼Œæ²¡æœ‰æ¨¡å¼çš„æ¦‚å¿µï¼Œå› æ­¤æ‚¨åªèƒ½åœ¨å•ä¸ª SQLite æ–‡ä»¶ä¸Šä¸‹æ–‡ä¸­å®šä¹‰è¡¨ã€‚

![](@/assets/images/sqlite-db-structure.png)
</Tab>
</Tabs>

### ç¤ºä¾‹

ä¸€æ—¦æ‚¨æŒæ¡äº†åŸºç¡€çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬ä¸ºä¸€ä¸ªå®é™…é¡¹ç›®å®šä¹‰ä¸€ä¸ªæ¨¡å¼ç¤ºä¾‹ï¼Œä»¥è·å¾—æ›´å¥½çš„è§†å›¾å’Œç†è§£ã€‚

> æ‰€æœ‰ç¤ºä¾‹å°†ä½¿ç”¨ `generateUniqueString`ã€‚å…¶å®ç°å°†åœ¨æ‰€æœ‰æ¨¡å¼ç¤ºä¾‹ä¹‹åæä¾›ã€‚

<CodeTabs items={['PostgreSQL', 'MySQL', 'SQLite']}>
```ts copy
import { AnyPgColumn } from "drizzle-orm/pg-core";
import { pgEnum, pgTable as table } from "drizzle-orm/pg-core";
import * as t from "drizzle-orm/pg-core";

export const rolesEnum = pgEnum("roles", ["guest", "user", "admin"]);

export const users = table(
  "users",
  {
    id: t.integer().primaryKey().generatedAlwaysAsIdentity(),
    firstName: t.varchar("first_name", { length: 256 }),
    lastName: t.varchar("last_name", { length: 256 }),
    email: t.varchar().notNull(),
    invitee: t.integer().references((): AnyPgColumn => users.id),
    role: rolesEnum().default("guest"),
  },
  (table) => [
    t.uniqueIndex("email_idx").on(table.email)
  ]
);

export const posts = table(
  "posts",
  {
    id: t.integer().primaryKey().generatedAlwaysAsIdentity(),
    slug: t.varchar().$default(() => generateUniqueString(16)),
    title: t.varchar({ length: 256 }),
    ownerId: t.integer("owner_id").references(() => users.id),
  },
  (table) => [
    t.uniqueIndex("slug_idx").on(table.slug),
    t.index("title_idx").on(table.title),
  ]
);

export const comments = table("comments", {
  id: t.integer().primaryKey().generatedAlwaysAsIdentity(),
  text: t.varchar({ length: 256 }),
  postId: t.integer("post_id").references(() => posts.id),
  ownerId: t.integer("owner_id").references(() => users.id),
});
```
```ts copy
import { mysqlTable as table } from "drizzle-orm/mysql-core";
import * as t from "drizzle-orm/mysql-core";
import { AnyMySqlColumn } from "drizzle-orm/mysql-core";

export const users = table(
  "users",
  {
    id: t.int().primaryKey().autoincrement(),
    firstName: t.varchar("first_name", { length: 256 }),
    lastName: t.varchar("last_name", { length: 256 }),
    email: t.varchar({ length: 256 }).notNull(),
    invitee: t.int().references((): AnyMySqlColumn => users.id),
    role: t.mysqlEnum(["guest", "user", "admin"]).default("guest"),
  },
  (table) => [
    t.uniqueIndex("email_idx").on(table.email)
  ]
);

export const posts = table(
  "posts",
  {
    id: t.int().primaryKey().autoincrement(),
    slug: t.varchar({ length: 256 }).$default(() => generateUniqueString(16)),
    title: t.varchar({ length: 256 }),
    ownerId: t.int("owner_id").references(() => users.id),
  },
  (table) => [
    t.uniqueIndex("slug_idx").on(table.slug),
    t.index("title_idx").on(table.title),
  ]
);

export const comments = table("comments", {
  id: t.int().primaryKey().autoincrement(),
  text: t.varchar({ length: 256 }),
  postId: t.int("post_id").references(() => posts.id),
  ownerId: t.int("owner_id").references(() => users.id),
});
```
```ts copy
import { sqliteTable as table } from "drizzle-orm/sqlite-core";
import * as t from "drizzle-orm/sqlite-core";
import { AnySQLiteColumn } from "drizzle-orm/sqlite-core";

export const users = table(
  "users",
  {
    id: t.int().primaryKey({ autoIncrement: true }),
    firstName: t.text("first_name"),
    lastName: t.text("last_name"),
    email: t.text().notNull(),
    invitee: t.int().references((): AnySQLiteColumn => users.id),
    role: t.text().$type<"guest" | "user" | "admin">().default("guest"),
  },
  (table) => [
    t.uniqueIndex("email_idx").on(table.email)
  ]
);

export const posts = table(
  "posts",
  {
    id: t.int().primaryKey({ autoIncrement: true }),
    slug: t.text().$default(() => generateUniqueString(16)),
    title: t.text(),
    ownerId: t.int("owner_id").references(() => users.id),
  },
  (table) => [
    t.uniqueIndex("slug_idx").on(table.slug),
    t.index("title_idx").on(table.title),
  ]
);

export const comments = table("comments", {
  id: t.int().primaryKey({ autoIncrement: true }),
  text: t.text({ length: 256 }),
  postId: t.int("post_id").references(() => posts.id),
  ownerId: t.int("owner_id").references(() => users.id),
});
```
</CodeTabs>

**`generateUniqueString` å®ç°ï¼š**  
```ts
function generateUniqueString(length: number = 12): string {
  const characters =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let uniqueString = "";

  for (let i = 0; i < length; i++) {
    const randomIndex = Math.floor(Math.random() * characters.length);
    uniqueString += characters[randomIndex];
  }

  return uniqueString;
}
```

#### æ¥ä¸‹æ¥åšä»€ä¹ˆï¼Ÿ  
<br/>
<Flex>
  <LinksList 
    title='ç®¡ç†æ¨¡å¼'
    links={[
        ["åˆ—ç±»å‹", "/docs/column-types/pg"], 
        ["ç´¢å¼•å’Œçº¦æŸ", "/docs/indexes-constraints"],
        ["æ•°æ®åº“è§†å›¾", "/docs/views"],
        ["æ•°æ®åº“æ¨¡å¼", "/docs/schemas"],
        ["åºåˆ—", "/docs/sequences"],
        ["æ‰©å±•", "/docs/extensions/pg"],
      ]}
  />
  <LinksList 
    title='ä»é›¶åˆ°è‹±é›„'
    links={[
        ["æ•°æ®åº“è¿æ¥", "/docs/connect-overview"], 
        ["æ•°æ®æŸ¥è¯¢", "/docs/data-querying"], 
        ["è¿ç§»", "/docs/migrations"], 
      ]}
  />
</Flex>

Source: https://drizzle.zhcndoc.com/docs/sql

import Callout from '@mdx/Callout.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import CodeTab from '@mdx/CodeTab.astro';
import Section from '@mdx/Section.astro';

# ç¥å¥‡çš„ `sql` æ“ä½œç¬¦ ğŸª„

åœ¨ä½¿ç”¨ ORM åº“æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨æä¾›çš„ ORM è¯­æ³•ç¼–å†™ç‰¹å®šæŸ¥è¯¢ä¼šæ„Ÿåˆ°å›°éš¾ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨åŸå§‹æŸ¥è¯¢ï¼Œ
è¿™æ„å‘³ç€æ„é€ ä¸€ä¸ªåŸå§‹å­—ç¬¦ä¸²å½¢å¼çš„æŸ¥è¯¢ã€‚
ç„¶è€Œï¼ŒåŸå§‹æŸ¥è¯¢å¾€å¾€ç¼ºä¹ç±»å‹å®‰å…¨å’ŒæŸ¥è¯¢å‚æ•°åŒ–çš„å¥½å¤„ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®¸å¤šåº“å¼•å…¥äº† `sql` æ¨¡æ¿çš„æ¦‚å¿µã€‚
è¿™ä¸ªæ¨¡æ¿å…è®¸ä½ ç¼–å†™æ›´åŠ ç±»å‹å®‰å…¨å’Œå‚æ•°åŒ–çš„æŸ¥è¯¢ï¼Œå¢å¼ºä»£ç çš„æ•´ä½“å®‰å…¨æ€§å’Œçµæ´»æ€§ã€‚
Drizzle ä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„ ORM åº“ï¼Œä¹Ÿæ”¯æŒ SQL æ¨¡æ¿ã€‚

é€šè¿‡ Drizzle çš„ `sql` æ¨¡æ¿ï¼Œä½ å¯ä»¥åœ¨æ„å»ºæŸ¥è¯¢æ—¶æ›´è¿›ä¸€æ­¥ã€‚
å¦‚æœåœ¨ä½¿ç”¨åº“çš„æŸ¥è¯¢æ„å»ºå™¨ç¼–å†™æ•´ä¸ªæŸ¥è¯¢æ—¶é‡åˆ°å›°éš¾ï¼Œ
ä½ å¯ä»¥åœ¨ Drizzle æŸ¥è¯¢çš„ç‰¹å®šéƒ¨åˆ†é€‰æ‹©æ€§ä½¿ç”¨ `sql` æ¨¡æ¿ã€‚
è¿™ç§çµæ´»æ€§ä½¿ä½ èƒ½å¤Ÿåœ¨éƒ¨åˆ† SELECT è¯­å¥ã€WHERE å­å¥ã€ORDER BY å­å¥ã€HAVING å­å¥ã€GROUP BY å­å¥ï¼Œ
ç”šè‡³å…³ç³»æŸ¥è¯¢æ„å»ºå™¨ä¸­ä½¿ç”¨ SQL æ¨¡æ¿ã€‚

åˆ©ç”¨ Drizzle ä¸­ SQL æ¨¡æ¿çš„èƒ½åŠ›ï¼Œä½ å¯ä»¥ç»´æŒç±»å‹å®‰å…¨å’ŒæŸ¥è¯¢å‚æ•°åŒ–çš„ä¼˜ç‚¹ï¼Œ
åŒæ—¶å®ç°æ‰€éœ€çš„æŸ¥è¯¢ç»“æ„å’Œå¤æ‚æ€§ã€‚
è¿™ä½¿ä½ èƒ½å¤Ÿåœ¨åº”ç”¨ç¨‹åºä¸­åˆ›å»ºæ›´å¥å£®å’Œå¯ç»´æŠ¤çš„ä»£ç ã€‚

## sql`` æ¨¡æ¿

åœ¨å…¶ä»– ORM ä¸­ï¼Œ
ä½ å¯èƒ½ä¼šé‡åˆ°çš„ä¸€ä¸ªæœ€å¸¸è§çš„ç”¨æ³•æ˜¯èƒ½å¤Ÿç›´æ¥ä½¿ç”¨ `sql` æŸ¥è¯¢è¿›è¡ŒåŸå§‹æŸ¥è¯¢ã€‚

```typescript copy
import { sql } from 'drizzle-orm' 

const id = 69;
await db.execute(sql`select * from ${usersTable} where ${usersTable.id} = ${id}`)
```

å®ƒå°†ç”Ÿæˆå½“å‰æŸ¥è¯¢

```sql
select * from "users" where "users"."id" = $1; --> [69]
```

ä»»ä½•æä¾›ç»™ sql å‚æ•°çš„è¡¨å’Œåˆ—éƒ½ä¼šè‡ªåŠ¨æ˜ å°„åˆ°ç›¸åº”çš„ SQL è¯­æ³•ï¼Œ
è¡¨åä¼šè¿›è¡Œè½¬ä¹‰ï¼Œå¹¶ä¸”è½¬ä¹‰çš„è¡¨åä¼šé™„åŠ åˆ°åˆ—åä¸Šã€‚

æ­¤å¤–ï¼Œä»»ä½•åŠ¨æ€å‚æ•°ä¾‹å¦‚ `${id}` å°†æ˜ å°„åˆ° $1 å ä½ç¬¦ï¼Œ
å¹¶ä¸”ç›¸åº”çš„å€¼å°†è¢«ç§»åŠ¨åˆ°ä¸€ä¸ªå•ç‹¬ä¼ é€’ç»™æ•°æ®åº“çš„å€¼æ•°ç»„ä¸­ã€‚

è¿™ç§æ–¹æ³•æœ‰æ•ˆåœ°é˜²æ­¢äº†ä»»ä½•æ½œåœ¨çš„ SQL æ³¨å…¥æ¼æ´ã€‚

## `sql<T>`

<Callout type="info" emoji="â„¹ï¸">
    è¯·æ³¨æ„ï¼Œ`sql<T>` ä¸è¿›è¡Œä»»ä½•è¿è¡Œæ—¶æ˜ å°„ã€‚
    ä½ ä½¿ç”¨ `sql<T>` å®šä¹‰çš„ç±»å‹ä»…ä»…æ˜¯ Drizzle çš„è¾…åŠ©å·¥å…·ã€‚
    ç†è§£æ²¡æœ‰å¯è¡Œçš„æ–¹æ³•åŠ¨æ€ç¡®å®šç¡®åˆ‡ç±»å‹æ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸º SQL æŸ¥è¯¢å¯ä»¥éå¸¸å¤šæ ·ä¸”å¯å®šåˆ¶ã€‚
</Callout>

ä½ å¯ä»¥åœ¨ Drizzle ä¸­å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹ï¼Œç”¨äºå­—æ®µè¦æ±‚ç‰¹å®šç±»å‹è€Œä¸æ˜¯ `unknown` çš„åœ°æ–¹ã€‚

æ­¤åŠŸèƒ½åœ¨éƒ¨åˆ†é€‰æ‹©æŸ¥è¯¢ä¸­å°¤å…¶æœ‰ç”¨ï¼Œç¡®ä¿æ‰€é€‰å­—æ®µçš„ä¸€è‡´ç±»å‹ï¼š

```typescript
// æœªå®šä¹‰ sql<T> ç±»å‹
const response: { lowerName: unknown }[] = await db.select({
    lowerName: sql`lower(${usersTable.id})`
}).from(usersTable);

// å®šä¹‰äº† sql<T> ç±»å‹
const response: { lowerName: string }[] = await db.select({
    lowerName: sql<string>`lower(${usersTable.id})`
}).from(usersTable);
```

## `sql``.mapWith()`

å¯¹äºéœ€è¦å¯¹ä»æ•°æ®åº“é©±åŠ¨ä¼ é€’ç»™ Drizzle çš„å€¼è¿›è¡Œè¿è¡Œæ—¶æ˜ å°„çš„æƒ…å†µï¼Œä½ å¯ä»¥ä½¿ç”¨ `.mapWith()`

æ­¤å‡½æ•°æ¥å—ä¸åŒçš„å€¼ï¼Œå°†åœ¨è¿è¡Œæ—¶æ˜ å°„å“åº”ã€‚

æ‚¨å¯ä»¥å¤åˆ¶ç‰¹å®šçš„åˆ—æ˜ å°„ç­–ç•¥ï¼Œ
åªè¦ mapWith å†…éƒ¨çš„æ¥å£ä¸ Column å®ç°çš„æ¥å£ç›¸åŒã€‚

```typescript
const usersTable = pgTable('users', {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
});

// åœ¨è¿è¡Œæ—¶ï¼Œè¿™äº›å€¼å°†ä¸ Drizzle ä¸­çš„ `text` åˆ—æ˜ å°„ç›¸åŒ
sql`...`.mapWith(usersTable.name);
```

ä½ è¿˜å¯ä»¥ä¸º `DriverValueDecoder` æ¥å£ä¼ é€’è‡ªå·±çš„å®ç°ï¼š

```ts 
sql``.mapWith({
	mapFromDriverValue: (value: any) => {
		const mappedValue = value;
		// ä½ æƒ³è¦åº”ç”¨çš„æ˜ å°„
		return mappedValue;
	},
});
    
// æˆ–è€…
sql``.mapWith(Number);
```

## `sql``.as<T>()`

åœ¨ä¸åŒåœºæ™¯ä¸­ï¼Œæœ‰æ—¶ç¡®å®šå¸Œæœ›ä½¿ç”¨çš„è‡ªå®šä¹‰å­—æ®µçš„åç§°å¯èƒ½å¾ˆå…·æŒ‘æˆ˜æ€§ã€‚
ä½ å¯èƒ½ä¼šé‡åˆ°éœ€è¦æ˜ç¡®ä¸ºè¦è¢«é€‰æ‹©çš„å­—æ®µæŒ‡å®šåˆ«åçš„æƒ…å†µã€‚
è¿™åœ¨å¤„ç†å¤æ‚æŸ¥è¯¢æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚

ä¸ºäº†è§£å†³è¿™äº›æƒ…å†µï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæœ‰ç”¨çš„ `.as('alias_name')` åŠ©æ‰‹ï¼Œ
å…è®¸ä½ æ˜ç¡®åœ°å®šä¹‰åˆ«åã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œä½ å¯ä»¥ä¸ºå­—æ®µæä¾›æ¸…æ™°æœ‰æ„ä¹‰çš„åç§°ï¼Œ
ä½¿ä½ çš„æŸ¥è¯¢æ›´åŠ ç›´è§‚å¯è¯»ã€‚

<Section>
```typescript
sql`lower(usersTable.name)`.as('lower_name')
```
```sql
... "usersTable"."name" as lower_name ...
```
</Section>

## `sql.raw()`

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¸éœ€è¦æ ¹æ®è¾“å…¥åˆ›å»ºå‚æ•°åŒ–å€¼æˆ–å°†è¡¨/åˆ—æ˜ å°„ä¸ºè½¬ä¹‰çš„ã€‚
ç›¸åï¼Œä½ å¯èƒ½åªæƒ³ç”ŸæˆåŸå§‹æŸ¥è¯¢ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æä¾›äº† `sql.raw()` å‡½æ•°ã€‚

`sql.raw()` å‡½æ•°å…è®¸ä½ åœ¨æŸ¥è¯¢ä¸­åŒ…å«åŸå§‹ SQL è¯­å¥ï¼Œ
è€Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„å¤„ç†æˆ–è½¬ä¹‰ã€‚
æ­¤åŠŸèƒ½åœ¨ä½ æœ‰é¢„æ„é€ çš„ SQL è¯­å¥æˆ–å½“ä½ éœ€è¦ç›´æ¥å°†å¤æ‚æˆ–åŠ¨æ€ SQL ä»£ç çº³å…¥æŸ¥è¯¢æ—¶éå¸¸æœ‰ç”¨ã€‚

<Section>
```typescript
sql.raw(`select * from users where id = ${12}`);
// ä¸
sql`select * from users where id = ${12}`;
```
```sql
select * from users where id = 12;
--> ä¸
select * from users where id = $1; --> [12]
```
</Section>

ä½ è¿˜å¯ä»¥åœ¨ sql å‡½æ•°ä¸­åˆ©ç”¨ `sql.raw()`ï¼Œä½¿ä½ èƒ½å¤Ÿç›´æ¥åŒ…å«ä»»ä½•åŸå§‹å­—ç¬¦ä¸²ï¼Œ
è€Œæ— éœ€é€šè¿‡ä¸» `sql` æ¨¡æ¿å‡½æ•°è¿›è¡Œè½¬ä¹‰ã€‚

é€šè¿‡åœ¨ `sql` å‡½æ•°å†…éƒ¨ä½¿ç”¨ `sql.raw()`ï¼Œä½ å¯ä»¥å°†æœªç»è½¬ä¹‰çš„åŸå§‹å­—ç¬¦ä¸²ç›´æ¥å¹¶å…¥ä½ çš„æŸ¥è¯¢ã€‚
è¿™åœ¨ä½ æœ‰ç‰¹å®šçš„ SQL ä»£ç æˆ–è¡¨è¾¾å¼æ—¶éå¸¸æœ‰ç”¨ï¼Œ
éœ€è¦ä¿æŒä¸è¢«æ¨¡æ¿å‡½æ•°çš„è‡ªåŠ¨è½¬ä¹‰æˆ–ä¿®æ”¹ã€‚

<Section>
```typescript
sql`select * from ${usersTable} where id = ${12}`;
// ä¸
sql`select * from ${usersTable} where id = ${sql.raw(12)}`;
```
```sql
select * from "users" where id = $1; --> [12]
--> ä¸
select * from "users" where id = 12;
```
</Section>

## sql.fromList()

`sql` æ¨¡æ¿ç”Ÿæˆ SQL å—ï¼Œå®ƒä»¬æ˜¯ SQL éƒ¨åˆ†çš„æ•°ç»„ï¼Œ
åœ¨å°† SQL åº”ç”¨åˆ°æ•°æ®åº“æˆ– Drizzle çš„æŸ¥è¯¢åï¼Œå°†è¢«è¿æ¥åˆ°æŸ¥è¯¢å’Œå‚æ•°ä¸­ã€‚

åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘å°†è¿™äº›å—èšåˆåˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œ
ç„¶åå°†å®ƒä»¬è¿æ¥æˆä¸€ä¸ªå¯ä»¥ä¼ é€’ç»™æ•°æ®åº“æˆ–æŸ¥è¯¢çš„å•ä¸€ SQL è¯­å¥ã€‚
å¯¹äºè¿™ç§æƒ…å†µï¼ŒfromList å‡½æ•°éå¸¸æœ‰ç”¨ã€‚

fromList å‡½æ•°å…è®¸ä½ å°†å¤šä¸ª SQL å—ç»„åˆæˆä¸€ä¸ªå•ä¸€çš„ SQL è¯­å¥ã€‚
ä½ å¯ä»¥æ ¹æ®ç‰¹å®šè¦æ±‚èšåˆå¹¶è¿æ¥ä¸ªåˆ« SQL éƒ¨åˆ†ï¼Œ
ç„¶åè·å¾—ä¸€ä¸ªç»Ÿä¸€çš„ SQL æŸ¥è¯¢ï¼Œå¯ä»¥æ‰§è¡Œã€‚

<Section>
```typescript
const sqlChunks: SQL[] = [];

sqlChunks.push(sql`select * from users`);

// ä¸€äº›é€»è¾‘

sqlChunks.push(sql` where `);

// ä¸€äº›é€»è¾‘

for (let i = 0; i < 5; i++) {
	sqlChunks.push(sql`id = ${i}`);

	if (i === 4) continue;
	sqlChunks.push(sql` or `);
}

const finalSql: SQL = sql.fromList(sqlChunks)
```
```sql
select * from users where id = $1 or id = $2 or id = $3 or id = $4 or id = $5; --> [0, 1, 2, 3, 4]
```
</Section>

## sql.join()

äº‹å®ä¸Šï¼Œ`sql.join` å‡½æ•°çš„ä½œç”¨ä¸ fromList åŠ©æ‰‹ç›¸ä¼¼ã€‚
ç„¶è€Œï¼Œåœ¨å¤„ç†ä¸¤è€…ä¹‹é—´çš„ç©ºé—´æ—¶ï¼Œå®ƒæä¾›äº†é¢å¤–çš„çµæ´»æ€§
SQL å—æˆ–æŒ‡å®šç”¨äºè¿æ¥ SQL å—çš„è‡ªå®šä¹‰åˆ†éš”ç¬¦ã€‚

ä½¿ç”¨ `sql.join`ï¼Œä½ å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ†éš”ç¬¦è¿æ¥ SQL å—ã€‚
æ­¤åˆ†éš”ç¬¦å¯ä»¥æ˜¯ä»»ä½•ä½ å¸Œæœ›åœ¨å—ä¹‹é—´æ’å…¥çš„å­—ç¬¦ä¸²æˆ–å­—ç¬¦ã€‚

å½“ä½ å¯¹ SQL å—çš„æ ¼å¼æˆ–åˆ†éš”æœ‰ç‰¹å®šè¦æ±‚æ—¶ï¼Œè¿™ç‰¹åˆ«æœ‰ç”¨ã€‚
é€šè¿‡æŒ‡å®šè‡ªå®šä¹‰åˆ†éš”ç¬¦ï¼Œ
ä½ å¯ä»¥åœ¨æœ€ç»ˆçš„ SQL æŸ¥è¯¢ä¸­å®ç°æ‰€éœ€çš„ç»“æ„å’Œæ ¼å¼ã€‚

<Section>
```typescript
const sqlChunks: SQL[] = [];

sqlChunks.push(sql`select * from users`);

// ä¸€äº›é€»è¾‘

sqlChunks.push(sql`where`);

// ä¸€äº›é€»è¾‘

for (let i = 0; i < 5; i++) {
	sqlChunks.push(sql`id = ${i}`);

	if (i === 4) continue;
    sqlChunks.push(sql`or`);
}

const finalSql: SQL = sql.join(sqlChunks, sql.raw(' '));
```
```sql
select * from users where id = $1 or id = $2 or id = $3 or id = $4 or id = $5; --> [0, 1, 2, 3, 4]
```
</Section>

## sql.append()

å¦‚æœä½ å·²ç»ä½¿ç”¨ `sql` æ¨¡æ¿ç”Ÿæˆäº† SQLï¼Œ
ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ append å‡½æ•°ç›´æ¥å°†æ–°å—æ·»åŠ åˆ°ç”Ÿæˆçš„ SQL æ¥å®ç°ä¸ fromList ç›¸åŒçš„è¡Œä¸ºã€‚

é€šè¿‡ä½¿ç”¨ append å‡½æ•°ï¼Œä½ å¯ä»¥åŠ¨æ€åœ°å‘ç°æœ‰çš„ SQL å­—ç¬¦ä¸²æ·»åŠ é¢å¤–çš„ SQL å—ï¼Œ
æœ‰æ•ˆåœ°å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ã€‚
è¿™ä½¿ä½ èƒ½å¤Ÿå°†è‡ªå®šä¹‰é€»è¾‘æˆ–ä¸šåŠ¡è§„åˆ™å¹¶å…¥æœ€ç»ˆçš„ SQL æŸ¥è¯¢ã€‚

<Section>
```typescript 
const finalSql = sql`select * from users`;

// ä¸€äº›é€»è¾‘

finalSql.append(sql` where `);

// ä¸€äº›é€»è¾‘

for (let i = 0; i < 5; i++) {
	finalSql.append(sql`id = ${i}`);

	if (i === 4) continue;
	finalSql.append(sql` or `);
}
```
```sql
select * from users where id = $1 or id = $2 or id = $3 or id = $4 or id = $5; --> [0, 1, 2, 3, 4]
```
</Section>

## sql.empty()

é€šè¿‡ä½¿ç”¨ sql.empty()ï¼Œä½ å¯ä»¥ä»ä¸€ä¸ªç©ºçš„ SQL å¯¹è±¡å¼€å§‹ï¼Œç„¶åæ ¹æ®éœ€è¦åŠ¨æ€åœ°å°† SQL å—é™„åŠ åˆ°å®ƒä¸Šã€‚è¿™ä½¿ä½ èƒ½å¤Ÿé€æ­¥æ„å»º SQL æŸ¥è¯¢ï¼Œåº”ç”¨è‡ªå®šä¹‰é€»è¾‘æˆ–æ¡ä»¶æ¥ç¡®å®šæ¯ä¸ªå—çš„å†…å®¹ã€‚

ä¸€æ—¦ä½ ä½¿ç”¨ sql.empty() åˆå§‹åŒ–äº† SQL å¯¹è±¡ï¼Œ
ä½ å¯ä»¥åˆ©ç”¨ sql æ¨¡æ¿çš„å®Œæ•´åŠŸèƒ½ï¼Œå¦‚å‚æ•°åŒ–ã€ç»„åˆå’Œè½¬ä¹‰ã€‚
è¿™ä½¿ä½ èƒ½å¤Ÿä»¥çµæ´»å’Œå¯æ§çš„æ–¹å¼æ„å»º SQL æŸ¥è¯¢ï¼Œ
é€‚åº”ç‰¹å®šçš„è¦æ±‚ã€‚

```typescript 
const finalSql = sql.empty();

// ä¸€äº›é€»è¾‘

finalSql.append(sql`select * from users`);

// ä¸€äº›é€»è¾‘

finalSql.append(sql` where `);

// ä¸€äº›é€»è¾‘

for (let i = 0; i < 5; i++) {
	finalSql.append(sql`id = ${i}`);

	if (i === 4) continue;
	finalSql.append(sql` or `);
}
```
```sql
select * from users where id = $1 or id = $2 or id = $3 or id = $4 or id = $5; --> [0, 1, 2, 3, 4]
```

## å°† `sql` è½¬æ¢ä¸ºå­—ç¬¦ä¸²å’Œå‚æ•°

åœ¨æ‰€æœ‰ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œä½ è§‚å¯Ÿåˆ°äº† SQL æ¨¡æ¿è¯­æ³•åœ¨ TypeScript
ä¸­çš„ä½¿ç”¨ä»¥åŠç”Ÿæˆçš„ SQL è¾“å‡ºã€‚

å¦‚æœä½ éœ€è¦è·å–ä» SQL æ¨¡æ¿ç”Ÿæˆçš„æŸ¥è¯¢å­—ç¬¦ä¸²å’Œç›¸åº”çš„å‚æ•°ï¼Œ
ä½ å¿…é¡»æŒ‡å®šå¸Œæœ›ä¸ºå…¶ç”ŸæˆæŸ¥è¯¢çš„æ•°æ®åº“æ–¹è¨€ã€‚
ä¸åŒçš„æ•°æ®åº“åœ¨å‚æ•°åŒ–å’Œè½¬ä¹‰çš„è¯­æ³•ä¸Šæœ‰æ‰€ä¸åŒï¼Œå› æ­¤é€‰æ‹©é€‚å½“çš„æ–¹è¨€è‡³å…³é‡è¦ã€‚

ä¸€æ—¦é€‰æ‹©äº†æ–¹è¨€ï¼Œ
ä½ å¯ä»¥åˆ©ç”¨ç›¸åº”å®ç°çš„åŠŸèƒ½å°† SQL æ¨¡æ¿è½¬æ¢ä¸ºæ‰€éœ€çš„æŸ¥è¯¢å­—ç¬¦ä¸²å’Œå‚æ•°æ ¼å¼ã€‚
è¿™ç¡®ä¿äº†ä¸ç‰¹å®šæ•°æ®åº“ç³»ç»Ÿçš„å…¼å®¹æ€§ã€‚

<CodeTabs items={["PostgreSQL", "MySQL", "SQLite"]}>
<CodeTab>
<Section>
```typescript copy
import { PgDialect } from 'drizzle-orm/pg-core';

const pgDialect = new PgDialect();
pgDialect.sqlToQuery(sql`select * from ${usersTable} where ${usersTable.id} = ${12}`);
```
```sql
select * from "users" where "users"."id" = $1; --> [ 12 ]
```
</Section>

</CodeTab>
<CodeTab>
<Section>
```typescript copy
import { MySqlDialect } from 'drizzle-orm/mysql-core';

const mysqlDialect = new MySqlDialect();
mysqlDialect.sqlToQuery(sql`select * from ${usersTable} where ${usersTable.id} = ${12}`);
```
```sql
select * from `users` where `users`.`id` = ?; --> [ 12 ]
```
</Section>
</CodeTab>
<CodeTab>
<Section>
```typescript copy
import { SQLiteSyncDialect } from 'drizzle-orm/sqlite-core';

const sqliteDialect = new SQLiteSyncDialect();
sqliteDialect.sqlToQuery(sql`select * from ${usersTable} where ${usersTable.id} = ${12}`);
```
```sql
select * from "users" where "users"."id" = ?; --> [ 12 ]
```
</Section>
</CodeTab>
</CodeTabs>

## `sql` select

ä½ ä¹Ÿå¯ä»¥åœ¨éƒ¨åˆ†é€‰æ‹©æŸ¥è¯¢ä¸­ä½¿ç”¨ sql åŠŸèƒ½ã€‚
éƒ¨åˆ†é€‰æ‹©æŸ¥è¯¢å…è®¸ä½ ä»ä¸€ä¸ªè¡¨ä¸­æ£€ç´¢ç‰¹å®šçš„å­—æ®µæˆ–åˆ—ï¼Œè€Œä¸æ˜¯è·å–å®Œæ•´è¡Œã€‚

æœ‰å…³éƒ¨åˆ†é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œ
å¯ä»¥å‚è€ƒ **[æ ¸å¿ƒ API æ–‡æ¡£](/docs/select#basic-and-partial-select)**ã€‚

**ä»è¡¨ä¸­é€‰æ‹©ä¸åŒçš„è‡ªå®šä¹‰å­—æ®µ**

åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥çœ‹åˆ° **[`sql<T>`](/docs/sql#sqlt)**, **[`sql``.mapWith()`](/docs/sql#sqlmapwith)**, **[`sql``.as<T>()`](/docs/sql#sqlast)** çš„ç”¨æ³•ã€‚

<Section>
```typescript copy
import { sql } from 'drizzle-orm'
import { usersTable } from 'schema'

await db.select({
    id: usersTable.id,
    lowerName: sql<string>`lower(${usersTable.name})`,
    aliasedName: sql<string>`lower(${usersTable.name})`.as('aliased_column'),
    count: sql<number>`count(*)`.mapWith(Number) 
}).from(usersTable)
```
```sql
select `id`, lower(`name`), lower(`name`) as `aliased_column`, count(*) from `users`;
```
</Section>

## `sql` in where

ç¡®å®ï¼ŒDrizzle æä¾›äº†ä¸€ç»„å¯ç”¨çš„è¡¨è¾¾å¼ï¼Œä½ å¯ä»¥åœ¨ sql æ¨¡æ¿ä¸­ä½¿ç”¨ã€‚
ç„¶è€Œï¼Œæ•°æ®åº“é€šå¸¸æœ‰æ›´å¤šå¯ç”¨çš„è¡¨è¾¾å¼ï¼Œ
åŒ…æ‹¬é€šè¿‡æ‰©å±•æˆ–å…¶ä»–æ‰‹æ®µæä¾›çš„ã€‚

ä¸ºç¡®ä¿çµæ´»æ€§ï¼Œå¹¶ä½¿ä½ èƒ½å¤Ÿåˆ©ç”¨ä»»ä½•åœ¨ Drizzle ä¸­æœªåŸç”Ÿæ”¯æŒçš„è¡¨è¾¾å¼ï¼Œ
ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ sql å‡½æ•°ç¼–å†™ SQL æ¨¡æ¿ã€‚
è¿™ä½¿ä½ èƒ½å¤Ÿå……åˆ†å‘æŒ¥ SQL çš„èƒ½åŠ›ï¼Œ
ç»“åˆç‰¹å®šäºç›®æ ‡æ•°æ®åº“çš„ä»»ä½•è¡¨è¾¾å¼æˆ–åŠŸèƒ½ã€‚

ä½¿ç”¨ sql æ¨¡æ¿æ—¶ï¼Œä½ ä¸ä¼šå±€é™äº Drizzle ä¸­é¢„å®šä¹‰çš„è¡¨è¾¾å¼ã€‚
ç›¸åï¼Œä½ å¯ä»¥è¡¨è¾¾å¤æ‚æŸ¥è¯¢ï¼Œ
å¹¶ç»“åˆåº•å±‚æ•°æ®åº“ç³»ç»Ÿæä¾›çš„ä»»ä½•æ”¯æŒçš„è¡¨è¾¾å¼ã€‚


**æŒ‰ `id` è¿‡æ»¤ï¼Œä½†ä½¿ç”¨ sql**
<Section>
```typescript copy
import { sql } from 'drizzle-orm'
import { usersTable } from 'schema'

const id = 77

await db.select()
        .from(usersTable)
        .where(sql`${usersTable.id} = ${id}`)
```
```sql
select * from "users" where "users"."id" = $1; --> [ 77 ]
```
</Section>

**é«˜çº§çš„å…¨æ–‡æœç´¢ where è¯­å¥**
<Section>
```typescript copy
import { sql } from 'drizzle-orm'
import { usersTable } from 'schema'

const searchParam = "Ale"

await db.select()
        .from(usersTable)
        .where(sql`to_tsvector('simple', ${usersTable.name}) @@ to_tsquery('simple', ${searchParam})`)
```
```sql
select * from "users" where to_tsvector('simple', "users"."name") @@ to_tsquery('simple', '$1'); --> [ "Ale" ]
```
</Section>

## `sql` in orderBy

`sql` æ¨¡æ¿ç¡®å®å¯ä»¥åœ¨ ORDER BY å­å¥ä¸­ä½¿ç”¨ï¼Œ
å½“ä½ éœ€è¦æŸç§ç‰¹å®šåŠŸèƒ½è¿›è¡Œæ’åºè€Œ Drizzle ä¸­æ²¡æœ‰æ—¶ï¼Œä½†åˆä¸æƒ³è¯‰è¯¸åŸå§‹ SQLã€‚

<Section>
```typescript copy
import { sql } from 'drizzle-orm'
import { usersTable } from 'schema'

await db.select().from(usersTable).orderBy(sql`${usersTable.id} desc nulls first`)
```
```sql
select * from "users" order by "users"."id" desc nulls first;
```
</Section>

## `sql` in having å’Œ groupBy

`sql` æ¨¡æ¿ç¡®å®å¯ä»¥åœ¨ HAVING å’Œ GROUP BY å­å¥ä¸­ä½¿ç”¨ï¼Œå½“ä½ éœ€è¦æŸç§ç‰¹å®šåŠŸèƒ½è¿›è¡Œåˆ†ç»„ï¼Œ
è€Œ Drizzle ä¸­æ²¡æœ‰ï¼Œä½†åˆä¸æƒ³è¯‰è¯¸åŸå§‹ SQLã€‚

<Section>
```typescript copy
import { sql } from 'drizzle-orm'
import { usersTable } from 'schema'

await db.select({ 
    projectId: usersTable.projectId,
    count: sql<number>`count(${usersTable.id})`.mapWith(Number)
}).from(usersTable)
    .groupBy(sql`${usersTable.projectId}`)
    .having(sql`count(${usersTable.id}) > 300`)
```
```sql
select "project_id", count("users"."id") from users group by "users"."project_id" having count("users"."id") > 300; 
```
</Section>


Source: https://drizzle.zhcndoc.com/docs/transactions

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';

# äº‹åŠ¡

SQL äº‹åŠ¡æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªä¸æ•°æ®åº“äº¤äº’çš„ SQL è¯­å¥çš„ç»„åˆã€‚
ä¸€ä¸ªäº‹åŠ¡å¯ä»¥ä½œä¸ºä¸€ä¸ªå•ä¸€çš„é€»è¾‘å•å…ƒæäº¤åˆ°æ•°æ®åº“ï¼Œ
æˆ–è€…ä½œä¸ºä¸€ä¸ªå•ä¸€çš„é€»è¾‘å•å…ƒå›æ»šï¼ˆæ’¤é”€ï¼‰ã€‚

Drizzle ORM æä¾›äº†åœ¨äº‹åŠ¡ä¸­è¿è¡Œ SQL è¯­å¥çš„ APIï¼š

```ts copy
const db = drizzle(...)

await db.transaction(async (tx) => {
  await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, 'Dan'));
  await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, 'Andrew'));
});
```

Drizzle ORM æ”¯æŒ `savepoints` ä»¥åŠåµŒå¥—äº‹åŠ¡ APIï¼š

```ts copy {7-9}
const db = drizzle(...)

await db.transaction(async (tx) => {
  await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, 'Dan'));
  await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, 'Andrew'));

  await tx.transaction(async (tx2) => {
    await tx2.update(users).set({ name: "Mr. Dan" }).where(eq(users.name, "Dan"));
  });
});
```

æ‚¨å¯ä»¥å°†ä¸šåŠ¡é€»è¾‘åµŒå…¥åˆ°äº‹åŠ¡ä¸­ï¼Œå¹¶åœ¨éœ€è¦æ—¶å›æ»šï¼š

```ts copy {7}
const db = drizzle(...)

await db.transaction(async (tx) => {
  const [account] = await tx.select({ balance: accounts.balance }).from(accounts).where(eq(users.name, 'Dan'));
  if (account.balance < 100) {
    // è¿™å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä»è€Œå›æ»šäº‹åŠ¡ã€‚
    tx.rollback()
  }

  await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, 'Dan'));
  await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, 'Andrew'));
});
```

æ‚¨å¯ä»¥ä»äº‹åŠ¡ä¸­è¿”å›å€¼ï¼š

```ts copy {8}
const db = drizzle(...)

const newBalance: number = await db.transaction(async (tx) => {
  await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, 'Dan'));
  await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, 'Andrew'));

  const [account] = await tx.select({ balance: accounts.balance }).from(accounts).where(eq(users.name, 'Dan'));
  return account.balance;
});
```

æ‚¨å¯ä»¥ä½¿ç”¨äº‹åŠ¡ä¸ **[å…³ç³»æŸ¥è¯¢](/docs/rqb)**ï¼š

```ts
const db = drizzle({ schema })

await db.transaction(async (tx) => {
  await tx.query.users.findMany({
    with: {
      accounts: true
    }
  });
});
```





æˆ‘ä»¬æä¾›ç‰¹å®šäºæ–¹è¨€çš„äº‹åŠ¡é…ç½® APIï¼š

<Tabs items={["PostgreSQL", "MySQL", "SQLite", "SingleStore", "MSSQL", "CockroachDB"]}>
<Tab>
```ts copy {6-8}
await db.transaction(
  async (tx) => {
    await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, "Dan"));
    await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, "Andrew"));
  }, {
    isolationLevel: "read committed",
    accessMode: "read write",
    deferrable: true,
  }
);

interface PgTransactionConfig {
  isolationLevel?:
    | "read uncommitted"
    | "read committed"
    | "repeatable read"
    | "serializable";
  accessMode?: "read only" | "read write";
  deferrable?: boolean;
}
```
</Tab>
<Tab>
```ts {6-8}
await db.transaction(
  async (tx) => {
    await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, "Dan"));
    await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, "Andrew"));
  }, {
    isolationLevel: "read committed",
    accessMode: "read write",
    withConsistentSnapshot: true,
  }
);

interface MySqlTransactionConfig {
  isolationLevel?:
    | "read uncommitted"
    | "read committed"
    | "repeatable read"
    | "serializable";
  accessMode?: "read only" | "read write";
  withConsistentSnapshot?: boolean;
}
```
</Tab>
<Tab>
```ts {6}
await db.transaction(
  async (tx) => {
    await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, "Dan"));
    await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, "Andrew"));
  }, {
    behavior: "deferred",
  }
);

interface SQLiteTransactionConfig {
    behavior?: 'deferred' | 'immediate' | 'exclusive';
}
```
</Tab>
<Tab>
```ts {6-8}
await db.transaction(
  async (tx) => {
    await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, "Dan"));
    await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, "Andrew"));
  }, {
    isolationLevel: "read committed",
    accessMode: "read write",
    withConsistentSnapshot: true,
  }
);

interface SingleStoreTransactionConfig {
  isolationLevel?:
    | "read uncommitted"
    | "read committed"
    | "repeatable read"
    | "serializable";
  accessMode?: "read only" | "read write";
  withConsistentSnapshot?: boolean;
}
```
</Tab>
<Tab>
```ts copy {6-8}
await db.transaction(
  async (tx) => {
    await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, "Dan"));
    await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, "Andrew"));
  }, {
    isolationLevel: "read committed",
  }
);

interface MsSqlTransactionConfig {
  isolationLevel?: 'read uncommitted' | 'read committed' | 'repeatable read' | 'serializable' | 'snapshot';
}
```
</Tab>
<Tab>
```ts copy {6-8}
await db.transaction(
  async (tx) => {
    await tx.update(accounts).set({ balance: sql`${accounts.balance} - 100.00` }).where(eq(users.name, "Dan"));
    await tx.update(accounts).set({ balance: sql`${accounts.balance} + 100.00` }).where(eq(users.name, "Andrew"));
  }, {
    isolationLevel: "read committed",
    accessMode: "read write",
    deferrable: true,
  }
);

interface CockroachTransactionConfig {
  isolationLevel?:
    | "read uncommitted"
    | "read committed"
    | "repeatable read"
    | "serializable";
  accessMode?: "read only" | "read write";
  deferrable?: boolean;
}
```
</Tab>
</Tabs>



Source: https://drizzle.zhcndoc.com/docs/tutorials

import Tutorials from "@components/Tutorials.astro";

<Tutorials/>

Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-netlify-edge-functions-neon


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from "@mdx/Callout.astro";

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM å’Œ [Netlify Edge Functions](https://docs.netlify.com/edge-functions/overview/) åŠ [Neon Postgres](https://neon.tech/) æ•°æ®åº“ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬çš„ [Netlify CLI](https://docs.netlify.com/cli/get-started/#installation)ã€‚
- æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚å¦‚æœæ‚¨ä½¿ç”¨ Node.js `v20.6.0` æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œåˆ™æ— éœ€å®‰è£…ï¼Œå› ä¸º Node.js åŸç”Ÿæ”¯æŒ `.env` æ–‡ä»¶ã€‚è¯¦ç»†äº†è§£ [è¿™é‡Œ](https://nodejs.org/en/blog/release/v20.6.0#built-in-env-file-support)ã€‚
<Npm>
  dotenv
</Npm>

- å¯é€‰åœ°ï¼Œæ‚¨å¯ä»¥å®‰è£… `@netlify/edge-functions` åŒ…ï¼Œä»¥å¯¼å…¥ç¨åå°†ä½¿ç”¨çš„ `Context` å¯¹è±¡çš„ç±»å‹ã€‚
<Npm>
  @netlify/edge-functions
</Npm>
</Prerequisites>

<Callout type="warning">
è¿™äº›å®‰è£…çš„åŒ…ä»…ç”¨äºåœ¨ [åˆ›å»ºè¡¨](#create-a-table)ã€[è®¾ç½® Drizzle é…ç½®æ–‡ä»¶](#setup-drizzle-config-file) å’Œ [å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“](#apply-changes-to-the-database) æ­¥éª¤ä¸­åˆ›å»ºæ•°æ®åº“ä¸­çš„è¡¨ã€‚è¿™äº›åŒ…ä¸ä¼šå½±å“åœ¨ Netlify Edge Functions å†…éƒ¨è¿è¡Œçš„ä»£ç ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `import_map.json` å¯¼å…¥ Edge Functions æ‰€éœ€çš„åŒ…ã€‚
</Callout>

<Steps>
#### è®¾ç½® Neon Postgres

ç™»å½•åˆ° [Neon æ§åˆ¶å°](https://console.neon.tech/app/projects) å¹¶å¯¼èˆªåˆ°é¡¹ç›®éƒ¨åˆ†ã€‚é€‰æ‹©ä¸€ä¸ªé¡¹ç›®æˆ–å•å‡» `æ–°å»ºé¡¹ç›®` æŒ‰é’®ä»¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚

æ‚¨çš„ Neon é¡¹ç›®é™„å¸¦ä¸€ä¸ªå¯ç›´æ¥ä½¿ç”¨çš„åä¸º `neondb` çš„ Postgres æ•°æ®åº“ã€‚æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨å®ƒã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

åœ¨ **é¡¹ç›®ä»ªè¡¨æ¿** éƒ¨åˆ†å•å‡» `è¿æ¥` æŒ‰é’®å¹¶å¤åˆ¶æ‚¨çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚å®ƒåº”è¯¥çœ‹èµ·æ¥ç±»ä¼¼äºï¼š

```bash
postgres://username:password@ep-cool-darkness-123456.us-east-2.aws.neon.tech/neondb?sslmode=require
```

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ  `DATABASE_URL` ç¯å¢ƒå˜é‡ï¼Œç”¨äºè¿æ¥ Neon æ•°æ®åº“ã€‚

```text copy
DATABASE_URL=NEON_DATABASE_CONNECTION_STRING
```

#### è®¾ç½® Netlify Edge Functions

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `netlify/edge-functions` ç›®å½•ã€‚è¿™æ˜¯æ‚¨å°†å­˜å‚¨ Edge Functions çš„åœ°æ–¹ã€‚

åœ¨ `netlify/edge-functions` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå‡½æ•° `user.ts`ã€‚

```typescript copy filename="netlify/edge-functions/user.ts"
import type { Context } from "@netlify/edge-functions";

export default async (request: Request, context: Context) => {
  return new Response("ç”¨æˆ·æ•°æ®");
};
```

<Callout type="warning">
`Request` å’Œ `Response` å¯¹è±¡çš„ç±»å‹å¤„äºå…¨å±€ä½œç”¨åŸŸä¸­ã€‚
</Callout>

#### è®¾ç½®å¯¼å…¥

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `import_map.json` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```json copy filename="import_map.json"
{
  "imports": {
    "drizzle-orm/": "https://esm.sh/drizzle-orm/",
    "@neondatabase/serverless": "https://esm.sh/@neondatabase/serverless"
  }
}
```

åœ¨ Netlify Edge Functions ä¸­è¯¦ç»†äº†è§£ `import_map.json` [è¿™é‡Œ](https://docs.netlify.com/edge-functions/api/#import-maps)ã€‚

#### åˆ›å»º Netlify é…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `netlify.toml` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```toml copy filename="netlify.toml"
[functions]
  deno_import_map = "./import_map.json"

[[edge_functions]]
  path = "/user"
  function = "user"
```

æ­¤é…ç½®å‘Šè¯‰ Netlify ä½¿ç”¨ `import_map.json` æ–‡ä»¶è¿›è¡Œ Deno å¯¼å…¥ï¼Œå¹¶å°†å¯¹ `/user` è·¯å¾„çš„è¯·æ±‚è·¯ç”±åˆ° `user.ts` å‡½æ•°ã€‚
åœ¨ [è¿™é‡Œ](https://docs.netlify.com/configure-builds/file-based-configuration/) äº†è§£æ›´å¤šå…³äº `netlify.toml` çš„å†…å®¹ã€‚

#### åˆ›å»ºè¡¨

åœ¨ `netlify/edge-functions/common` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¨¡å¼ï¼š

```typescript copy filename="netlify/edge-functions/common/schema.ts"
import { pgTable, serial, text, integer } from "drizzle-orm/pg-core";

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
})
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”¨äº [Drizzle Kit](/docs/kit-overview) çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // å¦‚æœä½¿ç”¨ Node.js v20.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œåˆ™åˆ é™¤æ­¤è¡Œ
import type { Config } from "drizzle-kit";

export default {
  schema: './netlify/edge-functions/common/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Drizzle kit å°†æ›´æ”¹æ¨é€åˆ° Neon æ•°æ®åº“ã€‚

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

```bash copy
npx drizzle-kit push
```
<Callout type="warning">æ¨é€å‘½ä»¤é€‚ç”¨äºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œæ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸å¿«é€Ÿè¿­ä»£è€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿ç§»å·¥ä½œæµç¨‹ã€‚å…³äºå®ƒçš„æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹è¿™é‡Œï¼š [è¿ç§»](/docs/migrations)ã€‚

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

æ›´æ–°æ‚¨çš„ `netlify/edge-functions/user.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="netlify/edge-functions/user.ts"
import type { Context } from "@netlify/edge-functions";
import { usersTable } from "./common/schema.ts";
import { neon } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';

export default async (request: Request, context: Context) => {
  const sql = neon(Netlify.env.get("DATABASE_URL")!);
  const db = drizzle({ client: sql });

  const users = await db.select().from(usersTable);

  return new Response(JSON.stringify(users));
};
```

<Callout type="warning">
å¦‚æœæ‚¨åœ¨ä½¿ç”¨ VS Codeï¼Œå¯¼å…¥å¯èƒ½ä¼šçœ‹åˆ°çº¢è‰²ä¸‹åˆ’çº¿ã€‚Edge Function ä»å°†æ‰§è¡Œã€‚è¦æ¶ˆé™¤çº¢è‰²ä¸‹åˆ’çº¿ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹ä¸€æ­¥ä¸­é…ç½® VS Code ä½¿ç”¨ Edge Functionsã€‚
</Callout>

#### åœ¨æœ¬åœ°æµ‹è¯•æ‚¨çš„ä»£ç 

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯åŠ¨ Netlify å¼€å‘æœåŠ¡å™¨ï¼š

```bash copy
netlify dev
```

å½“æ‚¨ç¬¬ä¸€æ¬¡è¿è¡Œè¯¥å‘½ä»¤æ—¶ï¼Œå®ƒä¼šå»ºè®®é…ç½® VS Code ä½¿ç”¨ Edge Functionsã€‚å•å‡» `æ˜¯` è¿›è¡Œé…ç½®ã€‚åœ¨ `.vscode` ç›®å½•ä¸­å°†åˆ›å»º `settings.json` æ–‡ä»¶ã€‚
å¦‚æœæ‚¨ä»ç„¶çœ‹åˆ°çº¢è‰²ä¸‹åˆ’çº¿ï¼Œå¯ä»¥é‡æ–°å¯åŠ¨ Deno è¯­è¨€æœåŠ¡å™¨ã€‚

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å¹¶å¯¼èˆªåˆ° `/user` è·¯ç”±ã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä» Neon æ•°æ®åº“è¿”å›çš„ç”¨æˆ·æ•°æ®ï¼š

```plaintext
[]
```

å¦‚æœæ‚¨å°šæœªå‘ `users_table` è¡¨ä¸­æ·»åŠ æ•°æ®ï¼Œåˆ™å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªç©ºæ•°ç»„ã€‚

#### åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Netlify é¡¹ç›®

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Netlify é¡¹ç›®ï¼š

```bash copy
netlify init
```

åœ¨ CLI ä¸­å›ç­”é—®é¢˜ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Netlify é¡¹ç›®ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é€‰æ‹© `æ˜¯ï¼Œæ‰‹åŠ¨åˆ›å»ºå’Œéƒ¨ç½²ç½‘ç«™` -> `<YOUR_TEAM>` -> `<SITE_NAME>`ã€‚

#### è®¾ç½® Netlify ç¯å¢ƒå˜é‡

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å°†æ‚¨çš„ç¯å¢ƒå˜é‡å¯¼å…¥åˆ° Netlifyï¼š

```bash copy
netlify env:import .env
```

åœ¨ [è¿™é‡Œ](https://docs.netlify.com/environment-variables/get-started/) äº†è§£æœ‰å…³ Netlify ç¯å¢ƒå˜é‡çš„æ›´å¤šä¿¡æ¯ã€‚

#### éƒ¨ç½²æ‚¨çš„é¡¹ç›®

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥éƒ¨ç½²æ‚¨çš„é¡¹ç›®ï¼š

```bash copy
netlify deploy
```

æŒ‰ç…§ CLI ä¸­çš„è¯´æ˜å°†æ‚¨çš„é¡¹ç›®éƒ¨ç½²åˆ° Netlifyã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„å‘å¸ƒç›®å½•æ˜¯ `'.'`ã€‚

é»˜è®¤æƒ…å†µä¸‹è¿™æ˜¯ä¸€ä¸ª [è‰ç¨¿éƒ¨ç½²](https://docs.netlify.com/cli/get-started/#draft-deploys)ã€‚
è¦è¿›è¡Œç”Ÿäº§éƒ¨ç½²ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
netlify deploy --prod
```

</Steps>

æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·²éƒ¨ç½²ç½‘ç«™çš„ URL å¹¶å¯¼èˆªåˆ°æ‚¨åˆ›å»ºçš„è·¯ç”±ï¼ˆä¾‹å¦‚ `/user`ï¼‰ä»¥è®¿é—®æ‚¨çš„ Edge Functionã€‚


Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-netlify-edge-functions-supabase


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from "@mdx/Callout.astro";

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM ä¸ [Netlify Edge å‡½æ•°](https://docs.netlify.com/edge-functions/overview/) å’Œ [Supabase æ•°æ®åº“](https://supabase.com/docs/guides/database/overview) æ•°æ®åº“ã€‚

<Prerequisites>
- ä½ åº”è¯¥å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ [Netlify CLI](https://docs.netlify.com/cli/get-started/#installation)ã€‚
- ä½ åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚ä½ å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆè¿™ä¸€æ­¥ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- ä½ åº”è¯¥å·²ç»å®‰è£…äº†ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡çš„ `dotenv` åŒ…ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Node.js `v20.6.0` æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œåˆ™ä¸éœ€è¦å®‰è£…å®ƒï¼Œå› ä¸º Node.js åŸç”Ÿæ”¯æŒ `.env` æ–‡ä»¶ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://nodejs.org/en/blog/release/v20.6.0#built-in-env-file-support)ã€‚
<Npm>
  dotenv
</Npm>

- å¯é€‰åœ°ï¼Œä½ å¯ä»¥å®‰è£… `@netlify/edge-functions` åŒ…ï¼Œä»¥å¯¼å…¥ç¨åå°†ä½¿ç”¨çš„ `Context` å¯¹è±¡çš„ç±»å‹ã€‚
<Npm>
  @netlify/edge-functions
</Npm>
</Prerequisites>

<Callout type="warning">
è¿™äº›å®‰è£…çš„åŒ…ä»…ç”¨äºåœ¨ [åˆ›å»ºè¡¨](#create-a-table)ã€[è®¾ç½® Drizzle é…ç½®æ–‡ä»¶](#setup-drizzle-config-file) å’Œ [å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“](#apply-changes-to-the-database) æ­¥éª¤ä¸­åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè¡¨ã€‚è¿™äº›åŒ…ä¸ä¼šå½±å“åœ¨ Netlify Edge å‡½æ•°å†…éƒ¨è¿è¡Œçš„ä»£ç ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `import_map.json` å¯¼å…¥ Edge å‡½æ•°æ‰€éœ€çš„åŒ…ã€‚
</Callout>

<Steps>
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Supabase é¡¹ç›®

ä½ å¯ä»¥åœ¨ [ä»ªè¡¨æ¿](https://supabase.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Supabase é¡¹ç›®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­¤ [é“¾æ¥](https://database.new/) è¿›è¡Œåˆ›å»ºã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

ä½ å¯ä»¥é€šè¿‡ç‚¹å‡»ä»ªè¡¨æ¿é¡¶éƒ¨çš„ **è¿æ¥** ä»¥æŸ¥æ‰¾ `é¡¹ç›®è¿æ¥è¯¦ç»†ä¿¡æ¯`ï¼Œå¹¶ä» `äº¤æ˜“æ± ` éƒ¨åˆ†å¤åˆ¶ URIã€‚è®°å¾—ç”¨ä½ çš„å®é™…æ•°æ®åº“å¯†ç æ›¿æ¢å¯†ç å ä½ç¬¦ã€‚

å°† `DATABASE_URL` å˜é‡æ·»åŠ åˆ°ä½ çš„ `.env` æ–‡ä»¶ä¸­ã€‚

```plaintext copy
DATABASE_URL=<YOUR_DATABASE_URL>
```

æœ‰å…³è¿æ¥ Supabase æ•°æ®åº“çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)ã€‚

#### è®¾ç½® Netlify Edge å‡½æ•°

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»º `netlify/edge-functions` ç›®å½•ã€‚è¿™æ˜¯ä½ å°†å­˜å‚¨ Edge å‡½æ•°çš„åœ°æ–¹ã€‚

åœ¨ `netlify/edge-functions` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå‡½æ•° `user.ts`ã€‚

```typescript copy filename="netlify/edge-functions/user.ts"
import type { Context } from "@netlify/edge-functions";

export default async (request: Request, context: Context) => {
  return new Response("ç”¨æˆ·æ•°æ®");
};
```

<Callout type="warning">
`Request` å’Œ `Response` å¯¹è±¡çš„ç±»å‹åœ¨å…¨å±€èŒƒå›´å†…ã€‚
</Callout>

#### è®¾ç½®å¯¼å…¥

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `import_map.json` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```json copy filename="import_map.json"
{
  "imports": {
    "drizzle-orm/": "https://esm.sh/drizzle-orm/",
    "postgres": "https://esm.sh/postgres"
  }
}
```

æœ‰å…³ `import_map.json` çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ Netlify Edge å‡½æ•°çš„ [æ–‡æ¡£](https://docs.netlify.com/edge-functions/api/#import-maps)ã€‚

#### åˆ›å»º Netlify é…ç½®æ–‡ä»¶

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `netlify.toml` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```toml copy filename="netlify.toml"
[functions]
  deno_import_map = "./import_map.json"

[[edge_functions]]
  path = "/user"
  function = "user"
```

æ­¤é…ç½®å‘Šè¯‰ Netlify ä½¿ç”¨ `import_map.json` æ–‡ä»¶è¿›è¡Œ Deno å¯¼å…¥ï¼Œå¹¶å°†å¯¹ `/user` è·¯å¾„çš„è¯·æ±‚è·¯ç”±åˆ° `user.ts` å‡½æ•°ã€‚
æœ‰å…³ `netlify.toml` çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://docs.netlify.com/configure-builds/file-based-configuration/)ã€‚

#### åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `netlify/edge-functions/common` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¨¡å¼ï¼š

```typescript copy filename="netlify/edge-functions/common/schema.ts"
import { pgTable, serial, text, integer } from "drizzle-orm/pg-core";

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
})
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªè¢« [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å…³äºæ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config'; // å¦‚æœä½ ä½¿ç”¨ Node.js v20.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œè¯·ç§»é™¤æ­¤è¡Œ
import type { Config } from "drizzle-kit";

export default {
  schema: './netlify/edge-functions/common/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Drizzle kit å°†æ›´æ”¹æ¨é€åˆ° Neon æ•°æ®åº“ã€‚

#### å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

```bash copy
npx drizzle-kit push
```
<Callout type="warning">æ¨é€å‘½ä»¤é€‚åˆäºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¨¡å¼è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œå¿«é€Ÿè¿­ä»£çš„æƒ…å†µï¼Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

å¦å¤–ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿ç§»å·¥ä½œæµã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿ç§»æ–‡æ¡£](/docs/migrations)ã€‚

#### å°† Drizzle ORM è¿æ¥åˆ°ä½ çš„æ•°æ®åº“

æ›´æ–°ä½ çš„ `netlify/edge-functions/user.ts` æ–‡ä»¶å¹¶è®¾ç½®æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="netlify/edge-functions/user.ts"
import type { Context } from "@netlify/edge-functions";
import { usersTable } from "./common/schema.ts";
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

export default async (request: Request, context: Context) => {
  const queryClient = postgres(Netlify.env.get("DATABASE_URL")!);
  const db = drizzle({ client: queryClient });

  const users = await db.select().from(usersTable);

  return new Response(JSON.stringify(users));
};
```

<Callout type="warning">
å¦‚æœä½ åœ¨ä½¿ç”¨ VS Codeï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°å¯¼å…¥éƒ¨åˆ†ä¸‹é¢æœ‰çº¢è‰²ä¸‹åˆ’çº¿ã€‚Edge å‡½æ•°ä»ç„¶ä¼šæ‰§è¡Œã€‚è¦æ¶ˆé™¤çº¢è‰²ä¸‹åˆ’çº¿ï¼Œå¯ä»¥åœ¨ä¸‹ä¸€æ­¥ä¸­é…ç½® VS Code ä½¿ç”¨ Edge å‡½æ•°ã€‚
</Callout>

#### åœ¨æœ¬åœ°æµ‹è¯•ä½ çš„ä»£ç 

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯åŠ¨ Netlify å¼€å‘æœåŠ¡å™¨ï¼š

```bash copy
netlify dev
```

é¦–æ¬¡è¿è¡Œè¯¥å‘½ä»¤æ—¶ï¼Œå®ƒä¼šå»ºè®®ä½ é…ç½® VS Code ä»¥ä½¿ç”¨ Edge å‡½æ•°ã€‚ç‚¹å‡» `æ˜¯` è¿›è¡Œé…ç½®ã€‚ä¸€ä¸ª `settings.json` æ–‡ä»¶å°†ä¼šåœ¨ `.vscode` ç›®å½•ä¸­åˆ›å»ºã€‚
å¦‚æœä½ ä»ç„¶çœ‹åˆ°çº¢è‰²ä¸‹åˆ’çº¿ï¼Œå¯ä»¥é‡æ–°å¯åŠ¨ Deno è¯­è¨€æœåŠ¡å™¨ã€‚

æ‰“å¼€ä½ çš„æµè§ˆå™¨å¹¶å¯¼èˆªåˆ°è·¯ç”± `/user`ã€‚ä½ åº”è¯¥èƒ½ä» Neon æ•°æ®åº“ä¸­çœ‹åˆ°è¿”å›çš„ç”¨æˆ·æ•°æ®ï¼š

```plaintext
[]
```

å¦‚æœä½ æ²¡æœ‰å‘ `users_table` è¡¨ä¸­æ·»åŠ ä»»ä½•æ•°æ®ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ã€‚

#### åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Netlify é¡¹ç›®

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Netlify é¡¹ç›®ï¼š

```bash copy
netlify init
```

åœ¨ CLI ä¸­å›ç­”é—®é¢˜ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Netlify é¡¹ç›®ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é€‰æ‹© `æ˜¯ï¼Œæ‰‹åŠ¨åˆ›å»ºå’Œéƒ¨ç½²ç«™ç‚¹` -> `<YOUR_TEAM>` -> `<SITE_NAME>`ã€‚

#### è®¾ç½® Netlify ç¯å¢ƒå˜é‡

è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†ä½ çš„ç¯å¢ƒå˜é‡å¯¼å…¥åˆ° Netlifyï¼š

```bash copy
netlify env:import .env
```

æœ‰å…³ Netlify ç¯å¢ƒå˜é‡çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://docs.netlify.com/environment-variables/get-started/)ã€‚

#### éƒ¨ç½²ä½ çš„é¡¹ç›®

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥éƒ¨ç½²ä½ çš„é¡¹ç›®ï¼š

```bash copy
netlify deploy
```

æŒ‰ç…§ CLI ä¸­çš„è¯´æ˜å°†ä½ çš„é¡¹ç›®éƒ¨ç½²åˆ° Netlifyã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„å‘å¸ƒç›®å½•ä¸º `'.'`ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ª [è‰ç¨¿éƒ¨ç½²](https://docs.netlify.com/cli/get-started/#draft-deploys)ã€‚
è¦è¿›è¡Œç”Ÿäº§éƒ¨ç½²ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
netlify deploy --prod
```

</Steps>

æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨éƒ¨ç½²ç½‘ç«™çš„ URLï¼Œå¯¼èˆªåˆ°ä½ åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /user)` ä»¥è®¿é—®ä½ çš„ Edge å‡½æ•°ã€‚


Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-supabase-edge-functions


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM ä¸ [Supabase Edge Functions](https://supabase.com/docs/guides/functions)ã€‚

<Prerequisites>
- ä½ åº”è¯¥å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ [Supabase CLI](https://supabase.com/docs/guides/cli/getting-started#installing-the-supabase-cli)ã€‚
- ä½ åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](https://orm.drizzle.team/kit-docs/overview)ã€‚ä½ å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- ä½ åº”è¯¥å®‰è£… Docker Desktopã€‚å®ƒæ˜¯æœ¬åœ°å¼€å‘çš„å‰ææ¡ä»¶ã€‚è¯·æŒ‰ç…§å®˜æ–¹ [æ–‡æ¡£](https://docs.docker.com/desktop) è¿›è¡Œå®‰è£…ã€‚
</Prerequisites>

è¦äº†è§£å¦‚ä½•åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šåˆ›å»ºåŸºæœ¬çš„ Edge Function å¹¶è¿›è¡Œéƒ¨ç½²ï¼Œè¯·å‚é˜… [Edge Functions å¿«é€Ÿå…¥é—¨](https://supabase.com/docs/guides/functions/quickstart)ã€‚

<Steps>
#### åˆ›å»ºè¡¨

åœ¨ `src` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¶æ„ï¼š

```typescript copy filename="src/schema.ts"
import { pgTable, serial, text, integer } from "drizzle-orm/pg-core";

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull()
})
```

æ­¤æ–‡ä»¶å°†ç”¨äºä¸ºä½ çš„æ•°æ®åº“ç”Ÿæˆè¿ç§»ã€‚

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - æ˜¯ä¸€ä¸ªç”± [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å…³äºæ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/schema.ts",
  out: "./supabase/migrations",
  dialect: "postgresql",
});
```

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Drizzle kit ä¸ºæˆ‘ä»¬çš„æ¶æ„ç”Ÿæˆè¿ç§»ã€‚

#### åˆå§‹åŒ–æ–°çš„ Supabase é¡¹ç›®

åœ¨æœ¬åœ°è®¡ç®—æœºçš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ Supabase é¡¹ç›®ï¼š

```bash copy
supabase init
```

è¿™å°†åˆ›å»ºä¸€ä¸ª `supabase` æ–‡ä»¶å¤¹å’Œ `config.toml` æ–‡ä»¶ï¼š

```text
â””â”€â”€ supabase
    â””â”€â”€ config.toml
```

å¦‚æœä½ åœ¨ä½¿ç”¨ Visual Studio Codeï¼Œè¯·æŒ‰ç…§ [Supabase æ–‡æ¡£](https://supabase.com/docs/guides/functions/local-development#deno-with-visual-studio-code) è®¾ç½® Deno çš„é…ç½®ã€‚

#### ç”Ÿæˆè¿ç§»

è¿è¡Œ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™å°†åœ¨ `supabase/migrations` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç§»æ–‡ä»¶ï¼š

#### åº”ç”¨è¿ç§»

è¦å¯åŠ¨ Supabase æœ¬åœ°å¼€å‘æ ˆï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
supabase start
```

è¦åº”ç”¨è¿ç§»ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
supabase migration up
```

ä½ å¯ä»¥åœ¨ [æ–‡æ¡£](https://supabase.com/docs/guides/deployment/database-migrations) ä¸­é˜…è¯»æ›´å¤šå…³äº Supabase è¿ç§»çš„ä¿¡æ¯ã€‚

<Callout type="warning">åˆ«å¿˜äº†è¿è¡Œ Docker</Callout>

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤æ¥åº”ç”¨è¿ç§»ã€‚äº†è§£æ›´å¤šå…³äºæ­¤è¿ç§»è¿‡ç¨‹çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://orm.drizzle.team/docs/migrations)ã€‚

#### åˆ›å»ºæ–°çš„ Edge Function

è¿è¡Œ `supabase functions new [FUNCTION_NAME]` å‘½ä»¤åˆ›å»ºæ–°çš„ Edge Functionï¼š

```bash copy
supabase functions new drizzle-tutorial
```

è¿™å°†åœ¨ `supabase/functions` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°åç§°æ–‡ä»¶å¤¹ï¼š

```text
â””â”€â”€ supabase
    â””â”€â”€ functions
    â”‚   â””â”€â”€ drizzle-tutorial
    â”‚   â”‚   â”œâ”€â”€ .npmrc ## å‡½æ•°ç‰¹å®šçš„ npm é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
    â”‚   â”‚   â”œâ”€â”€ deno.json ## å‡½æ•°ç‰¹å®šçš„ Deno é…ç½®
    â”‚   â”‚   â””â”€â”€ index.ts ## ä½ çš„å‡½æ•°ä»£ç 
```

åˆ›å»ºæ–°çš„ Edge Function æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹å°†ä½¿ç”¨ TypeScriptã€‚ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ JavaScript ç¼–å†™ Edge Functionã€‚äº†è§£æ›´å¤šä¿¡æ¯è¯·å‚é˜… [æ–‡æ¡£](https://supabase.com/docs/guides/functions/quickstart#not-using-typescript)ã€‚

#### è®¾ç½®å¯¼å…¥

å°†ä»¥ä¸‹å¯¼å…¥æ·»åŠ åˆ° `supabase/functions/drizzle-tutorial/deno.json` æ–‡ä»¶ä¸­ï¼š

```json copy filename="supabase/functions/drizzle-tutorial/deno.json"
{
  "imports": {
    "drizzle-orm/": "npm:/drizzle-orm/",
    "postgres": "npm:postgres"
  }
}
```

ä½ å¯ä»¥åœ¨ [è¿™é‡Œ](https://supabase.com/docs/guides/functions/dependencies#managing-dependencies) é˜…è¯»æ›´å¤šå…³äºç®¡ç†ä¾èµ–çš„ä¿¡æ¯ã€‚

#### å°†ä½ çš„æ¶æ„å¤åˆ¶åˆ°å‡½æ•°ç›®å½•

ä» `src/schema.ts` æ–‡ä»¶ä¸­å¤åˆ¶ä½ å°†åœ¨ Edge Function ä¸­ä½¿ç”¨çš„ä»£ç åˆ° `supabase/functions/drizzle-tutorial/index.ts` æ–‡ä»¶ï¼š

```typescript copy filename="supabase/functions/drizzle-tutorial/index.ts"
// è®¾ç½®å†…ç½® Supabase Runtime API çš„ç±»å‹å®šä¹‰
import "jsr:@supabase/functions-js/edge-runtime.d.ts"
import { pgTable, serial, text, integer } from "drizzle-orm/pg-core";

const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull()
})

Deno.serve(async (req) => {
  const { name } = await req.json()
  const data = {
    message: `Hello ${name}!`,
  }

  return new Response(
    JSON.stringify(data),
    { headers: { "Content-Type": "application/json" } },
  )
})  
```

<Callout type="warning">
åœ¨ Deno ç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªå‡½æ•°éƒ½åº”è¯¥è¢«è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œå¹¶å…·æœ‰è‡ªå·±çš„ä¸€ç»„ä¾èµ–å’Œé…ç½®ã€‚
å› æ­¤ï¼ŒSupabase å»ºè®®åœ¨æ¯ä¸ªå‡½æ•°çš„ç›®å½•ä¸­ç»´æŠ¤å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼ˆ`deno.json`ã€`.npmrc` æˆ– `import_map.json`ï¼‰ï¼Œå³ä½¿è¿™æ„å‘³ç€é‡å¤ä¸€äº›é…ç½®ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥é˜… [è¿™é‡Œ](https://supabase.com/docs/guides/functions/dependencies#managing-dependencies)ã€‚
</Callout>

#### å°† Drizzle ORM è¿æ¥åˆ°ä½ çš„æ•°æ®åº“

æ›´æ–°ä½ çš„ Edge Function ä»£ç ä»¥åŒ…å«æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="supabase/functions/drizzle-tutorial/index.ts" {14,17,18}
// è®¾ç½®å†…ç½® Supabase Runtime API çš„ç±»å‹å®šä¹‰
import { integer, pgTable, serial, text } from "drizzle-orm/pg-core";
import { drizzle } from "drizzle-orm/postgres-js";
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import postgres from "postgres";

const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull()
})

Deno.serve(async () => {
  const connectionString = Deno.env.get("SUPABASE_DB_URL")!;

  // ç¦ç”¨é¢„å–ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒâ€œTransactionâ€æ± æ¨¡å¼
  const client = postgres(connectionString, { prepare: false });
  const db = drizzle({ client });

  await db.insert(usersTable).values({
    name: "Alice",
    age: 25
  })
  const data = await db.select().from(usersTable);

  return new Response(
    JSON.stringify(data)
  )
})
```

`SUPABASE_DB_URL` æ˜¯ç›´æ¥æ•°æ®åº“è¿æ¥çš„é»˜è®¤ç¯å¢ƒå˜é‡ã€‚äº†è§£æ›´å¤šå…³äºç®¡ç† Supabase Edge Function ä¸­ç¯å¢ƒå˜é‡çš„ä¿¡æ¯ï¼Œè¯·æŸ¥é˜… [æ–‡æ¡£](https://supabase.com/docs/guides/functions/secrets)ã€‚

#### åœ¨æœ¬åœ°æµ‹è¯•ä½ çš„ä»£ç 

è¿è¡Œä»¥ä¸‹å‘½ä»¤åœ¨æœ¬åœ°æµ‹è¯•ä½ çš„å‡½æ•°ï¼š

```bash copy
supabase functions serve --no-verify-jwt
```

åœ¨æµè§ˆå™¨ä¸­å¯¼èˆªåˆ°åˆ›å»ºçš„è·¯ç”± `(e.g. /drizzle-tutorial)`ï¼š

```plaintext
[
  {
    "id": 1,
    "name": "Alice",
    "age": 25
  }
]
```

#### å°†æœ¬åœ°é¡¹ç›®é“¾æ¥åˆ°æ‰˜ç®¡çš„ Supabase é¡¹ç›®

ä½ å¯ä»¥åœ¨ [ä»ªè¡¨æ¿](https://supabase.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Supabase é¡¹ç›®æˆ–é€šè¿‡æ­¤ [é“¾æ¥](https://database.new/)ã€‚

ä»é¡¹ç›®è®¾ç½®ä¸­å¤åˆ¶ `Reference ID`ï¼Œå¹¶ä½¿ç”¨å®ƒé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†ä½ çš„æœ¬åœ°å¼€å‘é¡¹ç›®é“¾æ¥åˆ°æ‰˜ç®¡çš„ Supabase é¡¹ç›®ï¼š

```bash copy
supabase link --project-ref=<REFERENCE_ID>
```

é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†æ¨¡å¼æ›´æ”¹æ¨é€åˆ°æ‰˜ç®¡çš„ Supabase é¡¹ç›®ï¼š

```bash copy
supabase db push
```

#### è®¾ç½®ç¯å¢ƒå˜é‡

ä½ å¯ä»¥é€šè¿‡ç‚¹å‡»ä»ªè¡¨æ¿é¡¶éƒ¨æ ä¸­çš„ **Connect** æ‰¾åˆ° `Project connect details`ï¼Œå¹¶ä» `Transaction pooler` éƒ¨åˆ†å¤åˆ¶ URIã€‚è®°å¾—å°†å¯†ç å ä½ç¬¦æ›¿æ¢ä¸ºä½ çš„å®é™…æ•°æ®åº“å¯†ç ã€‚

äº†è§£æ›´å¤šå…³äºè¿æ¥æ± çš„ä¿¡æ¯ï¼Œè¯·æŸ¥é˜… [æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)ã€‚

æ›´æ–°ä½ çš„ Edge Function ä»£ç ï¼Œä»¥ä½¿ç”¨ `DATABASE_URL` ç¯å¢ƒå˜é‡è€Œä¸æ˜¯ `SUPABASE_DB_URL`ï¼š

```typescript copy filename="supabase/functions/drizzle-tutorial/index.ts"
// imports

// const connectionString = Deno.env.get("SUPABASE_DB_URL")!;
const connectionString = Deno.env.get("DATABASE_URL")!;

// code
```

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash copy
supabase secrets set DATABASE_URL=<CONNECTION_STRING>
```

äº†è§£æ›´å¤šå…³äºç®¡ç† Supabase Edge Functions ä¸­çš„ç¯å¢ƒå˜é‡çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://supabase.com/docs/guides/functions/secrets)ã€‚

#### éƒ¨ç½²ä½ çš„å‡½æ•°

é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²ä½ çš„å‡½æ•°ï¼š

```bash copy
supabase functions deploy drizzle-tutorial --no-verify-jwt
```
</Steps>

æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨éƒ¨ç½²é¡¹ç›®çš„ URLï¼Œå¯¼èˆªåˆ°ä½ åˆ›å»ºçš„è·¯ç”± `(e.g. /drizzle-tutorial)` æ¥è®¿é—®ä½ çš„ Edge Functionã€‚

Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-vercel-edge-functions


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from "@mdx/Callout.astro";

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•åœ¨[Edge è¿è¡Œæ—¶](https://vercel.com/docs/functions/runtimes/edge-runtime)ä¸­ä½¿ç”¨ Drizzle ORM ä¸ [Vercel Functions](https://vercel.com/docs/functions)ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬çš„ [Vercel CLI](https://vercel.com/docs/cli#)ã€‚
<Npm>
-g vercel
</Npm>

- æ‚¨åº”è¯¥å·²æœ‰ä¸€ä¸ªç°æœ‰çš„ Next.js é¡¹ç›®ï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š

```bash copy
npx create-next-app@latest --typescript
```
- æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®ƒï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
</Prerequisites>

<Callout type="warning">
å¦‚æœæ‚¨åœ¨å®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°ä¾èµ–å…³ç³»è§£æé—®é¢˜ï¼š

å¦‚æœæ‚¨ä¸æ˜¯åœ¨ä½¿ç”¨ React Nativeï¼Œå¯ä»¥é€šè¿‡å¼ºåˆ¶å®‰è£… `--force` æˆ– `--legacy-peer-deps` æ¥è§£å†³æ­¤é—®é¢˜ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ React Nativeï¼Œåˆ™éœ€è¦ä½¿ç”¨ä¸æ‚¨çš„ React Native ç‰ˆæœ¬å…¼å®¹çš„ React çš„ç²¾ç¡®ç‰ˆæœ¬ã€‚
</Callout>

## å…¼å®¹ Edge çš„é©±åŠ¨ç¨‹åº

åœ¨ä½¿ç”¨ Vercel Edge å‡½æ•°ä¸ Drizzle ORM æ—¶ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨å…¼å®¹ Edge çš„é©±åŠ¨ç¨‹åºï¼Œå› ä¸ºå‡½æ•°åœ¨ [Edge è¿è¡Œæ—¶](https://vercel.com/docs/functions/runtimes/edge-runtime) ä¸­è¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨ Node.js è¿è¡Œæ—¶ï¼Œè¿™æ ·æ ‡å‡† Node.js API å­˜åœ¨ä¸€äº›é™åˆ¶ã€‚

æ‚¨å¯ä»¥æ ¹æ®æ‚¨çš„æ•°æ®åº“æ–¹è¨€é€‰æ‹©ä»¥ä¸‹é©±åŠ¨ç¨‹åºä¹‹ä¸€ï¼š

- [Neon æ— æœåŠ¡å™¨é©±åŠ¨ç¨‹åº](/docs/get-started-postgresql#neon) å…è®¸æ‚¨é€šè¿‡ HTTP æˆ– WebSockets è€Œä¸æ˜¯ TCP ä»æ— æœåŠ¡å™¨å’Œè¾¹ç¼˜ç¯å¢ƒæŸ¥è¯¢æ‚¨çš„ Neon Postgres æ•°æ®åº“ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨æ­¤é©±åŠ¨ç¨‹åºæ¥è¿æ¥åˆ° `Neon Postgres`ã€‚
- [Vercel Postgres é©±åŠ¨ç¨‹åº](/docs/get-started-postgresql#vercel-postgres) æ„å»ºäº `Neon æ— æœåŠ¡å™¨é©±åŠ¨ç¨‹åº` ä¹‹ä¸Šã€‚æˆ‘ä»¬æ¨èä½¿ç”¨æ­¤é©±åŠ¨ç¨‹åºæ¥è¿æ¥åˆ° `Vercel Postgres`ã€‚
- [PlanetScale æ— æœåŠ¡å™¨é©±åŠ¨ç¨‹åº](/docs/get-started-mysql#planetscale) å…è®¸æ‚¨è®¿é—®ä»»ä½• `MySQL` å®¢æˆ·ç«¯å¹¶é€šè¿‡ HTTP è¿æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿™é€šå¸¸ä¸å—äº‘æä¾›å•†çš„é˜»æ­¢ã€‚
- [libSQL å®¢æˆ·ç«¯](/docs/get-started-sqlite#turso) å…è®¸æ‚¨è®¿é—® [Turso](https://docs.turso.tech/introduction) æ•°æ®åº“ã€‚

## å¯¼èˆª

- ç›´æ¥å¯¼èˆªè‡³ [Neon Postgres](/docs/tutorials/drizzle-with-vercel-edge-functions#neon-postgres) éƒ¨åˆ†ã€‚
- ç›´æ¥å¯¼èˆªè‡³ [Vercel Postgres](/docs/tutorials/drizzle-with-vercel-edge-functions#vercel-postgres) éƒ¨åˆ†ã€‚
- ç›´æ¥å¯¼èˆªè‡³ [PlanetScale](/docs/tutorials/drizzle-with-vercel-edge-functions#planetscale) éƒ¨åˆ†ã€‚
- ç›´æ¥å¯¼èˆªè‡³ [Turso](/docs/tutorials/drizzle-with-vercel-edge-functions#turso) éƒ¨åˆ†ã€‚

### Neon Postgres

<Steps>
#### å®‰è£… `@neondatabase/serverless` é©±åŠ¨ç¨‹åº

å®‰è£… `@neondatabase/serverless` é©±åŠ¨ç¨‹åºï¼š

<Npm>
@neondatabase/serverless
</Npm>

#### åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¶æ„ï¼š

```typescript copy filename="src/db/schema.ts"
import { pgTable, serial, text } from "drizzle-orm/pg-core";

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: text('age').notNull(),
  email: text('email').notNull().unique(),
})
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/db/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼š

```plaintext filename=".env"
POSTGRES_URL="postgres://[user]:[password]@[host]-[region].aws.neon.tech:5432/[db-name]?sslmode=[ssl-mode]"
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨çš„ `drizzle.config.ts` ä¸­æ‰€æŒ‡å®šã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶å’Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µ/schema å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" text NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) å°†æ›´æ”¹ç›´æ¥æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚åˆéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–æ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { drizzle } from 'drizzle-orm/neon-serverless';


export const db = drizzle(process.env.POSTGRES_URL!)
```

#### åˆ›å»º API è·¯ç”±

åœ¨ `src/app/api/hello` ç›®å½•ä¸­åˆ›å»º `route.ts` æ–‡ä»¶ã€‚æœ‰å…³å¦‚ä½•ç¼–å†™å‡½æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [Functions API Reference](https://vercel.com/docs/functions/functions-api-reference) å’Œ [Vercel Functions Quickstart](https://vercel.com/docs/functions/quickstart)ã€‚

```ts copy filename="src/app/api/hello/route.ts"
import { db } from "@/db";
import { usersTable } from "@/db/schema";
import { NextResponse } from "next/server";

export const dynamic = 'force-dynamic'; // é»˜è®¤ä¸ºé™æ€ï¼Œé™¤éè¯»å–è¯·æ±‚
export const runtime = 'edge' // æŒ‡å®šè¿è¡Œæ—¶ä¸ºè¾¹ç¼˜

export async function GET(request: Request) {
  const users = await db.select().from(usersTable)

  return NextResponse.json({ users, message: 'success' });
}
```

#### åœ¨æœ¬åœ°æµ‹è¯•æ‚¨çš„ä»£ç 

è¿è¡Œ `next dev` å‘½ä»¤ä»¥å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š

```bash copy
npx next dev
```

åœ¨æµè§ˆå™¨ä¸­å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)`ï¼š

```plaintext
{
  "users": [],
  "message": "success"
}
```

#### éƒ¨ç½²æ‚¨çš„é¡¹ç›®

åœ¨ [ä»ªè¡¨æ¿](https://vercel.com/new) ä¸­åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æˆ–è¿è¡Œ `vercel` å‘½ä»¤ä»¥éƒ¨ç½²æ‚¨çš„é¡¹ç›®ï¼š

```bash copy
vercel
```

æ·»åŠ  `POSTGRES_URL` ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel env add POSTGRES_URL
```

é‡æ–°éƒ¨ç½²æ‚¨çš„é¡¹ç›®ä»¥æ›´æ–°ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel
```
</Steps>

æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·²éƒ¨ç½²é¡¹ç›®çš„ URL å¹¶å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)` ä»¥è®¿é—®æ‚¨çš„è¾¹ç¼˜å‡½æ•°ã€‚

### Vercel Postgres

æ‚¨å¯ä»¥åœ¨ [æ–‡æ¡£](/docs/get-started-postgresql#vercel-postgres) ä¸­æŸ¥çœ‹ Drizzle ä¸ Vercel Postgres å®¢æˆ·ç«¯çš„å¿«é€Ÿå…¥é—¨æŒ‡å—ã€‚

<Steps>
#### å®‰è£… `@vercel/postgres` é©±åŠ¨ç¨‹åº

å®‰è£… `@vercel/postgres` é©±åŠ¨ç¨‹åºï¼š

<Npm>
@vercel/postgres
</Npm>

#### åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¶æ„ï¼š

```typescript copy filename="src/db/schema.ts"
import { pgTable, serial, text } from "drizzle-orm/pg-core";

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: text('age').notNull(),
  email: text('email').notNull().unique(),
})
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/db/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼š

```plaintext filename=".env"
POSTGRES_URL="postgres://[user]:[password]@[host]-[region].aws.neon.tech:5432/[db-name]?sslmode=[ssl-mode]"
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨çš„ `drizzle.config.ts` ä¸­æ‰€æŒ‡å®šã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶å’Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µ/schema å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" text NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) å°†æ›´æ”¹ç›´æ¥æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚åˆéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–æ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { drizzle } from 'drizzle-orm/vercel-postgres';

export const db = drizzle()
```

#### åˆ›å»º API è·¯ç”±

åœ¨ `src/app/api/hello` ç›®å½•ä¸­åˆ›å»º `route.ts` æ–‡ä»¶ã€‚æœ‰å…³å¦‚ä½•ç¼–å†™å‡½æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [Functions API Reference](https://vercel.com/docs/functions/functions-api-reference) å’Œ [Vercel Functions Quickstart](https://vercel.com/docs/functions/quickstart)ã€‚

```ts copy filename="src/app/api/hello/route.ts"

import { db } from "@/db";
import { usersTable } from "@/db/schema";
import { NextResponse } from "next/server";

export const dynamic = 'force-dynamic'; // é»˜è®¤ä¸ºé™æ€ï¼Œé™¤éè¯»å–è¯·æ±‚
export const runtime = 'edge' // æŒ‡å®šè¿è¡Œæ—¶ä¸ºè¾¹ç¼˜

export async function GET(request: Request) {
  const users = await db.select().from(usersTable)

  return NextResponse.json({ users, message: 'success' });
}
```

#### åœ¨æœ¬åœ°æµ‹è¯•æ‚¨çš„ä»£ç 

è¿è¡Œ `next dev` å‘½ä»¤ä»¥å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š

```bash copy
npx next dev
```

åœ¨æµè§ˆå™¨ä¸­å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)`ï¼š

```plaintext
{
  "users": [],
  "message": "success"
}
```

#### éƒ¨ç½²æ‚¨çš„é¡¹ç›®

åœ¨ [ä»ªè¡¨æ¿](https://vercel.com/new) ä¸­åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æˆ–è¿è¡Œ `vercel` å‘½ä»¤ä»¥éƒ¨ç½²æ‚¨çš„é¡¹ç›®ï¼š

```bash copy
vercel
```

æ·»åŠ  `POSTGRES_URL` ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel env add POSTGRES_URL
```

é‡æ–°éƒ¨ç½²æ‚¨çš„é¡¹ç›®ä»¥æ›´æ–°ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel
```
</Steps>

æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·²éƒ¨ç½²é¡¹ç›®çš„ URL å¹¶å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)` ä»¥è®¿é—®æ‚¨çš„è¾¹ç¼˜å‡½æ•°ã€‚

### PlanetScale

åœ¨æœ¬æ•™ç¨‹ä¸­æˆ‘ä»¬ä½¿ç”¨ [PlanetScale MySQL](https://planetscale.com)ã€‚

<Steps>
#### å®‰è£… `@planetscale/database` é©±åŠ¨ç¨‹åº

å®‰è£… `@planetscale/database` é©±åŠ¨ç¨‹åºï¼š

<Npm>
@planetscale/database
</Npm>

#### åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¶æ„ï¼š

```typescript copy filename="src/db/schema.ts"
import { mysqlTable, serial, text } from "drizzle-orm/mysql-core";

export const usersTable = mysqlTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: text('age').notNull(),
  email: text('email').notNull().unique(),
})
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/db/schema.ts",
  dialect: "mysql",
  dbCredentials: {
    url: process.env.MYSQL_URL!,
  },
});
```

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼š

```plaintext filename=".env"
MYSQL_URL="mysql://[user]:[password]@[host].[region].psdb.cloud/[db-name]?ssl={'rejectUnauthorized':[ssl-rejectUnauthorized]}"
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨çš„ `drizzle.config.ts` ä¸­æ‰€æŒ‡å®šã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶å’Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µ/schema å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE `users_table` (
	`id` serial AUTO_INCREMENT NOT NULL,
	`name` text NOT NULL,
	`age` text NOT NULL,
	`email` text NOT NULL,
	CONSTRAINT `users_table_id` PRIMARY KEY(`id`),
	CONSTRAINT `users_table_email_unique` UNIQUE(`email`)
);
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) å°†æ›´æ”¹ç›´æ¥æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚åˆéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–æ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { drizzle } from "drizzle-orm/planetscale-serverless";

export const db = drizzle(process.env.MYSQL_URL!)
```

#### åˆ›å»º API è·¯ç”±

åœ¨ `src/app/api/hello` ç›®å½•ä¸­åˆ›å»º `route.ts` æ–‡ä»¶ã€‚æœ‰å…³å¦‚ä½•ç¼–å†™å‡½æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [Functions API Reference](https://vercel.com/docs/functions/functions-api-reference) å’Œ [Vercel Functions Quickstart](https://vercel.com/docs/functions/quickstart)ã€‚

```ts copy filename="src/app/api/hello/route.ts"
import { db } from "@/app/db/db";
import { usersTable } from "@/app/db/schema";
import { NextResponse } from "next/server";

export const dynamic = 'force-dynamic'; // é»˜è®¤ä¸ºé™æ€ï¼Œé™¤éè¯»å–è¯·æ±‚
export const runtime = 'edge' // æŒ‡å®šè¿è¡Œæ—¶ä¸ºè¾¹ç¼˜

export async function GET(request: Request) {
  const users = await db.select().from(usersTable)

  return NextResponse.json({ users, message: 'success' });
}
```

#### åœ¨æœ¬åœ°æµ‹è¯•æ‚¨çš„ä»£ç 

è¿è¡Œ `next dev` å‘½ä»¤ä»¥å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š

```bash copy
npx next dev
```

åœ¨æµè§ˆå™¨ä¸­å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)`ï¼š

```plaintext
{
  "users": [],
  "message": "success"
}
```

#### éƒ¨ç½²æ‚¨çš„é¡¹ç›®

åœ¨ [ä»ªè¡¨æ¿](https://vercel.com/new) ä¸­åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æˆ–è¿è¡Œ `vercel` å‘½ä»¤ä»¥éƒ¨ç½²æ‚¨çš„é¡¹ç›®ï¼š

```bash copy
vercel
```

æ·»åŠ  `MYSQL_URL` ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel env add MYSQL_URL
```

é‡æ–°éƒ¨ç½²æ‚¨çš„é¡¹ç›®ä»¥æ›´æ–°ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel
```
</Steps>

æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·²éƒ¨ç½²é¡¹ç›®çš„ URL å¹¶å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)` ä»¥è®¿é—®æ‚¨çš„è¾¹ç¼˜å‡½æ•°ã€‚

### Turso

æ‚¨å¯ä»¥åœ¨æ–‡æ¡£ä¸­æŸ¥çœ‹ Drizzle ä¸ Turso çš„ [å¿«é€Ÿå…¥é—¨æŒ‡å—](/docs/get-started-sqlite#turso) æˆ– [æ•™ç¨‹](/docs/tutorials/drizzle-with-turso)ã€‚

<Steps>
#### å®‰è£… `@libsql/client` é©±åŠ¨ç¨‹åº

å®‰è£… `@libsql/client` é©±åŠ¨ç¨‹åºï¼š

<Npm>
@libsql/client
</Npm>

#### åˆ›å»ºä¸€ä¸ªè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜ä¸€ä¸ªè¡¨æ¶æ„ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, sqliteTable, text } from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable('users_table', {
  id: integer('id').primaryKey(),
  name: text('name').notNull(),
  age: text('age').notNull(),
  email: text('email').notNull().unique(),
})
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { defineConfig } from "drizzle-kit";

export default defineConfig({
  schema: "./src/db/schema.ts",
  dialect: "turso",
  dbCredentials: {
    url: process.env.TURSO_CONNECTION_URL!,
    authToken: process.env.TURSO_AUTH_TOKEN!,
  },
});
```

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å’Œèº«ä»½éªŒè¯ä»¤ç‰Œï¼š

```plaintext filename=".env"
TURSO_CONNECTION_URL="libsql://[db-name].turso.io"
TURSO_AUTH_TOKEN="[auth-token]"
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨çš„ `drizzle.config.ts` ä¸­æ‰€æŒ‡å®šã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶å’Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µ/schema å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE `users_table` (
	`id` integer PRIMARY KEY NOT NULL,
	`name` text NOT NULL,
	`age` text NOT NULL,
	`email` text NOT NULL
);
--> statement-breakpoint
CREATE UNIQUE INDEX `users_table_email_unique` ON `users_table` (`email`);
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) å°†æ›´æ”¹ç›´æ¥æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚åˆéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–æ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { drizzle } from 'drizzle-orm/libsql';

export const db = drizzle({ connection: {
  url: process.env.TURSO_CONNECTION_URL!,
  authToken: process.env.TURSO_AUTH_TOKEN!,
}})
```

#### åˆ›å»º API è·¯ç”±

åœ¨ `src/app/api/hello` ç›®å½•ä¸­åˆ›å»º `route.ts` æ–‡ä»¶ã€‚æœ‰å…³å¦‚ä½•ç¼–å†™å‡½æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [Functions API Reference](https://vercel.com/docs/functions/functions-api-reference) å’Œ [Vercel Functions Quickstart](https://vercel.com/docs/functions/quickstart)ã€‚

```ts copy filename="src/app/api/hello/route.ts"
import { db } from "@/app/db/db";
import { usersTable } from "@/app/db/schema";
import { NextResponse } from "next/server";

export const dynamic = 'force-dynamic'; // é»˜è®¤ä¸ºé™æ€ï¼Œé™¤éè¯»å–è¯·æ±‚
export const runtime = 'edge' // æŒ‡å®šè¿è¡Œæ—¶ä¸ºè¾¹ç¼˜

export async function GET(request: Request) {
  const users = await db.select().from(usersTable)

  return NextResponse.json({ users, message: 'success' });
}
```

#### åœ¨æœ¬åœ°æµ‹è¯•æ‚¨çš„ä»£ç 

è¿è¡Œ `next dev` å‘½ä»¤ä»¥å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š

```bash copy
npx next dev
```

åœ¨æµè§ˆå™¨ä¸­å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)`ï¼š

```plaintext
{
  "users": [],
  "message": "success"
}
```

#### éƒ¨ç½²æ‚¨çš„é¡¹ç›®

åœ¨ [ä»ªè¡¨æ¿](https://vercel.com/new) ä¸­åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æˆ–è¿è¡Œ `vercel` å‘½ä»¤ä»¥éƒ¨ç½²æ‚¨çš„é¡¹ç›®ï¼š

```bash copy
vercel
```

æ·»åŠ  `TURSO_CONNECTION_URL` ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel env add TURSO_CONNECTION_URL
```

æ·»åŠ  `TURSO_AUTH_TOKEN` ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel env add TURSO_AUTH_TOKEN
```

é‡æ–°éƒ¨ç½²æ‚¨çš„é¡¹ç›®ä»¥æ›´æ–°ç¯å¢ƒå˜é‡ï¼š

```bash copy
vercel
```
</Steps>

æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·²éƒ¨ç½²é¡¹ç›®çš„ URL å¹¶å¯¼èˆªè‡³æ‚¨åˆ›å»ºçš„è·¯ç”± `(ä¾‹å¦‚ /api/hello)` ä»¥è®¿é—®æ‚¨çš„è¾¹ç¼˜å‡½æ•°ã€‚


Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-neon


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from "@mdx/Npm.astro";
import Steps from "@mdx/Steps.astro";
import Section from "@mdx/Section.astro";
import Callout from "@mdx/Callout.astro";

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM ä¸ [Neon Postgres](https://neon.tech/) æ•°æ®åº“ã€‚å¦‚æœæ‚¨å°šæœªæ‹¥æœ‰ Neon è´¦æˆ·ï¼Œè¯· [åœ¨æ­¤å¤„æ³¨å†Œ](https://neon.tech)ã€‚

<Prerequisites>  
  - æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œï¼š
  <Npm>
    drizzle-orm 
    -D drizzle-kit
  </Npm>

  - æ‚¨è¿˜åº”è¯¥å®‰è£… [Neon æ— æœåŠ¡å™¨é©±åŠ¨](https://neon.tech/docs/serverless/serverless-driver)ã€‚ 
  <Npm>
    @neondatabase/serverless
  </Npm>
  
  - æ‚¨åº”è¯¥å·²å®‰è£… `dotenv` åŒ…æ¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚ 
  <Npm>
    dotenv
  </Npm>  
</Prerequisites>

## è®¾ç½® Neon å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºæ–° Neon é¡¹ç›®

ç™»å½•åˆ° [Neon æ§åˆ¶å°](https://console.neon.tech/app/projects) å¹¶å¯¼èˆªåˆ°é¡¹ç›®éƒ¨åˆ†ã€‚é€‰æ‹©ä¸€ä¸ªé¡¹ç›®æˆ–ç‚¹å‡» `æ–°å»ºé¡¹ç›®` æŒ‰é’®ä»¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚

æ‚¨çš„ Neon é¡¹ç›®å¸¦æœ‰ä¸€ä¸ªå¯å³ç”¨çš„ Postgres æ•°æ®åº“ï¼Œåä¸º `neondb`ã€‚æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨å®ƒã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªåˆ°é¡¹ç›®æ§åˆ¶å°ä¸­çš„ **è¿æ¥è¯¦ç»†ä¿¡æ¯** éƒ¨åˆ†ä»¥æ‰¾åˆ°æ‚¨çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚å®ƒåº”è¯¥ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š

```bash
postgres://username:password@ep-cool-darkness-123456.us-east-2.aws.neon.tech/neondb
```

å°† `DATABASE_URL` ç¯å¢ƒå˜é‡æ·»åŠ åˆ°æ‚¨çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ä¸­ï¼Œæ‚¨å°†ä½¿ç”¨å®ƒè¿æ¥åˆ° Neon æ•°æ®åº“ã€‚

```text copy
DATABASE_URL=NEON_DATABASE_CONNECTION_STRING
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“ 

åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶å¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db.ts"
import { drizzle } from "drizzle-orm/neon-http";
import { neon } from "@neondatabase/serverless";
import { config } from "dotenv";

config({ path: ".env" }); // æˆ–è€… .env.local

const sql = neon(process.env.DATABASE_URL!);
export const db = drizzle({ client: sql });
```

#### åˆ›å»ºè¡¨

åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from "drizzle-kit";

config({ path: '.env' });

export default defineConfig({
  schema: "./src/schema.ts",
  out: "./migrations",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å°†å­˜å‚¨åœ¨æ‚¨ `drizzle.config.ts` ä¸­æŒ‡å®šçš„ `drizzle/migrations` ç›®å½•ä¸­ã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ‚¨çš„æ•°æ®åº“æ¨¡å¼æ‰€éœ€çš„ SQL æ–‡ä»¶ï¼Œå¹¶åŒ…å«ä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µçš„æ¨¡å¼å¿«ç…§ã€‚

ç”Ÿæˆçš„è¿ç§»ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">æ¨é€å‘½ä»¤éå¸¸é€‚åˆå¿«é€Ÿæµ‹è¯•æ–°æ¨¡å¼è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­çš„æ›´æ”¹ï¼Œå…è®¸å¿«é€Ÿè¿­ä»£è€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

</Steps>

### åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬åœ¨ `db.ts` ä¸­çš„è¿æ¥ï¼Œåœ¨ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ï¼Œä»¥åŠåœ¨ `migrate.ts` æ–‡ä»¶ä¸­çš„è¿ç§»è„šæœ¬ï¼Œè¯¥æ–‡ä»¶è´Ÿè´£åº”ç”¨å­˜å‚¨åœ¨ `migrations` ç›®å½•ä¸­çš„è¿ç§»ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“œ db.ts
 â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚  â”œ ğŸ“‚ meta
 â”‚  â”‚  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”” ğŸ“œ 0000_dry_richard_fisk.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º `src/queries` æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œï¼ˆæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°ã€åˆ é™¤ï¼‰åˆ›å»ºå•ç‹¬çš„æ–‡ä»¶ã€‚

#### æ’å…¥æ•°æ®

æœ‰å…³æ’å…¥æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/queries/insert.ts" {4, 8}
import { db } from '../db';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

æœ‰å…³é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/select)ã€‚

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

```typescript copy filename="src/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getColumns, sql } from 'drizzle-orm';
import { db } from '../db';
import { SelectUser, usersTable, postsTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

æœ‰å…³æ›´æ–°æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../db';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

æœ‰å…³åˆ é™¤æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/queries/delete.ts" {5}
import { db } from '../db';
import { eq } from 'drizzle-orm';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```


Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-nile


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';
import TransferCode from '@mdx/get-started/TransferCode.mdx';
import ApplyChanges from '@mdx/get-started/ApplyChanges.mdx';
import RunFile from '@mdx/get-started/RunFile.mdx';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ORM ä¸ [Nile æ•°æ®åº“](https://thenile.dev)ã€‚Nile æ˜¯ä¸ºå¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºé‡æ–°è®¾è®¡çš„ Postgresã€‚

æœ¬æ•™ç¨‹å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ä¸ Nile çš„è™šæ‹Ÿç§Ÿæˆ·æ•°æ®åº“æ¥å¼€å‘ä¸€ä¸ªå®‰å…¨ã€å¯æ‰©å±•çš„å¤šç§Ÿæˆ·åº”ç”¨ç¨‹åºã€‚

æˆ‘ä»¬å°†é€æ­¥æ„å»ºè¿™ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚å¦‚æœæ‚¨æƒ³æŸ¥çœ‹å®Œæ•´çš„ç¤ºä¾‹ï¼Œå¯ä»¥æŸ¥çœ‹å®ƒçš„ [Github ä»“åº“](https://github.com/niledatabase/niledatabase/tree/main/examples/quickstart/drizzle)ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆå®‰è£…ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `node-postgres` åŒ…ä»¥è¿æ¥åˆ° Postgres æ•°æ®åº“ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/node-postgres)
<Npm>
  node-postgres
</Npm>
- æ‚¨åº”è¯¥å®‰è£… `express` åŒ…ä»¥ä½œä¸º Web æ¡†æ¶ã€‚æœ‰å…³ express çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://expressjs.com/)
<Npm>
  express
</Npm>

- æœ¬æŒ‡å—ä½¿ç”¨ [AsyncLocalStorage](https://nodejs.org/api/async_context.html) æ¥ç®¡ç†ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœæ‚¨çš„æ¡†æ¶æˆ–è¿è¡Œæ—¶ä¸æ”¯æŒ `AsyncLocalStorage`ï¼Œæ‚¨å¯ä»¥å‚è€ƒ [Drizzle\<\>Nile](../connect-nile) æ–‡æ¡£ä»¥è·å–æ›¿ä»£é€‰é¡¹ã€‚
</Prerequisites>

## è®¾ç½® Nile å’Œ Drizzle ORM

<Steps>
#### æ³¨å†Œ Nile å¹¶åˆ›å»ºæ•°æ®åº“

å¦‚æœæ‚¨è¿˜æ²¡æœ‰ï¼Œè¯·æ³¨å†Œ [Nile](https://console.thenile.dev)ï¼Œå¹¶æŒ‰ç…§åº”ç”¨è¯´æ˜åˆ›å»ºä¸€ä¸ªæ–°æ•°æ®åº“ã€‚

#### è·å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

åœ¨å·¦ä¾§è¾¹æ ä¸­ï¼Œé€‰æ‹©â€œè®¾ç½®â€é€‰é¡¹ï¼Œç‚¹å‡» Postgres å¾½æ ‡ï¼Œç„¶åç‚¹å‡»â€œç”Ÿæˆå‡­è¯â€ã€‚å¤åˆ¶è¿æ¥å­—ç¬¦ä¸²å¹¶å°†å…¶æ·»åŠ åˆ°é¡¹ç›®ä¸­çš„ `.env` æ–‡ä»¶ï¼š

```plaintext copy
NILEDB_URL=postgres://youruser:yourpassword@us-west-2.db.thenile.dev:5432:5432/your_db_name
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `db.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/db.ts"
import { drizzle } from 'drizzle-orm/node-postgres';
import dotenv from "dotenv/config";
import { sql } from "drizzle-orm";
import { AsyncLocalStorage } from "async_hooks";

export const db = drizzle(process.env.NILEDB_URL);
export const tenantContext = new AsyncLocalStorage<string | undefined>();

export function tenantDB<T>(cb: (tx: any) => T | Promise<T>): Promise<T> {
  return db.transaction(async (tx) => {
    const tenantId = tenantContext.getStore();
    console.log("æ‰§è¡Œå¸¦ç§Ÿæˆ·çš„æŸ¥è¯¢: " + tenantId);
    // å¦‚æœæœ‰ç§Ÿæˆ· IDï¼Œåœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­è®¾ç½®å®ƒ
    if (tenantId) {
      await tx.execute(sql`set local nile.tenant_id = '${sql.raw(tenantId)}'`);
    }

    return cb(tx);
  }) as Promise<T>;
}
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - æ­¤é…ç½®æ–‡ä»¶ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨ï¼ŒåŒ…å«æœ‰å…³æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';
export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.NILEDB_URL!,
  },
});
```

#### è§£æ Nile æ•°æ®åº“

Nile æ•°æ®åº“å…·æœ‰å†…ç½®è¡¨ã€‚å…¶ä¸­æœ€é‡è¦çš„æ˜¯ `tenants` è¡¨ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†ç§Ÿæˆ·ã€‚
ä¸ºäº†èƒ½åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ­¤è¡¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Drizzle Kit CLI ç”ŸæˆåŒ…å«æ­¤æ¶æ„çš„æ¨¡å¼æ–‡ä»¶ã€‚

```bash copy
npx drizzle-kit pull
```

è§£æçš„ç»“æœå°†æ˜¯ä¸€ä¸ª `schema.ts` æ–‡ä»¶ã€ä¸€ä¸ªåŒ…å«æ•°æ®åº“æ¨¡å¼å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€ä¸€ä¸ªå¸¦æœ‰è¿ç§»çš„ sql æ–‡ä»¶å’Œä¸€ä¸ªç”¨äº [å…³ç³»æŸ¥è¯¢](/docs/rqb) çš„ `relations.ts` æ–‡ä»¶ã€‚

<TransferCode/>

è¿™æ˜¯ç”Ÿæˆçš„ `schema.ts` æ–‡ä»¶ç¤ºä¾‹ï¼š

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡è§£æç”Ÿæˆçš„è¡¨æ¨¡å¼
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});
```

#### åˆ›å»ºé™„åŠ è¡¨

é™¤äº†å†…ç½®è¡¨ä¹‹å¤–ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿˜éœ€è¦ä¸€äº›è¡¨æ¥å­˜å‚¨æ•°æ®ã€‚æˆ‘ä»¬å°†å®ƒä»¬æ·»åŠ åˆ°ä¹‹å‰ç”Ÿæˆçš„ `src/db/schema.ts` ä¸­ï¼Œå› æ­¤è¯¥æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript copy filename="src/db/schema.ts"
// é€šè¿‡è§£æç”Ÿæˆçš„è¡¨æ¨¡å¼
import { pgTable, uuid, text, timestamp, varchar, vector, boolean } from "drizzle-orm/pg-core"
import { sql } from "drizzle-orm"

export const tenants = pgTable("tenants", {
	id: uuid().default(sql`public.uuid_generate_v7()`).primaryKey().notNull(),
	name: text(),
	created: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	updated: timestamp({ mode: 'string' }).default(sql`LOCALTIMESTAMP`).notNull(),
	deleted: timestamp({ mode: 'string' }),
});

export const todos = pgTable("todos", {
	id: uuid().defaultRandom(),
	tenantId: uuid("tenant_id"),
	title: varchar({ length: 256 }),
	estimate: varchar({ length: 256 }),
	embedding: vector({ dimensions: 3 }),
	complete: boolean(),
});
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

<ApplyChanges />

#### åˆå§‹åŒ– web åº”ç”¨

ç°åœ¨æˆ‘ä»¬å·²ç»è®¾ç½® Drizzle è¿æ¥åˆ° Nileï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æ¨¡å¼å·²å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤šç§Ÿæˆ· Web åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒä»¬ã€‚
åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Express ä½œä¸º Web æ¡†æ¶ï¼Œå°½ç®¡ Nile å’Œ Drizzle å¯ä»¥ä¸ä»»ä½• Web æ¡†æ¶ä¸€èµ·ä½¿ç”¨ã€‚

ä¸ºäº†ä¿æŒç¤ºä¾‹ç®€å•ï¼Œæˆ‘ä»¬å°†åœ¨å•ä¸ªæ–‡ä»¶ `src/app.ts` ä¸­å®ç° Web åº”ç”¨ã€‚æˆ‘ä»¬å°†é€šè¿‡åˆå§‹åŒ– Web åº”ç”¨å¼€å§‹ï¼š

```typescript copy filename="src/app.ts"
import express from "express";
import { tenantDB, tenantContext, db } from "./db/db";
import {
  tenants as tenantSchema,
  todos as todoSchema,
} from "./db/schema";
import { eq } from "drizzle-orm";

const PORT = process.env.PORT || 3001;

const app = express();
app.listen(PORT, () => console.log(`æœåŠ¡å™¨æ­£åœ¨ç«¯å£ ${PORT} ä¸Šè¿è¡Œ`));
app.use(express.json());
```

#### åˆå§‹åŒ–ç§Ÿæˆ·æ„ŸçŸ¥ä¸­é—´ä»¶

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ç¤ºä¾‹ä¸­æ·»åŠ ä¸­é—´ä»¶ã€‚æ­¤ä¸­é—´ä»¶ä»è·¯å¾„å‚æ•°ä¸­è·å–ç§Ÿæˆ· IDï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ `AsyncLocalStorage` ä¸­ã€‚
æˆ‘ä»¬åœ¨ `src/db/index.ts` ä¸­åˆ›å»ºçš„ `tenantDB` åŒ…è£…å™¨ä½¿ç”¨è¯¥ç§Ÿæˆ· ID åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶è®¾ç½® `nile.tenant_id`ï¼Œè¿™ç¡®ä¿äº†ä¸€æ—¦æŸ¥è¯¢å°†é’ˆå¯¹è¯¥ç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“æ‰§è¡Œã€‚

```typescript copy filename="src/app.ts"
// æ ¹æ® URL å‚æ•°åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç§Ÿæˆ· ID
app.use('/api/tenants/:tenantId/*', (req, res, next) => {
  const tenantId = req.params.tenantId;
  console.log("è®¾ç½®ä¸Šä¸‹æ–‡ä¸ºç§Ÿæˆ·: " + tenantId);
  tenantContext.run(tenantId, next);
});
```

<Callout>
è¯¥ç¤ºä¾‹ä»è·¯å¾„å‚æ•°è·å–ç§Ÿæˆ· IDï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡ `x-tenant-id` çš„æ ‡å¤´æˆ– cookie æ¥è®¾ç½®ç§Ÿæˆ· IDã€‚
</Callout>

#### æ·»åŠ è·¯ç”±

æœ€åï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›è·¯ç”±ï¼Œç”¨äºåˆ›å»ºå’Œåˆ—å‡ºç§Ÿæˆ·åŠå¾…åŠäº‹é¡¹ã€‚æ³¨æ„æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ `tenantDB` åŒ…è£…å™¨æ¥è¿æ¥ç§Ÿæˆ·çš„è™šæ‹Ÿæ•°æ®åº“ã€‚
åŒæ ·æ³¨æ„ï¼Œåœ¨ `app.get("/api/tenants/:tenantId/todos"` ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨æŸ¥è¯¢ä¸­æŒ‡å®š `where tenant_id=...`ã€‚
è¿™æ°æ°æ˜¯å› ä¸ºæˆ‘ä»¬è·¯ç”±åˆ°è¯¥ç§Ÿæˆ·çš„æ•°æ®åº“ï¼Œä¸”æŸ¥è¯¢ä¸èƒ½è¿”å›å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®ã€‚

```typescript copy filename="src/app.ts" {6,20,39,58,62,75,83}
// åˆ›å»ºæ–°ç§Ÿæˆ·
app.post("/api/tenants", async (req, res) => {
  try {
    const name = req.body.name;
    var tenants: any = null;
    tenants = await tenantDB(async (tx) => {
        return await tx.insert(tenantSchema).values({ name }).returning();
    });
    res.json(tenants);
  } catch (error: any) {
    console.log("åˆ›å»ºç§Ÿæˆ·æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// è¿”å›ç§Ÿæˆ·åˆ—è¡¨
app.get("/api/tenants", async (req, res) => {
  let tenants: any = [];
  try {
      tenants = await tenantDB(async (tx) => {
        return await tx.select().from(tenantSchema);
      });
    res.json(tenants);
  } catch (error: any) {
    console.log("åˆ—å‡ºç§Ÿæˆ·æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// ä¸ºç§Ÿæˆ·æ·»åŠ æ–°ä»»åŠ¡
app.post("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    const { title, complete } = req.body;
    if (!title) {
      res.status(400).json({message: "æœªæä¾›ä»»åŠ¡æ ‡é¢˜",});
    }
    const tenantId = req.params.tenantId;

    const newTodo = await tenantDB(async (tx) => {
      return await tx
        .insert(todoSchema)
        .values({ tenantId, title, complete })
        .returning();
    });
    // è¿”å›æ—¶ä¸åŒ…æ‹¬ embedding å‘é‡ï¼Œå› ä¸ºå®ƒå¾ˆå¤§ä¸”æ— ç”¨
    res.json(newTodo);
  } catch (error: any) {
    console.log("æ·»åŠ ä»»åŠ¡æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// æ›´æ–°ç§Ÿæˆ·çš„ä»»åŠ¡
// å› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­æœ‰ç§Ÿæˆ·ï¼Œæ‰€ä»¥ä¸éœ€è¦ where å­å¥
app.put("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    const { id, complete } = req.body;
    await tenantDB(async (tx) => {
      return await tx
        .update(todoSchema)
        .set({ complete })
        .where(eq(todoSchema.id, id));
    });
    res.sendStatus(200);
  } catch (error: any) {
    console.log("æ›´æ–°ä»»åŠ¡æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯",});
  }
});

// è·å–ç§Ÿæˆ·çš„æ‰€æœ‰ä»»åŠ¡
app.get("/api/tenants/:tenantId/todos", async (req, res) => {
  try {
    // è¿™é‡Œä¸éœ€è¦â€œwhereâ€å­å¥ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®äº†ç§Ÿæˆ· ID
    const todos = await tenantDB(async (tx) => {
      return await tx
        .select({
          id: todoSchema.id,
          tenant_id: todoSchema.tenantId,
          title: todoSchema.title,
          estimate: todoSchema.estimate,
        })
        .from(todoSchema);
    });
    res.json(todos);
  } catch (error: any) {
    console.log("åˆ—å‡ºä»»åŠ¡æ—¶å‡ºé”™: " + error.message);
    res.status(500).json({message: error.message,});
  }
});
```

#### å°è¯•ä¸€ä¸‹ï¼

æ‚¨ç°åœ¨å¯ä»¥è¿è¡Œæ‚¨çš„æ–° Web åº”ç”¨ï¼š

```bash copy
npx tsx src/app.ts
```

å¹¶ä½¿ç”¨ `curl` å°è¯•æ‚¨åˆšåˆšåˆ›å»ºçš„è·¯ç”±ï¼š

```bash
# åˆ›å»ºä¸€ä¸ªç§Ÿæˆ·
curl --location --request POST 'localhost:3001/api/tenants' \
--header 'Content-Type: application/json' \
--data-raw '{"name":"æˆ‘çš„ç¬¬ä¸€ä¸ªå®¢æˆ·"}'

# è·å–ç§Ÿæˆ·åˆ—è¡¨
curl  -X GET 'http://localhost:3001/api/tenants'

# åˆ›å»ºå¾…åŠäº‹é¡¹ï¼ˆè¯·åŠ¡å¿…åœ¨ URL ä¸­ä½¿ç”¨çœŸå®çš„ç§Ÿæˆ· IDï¼‰
curl  -X POST \
  'http://localhost:3001/api/tenants/108124a5-2e34-418a-9735-b93082e9fbf2/todos' \
  --header 'Content-Type: application/json' \
  --data-raw '{"title": "å–‚çŒ«", "complete": false}'

# åˆ—å‡ºç§Ÿæˆ·çš„å¾…åŠäº‹é¡¹ï¼ˆè¯·åŠ¡å¿…åœ¨ URL ä¸­ä½¿ç”¨çœŸå®çš„ç§Ÿæˆ· IDï¼‰
curl  -X GET \
  'http://localhost:3001/api/tenants/108124a5-2e34-418a-9735-b93082e9fbf2/todos'
```
</Steps>

## é¡¹ç›®æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬ `db.ts` ä¸­çš„è¿æ¥å’Œ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ã€‚
ç”±è¿ç§»å’Œè§£æç”Ÿæˆçš„æ–‡ä»¶ä½äº `./drizzle` ä¸­ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ db.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”‚   â”” ğŸ“œ app.ts
 â”œ ğŸ“‚ drizzle
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”œ ğŸ“œ relations.ts
 â”‚   â”œ ğŸ“œ schema.ts
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”” ğŸ“œ package.json
```

Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-supabase


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥ [Supabase æ•°æ®åº“](https://supabase.com/docs/guides/database/overview)ã€‚æ¯ä¸ª Supabase é¡¹ç›®éƒ½é™„å¸¦ä¸€ä¸ªå®Œæ•´çš„ [Postgres](https://www.postgresql.org/) æ•°æ®åº“ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- æ‚¨åº”è¯¥å·²å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³è¯¥åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·[ç‚¹å‡»æ­¤å¤„](https://www.npmjs.com/package/dotenv)ã€‚
<Npm>
  dotenv
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `postgres` åŒ…ä»¥è¿æ¥åˆ° Postgres æ•°æ®åº“ã€‚æœ‰å…³è¯¥åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·[ç‚¹å‡»æ­¤å¤„](https://www.npmjs.com/package/postgres)ã€‚
<Npm>
  postgres
</Npm>

- æ‚¨è¿˜åº”å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ [Supabase CLI](https://supabase.com/docs/guides/cli/getting-started#installing-the-supabase-cli)ï¼ˆä»…åœ¨æ‚¨æƒ³ä½¿ç”¨ Supabase CLI è¿›è¡Œè¿ç§»æ—¶ï¼‰ã€‚
</Prerequisites>

è¯·æŸ¥çœ‹ [Supabase æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connecting-with-drizzle)ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“ã€‚

## è®¾ç½® Supabase å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Supabase é¡¹ç›®

æ‚¨å¯ä»¥åœ¨ [ä»ªè¡¨æ¿](https://supabase.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Supabase é¡¹ç›®ï¼Œæˆ–é€šè¿‡æ­¤ [é“¾æ¥](https://database.new/) åˆ›å»ºã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªåˆ° [æ•°æ®åº“è®¾ç½®](https://supabase.com/dashboard/project/_/settings/database)ï¼Œå¹¶ä» `è¿æ¥å­—ç¬¦ä¸²` éƒ¨åˆ†å¤åˆ¶ URIã€‚ç¡®ä¿ä½¿ç”¨ `è¿æ¥æ± `ã€‚è¯·è®°å¾—ç”¨æ‚¨çš„å®é™…æ•°æ®åº“å¯†ç æ›¿æ¢å¯†ç å ä½ç¬¦ã€‚

å°† `DATABASE_URL` å˜é‡æ·»åŠ åˆ°æ‚¨çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ä¸­ã€‚

```plaintext copy
DATABASE_URL=<YOUR_DATABASE_URL>
```

æœ‰å…³è¿æ¥æ± å’Œæ± æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)ã€‚

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { config } from 'dotenv';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

config({ path: '.env' }); // æˆ– .env.local

const client = postgres(process.env.DATABASE_URL!);
export const db = drizzle({ client });
```

#### åˆ›å»ºè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ä¸€ä¸ªç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¶æ„æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './supabase/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `supabase/migrations` ç›®å½•ä¸­ï¼Œæ­£å¦‚æ‚¨åœ¨ `drizzle.config.ts` ä¸­æŒ‡å®šçš„é‚£æ ·ã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ‚¨çš„æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ªç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µæ¶æ„å¿«ç…§çš„ `meta` æ–‡ä»¶å¤¹ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

äº†è§£æœ‰å…³ [è¿ç§»è¿‡ç¨‹](/docs/migrations) çš„æ›´å¤šä¿¡æ¯ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ [Supabase CLI](https://supabase.com/docs/guides/cli/getting-started) åº”ç”¨è¿ç§»ï¼š
- å¯¹äºå·²å­˜åœ¨çš„è¡¨ï¼Œæ‰‹åŠ¨å®¡æŸ¥ä» `npx drizzle-kit generate` ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ï¼Œå¹¶æ³¨é‡Šæˆ–è°ƒæ•´ä»»ä½•ä¸å®‰å…¨çš„çº¯åˆ›å»ºè¯­å¥ï¼ˆä¾‹å¦‚ï¼Œ`CREATE SCHEMA "auth";`ï¼‰ï¼Œç¡®ä¿å®‰å…¨çš„æ¡ä»¶åˆ›å»ºï¼ˆä¾‹å¦‚ï¼Œ`CREATE TABLE IF NOT EXISTS "auth"."users"`ï¼‰å¾—åˆ°å¦¥å–„å¤„ç†ã€‚

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œæ›´æ”¹çš„æƒ…å†µï¼Œä½¿æ‚¨èƒ½å¤Ÿå¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

è¦ä½¿ç”¨ Supabase CLI åº”ç”¨è¿ç§»ï¼Œæ‚¨åº”éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

ä½¿ç”¨ Drizzle Kit ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

åˆå§‹åŒ–æœ¬åœ° Supabase é¡¹ç›®ï¼š

```bash copy
supabase init
```

å°†å…¶é“¾æ¥åˆ°æ‚¨çš„è¿œç¨‹é¡¹ç›®ï¼š

```bash copy
supabase link
```

å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
supabase db push
```
</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬åœ¨ `index.ts` ä¸­çš„è¿æ¥å’Œåœ¨ `schema.ts` ä¸­çš„æ¶æ„å®šä¹‰ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ supabase
 â”‚   â”œ ğŸ“‚ migrations
 â”‚   â”‚  â”œ ğŸ“‚ meta
 â”‚   â”‚  â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”‚  â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”‚   â”” ğŸ“œ config.toml
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º `src/db/queries` æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œï¼ˆæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°ã€åˆ é™¤ï¼‰å•ç‹¬åˆ›å»ºæ–‡ä»¶ã€‚

#### æ’å…¥æ•°æ®

æœ‰å…³æ’å…¥æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

æœ‰å…³é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/select)ã€‚

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚
#### æ›´æ–°æ•°æ®

æœ‰å…³æ›´æ–°æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

æœ‰å…³åˆ é™¤æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```

Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-turso


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†å¦‚ä½•å°† Drizzle ORM ä¸ [Turso](https://docs.turso.tech/introduction) ä¸€èµ·ä½¿ç”¨ã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®ç°ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³è¯¥åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† `@libsql/client` åŒ…ã€‚æœ‰å…³è¯¥åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/@libsql/client)ã€‚
<Npm>
  @libsql/client
</Npm>
- æ‚¨åº”è¯¥å·²ç»å®‰è£…äº† Turso CLIã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [æ–‡æ¡£](https://docs.turso.tech/cli/introduction)
</Prerequisites>

[Turso](https://docs.turso.tech/concepts) æ˜¯ä¸€ä¸ªå…¼å®¹ SQLite çš„æ•°æ®åº“ï¼Œå»ºç«‹åœ¨ [libSQL](https://docs.turso.tech/libsql) ä¸Šï¼Œè¿™æ˜¯ SQLite çš„å¼€æ”¾è´¡çŒ®åˆ†æ”¯ã€‚å®ƒå…è®¸æ¯ä¸ªç»„ç»‡æ‰©å±•åˆ°æ•°åä¸‡ä¸ªæ•°æ®åº“ï¼Œå¹¶æ”¯æŒå°†æ•°æ®å¤åˆ¶åˆ°ä»»ä½•ä½ç½®ï¼ŒåŒ…æ‹¬æ‚¨è‡ªå·±çš„æœåŠ¡å™¨ï¼Œä»è€Œå®ç°å¾®ç§’çº§å»¶è¿Ÿè®¿é—®ã€‚æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ](https://docs.turso.tech/concepts) é˜…è¯»æœ‰å…³ Turso æ¦‚å¿µçš„æ›´å¤šå†…å®¹ã€‚

Drizzle ORM æœ¬èº«æ”¯æŒ libSQL é©±åŠ¨ç¨‹åºï¼Œæˆ‘ä»¬æ‹¥æŠ± SQL æ–¹è¨€åŠæ–¹è¨€ç‰¹å®šçš„é©±åŠ¨ç¨‹åºå’Œè¯­æ³•ï¼Œå¹¶åæ˜ å¤§å¤šæ•°æµè¡Œçš„ç±»ä¼¼ SQLite çš„ `all`ã€`get`ã€`values` å’Œ `run` æŸ¥è¯¢æ–¹æ³•è¯­æ³•ã€‚

è¯·æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£](https://docs.turso.tech/quickstart) ä»¥è®¾ç½® Turso æ•°æ®åº“ã€‚

## è®¾ç½® Turso å’Œ Drizzle ORM

<Steps>
#### æ³¨å†Œæˆ–ç™»å½•åˆ° Turso

æ³¨å†Œï¼š

```bash copy
turso auth signup
```

ç™»å½•ï¼š

```bash copy
turso auth login
```

#### åˆ›å»ºæ–°æ•°æ®åº“

é€šè¿‡è¿è¡Œ `turso db create <DATABASE_NAME>` å‘½ä»¤åˆ›å»ºæ–°æ•°æ®åº“ï¼š

```bash copy
turso db create drizzle-turso-db
```

è¦æŸ¥çœ‹æœ‰å…³æ•°æ®åº“çš„ä¿¡æ¯ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
turso db show drizzle-turso-db
```

#### åˆ›å»ºèº«ä»½éªŒè¯ä»¤ç‰Œ

è¦ä¸ºæ‚¨çš„æ•°æ®åº“åˆ›å»ºèº«ä»½éªŒè¯ä»¤ç‰Œï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash copy
turso db tokens create drizzle-turso-db
```

åœ¨ [æ–‡æ¡£](https://docs.turso.tech/cli/db/tokens/create) ä¸­äº†è§£æœ‰å…³æ­¤å‘½ä»¤åŠå…¶é€‰é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚

#### æ›´æ–°ç¯å¢ƒå˜é‡

ç”¨è¿æ¥ URL å’Œèº«ä»½éªŒè¯ä»¤ç‰Œæ›´æ–°æ‚¨çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ã€‚

```text copy
TURSO_CONNECTION_URL=
TURSO_AUTH_TOKEN=
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { config } from 'dotenv';
import { drizzle } from 'drizzle-orm/libsql';

config({ path: '.env' }); // æˆ– .env.local

export const db = drizzle({ connection: {
  url: process.env.TURSO_CONNECTION_URL!,
  authToken: process.env.TURSO_AUTH_TOKEN!,
}});
```

#### åˆ›å»ºè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { sql } from 'drizzle-orm';
import { integer, sqliteTable, text } from 'drizzle-orm/sqlite-core';

export const usersTable = sqliteTable('users', {
  id: integer('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').unique().notNull(),
});

export const postsTable = sqliteTable('posts', {
  id: integer('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: text('created_at')
    .default(sql`(CURRENT_TIMESTAMP)`)
    .notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' }).$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - ç”¨äº [Drizzle Kit](/docs/kit-overview) çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'turso',
  dbCredentials: {
    url: process.env.TURSO_CONNECTION_URL!,
    authToken: process.env.TURSO_AUTH_TOKEN!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨åˆ°æ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `migrations` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨çš„ `drizzle.config.ts` ä¸­æ‰€æŒ‡å®šã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ•°æ®åº“æ¨¡å¼æ‰€éœ€çš„ SQL æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µçš„æ¨¡å¼å¿«ç…§ã€‚

ç”Ÿæˆçš„è¿ç§»ç¤ºä¾‹ï¼š

```sql
CREATE TABLE `posts` (
	`id` integer PRIMARY KEY NOT NULL,
	`title` text NOT NULL,
	`content` text NOT NULL,
	`user_id` integer NOT NULL,
	`created_at` text DEFAULT (CURRENT_TIMESTAMP) NOT NULL,
	`updated_at` integer,
	FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON UPDATE no action ON DELETE cascade
);
--> statement-breakpoint
CREATE TABLE `users` (
	`id` integer PRIMARY KEY NOT NULL,
	`name` text NOT NULL,
	`age` integer NOT NULL,
	`email` text NOT NULL
);
--> statement-breakpoint
CREATE UNIQUE INDEX `users_email_unique` ON `users` (`email`);
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) å°†æ›´æ”¹ç›´æ¥æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºæ‚¨éœ€è¦åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿæµ‹è¯•æ–°æ¨¡å¼è®¾è®¡æˆ–æ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸å¿«é€Ÿè¿­ä»£è€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„è´Ÿæ‹…ã€‚</Callout>
</Steps>

### åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬åœ¨ `index.ts` ä¸­çš„è¿æ¥å’Œåœ¨ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚  â”œ ğŸ“‚ meta
 â”‚  â”‚  â”œ ğŸ“œ _journal.json
 â”‚  â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚  â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»º `src/db/queries` æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œï¼šæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°ã€åˆ é™¤åˆ†åˆ«åˆ›å»ºæ–‡ä»¶ã€‚

#### æ’å…¥æ•°æ®

æœ‰å…³æ’å…¥æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

æœ‰å…³é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [æ–‡æ¡£](/docs/select)ã€‚

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, count, eq, getColumns, gt, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(gt(postsTable.createdAt, sql`(datetime('now','-24 hour'))`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

å¦å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

æœ‰å…³æ›´æ–°æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

æœ‰å…³åˆ é™¤æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```


Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-vercel


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Drizzle ORM ç»“åˆ [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres)ã€‚Vercel Postgres æ˜¯ä¸€ä¸ªæ— æœåŠ¡å™¨ SQL æ•°æ®åº“ï¼Œæ—¨åœ¨ä¸ Vercel Functions å’Œæ‚¨çš„å‰ç«¯æ¡†æ¶é›†æˆã€‚

<Prerequisites>
- æ‚¨åº”è¯¥å·²å®‰è£… Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `dotenv` åŒ…ä»¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>

- æ‚¨åº”è¯¥å·²å®‰è£… `@vercel/postgres` åŒ…ã€‚æœ‰å…³æ­¤åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯» [è¿™é‡Œ](https://www.npmjs.com/package/@vercel/postgres)
<Npm>
  @vercel/postgres
</Npm>  
</Prerequisites>

æŸ¥çœ‹ [Vercel æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/using-an-orm#drizzle)ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨ Drizzle ORM è¿æ¥åˆ°æ•°æ®åº“ã€‚

## è®¾ç½® Vercel Postgres å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºæ–°çš„ Vercel Postgres æ•°æ®åº“

æ‚¨å¯ä»¥åœ¨ [æ§åˆ¶é¢æ¿](https://vercel.com/dashboard) ä¸­åˆ›å»ºæ–°çš„ Vercel Postgres æ•°æ®åº“ã€‚

è¯·æŸ¥é˜… Vercel Postgres [æ–‡æ¡£](https://vercel.com/docs/storage/vercel-postgres/quickstart) ä»¥äº†è§£å¦‚ä½•åˆ›å»ºæ–°çš„æ•°æ®åº“ã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªè‡³æ‚¨çš„ Vercel Postgres æ•°æ®åº“å¹¶ä» `.env.local` éƒ¨åˆ†å¤åˆ¶ `POSTGRES_URL`ã€‚

å°† `POSTGRES_URL` æ·»åŠ åˆ°æ‚¨çš„ `.env.local` æˆ– `.env` æ–‡ä»¶ä¸­ã€‚

```plaintext copy
POSTGRES_URL=<YOUR_DATABASE_URL>
```

#### å°† Drizzle ORM è¿æ¥åˆ°æ‚¨çš„æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `index.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ‚¨çš„æ•°æ®åº“é…ç½®ï¼š

```typescript copy filename="src/db/index.ts"
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { config } from 'dotenv';

config({ path: '.env.local' }); // æˆ– .env

export const db = drizzle();

```

#### åˆ›å»ºè¡¨

åœ¨ `src/db` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `schema.ts` æ–‡ä»¶ï¼Œå¹¶å£°æ˜æ‚¨çš„è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - è¿™æ˜¯ç”± [Drizzle Kit](/docs/kit-overview) ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³æ‚¨çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env.local' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

æ‚¨å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle/migrations` ç›®å½•ä¸­ï¼Œå¦‚æ‚¨åœ¨ `drizzle.config.ts` ä¸­æŒ‡å®šçš„é‚£æ ·ã€‚è¯¥ç›®å½•å°†åŒ…å«æ›´æ–°æ‚¨çš„æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶ä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µçš„æ¶æ„å¿«ç…§ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

è¿è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¶æ„è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œæ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>

</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

è¿™æ˜¯é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„ã€‚åœ¨ `src/db` ç›®å½•ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬åœ¨ `index.ts` ä¸­çš„è¿æ¥å’Œåœ¨ `schema.ts` ä¸­çš„æ¨¡å¼å®šä¹‰ã€‚

```plaintext
ğŸ“¦ <project root>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env.local
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»º `src/db/queries` æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œåˆ†å¼€æ–‡ä»¶ï¼šæ’å…¥ã€é€‰æ‹©ã€æ›´æ–°ã€åˆ é™¤ã€‚

#### æ’å…¥æ•°æ®

æœ‰å…³æ’å…¥æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### é€‰æ‹©æ•°æ®

æœ‰å…³é€‰æ‹©æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/select)ã€‚

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

æœ‰å…³æ›´æ–°æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

æœ‰å…³åˆ é™¤æŸ¥è¯¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```


Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-with-xata


import Prerequisites from "@mdx/Prerequisites.astro";
import Npm from '@mdx/Npm.astro';
import Steps from '@mdx/Steps.astro';
import Section from "@mdx/Section.astro";
import Callout from '@mdx/Callout.astro';

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•å°† Drizzle ORM ä¸ [Xata](https://xata.io) ä¸€èµ·ä½¿ç”¨ã€‚Xata æ˜¯ä¸€ä¸ª PostgreSQL æ•°æ®åº“å¹³å°ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ›´é«˜æ•ˆåœ°è¿ç»´å’Œæ‰©å±•æ•°æ®åº“ï¼Œå…·å¤‡å³æ—¶å†™æ—¶å¤åˆ¶æ•°æ®åº“åˆ†æ”¯ã€é›¶åœæœºæ¨¡å¼çš„æ¶æ„å˜æ›´ã€æ•°æ®åŒ¿ååŒ–ä»¥åŠ AI é©±åŠ¨çš„æ€§èƒ½ç›‘æ§ç­‰åŠŸèƒ½ã€‚

<Prerequisites>
- ä½ éœ€è¦å…ˆå®‰è£… Drizzle ORM å’Œ [Drizzle Kit](/docs/kit-overview)ã€‚å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
<Npm>
drizzle-orm
-D drizzle-kit
</Npm>
- ä½ éœ€è¦å®‰è£… `dotenv` åŒ…æ¥ç®¡ç†ç¯å¢ƒå˜é‡ã€‚å¯åœ¨è¿™é‡Œäº†è§£æ›´å¤šè¯¥åŒ…ä¿¡æ¯ï¼š[dotenv](https://www.npmjs.com/package/dotenv)
<Npm>
  dotenv
</Npm>

- ä½ éœ€è¦å®‰è£… `postgres` åŒ…ä»¥è¿æ¥ Postgres æ•°æ®åº“ã€‚è¯¦ç»†ä»‹ç»è§ï¼š[postgres](https://www.npmjs.com/package/postgres)
<Npm>
  postgres
</Npm>

- ä½ éœ€è¦æ‹¥æœ‰ä¸€ä¸ª Xata è´¦å·åŠå·²åˆ›å»ºæ•°æ®åº“ã€‚å‚è€ƒ [Xata æ–‡æ¡£](https://xata.io/documentation/getting-started) åˆ›å»ºè´¦æˆ·åŠæ•°æ®åº“ã€‚
</Prerequisites>

æŸ¥çœ‹[Xata æ–‡æ¡£](https://xata.io/documentation/quickstarts/drizzle)ä»¥äº†è§£æ›´å¤š Drizzle ORM ä¸ Xata çš„ä½¿ç”¨èµ„è®¯ã€‚

## è®¾ç½® Xata å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Xata æ•°æ®åº“

æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä¸€ä¸ªæ–°çš„ Xata æ•°æ®åº“ï¼š

1. æ³¨å†Œæˆ–ç™»å½•ä½ çš„ [Xata è´¦å·](https://xata.io/)
2. ä»ä»ªè¡¨ç›˜åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“
3. é€‰æ‹©ä½ æ‰€åœ¨åŒºåŸŸåŠæ•°æ®åº“åç§°
4. ç³»ç»Ÿå°†åˆ›å»ºå¸¦æœ‰ PostgreSQL ç«¯ç‚¹çš„æ•°æ®åº“

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

è¿›å…¥ Xata ä»ªè¡¨ç›˜ï¼Œå¤åˆ¶ PostgreSQL è¿æ¥å­—ç¬¦ä¸²ï¼Œè¯¥ä¿¡æ¯å¯åœ¨åˆ†æ”¯æ€»è§ˆé¡µæ‰¾åˆ°ã€‚

å°† `DATABASE_URL` å˜é‡æ·»åŠ è‡³ä½ çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ï¼š

```plaintext copy
DATABASE_URL=<YOUR_XATA_DATABASE_URL>
```

è¿æ¥å­—ç¬¦ä¸²æ ¼å¼ç¤ºä¾‹å¦‚ä¸‹ï¼š
```plaintext
postgresql://postgres:<password>@<branch-id>.<region>.xata.tech/<database>?sslmode=require
```

ç¤ºä¾‹ï¼š
```plaintext
postgresql://postgres:password@t56hgfp7hd2sjfeiqcn66qpo8s.us-east-1.xata.tech/app?sslmode=require
```

<Callout type="info">
Xata æä¾›äº†åŸºäºåˆ†æ”¯çš„å¼€å‘ï¼Œå…è®¸ä½ ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒåˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“åˆ†æ”¯ã€‚
</Callout>

#### è¿æ¥ Drizzle ORM åˆ°æ•°æ®åº“

åœ¨ `src/db` ç›®å½•ä¸‹åˆ›å»º `index.ts` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ï¼š

```typescript copy filename="src/db/index.ts"
import { config } from 'dotenv';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

config({ path: '.env' }); // æˆ–è€… .env.local

const client = postgres(process.env.DATABASE_URL!);
export const db = drizzle({ client });
```

#### åˆ›å»ºè¡¨ç»“æ„

åœ¨ `src/db` ç›®å½•ä¸‹æ–°å»º `schema.ts` æ–‡ä»¶ï¼Œå£°æ˜æ•°æ®è¡¨ï¼š

```typescript copy filename="src/db/schema.ts"
import { integer, pgTable, serial, text, timestamp } from 'drizzle-orm/pg-core';

export const usersTable = pgTable('users_table', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  age: integer('age').notNull(),
  email: text('email').notNull().unique(),
});

export const postsTable = pgTable('posts_table', {
  id: serial('id').primaryKey(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  userId: integer('user_id')
    .notNull()
    .references(() => usersTable.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at')
    .notNull()
    .$onUpdate(() => new Date()),
});

export type InsertUser = typeof usersTable.$inferInsert;
export type SelectUser = typeof usersTable.$inferSelect;

export type InsertPost = typeof postsTable.$inferInsert;
export type SelectPost = typeof postsTable.$inferSelect;
```

#### é…ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®æ–‡ä»¶**ç”¨äº [Drizzle Kit](/docs/kit-overview)ï¼ŒåŒ…å«æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€è¿ç§»æ–‡ä»¶å¤¹è·¯å¾„å’Œ schema æ–‡ä»¶è·¯å¾„ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `drizzle.config.ts` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from 'drizzle-kit';

config({ path: '.env' });

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### åº”ç”¨æ•°æ®åº“å˜æ›´

ä½ å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼Œå†ç”¨ `drizzle-kit migrate` å‘½ä»¤æ¥æ‰§è¡Œè¿ç§»ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash copy
npx drizzle-kit generate
```

è¿ç§»æ–‡ä»¶å­˜å‚¨äº `migrations` ç›®å½•ï¼ˆç”±ä½ çš„ `drizzle.config.ts` æŒ‡å®šï¼‰ï¼Œè¯¥ç›®å½•åŒ…å«æ›´æ–°æ•°æ®åº“æ¶æ„æ‰€éœ€çš„ SQL æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œå­˜å‚¨ä¸åŒè¿ç§»é˜¶æ®µçš„ schema å¿«ç…§ã€‚

ç¤ºä¾‹ç”Ÿæˆçš„è¿ç§»å†…å®¹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "posts_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"title" text NOT NULL,
	"content" text NOT NULL,
	"user_id" integer NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE IF NOT EXISTS "users_table" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"age" integer NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "users_table_email_unique" UNIQUE("email")
);
--> statement-breakpoint
DO $$ BEGIN
 ALTER TABLE "posts_table" ADD CONSTRAINT "posts_table_user_id_users_table_id_fk" FOREIGN KEY ("user_id") REFERENCES "users_table"("id") ON DELETE cascade ON UPDATE no action;
EXCEPTION
 WHEN duplicate_object THEN null;
END $$;
```

æ‰§è¡Œè¿ç§»ï¼š

```bash copy
npx drizzle-kit migrate
```

è¯¦ç»†äº†è§£[è¿ç§»æµç¨‹](/docs/migrations)ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ [Drizzle kit çš„ push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥æ¨é€å˜æ›´åˆ°æ•°æ®åº“ï¼š

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚ç”¨äºéœ€è¦åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒå¿«é€Ÿæµ‹è¯•æ–° schema è®¾è®¡æˆ–å˜æ›´ï¼Œå…è®¸å¿«é€Ÿè¿­ä»£è€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„åœºæ™¯ã€‚</Callout>

<Callout type="info">
**Xata åˆ†æ”¯å¼€å‘**ï¼šXata å…è®¸ä½ ä¸ºä¸åŒç¯å¢ƒåˆ›å»ºæ•°æ®åº“åˆ†æ”¯ï¼Œä½ å¯ä»¥ä¸ºå¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§åˆ†æ”¯ä½¿ç”¨ä¸åŒçš„è¿æ¥å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§å‰æµ‹è¯•æ¶æ„æ›´æ”¹ã€‚
</Callout>
</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

é¡¹ç›®çš„åŸºæœ¬æ–‡ä»¶ç»“æ„å¦‚ä¸‹ã€‚åœ¨ `src/db` ç›®å½•ä¸‹å­˜æ”¾æ•°æ®åº“ç›¸å…³æ–‡ä»¶ï¼ŒåŒ…æ‹¬è¿æ¥é…ç½®çš„ `index.ts` å’Œ schema å®šä¹‰çš„ `schema.ts`ã€‚

```plaintext
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ src
 â”‚   â”œ ğŸ“‚ db
 â”‚   â”‚  â”œ ğŸ“œ index.ts
 â”‚   â”‚  â”” ğŸ“œ schema.ts
 â”œ ğŸ“‚ migrations
 â”‚   â”œ ğŸ“‚ meta
 â”‚   â”‚  â”œ ğŸ“œ _journal.json
 â”‚   â”‚  â”” ğŸ“œ 0000_snapshot.json
 â”‚   â”” ğŸ“œ 0000_watery_spencer_smythe.sql
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ package.json
 â”” ğŸ“œ tsconfig.json
```

## æŸ¥è¯¢ç¤ºä¾‹

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `src/db/queries` åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œåˆ†åˆ«åˆ›å»ºæ–‡ä»¶ï¼šæ’å…¥ã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ã€‚

#### æ’å…¥æ•°æ®

å…³äºæ’å…¥æŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/insert)ã€‚

```typescript copy filename="src/db/queries/insert.ts" {4, 8}
import { db } from '../index';
import { InsertPost, InsertUser, postsTable, usersTable } from '../schema';

export async function createUser(data: InsertUser) {
  await db.insert(usersTable).values(data);
}

export async function createPost(data: InsertPost) {
  await db.insert(postsTable).values(data);
}
```

#### æŸ¥è¯¢æ•°æ®

å…³äºæŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/select)ã€‚

<Callout type='warning'>
`getColumns` available starting from `drizzle-orm@1.0.0-beta.2`(read more [here](/docs/upgrade-v1))

If you are on pre-1 version(like `0.45.1`) then use `getTableColumns`
</Callout>

```typescript copy filename="src/db/queries/select.ts" {5, 16, 41}
import { asc, between, count, eq, getColumns, sql } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, postsTable, usersTable } from '../schema';

export async function getUserById(id: SelectUser['id']): Promise<
  Array<{
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db.select().from(usersTable).where(eq(usersTable.id, id));
}

export async function getUsersWithPostsCount(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    postsCount: number;
    id: number;
    name: string;
    age: number;
    email: string;
  }>
> {
  return db
    .select({
      ...getColumns(usersTable),
      postsCount: count(postsTable.id),
    })
    .from(usersTable)
    .leftJoin(postsTable, eq(usersTable.id, postsTable.userId))
    .groupBy(usersTable.id)
    .orderBy(asc(usersTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}

export async function getPostsForLast24Hours(
  page = 1,
  pageSize = 5,
): Promise<
  Array<{
    id: number;
    title: string;
  }>
> {
  return db
    .select({
      id: postsTable.id,
      title: postsTable.title,
    })
    .from(postsTable)
    .where(between(postsTable.createdAt, sql`now() - interval '1 day'`, sql`now()`))
    .orderBy(asc(postsTable.title), asc(postsTable.id))
    .limit(pageSize)
    .offset((page - 1) * pageSize);
}
```

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨[å…³ç³»æŸ¥è¯¢è¯­æ³•](/docs/rqb)ã€‚

#### æ›´æ–°æ•°æ®

å…³äºæ›´æ–°æŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/update)ã€‚

```typescript copy filename="src/db/queries/update.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectPost, postsTable } from '../schema';

export async function updatePost(id: SelectPost['id'], data: Partial<Omit<SelectPost, 'id'>>) {
  await db.update(postsTable).set(data).where(eq(postsTable.id, id));
}
```

#### åˆ é™¤æ•°æ®

å…³äºåˆ é™¤æŸ¥è¯¢çš„æ›´å¤šå†…å®¹è¯·å‚é˜…[æ–‡æ¡£](/docs/delete)ã€‚

```typescript copy filename="src/db/queries/delete.ts" {5}
import { eq } from 'drizzle-orm';
import { db } from '../index';
import { SelectUser, usersTable } from '../schema';

export async function deleteUser(id: SelectUser['id']) {
  await db.delete(usersTable).where(eq(usersTable.id, id));
}
```

## åç»­æ­¥éª¤

å®Œæˆ Drizzle ORM ä¸ Xata çš„æ­å»ºåï¼Œä½ å¯ä»¥ç»§ç»­æ·±å…¥å­¦ä¹ ï¼š

- äº†è§£ [Drizzle å…³ç³»æŸ¥è¯¢](/docs/rqb) ä»¥å®ç°å¤æ‚æŸ¥è¯¢
- æ¢ç´¢ [Xata å®˜æ–¹æ–‡æ¡£](https://xata.io/documentation/)
- å®æ–½ [æ•°æ®åº“è¿ç§»](/docs/migrations) ä»¥ä¾¿ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

Source: https://drizzle.zhcndoc.com/docs/tutorials/drizzle-nextjs-neon


import Steps from "@mdx/Steps.astro";
import Npm from "@mdx/Npm.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import CodeTab from "@mdx/CodeTab.astro";
import Section from "@mdx/Section.astro";
import Tabs from "@mdx/Tabs.astro";
import Tab from "@mdx/Tab.astro";
import Prerequisites from "@mdx/Prerequisites.astro";
import Callout from "@mdx/Callout.astro";

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ **Drizzle ORM** å’Œ **Neon æ•°æ®åº“** ä»¥åŠ **Next.js** æ„å»º `Todo åº”ç”¨`ã€‚

<Prerequisites>  
  - ä½ åº”è¯¥æœ‰ä¸€ä¸ªç°æœ‰çš„ Next.js é¡¹ç›®ï¼Œæˆ–è€…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼š
  ```bash
  npx create-next-app@latest --typescript
  ```

  - ä½ åº”è¯¥å·²ç»å®‰è£…äº† Drizzle ORM å’Œ [Drizzle kit](/docs/kit-overview)ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š
  <Npm>
    drizzle-orm 
    -D drizzle-kit
  </Npm>

  - ä½ åº”è¯¥å·²ç»å®‰è£…äº† [Neon æ— æœåŠ¡å™¨é©±åŠ¨](https://neon.tech/docs/serverless/serverless-driver)ã€‚ 
  <Npm>
    @neondatabase/serverless
  </Npm>

  - ä½ åº”è¯¥å·²ç»å®‰è£…äº† `dotenv` åŒ…ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡ã€‚ 
  <Npm>
    dotenv
  </Npm>  
</Prerequisites>

<Callout type="warning">
å¦‚æœåœ¨å®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°ä¾èµ–é¡¹è§£æé—®é¢˜ï¼š

å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ React Nativeï¼Œé€šè¿‡å¼ºåˆ¶ä½¿ç”¨ `--force` æˆ– `--legacy-peer-deps` æ¥è§£å†³è¯¥é—®é¢˜ã€‚å¦‚æœä½ åœ¨ä½¿ç”¨ React Nativeï¼Œåˆ™éœ€è¦ä½¿ç”¨ä¸ React Native ç‰ˆæœ¬å…¼å®¹çš„ç¡®åˆ‡ React ç‰ˆæœ¬ã€‚
</Callout>

## è®¾ç½® Neon å’Œ Drizzle ORM

<Steps>
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Neon é¡¹ç›®

ç™»å½•åˆ° [Neon æ§åˆ¶å°](https://console.neon.tech/app/projects) å¹¶å¯¼èˆªåˆ°é¡¹ç›®éƒ¨åˆ†ã€‚é€‰æ‹©ä¸€ä¸ªé¡¹ç›®æˆ–ç‚¹å‡» `æ–°å»ºé¡¹ç›®` æŒ‰é’®ä»¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚

ä½ çš„ Neon é¡¹ç›®è‡ªå¸¦ä¸€ä¸ªåä¸º `neondb` çš„ç°æˆ Postgres æ•°æ®åº“ã€‚æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨å®ƒã€‚

#### è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å˜é‡

å¯¼èˆªåˆ°é¡¹ç›®æ§åˆ¶å°ä¸­çš„ **è¿æ¥è¯¦æƒ…** éƒ¨åˆ†ä»¥æŸ¥æ‰¾ä½ çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚å®ƒåº”è¯¥ç±»ä¼¼äºä¸‹é¢è¿™æ ·ï¼š

```bash
postgres://username:password@ep-cool-darkness-123456.us-east-2.aws.neon.tech/neondb
```

å°† `DATABASE_URL` ç¯å¢ƒå˜é‡æ·»åŠ åˆ°ä½ çš„ `.env` æˆ– `.env.local` æ–‡ä»¶ä¸­ï¼Œä½ å°†åœ¨æ­¤ç”¨æ¥è¿æ¥ Neon æ•°æ®åº“ã€‚

```bash
DATABASE_URL=NEON_DATABASE_CONNECTION_STRING
```

#### è¿æ¥ Drizzle ORM åˆ°ä½ çš„æ•°æ®åº“ 

åœ¨ `src/db` æ–‡ä»¶å¤¹ä¸­åˆ›å»º `drizzle.ts` æ–‡ä»¶ï¼Œå¹¶è®¾ç½®ä½ çš„æ•°æ®åº“é…ç½®ï¼š

```tsx copy filename="src/db/drizzle.ts"
import { config } from "dotenv";
import { drizzle } from 'drizzle-orm/neon-http';

config({ path: ".env" }); // æˆ– .env.local

export const db = drizzle(process.env.DATABASE_URL!);
```

#### å£°æ˜ todo æ¨¡å¼

```tsx copy filename="src/db/schema.ts"
import { integer, text, boolean, pgTable } from "drizzle-orm/pg-core";

export const todo = pgTable("todo", {
  id: integer("id").primaryKey(),
  text: text("text").notNull(),
  done: boolean("done").default(false).notNull(),
});
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨æ¥è‡ª Drizzle ORM çš„æ•°æ®ç±»å‹å®šä¹‰ **`todo`** è¡¨ï¼Œå…¶ä¸­åŒ…å«å­—æ®µ **`id`**ã€**`text`** å’Œ **`done`**ã€‚

#### è®¾ç½® Drizzle é…ç½®æ–‡ä»¶

**Drizzle é…ç½®** - è¿™æ˜¯ä¸€ä¸ªç”¨äº [Drizzle Kit](/docs/kit-overview) çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æœ‰å…³ä½ çš„æ•°æ®åº“è¿æ¥ã€è¿ç§»æ–‡ä»¶å¤¹å’Œæ¨¡å¼æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `drizzle.config.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript copy filename="drizzle.config.ts"
import { config } from 'dotenv';
import { defineConfig } from "drizzle-kit";

config({ path: '.env' });

export default defineConfig({
  schema: "./src/db/schema.ts",
  out: "./migrations",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### å°†æ›´æ”¹åº”ç”¨äºæ•°æ®åº“

ä½ å¯ä»¥ä½¿ç”¨ `drizzle-kit generate` å‘½ä»¤ç”Ÿæˆè¿ç§»ï¼Œç„¶åä½¿ç”¨ `drizzle-kit migrate` å‘½ä»¤è¿è¡Œå®ƒä»¬ã€‚

ç”Ÿæˆè¿ç§»ï¼š

```bash
npx drizzle-kit generate
```

è¿™äº›è¿ç§»å­˜å‚¨åœ¨ `drizzle/migrations` ç›®å½•ä¸­ï¼Œå¦‚ä½ çš„ `drizzle.config.ts` æ‰€æŒ‡å®šçš„ã€‚è¿™ä¸€ç›®å½•å°†åŒ…å«æ›´æ–°æ•°æ®åº“æ¨¡å¼æ‰€éœ€çš„ SQL æ–‡ä»¶ä»¥åŠä¸€ä¸ª `meta` æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨åœ¨ä¸åŒè¿ç§»é˜¶æ®µçš„æ¨¡å¼å¿«ç…§ã€‚

ç”Ÿæˆè¿ç§»çš„ç¤ºä¾‹ï¼š

```sql
CREATE TABLE IF NOT EXISTS "todo" (
	"id" integer PRIMARY KEY NOT NULL,
	"text" text NOT NULL,
	"done" boolean DEFAULT false NOT NULL
);
```

è¿è¡Œè¿ç§»ï¼š

```bash
npx drizzle-kit migrate
```

å¦å¤–ï¼Œä½ å¯ä»¥ä½¿ç”¨ [Drizzle kit push å‘½ä»¤](/docs/kit-overview#prototyping-with-db-push) ç›´æ¥å°†æ›´æ”¹æ¨é€åˆ°æ•°æ®åº“ï¼š

```bash
npx drizzle-kit push
```

<Callout type="warning">Push å‘½ä»¤é€‚åˆäºéœ€è¦å¿«é€Ÿæµ‹è¯•æ–°æ¨¡å¼è®¾è®¡æˆ–åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­æ›´æ”¹çš„æƒ…å†µï¼Œå…è®¸å¿«é€Ÿè¿­ä»£ï¼Œè€Œæ— éœ€ç®¡ç†è¿ç§»æ–‡ä»¶çš„å¼€é”€ã€‚</Callout>
</Steps>

#### å»ºç«‹æœåŠ¡å™¨ç«¯å‡½æ•°
åœ¨æœ¬æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬åœ¨ **src/actions/todoAction.ts** æ–‡ä»¶ä¸­å»ºç«‹æœåŠ¡å™¨ç«¯å‡½æ•°ï¼Œä»¥å¤„ç† todo é¡¹ç›®çš„é‡è¦æ“ä½œï¼š

1. **`getData`:**
    - ä»æ•°æ®åº“è·å–æ‰€æœ‰ç°å­˜çš„ todo é¡¹ç›®ã€‚
2. **`addTodo`:**
    - å‘æ•°æ®åº“æ·»åŠ å¸¦æœ‰æä¾›æ–‡æœ¬çš„æ–° todo é¡¹ç›®ã€‚
    - ä½¿ç”¨ **`revalidatePath("/")`** è§¦å‘ä¸»é¡µçš„é‡æ–°éªŒè¯ã€‚
3. **`deleteTodo`:**
    - æ ¹æ®å”¯ä¸€ ID ä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€ä¸ª todo é¡¹ç›®ã€‚
    - è§¦å‘ä¸»é¡µçš„é‡æ–°éªŒè¯ã€‚
4. **`toggleTodo`:**
    - åˆ‡æ¢ä¸€ä¸ª todo é¡¹ç›®çš„å®ŒæˆçŠ¶æ€ï¼Œç›¸åº”åœ°æ›´æ–°æ•°æ®åº“ã€‚
    - åœ¨æ“ä½œä¹‹åé‡æ–°éªŒè¯ä¸»é¡µã€‚
5. **`editTodo`:**
    - ä¿®æ”¹æ•°æ®åº“ä¸­ç”± ID æ ‡è¯†çš„ todo é¡¹ç›®çš„æ–‡æœ¬ã€‚
    - å¯åŠ¨ä¸»é¡µçš„é‡æ–°éªŒè¯ã€‚

```tsx collapsable copy filename="src/actions/todoAction.ts"
"use server";
import { eq, not } from "drizzle-orm";
import { revalidatePath } from "next/cache";
import { db } from "@/db/drizzle";
import { todo } from "@/db/schema";

export const getData = async () => {
  const data = await db.select().from(todo);
  return data;
};

export const addTodo = async (id: number, text: string) => {
  await db.insert(todo).values({
    id: id,
    text: text,
  });
};

export const deleteTodo = async (id: number) => {
  await db.delete(todo).where(eq(todo.id, id));

  revalidatePath("/");
};

export const toggleTodo = async (id: number) => {
  await db
    .update(todo)
    .set({
      done: not(todo.done),
    })
    .where(eq(todo.id, id));

  revalidatePath("/");
};

export const editTodo = async (id: number, text: string) => {
  await db
    .update(todo)
    .set({
      text: text,
    })
    .where(eq(todo.id, id));

  revalidatePath("/");
};
```

## ä½¿ç”¨ Next.js è®¾ç½®ä¸»é¡µ

<Steps>
#### å®šä¹‰ä¸€ä¸ª TypeScript ç±»å‹

åœ¨ `src/types/todoType.ts` ä¸­å®šä¹‰ä¸€ä¸ªè¡¨ç¤º todo é¡¹ç›®çš„ TypeScript ç±»å‹ï¼ŒåŒ…å«ä¸‰ä¸ªå±æ€§ï¼š **`id`** ç±»å‹ä¸º **`number`**ã€ **`text`** ç±»å‹ä¸º **`string`** å’Œ **`done`** ç±»å‹ä¸º **`boolean`**ã€‚è¿™ä¸ªç±»å‹å‘½åä¸º **`todoType`**ï¼Œè¡¨ç¤ºä½ åº”ç”¨ä¸­ä¸€ä¸ªå…¸å‹ todo é¡¹ç›®çš„ç»“æ„ã€‚

```ts copy filename="src/types/todoType.ts"
export type todoType = {
  id: number;
  text: string;
  done: boolean;
};
```

#### ä¸º todo åº”ç”¨åˆ›å»ºä¸»é¡µ

1. **`src/components/todo.tsx`:**
    åˆ›å»ºä¸€ä¸ª `Todo` ç»„ä»¶ï¼Œè¡¨ç¤ºå•ä¸ª todo é¡¹ç›®ã€‚å®ƒåŒ…æ‹¬ç”¨äºæ˜¾ç¤ºå’Œç¼–è¾‘ todo æ–‡æœ¬ã€ç”¨å¤é€‰æ¡†æ ‡è®°ä¸ºå®Œæˆçš„åŠŸèƒ½ï¼Œä»¥åŠæä¾›ç¼–è¾‘ã€ä¿å­˜ã€å–æ¶ˆå’Œåˆ é™¤ todo çš„æ“ä½œã€‚
2. **`src/components/addTodo.tsx`:**
    `AddTodo` ç»„ä»¶æä¾›äº†ä¸€ä¸ªç®€å•çš„è¡¨å•ï¼Œç”¨äºå‘ Todo åº”ç”¨æ·»åŠ æ–°çš„ todo é¡¹ç›®ã€‚å®ƒåŒ…æ‹¬ä¸€ä¸ªè¾“å…¥å­—æ®µç”¨äºè¾“å…¥ todo æ–‡æœ¬ï¼Œä»¥åŠä¸€ä¸ªæŒ‰é’®ç”¨äºè§¦å‘æ–° todo çš„æ·»åŠ ã€‚
3. **`src/components/todos.tsx`:**
    åˆ›å»º Todos ç»„ä»¶ï¼Œè¡¨ç¤º Todo åº”ç”¨çš„ä¸»è¦ç•Œé¢ã€‚å®ƒç®¡ç† todo é¡¹ç›®çš„çŠ¶æ€ï¼Œæä¾›åˆ›å»ºã€ç¼–è¾‘ã€åˆ‡æ¢å’Œåˆ é™¤ todo çš„åŠŸèƒ½ï¼Œå¹¶ä½¿ç”¨ `Todo` ç»„ä»¶æ¸²æŸ“å„ä¸ª todo é¡¹ç›®ã€‚

<CodeTabs items={["todo.tsx", "addTodo.tsx", "todos.tsx"]}>
```tsx collapsable copy
"use client";
import { ChangeEvent, FC, useState } from "react";
import { todoType } from "@/types/todoType";

interface Props {
  todo: todoType;
  changeTodoText: (id: number, text: string) => void;
  toggleIsTodoDone: (id: number, done: boolean) => void;
  deleteTodoItem: (id: number) => void;
}

const Todo: FC<Props> = ({
  todo,
  changeTodoText,
  toggleIsTodoDone,
  deleteTodoItem,
}) => {
  // å¤„ç†ç¼–è¾‘æ¨¡å¼çš„çŠ¶æ€
  const [editing, setEditing] = useState(false);

  // å¤„ç†æ–‡æœ¬è¾“å…¥çš„çŠ¶æ€
  const [text, setText] = useState(todo.text);

  // å¤„ç†å®ŒæˆçŠ¶æ€çš„çŠ¶æ€
  const [isDone, setIsDone] = useState(todo.done);

  // æ–‡æœ¬è¾“å…¥å˜åŒ–çš„äº‹ä»¶å¤„ç†
  const handleTextChange = (e: ChangeEvent<HTMLInputElement>) => {
    setText(e.target.value);
  };

  // åˆ‡æ¢å®ŒæˆçŠ¶æ€çš„äº‹ä»¶å¤„ç†
  const handleIsDone = async () => {
    toggleIsTodoDone(todo.id, !isDone);
    setIsDone((prev) => !prev);
  };

  // å¯åŠ¨ç¼–è¾‘æ¨¡å¼çš„äº‹ä»¶å¤„ç†
  const handleEdit = () => {
    setEditing(true);
  };

  // ä¿å­˜ç¼–è¾‘æ–‡æœ¬çš„äº‹ä»¶å¤„ç†
  const handleSave = async () => {
    changeTodoText(todo.id, text);
    setEditing(false);
  };

  // å–æ¶ˆç¼–è¾‘æ¨¡å¼çš„äº‹ä»¶å¤„ç†
  const handleCancel = () => {
    setEditing(false);
    setText(todo.text);
  };

  // åˆ é™¤ todo é¡¹ç›®çš„äº‹ä»¶å¤„ç†
  const handleDelete = () => {
    if (confirm("ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ª todo å—ï¼Ÿ")) {
      deleteTodoItem(todo.id);
    }
  };

  // æ¸²æŸ“ Todo ç»„ä»¶
  return (
    <div className="flex items-center gap-2 p-4 border-gray-200 border-solid border rounded-lg">
      {/* ç”¨äºæ ‡è®° todo ä¸ºå®Œæˆçš„å¤é€‰æ¡† */}
      <input
        type="checkbox"
        className="text-blue-200 rounded-sm h-4 w-4"
        checked={isDone}
        onChange={handleIsDone}
      />
      {/* todo æ–‡æœ¬çš„è¾“å…¥å­—æ®µ */}
      <input
        type="text"
        value={text}
        onChange={handleTextChange}
        readOnly={!editing}
        className={`${
          todo.done ? "line-through" : ""
        } outline-none read-only:border-transparent focus:border border-gray-200 rounded px-2 py-1 w-full`}
      />
      {/* ç¼–è¾‘ã€ä¿å­˜ã€å–æ¶ˆå’Œåˆ é™¤çš„æ“ä½œæŒ‰é’® */}
      <div className="flex gap-1 ml-auto">
        {editing ? (
          <button
            onClick={handleSave}
            className="bg-green-600 text-green-50 rounded px-2 w-14 py-1"
          >
            ä¿å­˜
          </button>
        ) : (
          <button
            onClick={handleEdit}
            className="bg-blue-400 text-blue-50 rounded w-14 px-2 py-1"
          >
            ç¼–è¾‘
          </button>
        )}
        {editing ? (
          <button
            onClick={handleCancel}
            className="bg-red-400 w-16 text-red-50 rounded px-2 py-1"
          >
            å…³é—­
          </button>
        ) : (
          <button
            onClick={handleDelete}
            className="bg-red-400 w-16 text-red-50 rounded px-2 py-1"
          >
            åˆ é™¤
          </button>
        )}
      </div>
    </div>
  );
};

export default Todo;
```
```tsx collapsable copy
"use client";
import { ChangeEvent, FC, useState } from "react";

interface Props {
  createTodo: (value: string) => void;
}

const AddTodo: FC<Props> = ({ createTodo }) => {
  // å¤„ç†è¾“å…¥å€¼çš„çŠ¶æ€
  const [input, setInput] = useState("");

  // è¾“å…¥å˜åŒ–çš„äº‹ä»¶å¤„ç†
  const handleInput = (e: ChangeEvent<HTMLInputElement>) => {
    setInput(e.target.value);
  };

  // æ·»åŠ æ–° todo çš„äº‹ä»¶å¤„ç†
  const handleAdd = async () => {
    createTodo(input);
    setInput("");
  };

  // æ¸²æŸ“ AddTodo ç»„ä»¶
  return (
    <div className="w-full flex gap-1 mt-2">
      {/* è¾“å…¥æ–° todo æ–‡æœ¬çš„è¾“å…¥å­—æ®µ */}
      <input
        type="text"
        className="w-full px-2 py-1 border border-gray-200 rounded outline-none"
        onChange={handleInput}
        value={input}
      />
      {/* æ·»åŠ æ–° todo çš„æŒ‰é’® */}
      <button
        className="flex items-center justify-center bg-green-600 text-green-50 rounded px-2 h-9 w-14 py-1"
        onClick={handleAdd}
      >
        æ·»åŠ 
      </button>
    </div>
  );
};

export default AddTodo;
```

	<CodeTab>
```tsx collapsable copy
"use client";
import { FC, useState } from "react";
import { todoType } from "@/types/todoType";
import Todo from "./todo";
import AddTodo from "./addTodo";
import { addTodo, deleteTodo, editTodo, toggleTodo } from "@/actions/todoAction";

interface Props {
  todos: todoType[];
}

const Todos: FC<Props> = ({ todos }) => {
  // ç®¡ç† todo é¡¹ç›®åˆ—è¡¨çš„çŠ¶æ€
  const [todoItems, setTodoItems] = useState<todoType[]>(todos);

  // åˆ›å»ºæ–° todo é¡¹ç›®çš„å‡½æ•°
  const createTodo = (text: string) => {
    const id = (todoItems.at(-1)?.id || 0) + 1;
    addTodo(id, text);
    setTodoItems((prev) => [...prev, { id: id, text, done: false }]);
  };

  // æ›´æ”¹ todo é¡¹ç›®æ–‡æœ¬çš„å‡½æ•°
  const changeTodoText = (id: number, text: string) => {
    setTodoItems((prev) =>
      prev.map((todo) => (todo.id === id ? { ...todo, text } : todo))
    );
    editTodo(id, text);
  };

  // åˆ‡æ¢ todo é¡¹ç›®å®ŒæˆçŠ¶æ€çš„å‡½æ•°
  const toggleIsTodoDone = (id: number) => {
    setTodoItems((prev) =>
      prev.map((todo) => (todo.id === id ? { ...todo, done: !todo.done } : todo))
    );
    toggleTodo(id);
  };

  // åˆ é™¤ todo é¡¹ç›®çš„å‡½æ•°
  const deleteTodoItem = (id: number) => {
    setTodoItems((prev) => prev.filter((todo) => todo.id !== id));
    deleteTodo(id);
  };

  // æ¸²æŸ“ Todo åˆ—è¡¨ç»„ä»¶
  return (
    <main className="flex mx-auto max-w-xl w-full min-h-screen flex-col items-center p-16">
      <div className="text-5xl font-medium">å¾…åŠäº‹é¡¹åº”ç”¨</div>
      <div className="w-full flex flex-col mt-8 gap-2">
        {/* éå† todoItemsï¼Œå¹¶ä¸ºæ¯ä¸ª todo æ¸²æŸ“ Todo ç»„ä»¶ */}
        {todoItems.map((todo) => (
          <Todo
            key={todo.id}
            todo={todo}
            changeTodoText={changeTodoText}
            toggleIsTodoDone={toggleIsTodoDone}
            deleteTodoItem={deleteTodoItem}
          />
        ))}
      </div>
      {/* ä¸ºåˆ›å»ºæ–° todos æ·»åŠ  Todo ç»„ä»¶ */}
      <AddTodo createTodo={createTodo} />
    </main>
  );
};

export default Todos;
```

    </CodeTab>
</CodeTabs>

æ›´æ–° `src/app/page.tsx` æ–‡ä»¶ä»¥ä»æ•°æ®åº“è·å– todo é¡¹ç›®å¹¶æ¸²æŸ“ `Todos` ç»„ä»¶ï¼š

```tsx copy filename="src/app/page.tsx"
import { getData } from "@/actions/todoAction";
import Todos from "@/components/todos";

export default async function Home() {
  const data = await getData();
  return <Todos todos={data} />;
}
```
</Steps>

## åŸºæœ¬æ–‡ä»¶ç»“æ„

æœ¬æŒ‡å—ä½¿ç”¨ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š

```text
ğŸ“¦ <é¡¹ç›®æ ¹ç›®å½•>
 â”œ ğŸ“‚ migrations
 â”‚  â”œ ğŸ“‚ meta
 â”‚  â”” ğŸ“œ 0000_heavy_doctor_doom.sql
 â”œ ğŸ“‚ public
 â”œ ğŸ“‚ src
 â”‚  â”œ ğŸ“‚ actions
 â”‚  â”‚  â”” ğŸ“œ todoActions.ts
 â”‚  â”œ ğŸ“‚ app
 â”‚  â”‚  â”œ ğŸ“œ favicon.ico
 â”‚  â”‚  â”œ ğŸ“œ globals.css
 â”‚  â”‚  â”œ ğŸ“œ layout.tsx
 â”‚  â”‚  â”” ğŸ“œ page.tsx
 â”‚  â”œ ğŸ“‚ components
 â”‚  â”‚  â”œ ğŸ“œ addTodo.tsx
 â”‚  â”‚  â”œ ğŸ“œ todo.tsx
 â”‚  â”‚  â”” ğŸ“œ todos.tsx
 â”‚  â”” ğŸ“‚ db
 â”‚  â”‚  â”œ ğŸ“œ drizzle.ts
 â”‚  â”‚  â”” ğŸ“œ schema.ts
 â”‚  â”” ğŸ“‚ types
 â”‚     â”” ğŸ“œ todoType.ts
 â”œ ğŸ“œ .env
 â”œ ğŸ“œ .eslintrc.json
 â”œ ğŸ“œ .gitignore
 â”œ ğŸ“œ drizzle.config.ts
 â”œ ğŸ“œ next-env.d.ts
 â”œ ğŸ“œ next.config.mjs
 â”œ ğŸ“œ package-lock.json
 â”œ ğŸ“œ package.json
 â”œ ğŸ“œ postcss.config.mjs
 â”œ ğŸ“œ README.md
 â”œ ğŸ“œ tailwind.config.ts
 â”” ğŸ“œ tsconfig.json
```


Source: https://drizzle.zhcndoc.com/docs/typebox

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';

# drizzle-typebox

`drizzle-typebox` æ˜¯ä¸€ä¸ªé’ˆå¯¹ **[Drizzle ORM](https://github.com/drizzle-team/drizzle-orm)** çš„æ’ä»¶ï¼Œå…è®¸ä½ ä» Drizzle ORM æ¨¡å¼ç”Ÿæˆ **[Typebox](https://github.com/sinclairzx81/typebox)** æ¨¡å¼ã€‚

### å®‰è£…ä¾èµ–

<Npm>
drizzle-typebox
</Npm>

<Callout type="warning">
æœ¬æ–‡ä»¶å¯¹äº `drizzle-typebox@0.2.0` åŠä»¥ä¸Šç‰ˆæœ¬çš„æ–‡æ¡£

ä½ è¿˜å¿…é¡»å®‰è£… Drizzle ORM v0.36.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥åŠ Typebox v0.34.8 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
</Callout>

### é€‰æ‹©æ¨¡å¼

å®šä¹‰ä»æ•°æ®åº“æŸ¥è¯¢çš„æ•°æ®çš„ç»“æ„ - å¯ç”¨äºéªŒè¯ API å“åº”ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-typebox';
import { Value } from '@sinclair/typebox/value';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userSelectSchema = createSelectSchema(users);

const rows = await db.select({ id: users.id, name: users.name }).from(users).limit(1);
const parsed: { id: number; name: string; age: number } = Value.Parse(userSelectSchema, rows[0]); // é”™è¯¯ï¼š`age`åœ¨ä¸Šè¿°æŸ¥è¯¢ä¸­æœªè¿”å›

const rows = await db.select().from(users).limit(1);
const parsed: { id: number; name: string; age: number } = Value.Parse(userSelectSchema, rows[0]); // å°†æˆåŠŸè§£æ
```

è§†å›¾å’Œæšä¸¾ä¹Ÿè¢«æ”¯æŒã€‚

```ts copy
import { pgEnum } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-typebox';
import { Value } from '@sinclair/typebox/value';

const roles = pgEnum('roles', ['admin', 'basic']);
const rolesSchema = createSelectSchema(roles);
const parsed: 'admin' | 'basic' = Value.Parse(rolesSchema, ...);

const usersView = pgView('users_view').as((qb) => qb.select().from(users).where(gt(users.age, 18)));
const usersViewSchema = createSelectSchema(usersView);
const parsed: { id: number; name: string; age: number } = Value.Parse(usersViewSchema, ...);
```

### æ’å…¥æ¨¡å¼

å®šä¹‰è¦æ’å…¥åˆ°æ•°æ®åº“çš„æ•°æ®çš„ç»“æ„ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createInsertSchema } from 'drizzle-typebox';
import { Value } from '@sinclair/typebox/value';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userInsertSchema = createInsertSchema(users);

const user = { name: 'John' };
const parsed: { name: string, age: number } = Value.Parse(userInsertSchema, user); // é”™è¯¯ï¼š`age`æœªå®šä¹‰

const user = { name: 'Jane', age: 30 };
const parsed: { name: string, age: number } = Value.Parse(userInsertSchema, user); // å°†æˆåŠŸè§£æ
await db.insert(users).values(parsed);
```

### æ›´æ–°æ¨¡å¼

å®šä¹‰è¦æ›´æ–°åˆ°æ•°æ®åº“çš„æ•°æ®çš„ç»“æ„ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createUpdateSchema } from 'drizzle-typebox';
import { Value } from '@sinclair/typebox/value';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userUpdateSchema = createUpdateSchema(users);

const user = { id: 5, name: 'John' };
const parsed: { name?: string | undefined, age?: number | undefined } = Value.Parse(userUpdateSchema, user); // é”™è¯¯ï¼š`id`æ˜¯ä¸€ä¸ªç”Ÿæˆåˆ—ï¼Œæ— æ³•æ›´æ–°

const user = { age: 35 };
const parsed: { name?: string | undefined, age?: number | undefined } = Value.Parse(userUpdateSchema, user); // å°†æˆåŠŸè§£æ
await db.update(users).set(parsed).where(eq(users.name, 'Jane'));
```

### ç²¾ç‚¼

æ¯ä¸ªåˆ›å»ºæ¨¡å¼å‡½æ•°æ¥å—ä¸€ä¸ªé¢å¤–çš„å¯é€‰å‚æ•°ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥æ‰©å±•ã€ä¿®æ”¹æˆ–å®Œå…¨è¦†ç›–å­—æ®µçš„æ¨¡å¼ã€‚å®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°å°†æ‰©å±•æˆ–ä¿®æ”¹ï¼Œè€Œæä¾›ä¸€ä¸ª Typebox æ¨¡å¼å°†è¦†ç›–å®ƒã€‚

```ts copy
import { pgTable, text, integer, json } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-typebox';
import { Type } from '@sinclair/typebox';
import { Value } from '@sinclair/typebox/value';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  bio: text(),
  preferences: json()
});

const userSelectSchema = createSelectSchema(users, {
  name: (schema) => Type.String({ ...schema, maxLength: 20 }), // æ‰©å±•æ¨¡å¼
  bio: (schema) => Type.String({ ...schema, maxLength: 1000 }), // åœ¨å˜ä¸ºå¯é€‰/å¯ç©ºä¹‹å‰æ‰©å±•æ¨¡å¼
  preferences: Type.Object({ theme: Type.String() }) // è¦†ç›–å­—æ®µï¼ŒåŒ…æ‹¬å®ƒçš„å¯ç©ºæ€§
});

const parsed: {
  id: number;
  name: string,
  bio?: string | undefined;
  preferences: {
    theme: string;
  };
} = Value.Parse(userSelectSchema, ...);
```

### å·¥å‚å‡½æ•°

å¯¹äºæ›´é«˜çº§çš„ç”¨ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ `createSchemaFactory` å‡½æ•°ã€‚

**ç”¨ä¾‹ï¼šä½¿ç”¨æ‰©å±•çš„ Typebox å®ä¾‹**

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createSchemaFactory } from 'drizzle-typebox';
import { t } from 'elysia'; // æ‰©å±• Typebox å®ä¾‹

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const { createInsertSchema } = createSchemaFactory({ typeboxInstance: t });

const userInsertSchema = createInsertSchema(users, {
  // æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨æ‰©å±•çš„å®ä¾‹
  name: (schema) => t.Number({ ...schema }, { error: '`name` must be a string' })
});
```

### æ•°æ®ç±»å‹å‚è€ƒ

```ts
pg.boolean();

mysql.boolean();

sqlite.integer({ mode: 'boolean' });

// æ¨¡å¼
Type.Boolean();
```

```ts
pg.date({ mode: 'date' });
pg.timestamp({ mode: 'date' });

mysql.date({ mode: 'date' });
mysql.datetime({ mode: 'date' });
mysql.timestamp({ mode: 'date' });

sqlite.integer({ mode: 'timestamp' });
sqlite.integer({ mode: 'timestamp_ms' });

// æ¨¡å¼
Type.Date();
```

```ts
pg.date({ mode: 'string' });
pg.timestamp({ mode: 'string' });
pg.cidr();
pg.inet();
pg.interval();
pg.macaddr();
pg.macaddr8();
pg.numeric();
pg.text();
pg.sparsevec();
pg.time();

mysql.binary();
mysql.date({ mode: 'string' });
mysql.datetime({ mode: 'string' });
mysql.decimal();
mysql.time();
mysql.timestamp({ mode: 'string' });
mysql.varbinary();

sqlite.numeric();
sqlite.text({ mode: 'text' });

// æ¨¡å¼
Type.String();
```

```ts
pg.bit({ dimensions: ... });

// æ¨¡å¼
t.RegExp(/^[01]+$/, { maxLength: dimensions });
```

```ts
pg.uuid();

// æ¨¡å¼
Type.String({ format: 'uuid' });
```

```ts
pg.char({ length: ... });

mysql.char({ length: ... });

// æ¨¡å¼
Type.String({ minLength: length, maxLength: length });
```

```ts
pg.varchar({ length: ... });

mysql.varchar({ length: ... });

sqlite.text({ mode: 'text', length: ... });

// æ¨¡å¼
Type.String({ maxLength: length });
```

```ts
mysql.tinytext();

// æ¨¡å¼
Type.String({ maxLength: 255 }); // æ— ç¬¦å· 8 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.text();

// æ¨¡å¼
Type.String({ maxLength: 65_535 }); // æ— ç¬¦å· 16 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.mediumtext();

// æ¨¡å¼
Type.String({ maxLength: 16_777_215 }); // æ— ç¬¦å· 24 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.longtext();

// æ¨¡å¼
Type.String({ maxLength: 4_294_967_295 }); // æ— ç¬¦å· 32 ä½æ•´æ•°é™åˆ¶
```

```ts
pg.text({ enum: ... });
pg.char({ enum: ... });
pg.varchar({ enum: ... });

mysql.tinytext({ enum: ... });
mysql.mediumtext({ enum: ... });
mysql.text({ enum: ... });
mysql.longtext({ enum: ... });
mysql.char({ enum: ... });
mysql.varchar({ enum: ... });
mysql.mysqlEnum(..., ...);

sqlite.text({ mode: 'text', enum: ... });

// æ¨¡å¼
Type.Enum(enum);
```

```ts
mysql.tinyint();

// æ¨¡å¼
Type.Integer({ minimum: -128, maximum: 127 }); // 8 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.tinyint({ unsigned: true });

// æ¨¡å¼
Type.Integer({ minimum: 0, maximum: 255 }); // æ— ç¬¦å· 8 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.smallint();
pg.smallserial();

mysql.smallint();

// æ¨¡å¼
Type.Integer({ minimum: -32_768, maximum: 32_767 }); // 16 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.smallint({ unsigned: true });

// æ¨¡å¼
Type.Integer({ minimum: 0, maximum: 65_535 }); // æ— ç¬¦å· 16 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.real();

mysql.float();

// æ¨¡å¼
Type.Number().min(-8_388_608).max(8_388_607); // 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.mediumint();

// æ¨¡å¼
Type.Integer({ minimum: -8_388_608, maximum: 8_388_607 }); // 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.float({ unsigned: true });

// æ¨¡å¼
Type.Number({ minimum: 0, maximum: 16_777_215 }); // æ— ç¬¦å· 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.mediumint({ unsigned: true });

// æ¨¡å¼
Type.Integer({ minimum: 0, maximum: 16_777_215 }); // æ— ç¬¦å· 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.integer();
pg.serial();

mysql.int();

// æ¨¡å¼
Type.Integer({ minimum: -2_147_483_648, maximum: 2_147_483_647 }); // 32 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.int({ unsigned: true });

// æ¨¡å¼
Type.Integer({ minimum: 0, maximum: 4_294_967_295 }); // æ— ç¬¦å· 32 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.doublePrecision();

mysql.double();
mysql.real();

sqlite.real();

// æ¨¡å¼
Type.Number({ minimum: -140_737_488_355_328, maximum: 140_737_488_355_327 }); // 48 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.double({ unsigned: true });

// æ¨¡å¼
Type.Numer({ minimum: 0, maximum: 281_474_976_710_655 }); // æ— ç¬¦å· 48 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.bigint({ mode: 'number' });
pg.bigserial({ mode: 'number' });

mysql.bigint({ mode: 'number' });
mysql.bigserial({ mode: 'number' });

sqlite.integer({ mode: 'number' });

// æ¨¡å¼
Type.Integer({ minimum: -9_007_199_254_740_991, maximum: 9_007_199_254_740_991 }); // Javascript æœ€å°å’Œæœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
mysql.serial();

Type.Integer({ minimum: 0, maximum: 9_007_199_254_740_991 }); // Javascript æœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
pg.bigint({ mode: 'bigint' });
pg.bigserial({ mode: 'bigint' });

mysql.bigint({ mode: 'bigint' });

sqlite.blob({ mode: 'bigint' });

// æ¨¡å¼
Type.BigInt({ minimum: -9_223_372_036_854_775_808n, maximum: 9_223_372_036_854_775_807n }); // 64 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.bigint({ mode: 'bigint', unsigned: true });

// æ¨¡å¼
Type.BigInt({ minimum: 0, maximum: 18_446_744_073_709_551_615n }); // æ— ç¬¦å· 64 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.year();

// æ¨¡å¼
Type.Integer({ minimum: 1_901, maximum: 2_155 });
```

```ts
pg.geometry({ type: 'point', mode: 'tuple' });
pg.point({ mode: 'tuple' });

// æ¨¡å¼
Type.Tuple([Type.Number(), Type.Number()]);
```

```ts
pg.geometry({ type: 'point', mode: 'xy' });
pg.point({ mode: 'xy' });

// æ¨¡å¼
Type.Object({ x: Type.Number(), y: Type.Number() });
```

```ts
pg.halfvec({ dimensions: ... });
pg.vector({ dimensions: ... });

// æ¨¡å¼
Type.Array(Type.Number(), { minItems: dimensions, maxItems: dimensions });
```

```ts
pg.line({ mode: 'abc' });

// æ¨¡å¼
Type.Object({ a: Type.Number(), b: Type.Number(), c: Type.Number() });
```

```ts
pg.line({ mode: 'tuple' });

// æ¨¡å¼
Type.Tuple([Type.Number(), Type.Number(), Type.Number()]);
```

```ts
pg.json();
pg.jsonb();

mysql.json();

sqlite.blob({ mode: 'json' });
sqlite.text({ mode: 'json' });

// æ¨¡å¼
Type.Recursive((self) => Type.Union([Type.Union([Type.String(), Type.Number(), Type.Boolean(), Type.Null()]), Type.Array(self), Type.Record(Type.String(), self)]));
```

```ts
sqlite.blob({ mode: 'buffer' });

// Schema
t.Union([t.Union([t.String(), t.Number(), t.Boolean(), t.Null()]), t.Array(t.Any()), t.Record(t.String(), t.Any())]);
```

```ts
pg.dataType().array(...);

// æ¨¡å¼
Type.Array(baseDataTypeSchema, { minItems: size, maxItems: size });
```

Source: https://drizzle.zhcndoc.com/docs/update

import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';

# SQL æ›´æ–°

```typescript copy
await db.update(users)
  .set({ name: 'Mr. Dan' })
  .where(eq(users.name, 'Dan'));
```

ä¼ é€’ç»™ `update` çš„å¯¹è±¡åº”å…·æœ‰ä¸æ•°æ®åº“æ¶æ„ä¸­çš„åˆ—åç›¸åŒ¹é…çš„é”®ã€‚
å¯¹è±¡ä¸­å€¼ä¸º `undefined` çš„é”®ä¼šè¢«å¿½ç•¥ï¼šè¦å°†åˆ—è®¾ç½®ä¸º `null`ï¼Œè¯·ä¼ é€’ `null`ã€‚
æ‚¨å¯ä»¥å°† SQL ä½œä¸ºå€¼ä¼ é€’ï¼Œä»¥åœ¨æ›´æ–°å¯¹è±¡ä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript copy
await db.update(users)
  .set({ updatedAt: sql`NOW()` })
  .where(eq(users.name, 'Dan'));
```

### é™åˆ¶

<IsSupportedChipGroup chips={{ 'PostgreSQL': false, 'MySQL': true, 'SQLite': true, 'SingleStore': true, 'MSSQL': false, 'CockroachDB': false }} />

ä½¿ç”¨ `.limit()` å°† `limit` å­å¥æ·»åŠ åˆ°æŸ¥è¯¢ä¸­ - ä¾‹å¦‚ï¼š
<Section>
```typescript
await db.update(usersTable).set({ verified: true }).limit(2);
```
```sql
update "users" set "verified" = $1 limit $2;
```
</Section>

### æ’åº
ä½¿ç”¨ `.orderBy()` å‘æŸ¥è¯¢æ·»åŠ  `order by` å­å¥ï¼ŒæŒ‰æŒ‡å®šå­—æ®µå¯¹ç»“æœè¿›è¡Œæ’åºï¼š
<Section>
```typescript
import { asc, desc } from 'drizzle-orm';

await db.update(usersTable).set({ verified: true }).orderBy(usersTable.name);
await db.update(usersTable).set({ verified: true }).orderBy(desc(usersTable.name));

// æ ¹æ®å¤šä¸ªå­—æ®µæ’åº
await db.update(usersTable).set({ verified: true }).orderBy(usersTable.name, usersTable.name2);
await db.update(usersTable).set({ verified: true }).orderBy(asc(usersTable.name), desc(usersTable.name2));
```
```sql
update "users" set "verified" = $1 order by "name";
update "users" set "verified" = $1 order by "name" desc;

update "users" set "verified" = $1 order by "name", "name2";
update "users" set "verified" = $1 order by "name" asc, "name2" desc;
```
</Section>

### å¸¦è¿”å›å€¼çš„æ›´æ–°
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': false , 'SingleStore': false, 'MSSQL': false, 'CockroachDB': true }} />
æ‚¨å¯ä»¥åœ¨ PostgreSQL å’Œ SQLite ä¸­æ›´æ–°è¡Œå¹¶è¿”å›å®ƒï¼š
```typescript copy
const updatedUserId: { updatedId: number }[] = await db.update(users)
  .set({ name: 'Mr. Dan' })
  .where(eq(users.name, 'Dan'))
  .returning({ updatedId: users.id });
```

### è¾“å‡º
<IsSupportedChipGroup chips={{ 'MSSQL': true }} />
æ‚¨å¯ä»¥æ›´æ–°è¡Œå¹¶åŒæ—¶è·å–æ›´æ–°å‰å’Œæ›´æ–°åçš„æ•°æ®ï¼š

```typescript copy
type User = typeof users.$inferSelect;

const updatedUserId: User[] = await db.update(users)
  .set({ name: 'Mr. Dan' })
  .where(eq(users.name, 'Dan'))
  .output();
```

è¿”å›æ›´æ–°åçš„éƒ¨åˆ†ç”¨æˆ·å­—æ®µï¼š

```ts
const updatedUserId: { inserted: { updatedId: number }}[] = await db.update(users)
  .set({ name: 'Mr. Dan' })
  .where(eq(users.name, 'Dan'))
  .output({ inserted: { updatedId: users.id }});
```

è¿”å›æ›´æ–°å‰æ•°æ®åº“ä¸­çš„è¡Œï¼š

```ts
type User = typeof users.$inferSelect;

const updatedUserId: { deleted: User }[] = await db.update(users)
  .set({ name: 'Mr. Dan' })
  .where(eq(users.name, 'Dan'))
  .output({ deleted: true });
```

åŒæ—¶è¿”å›æ›´æ–°å‰å’Œæ›´æ–°åçš„æ•°æ®ï¼š

```ts
type User = typeof users.$inferSelect;

const updatedUserId: { deleted: User, inserted: User }[] = await db.update(users)
  .set({ name: 'Mr. Dan' })
  .where(eq(users.name, 'Dan'))
  .output({ deleted: true, inserted: true });
```

## `with update`å­å¥

<Callout>
  æŸ¥çœ‹å¦‚ä½•åœ¨ [select](/docs/select#with-clause)ã€[insert](/docs/insert#with-insert-clause)ã€[delete](/docs/delete#with-delete-clause) ä¸­ä½¿ç”¨ WITH è¯­å¥
</Callout>

ä½¿ç”¨ `with` å­å¥å¯ä»¥é€šè¿‡å°†å¤æ‚æŸ¥è¯¢æ‹†åˆ†ä¸ºç§°ä¸ºå…¬å…±è¡¨è¡¨è¾¾å¼ (CTE) çš„è¾ƒå°å­æŸ¥è¯¢æ¥ç®€åŒ–æŸ¥è¯¢ï¼š
<Section>
```typescript copy
const averagePrice = db.$with('average_price').as(
        db.select({ value: sql`avg(${products.price})`.as('value') }).from(products)
);

const result = await db.with(averagePrice)
		.update(products)
		.set({
			cheap: true
		})
		.where(lt(products.price, sql`(select * from ${averagePrice})`))
		.returning({
			id: products.id
		});
```
```sql
with "average_price" as (select avg("price") as "value" from "products") 
update "products" set "cheap" = $1 
where "products"."price" < (select * from "average_price") 
returning "id"
```
</Section>

## Update ... from

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': true, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': true }} />

æ­£å¦‚ SQLite æ–‡æ¡£æ‰€è¿°ï¼š

> UPDATE-FROM æ˜¯ SQL çš„ä¸€ä¸ªæ‰©å±•ï¼Œå…è®¸æ›´æ–°è¯­å¥é€šè¿‡æ•°æ®åº“ä¸­çš„å…¶ä»–è¡¨æ¥é©±åŠ¨ã€‚
â€œç›®æ ‡â€è¡¨æ˜¯è¢«æ›´æ–°çš„ç‰¹å®šè¡¨ã€‚ä½¿ç”¨ UPDATE-FROMï¼Œæ‚¨å¯ä»¥åœ¨ç›®æ ‡è¡¨
å’Œæ•°æ®åº“ä¸­çš„å…¶ä»–è¡¨ä¹‹é—´è¿›è¡Œè¿æ¥ï¼Œä»¥å¸®åŠ©è®¡ç®—å“ªäº›è¡Œéœ€è¦æ›´æ–°ä»¥åŠ
è¿™äº›è¡Œçš„æ–°å€¼åº”è¯¥æ˜¯ä»€ä¹ˆã€‚

PostgreSQL æ–‡æ¡£åŒæ ·æŒ‡å‡ºï¼š

> å…è®¸åœ¨ WHERE æ¡ä»¶å’Œæ›´æ–°è¡¨è¾¾å¼ä¸­å‡ºç°å…¶ä»–è¡¨çš„åˆ—çš„è¡¨è¡¨è¾¾å¼ã€‚

Drizzle ä»ç‰ˆæœ¬ `drizzle-orm@0.36.3` èµ·ä¹Ÿæ”¯æŒæ­¤åŠŸèƒ½ã€‚

<Section>
```ts
await db
  .update(users)
  .set({ cityId: cities.id })
  .from(cities)
  .where(and(eq(cities.name, 'Seattle'), eq(users.name, 'John')))
```
```sql
update "users" set "city_id" = "cities"."id" 
from "cities" 
where ("cities"."name" = $1 and "users"."name" = $2)

-- params: [ 'Seattle', 'John' ]
```
</Section>

æ‚¨è¿˜å¯ä»¥ä¸ºè¿æ¥çš„è¡¨æŒ‡å®šåˆ«åï¼ˆåœ¨ PostgreSQL ä¸­ï¼Œä¹Ÿå¯ä»¥ä¸ºæ›´æ–°çš„è¡¨æŒ‡å®šåˆ«åï¼‰ã€‚
<Section>
```ts
const c = alias(cities, 'c');
await db
  .update(users)
  .set({ cityId: c.id })
  .from(c);
```
```sql
update "users" set "city_id" = "c"."id" 
from "cities" "c"
```
</Section>

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': false, 'SingleStore': false, 'MSSQL': false, 'CockroachDB': true }} />

åœ¨ PostgreSQL ä¸­ï¼Œæ‚¨è¿˜å¯ä»¥è¿”å›è¿æ¥è¡¨ä¸­çš„åˆ—ã€‚
<Section>
```ts
const updatedUsers = await db
  .update(users)
  .set({ cityId: cities.id })
  .from(cities)
  .returning({ id: users.id, cityName: cities.name });
```
```sql
update "users" set "city_id" = "cities"."id" 
from "cities" 
returning "users"."id", "cities"."name"
```
</Section>

Source: https://drizzle.zhcndoc.com/docs/upgrade-21

import Callout from '@mdx/Callout.astro';

## å¦‚ä½•è¿ç§»åˆ° `0.21.0`

#### 1. ä»ä½ çš„ drizzle-kit å‘½ä»¤ä¸­ç§»é™¤æ‰€æœ‰ `:dialect` å‰ç¼€ã€‚
ç¤ºä¾‹ï¼šå°† `drizzle-kit push:mysql` æ”¹ä¸º `drizzle-kit push`ã€‚

#### 2. æ›´æ–°ä½ çš„ `drizzle.config.ts` æ–‡ä»¶ï¼š
 - åœ¨ `drizzle.config.ts` ä¸­æ·»åŠ  `dialect`ã€‚è¿™æ˜¯ç°åœ¨çš„å¿…éœ€é¡¹ï¼Œå¯ä»¥æ˜¯ `postgresql`ã€`mysql` æˆ– `sqlite`ã€‚
 - ä»…å½“ä½ ä½¿ç”¨ `aws-data-api`ã€`turso`ã€`d1-http`ï¼ˆè¿›è¡Œä¸­ï¼‰æˆ– `expo` æ—¶ï¼Œæ‰åœ¨ `drizzle.config.ts` ä¸­æ·»åŠ  `driver`ã€‚å¦åˆ™ï¼Œå¯ä»¥ä» `drizzle.config.ts` ä¸­åˆ é™¤ `driver`ã€‚
 - å¦‚æœä½ ä¹‹å‰åœ¨ `dbCredentials` ä¸­ä½¿ç”¨äº† `connectionString` æˆ– `uri`ï¼Œç°åœ¨åº”æ”¹ç”¨ `url`ã€‚
    
```ts
import { defineConfig } from "drizzle-kit"

export default defineConfig({
    dialect: "sqlite", // "postgresql" | "mysql"
    driver: "turso", // å¯é€‰ï¼Œä»…åœ¨ä½¿ç”¨ `aws-data-api`ã€`turso`ã€`d1-http`ï¼ˆè¿›è¡Œä¸­ï¼‰æˆ– `expo` æ—¶ä½¿ç”¨
    dbCredentials: {
        url: ""
    }
})
```

#### 3. å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ PostgreSQL æˆ– SQLiteï¼Œå¹¶ä¸”åœ¨ä½ çš„é¡¹ç›®ä¸­ç”Ÿæˆäº†è¿ç§»ï¼Œè¯·è¿è¡Œ `drizzle-kit up`ï¼Œä»¥ä¾¿ Drizzle å¯ä»¥å°†æ‰€æœ‰å¿«ç…§å‡çº§åˆ°ç‰ˆæœ¬ 6ã€‚

<Callout>
  ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ `0.21.0` ä¸­æ‰€æœ‰çš„å˜æ›´è¯¦æƒ…
</Callout>

## æ›´æ–°æ—¥å¿—

**â— å¿«ç…§å‡çº§**

æ‰€æœ‰ç”± PostgreSQL å’Œ SQLite ç”Ÿæˆçš„å¿«ç…§å°†å‡çº§åˆ°ç‰ˆæœ¬ 6ã€‚ä½ å°†è¢«æç¤ºé€šè¿‡è¿è¡Œ `drizzle-kit up` æ¥å‡çº§å®ƒä»¬ã€‚

**â— ä» `drizzle-kit` CLI å‘½ä»¤ä¸­ç§»é™¤ :dialect**

ä½ ç°åœ¨å¯ä»¥åªä½¿ç”¨å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `drizzle-kit generate`
- `drizzle-kit push`
- ç­‰ç­‰ã€‚

è€Œæ— éœ€æŒ‡å®šæ–¹è¨€ã€‚è¯¥å‚æ•°å·²ç§»è‡³ `drizzle.config.ts`ã€‚

**â— `drizzle.config` æ›´æ–°**

- `dialect` ç°åœ¨æ˜¯å¿…éœ€çš„ï¼›æŒ‡å®šä½ è¿æ¥çš„æ•°æ®åº“æ–¹è¨€ã€‚å¯é€‰é¡¹åŒ…æ‹¬ `mysql`ã€`postgresql` æˆ– `sqlite`ã€‚
- `driver` å·²æˆä¸ºå¯é€‰ï¼Œå¹¶å°†å…·æœ‰ä¸€ä¸ªç‰¹å®šé©±åŠ¨ç¨‹åºï¼Œæ¯ä¸ªé©±åŠ¨ç¨‹åºéƒ½æœ‰ä¸åŒçš„ `dbCredentials` é…ç½®ã€‚å¯ç”¨çš„é©±åŠ¨ç¨‹åºåŒ…æ‹¬ï¼š
  - `aws-data-api`
  - `turso`
  - `d1-http` - ç›®å‰è¿›è¡Œä¸­
  - `expo`
- `url` - ç»Ÿä¸€å‚æ•°ï¼Œæ›¿ä»£ä¹‹å‰å­˜åœ¨çš„ `connectionString` å’Œ `uri`ã€‚
- `migrations` - ä¸€ä¸ªæ–°çš„å¯¹è±¡å‚æ•°ï¼Œç”¨äºæŒ‡å®šè¿ç§»å‘½ä»¤çš„è‡ªå®šä¹‰è¡¨å’Œæ¨¡å¼ï¼š
  - `table` - drizzle å°†å­˜å‚¨è¿ç§»çš„è‡ªå®šä¹‰è¡¨ã€‚
  - `schema` - drizzle å°†å­˜å‚¨è¿ç§»çš„è‡ªå®šä¹‰æ¨¡å¼ï¼ˆä»…é™ PostgreSQLï¼‰ã€‚

æ‰€æœ‰æ–°å’Œæ›´æ–°å‘½ä»¤çš„ä½¿ç”¨ç¤ºä¾‹
```ts
import { defineConfig } from "drizzle-kit"

export default defineConfig({
    dialect: "sqlite", // "postgresql" | "mysql"
    driver: "turso"
    dbCredentials: {
        url: ""
    },
    migration: {
        table: "migrations",
        schema: "public"
    }
})
```

Drizzle é©±åŠ¨ç¨‹åºé€‰æ‹©éµå¾ªå½“å‰ç­–ç•¥ï¼š

å¦‚æœæŒ‡å®šäº† `driver`ï¼Œåˆ™ä½¿ç”¨è¯¥é©±åŠ¨ç¨‹åºè¿›è¡ŒæŸ¥è¯¢ã€‚

å¦‚æœæœªæŒ‡å®šé©±åŠ¨ç¨‹åºï¼š

- å¯¹äº `postgresql` æ–¹è¨€ï¼ŒDrizzle å°†ï¼š
  - æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `pg` é©±åŠ¨ç¨‹åºå¹¶ä½¿ç”¨å®ƒã€‚
  - å¦‚æœæ²¡æœ‰ï¼Œå°è¯•æ‰¾åˆ° `postgres` é©±åŠ¨ç¨‹åºå¹¶ä½¿ç”¨å®ƒã€‚
  - å¦‚æœä»æœªæ‰¾åˆ°ï¼Œå°è¯•æ‰¾åˆ° `@vercel/postgres`ã€‚
  - ç„¶åå°è¯• `@neondatabase/serverless`ã€‚
  - å¦‚æœæœªæ‰¾åˆ°ä»»ä½•å†…å®¹ï¼Œå°†æŠ›å‡ºé”™è¯¯ã€‚

- å¯¹äº `mysql` æ–¹è¨€ï¼ŒDrizzle å°†ï¼š
  - æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `mysql2` é©±åŠ¨ç¨‹åºå¹¶ä½¿ç”¨å®ƒã€‚
  - å¦‚æœæ²¡æœ‰ï¼Œå°è¯•æ‰¾åˆ° `@planetscale/database` å¹¶ä½¿ç”¨å®ƒã€‚
  - å¦‚æœæœªæ‰¾åˆ°ä»»ä½•å†…å®¹ï¼Œå°†æŠ›å‡ºé”™è¯¯ã€‚

- å¯¹äº `sqlite` æ–¹è¨€ï¼ŒDrizzle å°†ï¼š
  - æ£€æŸ¥æ˜¯å¦å®‰è£…äº† `@libsql/client` é©±åŠ¨ç¨‹åºå¹¶ä½¿ç”¨å®ƒã€‚
  - å¦‚æœæ²¡æœ‰ï¼Œå°è¯•æ‰¾åˆ° `better-sqlite3` å¹¶ä½¿ç”¨å®ƒã€‚
  - å¦‚æœæœªæ‰¾åˆ°ä»»ä½•å†…å®¹ï¼Œå°†æŠ›å‡ºé”™è¯¯ã€‚

**â— MySQL æ¨¡å¼/æ•°æ®åº“ä¸å†è¢« drizzle-kit æ”¯æŒ**

Drizzle Kit å°†ä¸å¤„ç†ä½  drizzle æ¨¡å¼æ–‡ä»¶ä¸­å…¶ä»–æ¨¡å¼/æ•°æ®åº“çš„ä»»ä½•æ¨¡å¼æ›´æ”¹ã€‚

# æ–°ç‰¹æ€§

**ğŸ‰ æ‹‰å–å…³ç³»**

Drizzle ç°åœ¨å°†é€šè¿‡æå–å¤–é”®ä¿¡æ¯å¹¶å°†å…¶è½¬æ¢ä¸º `relations` å¯¹è±¡ï¼Œä»æ•°æ®åº“ä¸­æ‹‰å– `relations`ã€‚ä½ å¯ä»¥åœ¨å®Œæˆåå°„åæŸ¥çœ‹ `out` æ–‡ä»¶å¤¹ä¸­çš„ `relations.ts` æ–‡ä»¶ã€‚

æœ‰å…³å…³ç³»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥é˜… [æ–‡æ¡£](/docs/rqb#declaring-relations)ã€‚


**ğŸ‰ ä¸ºç”Ÿæˆçš„è¿ç§»æŒ‡å®šè‡ªå®šä¹‰åç§°**

è¦ä¸ºä½ çš„è¿ç§»æŒ‡å®šåç§°ï¼Œåº”ä½¿ç”¨ `--name <name>`ã€‚

ç”¨æ³•
```
drizzle-kit generate --name init_db
```

**ğŸ‰ æ–°å‘½ä»¤ `migrate`**

ä½ ç°åœ¨å¯ä»¥ç›´æ¥ä» `drizzle-kit` å°†ç”Ÿæˆçš„è¿ç§»åº”ç”¨åˆ°ä½ çš„æ•°æ®åº“ä¸­ã€‚

ç”¨æ³•
```
drizzle-kit migrate
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œdrizzle-kit å°†åœ¨ `__drizzle_migrations` è¡¨ä¸­å­˜å‚¨è¿ç§»æ•°æ®æ¡ç›®ï¼Œå¹¶åœ¨ PostgreSQL çš„æƒ…å†µä¸‹å­˜å‚¨åœ¨ `drizzle` æ¨¡å¼ä¸­ã€‚å¦‚æœä½ æƒ³æ›´æ”¹æ­¤è®¾ç½®ï¼Œåˆ™éœ€è¦åœ¨ `drizzle.config.ts` ä¸­æŒ‡å®šä¿®æ”¹ã€‚

```ts
import { defineConfig } from "drizzle-kit"

export default defineConfig({
    migrations: {
        table: "migrations",
        schema: "public"
    }
})
```

Source: https://drizzle.zhcndoc.com/docs/upgrade-v1

import Npm from "@mdx/Npm.astro";
import Npx from "@mdx/Npx.astro";
import Prerequisites from "@mdx/Prerequisites.astro";

# å‡çº§åˆ° Drizzle v1 RC

<Prerequisites>
  - **beta.1** ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ â€”â€” ä»‹äº `latest` å’Œ `beta` ç‰ˆæœ¬ä¹‹é—´çš„ä¸€ç»„å˜æ›´ â€”â€” [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://github.com/drizzle-team/drizzle-orm/blob/beta/changelogs/drizzle-orm/1.0.0-beta.1.md)
  - **beta.2** ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ â€”â€” ä»‹äº `latest` å’Œ `beta` ç‰ˆæœ¬ä¹‹é—´çš„é¢å¤–å˜æ›´ â€”â€” [ç‚¹å‡»è¿™é‡Œé˜…è¯»](https://github.com/drizzle-team/drizzle-orm/releases/tag/v1.0.0-beta.2)
  - ç†æƒ³æƒ…å†µä¸‹ï¼Œé˜…è¯»æ‰€æœ‰å…¶ä»– `beta.X` ç‰ˆæœ¬çš„å˜æ›´ï¼Œä»¥ç†Ÿæ‚‰æ‰€æœ‰ä¿®å¤å’Œæ›´æ”¹å†…å®¹
</Prerequisites>

Drizzle å‘å¸ƒå€™é€‰ç‰ˆæœ¬æ‰˜ç®¡åœ¨ drizzle ä»“åº“çš„ [`beta` åˆ†æ”¯](https://github.com/drizzle-team/drizzle-orm/tree/beta) å’Œ npm ä¸Šçš„ `beta` æ ‡ç­¾ä¸‹ã€‚è¦å®‰è£…å®ƒï¼Œéœ€è¦è¿è¡Œï¼š

<Npm>
drizzle-orm@beta
-D drizzle-kit@beta
</Npm>

å®ƒéµå¾ª `1.0.0-beta.x` çš„ç‰ˆæœ¬æ¨¡å¼ï¼Œå› æ­¤ä½ ä¼šçœ‹åˆ°è¯¸å¦‚ `1.0.0-beta.7`ã€`1.0.0-beta.8` ç­‰ç‰ˆæœ¬ã€‚æ¯ä¸ª beta æ›´æ–°çš„å‘å¸ƒè¯´æ˜å¯åœ¨ [GitHub releases](https://github.com/drizzle-team/drizzle-orm/tags) è·å–ã€‚

#### æ­¥éª¤ 1 - è¿è¡Œ `drizzle-kit up`

> ç›¸å…³è®¨è®ºï¼šhttps://github.com/drizzle-team/drizzle-orm/discussions/2832

æˆ‘ä»¬æ›´æ–°äº†è¿ç§»æ–‡ä»¶å¤¹çš„ç»“æ„ï¼Œå…·ä½“åŒ…æ‹¬ï¼š
- ç§»é™¤ `journal.json`
- å°† SQL æ–‡ä»¶å’Œå¿«ç…§æ–‡ä»¶åˆ†ç»„æ”¾å…¥å•ç‹¬çš„è¿ç§»æ–‡ä»¶å¤¹
- ç§»é™¤ `drizzle-kit drop` å‘½ä»¤

è¿™äº›æ›´æ”¹æ¶ˆé™¤äº† journal æ–‡ä»¶å¯èƒ½å¼•èµ·çš„ Git å†²çªï¼Œå¹¶ç®€åŒ–äº†åˆ é™¤æˆ–ä¿®å¤å†²çªè¿ç§»çš„è¿‡ç¨‹ã€‚

åœ¨å³å°†å‘å¸ƒçš„ `beta` ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å°†å¼•å…¥äº¤æ¢å¾‹æ£€æŸ¥ï¼Œå¸®åŠ©ä½ åº”å¯¹å›¢é˜Ÿåä½œä¸­è¿ç§»å†²çªé—®é¢˜ï¼Œæ£€æµ‹æ½œåœ¨ç¢°æ’å¹¶æä¾›è§£å†³å»ºè®®ã€‚
> äº¤æ¢å¾‹è®¨è®ºï¼šhttps://github.com/drizzle-team/drizzle-orm/discussions/5005

è¦å°†ä¹‹å‰çš„æ–‡ä»¶å¤¹è¿ç§»åˆ°æ–°æ ¼å¼ï¼Œéœ€è¦è¿è¡Œ

<Npx>
drizzle-kit up
</Npx>

#### æ­¥éª¤ 2 - æ›´æ–°å…³ç³»æŸ¥è¯¢åˆ° v2

æˆ‘ä»¬è¯¦ç»†è§£é‡Šäº†æ‰€æœ‰ RQBv2 çš„å˜æ›´ï¼Œä»¥åŠæ›´æ–°ä»£ç åº“çš„æ–¹æ¡ˆï¼š

- [å¦‚ä½•å°†å…³ç³»å®šä¹‰ä» v1 è¿ç§»åˆ° v2](/docs/relations-v1-v2#how-to-migrate-relations-schema-definition-from-v1-to-v2)  
- [å¦‚ä½•å°†æŸ¥è¯¢ä» v1 è¿ç§»åˆ° v2](/docs/relations-v1-v2#how-to-migrate-queries-from-v1-to-v2)  
- [éƒ¨åˆ†å‡çº§ï¼Œæˆ–å¦‚ä½•åœ¨å‡çº§åä»ä¿ç•™ v1 ä½¿ç”¨ï¼Ÿ](/docs/relations-v1-v2#partial-upgrade-or-how-to-stay-on-rqb-v1-even-after-an-upgrade)  

#### æ­¥éª¤ 3 - å®Œæˆ âœ…

Source: https://drizzle.zhcndoc.com/docs/valibot

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';

# drizzle-valibot

`drizzle-valibot` æ˜¯ä¸€ä¸ª **[Drizzle ORM](https://github.com/drizzle-team/drizzle-orm)** çš„æ’ä»¶ï¼Œå…è®¸ä½ ä» Drizzle ORM æ–¹æ¡ˆç”Ÿæˆ **[Valibot](https://valibot.dev/)** æ–¹æ¡ˆã€‚

### å®‰è£…ä¾èµ–

<Npm>
drizzle-valibot
</Npm>

<Callout type="warning">
æ­¤æ–‡æ¡£é€‚ç”¨äº `drizzle-valibot@0.3.0` åŠæ›´é«˜ç‰ˆæœ¬

ä½ è¿˜å¿…é¡»å®‰è£… Drizzle ORM v0.36.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥åŠ Valibot v1.0.0-beta.7 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
</Callout>

### é€‰æ‹©æ–¹æ¡ˆ

å®šä¹‰ä»æ•°æ®åº“æŸ¥è¯¢çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API å“åº”ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-valibot';
import { parse } from 'valibot';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userSelectSchema = createSelectSchema(users);

const rows = await db.select({ id: users.id, name: users.name }).from(users).limit(1);
const parsed: { id: number; name: string; age: number } = parse(userSelectSchema, rows[0]); // é”™è¯¯ï¼šä¸Šè¿°æŸ¥è¯¢ä¸­æœªè¿”å› `age`

const rows = await db.select().from(users).limit(1);
const parsed: { id: number; name: string; age: number } = parse(userSelectSchema, rows[0]); // å°†æˆåŠŸè§£æ
```

è§†å›¾å’Œæšä¸¾ä¹Ÿå—åˆ°æ”¯æŒã€‚

```ts copy
import { pgEnum } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-valibot';
import { parse } from 'valibot';

const roles = pgEnum('roles', ['admin', 'basic']);
const rolesSchema = createSelectSchema(roles);
const parsed: 'admin' | 'basic' = parse(rolesSchema, ...);

const usersView = pgView('users_view').as((qb) => qb.select().from(users).where(gt(users.age, 18)));
const usersViewSchema = createSelectSchema(usersView);
const parsed: { id: number; name: string; age: number } = parse(usersViewSchema, ...);
```

### æ’å…¥æ–¹æ¡ˆ

å®šä¹‰è¦æ’å…¥åˆ°æ•°æ®åº“ä¸­çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createInsertSchema } from 'drizzle-valibot';
import { parse } from 'valibot';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userInsertSchema = createInsertSchema(users);

const user = { name: 'John' };
const parsed: { name: string, age: number } = parse(userInsertSchema, user); // é”™è¯¯ï¼š`age` æœªå®šä¹‰

const user = { name: 'Jane', age: 30 };
const parsed: { name: string, age: number } = parse(userInsertSchema, user); // å°†æˆåŠŸè§£æ
await db.insert(users).values(parsed);
```

### æ›´æ–°æ–¹æ¡ˆ

å®šä¹‰è¦åœ¨æ•°æ®åº“ä¸­æ›´æ–°çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createUpdateSchema } from 'drizzle-valibot';
import { parse } from 'valibot';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userUpdateSchema = createUpdateSchema(users);

const user = { id: 5, name: 'John' };
const parsed: { name?: string | undefined, age?: number | undefined } = parse(userUpdateSchema, user); // é”™è¯¯ï¼š`id` æ˜¯ä¸€ä¸ªç”Ÿæˆåˆ—ï¼Œæ— æ³•æ›´æ–°

const user = { age: 35 };
const parsed: { name?: string | undefined, age?: number | undefined } = parse(userUpdateSchema, user); // å°†æˆåŠŸè§£æ
await db.update(users).set(parsed).where(eq(users.name, 'Jane'));
```

### ç»†åŒ–

æ¯ä¸ªåˆ›å»ºæ¨¡å¼å‡½æ•°æ¥å—ä¸€ä¸ªé¢å¤–çš„å¯é€‰å‚æ•°ï¼Œä½ å¯ä»¥ç”¨æ¥æ‰©å±•ã€ä¿®æ”¹æˆ–å®Œå…¨è¦†ç›–å­—æ®µçš„æ–¹æ¡ˆã€‚å®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°å°†æ‰©å±•æˆ–ä¿®æ”¹ï¼Œè€Œæä¾›ä¸€ä¸ª Valibot æ–¹æ¡ˆå°†è¦†ç›–å®ƒã€‚

```ts copy
import { pgTable, text, integer, json } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-valibot';
import { parse, pipe, maxLength, object, string } from 'valibot';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  bio: text(),
  preferences: json()
});

const userSelectSchema = createSelectSchema(users, {
  name: (schema) => pipe(schema, maxLength(20)), // æ‰©å±•æ–¹æ¡ˆ
  bio: (schema) => pipe(schema, maxLength(1000)), // åœ¨å˜ä¸ºå¯ç©º/å¯é€‰ä¹‹å‰æ‰©å±•æ–¹æ¡ˆ
  preferences: object({ theme: string() }) // è¦†ç›–å­—æ®µï¼ŒåŒ…æ‹¬å…¶å¯ç©ºæ€§
});

const parsed: {
  id: number;
  name: string,
  bio?: string | undefined;
  preferences: {
    theme: string;
  };
} = parse(userSelectSchema, ...);
```

### æ•°æ®ç±»å‹å‚è€ƒ

```ts
pg.boolean();

mysql.boolean();

sqlite.integer({ mode: 'boolean' });

// æ–¹æ¡ˆ
boolean();
```

```ts
pg.date({ mode: 'date' });
pg.timestamp({ mode: 'date' });

mysql.date({ mode: 'date' });
mysql.datetime({ mode: 'date' });
mysql.timestamp({ mode: 'date' });

sqlite.integer({ mode: 'timestamp' });
sqlite.integer({ mode: 'timestamp_ms' });

// æ–¹æ¡ˆ
date();
```

```ts
pg.date({ mode: 'string' });
pg.timestamp({ mode: 'string' });
pg.cidr();
pg.inet();
pg.interval();
pg.macaddr();
pg.macaddr8();
pg.numeric();
pg.text();
pg.sparsevec();
pg.time();

mysql.binary();
mysql.date({ mode: 'string' });
mysql.datetime({ mode: 'string' });
mysql.decimal();
mysql.time();
mysql.timestamp({ mode: 'string' });
mysql.varbinary();

sqlite.numeric();
sqlite.text({ mode: 'text' });

// æ–¹æ¡ˆ
string();
```

```ts
pg.bit({ dimensions: ... });

// æ–¹æ¡ˆ
pipe(string(), regex(/^[01]+$/), maxLength(dimensions));
```

```ts
pg.uuid();

// æ–¹æ¡ˆ
pipe(string(), uuid());
```

```ts
pg.char({ length: ... });

mysql.char({ length: ... });

// æ–¹æ¡ˆ
pipe(string(), length(length));
```

```ts
pg.varchar({ length: ... });

mysql.varchar({ length: ... });

sqlite.text({ mode: 'text', length: ... });

// æ–¹æ¡ˆ
pipe(string(), maxLength(length));
```

```ts
mysql.tinytext();

// æ–¹æ¡ˆ
pipe(string(), maxLength(255)); // æ— ç¬¦å· 8 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.text();

// æ–¹æ¡ˆ
pipe(string(), maxLength(65_535)); // æ— ç¬¦å· 16 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.mediumtext();

// æ–¹æ¡ˆ
pipe(string(), maxLength(16_777_215)); // æ— ç¬¦å· 24 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.longtext();

// æ–¹æ¡ˆ
pipe(string(), maxLength(4_294_967_295)); // æ— ç¬¦å· 32 ä½æ•´æ•°é™åˆ¶
```

```ts
pg.text({ enum: ... });
pg.char({ enum: ... });
pg.varchar({ enum: ... });

mysql.tinytext({ enum: ... });
mysql.mediumtext({ enum: ... });
mysql.text({ enum: ... });
mysql.longtext({ enum: ... });
mysql.char({ enum: ... });
mysql.varchar({ enum: ... });
mysql.mysqlEnum(..., ...);

sqlite.text({ mode: 'text', enum: ... });

// æ–¹æ¡ˆ
enum(enum);
```

```ts
mysql.tinyint();

// æ–¹æ¡ˆ
pipe(number(), minValue(-128), maxValue(127), integer()); // 8 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.tinyint({ unsigned: true });

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(255), integer()); // æ— ç¬¦å· 8 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.smallint();
pg.smallserial();

mysql.smallint();

// æ–¹æ¡ˆ
pipe(number(), minValue(-32_768), maxValue(32_767), integer()); // 16 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.smallint({ unsigned: true });

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(65_535), integer()); // æ— ç¬¦å· 16 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.real();

mysql.float();

// æ–¹æ¡ˆ
pipe(number(), minValue(-8_388_608), maxValue(8_388_607)); // 24 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.mediumint();

// æ–¹æ¡ˆ
pipe(number(), minValue(-8_388_608), maxValue(8_388_607), integer()); // 24 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.float({ unsigned: true });

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(16_777_215)); // æ— ç¬¦å· 24 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.mediumint({ unsigned: true });

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(16_777_215), integer()); // æ— ç¬¦å· 24 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.integer();
pg.serial();

mysql.int();

// æ–¹æ¡ˆ
pipe(number(), minValue(-2_147_483_648), maxValue(2_147_483_647), integer()); // 32 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.int({ unsigned: true });

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(4_294_967_295), integer()); // æ— ç¬¦å· 32 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.doublePrecision();

mysql.double();
mysql.real();

sqlite.real();

// æ–¹æ¡ˆ
pipe(number(), minValue(-140_737_488_355_328), maxValue(140_737_488_355_327)); // 48 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.double({ unsigned: true });

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(281_474_976_710_655)); // æ— ç¬¦å· 48 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
pg.bigint({ mode: 'number' });
pg.bigserial({ mode: 'number' });

mysql.bigint({ mode: 'number' });
mysql.bigserial({ mode: 'number' });

sqlite.integer({ mode: 'number' });

// æ–¹æ¡ˆ
pipe(number(), minValue(-9_007_199_254_740_991), maxValue(9_007_199_254_740_991), integer()); // Javascript æœ€å°å’Œæœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
mysql.serial();

// æ–¹æ¡ˆ
pipe(number(), minValue(0), maxValue(9_007_199_254_740_991), integer()); // Javascript æœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
pg.bigint({ mode: 'bigint' });
pg.bigserial({ mode: 'bigint' });

mysql.bigint({ mode: 'bigint' });

sqlite.blob({ mode: 'bigint' });

// æ–¹æ¡ˆ
pipe(bigint(), minValue(-9_223_372_036_854_775_808n), maxValue(9_223_372_036_854_775_807n)); // 64 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.bigint({ mode: 'bigint', unsigned: true });

// æ–¹æ¡ˆ
pipe(bigint(), minValue(0n), maxValue(18_446_744_073_709_551_615n)); // æ— ç¬¦å· 64 ä½æ•´æ•°ä¸Šä¸‹é™
```

```ts
mysql.year();

// æ–¹æ¡ˆ
pipe(number(), minValue(1_901), maxValue(2_155), integer());
```

```ts
pg.geometry({ type: 'point', mode: 'tuple' });
pg.point({ mode: 'tuple' });

// æ–¹æ¡ˆ
tuple([number(), number()]);
```

```ts
pg.geometry({ type: 'point', mode: 'xy' });
pg.point({ mode: 'xy' });

// æ–¹æ¡ˆ
object({ x: number(), y: number() });
```

```ts
pg.halfvec({ dimensions: ... });
pg.vector({ dimensions: ... });

// æ–¹æ¡ˆ
pipe(array(number()), length(dimensions));
```

```ts
pg.line({ mode: 'abc' });

// æ–¹æ¡ˆ
object({ a: number(), b: number(), c: number() });
```

```ts
pg.line({ mode: 'tuple' });

// æ–¹æ¡ˆ
tuple([number(), number(), number()]);
```

```ts
pg.json();
pg.jsonb();

mysql.json();

sqlite.blob({ mode: 'json' });
sqlite.text({ mode: 'json' });

// æ–¹æ¡ˆ
union([union([string(), number(), boolean(), null_()]), array(any()), record(string(), any())]);
```

```ts
sqlite.blob({ mode: 'buffer' });

// æ–¹æ¡ˆ
custom<Buffer>((v) => v instanceof Buffer);
```

```ts
pg.dataType().array(...);

// æ–¹æ¡ˆ
pipe(array(baseDataTypeSchema), length(size));
``` 

Source: https://drizzle.zhcndoc.com/docs/views

import Tab from '@mdx/Tab.astro';
import Tabs from '@mdx/Tabs.astro';
import IsSupportedChipGroup from '@mdx/IsSupportedChipGroup.astro';
import Callout from '@mdx/Callout.astro';
import Section from '@mdx/Section.astro';

# è§†å›¾

<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'SQLite': true, 'MySQL': true, 'SingleStore': false, 'MSSQL': true, 'CockroachDB': true }} />
ä½ å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼åœ¨ Drizzle ORM ä¸­å£°æ˜è§†å›¾ã€‚

ä½ å¯ä»¥å£°æ˜éœ€è¦åˆ›å»ºçš„è§†å›¾ï¼Œæˆ–è€…å£°æ˜å·²å­˜åœ¨äºæ•°æ®åº“ä¸­çš„è§†å›¾ã€‚

ä½ å¯ä»¥ä½¿ç”¨å†…è” `query builder` è¯­æ³•ã€ç‹¬ç«‹çš„ `query builder` å’ŒåŸå§‹çš„ `sql` æ“ä½œç¬¦æ¥å£°æ˜è§†å›¾ã€‚

å½“ä½¿ç”¨å†…è”æˆ–ç‹¬ç«‹çš„æŸ¥è¯¢æ„å»ºå™¨åˆ›å»ºè§†å›¾æ—¶ï¼Œè§†å›¾åˆ—çš„æ¶æ„å°†è‡ªåŠ¨æ¨æ–­ï¼Œ
ä½†å¦‚æœä½¿ç”¨ `sql`ï¼Œåˆ™å¿…é¡»æ˜¾å¼å£°æ˜è§†å›¾åˆ—çš„æ¶æ„ã€‚

### å£°æ˜è§†å›¾
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {13-14}
      import { pgTable, pgView, serial, text, timestamp } from "drizzle-orm/pg-core";

      export const user = pgTable("user", {
        id: serial(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = pgView("user_view").as((qb) => qb.select().from(user));
      export const customersView = pgView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {13-14}
      import { text, mysqlTable, mysqlView, int, timestamp } from "drizzle-orm/mysql-core";

      export const user = mysqlTable("user", {
        id: int().primaryKey().autoincrement(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = mysqlView("user_view").as((qb) => qb.select().from(user));
      export const customersView = mysqlView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {13-14}
      import { integer, text, sqliteView, sqliteTable } from "drizzle-orm/sqlite-core";

      export const user = sqliteTable("user", {
        id: integer().primaryKey({ autoIncrement: true }),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: integer("created_at"),
        updatedAt: integer("updated_at"),
      });

      export const userView = sqliteView("user_view").as((qb) => qb.select().from(user));
      export const customersView = sqliteView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
    <Tab>
    <Section>
      ```ts filename="schema.ts" copy {13-14}
      import { mssqlTable, mssqlView, int, text, timestamp } from "drizzle-orm/mssql-core";

      export const user = mssqlTable("user", {
        id: int(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = mssqlView("user_view").as((qb) => qb.select().from(user));
      export const customersView = mssqlView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW [user_view] AS (SELECT * FROM "user");
      CREATE VIEW [customers_view] AS (SELECT * FROM "user" WHERE "role" = 'customer');
      ```
    </Section>
    å¦‚æœä½ éœ€è¦ä¸€ä¸ªåˆ—çš„å­é›†ï¼Œä½ å¯ä»¥åœ¨æŸ¥è¯¢æ„å»ºå™¨ä¸­ä½¿ç”¨ `.select({ ... })` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
<Section>
  ```ts {4-6}
  export const customersView = mssqlView("customers_view").as((qb) => {
    return qb
      .select({
        id: user.id,
        name: user.name,
        email: user.email,
      })
      .from(user);
  });
  ```
  ```sql
  CREATE VIEW [customers_view] AS (SELECT "id", "name", "email" FROM "user" WHERE "role" = 'customer');
  ```
</Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {13-14}
      import { cockroachTable, cockroachView, int4, text, timestamp } from "drizzle-orm/cockroach-core";

      export const user = cockroachTable("user", {
        id: int4(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = cockroachView("user_view").as((qb) => qb.select().from(user));
      export const customersView = cockroachView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
</Tabs>

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `ç‹¬ç«‹çš„æŸ¥è¯¢æ„å»ºå™¨` å£°æ˜è§†å›¾ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å®Œå…¨ç›¸åŒï¼š
<Tabs items={['PostgreSQL', 'MySQL', 'SQLite', 'MSSQL', 'CockroachDB']}>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {3, 15-16}
      import { pgTable, pgView, serial, text, timestamp, QueryBuilder} from "drizzle-orm/pg-core";
      
      const qb = new QueryBuilder();

      export const user = pgTable("user", {
        id: serial(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = pgView("user_view").as(qb.select().from(user));
      export const customersView = pgView("customers_view").as(qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {3, 15-16}
      import { text, mysqlTable, mysqlView, int, timestamp, QueryBuilder } from "drizzle-orm/mysql-core";

      const qb = new QueryBuilder();

      export const user = mysqlTable("user", {
        id: int().primaryKey().autoincrement(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = mysqlView("user_view").as(qb.select().from(user));
      export const customersView = mysqlView("customers_view").as(qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {3, 15-16}
      import { integer, text, sqliteView, sqliteTable, QueryBuilder } from "drizzle-orm/sqlite-core";

      const qb = new QueryBuilder();

      export const user = sqliteTable("user", {
        id: integer().primaryKey({ autoIncrement: true }),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: integer("created_at"),
        updatedAt: integer("updated_at"),
      });

      export const userView = sqliteView("user_view").as((qb) => qb.select().from(user));
      export const customerView = sqliteView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {3, 15-16}
      import { int, text, mssqlView, mssqlTable, QueryBuilder } from "drizzle-orm/mssql-core";

      const qb = new QueryBuilder();

      export const user = mssqlTable("user", {
        id: integer().primaryKey(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: integer("created_at"),
        updatedAt: integer("updated_at"),
      });

      export const userView = mssqlView("user_view").as((qb) => qb.select().from(user));
      export const customerView = mssqlView("customers_view").as((qb) => qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW [user_view] AS (SELECT * FROM "user");
      CREATE VIEW [customers_view] AS (SELECT * FROM "user" WHERE "role" = 'customer');
      ```
    </Section>
  </Tab>
  <Tab>
    <Section>
      ```ts filename="schema.ts" copy {3, 15-16}
      import { cockroachTable, cockroachView, int4, text, timestamp, QueryBuilder} from "drizzle-orm/cockroach-core";
      
      const qb = new QueryBuilder();

      export const user = cockroachTable("user", {
        id: int4(),
        name: text(),
        email: text(),
        password: text(),
        role: text().$type<"admin" | "customer">(),
        createdAt: timestamp("created_at"),
        updatedAt: timestamp("updated_at"),
      });

      export const userView = cockroachView("user_view").as(qb.select().from(user));
      export const customersView = cockroachView("customers_view").as(qb.select().from(user).where(eq(user.role, "customer")));
      ```
      ```sql
      CREATE VIEW "user_view" AS SELECT * FROM "user";
      CREATE VIEW "customers_view" AS SELECT * FROM "user" WHERE "role" = 'customer';
      ```
    </Section>
  </Tab>
</Tabs>

### ä½¿ç”¨åŸå§‹ SQL å£°æ˜è§†å›¾
æ¯å½“ä½ éœ€è¦ä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨ä¸æ”¯æŒçš„è¯­æ³•å£°æ˜è§†å›¾æ—¶ï¼Œ
ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ `sql` æ“ä½œç¬¦å¹¶æ˜¾å¼æŒ‡å®šè§†å›¾åˆ—çš„æ¶æ„ã€‚

```ts copy
// å¸¸è§„è§†å›¾
const newYorkers = pgView('new_yorkers', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  cityId: integer('city_id').notNull(),
}).as(sql`select * from ${users} where ${eq(users.cityId, 1)}`);

// ç‰©åŒ–è§†å›¾
const newYorkers = pgMaterializedView('new_yorkers', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  cityId: integer('city_id').notNull(),
}).as(sql`select * from ${users} where ${eq(users.cityId, 1)}`);
```

### å£°æ˜å·²å­˜åœ¨çš„è§†å›¾
å½“ä½ è·å¾—å¯¹æ•°æ®åº“ä¸­ç°æœ‰è§†å›¾çš„åªè¯»è®¿é—®æƒé™æ—¶ï¼Œå¯ä½¿ç”¨ `.existing()` è§†å›¾é…ç½®ï¼Œ
`drizzle-kit` å°†å¿½ç•¥å¹¶ä¸ä¼šåœ¨ç”Ÿæˆçš„è¿ç§»ä¸­ç”Ÿæˆ `create view` è¯­å¥ã€‚
```ts
export const user = pgTable("user", {
  id: serial(),
  name: text(),
  email: text(),
  password: text(),
  role: text().$type<"admin" | "customer">(),
  createdAt: timestamp("created_at"),
  updatedAt: timestamp("updated_at"),
});

// å¸¸è§„è§†å›¾
export const trimmedUser = pgView("trimmed_user", {
  id: serial("id"),
  name: text("name"),
  email: text("email"),
}).existing();

// ç‰©åŒ–è§†å›¾ä¸ä¼šæœ‰ä»»ä½•åŒºåˆ«ï¼Œä½†ä½ å¯ä»¥ä¸ºä¸€è‡´æ€§ä½¿ç”¨å®ƒ
export const trimmedUser = pgMaterializedView("trimmed_user", {
  id: serial("id"),
  name: text("name"),
  email: text("email"),
}).existing();
```

### ç‰©åŒ–è§†å›¾
<IsSupportedChipGroup chips={{ 'PostgreSQL': true, 'MySQL': false, 'SQLite': false, 'MSSQL': false, 'Cockroach': true }} />

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼ŒPostgreSQL å’Œ CockroachDB å…·æœ‰ **[`å¸¸è§„`](https://www.postgresql.org/docs/current/sql-createview.html)**
å’Œ **[`ç‰©åŒ–`](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)** è§†å›¾ã€‚
  
PostgreSQL å’Œ CockroachDB ä¸­çš„ç‰©åŒ–è§†å›¾åƒè§†å›¾ä¸€æ ·ä½¿ç”¨è§„åˆ™ç³»ç»Ÿï¼Œä½†ä»¥è¡¨æ ¼å½¢å¼æŒä¹…åŒ–ç»“æœã€‚
{/* è¿™æ„å‘³ç€ï¼Œå½“å¯¹ç‰©åŒ–è§†å›¾æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œç»“æœç›´æ¥æ¥è‡ªç‰©åŒ–è§†å›¾ï¼Œ
åƒæ¥è‡ªè¡¨æ ¼ä¸€æ ·ï¼Œè€Œä¸æ˜¯é€šè¿‡åœ¨æ„æˆè§†å›¾çš„åŸºç¡€è¡¨ä¸Šæ‰§è¡ŒæŸ¥è¯¢æ¥é‡å»ºã€‚ */}

<Tabs items={['PostgreSQL', 'CockroachDB']}>
<Tab>
<Section>
```ts filename="schema.ts" copy
const newYorkers = pgMaterializedView('new_yorkers').as((qb) => qb.select().from(users).where(eq(users.cityId, 1)));
```
```sql
CREATE MATERIALIZED VIEW "new_yorkers" AS SELECT * FROM "users";
```
</Section>

ä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾ï¼š
```ts copy
await db.refreshMaterializedView(newYorkers);

await db.refreshMaterializedView(newYorkers).concurrently();

await db.refreshMaterializedView(newYorkers).withNoData();
```
</Tab>
<Tab>
<Section>
```ts filename="schema.ts" copy
const newYorkers = cockroachMaterializedView('new_yorkers').as((qb) => qb.select().from(users).where(eq(users.cityId, 1)));
```
```sql
CREATE MATERIALIZED VIEW "new_yorkers" AS SELECT * FROM "users";
```
</Section>

ä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾ï¼š
```ts copy
await db.refreshMaterializedView(newYorkers);

await db.refreshMaterializedView(newYorkers).concurrently();

await db.refreshMaterializedView(newYorkers).withNoData();
```
</Tab>
</Tabs>

### æ‰©å±•ç¤ºä¾‹
<Callout type="info" emoji="â„¹ï¸">
æŸ¥è¯¢ä¸­çš„æ‰€æœ‰å‚æ•°å°†è¢«å†…è”ï¼Œè€Œä¸æ˜¯æ›¿æ¢ä¸º `$1`ã€`$2` ç­‰ã€‚
</Callout>

<Tabs items={['PostgreSQL', 'CockroachDB']}>
<Tab>
```ts copy
// å¸¸è§„è§†å›¾
const newYorkers = pgView('new_yorkers')
  .with({
    checkOption: 'cascaded',
    securityBarrier: true,
    securityInvoker: true,
  })
  .as((qb) => {
    const sq = qb
      .$with('sq')
      .as(
        qb.select({ userId: users.id, cityId: cities.id })
          .from(users)
          .leftJoin(cities, eq(cities.id, users.homeCity))
          .where(sql`${users.age1} > 18`),
      );
    return qb.with(sq).select().from(sq).where(sql`${users.homeCity} = 1`);
  });

// ç‰©åŒ–è§†å›¾
const newYorkers2 = pgMaterializedView('new_yorkers')
  .using('btree')
  .with({
    fillfactor: 90,
    toast_tuple_target: 0.5,
    autovacuum_enabled: true,
    ...
  })
  .tablespace('custom_tablespace')
  .withNoData()
  .as((qb) => {
    const sq = qb
      .$with('sq')
      .as(
        qb.select({ userId: users.id, cityId: cities.id })
          .from(users)
          .leftJoin(cities, eq(cities.id, users.homeCity))
          .where(sql`${users.age1} > 18`),
      );
    return qb.with(sq).select().from(sq).where(sql`${users.homeCity} = 1`);
  });
```
</Tab>
<Tab>
```ts copy
// å¸¸è§„è§†å›¾
const newYorkers = cockroachView('new_yorkers')
  .as((qb) => {
    const sq = qb
      .$with('sq')
      .as(
        qb.select({ userId: users.id, cityId: cities.id })
          .from(users)
          .leftJoin(cities, eq(cities.id, users.homeCity))
          .where(sql`${users.age1} > 18`),
      );
    return qb.with(sq).select().from(sq).where(sql`${users.homeCity} = 1`);
  });

// ç‰©åŒ–è§†å›¾
const newYorkers2 = cockroachMaterializedView('new_yorkers')
  .withNoData()
  .as((qb) => {
    const sq = qb
      .$with('sq')
      .as(
        qb.select({ userId: users.id, cityId: cities.id })
          .from(users)
          .leftJoin(cities, eq(cities.id, users.homeCity))
          .where(sql`${users.age1} > 18`),
      );
    return qb.with(sq).select().from(sq).where(sql`${users.homeCity} = 1`);
  });
```
</Tab>
</Tabs>

Source: https://drizzle.zhcndoc.com/docs/why-drizzle

import Callout from '@mdx/Callout.astro';
import CodeTabs from '@mdx/CodeTabs.astro';
import YoutubeCards from '@mdx/YoutubeCards.astro';

# Drizzle ORM  
> Drizzle æ˜¯ä¸€ä¸ªå¥½æœ‹å‹ï¼Œåœ¨ä½ éœ€è¦çš„æ—¶å€™ä¼šå‡ºç°ï¼Œåœ¨ä½ éœ€è¦ç©ºé—´çš„æ—¶å€™åˆ™ä¸ä¼šæ‰“æ‰°ä½ ã€‚

Drizzle ORM æ˜¯ä¸€ä¸ªæ— å¤´çš„ TypeScript ORMï¼Œå¸¦æœ‰ä¸€ä¸ªå¤´ã€‚ ğŸ²

å®ƒçœ‹èµ·æ¥ç®€å•ã€æ„Ÿè§‰ç®€å•ï¼Œåœ¨ä½ çš„é¡¹ç›®ç¬¬ _1000_ å¤©ä¾ç„¶è¡¨ç°ä¼˜ç§€ï¼Œ
è®©ä½ å¯ä»¥ç”¨è‡ªå·±çš„æ–¹å¼è¿›è¡Œå¼€å‘ï¼Œå¹¶éšæ—¶ä¸ºä½ æä¾›å¸®åŠ©ã€‚  

**å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåŒæ—¶æ‹¥æœ‰ [å…³ç³»å‹](/docs/rqb) å’Œ [SQL ç±»ä¼¼](/docs/select) æŸ¥è¯¢ API çš„ ORM**ï¼Œ 
åœ¨è®¿é—®å…³ç³»æ•°æ®æ—¶ä¸ºä½ æä¾›äº†ä¸¤å…¨å…¶ç¾çš„é€‰æ‹©ã€‚ 
Drizzle è½»é‡ã€é«˜æ•ˆã€å®‰å…¨ã€æ— ä¹³ç³–ã€æ— éº¸è´¨ã€æ¸…é†’ã€çµæ´»ï¼Œå¹¶ä¸” **ä»è®¾è®¡ä¸Šå°±æ”¯æŒæ— æœåŠ¡å™¨**ã€‚
Drizzle ä¸ä»…ä»…æ˜¯ä¸€ä¸ªåº“ï¼Œå®ƒæ˜¯ä¸€ç§ä½“éªŒã€‚ ğŸ¤©

[![Drizzle bestofjs](@/assets/images/bestofjs.jpg)](https://bestofjs.org/projects/drizzle-orm)

## æ— å¤´ ORM?
é¦–å…ˆï¼ŒDrizzle æ˜¯ä¸€ä¸ªåº“å’Œä¸€ç³»åˆ—å¯é€‰çš„å·¥å…·é›†åˆã€‚ 

**ORM** æ˜¯ _å¯¹è±¡å…³ç³»æ˜ å°„_ çš„ç¼©å†™ï¼Œå¼€å‘è€…å¾€å¾€å°† Django å¼æˆ– Spring å¼å·¥å…·ç§°ä¸º ORMã€‚ 
æˆ‘ä»¬çœŸå®åœ°è®¤ä¸ºè¿™æ˜¯ä¸€ç§åŸºäºé—ç•™å‘½åçš„è¯¯è§£ï¼Œæˆ‘ä»¬ç§°å®ƒä»¬ä¸º **æ•°æ®æ¡†æ¶**ã€‚

<Callout type="error" emoji="ï¸ğŸ’”">
  ä½¿ç”¨æ•°æ®æ¡†æ¶ï¼Œä½ å¿…é¡»å›´ç€å®ƒä»¬ **æ„å»ºé¡¹ç›®**ï¼Œè€Œä¸æ˜¯ **ä¸å®ƒä»¬å…±å»º**ã€‚
</Callout>

**Drizzle** è®©ä½ å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æ–¹å¼æ„å»ºé¡¹ç›®ï¼Œè€Œä¸ä¼šå¹²æ‰°ä½ çš„é¡¹ç›®æˆ–ç»“æ„ã€‚ 

ä½¿ç”¨ Drizzleï¼Œä½ å¯ä»¥ç”¨ TypeScript å®šä¹‰å’Œç®¡ç†æ•°æ®åº“æ¨¡å¼ï¼Œ
ä»¥ SQL ç±»ä¼¼çš„æ–¹å¼æˆ–å…³ç³»æ–¹å¼è®¿é—®æ•°æ®ï¼Œå¹¶åˆ©ç”¨å¯é€‰å·¥å…· 
å°†ä½ çš„å¼€å‘è€…ä½“éªŒæå‡åˆ° _æè‡´_ã€‚ ğŸ¤¯ 

## ä¸ºä»€ä¹ˆé€‰æ‹© SQL ç±»ä¼¼?
**å¦‚æœä½ çŸ¥é“ SQLï¼Œä½ å°±ä¼šçŸ¥é“ Drizzleã€‚**

å…¶ä»– ORM å’Œæ•°æ®æ¡†æ¶å¾€å¾€ä¼šè®©ä½ åç¦»/æŠ½è±¡æ‰ SQLï¼Œ
è¿™å¯¼è‡´äº†åŒé‡å­¦ä¹ æ›²çº¿ï¼šéœ€è¦åŒæ—¶äº†è§£ SQL å’Œæ¡†æ¶çš„ APIã€‚  

Drizzle æ°æ°ç›¸åã€‚ 
æˆ‘ä»¬æ‹¥æŠ± SQLï¼Œå¹¶è®© Drizzle åœ¨æ ¸å¿ƒä¸Š SQL ç±»ä¼¼ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å®ç°é›¶å­¦ä¹ æ›²çº¿ï¼Œ
å¹¶èƒ½å¤Ÿå…¨é¢ä½¿ç”¨ SQL çš„å¼ºå¤§åŠŸèƒ½ã€‚  

æˆ‘ä»¬æä¾›æ‰€æœ‰ç†Ÿæ‚‰çš„ **[SQL æ¨¡å¼](/docs/sql-schema-declaration)**ã€**[æŸ¥è¯¢](/docs/select)**ã€ 
**[è‡ªåŠ¨è¿ç§»](/docs/migrations)** å’Œ **[è¿˜æœ‰ä¸€ä»¶äº‹](/docs/rqb)**ã€‚ âœ¨

<CodeTabs items={["index.ts", "schema.ts", "migration.sql"]}>
```typescript copy
// è®¿é—®ä½ çš„æ•°æ®
await db
	.select()
	.from(countries)
	.leftJoin(cities, eq(cities.countryId, countries.id))
	.where(eq(countries.id, 10))
```
```typescript copy
// ç®¡ç†ä½ çš„æ¨¡å¼
export const countries = pgTable('countries', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 256 }),
});

export const cities = pgTable('cities', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 256 }),
  countryId: integer('country_id').references(() => countries.id),
});
```
```sql
-- ç”Ÿæˆè¿ç§»
CREATE TABLE IF NOT EXISTS "countries" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" varchar(256)
);

CREATE TABLE IF NOT EXISTS "cities" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" varchar(256),
	"country_id" integer
);

ALTER TABLE "cities" ADD CONSTRAINT "cities_country_id_countries_id_fk" FOREIGN KEY ("country_id") REFERENCES "countries"("id") ON DELETE no action ON UPDATE no action;
```
</CodeTabs>

## ä¸ºä»€ä¹ˆä¸é€‰æ‹© SQL ç±»ä¼¼?
æˆ‘ä»¬å§‹ç»ˆè¿½æ±‚ä¸€ä¸ªå®Œç¾å¹³è¡¡çš„è§£å†³æ–¹æ¡ˆï¼Œå°½ç®¡ SQL ç±»ä¼¼èƒ½å¤Ÿè¦†ç›– 100% çš„éœ€æ±‚ï¼Œ
ä½†åœ¨æŸäº›å¸¸è§åœºæ™¯ä¸­ï¼Œä½ å¯ä»¥æ›´å¥½åœ°æŸ¥è¯¢æ•°æ®ã€‚  

æˆ‘ä»¬ä¸ºä½ æ„å»ºäº† **[æŸ¥è¯¢ API](/docs/rqb)**ï¼Œé€šè¿‡æœ€æ–¹ä¾¿å’Œé«˜æ•ˆçš„æ–¹å¼ä»æ•°æ®åº“ä¸­æå–å…³ç³»åµŒå¥—æ•°æ®ï¼Œ
è€Œæ— éœ€è€ƒè™‘è¿æ¥å’Œæ•°æ®æ˜ å°„ã€‚  

**Drizzle å§‹ç»ˆè¾“å‡ºæ°å¥½ 1 æ¡ SQL æŸ¥è¯¢ã€‚** å¯ä»¥æ”¾å¿ƒä¸æ— æœåŠ¡å™¨æ•°æ®åº“ä¸€èµ·ä½¿ç”¨ï¼Œæ°¸è¿œä¸ç”¨æ‹…å¿ƒæ€§èƒ½æˆ–å¾€è¿”è´¹ç”¨ï¼

```ts
const result = await db.query.users.findMany({
	with: {
		posts: true
	},
});
```

## æ— æœåŠ¡å™¨?
<Callout type="info" emoji="ğŸ¥³">
  æœ€æ£’çš„éƒ¨åˆ†æ˜¯æ²¡æœ‰ä»»ä½•éƒ¨åˆ†ã€‚ **Drizzle ç²¾ç¡®ä¸º 0 ä¸ªä¾èµ–é¡¹ï¼**
</Callout>


![Drizzle è½»é‡ä¸”æ”¯æŒæ— æœåŠ¡å™¨](@/assets/images/drizzle31kb.jpg)
  
Drizzle ORM æ˜¯æ–¹è¨€ç‰¹å®šçš„ï¼Œè½»é‡ã€é«˜æ•ˆï¼Œå¹¶ä¸” **ä»è®¾è®¡ä¸Šæ”¯æŒæ— æœåŠ¡å™¨**ã€‚  

æˆ‘ä»¬èŠ±è´¹äº†å¤§é‡æ—¶é—´ç¡®ä¿ä½ æ‹¥æœ‰æœ€ä¼˜è´¨çš„ SQL æ–¹è¨€æ”¯æŒï¼ŒåŒ…æ‹¬ PostgreSQLã€MySQL å’Œå…¶ä»–ã€‚

Drizzle é€šè¿‡è¡Œä¸šæ ‡å‡†æ•°æ®åº“é©±åŠ¨ç¨‹åºåŸç”Ÿè¿è¡Œã€‚æˆ‘ä»¬æ”¯æŒæ‰€æœ‰ä¸»è¦çš„ **[PostgreSQL](/docs/get-started-postgresql)**ã€**[MySQL](/docs/get-started-mysql)** æˆ– **[SQLite](/docs/get-started-sqlite)** é©±åŠ¨ç¨‹åºï¼Œå¹¶ä¸”æˆ‘ä»¬æ­£åœ¨ **[å¿«é€Ÿæ·»åŠ æ–°é©±åŠ¨](https://twitter.com/DrizzleORM/status/1653082492742647811?s=20)**ã€‚ 


## æ¬¢è¿åŠ å…¥ï¼
è¶Šæ¥è¶Šå¤šçš„å…¬å¸åœ¨ç”Ÿäº§ä¸­é‡‡ç”¨ Drizzleï¼Œäº«å—å¼€å‘ä½“éªŒå’Œæ€§èƒ½çš„å·¨å¤§å¥½å¤„ã€‚

**æˆ‘ä»¬å§‹ç»ˆåœ¨è¿™é‡Œæä¾›å¸®åŠ©ï¼Œå› æ­¤è¯·éšæ—¶ä¸æˆ‘ä»¬è”ç³»ã€‚æˆ‘ä»¬å°†ä¹æ„ååŠ©ä½ åœ¨ Drizzle çš„æ—…ç¨‹ï¼**

æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡ºè‰²çš„ **[Discord ç¤¾åŒº](https://driz.link/discord)**ï¼Œæ¬¢è¿æ‰€æœ‰å¼€å‘è€…åŠ å…¥æˆ‘ä»¬çš„ **[Twitter](https://twitter.com/drizzleorm)**ã€‚
  
ç°åœ¨å¼€å§‹ä½¿ç”¨ Drizzle å’Œä½ çš„ **[PostgreSQL](/docs/get-started-postgresql)**ã€**[MySQL](/docs/get-started-mysql)** æˆ– **[SQLite](/docs/get-started-sqlite)** æ•°æ®åº“æ„å»ºä¸€äº›å¾ˆæ£’çš„ä¸œè¥¿å§ã€‚ ğŸš€

### è§†é¢‘å±•ç¤º

{/* tRPC + NextJS åº”ç”¨è·¯ç”± = ç®€å•çš„ç±»å‹å®‰å…¨ API
Jack Herrington 19:17
https://www.youtube.com/watch?v=qCLV0Iaq9zU */}
{/* https://www.youtube.com/watch?v=qDunJ0wVIec */}
{/* https://www.youtube.com/watch?v=NZpPMlSAez0 */}

 {/* https://www.youtube.com/watch?v=-A0kMiJqQRY */}

<YoutubeCards cards={[
	{
		id: "vyU5mJGCJMw",
		title: "åˆå­¦è€…çš„å®Œæ•´ Drizzle è¯¾ç¨‹",
		description: "Code Genix",
		time: "1:37:39",
	},
	{
		id: "7-NZ0MlPpJA",
		title: "60 åˆ†é’Ÿå­¦ä¼š Drizzle",
		description: "Web Dev Simplified",
		time: "56:09"
	},
	{
		id: "i_mAHOhpBSA",
		title: "100 ç§’äº†è§£ Drizzle ORM",
		description: "Fireship",
		time: "2:55"
	},
	{
		id: "hIYNOiZXQ7Y",
		title: "13 åˆ†é’Ÿå­¦ä¼š Drizzle ORMï¼ˆé€Ÿæˆè¯¾ç¨‹ï¼‰",
		description: "Neon",
		time: "14:00"
	},
	{
		id: "4ZhtoOFKFP8",
		title: "åœ¨ Next.js&nbsp;14 ä¸­ä½¿ç”¨ Turso&nbsp;&&nbsp;Drizzle çš„æœ€ç®€å•æ•°æ®åº“è®¾ç½®",
		description: "Sam Meech-Ward",
		time: '38:08'
	}, 
	{
		id: "NfVELsEZFsA",
		title: "ä½¿ç”¨ Vercelã€Neonã€Drizzleã€TailwindCSSã€FlowBite ç­‰çš„ Next.js é¡¹ç›®ï¼",
		description: "CodingEntrepreneurs",
		time: '5:46:28'
	}, 
	{
		id: "_SLxGYzv6jo",
		title: "æˆ‘æœ‰äº†æ–°çš„æœ€çˆ±æ•°æ®åº“å·¥å…·",
		description: "Theo - t3.gg",
		time: '5:46'
	}, 
	{
		id: "Qo-RXkSwOtc",
		title: "Drizzle ORM åˆå°è±¡ - è¿ç§»ã€å…³ç³»ã€æŸ¥è¯¢ï¼",
		description: "Marius Espejo",
		time: '33:52'
	},
	{
		id: "yXNEqyvA0OY",
		title: "æˆ‘æƒ³å­¦ä¹  Drizzle ORMï¼Œæ‰€ä»¥æˆ‘åœ¨å¦ä¸€ä¸ª next14 é¡¹ç›®ä¸­å¼€å§‹",
		description: "Web Dev Cody",
		time: "9:00"
	},
	{
		id: "h7vVhR-dFYo",
		title: "é€‰æ‹©ä¸€ä¸ª ORM å˜å¾—è¶Šæ¥è¶Šå›°éš¾...",
		description: "Ben Davis",
		time: "5:18"
	},
	{
		id: "8met6WTk0mQ",
		title: "è¿™ä¸ªæ–°çš„æ•°æ®åº“å·¥å…·æ˜¯ä¸€ä¸ªæ¸¸æˆè§„åˆ™çš„æ”¹å˜è€…",
		description: "Josh tried coding",
		time: "8:49"
	},
	{
		id: "woWW1T9DXEY",
		title: "æˆ‘å–œæ¬¢çš„æ•°æ®åº“å·¥å…·å˜å¾—æ›´å¥½äº†",
		description: "Josh tried coding",
		time: "4:23"
	},
	{
		id: "A3l6YYkXzzg",
		title: "å¸¦å®æ—¶å…‰æ ‡çš„ SaaS Notion å…‹éš†ï¼ŒNextjs 13ï¼ŒStripeï¼ŒDrizzle ORMï¼ŒTailwindï¼ŒSupabaseï¼ŒSockets",
		description: "Web Prodigies",
		time: "11:41:46"
	},
	{
		id: "EQfaw5bDE1s",
		title: "SvelteKit + Drizzle ä»£ç è§£æ",
		description: "Ben Davis",
		time: "12:18"
	},
	{
		id: "b6VhN_HHDiQ",
		title: "æ„å»ºä¸€ä¸ªå¤šç§Ÿæˆ·ã€åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿ",
		description: "TomDoesTech",
		time: "2:01:29"
	},
	{
		id: "3tl9XCiQErA",
		title: "Prisma æ€æ‰‹ç»ˆäºæ¥äº†",
		description: "SST",
		time: "5:42"
	},
	{
		id: "VQFjyEa8vGE",
		title: "å­¦ä¹  Drizzle ORM å¹¶åœ¨ä¸€ä¸ª next14 é¡¹ç›®ä¸­å·¥ä½œ",
		description: "Web Dev Cody",
		time: "1:07:41"
	},
	{
		id: "5G0upg4sxgE",
		title: "è¿™ä¸ªæŠ€å·§è®©æˆ‘çš„æœ€çˆ±æ•°æ®åº“å·¥å…·å˜å¾—æ›´å¥½",
		description: "Josh tried coding",
		time: "6:01"
	},
	{
		id: "-JnEuvPmt-Q",
		title: "åœ¨ Next.js 14 ä¸­è½»æ¾å®ç°èº«ä»½éªŒè¯ï¼šä½¿ç”¨ Auth.js å’Œ Drizzle ORM è¿›è¡Œå®‰å…¨ç™»å½•",
		description: "Sam Meech-Ward",
		time: "26:29"
	},
]} />


Source: https://drizzle.zhcndoc.com/docs/zod

import Npm from '@mdx/Npm.astro';
import Callout from '@mdx/Callout.astro';

# drizzle-zod

`drizzle-zod` æ˜¯ä¸€ä¸ª **[Drizzle ORM](https://github.com/drizzle-team/drizzle-orm)** çš„æ’ä»¶ï¼Œå…è®¸ä½ ä» Drizzle ORM ç”Ÿæˆ **[Zod](https://github.com/colinhacks/zod)** æ¨¡å¼ã€‚

### å®‰è£…ä¾èµ–

<Npm>
drizzle-zod
</Npm>

<Callout type="warning">
è¯¥æ–‡æ¡£é€‚ç”¨äº `drizzle-zod@0.6.0` åŠæ›´é«˜ç‰ˆæœ¬

ä½ è¿˜å¿…é¡»å®‰è£… Drizzle ORM v0.36.0 æˆ–æ›´é«˜ç‰ˆæœ¬ä»¥åŠ Zod v3.25.1 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
</Callout>

### é€‰æ‹©æ¨¡å¼

å®šä¹‰ä»æ•°æ®åº“æŸ¥è¯¢çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API å“åº”ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-zod';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userSelectSchema = createSelectSchema(users);

const rows = await db.select({ id: users.id, name: users.name }).from(users).limit(1);
const parsed: { id: number; name: string; age: number } = userSelectSchema.parse(rows[0]); // é”™è¯¯ï¼š`age` åœ¨ä¸Šé¢çš„æŸ¥è¯¢ä¸­æœªè¿”å›

const rows = await db.select().from(users).limit(1);
const parsed: { id: number; name: string; age: number } = userSelectSchema.parse(rows[0]); // å°†æˆåŠŸè§£æ
```

è§†å›¾å’Œæšä¸¾ä¹Ÿå—åˆ°æ”¯æŒã€‚

```ts copy
import { pgEnum } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-zod';

const roles = pgEnum('roles', ['admin', 'basic']);
const rolesSchema = createSelectSchema(roles);
const parsed: 'admin' | 'basic' = rolesSchema.parse(...);

const usersView = pgView('users_view').as((qb) => qb.select().from(users).where(gt(users.age, 18)));
const usersViewSchema = createSelectSchema(usersView);
const parsed: { id: number; name: string; age: number } = usersViewSchema.parse(...);
```

### æ’å…¥æ¨¡å¼

å®šä¹‰è¦æ’å…¥åˆ°æ•°æ®åº“ä¸­çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createInsertSchema } from 'drizzle-zod';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userInsertSchema = createInsertSchema(users);

const user = { name: 'John' };
const parsed: { name: string, age: number } = userInsertSchema.parse(user); // é”™è¯¯ï¼š`age` æœªå®šä¹‰

const user = { name: 'Jane', age: 30 };
const parsed: { name: string, age: number } = userInsertSchema.parse(user); // å°†æˆåŠŸè§£æ
await db.insert(users).values(parsed);
```

### æ›´æ–°æ¨¡å¼

å®šä¹‰è¦æ›´æ–°çš„æ•°æ®åº“ä¸­çš„æ•°æ®å½¢çŠ¶ - å¯ç”¨äºéªŒè¯ API è¯·æ±‚ã€‚

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createUpdateSchema } from 'drizzle-zod';

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const userUpdateSchema = createUpdateSchema(users);

const user = { id: 5, name: 'John' };
const parsed: { name?: string | undefined, age?: number | undefined } = userUpdateSchema.parse(user); // é”™è¯¯ï¼š`id` æ˜¯ä¸€ä¸ªç”Ÿæˆåˆ—ï¼Œæ— æ³•æ›´æ–°

const user = { age: 35 };
const parsed: { name?: string | undefined, age?: number | undefined } = userUpdateSchema.parse(user); // å°†æˆåŠŸè§£æ
await db.update(users).set(parsed).where(eq(users.name, 'Jane'));
```

### ç²¾ç»†åŒ–

æ¯ä¸ªåˆ›å»ºæ¨¡å¼å‡½æ•°æ¥å—ä¸€ä¸ªé¢å¤–çš„å¯é€‰å‚æ•°ï¼Œä½ å¯ä»¥ç”¨æ¥æ‰©å±•ã€ä¿®æ”¹æˆ–å®Œå…¨è¦†ç›–å­—æ®µçš„æ¨¡å¼ã€‚å®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°å°†æ‰©å±•æˆ–ä¿®æ”¹ï¼Œæä¾›ä¸€ä¸ª Zod æ¨¡å¼å°†è¦†ç›–å®ƒã€‚

```ts copy
import { pgTable, text, integer, json } from 'drizzle-orm/pg-core';
import { createSelectSchema } from 'drizzle-zod';
import { z } from 'zod/v4';

const users = pgTable('users', {
  id: integer().primaryKey(),
  name: text().notNull(),
  bio: text(),
  preferences: json()
});

const userSelectSchema = createSelectSchema(users, {
  name: (schema) => schema.max(20), // æ‰©å±•æ¨¡å¼
  bio: (schema) => schema.max(1000), // æ‰©å±•æ¨¡å¼ï¼Œä½¿å…¶å¯ä¸ºç©º/å¯é€‰
  preferences: z.object({ theme: z.string() }) // è¦†ç›–å­—æ®µï¼ŒåŒ…æ‹¬å…¶å¯ç©ºæ€§
});

const parsed: {
  id: number;
  name: string,
  bio?: string | undefined;
  preferences: {
    theme: string;
  };
} = userSelectSchema.parse(...);
```

### å·¥å‚å‡½æ•°

å¯¹äºæ›´é«˜çº§çš„ç”¨ä¾‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `createSchemaFactory` å‡½æ•°ã€‚

**ç”¨ä¾‹ï¼šä½¿ç”¨æ‰©å±•çš„ Zod å®ä¾‹**

```ts copy
import { pgTable, text, integer } from 'drizzle-orm/pg-core';
import { createSchemaFactory } from 'drizzle-zod';
import { z } from '@hono/zod-openapi'; // æ‰©å±•çš„ Zod å®ä¾‹

const users = pgTable('users', {
  id: integer().generatedAlwaysAsIdentity().primaryKey(),
  name: text().notNull(),
  age: integer().notNull()
});

const { createInsertSchema } = createSchemaFactory({ zodInstance: z });

const userInsertSchema = createInsertSchema(users, {
  // ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‰©å±•çš„å®ä¾‹
  name: (schema) => schema.openapi({ example: 'John' })
});
```

**ç”¨ä¾‹ï¼šç±»å‹å¼ºåˆ¶è½¬æ¢**

```ts copy
import { pgTable, timestamp } from 'drizzle-orm/pg-core';
import { createSchemaFactory } from 'drizzle-zod';
import { z } from 'zod/v4';

const users = pgTable('users', {
  ...,
  createdAt: timestamp().notNull()
});

const { createInsertSchema } = createSchemaFactory({
  // This configuration will only coerce dates. Set `coerce` to `true` to coerce all data types or specify others
  coerce: {
    date: true
  }
});

const userInsertSchema = createInsertSchema(users);
// The above is the same as this:
const userInsertSchema = z.object({
  ...,
  createdAt: z.coerce.date()
});
```

### æ•°æ®ç±»å‹å‚è€ƒ

```ts
pg.boolean();

mysql.boolean();

sqlite.integer({ mode: 'boolean' });

// æ¨¡å¼
z.boolean();
```

```ts
pg.date({ mode: 'date' });
pg.timestamp({ mode: 'date' });

mysql.date({ mode: 'date' });
mysql.datetime({ mode: 'date' });
mysql.timestamp({ mode: 'date' });

sqlite.integer({ mode: 'timestamp' });
sqlite.integer({ mode: 'timestamp_ms' });

// æ¨¡å¼
z.date();
```

```ts
pg.date({ mode: 'string' });
pg.timestamp({ mode: 'string' });
pg.cidr();
pg.inet();
pg.interval();
pg.macaddr();
pg.macaddr8();
pg.numeric();
pg.text();
pg.sparsevec();
pg.time();

mysql.binary();
mysql.date({ mode: 'string' });
mysql.datetime({ mode: 'string' });
mysql.decimal();
mysql.time();
mysql.timestamp({ mode: 'string' });
mysql.varbinary();

sqlite.numeric();
sqlite.text({ mode: 'text' });

// æ¨¡å¼
z.string();
```

```ts
pg.bit({ dimensions: ... });

// æ¨¡å¼
z.string().regex(/^[01]+$/).max(dimensions);
```

```ts
pg.uuid();

// æ¨¡å¼
z.string().uuid();
```

```ts
pg.char({ length: ... });

mysql.char({ length: ... });

// æ¨¡å¼
z.string().length(length);
```

```ts
pg.varchar({ length: ... });

mysql.varchar({ length: ... });

sqlite.text({ mode: 'text', length: ... });

// æ¨¡å¼
z.string().max(length);
```

```ts
mysql.tinytext();

// æ¨¡å¼
z.string().max(255); // æ— ç¬¦å· 8 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.text();

// æ¨¡å¼
z.string().max(65_535); // æ— ç¬¦å· 16 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.mediumtext();

// æ¨¡å¼
z.string().max(16_777_215); // æ— ç¬¦å· 24 ä½æ•´æ•°é™åˆ¶
```

```ts
mysql.longtext();

// æ¨¡å¼
z.string().max(4_294_967_295); // æ— ç¬¦å· 32 ä½æ•´æ•°é™åˆ¶
```

```ts
pg.text({ enum: ... });
pg.char({ enum: ... });
pg.varchar({ enum: ... });

mysql.tinytext({ enum: ... });
mysql.mediumtext({ enum: ... });
mysql.text({ enum: ... });
mysql.longtext({ enum: ... });
mysql.char({ enum: ... });
mysql.varchar({ enum: ... });
mysql.mysqlEnum(..., ...);

sqlite.text({ mode: 'text', enum: ... });

// æ¨¡å¼
z.enum(enum);
```

```ts
mysql.tinyint();

// æ¨¡å¼
z.number().min(-128).max(127).int(); // 8 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.tinyint({ unsigned: true });

// æ¨¡å¼
z.number().min(0).max(255).int(); // æ— ç¬¦å· 8 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.smallint();
pg.smallserial();

mysql.smallint();

// æ¨¡å¼
z.number().min(-32_768).max(32_767).int(); // 16 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.smallint({ unsigned: true });

// æ¨¡å¼
z.number().min(0).max(65_535).int(); // æ— ç¬¦å· 16 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.real();

mysql.float();

// æ¨¡å¼
z.number().min(-8_388_608).max(8_388_607); // 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.mediumint();

// æ¨¡å¼
z.number().min(-8_388_608).max(8_388_607).int(); // 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.float({ unsigned: true });

// æ¨¡å¼
z.number().min(0).max(16_777_215); // æ— ç¬¦å· 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.mediumint({ unsigned: true });

// æ¨¡å¼
z.number().min(0).max(16_777_215).int(); // æ— ç¬¦å· 24 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.integer();
pg.serial();

mysql.int();

// æ¨¡å¼
z.number().min(-2_147_483_648).max(2_147_483_647).int(); // 32 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.int({ unsigned: true });

// æ¨¡å¼
z.number().min(0).max(4_294_967_295).int(); // æ— ç¬¦å· 32 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.doublePrecision();

mysql.double();
mysql.real();

sqlite.real();

// æ¨¡å¼
z.number().min(-140_737_488_355_328).max(140_737_488_355_327); // 48 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.double({ unsigned: true });

// æ¨¡å¼
z.number().min(0).max(281_474_976_710_655); // æ— ç¬¦å· 48 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
pg.bigint({ mode: 'number' });
pg.bigserial({ mode: 'number' });

mysql.bigint({ mode: 'number' });
mysql.bigserial({ mode: 'number' });

sqlite.integer({ mode: 'number' });

// æ¨¡å¼
z.number().min(-9_007_199_254_740_991).max(9_007_199_254_740_991).int(); // Javascript æœ€å°å’Œæœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
mysql.serial();

// æ¨¡å¼
z.number().min(0).max(9_007_199_254_740_991).int(); // Javascript æœ€å¤§å®‰å…¨æ•´æ•°
```

```ts
pg.bigint({ mode: 'bigint' });
pg.bigserial({ mode: 'bigint' });

mysql.bigint({ mode: 'bigint' });

sqlite.blob({ mode: 'bigint' });

// æ¨¡å¼
z.bigint().min(-9_223_372_036_854_775_808n).max(9_223_372_036_854_775_807n); // 64 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.bigint({ mode: 'bigint', unsigned: true });

// æ¨¡å¼
z.bigint().min(0).max(18_446_744_073_709_551_615n); // æ— ç¬¦å· 64 ä½æ•´æ•°ä¸‹é™å’Œä¸Šé™
```

```ts
mysql.year();

// æ¨¡å¼
z.number().min(1_901).max(2_155).int();
```

```ts
pg.geometry({ type: 'point', mode: 'tuple' });
pg.point({ mode: 'tuple' });

// æ¨¡å¼
z.tuple([z.number(), z.number()]);
```

```ts
pg.geometry({ type: 'point', mode: 'xy' });
pg.point({ mode: 'xy' });

// æ¨¡å¼
z.object({ x: z.number(), y: z.number() });
```

```ts
pg.halfvec({ dimensions: ... });
pg.vector({ dimensions: ... });

// æ¨¡å¼
z.array(z.number()).length(dimensions);
```

```ts
pg.line({ mode: 'abc' });

// æ¨¡å¼
z.object({ a: z.number(), b: z.number(), c: z.number() });
```

```ts
pg.line({ mode: 'tuple' });

// æ¨¡å¼
z.tuple([z.number(), z.number(), z.number()]);
```

```ts
pg.json();
pg.jsonb();

mysql.json();

sqlite.blob({ mode: 'json' });
sqlite.text({ mode: 'json' });

// æ¨¡å¼
z.union([z.union([z.string(), z.number(), z.boolean(), z.null()]), z.record(z.any()), z.array(z.any())]);
```

```ts
sqlite.blob({ mode: 'buffer' });

// æ¨¡å¼
z.custom<Buffer>((v) => v instanceof Buffer);
```

```ts
pg.dataType().array(...);

// æ¨¡å¼
z.array(baseDataTypeSchema).length(size);
```

